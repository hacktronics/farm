"use strict";module.exports=(e,r)=>{const t=require("chalk"),o=require("./vinyl-stream"),s=require("stream").Transform,n={},{getFirstSupportedPlatform:i}=require("../utils");let a,l;r&&(Array.isArray(a)?a=r:"javascript"===r?l=["javascript"]:(r.platform&&(l=Array.isArray(r.platform)?r.platform:[r.platform]),r.extraArguments&&(a=r.extraArguments))),l||(l=["native","java","javascript"]);const c=i(l);class u extends s{constructor(){super({objectMode:!0})}_transform(r,t,o){e.file.write(r.path,r.contents),this.push(r),o()}}function p(r,i,l){let p=!1;const f=new s({objectMode:!0,transform:function(){},flush:function(r){p||(i.js_output_file?e.log.ok(t.cyan(i.js_output_file)+" created"):e.log.ok("Compilation succeeded")),r()}});return new Promise(function(t,s){let g;const m={};let d;d="javascript"===c?Object.assign({},n,{logger:e.log,pluginName:"grunt-google-closure-compiler"}):Object.assign({},n,{streamMode:"IN",logger:e.log,pluginName:"grunt-google-closure-compiler",requireStreamInput:!1}),a&&"javascript"!==a&&(m.extraArguments=a);const h=require("../gulp")(m),j=Object.assign({},d,l);r?(g=new o(r,{base:process.cwd()}).pipe(h(i,j)),"javascript"===c&&(g=g.on("error",e=>{p=!0,s(e)}).pipe(new u))):(g=h(i,j),"javascript"===c&&(g=g.on("error",e=>{p=!0,s(e)}).pipe(new u)),g.end()),g.on("error",function(e){p=!0,s(e)}),g.on("end",function(e){t()}),g.pipe(f),g.resume()})}function f(){const r=this,o=this.async(),s=[];function n(){const e=r.options({args:void 0}),t=e.args;return delete e.args,{args:t,compilerOpts:e}}if(r.files.forEach(function(r){const o=n(),i=r.src.filter(r=>!!e.file.exists(r)||(e.log.warn("Source file "+t.cyan(r)+" not found"),!1));0!==i.length?(o.compilerOpts.js_output_file=r.dest,s.push(p(i,o.args||o.compilerOpts,{platform:c}).then(function(){},function(e){throw e}))):e.log.warn("Destination "+t.cyan(r.dest)+" not written because src files were empty")}),0===r.files.length){const e=n();s.push(p(null,e.args||e.compilerOpts,{platform:c}))}Promise.all(s).then(()=>o()).catch(()=>{e.fail.warn("Compilation error"),o()})}return e.registerMultiTask("closure-compiler","Minify files with Google Closure Compiler",f),f};