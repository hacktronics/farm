/**
 * @license
 * Copyright 2016 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.Lua.texts"),goog.require("Blockly.Lua"),Blockly.Lua.text=function(l){return[Blockly.Lua.quote_(l.getFieldValue("TEXT")),Blockly.Lua.ORDER_ATOMIC]},Blockly.Lua.text_multiline=function(l){var e=Blockly.Lua.multiline_quote_(l.getFieldValue("TEXT")),o=-1!=e.indexOf("..")?Blockly.Lua.ORDER_CONCATENATION:Blockly.Lua.ORDER_ATOMIC;return[e,o]},Blockly.Lua.text_join=function(l){if(0==l.itemCount_)return["''",Blockly.Lua.ORDER_ATOMIC];if(1==l.itemCount_)return["tostring("+(Blockly.Lua.valueToCode(l,"ADD0",Blockly.Lua.ORDER_NONE)||"''")+")",Blockly.Lua.ORDER_HIGH];if(2==l.itemCount_)return[(Blockly.Lua.valueToCode(l,"ADD0",Blockly.Lua.ORDER_CONCATENATION)||"''")+" .. "+(Blockly.Lua.valueToCode(l,"ADD1",Blockly.Lua.ORDER_CONCATENATION)||"''"),Blockly.Lua.ORDER_CONCATENATION];for(var e=[],o=0;o<l.itemCount_;o++)e[o]=Blockly.Lua.valueToCode(l,"ADD"+o,Blockly.Lua.ORDER_NONE)||"''";return["table.concat({"+e.join(", ")+"})",Blockly.Lua.ORDER_HIGH]},Blockly.Lua.text_append=function(l){var e=Blockly.Lua.nameDB_.getName(l.getFieldValue("VAR"),Blockly.VARIABLE_CATEGORY_NAME);return e+" = "+e+" .. "+(Blockly.Lua.valueToCode(l,"TEXT",Blockly.Lua.ORDER_CONCATENATION)||"''")+"\n"},Blockly.Lua.text_length=function(l){return["#"+(Blockly.Lua.valueToCode(l,"VALUE",Blockly.Lua.ORDER_UNARY)||"''"),Blockly.Lua.ORDER_UNARY]},Blockly.Lua.text_isEmpty=function(l){return["#"+(Blockly.Lua.valueToCode(l,"VALUE",Blockly.Lua.ORDER_UNARY)||"''")+" == 0",Blockly.Lua.ORDER_RELATIONAL]},Blockly.Lua.text_indexOf=function(l){var e=Blockly.Lua.valueToCode(l,"FIND",Blockly.Lua.ORDER_NONE)||"''",o=Blockly.Lua.valueToCode(l,"VALUE",Blockly.Lua.ORDER_NONE)||"''";if("FIRST"==l.getFieldValue("END"))var t=Blockly.Lua.provideFunction_("firstIndexOf",["function "+Blockly.Lua.FUNCTION_NAME_PLACEHOLDER_+"(str, substr) ","  local i = string.find(str, substr, 1, true)","  if i == nil then","    return 0","  else","    return i","  end","end"]);else t=Blockly.Lua.provideFunction_("lastIndexOf",["function "+Blockly.Lua.FUNCTION_NAME_PLACEHOLDER_+"(str, substr)","  local i = string.find(string.reverse(str), string.reverse(substr), 1, true)","  if i then","    return #str + 2 - i - #substr","  end","  return 0","end"]);return[t+"("+o+", "+e+")",Blockly.Lua.ORDER_HIGH]},Blockly.Lua.text_charAt=function(l){var e,o=l.getFieldValue("WHERE")||"FROM_START",t="FROM_END"==o?Blockly.Lua.ORDER_UNARY:Blockly.Lua.ORDER_NONE,u=Blockly.Lua.valueToCode(l,"AT",t)||"1",a=Blockly.Lua.valueToCode(l,"VALUE",Blockly.Lua.ORDER_NONE)||"''";if("RANDOM"==o){e=Blockly.Lua.provideFunction_("text_random_letter",["function "+Blockly.Lua.FUNCTION_NAME_PLACEHOLDER_+"(str)","  local index = math.random(string.len(str))","  return string.sub(str, index, index)","end"])+"("+a+")"}else{if("FIRST"==o)var n="1";else if("LAST"==o)n="-1";else if("FROM_START"==o)n=u;else{if("FROM_END"!=o)throw Error("Unhandled option (text_charAt).");n="-"+u}if(n.match(/^-?\w*$/))e="string.sub("+a+", "+n+", "+n+")";else e=Blockly.Lua.provideFunction_("text_char_at",["function "+Blockly.Lua.FUNCTION_NAME_PLACEHOLDER_+"(str, index)","  return string.sub(str, index, index)","end"])+"("+a+", "+n+")"}return[e,Blockly.Lua.ORDER_HIGH]},Blockly.Lua.text_getSubstring=function(l){var e=Blockly.Lua.valueToCode(l,"STRING",Blockly.Lua.ORDER_NONE)||"''",o=l.getFieldValue("WHERE1"),t="FROM_END"==o?Blockly.Lua.ORDER_UNARY:Blockly.Lua.ORDER_NONE,u=Blockly.Lua.valueToCode(l,"AT1",t)||"1";if("FIRST"==o)var a=1;else if("FROM_START"==o)a=u;else{if("FROM_END"!=o)throw Error("Unhandled option (text_getSubstring)");a="-"+u}var n=l.getFieldValue("WHERE2"),r="FROM_END"==n?Blockly.Lua.ORDER_UNARY:Blockly.Lua.ORDER_NONE,c=Blockly.Lua.valueToCode(l,"AT2",r)||"1";if("LAST"==n)var i=-1;else if("FROM_START"==n)i=c;else{if("FROM_END"!=n)throw Error("Unhandled option (text_getSubstring)");i="-"+c}return["string.sub("+e+", "+a+", "+i+")",Blockly.Lua.ORDER_HIGH]},Blockly.Lua.text_changeCase=function(l){var e=l.getFieldValue("CASE"),o=Blockly.Lua.valueToCode(l,"TEXT",Blockly.Lua.ORDER_NONE)||"''";if("UPPERCASE"==e)var t="string.upper";else if("LOWERCASE"==e)t="string.lower";else if("TITLECASE"==e)t=Blockly.Lua.provideFunction_("text_titlecase",["function "+Blockly.Lua.FUNCTION_NAME_PLACEHOLDER_+"(str)","  local buf = {}","  local inWord = false","  for i = 1, #str do","    local c = string.sub(str, i, i)","    if inWord then","      table.insert(buf, string.lower(c))",'      if string.find(c, "%s") then',"        inWord = false","      end","    else","      table.insert(buf, string.upper(c))","      inWord = true","    end","  end","  return table.concat(buf)","end"]);return[t+"("+o+")",Blockly.Lua.ORDER_HIGH]},Blockly.Lua.text_trim=function(l){var e={LEFT:"^%s*(,-)",RIGHT:"(.-)%s*$",BOTH:"^%s*(.-)%s*$"}[l.getFieldValue("MODE")];return["string.gsub("+(Blockly.Lua.valueToCode(l,"TEXT",Blockly.Lua.ORDER_NONE)||"''")+', "'+e+'", "%1")',Blockly.Lua.ORDER_HIGH]},Blockly.Lua.text_print=function(l){return"print("+(Blockly.Lua.valueToCode(l,"TEXT",Blockly.Lua.ORDER_NONE)||"''")+")\n"},Blockly.Lua.text_prompt_ext=function(l){if(l.getField("TEXT"))var e=Blockly.Lua.quote_(l.getFieldValue("TEXT"));else e=Blockly.Lua.valueToCode(l,"TEXT",Blockly.Lua.ORDER_NONE)||"''";var o=Blockly.Lua.provideFunction_("text_prompt",["function "+Blockly.Lua.FUNCTION_NAME_PLACEHOLDER_+"(msg)","  io.write(msg)","  io.flush()","  return io.read()","end"])+"("+e+")";return"NUMBER"==l.getFieldValue("TYPE")&&(o="tonumber("+o+", 10)"),[o,Blockly.Lua.ORDER_HIGH]},Blockly.Lua.text_prompt=Blockly.Lua.text_prompt_ext,Blockly.Lua.text_count=function(l){var e=Blockly.Lua.valueToCode(l,"TEXT",Blockly.Lua.ORDER_NONE)||"''",o=Blockly.Lua.valueToCode(l,"SUB",Blockly.Lua.ORDER_NONE)||"''";return[Blockly.Lua.provideFunction_("text_count",["function "+Blockly.Lua.FUNCTION_NAME_PLACEHOLDER_+"(haystack, needle)","  if #needle == 0 then","    return #haystack + 1","  end","  local i = 1","  local count = 0","  while true do","    i = string.find(haystack, needle, i, true)","    if i == nil then","      break","    end","    count = count + 1","    i = i + #needle","  end","  return count","end"])+"("+e+", "+o+")",Blockly.Lua.ORDER_HIGH]},Blockly.Lua.text_replace=function(l){var e=Blockly.Lua.valueToCode(l,"TEXT",Blockly.Lua.ORDER_NONE)||"''",o=Blockly.Lua.valueToCode(l,"FROM",Blockly.Lua.ORDER_NONE)||"''",t=Blockly.Lua.valueToCode(l,"TO",Blockly.Lua.ORDER_NONE)||"''";return[Blockly.Lua.provideFunction_("text_replace",["function "+Blockly.Lua.FUNCTION_NAME_PLACEHOLDER_+"(haystack, needle, replacement)","  local buf = {}","  local i = 1","  while i <= #haystack do","    if string.sub(haystack, i, i + #needle - 1) == needle then","      for j = 1, #replacement do","        table.insert(buf, string.sub(replacement, j, j))","      end","      i = i + #needle","    else","      table.insert(buf, string.sub(haystack, i, i))","      i = i + 1","    end","  end","  return table.concat(buf)","end"])+"("+e+", "+o+", "+t+")",Blockly.Lua.ORDER_HIGH]},Blockly.Lua.text_reverse=function(l){return["string.reverse("+(Blockly.Lua.valueToCode(l,"TEXT",Blockly.Lua.ORDER_NONE)||"''")+")",Blockly.Lua.ORDER_HIGH]};