"use strict";var arrayProto=require("@sinonjs/commons").prototypes.array,extend=require("./util/core/extend"),functionName=require("@sinonjs/commons").functionName,nextTick=require("./util/core/next-tick"),valueToString=require("@sinonjs/commons").valueToString,exportAsyncBehaviors=require("./util/core/export-async-behaviors"),concat=arrayProto.concat,join=arrayProto.join,reverse=arrayProto.reverse,slice=arrayProto.slice,useLeftMostCallback=-1,useRightMostCallback=-2;function getCallback(e,r){var t,i=e.callArgAt;if(i>=0)return r[i];i===useLeftMostCallback&&(t=r),i===useRightMostCallback&&(t=reverse(slice(r)));for(var o=e.callArgProp,n=0,a=t.length;n<a;++n){if(!o&&"function"==typeof t[n])return t[n];if(o&&t[n]&&"function"==typeof t[n][o])return t[n][o]}return null}function getCallbackError(e,r,t){var i;return e.callArgAt<0?(i=e.callArgProp?functionName(e.stub)+" expected to yield to '"+valueToString(e.callArgProp)+"', but no object with such a property was passed.":functionName(e.stub)+" expected to yield, but no callback was passed.",t.length>0&&(i+=" Received ["+join(t,", ")+"]"),i):"argument at index "+e.callArgAt+" is not a function: "+r}function ensureArgs(e,r,t){var i=r[e.replace(/sArg/,"ArgAt")];if(i>=t.length)throw new TypeError(e+" failed: "+(i+1)+" arguments required but only "+t.length+" present")}function callCallback(e,r){if("number"==typeof e.callArgAt){ensureArgs("callsArg",e,r);var t=getCallback(e,r);if("function"!=typeof t)throw new TypeError(getCallbackError(e,t,r));if(!e.callbackAsync)return t.apply(e.callbackContext,e.callbackArguments);nextTick(function(){t.apply(e.callbackContext,e.callbackArguments)})}}var proto={create:function(e){var r=extend({},proto);return delete r.create,delete r.addBehavior,delete r.createBehavior,r.stub=e,e.defaultBehavior&&e.defaultBehavior.promiseLibrary&&(r.promiseLibrary=e.defaultBehavior.promiseLibrary),r},isPresent:function(){return"number"==typeof this.callArgAt||this.exception||this.exceptionCreator||"number"==typeof this.returnArgAt||this.returnThis||"number"==typeof this.resolveArgAt||this.resolveThis||"number"==typeof this.throwArgAt||this.fakeFn||this.returnValueDefined},invoke:function(e,r){var t=callCallback(this,r);if(this.exception)throw this.exception;if(this.exceptionCreator)throw this.exception=this.exceptionCreator(),this.exceptionCreator=void 0,this.exception;if("number"==typeof this.returnArgAt)return ensureArgs("returnsArg",this,r),r[this.returnArgAt];if(this.returnThis)return e;if("number"==typeof this.throwArgAt)throw ensureArgs("throwsArg",this,r),r[this.throwArgAt];if(this.fakeFn)return this.fakeFn.apply(e,r);if("number"==typeof this.resolveArgAt)return ensureArgs("resolvesArg",this,r),(this.promiseLibrary||Promise).resolve(r[this.resolveArgAt]);if(this.resolveThis)return(this.promiseLibrary||Promise).resolve(e);if(this.resolve)return(this.promiseLibrary||Promise).resolve(this.returnValue);if(this.reject)return(this.promiseLibrary||Promise).reject(this.returnValue);if(this.callsThrough)return this.effectiveWrappedMethod().apply(e,r);if(this.callsThroughWithNew){var i=this.effectiveWrappedMethod(),o=slice(r);return new(i.bind.apply(i,concat([null],o)))}return void 0!==this.returnValue?this.returnValue:"number"==typeof this.callArgAt?t:this.returnValue},effectiveWrappedMethod:function(){for(var e=this.stub;e;e=e.parent)if(e.wrappedMethod)return e.wrappedMethod;throw new Error("Unable to find wrapped method")},onCall:function(e){return this.stub.onCall(e)},onFirstCall:function(){return this.stub.onFirstCall()},onSecondCall:function(){return this.stub.onSecondCall()},onThirdCall:function(){return this.stub.onThirdCall()},withArgs:function(){throw new Error('Defining a stub by invoking "stub.onCall(...).withArgs(...)" is not supported. Use "stub.withArgs(...).onCall(...)" to define sequential behavior for calls with certain arguments.')}};function createBehavior(e){return function(){return this.defaultBehavior=this.defaultBehavior||proto.create(this),this.defaultBehavior[e].apply(this.defaultBehavior,arguments),this}}function addBehavior(e,r,t){proto[r]=function(){return t.apply(this,concat([this],slice(arguments))),this.stub||this},e[r]=createBehavior(r)}proto.addBehavior=addBehavior,proto.createBehavior=createBehavior;var asyncBehaviors=exportAsyncBehaviors(proto);module.exports=extend.nonEnum({},proto,asyncBehaviors);