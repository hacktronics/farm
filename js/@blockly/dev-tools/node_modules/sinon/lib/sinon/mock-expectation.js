"use strict";var arrayProto=require("@sinonjs/commons").prototypes.array,proxyInvoke=require("./proxy-invoke"),proxyCallToString=require("./proxy-call").toString,timesInWords=require("./util/core/times-in-words"),extend=require("./util/core/extend"),match=require("@sinonjs/samsam").createMatcher,stub=require("./stub"),assert=require("./assert"),deepEqual=require("@sinonjs/samsam").deepEqual,format=require("./util/core/format"),valueToString=require("@sinonjs/commons").valueToString,every=arrayProto.every,forEach=arrayProto.forEach,push=arrayProto.push,slice=arrayProto.slice;function callCountInWords(t){return 0===t?"never called":"called "+timesInWords(t)}function expectedCallCountInWords(t){var e=t.minCalls,r=t.maxCalls;if("number"==typeof e&&"number"==typeof r){var i=timesInWords(e);return e!==r&&(i="at least "+i+" and at most "+timesInWords(r)),i}return"number"==typeof e?"at least "+timesInWords(e):"at most "+timesInWords(r)}function receivedMinCalls(t){return!("number"==typeof t.minCalls)||t.callCount>=t.minCalls}function receivedMaxCalls(t){return"number"==typeof t.maxCalls&&t.callCount===t.maxCalls}function verifyMatcher(t,e){return match.isMatcher(t)&&t.test(e)||!0}var mockExpectation={minCalls:1,maxCalls:1,create:function(t){var e=extend.nonEnum(stub(),mockExpectation);return delete e.create,e.method=t,e},invoke:function(t,e,r){return this.verifyCallAllowed(e,r),proxyInvoke.apply(this,arguments)},atLeast:function(t){if("number"!=typeof t)throw new TypeError("'"+valueToString(t)+"' is not number");return this.limitsSet||(this.maxCalls=null,this.limitsSet=!0),this.minCalls=t,this},atMost:function(t){if("number"!=typeof t)throw new TypeError("'"+valueToString(t)+"' is not number");return this.limitsSet||(this.minCalls=null,this.limitsSet=!0),this.maxCalls=t,this},never:function(){return this.exactly(0)},once:function(){return this.exactly(1)},twice:function(){return this.exactly(2)},thrice:function(){return this.exactly(3)},exactly:function(t){if("number"!=typeof t)throw new TypeError("'"+valueToString(t)+"' is not a number");return this.atLeast(t),this.atMost(t)},met:function(){return!this.failed&&receivedMinCalls(this)},verifyCallAllowed:function(t,e){var r=this.expectedArguments;receivedMaxCalls(this)&&(this.failed=!0,mockExpectation.fail(this.method+" already called "+timesInWords(this.maxCalls))),"expectedThis"in this&&this.expectedThis!==t&&mockExpectation.fail(this.method+" called with "+valueToString(t)+" as thisValue, expected "+valueToString(this.expectedThis)),"expectedArguments"in this&&(e||mockExpectation.fail(this.method+" received no arguments, expected "+format(r)),e.length<r.length&&mockExpectation.fail(this.method+" received too few arguments ("+format(e)+"), expected "+format(r)),this.expectsExactArgCount&&e.length!==r.length&&mockExpectation.fail(this.method+" received too many arguments ("+format(e)+"), expected "+format(r)),forEach(r,function(t,i){verifyMatcher(t,e[i])||mockExpectation.fail(this.method+" received wrong arguments "+format(e)+", didn't match "+String(r)),deepEqual(e[i],t)||mockExpectation.fail(this.method+" received wrong arguments "+format(e)+", expected "+format(r))},this))},allowsCall:function(t,e){var r=this.expectedArguments;if(this.met()&&receivedMaxCalls(this))return!1;if("expectedThis"in this&&this.expectedThis!==t)return!1;if(!("expectedArguments"in this))return!0;var i=e||[];return!(i.length<r.length)&&((!this.expectsExactArgCount||i.length===r.length)&&every(r,function(t,e){return!!verifyMatcher(t,i[e])&&!!deepEqual(i[e],t)}))},withArgs:function(){return this.expectedArguments=slice(arguments),this},withExactArgs:function(){return this.withArgs.apply(this,arguments),this.expectsExactArgCount=!0,this},on:function(t){return this.expectedThis=t,this},toString:function(){var t=slice(this.expectedArguments||[]);this.expectsExactArgCount||push(t,"[...]");var e=proxyCallToString.call({proxy:this.method||"anonymous mock expectation",args:t}).replace(", [...","[, ...")+" "+expectedCallCountInWords(this);return this.met()?"Expectation met: "+e:"Expected "+e+" ("+callCountInWords(this.callCount)+")"},verify:function(){return this.met()?mockExpectation.pass(String(this)):mockExpectation.fail(String(this)),!0},pass:function(t){assert.pass(t)},fail:function(t){var e=new Error(t);throw e.name="ExpectationError",e}};module.exports=mockExpectation;