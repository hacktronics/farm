"use strict";var arrayProto=require("@sinonjs/commons").prototypes.array,mockExpectation=require("./mock-expectation"),proxyCallToString=require("./proxy-call").toString,extend=require("./util/core/extend"),deepEqual=require("@sinonjs/samsam").deepEqual,wrapMethod=require("./util/core/wrap-method"),usePromiseLibrary=require("./util/core/use-promise-library"),concat=arrayProto.concat,filter=arrayProto.filter,forEach=arrayProto.forEach,every=arrayProto.every,join=arrayProto.join,push=arrayProto.push,slice=arrayProto.slice,unshift=arrayProto.unshift;function mock(t){return t&&"string"!=typeof t?mock.create(t):mockExpectation.create(t||"Anonymous mock")}function each(t,e){forEach(t||[],e)}function arrayEquals(t,e,r){return(!r||t.length===e.length)&&every(t,function(t,r){return deepEqual(e[r],t)})}extend(mock,{create:function(t){if(!t)throw new TypeError("object is null");var e=extend.nonEnum({},mock,{object:t});return delete e.create,e},expects:function(t){if(!t)throw new TypeError("method is falsy");if(this.expectations||(this.expectations={},this.proxies=[],this.failures=[]),!this.expectations[t]){this.expectations[t]=[];var e=this;wrapMethod(this.object,t,function(){return e.invokeMethod(t,this,arguments)}),push(this.proxies,t)}var r=mockExpectation.create(t);return r.wrappedMethod=this.object[t].wrappedMethod,push(this.expectations[t],r),usePromiseLibrary(this.promiseLibrary,r),r},restore:function(){var t=this.object;each(this.proxies,function(e){"function"==typeof t[e].restore&&t[e].restore()})},verify:function(){var t=this.expectations||{},e=this.failures?slice(this.failures):[],r=[];return each(this.proxies,function(o){each(t[o],function(t){t.met()?push(r,String(t)):push(e,String(t))})}),this.restore(),e.length>0?mockExpectation.fail(join(concat(e,r),"\n")):r.length>0&&mockExpectation.pass(join(concat(e,r),"\n")),!0},usingPromise:function(t){return this.promiseLibrary=t,this},invokeMethod:function(t,e,r){var o,i=this.expectations&&this.expectations[t]?this.expectations[t]:[],n=r||[],a=filter(i,function(t){return arrayEquals(t.expectedArguments||[],n,t.expectsExactArgCount)}),s=filter(a,function(t){return!t.met()&&t.allowsCall(e,r)});if(s.length>0)return s[0].apply(e,r);var c=[],u=0;if(forEach(a,function(t){t.allowsCall(e,r)?o=o||t:u+=1}),o&&0===u)return o.apply(e,r);forEach(i,function(t){push(c,"    "+String(t))}),unshift(c,"Unexpected call: "+proxyCallToString.call({proxy:t,args:r}));var p=new Error;if(!p.stack)try{throw p}catch(t){}push(this.failures,"Unexpected call: "+proxyCallToString.call({proxy:t,args:r,stack:p.stack})),mockExpectation.fail(join(c,"\n"))}}),module.exports=mock;