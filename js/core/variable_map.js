/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.VariableMap"),goog.require("Blockly.Events"),goog.require("Blockly.Events.VarDelete"),goog.require("Blockly.Events.VarRename"),goog.require("Blockly.Msg"),goog.require("Blockly.utils"),goog.require("Blockly.utils.object"),goog.requireType("Blockly.Block"),goog.requireType("Blockly.VariableModel"),goog.requireType("Blockly.Workspace"),Blockly.VariableMap=function(e){this.variableMap_=Object.create(null),this.workspace=e},Blockly.VariableMap.prototype.clear=function(){this.variableMap_=Object.create(null)},Blockly.VariableMap.prototype.renameVariable=function(e,a){var l=e.type,r=this.getVariable(a,l),t=this.workspace.getAllBlocks(!1);Blockly.Events.setGroup(!0);try{r&&r.getId()!=e.getId()?this.renameVariableWithConflict_(e,a,r,t):this.renameVariableAndUses_(e,a,t)}finally{Blockly.Events.setGroup(!1)}},Blockly.VariableMap.prototype.renameVariableById=function(e,a){var l=this.getVariableById(e);if(!l)throw Error("Tried to rename a variable that didn't exist. ID: "+e);this.renameVariable(l,a)},Blockly.VariableMap.prototype.renameVariableAndUses_=function(e,a,l){Blockly.Events.fire(new(Blockly.Events.get(Blockly.Events.VAR_RENAME))(e,a)),e.name=a;for(var r=0;r<l.length;r++)l[r].updateVarName(e)},Blockly.VariableMap.prototype.renameVariableWithConflict_=function(e,a,l,r){var t=e.type;a!=l.name&&this.renameVariableAndUses_(l,a,r);for(var i=0;i<r.length;i++)r[i].renameVarById(e.getId(),l.getId());Blockly.Events.fire(new(Blockly.Events.get(Blockly.Events.VAR_DELETE))(e));var o=this.getVariablesOfType(t).indexOf(e);this.variableMap_[t].splice(o,1)},Blockly.VariableMap.prototype.createVariable=function(e,a,l){var r=this.getVariable(e,a);if(r)return r;if(l&&this.getVariableById(l))throw Error('Variable id, "'+l+'", is already in use.');var t=l||Blockly.utils.genUid(),i=a||"";r=new Blockly.VariableModel(this.workspace,e,i,t);var o=this.variableMap_[i]||[];return o.push(r),delete this.variableMap_[i],this.variableMap_[i]=o,r},Blockly.VariableMap.prototype.deleteVariable=function(e){for(var a,l=this.variableMap_[e.type],r=0;a=l[r];r++)if(a.getId()==e.getId())return l.splice(r,1),void Blockly.Events.fire(new(Blockly.Events.get(Blockly.Events.VAR_DELETE))(e))},Blockly.VariableMap.prototype.deleteVariableById=function(e){var a=this.getVariableById(e);if(a){for(var l,r=a.name,t=this.getVariableUsesById(e),i=0;l=t[i];i++)if("procedures_defnoreturn"==l.type||"procedures_defreturn"==l.type){var o=l.getFieldValue("NAME"),n=Blockly.Msg.CANNOT_DELETE_VARIABLE_PROCEDURE.replace("%1",r).replace("%2",o);return void Blockly.alert(n)}var s=this;if(t.length>1){var p=Blockly.Msg.DELETE_VARIABLE_CONFIRMATION.replace("%1",String(t.length)).replace("%2",r);Blockly.confirm(p,function(e){e&&a&&s.deleteVariableInternal(a,t)})}else s.deleteVariableInternal(a,t)}else console.warn("Can't delete non-existent variable: "+e)},Blockly.VariableMap.prototype.deleteVariableInternal=function(e,a){var l=Blockly.Events.getGroup();l||Blockly.Events.setGroup(!0);try{for(var r=0;r<a.length;r++)a[r].dispose(!0);this.deleteVariable(e)}finally{l||Blockly.Events.setGroup(!1)}},Blockly.VariableMap.prototype.getVariable=function(e,a){var l=a||"",r=this.variableMap_[l];if(r)for(var t,i=0;t=r[i];i++)if(Blockly.Names.equals(t.name,e))return t;return null},Blockly.VariableMap.prototype.getVariableById=function(e){for(var a=Object.keys(this.variableMap_),l=0;l<a.length;l++)for(var r,t=a[l],i=0;r=this.variableMap_[t][i];i++)if(r.getId()==e)return r;return null},Blockly.VariableMap.prototype.getVariablesOfType=function(e){e=e||"";var a=this.variableMap_[e];return a?a.slice():[]},Blockly.VariableMap.prototype.getVariableTypes=function(e){var a={};Blockly.utils.object.mixin(a,this.variableMap_),e&&e.getPotentialVariableMap()&&Blockly.utils.object.mixin(a,e.getPotentialVariableMap().variableMap_);for(var l=Object.keys(a),r=!1,t=0;t<l.length;t++)""==l[t]&&(r=!0);return r||l.push(""),l},Blockly.VariableMap.prototype.getAllVariables=function(){var e=[];for(var a in this.variableMap_)e=e.concat(this.variableMap_[a]);return e},Blockly.VariableMap.prototype.getAllVariableNames=function(){var e=[];for(var a in this.variableMap_)for(var l,r=this.variableMap_[a],t=0;l=r[t];t++)e.push(l.name);return e},Blockly.VariableMap.prototype.getVariableUsesById=function(e){for(var a=[],l=this.workspace.getAllBlocks(!1),r=0;r<l.length;r++){var t=l[r].getVarModels();if(t)for(var i=0;i<t.length;i++)t[i].getId()==e&&a.push(l[r])}return a};