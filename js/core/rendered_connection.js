/**
 * @license
 * Copyright 2016 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.RenderedConnection"),goog.require("Blockly.Connection"),goog.require("Blockly.connectionTypes"),goog.require("Blockly.constants"),goog.require("Blockly.utils"),goog.require("Blockly.utils.Coordinate"),goog.require("Blockly.utils.deprecation"),goog.require("Blockly.utils.dom"),goog.require("Blockly.utils.object"),goog.require("Blockly.utils.Svg"),goog.requireType("Blockly.Block"),goog.requireType("Blockly.BlockSvg"),goog.requireType("Blockly.ConnectionDB"),Blockly.RenderedConnection=function(e,o){Blockly.RenderedConnection.superClass_.constructor.call(this,e,o),this.db_=e.workspace.connectionDBList[o],this.dbOpposite_=e.workspace.connectionDBList[Blockly.OPPOSITE_TYPE[o]],this.offsetInBlock_=new Blockly.utils.Coordinate(0,0),this.trackedState_=Blockly.RenderedConnection.TrackedState.WILL_TRACK,this.targetConnection=null},Blockly.utils.object.inherits(Blockly.RenderedConnection,Blockly.Connection),Blockly.RenderedConnection.TrackedState={WILL_TRACK:-1,UNTRACKED:0,TRACKED:1},Blockly.RenderedConnection.prototype.dispose=function(){Blockly.RenderedConnection.superClass_.dispose.call(this),this.trackedState_==Blockly.RenderedConnection.TrackedState.TRACKED&&this.db_.removeConnection(this,this.y)},Blockly.RenderedConnection.prototype.getSourceBlock=function(){return Blockly.RenderedConnection.superClass_.getSourceBlock.call(this)},Blockly.RenderedConnection.prototype.targetBlock=function(){return Blockly.RenderedConnection.superClass_.targetBlock.call(this)},Blockly.RenderedConnection.prototype.distanceFrom=function(e){var o=this.x-e.x,t=this.y-e.y;return Math.sqrt(o*o+t*t)},Blockly.RenderedConnection.prototype.bumpAwayFrom=function(e){if(!this.sourceBlock_.workspace.isDragging()){var o=this.sourceBlock_.getRootBlock();if(!o.isInFlyout){var t=!1;if(!o.isMovable()){if(!(o=e.getSourceBlock().getRootBlock()).isMovable())return;e=this,t=!0}var n=Blockly.selected==o;n||o.addSelect();var c=e.x+Blockly.SNAP_RADIUS+Math.floor(Math.random()*Blockly.BUMP_RANDOMNESS)-this.x,i=e.y+Blockly.SNAP_RADIUS+Math.floor(Math.random()*Blockly.BUMP_RANDOMNESS)-this.y;t&&(i=-i),o.RTL&&(c=e.x-Blockly.SNAP_RADIUS-Math.floor(Math.random()*Blockly.BUMP_RANDOMNESS)-this.x),o.moveBy(c,i),n||o.removeSelect()}}},Blockly.RenderedConnection.prototype.moveTo=function(e,o){this.trackedState_==Blockly.RenderedConnection.TrackedState.WILL_TRACK?(this.db_.addConnection(this,o),this.trackedState_=Blockly.RenderedConnection.TrackedState.TRACKED):this.trackedState_==Blockly.RenderedConnection.TrackedState.TRACKED&&(this.db_.removeConnection(this,this.y),this.db_.addConnection(this,o)),this.x=e,this.y=o},Blockly.RenderedConnection.prototype.moveBy=function(e,o){this.moveTo(this.x+e,this.y+o)},Blockly.RenderedConnection.prototype.moveToOffset=function(e){this.moveTo(e.x+this.offsetInBlock_.x,e.y+this.offsetInBlock_.y)},Blockly.RenderedConnection.prototype.setOffsetInBlock=function(e,o){this.offsetInBlock_.x=e,this.offsetInBlock_.y=o},Blockly.RenderedConnection.prototype.getOffsetInBlock=function(){return this.offsetInBlock_},Blockly.RenderedConnection.prototype.tighten=function(){var e=this.targetConnection.x-this.x,o=this.targetConnection.y-this.y;if(0!=Math.round(e)||0!=Math.round(o)){var t=this.targetBlock(),n=t.getSvgRoot();if(!n)throw Error("block is not rendered.");if(t.rendered){var c=Blockly.utils.getRelativeXY(n);t.getSvgRoot().setAttribute("transform","translate("+(c.x-e)+","+(c.y-o)+")"),t.moveConnections(-e,-o)}}},Blockly.RenderedConnection.prototype.closest=function(e,o){return this.dbOpposite_.searchForClosest(this,e,o)},Blockly.RenderedConnection.prototype.highlight=function(){var e,o=this.sourceBlock_.workspace.getRenderer().getConstants(),t=o.shapeFor(this);if(this.type==Blockly.connectionTypes.INPUT_VALUE||this.type==Blockly.connectionTypes.OUTPUT_VALUE){var n=o.TAB_OFFSET_FROM_TOP;e=Blockly.utils.svgPaths.moveBy(0,-n)+Blockly.utils.svgPaths.lineOnAxis("v",n)+t.pathDown+Blockly.utils.svgPaths.lineOnAxis("v",n)}else{var c=o.NOTCH_OFFSET_LEFT-o.CORNER_RADIUS;e=Blockly.utils.svgPaths.moveBy(-c,0)+Blockly.utils.svgPaths.lineOnAxis("h",c)+t.pathLeft+Blockly.utils.svgPaths.lineOnAxis("h",c)}var i=this.sourceBlock_.getRelativeToSurfaceXY(),l=this.x-i.x,r=this.y-i.y;Blockly.Connection.highlightedPath_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.PATH,{class:"blocklyHighlightedConnectionPath",d:e,transform:"translate("+l+","+r+")"+(this.sourceBlock_.RTL?" scale(-1 1)":"")},this.sourceBlock_.getSvgRoot())},Blockly.RenderedConnection.prototype.unhighlight=function(){Blockly.utils.dom.removeNode(Blockly.Connection.highlightedPath_),delete Blockly.Connection.highlightedPath_},Blockly.RenderedConnection.prototype.setTracking=function(e){if(!(e&&this.trackedState_==Blockly.RenderedConnection.TrackedState.TRACKED||!e&&this.trackedState_==Blockly.RenderedConnection.TrackedState.UNTRACKED||this.sourceBlock_.isInFlyout)){if(e)return this.db_.addConnection(this,this.y),void(this.trackedState_=Blockly.RenderedConnection.TrackedState.TRACKED);this.trackedState_==Blockly.RenderedConnection.TrackedState.TRACKED&&this.db_.removeConnection(this,this.y),this.trackedState_=Blockly.RenderedConnection.TrackedState.UNTRACKED}},Blockly.RenderedConnection.prototype.stopTrackingAll=function(){if(this.setTracking(!1),this.targetConnection)for(var e=this.targetBlock().getDescendants(!1),o=0;o<e.length;o++){for(var t=e[o],n=t.getConnections_(!0),c=0;c<n.length;c++)n[c].setTracking(!1);var i=t.getIcons();for(c=0;c<i.length;c++)i[c].setVisible(!1)}},Blockly.RenderedConnection.prototype.startTrackingAll=function(){this.setTracking(!0);var e=[];if(this.type!=Blockly.connectionTypes.INPUT_VALUE&&this.type!=Blockly.connectionTypes.NEXT_STATEMENT)return e;var o=this.targetBlock();if(o){var t;o.isCollapsed()?(t=[],o.outputConnection&&t.push(o.outputConnection),o.nextConnection&&t.push(o.nextConnection),o.previousConnection&&t.push(o.previousConnection)):t=o.getConnections_(!0);for(var n=0;n<t.length;n++)e.push.apply(e,t[n].startTrackingAll());e.length||(e[0]=o)}return e},Blockly.RenderedConnection.prototype.isConnectionAllowed=function(e,o){return Blockly.utils.deprecation.warn("RenderedConnection.prototype.isConnectionAllowed","July 2020","July 2021","Blockly.Workspace.prototype.getConnectionChecker().canConnect"),!(this.distanceFrom(e)>o)&&Blockly.RenderedConnection.superClass_.isConnectionAllowed.call(this,e)},Blockly.RenderedConnection.prototype.onFailedConnect=function(e){var o=this.getSourceBlock();if(Blockly.Events.recordUndo){var t=Blockly.Events.getGroup();setTimeout(function(){o.isDisposed()||o.getParent()||(Blockly.Events.setGroup(t),this.bumpAwayFrom(e),Blockly.Events.setGroup(!1))}.bind(this),Blockly.BUMP_DELAY)}},Blockly.RenderedConnection.prototype.disconnectInternal_=function(e,o){Blockly.RenderedConnection.superClass_.disconnectInternal_.call(this,e,o),e.rendered&&e.render(),o.rendered&&(o.updateDisabled(),o.render(),o.getSvgRoot().style.display="block")},Blockly.RenderedConnection.prototype.respawnShadow_=function(){Blockly.RenderedConnection.superClass_.respawnShadow_.call(this);var e=this.targetBlock();if(e){e.initSvg(),e.render(!1);var o=this.getSourceBlock();o.rendered&&o.render()}},Blockly.RenderedConnection.prototype.neighbours=function(e){return this.dbOpposite_.getNeighbours(this,e)},Blockly.RenderedConnection.prototype.connect_=function(e){Blockly.RenderedConnection.superClass_.connect_.call(this,e);var o=this,t=o.getSourceBlock(),n=e.getSourceBlock(),c=t.rendered,i=n.rendered;c&&t.updateDisabled(),i&&n.updateDisabled(),c&&i&&(o.type==Blockly.connectionTypes.NEXT_STATEMENT||o.type==Blockly.connectionTypes.PREVIOUS_STATEMENT?n.render():t.render());var l=t.getInputWithBlock(n);if(l){var r=l.isVisible();n.getSvgRoot().style.display=r?"block":"none"}},Blockly.RenderedConnection.prototype.onCheckChanged_=function(){!this.isConnected()||this.targetConnection&&this.getConnectionChecker().canConnect(this,this.targetConnection,!1)||((this.isSuperior()?this.targetBlock():this.sourceBlock_).unplug(),this.sourceBlock_.bumpNeighbours())};