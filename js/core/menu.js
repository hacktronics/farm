/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.Menu"),goog.require("Blockly.browserEvents"),goog.require("Blockly.utils.aria"),goog.require("Blockly.utils.Coordinate"),goog.require("Blockly.utils.dom"),goog.require("Blockly.utils.KeyCodes"),goog.require("Blockly.utils.style"),goog.requireType("Blockly.MenuItem"),goog.requireType("Blockly.utils.Size"),Blockly.Menu=function(){this.menuItems_=[],this.openingCoords=null,this.highlightedItem_=null,this.mouseOverHandler_=null,this.clickHandler_=null,this.mouseEnterHandler_=null,this.mouseLeaveHandler_=null,this.onKeyDownHandler_=null,this.element_=null,this.roleName_=null},Blockly.Menu.prototype.addChild=function(e){this.menuItems_.push(e)},Blockly.Menu.prototype.render=function(e){var t=document.createElement("div");t.className="blocklyMenu goog-menu blocklyNonSelectable",t.tabIndex=0,this.roleName_&&Blockly.utils.aria.setRole(t,this.roleName_),this.element_=t;for(var l,i=0;l=this.menuItems_[i];i++)t.appendChild(l.createDom());this.mouseOverHandler_=Blockly.browserEvents.conditionalBind(t,"mouseover",this,this.handleMouseOver_,!0),this.clickHandler_=Blockly.browserEvents.conditionalBind(t,"click",this,this.handleClick_,!0),this.mouseEnterHandler_=Blockly.browserEvents.conditionalBind(t,"mouseenter",this,this.handleMouseEnter_,!0),this.mouseLeaveHandler_=Blockly.browserEvents.conditionalBind(t,"mouseleave",this,this.handleMouseLeave_,!0),this.onKeyDownHandler_=Blockly.browserEvents.conditionalBind(t,"keydown",this,this.handleKeyEvent_),e.appendChild(t)},Blockly.Menu.prototype.getElement=function(){return this.element_},Blockly.Menu.prototype.focus=function(){var e=this.getElement();e&&(e.focus({preventScroll:!0}),Blockly.utils.dom.addClass(e,"blocklyFocused"))},Blockly.Menu.prototype.blur_=function(){var e=this.getElement();e&&(e.blur(),Blockly.utils.dom.removeClass(e,"blocklyFocused"))},Blockly.Menu.prototype.setRole=function(e){this.roleName_=e},Blockly.Menu.prototype.dispose=function(){this.mouseOverHandler_&&(Blockly.browserEvents.unbind(this.mouseOverHandler_),this.mouseOverHandler_=null),this.clickHandler_&&(Blockly.browserEvents.unbind(this.clickHandler_),this.clickHandler_=null),this.mouseEnterHandler_&&(Blockly.browserEvents.unbind(this.mouseEnterHandler_),this.mouseEnterHandler_=null),this.mouseLeaveHandler_&&(Blockly.browserEvents.unbind(this.mouseLeaveHandler_),this.mouseLeaveHandler_=null),this.onKeyDownHandler_&&(Blockly.browserEvents.unbind(this.onKeyDownHandler_),this.onKeyDownHandler_=null);for(var e,t=0;e=this.menuItems_[t];t++)e.dispose();this.element_=null},Blockly.Menu.prototype.getMenuItem_=function(e){for(var t=this.getElement();e&&e!=t;){if(Blockly.utils.dom.hasClass(e,"blocklyMenuItem"))for(var l,i=0;l=this.menuItems_[i];i++)if(l.getElement()==e)return l;e=e.parentElement}return null},Blockly.Menu.prototype.setHighlighted=function(e){var t=this.highlightedItem_;if(t&&(t.setHighlighted(!1),this.highlightedItem_=null),e){e.setHighlighted(!0),this.highlightedItem_=e;var l=this.getElement();Blockly.utils.style.scrollIntoContainerView(e.getElement(),l),Blockly.utils.aria.setState(l,Blockly.utils.aria.State.ACTIVEDESCENDANT,e.getId())}},Blockly.Menu.prototype.highlightNext=function(){var e=this.menuItems_.indexOf(this.highlightedItem_);this.highlightHelper_(e,1)},Blockly.Menu.prototype.highlightPrevious=function(){var e=this.menuItems_.indexOf(this.highlightedItem_);this.highlightHelper_(e<0?this.menuItems_.length:e,-1)},Blockly.Menu.prototype.highlightFirst_=function(){this.highlightHelper_(-1,1)},Blockly.Menu.prototype.highlightLast_=function(){this.highlightHelper_(this.menuItems_.length,-1)},Blockly.Menu.prototype.highlightHelper_=function(e,t){for(var l,i=e+t;l=this.menuItems_[i];){if(l.isEnabled()){this.setHighlighted(l);break}i+=t}},Blockly.Menu.prototype.handleMouseOver_=function(e){var t=this.getMenuItem_(e.target);t&&(t.isEnabled()?this.highlightedItem_!=t&&this.setHighlighted(t):this.setHighlighted(null))},Blockly.Menu.prototype.handleClick_=function(e){var t=this.openingCoords;if(this.openingCoords=null,t&&"number"==typeof e.clientX){var l=new Blockly.utils.Coordinate(e.clientX,e.clientY);if(Blockly.utils.Coordinate.distance(t,l)<1)return}var i=this.getMenuItem_(e.target);i&&i.performAction()},Blockly.Menu.prototype.handleMouseEnter_=function(e){this.focus()},Blockly.Menu.prototype.handleMouseLeave_=function(e){this.getElement()&&(this.blur_(),this.setHighlighted(null))},Blockly.Menu.prototype.handleKeyEvent_=function(e){if(this.menuItems_.length&&!(e.shiftKey||e.ctrlKey||e.metaKey||e.altKey)){var t=this.highlightedItem_;switch(e.keyCode){case Blockly.utils.KeyCodes.ENTER:case Blockly.utils.KeyCodes.SPACE:t&&t.performAction();break;case Blockly.utils.KeyCodes.UP:this.highlightPrevious();break;case Blockly.utils.KeyCodes.DOWN:this.highlightNext();break;case Blockly.utils.KeyCodes.PAGE_UP:case Blockly.utils.KeyCodes.HOME:this.highlightFirst_();break;case Blockly.utils.KeyCodes.PAGE_DOWN:case Blockly.utils.KeyCodes.END:this.highlightLast_();break;default:return}e.preventDefault(),e.stopPropagation()}},Blockly.Menu.prototype.getSize=function(){var e=this.getElement(),t=Blockly.utils.style.getSize(e);return t.height=e.scrollHeight,t};