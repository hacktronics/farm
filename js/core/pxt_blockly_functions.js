/**
 * @license
 * PXT Blockly fork
 *
 * The MIT License (MIT)
 *
 * Copyright (c) Microsoft Corporation
 *
 * All rights reserved.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
"use strict";goog.provide("Blockly.Functions"),goog.require("Blockly.Blocks"),goog.require("Blockly.constants"),goog.require("Blockly.Events.BlockChange"),goog.require("Blockly.Field"),goog.require("Blockly.Names"),goog.require("Blockly.pxtBlocklyUtils"),goog.require("Blockly.Workspace"),Blockly.Functions.NAME_TYPE=Blockly.PROCEDURE_CATEGORY_NAME,Blockly.Functions.flyoutCategory=function(t){var e=[];return Blockly.Functions.addCreateButton_(t,e),function(t,n){for(var o=0;o<t.length;o++){var l=t[o].getName(),c=t[o].getArguments(),i=Blockly.utils.xml.createElement("block");i.setAttribute("type",n),i.setAttribute("gap",16);var r=Blockly.utils.xml.createElement("mutation");r.setAttribute("name",l),i.appendChild(r);for(var u=0;u<c.length;u++){var a=Blockly.utils.xml.createElement("arg");a.setAttribute("name",c[u].name),a.setAttribute("type",c[u].type),a.setAttribute("id",c[u].id),r.appendChild(a)}e.push(i)}}(Blockly.Functions.getAllFunctionDefinitionBlocks(t),"function_call"),e},Blockly.Functions.addCreateButton_=function(t,e){var n=document.createElement("button"),o=Blockly.Msg.FUNCTION_CREATE_NEW,l="CREATE_FUNCTION";n.setAttribute("text",o),n.setAttribute("callbackKey",l),t.registerButtonCallback(l,function(){Blockly.Functions.createFunctionCallback_(t)}),e.push(n)},Blockly.Functions.getCallers=function(t,e){for(var n=[],o=e.getAllBlocks(),l=0;l<o.length;l++){if(o[l].type==Blockly.FUNCTION_CALL_BLOCK_TYPE||o[l].type===Blockly.FUNCTION_CALL_OUTPUT_BLOCK_TYPE)if(o[l].getName)o[l].getName()==t&&n.push(o[l])}return n},Blockly.Functions.getDefinition=function(t,e){for(var n=e.getTopBlocks(!1),o=0;o<n.length;o++){if(n[o].type==Blockly.FUNCTION_DEFINITION_BLOCK_TYPE&&n[o].getName)if(n[o].getName()==t)return n[o]}return null},Blockly.Functions.getAllFunctionDefinitionBlocks=function(t){for(var e=t.getTopBlocks(!1),n=[],o=0;o<e.length;o++)e[o].type===Blockly.FUNCTION_DEFINITION_BLOCK_TYPE&&n.push(e[o]);return n},Blockly.Functions.isCustomType=function(t){return!("boolean"==t||"string"==t||"number"==t)},Blockly.Functions.newFunctionMutation=function(t){var e='<xml><mutation name="'+Blockly.Functions.findLegalName(Blockly.Msg.FUNCTIONS_DEFAULT_FUNCTION_NAME,t)+'" functionid="'+Blockly.utils.genUid()+'"></mutation></xml>',n=Blockly.Xml.textToDom(e).firstChild;return n.removeAttribute("xmlns"),n},Blockly.Functions.incrementNameSuffix=function(t){var e=t.match(/^(.*?)(\d+)$/);return e?t=e[1]+(parseInt(e[2],10)+1):t+="2",t},Blockly.Functions.findUniqueParamName=function(t,e){for(;!Blockly.Functions.isUniqueParamName(t,e);)t=Blockly.Functions.incrementNameSuffix(t);return t},Blockly.Functions.isUniqueParamName=function(t,e){return!e||-1==e.indexOf(t)},Blockly.Functions.createFunctionCallback_=function(t){Blockly.hideChaff(),Blockly.selected&&Blockly.selected.unselect(),Blockly.Functions.editFunctionExternalHandler(Blockly.Functions.newFunctionMutation(t),Blockly.Functions.createFunctionCallbackFactory_(t))},Blockly.Functions.createFunctionCallbackFactory_=function(t){return function(e){if(e){var n='<xml><block type="'+Blockly.FUNCTION_DEFINITION_BLOCK_TYPE+'">'+Blockly.Xml.domToText(e)+"</block></xml>",o=Blockly.Xml.textToDom(n);Blockly.Events.setGroup(!0);var l=Blockly.Xml.domToBlock(o.firstChild,t);if(l.updateDisplay_(),t.getMetrics){var c=t.getMetrics(),i=l.getHeightWidth();l.moveBy(c.viewLeft+c.viewWidth/2-i.width/2,c.viewTop+c.viewHeight/2-i.height/2),l.scheduleSnapAndBump()}t.centerOnBlock(l.id),Blockly.Events.setGroup(!1)}}},Blockly.Functions.editFunctionCallback_=function(t){if(t.type==Blockly.FUNCTION_CALL_BLOCK_TYPE||t.type==Blockly.FUNCTION_CALL_OUTPUT_BLOCK_TYPE){var e=t.workspace.isFlyout?t.workspace.targetWorkspace:t.workspace;t=Blockly.Functions.getDefinition(t.getName(),e)}Blockly.hideChaff(),Blockly.selected&&Blockly.selected.unselect(),Blockly.Functions.editFunctionExternalHandler(t.mutationToDom(),Blockly.Functions.editFunctionCallbackFactory_(t))},Blockly.Functions.editFunctionCallbackFactory_=function(t){return function(e){e&&(Blockly.Functions.mutateCallersAndDefinition(t.getName(),t.workspace,e),t.updateDisplay_())}},Blockly.Functions.editFunctionExternalHandler=function(t,e){console.warn("External function editor must be overriden: Blockly.Functions.editFunctionExternalHandler",t,e)},Blockly.Functions.makeEditOption=function(t){return{enabled:!t.inDebugWorkspace(),text:Blockly.Msg.FUNCTIONS_EDIT_OPTION,callback:function(){Blockly.Functions.editFunctionCallback_(t)}}},Blockly.Functions.makeCreateCallOption=function(t){var e=t.getField("function_name").getText(),n=goog.dom.createDom("mutation");n.setAttribute("name",e);var o=goog.dom.createDom("block",null,n);return o.setAttribute("type","function_call"),{enabled:t.workspace.remainingCapacity()>0&&!t.inDebugWorkspace(),text:Blockly.Msg.FUNCTIONS_CREATE_CALL_OPTION.replace("%1",e),callback:Blockly.ContextMenu.callbackFactory(t,o)}},Blockly.Functions.makeGoToDefinitionOption=function(t){return{enabled:!t.inDebugWorkspace(),text:Blockly.Msg.FUNCTIONS_GO_TO_DEFINITION_OPTION,callback:function(){var e=t.getField("function_name").getText(),n=Blockly.Functions.getDefinition(e,t.workspace);n&&t.workspace.centerOnBlock(n.id)}}},Blockly.Functions.getReporterArgumentType=function(t){switch(t){case"Boolean":case"Number":case"String":return t.toLowerCase();default:return t}},Blockly.Functions.namesInUse=function(t,e,n){var o={};return t.getAllVariables().forEach(function(t){o[t.name]=!0}),t.getAllBlocks().forEach(function(t){t==e||n&&t.getFunctionId&&t.getFunctionId()==n||(t.type==Blockly.FUNCTION_DEFINITION_BLOCK_TYPE?o[t.getName()]=!0:"procedures_defreturn"!=t.type&&"procedures_defnoreturn"!=t.type||(o[t.getProcedureDef()[0]]=!0))}),o},Blockly.Functions.idsInUse=function(t){var e=[];return t.getAllBlocks().forEach(function(t){t.type==Blockly.FUNCTION_DEFINITION_BLOCK_TYPE&&e.push(t.getFunctionId())}),e},Blockly.Functions.findLegalName=function(t,e,n){if(n&&n.isInFlyout)return t;for(var o=Blockly.Functions.namesInUse(e,n);o[t];)t=Blockly.Functions.incrementNameSuffix(t);return t},Blockly.Functions.rename=function(t){t=t.replace(/^[\s\xa0]+|[\s\xa0]+$/g,"");var e=Blockly.Functions.findLegalName(t,this.sourceBlock_.workspace,this.sourceBlock_),n=this.getValue();if(!t)return n;if(!e)return t;if(!n)return this.sourceBlock_.name_=e,e;if(n!=t&&n!=e){var o=this.sourceBlock_;o.name_=e;var l=o.mutationToDom();o.name_=n,Blockly.Functions.mutateCallersAndDefinition(n,o.workspace,l)}return e},Blockly.Functions.validateFunctionExternal=function(t,e){var n=t.getAttribute("name");if(!n)return Blockly.alert(Blockly.Msg.FUNCTION_WARNING_EMPTY_NAME),!1;for(var o={},l=0;l<t.childNodes.length;++l){var c=t.childNodes[l].getAttribute("name");if(!c)return Blockly.alert(Blockly.Msg.FUNCTION_WARNING_EMPTY_NAME),!1;if(o[c])return Blockly.alert(Blockly.Msg.FUNCTION_WARNING_DUPLICATE_ARG),!1;o[c]=!0}if(o[n])return Blockly.alert(Blockly.Msg.FUNCTION_WARNING_ARG_NAME_IS_FUNCTION_NAME),!1;var i=t.getAttribute("functionid");return!Blockly.Functions.namesInUse(e,null,i)[n]||(Blockly.alert(Blockly.Msg.VARIABLE_ALREADY_EXISTS.replace("%1",n)),!1)},Blockly.Functions.getArgMap=function(t,e){for(var n={},o=0;o<t.childNodes.length;++o){var l=t.childNodes[o],c=e?l.getAttribute("id"):l.getAttribute("name"),i=e?l.getAttribute("name"):l.getAttribute("id");n[c]=i}return n},Blockly.Functions.mutateCallersAndDefinition=function(t,e,n){var o=Blockly.Functions.getDefinition(t,e);if(o){var l=Blockly.Functions.getCallers(t,o.workspace);l.push(o),Blockly.Events.setGroup(!0),l.forEach(function(t){var e=t.mutationToDom(),l=e&&Blockly.Xml.domToText(e);t.domToMutation(n);var c=t.mutationToDom(),i=c&&Blockly.Xml.domToText(c);if(l!=i)if(Blockly.Events.fire(new Blockly.Events.BlockChange(t,"mutation",null,l,i)),t.id==o.id){var r=Blockly.Functions.getArgMap(e),u=Blockly.Functions.getArgMap(c,!0);o.getDescendants().forEach(function(t){if(Blockly.pxtBlocklyUtils.isFunctionArgumentReporter(t)){var e=t.getFieldValue("VALUE"),n=r[e];u[n]?u[n]!==e&&t.setFieldValue(u[n],"VALUE"):t.dispose()}})}else setTimeout(function(){t.bumpNeighbours()},Blockly.BUMP_DELAY)}),Blockly.Events.setGroup(!1)}else console.warn("Attempted to change function "+t+", but no definition block was found on the workspace")},Blockly.Functions.createFlyout=function(t,e){let n,o=new Blockly.Options({scrollbars:!0,disabledPatternId:t.options.disabledPatternId,parentWorkspace:t,rtl:t.RTL,oneBasedIndex:t.options.oneBasedIndex,horizontalLayout:t.horizontalLayout,toolboxPosition:t.options.toolboxPosition,zoomOptions:t.options.zoomOptions,renderer:t.options.renderer,rendererOverrides:t.options.rendererOverrides,newFunctions:t.options.newFunctions,move:{scrollbars:!0}});n=o.horizontalLayout?new Blockly.HorizontalFlyout(o):new Blockly.VerticalFlyout(o);let l=n.createDom("svg");return goog.dom.insertSiblingAfter(l,e),n.init(t),n};