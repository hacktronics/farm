/**
 * @license
 * Copyright 2011 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.Flyout"),goog.require("Blockly.Block"),goog.require("Blockly.blockRendering"),goog.require("Blockly.browserEvents"),goog.require("Blockly.ComponentManager"),goog.require("Blockly.DeleteArea"),goog.require("Blockly.Events"),goog.require("Blockly.Events.BlockCreate"),goog.require("Blockly.Events.VarCreate"),goog.require("Blockly.FlyoutMetricsManager"),goog.require("Blockly.Gesture"),goog.require("Blockly.IFlyout"),goog.require("Blockly.ScrollbarPair"),goog.require("Blockly.Tooltip"),goog.require("Blockly.Touch"),goog.require("Blockly.utils"),goog.require("Blockly.utils.Coordinate"),goog.require("Blockly.utils.dom"),goog.require("Blockly.utils.Svg"),goog.require("Blockly.utils.toolbox"),goog.require("Blockly.utils.xml"),goog.require("Blockly.WorkspaceSvg"),goog.require("Blockly.Xml"),goog.requireType("Blockly.BlockSvg"),goog.requireType("Blockly.FlyoutButton"),goog.requireType("Blockly.Options"),goog.requireType("Blockly.utils.Rect"),Blockly.Flyout=function(t){Blockly.Flyout.superClass_.constructor.call(this),t.setMetrics=this.setMetrics_.bind(this),this.workspace_=new Blockly.WorkspaceSvg(t),this.workspace_.setMetricsManager(new Blockly.FlyoutMetricsManager(this.workspace_,this)),this.workspace_.isFlyout=!0,this.workspace_.setVisible(this.isVisible_),this.id=Blockly.utils.genUid(),this.RTL=!!t.RTL,this.horizontalLayout=!1,this.toolboxPosition_=t.toolboxPosition,this.hasTwoScrolls=!1,this.eventWrappers_=[],this.mats_=[],this.buttons_=[],this.listeners_=[],this.permanentlyDisabled_=[],this.tabWidth_=this.workspace_.getRenderer().getConstants().TAB_WIDTH,this.targetWorkspace=null},Blockly.utils.object.inherits(Blockly.Flyout,Blockly.DeleteArea),Blockly.Flyout.prototype.autoClose=!0,Blockly.Flyout.prototype.isVisible_=!1,Blockly.Flyout.prototype.containerVisible_=!0,Blockly.Flyout.prototype.CORNER_RADIUS=8,Blockly.Flyout.prototype.MARGIN=Blockly.Flyout.prototype.CORNER_RADIUS,Blockly.Flyout.prototype.GAP_X=3*Blockly.Flyout.prototype.MARGIN,Blockly.Flyout.prototype.GAP_Y=3*Blockly.Flyout.prototype.MARGIN,Blockly.Flyout.prototype.SCROLLBAR_MARGIN=2.5,Blockly.Flyout.prototype.width_=0,Blockly.Flyout.prototype.height_=0,Blockly.Flyout.prototype.dragAngleRange_=70,Blockly.Flyout.prototype.svgGroup_=null,Blockly.Flyout.prototype.scrollbar_=null,Blockly.Flyout.prototype.targetWorkspace_=null,Blockly.Flyout.prototype.createDom=function(t){return this.svgGroup_=Blockly.utils.dom.createSvgElement(t,{class:"blocklyFlyout",style:"display: none"},null),this.svgBackground_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.PATH,{class:"blocklyFlyoutBackground"},this.svgGroup_),this.svgGroup_.appendChild(this.workspace_.createDom()),this.workspace_.getThemeManager().subscribe(this.svgBackground_,"flyoutBackgroundColour","fill"),this.workspace_.getThemeManager().subscribe(this.svgBackground_,"flyoutOpacity","fill-opacity"),this.svgGroup_},Blockly.Flyout.prototype.init=function(t){this.targetWorkspace=t,this.workspace_.targetWorkspace=t,this.workspace_.scrollbar=new Blockly.ScrollbarPair(this.workspace_,this.horizontalLayout||this.hasTwoScrolls,!this.horizontalLayout||this.hasTwoScrolls,"blocklyFlyoutScrollbar",this.SCROLLBAR_MARGIN),this.hide(),Array.prototype.push.apply(this.eventWrappers_,Blockly.browserEvents.conditionalBind(this.svgGroup_,"wheel",this,this.wheel_)),this.autoClose||(this.filterWrapper_=this.filterForCapacity_.bind(this),this.targetWorkspace.addChangeListener(this.filterWrapper_)),Array.prototype.push.apply(this.eventWrappers_,Blockly.browserEvents.conditionalBind(this.svgBackground_,"mousedown",this,this.onMouseDown_)),this.workspace_.getGesture=this.targetWorkspace.getGesture.bind(this.targetWorkspace),this.workspace_.setVariableMap(this.targetWorkspace.getVariableMap()),this.workspace_.createPotentialVariableMap(),t.getComponentManager().addComponent({component:this,weight:1,capabilities:[Blockly.ComponentManager.Capability.DELETE_AREA,Blockly.ComponentManager.Capability.DRAG_TARGET]})},Blockly.Flyout.prototype.dispose=function(){this.hide(),this.clearOldEventListeners_(),this.workspace_.getComponentManager().removeComponent(this.id),Blockly.browserEvents.unbind(this.eventWrappers_),this.filterWrapper_&&(this.targetWorkspace.removeChangeListener(this.filterWrapper_),this.filterWrapper_=null),this.workspace_&&(this.workspace_.getThemeManager().unsubscribe(this.svgBackground_),this.workspace_.targetWorkspace=null,this.workspace_.dispose(),this.workspace_=null),this.svgGroup_&&(Blockly.utils.dom.removeNode(this.svgGroup_),this.svgGroup_=null),this.svgBackground_=null,this.targetWorkspace=null},Blockly.Flyout.prototype.getWidth=function(){return this.width_},Blockly.Flyout.prototype.getHeight=function(){return this.height_},Blockly.Flyout.prototype.getFlyoutScale=function(){return this.targetWorkspace.scale},Blockly.Flyout.prototype.getWorkspace=function(){return this.workspace_},Blockly.Flyout.prototype.isVisible=function(){return this.isVisible_},Blockly.Flyout.prototype.setVisible=function(t){var o=t!=this.isVisible();this.isVisible_=t,o&&(this.autoClose||this.workspace_.recordDragTargets(),this.updateDisplay_())},Blockly.Flyout.prototype.setContainerVisible=function(t){var o=t!=this.containerVisible_;this.containerVisible_=t,o&&this.updateDisplay_()},Blockly.Flyout.prototype.updateDisplay_=function(){var t=!0;t=!!this.containerVisible_&&this.isVisible(),this.svgGroup_.style.display=t?"block":"none",this.workspace_.scrollbar.setContainerVisible(t)},Blockly.Flyout.prototype.setTwoScrolls=function(){this.hasTwoScrolls||(this.hasTwoScrolls=!0)},Blockly.Flyout.prototype.positionAt_=function(t,o,e,l){if(this.svgGroup_.setAttribute("width",t),this.svgGroup_.setAttribute("height",o),this.workspace_.setCachedParentSvgSize(t,o),"svg"==this.svgGroup_.tagName){var r="translate("+e+"px,"+l+"px)";Blockly.utils.dom.setCssTransform(this.svgGroup_,r)}else{r="translate("+e+","+l+")";this.svgGroup_.setAttribute("transform",r)}var s=this.workspace_.scrollbar;s&&(s.setOrigin(e,l),s.resize(),s.hScroll&&s.hScroll.setPosition(s.hScroll.position.x,s.hScroll.position.y),s.vScroll&&s.vScroll.setPosition(s.vScroll.position.x,s.vScroll.position.y))},Blockly.Flyout.prototype.hide=function(){this.isVisible()&&this.setVisible(!1)},Blockly.Flyout.prototype.clearOldEventListeners_=function(){for(var t,o=0;t=this.listeners_[o];o++)Blockly.browserEvents.unbind(t);this.listeners_.length=0,this.reflowWrapper_&&(this.workspace_.removeChangeListener(this.reflowWrapper_),this.reflowWrapper_=null)},Blockly.Flyout.prototype.show=function(t){this.workspace_.setResizesEnabled(!1),this.hide(),this.clearOldEventListeners_(),this.clearOldBlocks_(),"string"==typeof t&&(t=this.getDynamicCategoryContents_(t)),this.setVisible(!0);var o=Blockly.utils.toolbox.convertFlyoutDefToJsonArray(t),e=this.createFlyoutInfo_(o);this.layout_(e.contents,e.gaps);this.listeners_.push(Blockly.browserEvents.conditionalBind(this.svgBackground_,"mouseover",this,function(){for(var t,o=this.workspace_.getTopBlocks(!1),e=0;t=o[e];e++)t.removeSelect()})),this.horizontalLayout?this.height_=0:this.width_=0,this.workspace_.setResizesEnabled(!0),this.reflow(),this.filterForCapacity_(),this.position(),this.reflowWrapper_=this.reflow.bind(this),this.workspace_.addChangeListener(this.reflowWrapper_)},Blockly.Flyout.prototype.createFlyoutInfo_=function(t){var o=[],e=[];this.permanentlyDisabled_.length=0;for(var l,r=this.horizontalLayout?this.GAP_X:this.GAP_Y,s=0;l=t[s];s++){if(l.custom){var i=l.custom,a=this.getDynamicCategoryContents_(i),c=Blockly.utils.toolbox.convertFlyoutDefToJsonArray(a);t.splice.apply(t,[s,1].concat(c)),l=t[s]}switch(l.kind.toUpperCase()){case"BLOCK":var n=l,y=this.getBlockXml_(n),p=this.createBlock_(y),u=parseInt(n.gap||y.getAttribute("gap"),10);e.push(isNaN(u)?r:u),o.push({type:"block",block:p});break;case"SEP":var h=l;this.addSeparatorGap_(h,e,r);break;case"LABEL":var k=l,g=this.createButton_(k,!0);o.push({type:"button",button:g}),e.push(r);break;case"BUTTON":var B=l,_=this.createButton_(B,!1);o.push({type:"button",button:_}),e.push(r)}}return{contents:o,gaps:e}},Blockly.Flyout.prototype.getDynamicCategoryContents_=function(t){var o=this.workspace_.targetWorkspace.getToolboxCategoryCallback(t);if("function"!=typeof o)throw TypeError("Couldn't find a callback function when opening a toolbox category.");var e=o(this.workspace_.targetWorkspace);if(!Array.isArray(e))throw new TypeError("Result of toolbox category callback must be an array.");return e},Blockly.Flyout.prototype.createButton_=function(t,o){if(!Blockly.FlyoutButton)throw Error("Missing require for Blockly.FlyoutButton");return new Blockly.FlyoutButton(this.workspace_,this.targetWorkspace,t,o)},Blockly.Flyout.prototype.createBlock_=function(t){var o=Blockly.Xml.domToBlock(t,this.workspace_);return o.isEnabled()||this.permanentlyDisabled_.push(o),o},Blockly.Flyout.prototype.getBlockXml_=function(t){var o=null,e=t.blockxml;if(e&&"string"!=typeof e?o=e:e&&"string"==typeof e?(o=Blockly.Xml.textToDom(e),t.blockxml=o):t.type&&((o=Blockly.utils.xml.createElement("xml")).setAttribute("type",t.type),o.setAttribute("disabled",t.disabled),t.blockxml=o),!o)throw Error("Error: Invalid block definition. Block definition must have blockxml or type.");return o},Blockly.Flyout.prototype.addSeparatorGap_=function(t,o,e){var l=parseInt(t.gap,10);!isNaN(l)&&o.length>0?o[o.length-1]=l:o.push(e)},Blockly.Flyout.prototype.clearOldBlocks_=function(){for(var t,o=this.workspace_.getTopBlocks(!1),e=0;t=o[e];e++)t.workspace==this.workspace_&&t.dispose(!1,!1);for(var l=0;l<this.mats_.length;l++){var r=this.mats_[l];r&&(Blockly.Tooltip.unbindMouseEvents(r),Blockly.utils.dom.removeNode(r))}this.mats_.length=0;var s;for(e=0;s=this.buttons_[e];e++)s.dispose();this.buttons_.length=0,this.workspace_.getPotentialVariableMap().clear()},Blockly.Flyout.prototype.addBlockListeners_=function(t,o,e){this.listeners_.push(Blockly.browserEvents.conditionalBind(t,"mousedown",null,this.blockMouseDown_(o))),this.listeners_.push(Blockly.browserEvents.conditionalBind(e,"mousedown",null,this.blockMouseDown_(o))),this.listeners_.push(Blockly.browserEvents.bind(t,"mouseenter",o,o.addSelect)),this.listeners_.push(Blockly.browserEvents.bind(t,"mouseleave",o,o.removeSelect)),this.listeners_.push(Blockly.browserEvents.bind(e,"mouseenter",o,o.addSelect)),this.listeners_.push(Blockly.browserEvents.bind(e,"mouseleave",o,o.removeSelect))},Blockly.Flyout.prototype.blockMouseDown_=function(t){var o=this;return function(e){var l=o.targetWorkspace.getGesture(e);l&&(l.setStartBlock(t),l.handleFlyoutStart(e,o))}},Blockly.Flyout.prototype.onMouseDown_=function(t){var o=this.targetWorkspace.getGesture(t);o&&o.handleFlyoutStart(t,this)},Blockly.Flyout.prototype.isBlockCreatable_=function(t){return t.isEnabled()},Blockly.Flyout.prototype.createBlock=function(t){var o=null;Blockly.Events.disable();var e=this.targetWorkspace.getAllVariables();this.targetWorkspace.setResizesEnabled(!1);try{o=this.placeNewBlock_(t)}finally{Blockly.Events.enable()}Blockly.hideChaff();var l=Blockly.Variables.getAddedVariables(this.targetWorkspace,e);if(Blockly.Events.isEnabled()){Blockly.Events.setGroup(!0);for(var r=0;r<l.length;r++){var s=l[r];Blockly.Events.fire(new(Blockly.Events.get(Blockly.Events.VAR_CREATE))(s))}Blockly.Events.fire(new(Blockly.Events.get(Blockly.Events.BLOCK_CREATE))(o))}return this.autoClose?this.hide():this.filterForCapacity_(),o},Blockly.Flyout.prototype.initFlyoutButton_=function(t,o,e){var l=t.createDom();t.moveTo(o,e),t.show(),this.listeners_.push(Blockly.browserEvents.conditionalBind(l,"mousedown",this,this.onMouseDown_)),this.buttons_.push(t)},Blockly.Flyout.prototype.createRect_=function(t,o,e,l,r){var s=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.RECT,{"fill-opacity":0,x:o,y:e,height:l.height,width:l.width},null);return s.tooltip=t,Blockly.Tooltip.bindMouseEvents(s),this.workspace_.getCanvas().insertBefore(s,t.getSvgRoot()),t.flyoutRect_=s,this.mats_[r]=s,s},Blockly.Flyout.prototype.moveRectToBlock_=function(t,o){var e=o.getHeightWidth();t.setAttribute("width",e.width),t.setAttribute("height",e.height);var l=o.startHat_?Blockly.BlockSvg.START_HAT_HEIGHT:0;l&&o.moveBy(0,l);var r=o.getRelativeToSurfaceXY();t.setAttribute("y",r.y),t.setAttribute("x",this.RTL?r.x-e.width:r.x)},Blockly.Flyout.prototype.filterForCapacity_=function(){for(var t,o=this.workspace_.getTopBlocks(!1),e=0;t=o[e];e++)if(-1==this.permanentlyDisabled_.indexOf(t))for(var l=this.targetWorkspace.isCapacityAvailable(Blockly.utils.getBlockTypeCounts(t));t;)t.setEnabled(l),t=t.getNextBlock()},Blockly.Flyout.prototype.reflow=function(){this.reflowWrapper_&&this.workspace_.removeChangeListener(this.reflowWrapper_),this.reflowInternal_(),this.reflowWrapper_&&this.workspace_.addChangeListener(this.reflowWrapper_)},Blockly.Flyout.prototype.isScrollable=function(){return!!this.workspace_.scrollbar&&this.workspace_.scrollbar.isVisible()},Blockly.Flyout.prototype.placeNewBlock_=function(t){var o=this.targetWorkspace;if(!t.getSvgRoot())throw Error("oldBlock is not rendered.");"function_call"==t.type&&t.inputList.forEach(function(t){if(t.connection&&t.connection.targetConnection&&"variables_get"==t.connection.targetBlock().type){var e=t.connection.targetBlock(),l=e.inputList[0].fieldRow[0].getText(),r=Blockly.Variables.getOrCreateVariablePackage(o,null,l,"").getId();e.setFieldValue(r,"VAR")}});var e=Blockly.Xml.blockToDom(t,!0);o.setResizesEnabled(!1);var l=Blockly.Xml.domToBlock(e,o);if(!l.getSvgRoot())throw Error("block is not rendered.");var r=o.getOriginOffsetInPixels(),s=this.workspace_.getOriginOffsetInPixels(),i=t.getRelativeToSurfaceXY();i.scale(this.workspace_.scale);var a=Blockly.utils.Coordinate.sum(s,i),c=Blockly.utils.Coordinate.difference(a,r);return c.scale(1/o.scale),l.moveBy(c.x,c.y),l},Blockly.Flyout.prototype.getClientRect,Blockly.Flyout.prototype.position,Blockly.Flyout.prototype.isDragTowardWorkspace,Blockly.Flyout.prototype.setMetrics_,Blockly.Flyout.prototype.layout_,Blockly.Flyout.prototype.wheel_,Blockly.Flyout.prototype.reflowInternal_,Blockly.Flyout.prototype.getX,Blockly.Flyout.prototype.getY;