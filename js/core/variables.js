/**
 * @license
 * Copyright 2012 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.Variables"),goog.require("Blockly.Blocks"),goog.require("Blockly.constants"),goog.require("Blockly.Msg"),goog.require("Blockly.utils"),goog.require("Blockly.utils.xml"),goog.require("Blockly.VariableModel"),goog.require("Blockly.Xml"),goog.requireType("Blockly.Workspace"),Blockly.Variables.NAME_TYPE=Blockly.VARIABLE_CATEGORY_NAME,Blockly.Variables.allUsedVarModels=function(e){for(var l=e.getAllBlocks(!1).filter(e=>!e.disabled),a=Object.create(null),r=0;r<l.length;r++){var t=l[r].getVarModels();if(t)for(var o=0;o<t.length;o++){var i=t[o];(c=i.getId())&&(a[c]=i)}}var n=[];for(var c in a)n.push(a[c]);return n},Blockly.Variables.ALL_DEVELOPER_VARS_WARNINGS_BY_BLOCK_TYPE_={},Blockly.Variables.allDeveloperVariables=function(e){for(var l,a=e.getAllBlocks(!1),r=Object.create(null),t=0;l=a[t];t++){var o=l.getDeveloperVariables;if(!o&&l.getDeveloperVars&&(o=l.getDeveloperVars,Blockly.Variables.ALL_DEVELOPER_VARS_WARNINGS_BY_BLOCK_TYPE_[l.type]||(console.warn("Function getDeveloperVars() deprecated. Use getDeveloperVariables() (block type '"+l.type+"')"),Blockly.Variables.ALL_DEVELOPER_VARS_WARNINGS_BY_BLOCK_TYPE_[l.type]=!0)),o)for(var i=o(),n=0;n<i.length;n++)r[i[n]]=!0}return Object.keys(r)},Blockly.Variables.flyoutCategory=function(e){var l=[],a=document.createElement("button");a.setAttribute("text","%{BKY_NEW_VARIABLE}"),a.setAttribute("callbackKey","CREATE_VARIABLE"),e.registerButtonCallback(Blockly.CREATE_VARIABLE_ID,function(e){Blockly.Variables.createVariableButtonHandler(e.getTargetWorkspace())}),l.push(a);var r=Blockly.Variables.flyoutCategoryBlocks(e);return l=l.concat(r)},Blockly.Variables.flyoutCategoryBlocks=function(e){var l=e.getVariablesOfType(""),a=[];if(l.length>0){var r=l[l.length-1];if(Blockly.Blocks.variables_set)(n=Blockly.utils.xml.createElement("block")).setAttribute("type","variables_set"),n.setAttribute("gap",Blockly.Blocks.math_change?8:24),n.appendChild(Blockly.Variables.generateVariableFieldDom(r)),a.push(n);if(Blockly.Blocks.math_change){(n=Blockly.utils.xml.createElement("block")).setAttribute("type","math_change"),n.setAttribute("gap",Blockly.Blocks.variables_get?20:8),n.appendChild(Blockly.Variables.generateVariableFieldDom(r));var t=Blockly.Xml.textToDom('<value name="DELTA"><shadow type="math_number"><field name="NUM">1</field></shadow></value>');n.appendChild(t),a.push(n)}if(Blockly.Blocks.variables_get){l.sort(Blockly.VariableModel.compareByName);for(var o,i=0;o=l[i];i++){var n;(n=Blockly.utils.xml.createElement("block")).setAttribute("type","variables_get"),n.setAttribute("gap",8),n.appendChild(Blockly.Variables.generateVariableFieldDom(o)),a.push(n)}}}return a},Blockly.Variables.VAR_LETTER_OPTIONS="ijkmnopqrstuvwxyzabcdefgh",Blockly.Variables.generateUniqueName=function(e){return Blockly.Variables.generateUniqueNameFromOptions(Blockly.Variables.VAR_LETTER_OPTIONS.charAt(0),e.getAllVariableNames())},Blockly.Variables.generateUniqueNameFromOptions=function(e,l){if(!l.length)return e;for(var a=Blockly.Variables.VAR_LETTER_OPTIONS,r="",t=a.indexOf(e),o=e;;){for(var i=!1,n=0;n<l.length;n++)if(l[n].toLowerCase()==o){i=!0;break}if(!i)return o;++t==a.length&&(t=0,r=Number(r)+1),o=a.charAt(t)+r}},Blockly.Variables.createVariableButtonHandler=function(e,l,a){var r=a||"",t=function(a){Blockly.Variables.promptName(Blockly.Msg.NEW_VARIABLE_TITLE,a,function(a){if(a){var o=Blockly.Variables.nameUsedWithAnyType(a,e),i=Blockly.Functions.getDefinition(a,e);if(o||i){if(i||o.type==r)var n=Blockly.Msg.VARIABLE_ALREADY_EXISTS.replace("%1",o.name);else n=(n=Blockly.Msg.VARIABLE_ALREADY_EXISTS_FOR_ANOTHER_TYPE).replace("%1",o.name).replace("%2",o.type);Blockly.alert(n,function(){t(a)})}else e.createVariable(a,r),l&&l(a)}else l&&l(null)})};t("")},Blockly.Variables.createVariable=Blockly.Variables.createVariableButtonHandler,Blockly.Variables.renameVariable=function(e,l,a){var r=function(t){var o=Blockly.Msg.RENAME_VARIABLE_TITLE.replace("%1",l.name);Blockly.Variables.promptName(o,t,function(t){if(t){var o=Blockly.Variables.nameUsedWithOtherType_(t,l.type,e);if(o){var i=Blockly.Msg.VARIABLE_ALREADY_EXISTS_FOR_ANOTHER_TYPE.replace("%1",o.name).replace("%2",o.type);Blockly.alert(i,function(){r(t)})}else e.renameVariableById(l.getId(),t),a&&a(t)}else a&&a(null)})};r(l.name||"")},Blockly.Variables.promptName=function(e,l,a){Blockly.prompt(e,l,function(e){e&&((e=e.replace(/[\s\xa0]+/g," ").trim())!=Blockly.Msg.RENAME_VARIABLE&&e!=Blockly.Msg.NEW_VARIABLE||(e=null)),a(e)})},Blockly.Variables.nameUsedWithOtherType_=function(e,l,a){var r=a.getVariableMap().getAllVariables();e=e.toLowerCase();for(var t,o=0;t=r[o];o++)if(t.name.toLowerCase()==e&&t.type!=l)return t;return null},Blockly.Variables.nameUsedWithAnyType=function(e,l){var a=l.getVariableMap().getAllVariables();e=e.toLowerCase();for(var r,t=0;r=a[t];t++)if(r.name.toLowerCase()==e)return r;return null},Blockly.Variables.generateVariableFieldXmlString=function(e){var l=e.type;return'<field name="VAR" id="'+e.getId()+'" variabletype="'+goog.string.htmlEscape(l)+'">'+goog.string.htmlEscape(e.name)+"</field>"},Blockly.Variables.generateVariableFieldDom=function(e){var l=Blockly.utils.xml.createElement("field");l.setAttribute("name","VAR"),l.setAttribute("id",e.getId()),l.setAttribute("variabletype",e.type);var a=Blockly.utils.xml.createTextNode(e.name);return l.appendChild(a),l},Blockly.Variables.getOrCreateVariablePackage=function(e,l,a,r){var t=Blockly.Variables.getVariable(e,l,a,r);return t||(t=Blockly.Variables.createVariable_(e,l,a,r)),t},Blockly.Variables.getVariable=function(e,l,a,r){var t=e.getPotentialVariableMap(),o=null;if(l&&(!(o=e.getVariableById(l))&&t&&(o=t.getVariableById(l)),o))return o;if(a){if(null==r)throw Error("Tried to look up a variable by name without a type");!(o=e.getVariable(a,r))&&t&&(o=t.getVariable(a,r))}return o},Blockly.Variables.createVariable_=function(e,l,a,r){var t=e.getPotentialVariableMap();if(!a){var o=e.isFlyout?e.targetWorkspace:e;a=Blockly.Variables.generateUniqueName(o)}return t?t.createVariable(a,r,l):e.createVariable(a,r,l)},Blockly.Variables.getAddedVariables=function(e,l){var a=e.getAllVariables(),r=[];if(l.length!=a.length)for(var t=0;t<a.length;t++){var o=a[t];-1==l.indexOf(o)&&r.push(o)}return r};