/**
 * @license
 * Visual Blocks Editor
 *
 * Copyright 2017 Google Inc.
 * https://developers.google.com/blockly/
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
"use strict";goog.provide("Blockly.FieldVariableGetter"),goog.require("Blockly.Field"),goog.require("Blockly.utils.object"),Blockly.FieldVariableGetter=function(e,t,l,r,i){this.defaultVariableName=e||"",this.size_=new Blockly.utils.Size(0,0),i&&this.configure_(i),t&&this.setValidator(t),i||this.setTypes_(l,r)},Blockly.utils.object.inherits(Blockly.FieldVariableGetter,Blockly.Field),Blockly.FieldVariableGetter.fromJson=function(e){var t=Blockly.utils.replaceMessageReferences(e.variable),l=e.variableTypes,r=e.defaultType;return new Blockly.FieldVariableGetter(t,null,l,r)},Blockly.FieldVariableGetter.prototype.workspace_=null,Blockly.FieldVariableGetter.prototype.CURSOR="copy",Blockly.FieldVariableGetter.prototype.EDITABLE=!1,Blockly.FieldVariableGetter.prototype.SERIALIZABLE=!0,Blockly.FieldVariableGetter.prototype.initView=function(){this.createTextElement_(),this.sourceBlock_.isEditable()&&(this.mouseOverWrapper_=Blockly.bindEvent_(this.getClickTarget_(),"mouseover",this,this.onMouseOver_),this.mouseOutWrapper_=Blockly.bindEvent_(this.getClickTarget_(),"mouseout",this,this.onMouseOut_))},Blockly.FieldVariableGetter.prototype.initModel=function(){if(!this.variable_){var e=Blockly.Variables.getOrCreateVariablePackage(this.sourceBlock_.workspace,null,this.defaultVariableName,this.defaultType_);this.doValueUpdate_(e.getId())}},Blockly.FieldVariableGetter.prototype.onMouseOver_=function(e){if(!this.sourceBlock_.isInFlyout){var t=this.sourceBlock_.workspace.getGesture(e);if(!t||!t.isDragging()){var l=this.sourceBlock_.pathObject.svgPath;l&&(Blockly.utils.dom.addClass(l,"blocklyFieldHover"),l.style.strokeDasharray="2")}}},Blockly.FieldVariableGetter.prototype.clearHover=function(){var e=this.sourceBlock_.pathObject.svgPath;e&&(Blockly.utils.dom.removeClass(e,"blocklyFieldHover"),e.style.strokeDasharray="")},Blockly.FieldVariableGetter.prototype.onMouseOut_=function(e){if(!this.sourceBlock_.isInFlyout){var t=this.sourceBlock_.workspace.getGesture(e);t&&t.isDragging()||this.clearHover()}},Blockly.FieldVariableGetter.dispose=function(){this.mouseOverWrapper_&&(Blockly.unbindEvent_(this.mouseOverWrapper_),this.mouseOverWrapper_=null),this.mouseOutWrapper_&&(Blockly.unbindEvent_(this.mouseOutWrapper_),this.mouseOutWrapper_=null),Blockly.FieldVariableGetter.superClass_.dispose.call(this),this.workspace_=null,this.variableMap_=null},Blockly.FieldVariableGetter.prototype.fromXml=function(e){e.getAttribute("id");var t=e.textContent,l=e.getAttribute("variabletype")||e.getAttribute("variableType")||"",r=Blockly.Variables.getOrCreateVariablePackage(this.sourceBlock_.workspace,null,t,l);if(null!=l&&l!==r.type)throw Error("Serialized variable type with id '"+r.getId()+"' had type "+r.type+", and does not match variable field that references it: "+Blockly.Xml.domToText(e)+".");this.setValue(r.getId())},Blockly.FieldVariableGetter.prototype.toXml=function(e){return this.initModel(),e.id=this.variable_.getId(),e.textContent=this.variable_.name,this.variable_.type&&e.setAttribute("variabletype",this.variable_.type),e},Blockly.FieldVariableGetter.prototype.setSourceBlock=function(e){goog.asserts.assert(!e.isShadow(),"Variable fields are not allowed to exist on shadow blocks."),Blockly.FieldVariableGetter.superClass_.setSourceBlock.call(this,e)},Blockly.FieldVariableGetter.prototype.getValue=function(){return this.variable_?this.variable_.getId():null},Blockly.FieldVariableGetter.prototype.getText=function(){return this.variable_?this.variable_.name:""},Blockly.FieldVariableGetter.prototype.getVariable=function(){return this.variable_},Blockly.FieldVariableGetter.prototype.doValueUpdate_=function(e){this.variable_=Blockly.Variables.getVariable(this.sourceBlock_.workspace,e),Blockly.FieldVariableGetter.superClass_.doValueUpdate_.call(this,e)},Blockly.FieldVariableGetter.prototype.doClassValidation_=function(e){if(null===e)return null;var t=e,l=Blockly.Variables.getVariable(this.sourceBlock_.workspace,t);if(!l)return console.warn("Variable id doesn't point to a real variable! ID was "+t),null;var r=l.type;return this.typeIsAllowed_(r)?t:(console.warn("Variable type doesn't match this field!  Type was "+r),null)},Blockly.FieldVariableGetter.prototype.typeIsAllowed_=function(e){var t=this.getVariableTypes_();if(!t)return!0;for(var l=0;l<t.length;l++)if(e==t[l])return!0;return!1},Blockly.FieldVariableGetter.prototype.getVariableTypes_=function(){var e=this.variableTypes;if(null===e&&this.sourceBlock_)return this.sourceBlock_.workspace.getVariableTypes();if(0==(e=e||[""]).length){var t=this.getText();throw new Error("'variableTypes' of field variable "+t+" was an empty list")}return e},Blockly.FieldVariableGetter.prototype.setTypes_=function(e,t){var l=t||"";if(null==e||null==e)var r=null;else{if(!Array.isArray(e))throw new Error("'variableTypes' was not an array in the definition of a FieldVariable");r=e;for(var i=!1,a=0;a<r.length;a++)r[a]==l&&(i=!0);if(!i)throw new Error("Invalid default type '"+l+"' in the definition of a FieldVariable")}this.defaultType_=l,this.variableTypes=r},Blockly.FieldVariableGetter.prototype.showEditor_=function(){},Blockly.FieldVariableGetter.prototype.updateEditable=function(){!this.sourceBlock_.isInFlyout&&this.sourceBlock_.isEditable()&&(this.sourceBlock_.pathObject.svgPath.style.cursor=this.CURSOR)},Blockly.FieldVariableGetter.prototype.referencesVariables=function(){return!0},Blockly.fieldRegistry.register("field_variable_getter",Blockly.FieldVariableGetter);