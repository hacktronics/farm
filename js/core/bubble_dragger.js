/**
 * @license
 * Copyright 2018 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.BubbleDragger"),goog.require("Blockly.Bubble"),goog.require("Blockly.ComponentManager"),goog.require("Blockly.constants"),goog.require("Blockly.Events"),goog.require("Blockly.Events.CommentMove"),goog.require("Blockly.utils"),goog.require("Blockly.utils.Coordinate"),goog.requireType("Blockly.BlockDragSurfaceSvg"),goog.requireType("Blockly.IBubble"),goog.requireType("Blockly.WorkspaceSvg"),Blockly.BubbleDragger=function(e,t){this.draggingBubble_=e,this.workspace_=t,this.dragTarget_=null,this.wouldDeleteBubble_=!1,this.startXY_=this.draggingBubble_.getRelativeToSurfaceXY(),this.dragSurface_=Blockly.utils.is3dSupported()&&t.getBlockDragSurface()?t.getBlockDragSurface():null},Blockly.BubbleDragger.prototype.dispose=function(){this.draggingBubble_=null,this.workspace_=null,this.dragSurface_=null},Blockly.BubbleDragger.prototype.startBubbleDrag=function(){Blockly.Events.getGroup()||Blockly.Events.setGroup(!0),this.workspace_.setResizesEnabled(!1),this.draggingBubble_.setAutoLayout(!1),this.dragSurface_&&this.moveToDragSurface_(),this.draggingBubble_.setDragging&&this.draggingBubble_.setDragging(!0)},Blockly.BubbleDragger.prototype.dragBubble=function(e,t){var r=this.pixelsToWorkspaceUnits_(t),g=Blockly.utils.Coordinate.sum(this.startXY_,r);this.draggingBubble_.moveDuringDrag(this.dragSurface_,g);var o=this.dragTarget_;this.dragTarget_=this.workspace_.getDragTarget(e);var a=this.wouldDeleteBubble_;this.wouldDeleteBubble_=this.shouldDelete_(this.dragTarget_),a!=this.wouldDeleteBubble_&&this.updateCursorDuringBubbleDrag_(),this.dragTarget_!==o&&(o&&o.onDragExit(this.draggingBubble_),this.dragTarget_&&this.dragTarget_.onDragEnter(this.draggingBubble_)),this.dragTarget_&&this.dragTarget_.onDragOver(this.draggingBubble_)},Blockly.BubbleDragger.prototype.shouldDelete_=function(e){if(e&&this.workspace_.getComponentManager().hasCapability(e.id,Blockly.ComponentManager.Capability.DELETE_AREA))return e.wouldDelete(this.draggingBubble_,!1);return!1},Blockly.BubbleDragger.prototype.updateCursorDuringBubbleDrag_=function(){this.draggingBubble_.setDeleteStyle(this.wouldDeleteBubble_)},Blockly.BubbleDragger.prototype.endBubbleDrag=function(e,t){if(this.dragBubble(e,t),this.dragTarget_&&this.dragTarget_.shouldPreventMove(this.draggingBubble_))var r=this.startXY_;else{var g=this.pixelsToWorkspaceUnits_(t);r=Blockly.utils.Coordinate.sum(this.startXY_,g)}this.draggingBubble_.moveTo(r.x,r.y),this.dragTarget_&&this.dragTarget_.onDrop(this.draggingBubble_),this.wouldDeleteBubble_?(this.fireMoveEvent_(),this.draggingBubble_.dispose(!1,!0)):(this.dragSurface_&&this.dragSurface_.clearAndHide(this.workspace_.getBubbleCanvas()),this.draggingBubble_.setDragging&&this.draggingBubble_.setDragging(!1),this.fireMoveEvent_()),this.workspace_.setResizesEnabled(!0),Blockly.Events.setGroup(!1)},Blockly.BubbleDragger.prototype.fireMoveEvent_=function(){if(this.draggingBubble_.isComment){var e=new(Blockly.Events.get(Blockly.Events.COMMENT_MOVE))(this.draggingBubble_);e.setOldCoordinate(this.startXY_),e.recordNew(),Blockly.Events.fire(e)}},Blockly.BubbleDragger.prototype.pixelsToWorkspaceUnits_=function(e){var t=new Blockly.utils.Coordinate(e.x/this.workspace_.scale,e.y/this.workspace_.scale);if(this.workspace_.isMutator){var r=this.workspace_.options.parentWorkspace.scale;t.scale(1/r)}return t},Blockly.BubbleDragger.prototype.moveToDragSurface_=function(){this.draggingBubble_.moveTo(0,0),this.dragSurface_.translateSurface(this.startXY_.x,this.startXY_.y),this.dragSurface_.setBlocksAndShow(this.draggingBubble_.getSvgRoot())};