/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.BlockDragger"),goog.require("Blockly.blockAnimations"),goog.require("Blockly.constants"),goog.require("Blockly.Events"),goog.require("Blockly.Events.BlockDrag"),goog.require("Blockly.Events.BlockMove"),goog.require("Blockly.Events.EndBlockDrag"),goog.require("Blockly.IBlockDragger"),goog.require("Blockly.InsertionMarkerManager"),goog.require("Blockly.registry"),goog.require("Blockly.utils.Coordinate"),goog.require("Blockly.utils.dom"),goog.requireType("Blockly.BlockSvg"),goog.requireType("Blockly.IDragTarget"),goog.requireType("Blockly.WorkspaceSvg"),Blockly.BlockDragger=function(o,t,e){this.draggingBlock_=o,this.workspace_=t,this.draggedConnectionManager_=new Blockly.InsertionMarkerManager(this.draggingBlock_),this.dragTarget_=null,this.wouldDeleteBlock_=!1,this.startXY_=this.draggingBlock_.getRelativeToSurfaceXY(),this.dragIconData_=Blockly.BlockDragger.initIconData_(o)},Blockly.BlockDragger.prototype.dispose=function(){this.dragIconData_.length=0,this.draggedConnectionManager_&&this.draggedConnectionManager_.dispose()},Blockly.BlockDragger.initIconData_=function(o){for(var t,e=[],r=o.getDescendants(!1),g=0;t=r[g];g++)for(var i=t.getIcons(),n=0;n<i.length;n++){var l={location:i[n].getIconLocation(),icon:i[n]};l.location&&e.push(l)}return e},Blockly.BlockDragger.prototype.startDrag=function(o,t){Blockly.Events.getGroup()||Blockly.Events.setGroup(!0),this.fireDragStartEvent_(),this.workspace_.isMutator&&this.draggingBlock_.bringToFront(),t&&(this.dragIconData_=this.dragIconData_.filter(o=>o.icon.block_.id==this.draggingBlock_.id)),Blockly.utils.dom.startTextWidthCache(),this.workspace_.setResizesEnabled(!1),Blockly.blockAnimations.disconnectUiStop(),this.shouldDisconnect_(t)&&this.disconnectBlock_(t,o),this.draggingBlock_.setDragging(!0),this.draggingBlock_.moveToDragSurface()},Blockly.BlockDragger.prototype.shouldDisconnect_=function(o){return!!(this.draggingBlock_.getParent()||o&&this.draggingBlock_.nextConnection&&this.draggingBlock_.nextConnection.targetBlock())},Blockly.BlockDragger.prototype.disconnectBlock_=function(o,t){this.draggingBlock_.unplug(o);var e=this.pixelsToWorkspaceUnits_(t),r=Blockly.utils.Coordinate.sum(this.startXY_,e);this.draggingBlock_.translate(r.x,r.y),Blockly.blockAnimations.disconnectUiEffect(this.draggingBlock_),this.draggedConnectionManager_.updateAvailableConnections()},Blockly.BlockDragger.prototype.fireDragStartEvent_=function(){var o=new(Blockly.Events.get(Blockly.Events.BLOCK_DRAG))(this.draggingBlock_,!0,this.draggingBlock_.getDescendants(!1));Blockly.Events.fire(o)},Blockly.BlockDragger.prototype.drag=function(o,t){var e=this.pixelsToWorkspaceUnits_(t),r=Blockly.utils.Coordinate.sum(this.startXY_,e);this.draggingBlock_.moveDuringDrag(r),this.dragIcons_(e);var g=this.dragTarget_;this.dragTarget_=this.workspace_.getDragTarget(o),this.draggedConnectionManager_.update(e,this.dragTarget_);var i=this.wouldDeleteBlock_;this.wouldDeleteBlock_=this.draggedConnectionManager_.wouldDeleteBlock(),i!=this.wouldDeleteBlock_&&this.updateCursorDuringBlockDrag_(),this.dragTarget_!==g&&(g&&g.onDragExit(this.draggingBlock_),this.dragTarget_&&this.dragTarget_.onDragEnter(this.draggingBlock_)),this.dragTarget_&&this.dragTarget_.onDragOver(this.draggingBlock_)},Blockly.BlockDragger.prototype.endDrag=function(o,t){if(this.drag(o,t),this.dragIconData_=[],this.fireDragEndEvent_(),Blockly.utils.dom.stopTextWidthCache(),Blockly.blockAnimations.disconnectUiStop(),!!this.dragTarget_&&this.dragTarget_.shouldPreventMove(this.draggingBlock_))var e=this.startXY_;else{var r=this.getNewLocationAfterDrag_(t),g=r.delta;e=r.newLocation}this.draggingBlock_.moveOffDragSurface(e),this.dragTarget_&&this.dragTarget_.onDrop(this.draggingBlock_),this.maybeDeleteBlock_()||(this.draggingBlock_.setDragging(!1),g?this.updateBlockAfterMove_(g):Blockly.bumpObjectIntoBounds_(this.draggingBlock_.workspace,this.workspace_.getMetricsManager().getScrollMetrics(!0),this.draggingBlock_)),this.workspace_.setResizesEnabled(!0),Blockly.Events.setGroup(!1)},Blockly.BlockDragger.prototype.getNewLocationAfterDrag_=function(o){var t={};return t.delta=this.pixelsToWorkspaceUnits_(o),t.newLocation=Blockly.utils.Coordinate.sum(this.startXY_,t.delta),t},Blockly.BlockDragger.prototype.maybeDeleteBlock_=function(){return!!this.wouldDeleteBlock_&&(this.fireMoveEvent_(),this.draggingBlock_.dispose(!1,!0),Blockly.draggingConnections=[],!0)},Blockly.BlockDragger.prototype.updateBlockAfterMove_=function(o){this.draggingBlock_.moveConnections(o.x,o.y),this.fireMoveEvent_(),this.draggedConnectionManager_.wouldConnectBlock()?this.draggedConnectionManager_.applyConnections():this.draggingBlock_.render(),this.draggingBlock_.scheduleSnapAndBump()},Blockly.BlockDragger.prototype.fireDragEndEvent_=function(){var o=new Blockly.Events.EndBlockDrag(this.draggingBlock_);Blockly.Events.fire(o)},Blockly.BlockDragger.prototype.updateToolboxStyle_=function(o){var t=this.workspace_.getToolbox();if(t){var e=this.draggingBlock_.isDeletable()?"blocklyToolboxDelete":"blocklyToolboxGrab";o&&"function"==typeof t.removeStyle?t.removeStyle(e):o||"function"!=typeof t.addStyle||t.addStyle(e)}},Blockly.BlockDragger.prototype.fireMoveEvent_=function(){var o=new(Blockly.Events.get(Blockly.Events.BLOCK_MOVE))(this.draggingBlock_);o.oldCoordinate=this.startXY_,o.recordNew(),Blockly.Events.fire(o)},Blockly.BlockDragger.prototype.updateCursorDuringBlockDrag_=function(){this.draggingBlock_.setDeleteStyle(this.wouldDeleteBlock_)},Blockly.BlockDragger.prototype.pixelsToWorkspaceUnits_=function(o){var t=new Blockly.utils.Coordinate(o.x/this.workspace_.scale,o.y/this.workspace_.scale);if(this.workspace_.isMutator){var e=this.workspace_.options.parentWorkspace.scale;t.scale(1/e)}return t},Blockly.BlockDragger.prototype.workspaceOriginInPixels_=function(){var o=goog.style.getPageOffset(this.workspace_.getInjectionDiv()),t=this.workspace_.getOriginOffsetInPixels();return Blockly.utils.Coordinate.sum(o,t)},Blockly.BlockDragger.prototype.dragIcons_=function(o){for(var t=0;t<this.dragIconData_.length;t++){var e=this.dragIconData_[t];e.icon.setIconLocation(Blockly.utils.Coordinate.sum(e.location,o))}},Blockly.BlockDragger.prototype.getInsertionMarkers=function(){return this.draggedConnectionManager_&&this.draggedConnectionManager_.getInsertionMarkers?this.draggedConnectionManager_.getInsertionMarkers():[]},Blockly.registry.register(Blockly.registry.Type.BLOCK_DRAGGER,Blockly.registry.DEFAULT,Blockly.BlockDragger);