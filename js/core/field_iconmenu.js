/**
 * @license
 * Visual Blocks Editor
 *
 * Copyright 2016 Massachusetts Institute of Technology
 * All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
"use strict";goog.provide("Blockly.FieldIconMenu"),goog.require("Blockly.DropDownDiv"),goog.require("Blockly.utils.object"),Blockly.FieldIconMenu=function(o){this.icons_=o;var t=o[0].value;Blockly.FieldIconMenu.superClass_.constructor.call(this,t),this.addArgType("iconmenu")},Blockly.utils.object.inherits(Blockly.FieldIconMenu,Blockly.Field),Blockly.FieldIconMenu.fromJson=function(o){return new Blockly.FieldIconMenu(o.options)},Blockly.FieldIconMenu.DROPDOWN_WIDTH=168,Blockly.FieldIconMenu.savedPrimary_=null,Blockly.FieldIconMenu.prototype.init=function(o){this.arrowX_=18,this.arrowY_=10,o.RTL&&(this.arrowX_=-this.arrowX_-12),this.arrowIcon_=Blockly.utils.dom.createSvgElement("image",{height:"12px",width:"12px",transform:"translate("+this.arrowX_+","+this.arrowY_+")"}),this.arrowIcon_.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",Blockly.mainWorkspace.options.pathToMedia+"dropdown-arrow.svg"),o.getSvgRoot().appendChild(this.arrowIcon_),Blockly.FieldIconMenu.superClass_.init.call(this,o)},Blockly.FieldIconMenu.prototype.CURSOR="default",Blockly.FieldIconMenu.prototype.setValue=function(o){null!==o&&o!==this.value_&&(this.sourceBlock_&&Blockly.Events.isEnabled()&&Blockly.Events.fire(new Blockly.Events.Change(this.sourceBlock_,"field",this.name,this.value_,o)),this.value_=o,this.setParentFieldImage(this.getSrcForValue(this.value_)))},Blockly.FieldIconMenu.prototype.setParentFieldImage=function(o){if(this.sourceBlock_&&this.sourceBlock_.parentBlock_)for(var t,e=this.sourceBlock_.parentBlock_,l=0;t=e.inputList[l];l++)for(var r,i=0;r=t.fieldRow[i];i++)if(r instanceof Blockly.FieldImage)return void r.setValue(o)},Blockly.FieldIconMenu.prototype.getValue=function(){return this.value_},Blockly.FieldIconMenu.prototype.getSrcForValue=function(o){for(var t,e=0;t=this.icons_[e];e++)if(t.value===o)return t.src},Blockly.FieldIconMenu.prototype.showEditor_=function(){if(!Blockly.DropDownDiv.hideIfOwner(this)){Blockly.DropDownDiv.hideWithoutAnimation(),Blockly.DropDownDiv.clearContent();var o=Blockly.DropDownDiv.getContentDiv();o.setAttribute("role","menu"),o.setAttribute("aria-haspopup","true");for(var t,e=0;t=this.icons_[e];e++)if("placeholder"!=t.type){var l=document.createElement("button");l.setAttribute("id",":"+e),l.setAttribute("role","menuitem"),l.setAttribute("class","blocklyDropDownButton"),l.title=t.alt,l.style.width=t.width+"px",l.style.height=t.height+"px";var r=this.sourceBlock_.getColour();t.value==this.getValue()&&(r=this.sourceBlock_.getColourTertiary(),l.setAttribute("aria-selected","true")),l.style.backgroundColor=r,l.style.borderColor=this.sourceBlock_.getColourTertiary(),Blockly.bindEvent_(l,"click",this,this.buttonClick_),Blockly.bindEvent_(l,"mouseup",this,this.buttonClick_),Blockly.bindEvent_(l,"mousedown",l,function(o){this.setAttribute("class","blocklyDropDownButton blocklyDropDownButtonHover"),o.preventDefault()}),Blockly.bindEvent_(l,"mouseover",l,function(){this.setAttribute("class","blocklyDropDownButton blocklyDropDownButtonHover"),o.setAttribute("aria-activedescendant",this.id)}),Blockly.bindEvent_(l,"mouseout",l,function(){this.setAttribute("class","blocklyDropDownButton"),o.removeAttribute("aria-activedescendant")});var i=document.createElement("img");i.src=t.src,l.setAttribute("data-value",t.value),i.setAttribute("data-value",t.value),l.appendChild(i),o.appendChild(l)}else{var c=document.createElement("span");c.setAttribute("class","blocklyDropDownPlaceholder"),c.style.width=t.width+"px",c.style.height=t.height+"px",o.appendChild(c)}o.style.width=Blockly.FieldIconMenu.DROPDOWN_WIDTH+"px",Blockly.DropDownDiv.setColour(this.sourceBlock_.getColour(),this.sourceBlock_.getColourTertiary()),Blockly.DropDownDiv.setCategory(this.sourceBlock_.parentBlock_.getCategory()),this.savedPrimary_=this.sourceBlock_.getColour(),this.sourceBlock_.setColour(this.sourceBlock_.getColourSecondary(),this.sourceBlock_.getColourSecondary(),this.sourceBlock_.getColourTertiary());var n=this.sourceBlock_.workspace.scale,s=-Blockly.BlockSvg.MIN_BLOCK_Y*n-Blockly.BlockSvg.FIELD_Y_OFFSET*n;if(!Blockly.DropDownDiv.showPositionedByBlock(this,this.sourceBlock_,this.onHide_.bind(this),s)){var u=this.arrowX_+Blockly.DropDownDiv.ARROW_SIZE/1.5+1,a=this.arrowY_+Blockly.DropDownDiv.ARROW_SIZE/1.5;this.arrowIcon_.setAttribute("transform","translate("+u+","+a+") rotate(180)")}}},Blockly.FieldIconMenu.prototype.buttonClick_=function(o){var t=o.target.getAttribute("data-value");this.setValue(t),Blockly.DropDownDiv.hide()},Blockly.FieldIconMenu.prototype.onHide_=function(){this.sourceBlock_&&this.sourceBlock_.setColour(this.savedPrimary_,this.sourceBlock_.getColourSecondary(),this.sourceBlock_.getColourTertiary()),Blockly.DropDownDiv.content_.removeAttribute("role"),Blockly.DropDownDiv.content_.removeAttribute("aria-haspopup"),Blockly.DropDownDiv.content_.removeAttribute("aria-activedescendant"),this.arrowIcon_.setAttribute("transform","translate("+this.arrowX_+","+this.arrowY_+")")},Blockly.fieldRegistry.register("field_iconmenu",Blockly.FieldIconMenu);