/**
 * @license
 * Copyright 2012 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.Procedures"),goog.require("Blockly.Blocks"),goog.require("Blockly.constants"),goog.require("Blockly.Events"),goog.require("Blockly.Events.BlockChange"),goog.require("Blockly.Field"),goog.require("Blockly.Msg"),goog.require("Blockly.Names"),goog.require("Blockly.utils.xml"),goog.require("Blockly.Workspace"),goog.require("Blockly.Xml"),goog.requireType("Blockly.Block"),goog.requireType("Blockly.Events.Abstract"),goog.requireType("Blockly.WorkspaceSvg"),Blockly.Procedures.NAME_TYPE=Blockly.PROCEDURE_CATEGORY_NAME,Blockly.Procedures.DEFAULT_ARG="x",Blockly.Procedures.ProcedureBlock,Blockly.Procedures.allProcedures=function(e){var r=e.getBlocksByType("procedures_defnoreturn",!1).map(function(e){return e.getProcedureDef()}),l=e.getBlocksByType("procedures_defreturn",!1).map(function(e){return e.getProcedureDef()});return r.sort(Blockly.Procedures.procTupleComparator_),l.sort(Blockly.Procedures.procTupleComparator_),[r,l]},Blockly.Procedures.procTupleComparator_=function(e,r){return e[0].localeCompare(r[0],void 0,{sensitivity:"base"})},Blockly.Procedures.findLegalName=function(e,r){if(r.isInFlyout)return e;for(e=e||Blockly.Msg.UNNAMED_KEY||"unnamed";!Blockly.Procedures.isLegalName_(e,r.workspace,r);){var l=e.match(/^(.*?)(\d+)$/);l?e=l[1]+(parseInt(l[2],10)+1):e+="2"}return e},Blockly.Procedures.isLegalName_=function(e,r,l){return!Blockly.Procedures.isNameUsed(e,r,l)},Blockly.Procedures.isNameUsed=function(e,r,l){for(var o=r.getAllBlocks(!1),t=0;t<o.length;t++)if(o[t]!=l){var c="";if(o[t].getProcedureDef)c=o[t].getProcedureDef()[0];else o[t].getName&&(c=o[t].getName());if(Blockly.Names.equals(c,e))return!0}return!1},Blockly.Procedures.rename=function(e){e=e.trim();var r=Blockly.Procedures.findLegalName(e,this.getSourceBlock()),l=this.getValue();if(!r)return l;if(l!=e&&l!=r)for(var o=this.getSourceBlock().workspace.getAllBlocks(!1),t=0;t<o.length;t++){if(o[t].renameProcedure)o[t].renameProcedure(l,r)}return r},Blockly.Procedures.flyoutCategory=function(e){var r,l,o=[];Blockly.Blocks.procedures_defnoreturn&&((l=Blockly.utils.xml.createElement("block")).setAttribute("type","procedures_defnoreturn"),l.setAttribute("gap",16),(r=Blockly.utils.xml.createElement("field")).setAttribute("name","NAME"),r.appendChild(Blockly.utils.xml.createTextNode(Blockly.Msg.PROCEDURES_DEFNORETURN_PROCEDURE)),l.appendChild(r),o.push(l));Blockly.Blocks.procedures_defreturn&&((l=Blockly.utils.xml.createElement("block")).setAttribute("type","procedures_defreturn"),l.setAttribute("gap",16),(r=Blockly.utils.xml.createElement("field")).setAttribute("name","NAME"),r.appendChild(Blockly.utils.xml.createTextNode(Blockly.Msg.PROCEDURES_DEFRETURN_PROCEDURE)),l.appendChild(r),o.push(l));Blockly.Blocks.procedures_ifreturn&&((l=Blockly.utils.xml.createElement("block")).setAttribute("type","procedures_ifreturn"),l.setAttribute("gap",16),o.push(l));function t(e,r){for(var l=0;l<e.length;l++){var t=e[l][0],c=e[l][1],u=Blockly.utils.xml.createElement("block");u.setAttribute("type",r),u.setAttribute("gap",16);var s=Blockly.utils.xml.createElement("mutation");s.setAttribute("name",t),u.appendChild(s);for(var a=0;a<c.length;a++){var n=Blockly.utils.xml.createElement("arg");n.setAttribute("name",c[a]),s.appendChild(n)}o.push(u)}}o.length&&o[o.length-1].setAttribute("gap",24);var c=Blockly.Procedures.allProcedures(e);return t(c[0],"procedures_callnoreturn"),t(c[1],"procedures_callreturn"),o},Blockly.Procedures.updateMutatorFlyout_=function(e){for(var r,l=[],o=e.getBlocksByType("procedures_mutatorarg",!1),t=0;r=o[t];t++)l.push(r.getFieldValue("NAME"));var c=Blockly.utils.xml.createElement("xml"),u=Blockly.utils.xml.createElement("block");u.setAttribute("type","procedures_mutatorarg");var s=Blockly.utils.xml.createElement("field");s.setAttribute("name","NAME");var a=Blockly.Variables.generateUniqueNameFromOptions(Blockly.Procedures.DEFAULT_ARG,l),n=Blockly.utils.xml.createTextNode(a);s.appendChild(n),u.appendChild(s),c.appendChild(u),e.updateToolbox(c)},Blockly.Procedures.mutatorOpenListener=function(e){if(e.type==Blockly.Events.BUBBLE_OPEN&&"mutator"===e.bubbleType&&e.isOpen){var r=e.workspaceId,l=Blockly.Workspace.getById(r).getBlockById(e.blockId),o=l.type;if("procedures_defnoreturn"==o||"procedures_defreturn"==o){var t=l.mutator.getWorkspace();Blockly.Procedures.updateMutatorFlyout_(t),t.addChangeListener(Blockly.Procedures.mutatorChangeListener_)}}},Blockly.Procedures.mutatorChangeListener_=function(e){if(e.type==Blockly.Events.BLOCK_CREATE||e.type==Blockly.Events.BLOCK_DELETE||e.type==Blockly.Events.BLOCK_CHANGE){var r=e.workspaceId,l=Blockly.Workspace.getById(r);Blockly.Procedures.updateMutatorFlyout_(l)}},Blockly.Procedures.getCallers=function(e,r){for(var l=[],o=r.getAllBlocks(!1),t=0;t<o.length;t++)if(o[t].getProcedureCall){var c=o[t].getProcedureCall();c&&Blockly.Names.equals(c,e)&&l.push(o[t])}return l},Blockly.Procedures.mutateCallers=function(e){for(var r,l=Blockly.Events.recordUndo,o=e.getProcedureDef()[0],t=e.mutationToDom(!0),c=Blockly.Procedures.getCallers(o,e.workspace),u=0;r=c[u];u++){var s=r.mutationToDom(),a=s&&Blockly.Xml.domToText(s);r.domToMutation(t);var n=r.mutationToDom(),i=n&&Blockly.Xml.domToText(n);a!=i&&(Blockly.Events.recordUndo=!1,Blockly.Events.fire(new(Blockly.Events.get(Blockly.Events.BLOCK_CHANGE))(r,"mutation",null,a,i)),Blockly.Events.recordUndo=l)}},Blockly.Procedures.getDefinition=function(e,r){for(var l=r.getAllBlocks(!1),o=0;o<l.length;o++)if(l[o].getProcedureDef){var t=l[o].getProcedureDef();if(t&&Blockly.Names.equals(t[0],e))return l[o]}return null};