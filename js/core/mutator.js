/**
 * @license
 * Copyright 2012 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.Mutator"),goog.require("Blockly.Bubble"),goog.require("Blockly.Events"),goog.require("Blockly.Events.BlockChange"),goog.require("Blockly.Events.BubbleOpen"),goog.require("Blockly.Icon"),goog.require("Blockly.Options"),goog.require("Blockly.utils"),goog.require("Blockly.utils.dom"),goog.require("Blockly.utils.object"),goog.require("Blockly.utils.Svg"),goog.require("Blockly.utils.toolbox"),goog.require("Blockly.utils.xml"),goog.require("Blockly.WorkspaceSvg"),goog.require("Blockly.Xml"),goog.requireType("Blockly.Block"),goog.requireType("Blockly.BlockSvg"),goog.requireType("Blockly.Connection"),goog.requireType("Blockly.Events.Abstract"),goog.requireType("Blockly.utils.Coordinate"),goog.requireType("Blockly.Workspace"),Blockly.Mutator=function(o){Blockly.Mutator.superClass_.constructor.call(this,null),this.quarkNames_=o},Blockly.utils.object.inherits(Blockly.Mutator,Blockly.Icon),Blockly.Mutator.prototype.workspace_=null,Blockly.Mutator.prototype.workspaceWidth_=0,Blockly.Mutator.prototype.workspaceHeight_=0,Blockly.Mutator.prototype.setBlock=function(o){this.block_=o},Blockly.Mutator.prototype.getWorkspace=function(){return this.workspace_},Blockly.Mutator.prototype.drawIcon_=function(o){Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.RECT,{class:"blocklyIconShape",rx:"10",ry:"10",height:"16",width:"16"},o),Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.PATH,{class:"blocklyIconSymbol",d:"m4.203,7.296 0,1.368 -0.92,0.677 -0.11,0.41 0.9,1.559 0.41,0.11 1.043,-0.457 1.187,0.683 0.127,1.134 0.3,0.3 1.8,0 0.3,-0.299 0.127,-1.138 1.185,-0.682 1.046,0.458 0.409,-0.11 0.9,-1.559 -0.11,-0.41 -0.92,-0.677 0,-1.366 0.92,-0.677 0.11,-0.41 -0.9,-1.559 -0.409,-0.109 -1.046,0.458 -1.185,-0.682 -0.127,-1.138 -0.3,-0.299 -1.8,0 -0.3,0.3 -0.126,1.135 -1.187,0.682 -1.043,-0.457 -0.41,0.11 -0.899,1.559 0.108,0.409z"},o),Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.CIRCLE,{class:"blocklyIconShape",r:"2.7",cx:"8",cy:"8"},o)},Blockly.Mutator.prototype.iconClick_=function(o){this.block_.isEditable()&&Blockly.Icon.prototype.iconClick_.call(this,o)},Blockly.Mutator.prototype.createEditor_=function(){if(this.svgDialog_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.SVG,{x:Blockly.Bubble.BORDER_WIDTH,y:Blockly.Bubble.BORDER_WIDTH},null),this.quarkNames_.length)for(var o,t=Blockly.utils.xml.createElement("xml"),e=0;o=this.quarkNames_[e];e++){var l=Blockly.utils.xml.createElement("block");l.setAttribute("type",o),t.appendChild(l)}else t=null;var s=new Blockly.Options({disable:!1,parentWorkspace:this.block_.workspace,media:this.block_.workspace.options.pathToMedia,rtl:this.block_.RTL,horizontalLayout:!1,renderer:this.block_.workspace.options.renderer,rendererOverrides:this.block_.workspace.options.rendererOverrides});s.toolboxPosition=this.block_.RTL?Blockly.utils.toolbox.Position.RIGHT:Blockly.utils.toolbox.Position.LEFT;var i=!!t;i&&(s.languageTree=Blockly.utils.toolbox.convertToolboxDefToJson(t)),this.workspace_=new Blockly.WorkspaceSvg(s),this.workspace_.isMutator=!0,this.workspace_.addChangeListener(Blockly.Events.disableOrphans);var r=i?this.workspace_.addFlyout(Blockly.utils.Svg.G):null,c=this.workspace_.createDom("blocklyMutatorBackground");return r&&c.insertBefore(r,this.workspace_.svgBlockCanvas_),this.svgDialog_.appendChild(c),this.svgDialog_},Blockly.Mutator.prototype.updateEditable=function(){Blockly.Mutator.superClass_.updateEditable.call(this),this.block_.isInFlyout||(this.block_.isEditable()?this.iconGroup_&&Blockly.utils.dom.removeClass(this.iconGroup_,"blocklyIconGroupReadonly"):(this.setVisible(!1),this.iconGroup_&&Blockly.utils.dom.addClass(this.iconGroup_,"blocklyIconGroupReadonly")))},Blockly.Mutator.prototype.resizeBubble_=function(){var o=2*Blockly.Bubble.BORDER_WIDTH,t=this.workspace_.getCanvas().getBBox(),e=t.width+t.x,l=t.height+3*o,s=this.workspace_.getFlyout();if(s){var i=s.getWorkspace().getMetricsManager().getScrollMetrics();l=Math.max(l,i.height+20),e+=s.getWidth()}if(this.block_.RTL&&(e=-t.x),e+=3*o,(Math.abs(this.workspaceWidth_-e)>o||Math.abs(this.workspaceHeight_-l)>o)&&(this.workspaceWidth_=e,this.workspaceHeight_=l,this.bubble_.setBubbleSize(e+o,l+o),this.svgDialog_.setAttribute("width",this.workspaceWidth_),this.svgDialog_.setAttribute("height",this.workspaceHeight_),this.workspace_.setCachedParentSvgSize(this.workspaceWidth_,this.workspaceHeight_)),this.block_.RTL){var r="translate("+this.workspaceWidth_+",0)";this.workspace_.getCanvas().setAttribute("transform",r)}this.workspace_.resize()},Blockly.Mutator.prototype.onBubbleMove_=function(){this.workspace_&&this.workspace_.recordDragTargets()},Blockly.Mutator.prototype.setVisible=function(o){if(o!=this.isVisible())if(Blockly.Events.fire(new(Blockly.Events.get(Blockly.Events.BUBBLE_OPEN))(this.block_,o,"mutator")),o){this.bubble_=new Blockly.Bubble(this.block_.workspace,this.createEditor_(),this.block_.pathObject.svgPath,this.iconXY_,null,null),this.bubble_.setSvgId(this.block_.id),this.bubble_.registerMoveEvent(this.onBubbleMove_.bind(this));var t=this.workspace_.options.languageTree,e=this.workspace_.getFlyout();t&&(e.init(this.workspace_),e.show(t)),this.rootBlock_=this.block_.decompose(this.workspace_);for(var l,s=this.rootBlock_.getDescendants(!1),i=0;l=s[i];i++)l.render();if(this.rootBlock_.setMovable(!1),this.rootBlock_.setDeletable(!1),e)var r=2*e.CORNER_RADIUS,c=this.rootBlock_.RTL?e.getWidth()+r:r;else c=r=16;if(this.block_.RTL&&(c=-c),this.rootBlock_.moveBy(c,r),this.block_.saveConnections){var a=this,n=this.block_;n.saveConnections(this.rootBlock_),this.sourceListener_=function(){n.saveConnections(a.rootBlock_)},this.block_.workspace.addChangeListener(this.sourceListener_)}this.resizeBubble_(),this.workspace_.addChangeListener(this.workspaceChanged_.bind(this)),this.applyColour()}else this.svgDialog_=null,this.workspace_.dispose(),this.workspace_=null,this.rootBlock_=null,this.bubble_.dispose(),this.bubble_=null,this.workspaceWidth_=0,this.workspaceHeight_=0,this.sourceListener_&&(this.block_.workspace.removeChangeListener(this.sourceListener_),this.sourceListener_=null)},Blockly.Mutator.prototype.workspaceChanged_=function(o){if(!(o.isUiEvent||o.type==Blockly.Events.CHANGE&&"disabled"==o.element)){if(!this.workspace_.isDragging())for(var t=this.workspace_.getTopBlocks(!1),e=0;r=t[e];e++){var l=r.getRelativeToSurfaceXY();if(l.y<20&&r.moveBy(0,20-l.y),r.RTL){var s=-20,i=this.workspace_.getFlyout();i&&(s-=i.getWidth()),l.x>s&&r.moveBy(s-l.x,0)}else l.x<20&&r.moveBy(20-l.x,0)}if(this.rootBlock_.workspace==this.workspace_){Blockly.Events.setGroup(!0);var r,c=(r=this.block_).mutationToDom(),a=c&&Blockly.Xml.domToText(c),n=r.rendered;r.rendered=!1,r.compose(this.rootBlock_),r.rendered=n,r.initSvg(),r.rendered&&r.render();var k=r.mutationToDom(),u=k&&Blockly.Xml.domToText(k);if(a!=u){Blockly.Events.fire(new(Blockly.Events.get(Blockly.Events.BLOCK_CHANGE))(r,"mutation",null,a,u));var h=Blockly.Events.getGroup();setTimeout(function(){Blockly.Events.setGroup(h),r.bumpNeighbours(),Blockly.Events.setGroup(!1)},Blockly.BUMP_DELAY)}this.workspace_.isDragging()||this.resizeBubble_(),Blockly.Events.setGroup(!1)}}},Blockly.Mutator.prototype.dispose=function(){this.block_.mutator=null,Blockly.Icon.prototype.dispose.call(this)},Blockly.Mutator.prototype.updateBlockStyle=function(){var o=this.workspace_;if(o&&o.getAllBlocks(!1)){for(var t=o.getAllBlocks(!1),e=0;s=t[e];e++)s.setStyle(s.getStyleName());var l=o.getFlyout();if(l){var s,i=l.workspace_.getAllBlocks(!1);for(e=0;s=i[e];e++)s.setStyle(s.getStyleName())}}},Blockly.Mutator.reconnect=function(o,t,e){if(!o||!o.getSourceBlock().workspace)return!1;var l=t.getInput(e).connection,s=o.targetBlock();return!(s&&s!=t||l.targetConnection==o)&&(l.isConnected()&&l.disconnect(),l.connect(o),!0)},Blockly.Mutator.findParentWs=function(o){var t=null;if(o&&o.options){var e=o.options.parentWorkspace;o.isFlyout?e&&e.options&&(t=e.options.parentWorkspace):e&&(t=e)}return t};