/**
 * @license
 * Copyright 2012 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.BlockSvg"),goog.require("Blockly.ASTNode"),goog.require("Blockly.Block"),goog.require("Blockly.blockAnimations"),goog.require("Blockly.blockRendering.IPathObject"),goog.require("Blockly.browserEvents"),goog.require("Blockly.connectionTypes"),goog.require("Blockly.constants"),goog.require("Blockly.ContextMenu"),goog.require("Blockly.ContextMenuRegistry"),goog.require("Blockly.Events"),goog.require("Blockly.Events.BlockMove"),goog.require("Blockly.Events.Selected"),goog.require("Blockly.IASTNodeLocationSvg"),goog.require("Blockly.IBoundedElement"),goog.require("Blockly.ICopyable"),goog.require("Blockly.IDraggable"),goog.require("Blockly.Msg"),goog.require("Blockly.pxtBlocklyUtils"),goog.require("Blockly.RenderedConnection"),goog.require("Blockly.TabNavigateCursor"),goog.require("Blockly.Tooltip"),goog.require("Blockly.Touch"),goog.require("Blockly.utils"),goog.require("Blockly.utils.Coordinate"),goog.require("Blockly.utils.deprecation"),goog.require("Blockly.utils.dom"),goog.require("Blockly.utils.object"),goog.require("Blockly.utils.Rect"),goog.require("Blockly.utils.Svg"),goog.require("Blockly.utils.userAgent"),goog.require("Blockly.Xml"),goog.requireType("Blockly.blockRendering.Debug"),goog.requireType("Blockly.Comment"),goog.requireType("Blockly.Connection"),goog.requireType("Blockly.Field"),goog.requireType("Blockly.Input"),goog.requireType("Blockly.Mutator"),goog.requireType("Blockly.Theme"),goog.requireType("Blockly.Warning"),goog.requireType("Blockly.WorkspaceSvg"),Blockly.BlockSvg=function(t,o,e){this.svgGroup_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.G,{},null),this.svgGroup_.translate_="",this.style=t.getRenderer().getConstants().getBlockStyle(null),this.pathObject=t.getRenderer().makePathObject(this.svgGroup_,this.style),this.rendered=!1,this.renderIsInProgress_=!1,this.workspace=t,this.outputConnection=null,this.nextConnection=null,this.previousConnection=null,this.useDragSurface_=Blockly.utils.is3dSupported()&&!!t.getBlockDragSurface();var l=this.pathObject.svgPath;l.tooltip=this,Blockly.Tooltip.bindMouseEvents(l),Blockly.BlockSvg.superClass_.constructor.call(this,t,o,e),this.svgGroup_.dataset?this.svgGroup_.dataset.id=this.id:Blockly.utils.userAgent.IE&&this.svgGroup_.setAttribute("data-id",this.id)},Blockly.utils.object.inherits(Blockly.BlockSvg,Blockly.Block),Blockly.BlockSvg.prototype.height=0,Blockly.BlockSvg.prototype.width=0,Blockly.BlockSvg.prototype.warningTextDb_=null,Blockly.BlockSvg.INLINE=-1,Blockly.BlockSvg.COLLAPSED_WARNING_ID="TEMP_COLLAPSED_WARNING_",Blockly.BlockSvg.prototype.decompose,Blockly.BlockSvg.prototype.compose,Blockly.BlockSvg.prototype.customContextMenu,Blockly.BlockSvg.prototype.renderingDebugger,Blockly.BlockSvg.prototype.initSvg=function(){if(!this.workspace.rendered)throw TypeError("Workspace is headless.");for(var t,o=0;t=this.inputList[o];o++)t.init();var e=this.getIcons();for(o=0;o<e.length;o++)e[o].createIcon();this.applyColour(),this.pathObject.updateMovable(this.isMovable());var l=this.getSvgRoot();this.workspace.options.readOnly||this.eventsInit_||!l||Blockly.browserEvents.conditionalBind(l,"mousedown",this,this.onMouseDown_),this.eventsInit_=!0,l.parentNode||this.workspace.getCanvas().appendChild(l),!this.workspace.options.readOnly&&this.outputConnection&&this.bindReporterHoverEvents_()},Blockly.BlockSvg.prototype.getColourSecondary=function(){return this.style.colourSecondary},Blockly.BlockSvg.prototype.getColourTertiary=function(){return this.style.colourTertiary},Blockly.BlockSvg.prototype.getColourShadow=function(){return Blockly.utils.deprecation.warn("BlockSvg.prototype.getColourShadow","January 2020","January 2021","style.colourSecondary"),this.getColourSecondary()},Blockly.BlockSvg.prototype.getColourBorder=function(){return Blockly.utils.deprecation.warn("BlockSvg.prototype.getColourBorder","January 2020","January 2021","style.colourTertiary"),{colourBorder:this.getColourTertiary(),colourLight:null,colourDark:null}},Blockly.BlockSvg.prototype.select=function(){if(this.isMovable())if(this.isShadow()&&this.getParent())this.getParent().select();else if(Blockly.selected!=this){var t=null;if(Blockly.selected){t=Blockly.selected.id,Blockly.Events.disable();try{Blockly.selected.unselect()}finally{Blockly.Events.enable()}}var o=new(Blockly.Events.get(Blockly.Events.SELECTED))(t,this.id,this.workspace.id);Blockly.Events.fire(o),Blockly.selected=this,this.addSelect()}},Blockly.BlockSvg.prototype.unselect=function(){if(Blockly.selected==this){var t=new(Blockly.Events.get(Blockly.Events.SELECTED))(this.id,null,this.workspace.id);t.workspaceId=this.workspace.id,Blockly.Events.fire(t),Blockly.selected=null,this.removeSelect()}},Blockly.BlockSvg.prototype.setHighlightWarning=function(t){if(this.rendered)if(this.isHighlightingWarningBlock_=t,this.isHighlightingWarningBlock_&&!this.svgPathWarningHighlight_){var o=Blockly.mainWorkspace.options.warningGlowFilterId||"blocklyHighlightWarningFilter";this.svgPathWarningHighlight_=this.svgPath_.cloneNode(!0),this.svgPathWarningHighlight_.setAttribute("fill","none"),this.svgPathWarningHighlight_.setAttribute("filter","url(#"+o+")"),this.getSvgRoot().appendChild(this.svgPathWarningHighlight_)}else!this.isHighlightingWarningBlock_&&this.svgPathWarningHighlight_&&(this.getSvgRoot().removeChild(this.svgPathWarningHighlight_),this.svgPathWarningHighlight_=null)},Blockly.BlockSvg.prototype.mutator=null,Blockly.BlockSvg.prototype.comment=null,Blockly.BlockSvg.prototype.commentIcon_=null,Blockly.BlockSvg.prototype.warning=null,Blockly.BlockSvg.prototype.breakpoint=null,Blockly.BlockSvg.prototype.getIcons=function(){var t=[];return this.breakpoint&&t.push(this.breakpoint),this.mutator&&t.push(this.mutator),this.commentIcon_&&t.push(this.commentIcon_),this.warning&&t.push(this.warning),t},Blockly.BlockSvg.prototype.setParent=function(t){var o=this.parentBlock_;if(t!=o){Blockly.utils.dom.startTextWidthCache(),Blockly.BlockSvg.superClass_.setParent.call(this,t),Blockly.utils.dom.stopTextWidthCache();var e=this.getSvgRoot();if(!this.workspace.isClearing&&e){var l=this.getRelativeToSurfaceXY();if(t){t.getSvgRoot().appendChild(e);var i=this.getRelativeToSurfaceXY();this.moveConnections(i.x-l.x,i.y-l.y)}else o&&(this.workspace.getCanvas().appendChild(e),this.translate(l.x,l.y));this.applyColour()}}},Blockly.BlockSvg.prototype.getRelativeToSurfaceXY=function(){var t=0,o=0,e=this.useDragSurface_?this.workspace.getBlockDragSurface().getGroup():null,l=this.getSvgRoot();if(l)do{var i=Blockly.utils.getRelativeXY(l);if(t+=i.x,o+=i.y,this.useDragSurface_&&this.workspace.getBlockDragSurface().getCurrentBlock()==l){var r=this.workspace.getBlockDragSurface().getSurfaceTranslation();t+=r.x,o+=r.y}l=l.parentNode}while(l&&l!=this.workspace.getCanvas()&&l!=e);return new Blockly.utils.Coordinate(t,o)},Blockly.BlockSvg.prototype.moveBy=function(t,o){if(this.parentBlock_)throw Error("Block has parent.");var e=Blockly.Events.isEnabled();if(e)var l=new(Blockly.Events.get(Blockly.Events.BLOCK_MOVE))(this);var i=this.getRelativeToSurfaceXY();this.translate(i.x+t,i.y+o),this.moveConnections(t,o),e&&(l.recordNew(),Blockly.Events.fire(l)),this.workspace.resizeContents()},Blockly.BlockSvg.prototype.translate=function(t,o){this.getSvgRoot().setAttribute("transform","translate("+t+","+o+")")},Blockly.BlockSvg.prototype.moveToDragSurface=function(){if(this.useDragSurface_){var t=this.getRelativeToSurfaceXY();this.clearTransformAttributes_(),this.workspace.getBlockDragSurface().translateSurface(t.x,t.y);var o=this.getSvgRoot();o&&this.workspace.getBlockDragSurface().setBlocksAndShow(o)}},Blockly.BlockSvg.prototype.moveTo=function(t){var o=this.getRelativeToSurfaceXY();this.moveBy(t.x-o.x,t.y-o.y)},Blockly.BlockSvg.prototype.moveOffDragSurface=function(t){this.useDragSurface_&&(this.translate(t.x,t.y),this.workspace.getBlockDragSurface().clearAndHide(this.workspace.getCanvas()))},Blockly.BlockSvg.prototype.moveDuringDrag=function(t){this.useDragSurface_?this.workspace.getBlockDragSurface().translateSurface(t.x,t.y):(this.svgGroup_.translate_="translate("+t.x+","+t.y+")",this.svgGroup_.setAttribute("transform",this.svgGroup_.translate_+this.svgGroup_.skew_))},Blockly.BlockSvg.prototype.clearTransformAttributes_=function(){this.getSvgRoot().removeAttribute("transform")},Blockly.BlockSvg.prototype.snapToGrid=function(){if(this.workspace&&!this.workspace.isDragging()&&!this.getParent()&&!this.isInFlyout){var t=this.workspace.getGrid();if(t&&t.shouldSnap()){var o=t.getSpacing(),e=o/2,l=this.getRelativeToSurfaceXY(),i=Math.round((l.x-e)/o)*o+e-l.x,r=Math.round((l.y-e)/o)*o+e-l.y;i=Math.round(i),r=Math.round(r),0==i&&0==r||this.moveBy(i,r)}}},Blockly.BlockSvg.prototype.getBoundingRectangle=function(){var t,o,e=this.getRelativeToSurfaceXY(),l=this.getHeightWidth();return this.RTL?(t=e.x-l.width,o=e.x):(t=e.x,o=e.x+l.width),new Blockly.utils.Rect(e.y,e.y+l.height,t,o)},Blockly.BlockSvg.prototype.markDirty=function(){this.pathObject.constants=this.workspace.getRenderer().getConstants();for(var t,o=0;t=this.inputList[o];o++)t.markDirty()},Blockly.BlockSvg.prototype.setOpacity=function(t){this.opacity_=t,this.rendered&&this.updateColour()},Blockly.BlockSvg.prototype.getOpacity=function(){return this.opacity_},Blockly.BlockSvg.prototype.setCollapsed=function(t){this.collapsed_!=t&&(Blockly.BlockSvg.superClass_.setCollapsed.call(this,t),t?this.rendered&&this.render():this.updateCollapsed_())},Blockly.BlockSvg.prototype.updateCollapsed_=function(){for(var t=this.isCollapsed(),o=Blockly.constants.COLLAPSED_INPUT_NAME,e=Blockly.constants.COLLAPSED_FIELD_NAME,l=0;c=this.inputList[l];l++)c.name!=o&&c.setVisible(!t);if(!t)return this.updateDisabled(),void this.removeInput(o);var i,r=this.getIcons();for(l=0;i=r[l];l++)i.setVisible(!1);var s=this.toString(Blockly.COLLAPSE_CHARS),n=this.getField(e);if(n)n.setValue(s);else{var c;(c=this.getInput(o)||this.appendDummyInput(o)).appendField(new Blockly.FieldLabel(s),e);var a=this,h=this.workspace.getRenderer().getConstants().EXPAND_IMAGE_DATAURI;h&&c.appendField(new Blockly.FieldImage(h,24,24,"",function(){a.setCollapsed(!1)},!1))}},Blockly.BlockSvg.prototype.tab=function(t,o){var e=new Blockly.TabNavigateCursor;e.setCurNode(Blockly.ASTNode.createFieldNode(t));var l=e.getCurNode();o?e.next():e.prev();var i=e.getCurNode();i&&i!==l&&(i.getLocation().showEditor(),this.workspace.keyboardAccessibilityMode&&this.workspace.getCursor().setCurNode(i))},Blockly.BlockSvg.prototype.onMouseDown_=function(t){var o=this.workspace&&this.workspace.getGesture(t);o&&o.handleBlockStart(t,this)},Blockly.BlockSvg.prototype.showHelp=function(){var t="function"==typeof this.helpUrl?this.helpUrl():this.helpUrl;t&&alert(t)},Blockly.BlockSvg.prototype.generateContextMenu=function(){if(this.workspace.options.readOnly||!this.contextMenu)return null;var t=Blockly.ContextMenuRegistry.registry.getContextMenuOptions(Blockly.ContextMenuRegistry.ScopeType.BLOCK,{block:this});return this.customContextMenu&&this.customContextMenu(t),t},Blockly.BlockSvg.prototype.showContextMenu=function(t){if(this.parentBlock_&&this.isShadow_&&!Blockly.pxtBlocklyUtils.isShadowArgumentReporter(this))this.parentBlock_.showContextMenu_(t);else{var o=this.generateContextMenu();o&&o.length&&(Blockly.ContextMenu.show(t,o,this.RTL),Blockly.ContextMenu.currentBlock=this)}},Blockly.BlockSvg.prototype.moveConnections=function(t,o){if(this.rendered){for(var e=this.getConnections_(!1),l=0;l<e.length;l++)e[l].moveBy(t,o);var i=this.getIcons();for(l=0;l<i.length;l++)i[l].computeIconLocation();for(l=0;l<this.childBlocks_.length;l++)this.childBlocks_[l].moveConnections(t,o);Blockly.WidgetDiv.repositionForWindowResize(),Blockly.DropDownDiv.repositionForWindowResize()}},Blockly.BlockSvg.prototype.setDragging=function(t){if(t){var o=this.getSvgRoot();o.translate_="",o.skew_="",Blockly.draggingConnections=Blockly.draggingConnections.concat(this.getConnections_(!0)),Blockly.utils.dom.addClass(this.svgGroup_,"blocklyDragging")}else Blockly.draggingConnections=[],Blockly.utils.dom.removeClass(this.svgGroup_,"blocklyDragging");for(var e=0;e<this.childBlocks_.length;e++)this.childBlocks_[e].setDragging(t)},Blockly.BlockSvg.prototype.setMovable=function(t){Blockly.BlockSvg.superClass_.setMovable.call(this,t),t||this.unselect(),this.pathObject.updateMovable(t)},Blockly.BlockSvg.prototype.setEditable=function(t){Blockly.BlockSvg.superClass_.setEditable.call(this,t);for(var o=this.getIcons(),e=0;e<o.length;e++)o[e].updateEditable()},Blockly.BlockSvg.prototype.setShadow=function(t){Blockly.BlockSvg.superClass_.setShadow.call(this,t),this.applyColour()},Blockly.BlockSvg.prototype.setInsertionMarker=function(t,o){this.isInsertionMarker_!=t&&(this.isInsertionMarker_=t,this.isInsertionMarker_&&(this.setColour(this.workspace.getRenderer().getConstants().INSERTION_MARKER_COLOUR),this.pathObject.updateInsertionMarker(!0)))},Blockly.BlockSvg.prototype.getSvgRoot=function(){return this.svgGroup_},Blockly.BlockSvg.prototype.dispose=function(t,o){if(this.workspace){Blockly.Tooltip.dispose(),Blockly.Tooltip.unbindMouseEvents(this.pathObject.svgPath),Blockly.utils.dom.startTextWidthCache();var e=this.workspace;if(Blockly.selected==this&&(this.unselect(),this.workspace.cancelCurrentGesture()),Blockly.ContextMenu.currentBlock==this&&Blockly.ContextMenu.hide(),o&&this.rendered&&(this.unplug(t),Blockly.blockAnimations.disposeUiEffect(this)),this.rendered=!1,this.warningTextDb_){for(var l in this.warningTextDb_)clearTimeout(this.warningTextDb_[l]);this.warningTextDb_=null}for(var i=this.getIcons(),r=0;r<i.length;r++)i[r].dispose();Blockly.BlockSvg.superClass_.dispose.call(this,!!t),Blockly.utils.dom.removeNode(this.svgGroup_),e.resizeContents(),this.svgGroup_=null,Blockly.utils.dom.stopTextWidthCache()}},Blockly.BlockSvg.prototype.toCopyData=function(){if(this.isInsertionMarker_)return null;var t=Blockly.Xml.blockToDom(this,!0);Blockly.Xml.deleteNext(t);var o=this.getRelativeToSurfaceXY();return t.setAttribute("x",this.RTL?-o.x:o.x),t.setAttribute("y",o.y),{xml:t,source:this.workspace,typeCounts:Blockly.utils.getBlockTypeCounts(this,!0)}},Blockly.BlockSvg.prototype.applyColour=function(){this.pathObject.applyColour(this);for(var t=this.getIcons(),o=0;o<t.length;o++)t[o].applyColour();for(var e,l=0;e=this.inputList[l];l++)for(var i,r=0;i=e.fieldRow[r];r++)i.applyColour()},Blockly.BlockSvg.prototype.updateDisabled=function(){var t=this.getChildren(!1);if(this.applyColour(),!this.isCollapsed())for(var o,e=0;o=t[e];e++)o.rendered&&o.updateDisabled()},Blockly.BlockSvg.prototype.getCommentIcon=function(){return this.commentIcon_},Blockly.BlockSvg.prototype.enableBreakpoint=function(t){var o=!1;t?this.breakpoint||(this.breakpoint=new Blockly.Breakpoint(this),o=!0,this.breakpoint.enableBreakpoint()):this.breakpoint&&(this.breakpoint.dispose(),o=!0),o&&this.rendered&&(this.render(),this.bumpNeighbours())},Blockly.BlockSvg.prototype.setCommentText=function(t){if(!Blockly.Comment)throw Error("Missing require for Blockly.Comment");if(this.commentModel.text!=t){Blockly.BlockSvg.superClass_.setCommentText.call(this,t);var o=null!=t;!!this.commentIcon_!=o?(o?(this.commentIcon_=new Blockly.Comment(this),this.comment=this.commentIcon_):(this.commentIcon_.dispose(),this.commentIcon_=null,this.comment=null),this.rendered&&(this.render(),this.bumpNeighbours())):this.commentIcon_.updateText()}},Blockly.BlockSvg.prototype.setWarningText=function(t,o){if(!Blockly.Warning)throw Error("Missing require for Blockly.Warning");this.warningTextDb_||(this.warningTextDb_=Object.create(null));var e=o||"";if(e)this.warningTextDb_[e]&&(clearTimeout(this.warningTextDb_[e]),delete this.warningTextDb_[e]);else for(var l in this.warningTextDb_)clearTimeout(this.warningTextDb_[l]),delete this.warningTextDb_[l];if(this.workspace.isDragging()){var i=this;this.warningTextDb_[e]=setTimeout(function(){i.workspace&&(delete i.warningTextDb_[e],i.setWarningText(t,e))},100)}else{this.isInFlyout&&(t=null);var r=!1;if("string"==typeof t){for(var s=this.getSurroundParent(),n=null;s;)s.isCollapsed()&&(n=s),s=s.getSurroundParent();n&&n.setWarningText(Blockly.Msg.COLLAPSED_WARNINGS_WARNING,Blockly.BlockSvg.COLLAPSED_WARNING_ID),this.warning||(this.warning=new Blockly.Warning(this),r=!0),this.warning.setText(t,e)}else if(this.warning&&!e)this.warning.dispose(),r=!0;else if(this.warning){var c=this.warning.getText();this.warning.setText("",e);var a=this.warning.getText();a||this.warning.dispose(),r=c!=a}r&&this.rendered&&(this.render(),this.bumpNeighbours())}},Blockly.BlockSvg.prototype.setMutator=function(t){this.mutator&&this.mutator!==t&&this.mutator.dispose(),t&&(t.setBlock(this),this.mutator=t,t.createIcon()),this.rendered&&(this.render(),this.bumpNeighbours())},Blockly.BlockSvg.prototype.setEnabled=function(t){this.isEnabled()!=t&&(Blockly.BlockSvg.superClass_.setEnabled.call(this,t),this.rendered&&!this.getInheritedDisabled()&&this.updateDisabled())},Blockly.BlockSvg.prototype.setHighlighted=function(t){this.rendered&&this.pathObject.updateHighlighted(t)},Blockly.BlockSvg.prototype.setHighlightWarning=function(t){this.rendered&&this.pathObject.updateHighlightedWarning(t)},Blockly.BlockSvg.prototype.addSelect=function(){this.pathObject.updateSelected(!0)},Blockly.BlockSvg.prototype.removeSelect=function(){this.pathObject.updateSelected(!1)},Blockly.BlockSvg.prototype.setDeleteStyle=function(t){this.pathObject.updateDraggingDelete(t)},Blockly.BlockSvg.prototype.getColour=function(){return this.style.colourPrimary},Blockly.BlockSvg.prototype.getColourSecondary=function(){return this.style.colourSecondary},Blockly.BlockSvg.prototype.getColourTertiary=function(){return this.style.colourTertiary},Blockly.BlockSvg.prototype.setColour=function(t,o,e){Blockly.BlockSvg.superClass_.setColour.call(this,t);var l=this.workspace.getRenderer().getConstants().getBlockStyleForColour(this.colour_);this.pathObject.setStyle(l.style),this.style=l.style,this.styleName_=l.name,o&&(this.style.colourSecondary=o),e&&(this.style.colourTertiary=e),this.applyColour()},Blockly.BlockSvg.prototype.setStyle=function(t){var o=this.workspace.getRenderer().getConstants().getBlockStyle(t);if(this.styleName_=t,!o)throw Error("Invalid style name: "+t);this.hat=o.hat,this.pathObject.setStyle(o),this.colour_=o.colourPrimary,this.style=o,this.applyColour()},Blockly.BlockSvg.prototype.bringToFront=function(){var t=this;do{var o=t.getSvgRoot(),e=o.parentNode,l=e.childNodes;l[l.length-1]!==o&&e.appendChild(o),t=t.getParent()}while(t)},Blockly.BlockSvg.prototype.setPreviousStatement=function(t,o){Blockly.BlockSvg.superClass_.setPreviousStatement.call(this,t,o),this.rendered&&(this.render(),this.bumpNeighbours())},Blockly.BlockSvg.prototype.setNextStatement=function(t,o){Blockly.BlockSvg.superClass_.setNextStatement.call(this,t,o),this.rendered&&(this.render(),this.bumpNeighbours())},Blockly.BlockSvg.prototype.setOutput=function(t,o){Blockly.BlockSvg.superClass_.setOutput.call(this,t,o),this.rendered&&(this.render(),this.bumpNeighbours())},Blockly.BlockSvg.prototype.setInputsInline=function(t){Blockly.BlockSvg.superClass_.setInputsInline.call(this,t),this.rendered&&(this.render(),this.bumpNeighbours())},Blockly.BlockSvg.prototype.removeInput=function(t,o){var e=Blockly.BlockSvg.superClass_.removeInput.call(this,t,o);return this.rendered&&(this.render(),this.bumpNeighbours()),e},Blockly.BlockSvg.prototype.moveNumberedInputBefore=function(t,o){Blockly.BlockSvg.superClass_.moveNumberedInputBefore.call(this,t,o),this.rendered&&(this.render(),this.bumpNeighbours())},Blockly.BlockSvg.prototype.appendInput_=function(t,o){var e=Blockly.BlockSvg.superClass_.appendInput_.call(this,t,o);return this.rendered&&(this.render(),this.bumpNeighbours()),e},Blockly.BlockSvg.prototype.setConnectionTracking=function(t){if(this.previousConnection&&this.previousConnection.setTracking(t),this.outputConnection&&this.outputConnection.setTracking(t),this.nextConnection){this.nextConnection.setTracking(t);var o=this.nextConnection.targetBlock();o&&o.setConnectionTracking(t)}if(!this.collapsed_)for(var e=0;e<this.inputList.length;e++)if(this.inputList[e].isVisible()){var l=this.inputList[e].connection;if(l){l.setTracking(t);var i=l.targetBlock();i&&i.setConnectionTracking(t)}}},Blockly.BlockSvg.prototype.getConnections_=function(t){var o=[];if((t||this.rendered)&&(this.outputConnection&&o.push(this.outputConnection),this.previousConnection&&o.push(this.previousConnection),this.nextConnection&&o.push(this.nextConnection),t||!this.collapsed_))for(var e,l=0;e=this.inputList[l];l++)e.connection&&o.push(e.connection);return o},Blockly.BlockSvg.prototype.lastConnectionInStack=function(t){return Blockly.BlockSvg.superClass_.lastConnectionInStack.call(this,t)},Blockly.BlockSvg.prototype.getMatchingConnection=function(t,o){return Blockly.BlockSvg.superClass_.getMatchingConnection.call(this,t,o)},Blockly.BlockSvg.prototype.makeConnection_=function(t){return new Blockly.RenderedConnection(this,t)},Blockly.BlockSvg.prototype.bumpNeighbours=function(){if(this.workspace&&!this.workspace.isDragging()){var t=this.getRootBlock();if(!t.isInFlyout)for(var o,e=this.getConnections_(!1),l=0;o=e[l];l++){o.isConnected()&&o.isSuperior()&&o.targetBlock().bumpNeighbours();for(var i,r=o.neighbours(Blockly.SNAP_RADIUS),s=0;i=r[s];s++)o.isConnected()&&i.isConnected()||i.getSourceBlock().getRootBlock()!=t&&(o.isSuperior()?i.bumpAwayFrom(o):o.bumpAwayFrom(i))}}},Blockly.BlockSvg.prototype.scheduleSnapAndBump=function(){var t=this,o=Blockly.Events.getGroup();setTimeout(function(){Blockly.Events.setGroup(o),t.snapToGrid(),Blockly.Events.setGroup(!1)},Blockly.BUMP_DELAY/2),setTimeout(function(){Blockly.Events.setGroup(o),t.bumpNeighbours(),Blockly.Events.setGroup(!1)},Blockly.BUMP_DELAY)},Blockly.BlockSvg.prototype.bindReporterHoverEvents_=function(){var t=this;Blockly.bindEvent_(this.svgGroup_,"mouseover",null,function(o){var e=t;if(!e.isInFlyout){for(;e.isShadow_&&e.parentBlock_;)e=e.parentBlock_;e.parentBlock_&&e.outputConnection&&(Blockly.utils.dom.addClass(e.pathObject.svgPath,"blocklyReporterHover"),o.stopPropagation())}}),Blockly.bindEvent_(this.svgGroup_,"mouseout",null,function(){t.isInFlyout||Blockly.utils.dom.removeClass(t.pathObject.svgPath,"blocklyReporterHover")})},Blockly.BlockSvg.prototype.positionNearConnection=function(t,o){if(t.type==Blockly.connectionTypes.NEXT_STATEMENT||t.type==Blockly.connectionTypes.INPUT_VALUE){var e=o.x-t.x,l=o.y-t.y;this.moveBy(e,l)}},Blockly.BlockSvg.prototype.getParent=function(){return Blockly.BlockSvg.superClass_.getParent.call(this)},Blockly.BlockSvg.prototype.getRootBlock=function(){return Blockly.BlockSvg.superClass_.getRootBlock.call(this)},Blockly.BlockSvg.prototype.render=function(t){if(!this.renderIsInProgress_){this.renderIsInProgress_=!0;try{if(this.rendered=!0,Blockly.utils.dom.startTextWidthCache(),this.isCollapsed()&&this.updateCollapsed_(),this.workspace.getRenderer().render(this),this.updateConnectionLocations_(),!1!==t){var o=this.getParent();o?o.render(!0):this.workspace.resizeContents()}Blockly.utils.dom.stopTextWidthCache(),this.updateMarkers_()}finally{this.renderIsInProgress_=!1}}},Blockly.BlockSvg.prototype.updateMarkers_=function(){this.workspace.keyboardAccessibilityMode&&this.pathObject.cursorSvg&&this.workspace.getCursor().draw(),this.workspace.keyboardAccessibilityMode&&this.pathObject.markerSvg&&this.workspace.getMarker(Blockly.MarkerManager.LOCAL_MARKER).draw()},Blockly.BlockSvg.prototype.updateConnectionLocations_=function(){var t=this.getRelativeToSurfaceXY();this.previousConnection&&this.previousConnection.moveToOffset(t),this.outputConnection&&this.outputConnection.moveToOffset(t);for(var o=0;o<this.inputList.length;o++){var e=this.inputList[o].connection;e&&(e.moveToOffset(t),e.isConnected()&&e.tighten())}this.nextConnection&&(this.nextConnection.moveToOffset(t),this.nextConnection.isConnected()&&this.nextConnection.tighten())},Blockly.BlockSvg.prototype.setCursorSvg=function(t){this.pathObject.setCursorSvg(t)},Blockly.BlockSvg.prototype.setMarkerSvg=function(t){this.pathObject.setMarkerSvg(t)},Blockly.BlockSvg.prototype.getHeightWidth=function(){var t=this.height,o=this.width,e=this.getNextBlock();if(e){var l=e.getHeightWidth(),i=this.workspace.getRenderer().getConstants().NOTCH_HEIGHT;t+=l.height-i,o=Math.max(o,l.width)}return{height:t,width:o}},Blockly.BlockSvg.prototype.fadeForReplacement=function(t){this.pathObject.updateReplacementFade(t)},Blockly.BlockSvg.prototype.highlightShapeForInput=function(t,o){this.pathObject.updateShapeForInputHighlight(t,o)};