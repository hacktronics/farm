/**
 * @license
 * Copyright 2011 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.Scrollbar"),goog.provide("Blockly.ScrollbarPair"),goog.require("Blockly.browserEvents"),goog.require("Blockly.Events"),goog.require("Blockly.Touch"),goog.require("Blockly.utils"),goog.require("Blockly.utils.Coordinate"),goog.require("Blockly.utils.dom"),goog.require("Blockly.utils.Metrics"),goog.require("Blockly.utils.Svg"),goog.requireType("Blockly.WorkspaceSvg"),Blockly.ScrollbarPair=function(t,o,l,i,s){this.workspace_=t,l=void 0===l||l;var e=(o=void 0===o||o)&&l;o&&(this.hScroll=new Blockly.Scrollbar(t,!0,e,i,s)),l&&(this.vScroll=new Blockly.Scrollbar(t,!1,e,i,s)),e&&(this.corner_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.RECT,{height:Blockly.Scrollbar.scrollbarThickness,width:Blockly.Scrollbar.scrollbarThickness,class:"blocklyScrollbarBackground"},null),Blockly.utils.dom.insertAfter(this.corner_,t.getBubbleCanvas())),this.oldHostMetrics_=null},Blockly.ScrollbarPair.prototype.dispose=function(){Blockly.utils.dom.removeNode(this.corner_),this.corner_=null,this.workspace_=null,this.oldHostMetrics_=null,this.hScroll&&(this.hScroll.dispose(),this.hScroll=null),this.vScroll&&(this.vScroll.dispose(),this.vScroll=null)},Blockly.ScrollbarPair.prototype.resize=function(){var t=this.workspace_.getMetrics();if(t){var o=!1,l=!1;if(this.oldHostMetrics_&&this.oldHostMetrics_.viewWidth==t.viewWidth&&this.oldHostMetrics_.viewHeight==t.viewHeight&&this.oldHostMetrics_.absoluteTop==t.absoluteTop&&this.oldHostMetrics_.absoluteLeft==t.absoluteLeft?(this.oldHostMetrics_&&this.oldHostMetrics_.scrollWidth==t.scrollWidth&&this.oldHostMetrics_.viewLeft==t.viewLeft&&this.oldHostMetrics_.scrollLeft==t.scrollLeft||(o=!0),this.oldHostMetrics_&&this.oldHostMetrics_.scrollHeight==t.scrollHeight&&this.oldHostMetrics_.viewTop==t.viewTop&&this.oldHostMetrics_.scrollTop==t.scrollTop||(l=!0)):(o=!0,l=!0),o||l){try{Blockly.Events.disable(),this.hScroll&&o&&this.hScroll.resize(t),this.vScroll&&l&&this.vScroll.resize(t)}finally{Blockly.Events.enable()}this.workspace_.maybeFireViewportChangeEvent()}this.hScroll&&this.vScroll&&(this.oldHostMetrics_&&this.oldHostMetrics_.viewWidth==t.viewWidth&&this.oldHostMetrics_.absoluteLeft==t.absoluteLeft||this.corner_.setAttribute("x",this.vScroll.position.x),this.oldHostMetrics_&&this.oldHostMetrics_.viewHeight==t.viewHeight&&this.oldHostMetrics_.absoluteTop==t.absoluteTop||this.corner_.setAttribute("y",this.hScroll.position.y)),this.oldHostMetrics_=t}},Blockly.ScrollbarPair.prototype.canScrollHorizontally=function(){return!!this.hScroll},Blockly.ScrollbarPair.prototype.canScrollVertically=function(){return!!this.vScroll},Blockly.ScrollbarPair.prototype.setOrigin=function(t,o){this.hScroll&&this.hScroll.setOrigin(t,o),this.vScroll&&this.vScroll.setOrigin(t,o)},Blockly.ScrollbarPair.prototype.set=function(t,o,l){if(this.hScroll&&this.hScroll.set(t,!1),this.vScroll&&this.vScroll.set(o,!1),l||void 0===l){var i={};this.hScroll&&(i.x=this.hScroll.getRatio_()),this.vScroll&&(i.y=this.vScroll.getRatio_()),this.workspace_.setMetrics(i)}},Blockly.ScrollbarPair.prototype.setX=function(t){this.hScroll&&this.hScroll.set(t,!0)},Blockly.ScrollbarPair.prototype.setY=function(t){this.vScroll&&this.vScroll.set(t,!0)},Blockly.ScrollbarPair.prototype.setContainerVisible=function(t){this.hScroll&&this.hScroll.setContainerVisible(t),this.vScroll&&this.vScroll.setContainerVisible(t)},Blockly.ScrollbarPair.prototype.isVisible=function(){var t=!1;return this.hScroll&&(t=this.hScroll.isVisible()),this.vScroll&&(t=t||this.vScroll.isVisible()),t},Blockly.ScrollbarPair.prototype.resizeContent=function(t){this.hScroll&&this.hScroll.resizeContentHorizontal(t),this.vScroll&&this.vScroll.resizeContentVertical(t)},Blockly.ScrollbarPair.prototype.resizeView=function(t){this.hScroll&&this.hScroll.resizeViewHorizontal(t),this.vScroll&&this.vScroll.resizeViewVertical(t)},Blockly.Scrollbar=function(t,o,l,i,s){this.workspace_=t,this.pair_=l||!1,this.horizontal_=o,this.margin_=void 0!==s?s:Blockly.Scrollbar.DEFAULT_SCROLLBAR_MARGIN,this.oldHostMetrics_=null,this.ratio=null,this.svgGroup_=null,this.createDom_(i),this.position=new Blockly.utils.Coordinate(0,0);var e=Blockly.Scrollbar.scrollbarThickness;o?(this.svgBackground_.setAttribute("height",e),this.outerSvg_.setAttribute("height",e),this.svgHandle_.setAttribute("height",e-5),this.svgHandle_.setAttribute("y",2.5),this.lengthAttribute_="width",this.positionAttribute_="x"):(this.svgBackground_.setAttribute("width",e),this.outerSvg_.setAttribute("width",e),this.svgHandle_.setAttribute("width",e-5),this.svgHandle_.setAttribute("x",2.5),this.lengthAttribute_="height",this.positionAttribute_="y");var r=this;this.onMouseDownBarWrapper_=Blockly.browserEvents.conditionalBind(this.svgBackground_,"mousedown",r,r.onMouseDownBar_),this.onMouseDownHandleWrapper_=Blockly.browserEvents.conditionalBind(this.svgHandle_,"mousedown",r,r.onMouseDownHandle_)},Blockly.Scrollbar.prototype.origin_=new Blockly.utils.Coordinate(0,0),Blockly.Scrollbar.prototype.originHasChanged_=!0,Blockly.Scrollbar.prototype.startDragMouse_=0,Blockly.Scrollbar.prototype.scrollbarLength_=0,Blockly.Scrollbar.prototype.handleLength_=0,Blockly.Scrollbar.prototype.handlePosition_=0,Blockly.Scrollbar.prototype.isVisible_=!0,Blockly.Scrollbar.prototype.containerVisible_=!0,Blockly.Scrollbar.scrollbarThickness=15,Blockly.Touch.TOUCH_ENABLED&&(Blockly.Scrollbar.scrollbarThickness=25),Blockly.Scrollbar.DEFAULT_SCROLLBAR_MARGIN=.5,Blockly.Scrollbar.metricsAreEquivalent_=function(t,o){return t.viewWidth==o.viewWidth&&t.viewHeight==o.viewHeight&&t.viewLeft==o.viewLeft&&t.viewTop==o.viewTop&&t.absoluteTop==o.absoluteTop&&t.absoluteLeft==o.absoluteLeft&&t.scrollWidth==o.scrollWidth&&t.scrollHeight==o.scrollHeight&&t.scrollLeft==o.scrollLeft&&t.scrollTop==o.scrollTop},Blockly.Scrollbar.prototype.dispose=function(){this.cleanUp_(),Blockly.browserEvents.unbind(this.onMouseDownBarWrapper_),this.onMouseDownBarWrapper_=null,Blockly.browserEvents.unbind(this.onMouseDownHandleWrapper_),this.onMouseDownHandleWrapper_=null,Blockly.utils.dom.removeNode(this.outerSvg_),this.outerSvg_=null,this.svgGroup_=null,this.svgBackground_=null,this.svgHandle_&&(this.workspace_.getThemeManager().unsubscribe(this.svgHandle_),this.svgHandle_=null),this.workspace_=null},Blockly.Scrollbar.prototype.constrainHandleLength_=function(t){return t=t<=0||isNaN(t)?0:Math.min(t,this.scrollbarLength_)},Blockly.Scrollbar.prototype.setHandleLength_=function(t){this.handleLength_=t,this.svgHandle_.setAttribute(this.lengthAttribute_,this.handleLength_)},Blockly.Scrollbar.prototype.constrainHandlePosition_=function(t){return t=t<=0||isNaN(t)?0:Math.min(t,this.scrollbarLength_-this.handleLength_)},Blockly.Scrollbar.prototype.setHandlePosition=function(t){this.handlePosition_=t,this.svgHandle_.setAttribute(this.positionAttribute_,this.handlePosition_)},Blockly.Scrollbar.prototype.setScrollbarLength_=function(t){this.scrollbarLength_=t,this.outerSvg_.setAttribute(this.lengthAttribute_,this.scrollbarLength_),this.svgBackground_.setAttribute(this.lengthAttribute_,this.scrollbarLength_)},Blockly.Scrollbar.prototype.setPosition=function(t,o){this.position.x=t,this.position.y=o;var l="translate("+(this.position.x+this.origin_.x)+"px,"+(this.position.y+this.origin_.y)+"px)";Blockly.utils.dom.setCssTransform(this.outerSvg_,l)},Blockly.Scrollbar.prototype.resize=function(t){var o=t;(o||(o=this.workspace_.getMetrics()))&&(this.oldHostMetrics_&&Blockly.Scrollbar.metricsAreEquivalent_(o,this.oldHostMetrics_)||(this.horizontal_?this.resizeHorizontal_(o):this.resizeVertical_(o),this.oldHostMetrics_=o,this.updateMetrics_()))},Blockly.Scrollbar.prototype.requiresViewResize_=function(t){return!this.oldHostMetrics_||(this.oldHostMetrics_.viewWidth!==t.viewWidth||this.oldHostMetrics_.viewHeight!==t.viewHeight||this.oldHostMetrics_.absoluteLeft!==t.absoluteLeft||this.oldHostMetrics_.absoluteTop!==t.absoluteTop)},Blockly.Scrollbar.prototype.resizeHorizontal_=function(t){this.requiresViewResize_(t)?this.resizeViewHorizontal(t):this.resizeContentHorizontal(t)},Blockly.Scrollbar.prototype.resizeViewHorizontal=function(t){var o=t.viewWidth-2*this.margin_;this.pair_&&(o-=Blockly.Scrollbar.scrollbarThickness),this.setScrollbarLength_(Math.max(0,o));var l=t.absoluteLeft+this.margin_;this.pair_&&this.workspace_.RTL&&(l+=Blockly.Scrollbar.scrollbarThickness);var i=t.absoluteTop+t.viewHeight-Blockly.Scrollbar.scrollbarThickness-this.margin_;this.setPosition(l,i),this.resizeContentHorizontal(t)},Blockly.Scrollbar.prototype.resizeContentHorizontal=function(t){if(t.viewWidth>=t.scrollWidth)return this.setHandleLength_(this.scrollbarLength_),this.setHandlePosition(0),void(this.pair_||this.setVisible(!1));this.pair_||this.setVisible(!0);var o=this.scrollbarLength_*t.viewWidth/t.scrollWidth;o=this.constrainHandleLength_(o),this.setHandleLength_(o);var l=t.scrollWidth-t.viewWidth,i=(t.viewLeft-t.scrollLeft)/l,s=this.scrollbarLength_-this.handleLength_,e=s*i;e=this.constrainHandlePosition_(e),this.setHandlePosition(e),this.ratio=s/l},Blockly.Scrollbar.prototype.resizeVertical_=function(t){this.requiresViewResize_(t)?this.resizeViewVertical(t):this.resizeContentVertical(t)},Blockly.Scrollbar.prototype.resizeViewVertical=function(t){var o=t.viewHeight-2*this.margin_;this.pair_&&(o-=Blockly.Scrollbar.scrollbarThickness),this.setScrollbarLength_(Math.max(0,o));var l=this.workspace_.RTL?t.absoluteLeft+this.margin_:t.absoluteLeft+t.viewWidth-Blockly.Scrollbar.scrollbarThickness-this.margin_,i=t.absoluteTop+this.margin_;this.setPosition(l,i),this.resizeContentVertical(t)},Blockly.Scrollbar.prototype.resizeContentVertical=function(t){if(t.viewHeight>=t.scrollHeight)return this.setHandleLength_(this.scrollbarLength_),this.setHandlePosition(0),void(this.pair_||this.setVisible(!1));this.pair_||this.setVisible(!0);var o=this.scrollbarLength_*t.viewHeight/t.scrollHeight;o=this.constrainHandleLength_(o),this.setHandleLength_(o);var l=t.scrollHeight-t.viewHeight,i=(t.viewTop-t.scrollTop)/l,s=this.scrollbarLength_-this.handleLength_,e=s*i;e=this.constrainHandlePosition_(e),this.setHandlePosition(e),this.ratio=s/l},Blockly.Scrollbar.prototype.createDom_=function(t){var o="blocklyScrollbar"+(this.horizontal_?"Horizontal":"Vertical");t&&(o+=" "+t),this.outerSvg_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.SVG,{class:o},null),this.svgGroup_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.G,{},this.outerSvg_),this.svgBackground_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.RECT,{class:"blocklyScrollbarBackground"},this.svgGroup_);var l=Math.floor((Blockly.Scrollbar.scrollbarThickness-5)/2);this.svgHandle_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.RECT,{class:"blocklyScrollbarHandle",rx:l,ry:l},this.svgGroup_),this.workspace_.getThemeManager().subscribe(this.svgHandle_,"scrollbarColour","fill"),this.workspace_.getThemeManager().subscribe(this.svgHandle_,"scrollbarOpacity","fill-opacity"),Blockly.utils.dom.insertAfter(this.outerSvg_,this.workspace_.getParentSvg())},Blockly.Scrollbar.prototype.isVisible=function(){return this.isVisible_},Blockly.Scrollbar.prototype.setContainerVisible=function(t){var o=t!=this.containerVisible_;this.containerVisible_=t,o&&this.updateDisplay_()},Blockly.Scrollbar.prototype.setVisible=function(t){var o=t!=this.isVisible();if(this.pair_)throw Error("Unable to toggle visibility of paired scrollbars.");this.isVisible_=t,o&&this.updateDisplay_()},Blockly.Scrollbar.prototype.updateDisplay_=function(){!!this.containerVisible_&&this.isVisible()?this.outerSvg_.setAttribute("display","block"):this.outerSvg_.setAttribute("display","none")},Blockly.Scrollbar.prototype.onMouseDownBar_=function(t){if(this.workspace_.markFocused(),Blockly.Touch.clearTouchIdentifier(),this.cleanUp_(),Blockly.utils.isRightButton(t))t.stopPropagation();else{var o=Blockly.utils.mouseToSvg(t,this.workspace_.getParentSvg(),this.workspace_.getInverseScreenCTM()),l=this.horizontal_?o.x:o.y,i=Blockly.utils.getInjectionDivXY_(this.svgHandle_),s=this.horizontal_?i.x:i.y,e=this.handlePosition_,r=.95*this.handleLength_;l<=s?e-=r:l>=s+this.handleLength_&&(e+=r),Blockly.WidgetDiv.hide(!0),Blockly.DropDownDiv.hideWithoutAnimation(),this.setHandlePosition(this.constrainHandlePosition_(e)),this.updateMetrics_(),t.stopPropagation(),t.preventDefault()}},Blockly.Scrollbar.prototype.onMouseDownHandle_=function(t){this.workspace_.markFocused(),this.cleanUp_(),Blockly.utils.isRightButton(t)?t.stopPropagation():(this.startDragHandle=this.handlePosition_,this.workspace_.setupDragSurface(),this.startDragMouse_=this.horizontal_?t.clientX:t.clientY,Blockly.Scrollbar.onMouseUpWrapper_=Blockly.browserEvents.conditionalBind(document,"mouseup",this,this.onMouseUpHandle_),Blockly.Scrollbar.onMouseMoveWrapper_=Blockly.browserEvents.conditionalBind(document,"mousemove",this,this.onMouseMoveHandle_),t.stopPropagation(),t.preventDefault())},Blockly.Scrollbar.prototype.onMouseMoveHandle_=function(t){var o=(this.horizontal_?t.clientX:t.clientY)-this.startDragMouse_,l=this.startDragHandle+o;this.setHandlePosition(this.constrainHandlePosition_(l)),this.updateMetrics_()},Blockly.Scrollbar.prototype.onMouseUpHandle_=function(){this.workspace_.resetDragSurface(),Blockly.Touch.clearTouchIdentifier(),this.cleanUp_()},Blockly.Scrollbar.prototype.cleanUp_=function(){Blockly.hideChaff(!0),Blockly.Scrollbar.onMouseUpWrapper_&&(Blockly.browserEvents.unbind(Blockly.Scrollbar.onMouseUpWrapper_),Blockly.Scrollbar.onMouseUpWrapper_=null),Blockly.Scrollbar.onMouseMoveWrapper_&&(Blockly.browserEvents.unbind(Blockly.Scrollbar.onMouseMoveWrapper_),Blockly.Scrollbar.onMouseMoveWrapper_=null)},Blockly.Scrollbar.prototype.getRatio_=function(){var t=this.scrollbarLength_-this.handleLength_,o=this.handlePosition_/t;return isNaN(o)&&(o=0),o},Blockly.Scrollbar.prototype.updateMetrics_=function(){var t=this.getRatio_(),o={};this.horizontal_?o.x=t:o.y=t,this.workspace_.setMetrics(o)},Blockly.Scrollbar.prototype.set=function(t,o){const l=this.constrainHandlePosition_(t*this.ratio);this.handlePosition_!==l&&(this.setHandlePosition(l),(o||void 0===o)&&this.updateMetrics_())},Blockly.Scrollbar.prototype.setOrigin=function(t,o){this.origin_=new Blockly.utils.Coordinate(t,o)};