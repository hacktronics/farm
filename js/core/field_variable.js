/**
 * @license
 * Copyright 2012 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.FieldVariable"),goog.require("Blockly.constants"),goog.require("Blockly.Events.BlockChange"),goog.require("Blockly.FieldDropdown"),goog.require("Blockly.fieldRegistry"),goog.require("Blockly.Msg"),goog.require("Blockly.utils"),goog.require("Blockly.utils.object"),goog.require("Blockly.utils.Size"),goog.require("Blockly.VariableModel"),goog.require("Blockly.Variables"),goog.require("Blockly.Xml"),goog.requireType("Blockly.Block"),goog.requireType("Blockly.Menu"),goog.requireType("Blockly.MenuItem"),Blockly.FieldVariable=function(e,l,r,i,a){this.menuGenerator_=Blockly.FieldVariable.dropdownCreate,this.defaultVariableName="string"==typeof e?e:"",this.size_=new Blockly.utils.Size(0,0),a&&this.configure_(a),l&&this.setValidator(l),a||this.setTypes_(r,i)},Blockly.utils.object.inherits(Blockly.FieldVariable,Blockly.FieldDropdown),Blockly.FieldVariable.fromJson=function(e){var l=Blockly.utils.replaceMessageReferences(e.variable);return new Blockly.FieldVariable(l,void 0,void 0,void 0,e)},Blockly.FieldVariable.prototype.SERIALIZABLE=!0,Blockly.FieldVariable.prototype.configure_=function(e){Blockly.FieldVariable.superClass_.configure_.call(this,e),this.setTypes_(e.variableTypes,e.defaultType)},Blockly.FieldVariable.prototype.initModel=function(){if(!(this.variable_||this.sourceBlock_&&this.sourceBlock_.isInsertionMarker())){var e=Blockly.Variables.getOrCreateVariablePackage(this.sourceBlock_.workspace,null,this.defaultVariableName,this.defaultType_);this.doValueUpdate_(e.getId())}},Blockly.FieldVariable.prototype.shouldAddBorderRect_=function(){return Blockly.FieldVariable.superClass_.shouldAddBorderRect_.call(this)&&(!this.getConstants().FIELD_DROPDOWN_NO_BORDER_RECT_SHADOW||!("variables_get"==this.sourceBlock_.type||"variables_get_reporter"==this.sourceBlock_.type))},Blockly.FieldVariable.prototype.fromXml=function(e){e.getAttribute("id");var l=e.textContent,r=e.getAttribute("variabletype")||e.getAttribute("variableType")||"",i=Blockly.Variables.getOrCreateVariablePackage(this.sourceBlock_.workspace,null,l,r);if(null!=r&&r!==i.type)throw Error("Serialized variable type with id '"+i.getId()+"' had type "+i.type+", and does not match variable field that references it: "+Blockly.Xml.domToText(e)+".");this.setValue(i.getId())},Blockly.FieldVariable.prototype.toXml=function(e){return this.initModel(),e.id=this.variable_.getId(),e.textContent=this.variable_.name,this.variable_.type&&e.setAttribute("variabletype",this.variable_.type),e},Blockly.FieldVariable.prototype.setSourceBlock=function(e){if(e.isShadow())throw Error("Variable fields are not allowed to exist on shadow blocks.");Blockly.FieldVariable.superClass_.setSourceBlock.call(this,e)},Blockly.FieldVariable.prototype.getValue=function(){return this.variable_?this.variable_.getId():null},Blockly.FieldVariable.prototype.getText=function(){return this.variable_?this.variable_.name:""},Blockly.FieldVariable.prototype.getVariable=function(){return this.variable_},Blockly.FieldVariable.prototype.getValidator=function(){return this.variable_?this.validator_:null},Blockly.FieldVariable.prototype.doClassValidation_=function(e){if(null===e)return null;var l=e,r=Blockly.Variables.getVariable(this.sourceBlock_.workspace,l);if(!r)return console.warn("Variable id doesn't point to a real variable! ID was "+l),null;var i=r.type;return this.typeIsAllowed_(i)?l:(console.warn("Variable type doesn't match this field!  Type was "+i),null)},Blockly.FieldVariable.prototype.doValueUpdate_=function(e){this.variable_=Blockly.Variables.getVariable(this.sourceBlock_.workspace,e),Blockly.FieldVariable.superClass_.doValueUpdate_.call(this,e)},Blockly.FieldVariable.prototype.typeIsAllowed_=function(e){var l=this.getVariableTypes_();if(!l)return!0;for(var r=0;r<l.length;r++)if(e==l[r])return!0;return!1},Blockly.FieldVariable.prototype.getVariableTypes_=function(){var e=this.variableTypes;if(null===e&&this.sourceBlock_&&this.sourceBlock_.workspace)return this.sourceBlock_.workspace.getVariableTypes();if(0==(e=e||[""]).length){var l=this.getText();throw Error("'variableTypes' of field variable "+l+" was an empty list")}return e},Blockly.FieldVariable.prototype.setTypes_=function(e,l){var r=l||"";if(null==e||null==e)var i=null;else{if(!Array.isArray(e))throw Error("'variableTypes' was not an array in the definition of a FieldVariable");i=e;for(var a=!1,t=0;t<i.length;t++)i[t]==r&&(a=!0);if(!a)throw Error("Invalid default type '"+r+"' in the definition of a FieldVariable")}this.defaultType_=r,this.variableTypes=i},Blockly.FieldVariable.dropdownCreate=function(){if(!this.variable_)throw Error("Tried to call dropdownCreate on a variable field with no variable selected.");var e=this.getText(),l=[];if(this.sourceBlock_&&this.sourceBlock_.workspace)for(var r=this.getVariableTypes_(),i=0;i<r.length;i++){var a=r[i],t=this.sourceBlock_.workspace.getVariablesOfType(a);l=l.concat(t)}l.sort(Blockly.VariableModel.compareByName);var o=[];for(i=0;i<l.length;i++)o[i]=[l[i].name,l[i].getId()];if(Blockly.Msg.NEW_VARIABLE_TYPE_DROPDOWN&&this.variable_.type){var s=this.variable_.type;o.push([Blockly.Msg.NEW_VARIABLE_TYPE_DROPDOWN.replace("%1",s),Blockly.CREATE_VARIABLE_ID]),o.push([void 0,"SEPARATOR"])}else Blockly.Msg.NEW_VARIABLE_DROPDOWN&&(o.push([Blockly.Msg.NEW_VARIABLE_DROPDOWN,Blockly.CREATE_VARIABLE_ID]),o.push([void 0,"SEPARATOR"]));return o.push([Blockly.Msg.RENAME_VARIABLE,Blockly.RENAME_VARIABLE_ID]),Blockly.Msg.DELETE_VARIABLE&&o.push([Blockly.Msg.DELETE_VARIABLE.replace("%1",e),Blockly.DELETE_VARIABLE_ID]),o},Blockly.FieldVariable.prototype.onItemSelected_=function(e,l){var r=l.getValue();if(this.sourceBlock_&&this.sourceBlock_.workspace){if(r==Blockly.RENAME_VARIABLE_ID)return void Blockly.Variables.renameVariable(this.sourceBlock_.workspace,this.variable_);if(r==Blockly.DELETE_VARIABLE_ID)return void this.sourceBlock_.workspace.deleteVariableById(this.variable_.getId());if(r==Blockly.CREATE_VARIABLE_ID){var i=this,a=this.sourceBlock_.workspace,t=a.getVariableById(this.getValue()).type;return void Blockly.Variables.createVariableButtonHandler(a,function(e){var l=a.getVariable(e,t);i.setValue(l.getId())},t)}}this.setValue(r)},Blockly.FieldVariable.prototype.referencesVariables=function(){return!0},Blockly.fieldRegistry.register("field_variable",Blockly.FieldVariable);