/**
 * @license
 * Copyright 2014 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.WorkspaceSvg"),goog.require("Blockly.blockRendering"),goog.require("Blockly.BlockSvg"),goog.require("Blockly.browserEvents"),goog.require("Blockly.Colours"),goog.require("Blockly.ComponentManager"),goog.require("Blockly.ConnectionDB"),goog.require("Blockly.constants"),goog.require("Blockly.ContextMenu"),goog.require("Blockly.ContextMenuRegistry"),goog.require("Blockly.DropDownDiv"),goog.require("Blockly.Events"),goog.require("Blockly.Events.BlockCreate"),goog.require("Blockly.Events.ThemeChange"),goog.require("Blockly.Events.ViewportChange"),goog.require("Blockly.Gesture"),goog.require("Blockly.Grid"),goog.require("Blockly.IASTNodeLocationSvg"),goog.require("Blockly.MarkerManager"),goog.require("Blockly.MetricsManager"),goog.require("Blockly.Msg"),goog.require("Blockly.Options"),goog.require("Blockly.registry"),goog.require("Blockly.ThemeManager"),goog.require("Blockly.Themes.Classic"),goog.require("Blockly.TouchGesture"),goog.require("Blockly.utils"),goog.require("Blockly.utils.Coordinate"),goog.require("Blockly.utils.dom"),goog.require("Blockly.utils.Metrics"),goog.require("Blockly.utils.object"),goog.require("Blockly.utils.Rect"),goog.require("Blockly.utils.Size"),goog.require("Blockly.utils.Svg"),goog.require("Blockly.utils.toolbox"),goog.require("Blockly.Workspace"),goog.require("Blockly.WorkspaceAudio"),goog.require("Blockly.WorkspaceDragSurfaceSvg"),goog.require("Blockly.Xml"),goog.requireType("Blockly.Block"),goog.requireType("Blockly.BlockDragSurfaceSvg"),goog.requireType("Blockly.blockRendering.Renderer"),goog.requireType("Blockly.Cursor"),goog.requireType("Blockly.FlyoutButton"),goog.requireType("Blockly.IBoundedElement"),goog.requireType("Blockly.IDragTarget"),goog.requireType("Blockly.IFlyout"),goog.requireType("Blockly.IMetricsManager"),goog.requireType("Blockly.IToolbox"),goog.requireType("Blockly.Marker"),goog.requireType("Blockly.ScrollbarPair"),goog.requireType("Blockly.Theme"),goog.requireType("Blockly.Trashcan"),goog.requireType("Blockly.VariableModel"),goog.requireType("Blockly.ZoomControls"),Blockly.WorkspaceSvg=function(e,o,t){Blockly.WorkspaceSvg.superClass_.constructor.call(this,e);var s=Blockly.registry.getClassFromOptions(Blockly.registry.Type.METRICS_MANAGER,e,!0);this.metricsManager_=new s(this),this.getMetrics=e.getMetrics||this.metricsManager_.getMetrics.bind(this.metricsManager_),this.setMetrics=e.setMetrics||Blockly.WorkspaceSvg.setTopLevelWorkspaceMetrics_,this.componentManager_=new Blockly.ComponentManager,this.connectionDBList=Blockly.ConnectionDB.init(this.connectionChecker),o&&(this.blockDragSurface_=o),t&&(this.workspaceDragSurface_=t),this.useWorkspaceDragSurface_=!!this.workspaceDragSurface_&&Blockly.utils.is3dSupported(),this.highlightedBlocks_=[],this.audioManager_=new Blockly.WorkspaceAudio(e.parentWorkspace),this.grid_=this.options.gridPattern?new Blockly.Grid(this.options.gridPattern,e.gridOptions):null,this.markerManager_=new Blockly.MarkerManager(this),this.toolboxCategoryCallbacks_=Object.create(null),this.flyoutButtonCallbacks_=Object.create(null),Blockly.Variables&&Blockly.Variables.flyoutCategory&&this.registerToolboxCategoryCallback(Blockly.VARIABLE_CATEGORY_NAME,Blockly.Variables.flyoutCategory),Blockly.VariablesDynamic&&Blockly.VariablesDynamic.flyoutCategory&&this.registerToolboxCategoryCallback(Blockly.VARIABLE_DYNAMIC_CATEGORY_NAME,Blockly.VariablesDynamic.flyoutCategory),e.newFunctions&&Blockly.Functions&&Blockly.Functions.flyoutCategory?this.registerToolboxCategoryCallback(Blockly.PROCEDURE_CATEGORY_NAME,Blockly.Functions.flyoutCategory):Blockly.Procedures&&Blockly.Procedures.flyoutCategory&&(this.registerToolboxCategoryCallback(Blockly.PROCEDURE_CATEGORY_NAME,Blockly.Procedures.flyoutCategory),this.addChangeListener(Blockly.Procedures.mutatorOpenListener)),this.themeManager_=this.options.parentWorkspace?this.options.parentWorkspace.getThemeManager():new Blockly.ThemeManager(this,this.options.theme||Blockly.Themes.Classic),this.themeManager_.subscribeWorkspace(this),this.renderer_=Blockly.blockRendering.init(this.options.renderer||"geras",this.getTheme(),this.options.rendererOverrides),this.cachedParentSvg_=null,this.keyboardAccessibilityMode=!1,this.topBoundedElements_=[],this.dragTargetAreas_=[],this.cachedParentSvgSize_=new Blockly.utils.Size(0,0)},Blockly.utils.object.inherits(Blockly.WorkspaceSvg,Blockly.Workspace),Blockly.WorkspaceSvg.prototype.resizeHandlerWrapper_=null,Blockly.WorkspaceSvg.prototype.rendered=!0,Blockly.WorkspaceSvg.prototype.isVisible_=!0,Blockly.WorkspaceSvg.prototype.isFlyout=!1,Blockly.WorkspaceSvg.prototype.isMutator=!1,Blockly.WorkspaceSvg.prototype.resizesEnabled_=!0,Blockly.WorkspaceSvg.prototype.scrollX=0,Blockly.WorkspaceSvg.prototype.scrollY=0,Blockly.WorkspaceSvg.prototype.startScrollX=0,Blockly.WorkspaceSvg.prototype.startScrollY=0,Blockly.WorkspaceSvg.prototype.dragDeltaXY_=null,Blockly.WorkspaceSvg.prototype.scale=1,Blockly.WorkspaceSvg.prototype.oldScale_=1,Blockly.WorkspaceSvg.prototype.oldTop_=0,Blockly.WorkspaceSvg.prototype.oldLeft_=0,Blockly.WorkspaceSvg.prototype.trashcan=null,Blockly.WorkspaceSvg.prototype.scrollbar=null,Blockly.WorkspaceSvg.prototype.flyout_=null,Blockly.WorkspaceSvg.prototype.toolbox_=null,Blockly.WorkspaceSvg.prototype.currentGesture_=null,Blockly.WorkspaceSvg.prototype.blockDragSurface_=null,Blockly.WorkspaceSvg.prototype.workspaceDragSurface_=null,Blockly.WorkspaceSvg.prototype.useWorkspaceDragSurface_=!1,Blockly.WorkspaceSvg.prototype.isDragSurfaceActive_=!1,Blockly.WorkspaceSvg.prototype.injectionDiv_=null,Blockly.WorkspaceSvg.prototype.lastRecordedPageScroll_=null,Blockly.WorkspaceSvg.prototype.configureContextMenu,Blockly.WorkspaceSvg.prototype.targetWorkspace=null,Blockly.WorkspaceSvg.prototype.inverseScreenCTM_=null,Blockly.WorkspaceSvg.prototype.inverseScreenCTMDirty_=!0,Blockly.WorkspaceSvg.prototype.getMarkerManager=function(){return this.markerManager_},Blockly.WorkspaceSvg.prototype.getMetricsManager=function(){return this.metricsManager_},Blockly.WorkspaceSvg.prototype.setMetricsManager=function(e){this.metricsManager_=e,this.getMetrics=this.metricsManager_.getMetrics.bind(this.metricsManager_)},Blockly.WorkspaceSvg.prototype.getComponentManager=function(){return this.componentManager_},Blockly.WorkspaceSvg.prototype.setCursorSvg=function(e){this.markerManager_.setCursorSvg(e)},Blockly.WorkspaceSvg.prototype.setMarkerSvg=function(e){this.markerManager_.setMarkerSvg(e)},Blockly.WorkspaceSvg.prototype.getMarker=function(e){return this.markerManager_?this.markerManager_.getMarker(e):null},Blockly.WorkspaceSvg.prototype.getCursor=function(){return this.markerManager_?this.markerManager_.getCursor():null},Blockly.WorkspaceSvg.prototype.getRenderer=function(){return this.renderer_},Blockly.WorkspaceSvg.prototype.getThemeManager=function(){return this.themeManager_},Blockly.WorkspaceSvg.prototype.getTheme=function(){return this.themeManager_.getTheme()},Blockly.WorkspaceSvg.prototype.setTheme=function(e){e||(e=Blockly.Themes.Classic),this.themeManager_.setTheme(e)},Blockly.WorkspaceSvg.prototype.refreshTheme=function(){this.svgGroup_&&this.renderer_.refreshDom(this.svgGroup_,this.getTheme()),this.updateBlockStyles_(this.getAllBlocks(!1).filter(function(e){return!!e.getStyleName()})),this.refreshToolboxSelection(),this.toolbox_&&this.toolbox_.refreshTheme(),this.isVisible()&&this.setVisible(!0);var e=new(Blockly.Events.get(Blockly.Events.THEME_CHANGE))(this.getTheme().name,this.id);Blockly.Events.fire(e)},Blockly.WorkspaceSvg.prototype.updateBlockStyles_=function(e){for(var o,t=0;o=e[t];t++){var s=o.getStyleName();s&&(o.setStyle(s),o.mutator&&o.mutator.updateBlockStyle())}},Blockly.WorkspaceSvg.prototype.getInverseScreenCTM=function(){if(this.inverseScreenCTMDirty_){var e=this.getParentSvg().getScreenCTM();e&&(this.inverseScreenCTM_=e.inverse(),this.inverseScreenCTMDirty_=!1)}return this.inverseScreenCTM_},Blockly.WorkspaceSvg.prototype.updateInverseScreenCTM=function(){this.inverseScreenCTMDirty_=!0},Blockly.WorkspaceSvg.prototype.isVisible=function(){return this.isVisible_},Blockly.WorkspaceSvg.prototype.getSvgXY=function(e){var o=0,t=0,s=1;(Blockly.utils.dom.containsNode(this.getCanvas(),e)||Blockly.utils.dom.containsNode(this.getBubbleCanvas(),e))&&(s=this.scale);do{var r=Blockly.utils.getRelativeXY(e);e!=this.getCanvas()&&e!=this.getBubbleCanvas()||(s=1),o+=r.x*s,t+=r.y*s,e=e.parentNode}while(e&&e!=this.getParentSvg());return new Blockly.utils.Coordinate(o,t)},Blockly.WorkspaceSvg.prototype.getCachedParentSvgSize=function(){var e=this.cachedParentSvgSize_;return new Blockly.utils.Size(e.width,e.height)},Blockly.WorkspaceSvg.prototype.getOriginOffsetInPixels=function(){return Blockly.utils.getInjectionDivXY_(this.getCanvas())},Blockly.WorkspaceSvg.prototype.getInjectionDiv=function(){if(!this.injectionDiv_)for(var e=this.svgGroup_;e;){if(-1!=(" "+(e.getAttribute("class")||"")+" ").indexOf(" injectionDiv ")){this.injectionDiv_=e;break}e=e.parentNode}return this.injectionDiv_},Blockly.WorkspaceSvg.prototype.getBlockCanvas=function(){return this.svgBlockCanvas_},Blockly.WorkspaceSvg.prototype.setResizeHandlerWrapper=function(e){this.resizeHandlerWrapper_=e},Blockly.WorkspaceSvg.prototype.createDom=function(e){if(this.svgGroup_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.G,{class:"blocklyWorkspace"},null),e&&(this.svgBackground_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.RECT,{height:"100%",width:"100%",class:e},this.svgGroup_),"blocklyMainBackground"==e&&this.grid_?this.svgBackground_.style.fill="url(#"+this.grid_.getPatternId()+")":this.themeManager_.subscribe(this.svgBackground_,"workspaceBackgroundColour","fill")),this.svgBlockCanvas_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.G,{class:"blocklyBlockCanvas"},this.svgGroup_),this.svgBubbleCanvas_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.G,{class:"blocklyBubbleCanvas"},this.svgGroup_),this.isFlyout||(Blockly.browserEvents.conditionalBind(this.svgGroup_,"mousedown",this,this.onMouseDown_,!1,!0),Blockly.browserEvents.conditionalBind(this.svgGroup_,"wheel",this,this.onMouseWheel_)),this.options.hasCategories){var o=Blockly.registry.getClassFromOptions(Blockly.registry.Type.TOOLBOX,this.options,!0);this.toolbox_=new o(this)}this.grid_&&this.grid_.update(this.scale),this.recordDragTargets();var t=Blockly.registry.getClassFromOptions(Blockly.registry.Type.CURSOR,this.options);return t&&this.markerManager_.setCursor(new t),this.renderer_.createDom(this.svgGroup_,this.getTheme()),this.svgGroup_},Blockly.WorkspaceSvg.prototype.dispose=function(){if(this.rendered=!1,this.currentGesture_&&this.currentGesture_.cancel(),this.svgGroup_&&(Blockly.utils.dom.removeNode(this.svgGroup_),this.svgGroup_=null),this.svgBlockCanvas_=null,this.svgBubbleCanvas_=null,this.toolbox_&&(this.toolbox_.dispose(),this.toolbox_=null),this.flyout_&&(this.flyout_.dispose(),this.flyout_=null),this.trashcan&&(this.trashcan.dispose(),this.trashcan=null),this.scrollbar&&(this.scrollbar.dispose(),this.scrollbar=null),this.zoomControls_&&(this.zoomControls_.dispose(),this.zoomControls_=null),this.audioManager_&&(this.audioManager_.dispose(),this.audioManager_=null),this.grid_&&(this.grid_.dispose(),this.grid_=null),this.renderer_.dispose(),this.markerManager_&&(this.markerManager_.dispose(),this.markerManager_=null),Blockly.WorkspaceSvg.superClass_.dispose.call(this),this.themeManager_&&(this.themeManager_.unsubscribeWorkspace(this),this.themeManager_.unsubscribe(this.svgBackground_),this.options.parentWorkspace||(this.themeManager_.dispose(),this.themeManager_=null)),this.connectionDBList=null,this.toolboxCategoryCallbacks_=null,this.flyoutButtonCallbacks_=null,!this.options.parentWorkspace){var e=this.getParentSvg();e&&e.parentNode&&Blockly.utils.dom.removeNode(e.parentNode)}this.resizeHandlerWrapper_&&(Blockly.browserEvents.unbind(this.resizeHandlerWrapper_),this.resizeHandlerWrapper_=null)},Blockly.WorkspaceSvg.prototype.newBlock=function(e,o){var t=new Blockly.BlockSvg(this,e,o);return this.loadingEventsDisabled||t.onLoadedIntoWorkspace(),t},Blockly.WorkspaceSvg.prototype.addTrashcan=function(){if(!Blockly.Trashcan)throw Error("Missing require for Blockly.Trashcan");this.trashcan=new Blockly.Trashcan(this);var e=this.trashcan.createDom();this.svgGroup_.insertBefore(e,this.svgBlockCanvas_)},Blockly.WorkspaceSvg.prototype.addZoomControls=function(){if(!Blockly.ZoomControls)throw Error("Missing require for Blockly.ZoomControls");this.zoomControls_=new Blockly.ZoomControls(this);var e=this.zoomControls_.createDom();this.svgGroup_.appendChild(e)},Blockly.WorkspaceSvg.prototype.addFlyout=function(e){var o=new Blockly.Options({parentWorkspace:this,rtl:this.RTL,oneBasedIndex:this.options.oneBasedIndex,horizontalLayout:this.horizontalLayout,renderer:this.options.renderer,rendererOverrides:this.options.rendererOverrides,move:{scrollbars:!0}});if(o.toolboxPosition=this.options.toolboxPosition,this.horizontalLayout){var t=Blockly.registry.getClassFromOptions(Blockly.registry.Type.FLYOUTS_HORIZONTAL_TOOLBOX,this.options,!0);this.flyout_=new t(o)}else{var s=Blockly.registry.getClassFromOptions(Blockly.registry.Type.FLYOUTS_VERTICAL_TOOLBOX,this.options,!0);this.flyout_=new s(o)}return this.flyout_.autoClose=!1,this.flyout_.getWorkspace().setVisible(!0),this.flyout_.createDom(e)},Blockly.WorkspaceSvg.prototype.getFlyout=function(e){return this.flyout_||e?this.flyout_:this.toolbox_?this.toolbox_.getFlyout():null},Blockly.WorkspaceSvg.prototype.getToolbox=function(){return this.toolbox_},Blockly.WorkspaceSvg.prototype.updateScreenCalculations_=function(){this.updateInverseScreenCTM(),this.recordDragTargets()},Blockly.WorkspaceSvg.prototype.resizeContents=function(){this.resizesEnabled_&&this.rendered&&(this.scrollbar&&this.scrollbar.resize(),this.updateInverseScreenCTM())},Blockly.WorkspaceSvg.prototype.resize=function(){this.toolbox_&&this.toolbox_.position(),this.flyout_&&this.flyout_.position();for(var e,o=this.componentManager_.getComponents(Blockly.ComponentManager.Capability.POSITIONABLE,!0),t=this.getMetricsManager().getUiMetrics(),s=[],r=0;e=o[r];r++){e.position(t,s);var l=e.getBoundingRectangle();l&&s.push(l)}this.scrollbar&&this.scrollbar.resize(),this.updateScreenCalculations_()},Blockly.WorkspaceSvg.prototype.updateScreenCalculationsIfScrolled=function(){var e=Blockly.utils.getDocumentScroll();Blockly.utils.Coordinate.equals(this.lastRecordedPageScroll_,e)||(this.lastRecordedPageScroll_=e,this.updateScreenCalculations_())},Blockly.WorkspaceSvg.prototype.getCanvas=function(){return this.svgBlockCanvas_},Blockly.WorkspaceSvg.prototype.setCachedParentSvgSize=function(e,o){var t=this.getParentSvg();isNaN(e)||null===e||(this.cachedParentSvgSize_.width=e,t.cachedWidth_=e),isNaN(o)||null===o||(this.cachedParentSvgSize_.height=o,t.cachedHeight_=o)},Blockly.WorkspaceSvg.prototype.getBubbleCanvas=function(){return this.svgBubbleCanvas_},Blockly.WorkspaceSvg.prototype.getParentSvg=function(){if(!this.cachedParentSvg_)for(var e=this.svgGroup_;e;){if("svg"==e.tagName){this.cachedParentSvg_=e;break}e=e.parentNode}return this.cachedParentSvg_},Blockly.WorkspaceSvg.prototype.maybeFireViewportChangeEvent=function(){if(Blockly.Events.isEnabled()){var e=this.scale,o=-this.scrollY,t=-this.scrollX;if(!(e==this.oldScale_&&Math.abs(o-this.oldTop_)<1&&Math.abs(t-this.oldLeft_)<1)){var s=new(Blockly.Events.get(Blockly.Events.VIEWPORT_CHANGE))(o,t,e,this.id,this.oldScale_);this.oldScale_=e,this.oldTop_=o,this.oldLeft_=t,Blockly.Events.fire(s)}}},Blockly.WorkspaceSvg.prototype.translate=function(e,o){if(this.useWorkspaceDragSurface_&&this.isDragSurfaceActive_)this.workspaceDragSurface_.translateSurface(e,o);else{var t="translate("+e+","+o+") scale("+this.scale+")";this.svgBlockCanvas_.setAttribute("transform",t),this.svgBubbleCanvas_.setAttribute("transform",t)}this.blockDragSurface_&&this.blockDragSurface_.translateAndScaleGroup(e,o,this.scale),this.grid_&&this.grid_.moveTo(e,o),this.maybeFireViewportChangeEvent()},Blockly.WorkspaceSvg.prototype.resetDragSurface=function(){if(this.useWorkspaceDragSurface_){this.isDragSurfaceActive_=!1;var e=this.workspaceDragSurface_.getSurfaceTranslation();this.workspaceDragSurface_.clearAndHide(this.svgGroup_);var o="translate("+e.x+","+e.y+") scale("+this.scale+")";this.svgBlockCanvas_.setAttribute("transform",o),this.svgBubbleCanvas_.setAttribute("transform",o)}},Blockly.WorkspaceSvg.prototype.setupDragSurface=function(){if(this.useWorkspaceDragSurface_&&!this.isDragSurfaceActive_){this.isDragSurfaceActive_=!0;var e=this.svgBlockCanvas_.previousSibling,o=parseInt(this.getParentSvg().getAttribute("width"),10),t=parseInt(this.getParentSvg().getAttribute("height"),10),s=Blockly.utils.getRelativeXY(this.getCanvas());this.workspaceDragSurface_.setContentsAndShow(this.getCanvas(),this.getBubbleCanvas(),e,o,t,this.scale),this.workspaceDragSurface_.translateSurface(s.x,s.y)}},Blockly.WorkspaceSvg.prototype.getBlockDragSurface=function(){return this.blockDragSurface_},Blockly.WorkspaceSvg.prototype.getWidth=function(){var e=this.getMetrics();return e?e.viewWidth/this.scale:0},Blockly.WorkspaceSvg.prototype.setVisible=function(e){if(this.isVisible_=e,this.svgGroup_)if(this.scrollbar&&this.scrollbar.setContainerVisible(e),this.getFlyout()&&this.getFlyout().setContainerVisible(e),this.getParentSvg().style.display=e?"block":"none",this.toolbox_&&this.toolbox_.setVisible(e),e){for(var o=this.getAllBlocks(!1),t=o.length-1;t>=0;t--)o[t].markDirty();this.render(),this.resize()}else Blockly.hideChaff(!0),Blockly.DropDownDiv.hideWithoutAnimation()},Blockly.WorkspaceSvg.prototype.render=function(){for(var e=this.getAllBlocks(!1),o=e.length-1;o>=0;o--)e[o].render(!1);if(this.currentGesture_){var t=this.currentGesture_.getInsertionMarkers();for(o=0;o<t.length;o++)t[o].render(!1)}this.markerManager_.updateMarkers()},Blockly.WorkspaceSvg.prototype.highlightBlock=function(e,o){if(void 0===o){for(var t=0;s=this.highlightedBlocks_[t];t++)s.setHighlighted(!1);this.highlightedBlocks_.length=0}var s;if(s=e?this.getBlockById(e):null){var r=void 0===o||o;r?-1==this.highlightedBlocks_.indexOf(s)&&this.highlightedBlocks_.push(s):Blockly.utils.arrayRemove(this.highlightedBlocks_,s),s.setHighlighted(r)}},Blockly.WorkspaceSvg.prototype.paste=function(e){!this.rendered||!e.tagName||e.getElementsByTagName("block").length>=this.remainingCapacity()||(this.currentGesture_&&this.currentGesture_.cancel(),"comment"==e.tagName.toLowerCase()?this.pasteWorkspaceComment_(e):this.pasteBlock_(e))},Blockly.WorkspaceSvg.prototype.pasteBlock_=function(e){Blockly.Events.disable();try{var o=Blockly.Xml.domToBlock(e,this),t=parseInt(e.getAttribute("x"),10),s=parseInt(e.getAttribute("y"),10);if(!isNaN(t)&&!isNaN(s)){this.RTL&&(t=-t);do{for(var r,l=!1,i=this.getAllBlocks(!1),a=0;r=i[a];a++){var c=r.getRelativeToSurfaceXY();if(Math.abs(t-c.x)<=1&&Math.abs(s-c.y)<=1){l=!0;break}}if(!l){var n,g=o.getConnections_(!1);for(a=0;n=g[a];a++){if(n.closest(Blockly.SNAP_RADIUS,new Blockly.utils.Coordinate(t,s)).connection){l=!0;break}}}l&&(this.RTL?t-=Blockly.SNAP_RADIUS:t+=Blockly.SNAP_RADIUS,s+=2*Blockly.SNAP_RADIUS)}while(l);o.moveBy(t,s)}}finally{Blockly.Events.enable()}Blockly.Events.isEnabled()&&!o.isShadow()&&Blockly.Events.fire(new(Blockly.Events.get(Blockly.Events.BLOCK_CREATE))(o)),o.select()},Blockly.WorkspaceSvg.prototype.pasteWorkspaceComment_=function(e){Blockly.Events.disable();try{var o=Blockly.WorkspaceCommentSvg.fromXml(e,this),t=parseInt(e.getAttribute("x"),10),s=parseInt(e.getAttribute("y"),10);isNaN(t)||isNaN(s)||(this.RTL&&(t=-t),t+=50,s+=50,o.moveBy(t,s))}finally{Blockly.Events.enable()}Blockly.Events.isEnabled()&&Blockly.WorkspaceComment.fireCreateEvent(o),o.select()},Blockly.WorkspaceSvg.prototype.refreshToolboxSelection=function(){var e=this.isFlyout?this.targetWorkspace:this;e&&!e.currentGesture_&&e.toolbox_&&e.toolbox_.getFlyout()&&e.toolbox_.refreshSelection()},Blockly.WorkspaceSvg.prototype.renameVariableById=function(e,o){Blockly.WorkspaceSvg.superClass_.renameVariableById.call(this,e,o),this.refreshToolboxSelection()},Blockly.WorkspaceSvg.prototype.deleteVariableById=function(e){Blockly.WorkspaceSvg.superClass_.deleteVariableById.call(this,e),this.refreshToolboxSelection()},Blockly.WorkspaceSvg.prototype.createVariable=function(e,o,t){var s=Blockly.WorkspaceSvg.superClass_.createVariable.call(this,e,o,t);return this.refreshToolboxSelection(),s},Blockly.WorkspaceSvg.prototype.recordDeleteAreas=function(){Blockly.utils.deprecation.warn("WorkspaceSvg.prototype.recordDeleteAreas","June 2021","June 2022","WorkspaceSvg.prototype.recordDragTargets"),this.recordDragTargets()},Blockly.WorkspaceSvg.prototype.recordDragTargets=function(){var e=this.componentManager_.getComponents(Blockly.ComponentManager.Capability.DRAG_TARGET,!0);this.dragTargetAreas_=[];for(var o,t=0;o=e[t];t++){var s=o.getClientRect();s&&this.dragTargetAreas_.push({component:o,clientRect:s})}},Blockly.WorkspaceSvg.prototype.getDragTarget=function(e){for(var o,t=0;o=this.dragTargetAreas_[t];t++)if(o.clientRect.contains(e.clientX,e.clientY))return o.component;return null},Blockly.WorkspaceSvg.prototype.onMouseDown_=function(e){var o=this.getGesture(e);o&&o.handleWsStart(e,this)},Blockly.WorkspaceSvg.prototype.startDrag=function(e,o){var t=Blockly.utils.mouseToSvg(e,this.getParentSvg(),this.getInverseScreenCTM());t.x/=this.scale,t.y/=this.scale,this.dragDeltaXY_=Blockly.utils.Coordinate.difference(o,t)},Blockly.WorkspaceSvg.prototype.moveDrag=function(e){var o=Blockly.utils.mouseToSvg(e,this.getParentSvg(),this.getInverseScreenCTM());return o.x/=this.scale,o.y/=this.scale,Blockly.utils.Coordinate.sum(this.dragDeltaXY_,o)},Blockly.WorkspaceSvg.prototype.isDragging=function(){return null!=this.currentGesture_&&this.currentGesture_.isDragging()},Blockly.WorkspaceSvg.prototype.isDraggable=function(){return this.options.moveOptions&&this.options.moveOptions.drag},Blockly.WorkspaceSvg.prototype.isMovable=function(){return this.options.moveOptions&&!!this.options.moveOptions.scrollbars||this.options.moveOptions&&this.options.moveOptions.wheel||this.options.moveOptions&&this.options.moveOptions.drag||this.options.zoomOptions&&this.options.zoomOptions.wheel||this.options.zoomOptions&&this.options.zoomOptions.pinch},Blockly.WorkspaceSvg.prototype.isMovableHorizontally=function(){var e=!!this.scrollbar;return this.isMovable()&&(!e||e&&this.scrollbar.canScrollHorizontally())},Blockly.WorkspaceSvg.prototype.isMovableVertically=function(){var e=!!this.scrollbar;return this.isMovable()&&(!e||e&&this.scrollbar.canScrollVertically())},Blockly.WorkspaceSvg.prototype.onMouseWheel_=function(e){if(Blockly.Gesture.inProgress())return e.preventDefault(),void e.stopPropagation();var o=this.options.zoomOptions&&this.options.zoomOptions.wheel,t=this.options.moveOptions&&this.options.moveOptions.wheel;if(o||t){var s=Blockly.utils.getScrollDeltaPixels(e);if(!o||!e.ctrlKey&&t){var r=this.scrollX-s.x,l=this.scrollY-s.y;e.shiftKey&&!s.x&&(r=this.scrollX-s.y,l=this.scrollY),this.scroll(r,l)}else{var i=50,a=-s.y/i,c=Blockly.utils.mouseToSvg(e,this.getParentSvg(),this.getInverseScreenCTM());this.zoom(c.x,c.y,a)}if(e.ctrlKey||e.metaKey){i=50,a=-e.deltaY/i,c=Blockly.utils.mouseToSvg(e,this.getParentSvg(),this.getInverseScreenCTM());this.zoom(c.x,c.y,a)}else{Blockly.WidgetDiv.hide(!0),Blockly.DropDownDiv.hideWithoutAnimation();r=this.scrollX-e.deltaX,l=this.scrollY-e.deltaY;this.startDragMetrics=this.getMetrics(),this.scroll(r,l)}e.preventDefault()}},Blockly.WorkspaceSvg.prototype.getBlocksBoundingBox=function(){var e=this.getTopBoundedElements();if(!e.length)return new Blockly.utils.Rect(0,0,0,0);for(var o=e[0].getBoundingRectangle(),t=1;t<e.length;t++){var s=e[t];if(!s.isInsertionMarker||!s.isInsertionMarker()){var r=s.getBoundingRectangle();r.top<o.top&&(o.top=r.top),r.bottom>o.bottom&&(o.bottom=r.bottom),r.left<o.left&&(o.left=r.left),r.right>o.right&&(o.right=r.right)}}return o},Blockly.WorkspaceSvg.prototype.cleanUp=function(){this.setResizesEnabled(!1),Blockly.Events.setGroup(!0);for(var e,o=this.getTopBlocks(!0),t=0,s=0;e=o[s];s++)if(e.isMovable()){var r=e.getRelativeToSurfaceXY();e.moveBy(-r.x,t-r.y),e.snapToGrid(),t=e.getRelativeToSurfaceXY().y+e.getHeightWidth().height+this.renderer_.getConstants().MIN_BLOCK_HEIGHT}Blockly.Events.setGroup(!1),this.setResizesEnabled(!0)},Blockly.WorkspaceSvg.prototype.showContextMenu=function(e){if(!this.options.readOnly&&!this.isFlyout){var o=Blockly.ContextMenuRegistry.registry.getContextMenuOptions(Blockly.ContextMenuRegistry.ScopeType.WORKSPACE,{workspace:this});this.configureContextMenu&&this.configureContextMenu(o,e),Blockly.ContextMenu.show(e,o,this.RTL)}},Blockly.WorkspaceSvg.buildDeleteList_=function(e){var o=[];function t(e){if(e.isDeletable())o=o.concat(e.getDescendants());else for(var s=e.getChildren(),r=0;r<s.length;r++)t(s[r])}for(var s=0;s<e.length;s++)t(e[s]);return o},Blockly.WorkspaceSvg.prototype.updateToolbox=function(e){var o=Blockly.utils.toolbox.convertToolboxDefToJson(e);if(o){if(!this.options.languageTree)throw Error("Existing toolbox is null.  Can't create new toolbox.");if(Blockly.utils.toolbox.hasCategories(o)){if(!this.toolbox_)throw Error("Existing toolbox has no categories.  Can't change mode.");this.options.languageTree=o,this.toolbox_.render(o)}else{if(!this.flyout_)throw Error("Existing toolbox has categories.  Can't change mode.");this.options.languageTree=o,this.flyout_.show(o)}}else if(this.options.languageTree)throw Error("Can't nullify an existing toolbox.")},Blockly.WorkspaceSvg.prototype.markFocused=function(){this.options.parentWorkspace?this.options.parentWorkspace.markFocused():(Blockly.mainWorkspace=this,this.setBrowserFocus())},Blockly.WorkspaceSvg.prototype.setBrowserFocus=function(){document.activeElement&&document.activeElement.blur&&document.activeElement.blur();try{this.getParentSvg().focus({preventScroll:!0})}catch(e){try{this.getParentSvg().parentNode.setActive()}catch(e){this.getParentSvg().parentNode.focus({preventScroll:!0})}}},Blockly.WorkspaceSvg.prototype.zoom=function(e,o,t){var s=this.options.zoomOptions.scaleSpeed,r=Math.pow(s,t),l=this.scale*r;if(this.scale!=l){l>this.options.zoomOptions.maxScale?r=this.options.zoomOptions.maxScale/this.scale:l<this.options.zoomOptions.minScale&&(r=this.options.zoomOptions.minScale/this.scale);var i=this.getCanvas().getCTM(),a=this.getParentSvg().createSVGPoint();a.x=e,a.y=o,e=(a=a.matrixTransform(i.inverse())).x,o=a.y,i=i.translate(e*(1-r),o*(1-r)).scale(r),this.scrollX=i.e,this.scrollY=i.f,this.setScale(l),Blockly.WidgetDiv.hide(!0),Blockly.DropDownDiv.hideWithoutAnimation()}},Blockly.WorkspaceSvg.prototype.zoomCenter=function(e){var o=this.getMetrics();if(this.flyout_)var t=o.svgWidth?o.svgWidth/2:0,s=o.svgHeight?o.svgHeight/2:0;else t=o.viewWidth/2+o.absoluteLeft,s=o.viewHeight/2+o.absoluteTop;this.zoom(t,s,e)},Blockly.WorkspaceSvg.prototype.zoomToFit=function(){if(this.isMovable()){var e=this.getMetrics(),o=e.viewWidth,t=e.viewHeight,s=this.getBlocksBoundingBox(),r=s.right-s.left,l=s.bottom-s.top;if(r){this.flyout_&&(this.horizontalLayout?(t+=this.flyout_.getHeight(),l+=this.flyout_.getHeight()/this.scale):(o+=this.flyout_.getWidth(),r+=this.flyout_.getWidth()/this.scale));var i=o/r,a=t/l;Blockly.Events.disable();try{this.setScale(Math.min(i,a)),this.scrollCenter()}finally{Blockly.Events.enable()}this.maybeFireViewportChangeEvent()}}else console.warn("Tried to move a non-movable workspace. This could result in blocks becoming inaccessible.")},Blockly.WorkspaceSvg.prototype.beginCanvasTransition=function(){Blockly.utils.dom.addClass(this.svgBlockCanvas_,"blocklyCanvasTransitioning"),Blockly.utils.dom.addClass(this.svgBubbleCanvas_,"blocklyCanvasTransitioning")},Blockly.WorkspaceSvg.prototype.endCanvasTransition=function(){Blockly.utils.dom.removeClass(this.svgBlockCanvas_,"blocklyCanvasTransitioning"),Blockly.utils.dom.removeClass(this.svgBubbleCanvas_,"blocklyCanvasTransitioning")},Blockly.WorkspaceSvg.prototype.scrollCenter=function(){if(this.isMovable()){var e=this.getMetrics(),o=(e.scrollWidth-e.viewWidth)/2,t=(e.scrollHeight-e.viewHeight)/2;o=-o-e.scrollLeft,t=-t-e.scrollTop,this.scroll(o,t)}else console.warn("Tried to move a non-movable workspace. This could result in blocks becoming inaccessible.")},Blockly.WorkspaceSvg.prototype.centerOnBlock=function(e,o){if(this.isMovable()){var t=e?this.getBlockById(e):null;if(t){o&&Blockly.utils.dom.addClass(this.svgBlockCanvas_,"blocklyTransitioning");var s=t.getRelativeToSurfaceXY(),r=t.height,l=t.width,i=s.y+r/2,a=this.RTL?-1:1,c=s.x+a*l/2,n=this.scale,g=c*n,p=i*n,h=this.getMetrics(),u=-(g-h.viewWidth/2),y=-(p-h.viewHeight/2);this.scroll(u,y);var k=this.svgBlockCanvas_;setTimeout(function(){Blockly.utils.dom.removeClass(k,"blocklyTransitioning")},Blockly.Colours.canvasTransitionLength)}}else console.warn("Tried to move a non-movable workspace. This could result in blocks becoming inaccessible.")},Blockly.WorkspaceSvg.prototype.setScale=function(e){this.options.zoomOptions.maxScale&&e>this.options.zoomOptions.maxScale?e=this.options.zoomOptions.maxScale:this.options.zoomOptions.minScale&&e<this.options.zoomOptions.minScale&&(e=this.options.zoomOptions.minScale),this.scale=e,Blockly.hideChaff(!1),this.flyout_&&(this.flyout_.reflow(),this.recordDragTargets()),this.grid_&&this.grid_.update(this.scale);var o=this.getMetrics();this.scrollX-=o.absoluteLeft,this.scrollY-=o.absoluteTop,o.viewLeft+=o.absoluteLeft,o.viewTop+=o.absoluteTop,this.scroll(this.scrollX,this.scrollY),this.scrollbar&&(this.flyout_?this.scrollbar.resizeView(o):this.scrollbar.resizeContent(o))},Blockly.WorkspaceSvg.prototype.getScale=function(){return this.options.parentWorkspace?this.options.parentWorkspace.getScale():this.scale},Blockly.WorkspaceSvg.prototype.scroll=function(e,o){Blockly.hideChaff(!0);var t=this.getMetrics();e=Math.min(e,-t.scrollLeft),o=Math.min(o,-t.scrollTop);var s=Math.max(0,t.scrollWidth-t.viewWidth),r=t.scrollLeft+s,l=Math.max(0,t.scrollHeight-t.viewHeight),i=t.scrollTop+l;e=Math.max(e,-r),o=Math.max(o,-i),this.scrollX=e,this.scrollY=o,this.scrollbar&&this.scrollbar.set(-(e+t.scrollLeft),-(o+t.scrollTop),!1),e+=t.absoluteLeft,o+=t.absoluteTop,Blockly.WidgetDiv.hide(!0),Blockly.DropDownDiv.hideWithoutAnimation(),this.translate(e,o)},Blockly.WorkspaceSvg.setTopLevelWorkspaceMetrics_=function(e){var o=this.getMetrics();"number"==typeof e.x&&(this.scrollX=-(o.scrollLeft+(o.scrollWidth-o.viewWidth)*e.x)),"number"==typeof e.y&&(this.scrollY=-(o.scrollTop+(o.scrollHeight-o.viewHeight)*e.y));var t=this.scrollX+o.absoluteLeft,s=this.scrollY+o.absoluteTop;this.translate(t,s)},Blockly.WorkspaceSvg.prototype.getBlockById=function(e){return Blockly.WorkspaceSvg.superClass_.getBlockById.call(this,e)},Blockly.WorkspaceSvg.prototype.getTopBlocks=function(e){return Blockly.WorkspaceSvg.superClass_.getTopBlocks.call(this,e)},Blockly.WorkspaceSvg.prototype.addTopBlock=function(e){this.addTopBoundedElement(e),Blockly.WorkspaceSvg.superClass_.addTopBlock.call(this,e)},Blockly.WorkspaceSvg.prototype.removeTopBlock=function(e){this.removeTopBoundedElement(e),Blockly.WorkspaceSvg.superClass_.removeTopBlock.call(this,e)},Blockly.WorkspaceSvg.prototype.addTopComment=function(e){this.addTopBoundedElement(e),Blockly.WorkspaceSvg.superClass_.addTopComment.call(this,e)},Blockly.WorkspaceSvg.prototype.removeTopComment=function(e){this.removeTopBoundedElement(e),Blockly.WorkspaceSvg.superClass_.removeTopComment.call(this,e)},Blockly.WorkspaceSvg.prototype.addTopBoundedElement=function(e){this.topBoundedElements_.push(e)},Blockly.WorkspaceSvg.prototype.removeTopBoundedElement=function(e){Blockly.utils.arrayRemove(this.topBoundedElements_,e)},Blockly.WorkspaceSvg.prototype.getTopBoundedElements=function(){return[].concat(this.topBoundedElements_)},Blockly.WorkspaceSvg.prototype.setResizesEnabled=function(e){var o=!this.resizesEnabled_&&e;this.resizesEnabled_=e,o&&this.resizeContents()},Blockly.WorkspaceSvg.prototype.clear=function(){this.setResizesEnabled(!1),Blockly.WorkspaceSvg.superClass_.clear.call(this),this.topBoundedElements_=[],this.setResizesEnabled(!0)},Blockly.WorkspaceSvg.prototype.registerButtonCallback=function(e,o){if("function"!=typeof o)throw TypeError("Button callbacks must be functions.");this.flyoutButtonCallbacks_[e]=o},Blockly.WorkspaceSvg.prototype.getButtonCallback=function(e){var o=this.flyoutButtonCallbacks_[e];return o||null},Blockly.WorkspaceSvg.prototype.removeButtonCallback=function(e){this.flyoutButtonCallbacks_[e]=null},Blockly.WorkspaceSvg.prototype.registerToolboxCategoryCallback=function(e,o){if("function"!=typeof o)throw TypeError("Toolbox category callbacks must be functions.");this.toolboxCategoryCallbacks_[e]=o},Blockly.WorkspaceSvg.prototype.getToolboxCategoryCallback=function(e){return this.toolboxCategoryCallbacks_[e]||null},Blockly.WorkspaceSvg.prototype.removeToolboxCategoryCallback=function(e){this.toolboxCategoryCallbacks_[e]=null},Blockly.WorkspaceSvg.prototype.getGesture=function(e){var o="mousedown"==e.type||"touchstart"==e.type||"pointerdown"==e.type,t=this.currentGesture_;return t?o&&t.hasStarted()?(console.warn("Tried to start the same gesture twice."),t.cancel(),null):t:o?(this.currentGesture_=new Blockly.TouchGesture(e,this),this.currentGesture_):null},Blockly.WorkspaceSvg.prototype.clearGesture=function(){this.currentGesture_=null},Blockly.WorkspaceSvg.prototype.cancelCurrentGesture=function(){this.currentGesture_&&this.currentGesture_.cancel()},Blockly.WorkspaceSvg.prototype.getAudioManager=function(){return this.audioManager_},Blockly.WorkspaceSvg.prototype.getGrid=function(){return this.grid_};