/**
 * @license
 * Copyright 2012 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.utils"),goog.require("Blockly.constants"),goog.require("Blockly.Msg"),goog.require("Blockly.utils.colour"),goog.require("Blockly.utils.Coordinate"),goog.require("Blockly.utils.global"),goog.require("Blockly.utils.Rect"),goog.require("Blockly.utils.string"),goog.require("Blockly.utils.style"),goog.require("Blockly.utils.userAgent"),goog.requireType("Blockly.Block"),goog.requireType("Blockly.WorkspaceSvg"),Blockly.utils.noEvent=function(e){e.preventDefault(),e.stopPropagation()},Blockly.utils.isTargetInput=function(e){return"textarea"==e.target.type||"text"==e.target.type||"number"==e.target.type||"email"==e.target.type||"password"==e.target.type||"search"==e.target.type||"tel"==e.target.type||"url"==e.target.type||e.target.isContentEditable||e.target.dataset&&"true"==e.target.dataset.isTextInput},Blockly.utils.getRelativeXY=function(e){var t=new Blockly.utils.Coordinate(0,0),l=e.getAttribute("x");l&&(t.x=parseInt(l,10));var o=e.getAttribute("y");o&&(t.y=parseInt(o,10));var r=e.getAttribute("transform"),i=r&&r.match(Blockly.utils.getRelativeXY.XY_REGEX_);i&&(t.x+=Number(i[1]),i[3]&&(t.y+=Number(i[3])));var n=e.getAttribute("style");if(n&&n.indexOf("translate")>-1){var s=n.match(Blockly.utils.getRelativeXY.XY_STYLE_REGEX_);s&&(t.x+=Number(s[1]),s[3]&&(t.y+=Number(s[3])))}return t},Blockly.utils.getInjectionDivXY_=function(e){for(var t=0,l=0;e;){var o=Blockly.utils.getRelativeXY(e);if(t+=o.x,l+=o.y,-1!=(" "+(e.getAttribute("class")||"")+" ").indexOf(" injectionDiv "))break;e=e.parentNode}return new Blockly.utils.Coordinate(t,l)},Blockly.utils.getRelativeXY.XY_REGEX_=/translate\(\s*([-+\d.e]+)([ ,]\s*([-+\d.e]+)\s*)?/,Blockly.utils.getRelativeXY.XY_STYLE_REGEX_=/transform:\s*translate(?:3d)?\(\s*([-+\d.e]+)\s*px([ ,]\s*([-+\d.e]+)\s*px)?/,Blockly.utils.isRightButton=function(e){return!(!e.ctrlKey||!Blockly.utils.userAgent.MAC)||2==e.button},Blockly.utils.mouseToSvg=function(e,t,l){var o=t.createSVGPoint();return o.x=e.clientX,o.y=e.clientY,l||(l=t.getScreenCTM().inverse()),o.matrixTransform(l)},Blockly.utils.getScrollDeltaPixels=function(e){switch(e.deltaMode){case 0:default:return{x:e.deltaX,y:e.deltaY};case 1:return{x:e.deltaX*Blockly.LINE_MODE_MULTIPLIER,y:e.deltaY*Blockly.LINE_MODE_MULTIPLIER};case 2:return{x:e.deltaX*Blockly.PAGE_MODE_MULTIPLIER,y:e.deltaY*Blockly.PAGE_MODE_MULTIPLIER}}},Blockly.utils.tokenizeInterpolation=function(e){return Blockly.utils.tokenizeInterpolation_(e,!0)},Blockly.utils.replaceMessageReferences=function(e){if("string"!=typeof e)return e;var t=Blockly.utils.tokenizeInterpolation_(e,!1);return t.length?String(t[0]):""},Blockly.utils.checkMessageReferences=function(e){for(var t=!0,l=Blockly.Msg,o=e.match(/%{BKY_[A-Z]\w*}/gi),r=0;r<o.length;r++){null==l[o[r].toUpperCase().slice(6,-1)]&&(t=!1)}return t},Blockly.utils.tokenizeInterpolation_=function(e,t){var l=[],o=e.split("");o.push("");for(var r=0,i=[],n=null,s=0;s<o.length;s++){var u=o[s];if(0==r)if("%"==u)(c=i.join(""))&&l.push(c),i.length=0,r=1;else i.push(u);else if(1==r)if("%"==u)i.push(u),r=0;else if(t&&"0"<=u&&u<="9"){var c;r=2,n=u,(c=i.join(""))&&l.push(c),i.length=0}else"{"==u?r=3:(i.push("%",u),r=0);else if(2==r)"0"<=u&&u<="9"?n+=u:(l.push(parseInt(n,10)),s--,r=0);else if(3==r)if(""==u)i.splice(0,0,"%{"),s--,r=0;else if("}"!=u)i.push(u);else{var a=i.join("");if(/[A-Z]\w*/i.test(a)){var y=a.toUpperCase(),g=Blockly.utils.string.startsWith(y,"BKY_")?y.substring(4):null;if(g&&g in Blockly.Msg){var d=Blockly.Msg[g];"string"==typeof d?Array.prototype.push.apply(l,Blockly.utils.tokenizeInterpolation_(d,t)):t?l.push(String(d)):l.push(d)}else l.push("%{"+a+"}");i.length=0,r=0}else l.push("%{"+a+"}"),i.length=0,r=0}}(c=i.join(""))&&l.push(c);var p=[];i.length=0;for(s=0;s<l.length;++s)"string"==typeof l[s]?i.push(l[s]):((c=i.join(""))&&p.push(c),i.length=0,p.push(l[s]));return(c=i.join(""))&&p.push(c),i.length=0,p},Blockly.utils.genUid=function(){for(var e=Blockly.utils.genUid.soup_.length,t=[],l=0;l<20;l++)t[l]=Blockly.utils.genUid.soup_.charAt(Math.random()*e);return t.join("")},Blockly.utils.genUid.soup_="!#$%()*+,-./:;=?@[]^_`{|}~ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",Blockly.utils.is3dSupported=function(){if(void 0!==Blockly.utils.is3dSupported.cached_)return Blockly.utils.is3dSupported.cached_;if(!Blockly.utils.global.getComputedStyle)return!1;var e=document.createElement("p"),t="none",l={webkitTransform:"-webkit-transform",OTransform:"-o-transform",msTransform:"-ms-transform",MozTransform:"-moz-transform",transform:"transform"};for(var o in document.body.insertBefore(e,null),l)if(void 0!==e.style[o]){e.style[o]="translate3d(1px,1px,1px)";var r=Blockly.utils.global.getComputedStyle(e);if(!r)return document.body.removeChild(e),!1;t=r.getPropertyValue(l[o])}return document.body.removeChild(e),Blockly.utils.is3dSupported.cached_="none"!==t,Blockly.utils.is3dSupported.cached_},Blockly.utils.runAfterPageLoad=function(e){if("object"!=typeof document)throw Error("Blockly.utils.runAfterPageLoad() requires browser document.");if("complete"==document.readyState)e();else var t=setInterval(function(){"complete"==document.readyState&&(clearInterval(t),e())},10)},Blockly.utils.getViewportBBox=function(){var e=Blockly.utils.style.getViewportPageOffset();return new Blockly.utils.Rect(e.y,document.documentElement.clientHeight+e.y,e.x,document.documentElement.clientWidth+e.x)},Blockly.utils.arrayRemove=function(e,t){var l=e.indexOf(t);return-1!=l&&(e.splice(l,1),!0)},Blockly.utils.getDocumentScroll=function(){var e=document.documentElement,t=window;return Blockly.utils.userAgent.IE&&t.pageYOffset!=e.scrollTop?new Blockly.utils.Coordinate(e.scrollLeft,e.scrollTop):new Blockly.utils.Coordinate(t.pageXOffset||e.scrollLeft,t.pageYOffset||e.scrollTop)},Blockly.utils.getBlockTypeCounts=function(e,t){var l=Object.create(null),o=e.getDescendants(!0);if(t){var r=e.getNextBlock();if(r){var i=o.indexOf(r);o.splice(i,o.length-i)}}for(var n,s=0;n=o[s];s++)l[n.type]?l[n.type]++:l[n.type]=1;return l};var resizeFromKeyboard=!0,initialWidth=0,lastHeight=0,debounceTimeout=null;Blockly.utils.resizeTracker=function(e){debounceTimeout&&clearTimeout(debounceTimeout),debounceTimeout=setTimeout(function(){var t=e.getInjectionDiv();resizeFromKeyboard=!0,t&&(initialWidth=t.clientWidth,lastHeight=t.clientHeight)},1e3);var t=e.getInjectionDiv();if(t&&(0==initialWidth&&(resizeFromKeyboard=!0,initialWidth=t.clientWidth,lastHeight=t.clientHeight),resizeFromKeyboard)){var l=t.clientWidth,o=t.clientHeight;l!=initialWidth&&(resizeFromKeyboard=!1),o>lastHeight?resizeFromKeyboard=!1:lastHeight=o}},Blockly.utils.isOnScreenKeyboardResize=function(){return!(!Blockly.utils.dom.hasClass(document.activeElement,"blocklyHtmlInput")||!resizeFromKeyboard)},Blockly.utils.screenToWsCoordinates=function(e,t){var l=t.x,o=t.y,r=e.getInjectionDiv().getBoundingClientRect(),i=new Blockly.utils.Coordinate(l-r.left,o-r.top),n=e.getOriginOffsetInPixels();return Blockly.utils.Coordinate.difference(i,n).scale(1/e.scale)},Blockly.utils.parseBlockColour=function(e){var t="string"==typeof e?Blockly.utils.replaceMessageReferences(e):e,l=Number(t);if(!isNaN(l)&&0<=l&&l<=360)return{hue:l,hex:Blockly.utils.colour.hsvToHex(l,Blockly.HSV_SATURATION,255*Blockly.HSV_VALUE)};var o=Blockly.utils.colour.parse(t);if(o)return{hue:null,hex:o};var r='Invalid colour: "'+t+'"';throw e!=t&&(r+=' (from "'+e+'")'),Error(r)};