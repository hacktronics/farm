/**
 * @license
 * Copyright 2011 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.Connection"),goog.require("Blockly.connectionTypes"),goog.require("Blockly.constants"),goog.require("Blockly.Events"),goog.require("Blockly.Events.BlockMove"),goog.require("Blockly.IASTNodeLocationWithBlock"),goog.require("Blockly.utils.deprecation"),goog.require("Blockly.Xml"),goog.requireType("Blockly.Block"),goog.requireType("Blockly.IConnectionChecker"),goog.requireType("Blockly.Input"),Blockly.Connection=function(o,n){this.sourceBlock_=o,this.type=n},Blockly.Connection.CAN_CONNECT=0,Blockly.Connection.REASON_SELF_CONNECTION=1,Blockly.Connection.REASON_WRONG_TYPE=2,Blockly.Connection.REASON_TARGET_NULL=3,Blockly.Connection.REASON_CHECKS_FAILED=4,Blockly.Connection.REASON_DIFFERENT_WORKSPACES=5,Blockly.Connection.REASON_SHADOW_PARENT=6,Blockly.Connection.REASON_DRAG_CHECKS_FAILED=7,Blockly.Connection.prototype.targetConnection=null,Blockly.Connection.prototype.disposed=!1,Blockly.Connection.prototype.check_=null,Blockly.Connection.prototype.shadowDom_=null,Blockly.Connection.prototype.x=0,Blockly.Connection.prototype.y=0,Blockly.Connection.prototype.connect_=function(o){var n,t,e=Blockly.connectionTypes.INPUT_VALUE,c=this,i=c.getSourceBlock(),r=o.getSourceBlock(),l=!1;if(c==i.getFirstStatementConnection()&&(l=!0),o.isConnected()){if(l)var s=o.targetConnection;o.disconnect()}if(c.isConnected()){var k=c.getShadowDom(!0);c.shadowDom_=null;var u=c.targetBlock();u.isShadow()?u.dispose(!1):(c.disconnect(),n=u),c.shadowDom_=k}if(l&&s&&s.connect(i.previousConnection),Blockly.Events.isEnabled()&&(t=new(Blockly.Events.get(Blockly.Events.BLOCK_MOVE))(r)),Blockly.Connection.connectReciprocally_(c,o),r.setParent(i),t&&(t.recordNew(),Blockly.Events.fire(t)),n){var C=c.type===e?n.outputConnection:n.previousConnection,p=Blockly.Connection.getConnectionForOrphanedConnection(r,C);p?C.connect(p):C.onFailedConnect(c)}},Blockly.Connection.prototype.dispose=function(){if(this.isConnected()){this.setShadowDom(null);var o=this.targetBlock();o&&o.unplug()}this.disposed=!0},Blockly.Connection.prototype.isConnectedToNonInsertionMarker=function(){return this.targetConnection&&!this.targetBlock().isInsertionMarker()},Blockly.Connection.prototype.getSourceBlock=function(){return this.sourceBlock_},Blockly.Connection.prototype.isSuperior=function(){return this.type==Blockly.connectionTypes.INPUT_VALUE||this.type==Blockly.connectionTypes.NEXT_STATEMENT},Blockly.Connection.prototype.isConnected=function(){return!!this.targetConnection},Blockly.Connection.prototype.canConnectWithReason=function(o){return Blockly.utils.deprecation.warn("Connection.prototype.canConnectWithReason","July 2020","July 2021","the workspace's connection checker"),this.getConnectionChecker().canConnectWithReason(this,o,!1)},Blockly.Connection.prototype.checkConnection=function(o){Blockly.utils.deprecation.warn("Connection.prototype.checkConnection","July 2020","July 2021","the workspace's connection checker");var n=this.getConnectionChecker(),t=n.canConnectWithReason(this,o,!1);if(t!=Blockly.Connection.CAN_CONNECT)throw new Error(n.getErrorMessage(t,this,o))},Blockly.Connection.prototype.getConnectionChecker=function(){return this.sourceBlock_.workspace.connectionChecker},Blockly.Connection.prototype.isConnectionAllowed=function(o){return Blockly.utils.deprecation.warn("Connection.prototype.isConnectionAllowed","July 2020","July 2021","the workspace's connection checker"),this.getConnectionChecker().canConnect(this,o,!0)},Blockly.Connection.prototype.onFailedConnect=function(o){},Blockly.Connection.prototype.connect=function(o){if(this.targetConnection!=o&&this.getConnectionChecker().canConnect(this,o,!1)){var n=Blockly.Events.getGroup();n||Blockly.Events.setGroup(!0),this.isSuperior()?this.connect_(o):o.connect_(this),n||Blockly.Events.setGroup(!1)}},Blockly.Connection.connectReciprocally_=function(o,n){if(!o||!n)throw Error("Cannot connect null connections.");o.targetConnection=n,n.targetConnection=o},Blockly.Connection.getSingleConnection_=function(o,n){for(var t,e=null,c=n.outputConnection,i=c.getConnectionChecker(),r=0;t=o.inputList[r];r++){var l=t.connection;if(l&&i.canConnect(c,l,!1)){if(e)return null;e=l}}return e},Blockly.Connection.getConnectionForOrphanedOutput_=function(o,n){for(var t,e=o;t=Blockly.Connection.getSingleConnection_(e,n);)if(!(e=t.targetBlock())||e.isShadow())return t;return null},Blockly.Connection.getConnectionForOrphanedConnection=function(o,n){if(n.type===Blockly.connectionTypes.OUTPUT_VALUE)return Blockly.Connection.getConnectionForOrphanedOutput_(o,n.getSourceBlock());var t=o.lastConnectionInStack(!0),e=n.getConnectionChecker();return t&&e.canConnect(n,t,!1)?t:null},Blockly.Connection.prototype.disconnect=function(){var o,n,t,e=this.targetConnection;if(!e)throw Error("Source connection not connected.");if(e.targetConnection!=this)throw Error("Target connection not connected to source connection.");this.isSuperior()?(o=this.sourceBlock_,n=e.getSourceBlock(),t=this):(o=e.getSourceBlock(),n=this.sourceBlock_,t=e);var c=Blockly.Events.getGroup();c||Blockly.Events.setGroup(!0),this.disconnectInternal_(o,n),n.isShadow()||t.respawnShadow_(),c||Blockly.Events.setGroup(!1)},Blockly.Connection.prototype.disconnectInternal_=function(o,n){var t;Blockly.Events.isEnabled()&&(t=new(Blockly.Events.get(Blockly.Events.BLOCK_MOVE))(n)),this.targetConnection.targetConnection=null,this.targetConnection=null,n.setParent(null),t&&(t.recordNew(),Blockly.Events.fire(t))},Blockly.Connection.prototype.respawnShadow_=function(){var o=this.getSourceBlock(),n=this.getShadowDom();if(o.workspace&&n){var t=Blockly.Xml.domToBlock(n,o.workspace);if(t.outputConnection)this.connect(t.outputConnection);else{if(!t.previousConnection)throw Error("Child block does not have output or previous statement.");this.connect(t.previousConnection)}}},Blockly.Connection.prototype.targetBlock=function(){return this.isConnected()?this.targetConnection.getSourceBlock():null},Blockly.Connection.prototype.checkType=function(o){return Blockly.utils.deprecation.warn("Connection.prototype.checkType","October 2019","January 2021","the workspace's connection checker"),this.getConnectionChecker().canConnect(this,o,!1)},Blockly.Connection.prototype.checkType_=function(o){return Blockly.utils.deprecation.warn("Connection.prototype.checkType_","October 2019","January 2021","the workspace's connection checker"),this.checkType(o)},Blockly.Connection.prototype.onCheckChanged_=function(){!this.isConnected()||this.targetConnection&&this.getConnectionChecker().canConnect(this,this.targetConnection,!1)||(this.isSuperior()?this.targetBlock():this.sourceBlock_).unplug()},Blockly.Connection.prototype.setCheck=function(o){return o?(Array.isArray(o)||(o=[o]),this.check_=o,this.onCheckChanged_()):this.check_=null,this},Blockly.Connection.prototype.getCheck=function(){return this.check_},Blockly.Connection.prototype.getOutputShape=function(){return this.check_?-1!==this.check_.indexOf("Boolean")?Blockly.OUTPUT_SHAPE_HEXAGONAL:(-1!==this.check_.indexOf("Number")||this.check_.indexOf("String"),Blockly.OUTPUT_SHAPE_ROUND):Blockly.OUTPUT_SHAPE_ROUND},Blockly.Connection.prototype.setShadowDom=function(o,n){this.shadowDom_=o;var t=this.targetBlock();t?t.isShadow()&&!n&&(t.dispose(!1),this.respawnShadow_()):this.respawnShadow_()},Blockly.Connection.prototype.getShadowDom=function(o){return o&&this.targetBlock().isShadow()?Blockly.Xml.blockToDom(this.targetBlock()):this.shadowDom_},Blockly.Connection.prototype.neighbours=function(o){return[]},Blockly.Connection.prototype.getParentInput=function(){for(var o=null,n=this.sourceBlock_.inputList,t=0;t<n.length;t++)if(n[t].connection===this){o=n[t];break}return o},Blockly.Connection.prototype.toString=function(){var o,n=this.sourceBlock_;if(!n)return"Orphan Connection";if(n.outputConnection==this)o="Output Connection of ";else if(n.previousConnection==this)o="Previous Connection of ";else if(n.nextConnection==this)o="Next Connection of ";else{for(var t,e=null,c=0;t=n.inputList[c];c++)if(t.connection==this){e=t;break}if(!e)return console.warn("Connection not actually connected to sourceBlock_"),"Orphan Connection";o='Input "'+e.name+'" connection on '}return o+n.toDevString()};