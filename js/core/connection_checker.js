/**
 * @license
 * Copyright 2020 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.ConnectionChecker"),goog.require("Blockly.Connection"),goog.require("Blockly.connectionTypes"),goog.require("Blockly.constants"),goog.require("Blockly.IConnectionChecker"),goog.require("Blockly.pxtBlocklyUtils"),goog.require("Blockly.registry"),goog.requireType("Blockly.RenderedConnection"),Blockly.ConnectionChecker=function(){},Blockly.ConnectionChecker.prototype.canConnect=function(e,o,n,t){return this.canConnectWithReason(e,o,n,t)==Blockly.Connection.CAN_CONNECT},Blockly.ConnectionChecker.prototype.canConnectWithReason=function(e,o,n,t){var c=this.doSafetyChecks(e,o);if(c!=Blockly.Connection.CAN_CONNECT)return c;var r=e,l=o;return this.doTypeChecks(r,l)?n&&!this.doDragChecks(e,o,t||0)?Blockly.Connection.REASON_DRAG_CHECKS_FAILED:Blockly.Connection.CAN_CONNECT:Blockly.Connection.REASON_CHECKS_FAILED},Blockly.ConnectionChecker.prototype.getErrorMessage=function(e,o,n){switch(e){case Blockly.Connection.REASON_SELF_CONNECTION:return"Attempted to connect a block to itself.";case Blockly.Connection.REASON_DIFFERENT_WORKSPACES:return"Blocks not on same workspace.";case Blockly.Connection.REASON_WRONG_TYPE:return"Attempt to connect incompatible types.";case Blockly.Connection.REASON_TARGET_NULL:return"Target connection is null.";case Blockly.Connection.REASON_CHECKS_FAILED:var t=n,c="Connection checks failed. ";return c+=o+" expected "+o.getCheck()+", found "+t.getCheck();case Blockly.Connection.REASON_SHADOW_PARENT:return"Connecting non-shadow to shadow block.";case Blockly.Connection.REASON_DRAG_CHECKS_FAILED:return"Drag checks failed.";default:return"Unknown connection failure: this should never happen!"}},Blockly.ConnectionChecker.prototype.doSafetyChecks=function(e,o){if(!e||!o)return Blockly.Connection.REASON_TARGET_NULL;if(e.isSuperior())var n=e.getSourceBlock(),t=o.getSourceBlock();else t=e.getSourceBlock(),n=o.getSourceBlock();return n==t?Blockly.Connection.REASON_SELF_CONNECTION:o.type!=Blockly.OPPOSITE_TYPE[e.type]?Blockly.Connection.REASON_WRONG_TYPE:n.workspace!==t.workspace?Blockly.Connection.REASON_DIFFERENT_WORKSPACES:Blockly.Connection.CAN_CONNECT},Blockly.ConnectionChecker.prototype.doTypeChecks=function(e,o){var n=e.getCheck(),t=o.getCheck();if(!n||!t)return!0;for(var c=0;c<n.length;c++)if(-1!=t.indexOf(n[c]))return!0;return!1},Blockly.ConnectionChecker.prototype.doDragChecks=function(e,o,n){if(e.distanceFrom(o)>n)return!1;if(o.getSourceBlock().isInsertionMarker())return!1;switch(o.type){case Blockly.connectionTypes.PREVIOUS_STATEMENT:return this.canConnectToPrevious_(e,o);case Blockly.connectionTypes.OUTPUT_VALUE:if(o.isConnected()&&!o.targetBlock().isInsertionMarker()||e.isConnected())return!1;break;case Blockly.connectionTypes.INPUT_VALUE:if(o.isConnected()&&!o.targetBlock().isMovable()&&!o.targetBlock().isShadow())return!1;if(o&&o.targetBlock()){var t=o.targetBlock();if(t.isShadow()&&Blockly.pxtBlocklyUtils.isFunctionArgumentReporter(t))return!1}if(Blockly.pxtBlocklyUtils.isFunctionArgumentReporter(e.getSourceBlock())){for(var c=o.getSourceBlock().getParent(),r=!1;c;){if(!c.isEnabled()||Blockly.pxtBlocklyUtils.hasMatchingArgumentReporter(c,e.getSourceBlock())){r=!0;break}c=c.getParent()}if(!r)return!1}break;case Blockly.connectionTypes.NEXT_STATEMENT:if(o.isConnected()&&!e.getSourceBlock().nextConnection&&!o.targetBlock().isShadow()&&o.targetBlock().nextConnection)return!1;break;default:return!1}return-1==Blockly.draggingConnections.indexOf(o)},Blockly.ConnectionChecker.prototype.canConnectToPrevious_=function(e,o){if(e.targetConnection)return!1;if(-1!=Blockly.draggingConnections.indexOf(o))return!1;var n=e.getSourceBlock(),t=n.getFirstStatementConnection(),c=null!=t,r=e==t,l=e==n.nextConnection;if(c&&!r&&!l)return!1;var i=null!=n.previousConnection;if(r&&i)return!0;if(!o.targetConnection)return!0;var k=o.targetBlock();return!!k.isInsertionMarker()&&!k.getPreviousBlock()},Blockly.registry.register(Blockly.registry.Type.CONNECTION_CHECKER,Blockly.registry.DEFAULT,Blockly.ConnectionChecker);