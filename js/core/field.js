/**
 * @license
 * Copyright 2012 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.Field"),goog.require("Blockly.browserEvents"),goog.require("Blockly.DropDownDiv"),goog.require("Blockly.Events"),goog.require("Blockly.Events.BlockChange"),goog.require("Blockly.Gesture"),goog.require("Blockly.IASTNodeLocationSvg"),goog.require("Blockly.IASTNodeLocationWithBlock"),goog.require("Blockly.IKeyboardAccessible"),goog.require("Blockly.IRegistrable"),goog.require("Blockly.MarkerManager"),goog.require("Blockly.Tooltip"),goog.require("Blockly.utils"),goog.require("Blockly.utils.dom"),goog.require("Blockly.utils.Rect"),goog.require("Blockly.utils.Size"),goog.require("Blockly.utils.style"),goog.require("Blockly.utils.Svg"),goog.require("Blockly.utils.userAgent"),goog.require("Blockly.WidgetDiv"),goog.requireType("Blockly.Block"),goog.requireType("Blockly.blockRendering.ConstantProvider"),goog.requireType("Blockly.BlockSvg"),goog.requireType("Blockly.Input"),goog.requireType("Blockly.ShortcutRegistry"),goog.requireType("Blockly.utils.Coordinate"),goog.requireType("Blockly.WorkspaceSvg"),Blockly.Field=function(t,e,o){this.value_=this.DEFAULT_VALUE,this.validator_=null,this.tooltip_=null,this.size_=new Blockly.utils.Size(0,0),this.cursorSvg_=null,this.markerSvg_=null,this.fieldGroup_=null,this.borderRect_=null,this.textElement_=null,this.textContent_=null,this.mouseDownWrapper_=null,this.constants_=null,o&&this.configure_(o),this.setValue(t),e&&this.setValidator(e)},Blockly.Field.prototype.DEFAULT_VALUE=null,Blockly.Field.prototype.name=void 0,Blockly.Field.prototype.className_="blocklyText",Blockly.Field.prototype.disposed=!1,Blockly.Field.prototype.maxDisplayLength=1/0,Blockly.Field.prototype.sourceBlock_=null,Blockly.Field.prototype.isDirty_=!0,Blockly.Field.prototype.visible_=!0,Blockly.Field.prototype.argType_=null,Blockly.Field.prototype.clickTarget_=null,Blockly.Field.prototype.getText_,Blockly.Field.prototype.showEditor_,Blockly.Field.NBSP=" ",Blockly.Field.IE_TEXT_OFFSET="0.3em",Blockly.Field.prototype.EDITABLE=!0,Blockly.Field.prototype.SERIALIZABLE=!1,Blockly.Field.prototype.configure_=function(t){var e=t.tooltip;"string"==typeof e&&(e=Blockly.utils.replaceMessageReferences(t.tooltip)),e&&this.setTooltip(e)},Blockly.Field.prototype.setSourceBlock=function(t){if(this.sourceBlock_)throw Error("Field already bound to a block.");this.sourceBlock_=t},Blockly.Field.prototype.getConstants=function(){return!this.constants_&&this.sourceBlock_&&this.sourceBlock_.workspace&&this.sourceBlock_.workspace.rendered&&(this.constants_=this.sourceBlock_.workspace.getRenderer().getConstants()),this.constants_},Blockly.Field.prototype.getSourceBlock=function(){return this.sourceBlock_},Blockly.Field.prototype.init=function(){this.fieldGroup_||(this.fieldGroup_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.G,{},null),this.isVisible()||(this.fieldGroup_.style.display="none"),this.sourceBlock_.getSvgRoot().appendChild(this.fieldGroup_),this.initView(),this.setDataAttribute_(),this.updateEditable(),this.setTooltip(this.tooltip_),this.bindEvents_(),this.initModel())},Blockly.Field.prototype.initView=function(){this.createBorderRect_(),this.createTextElement_()},Blockly.Field.prototype.initModel=function(){},Blockly.Field.prototype.onLoadedIntoWorkspace=function(){},Blockly.Field.prototype.createBorderRect_=function(){this.borderRect_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.RECT,{rx:this.getConstants().FIELD_BORDER_RECT_RADIUS,ry:this.getConstants().FIELD_BORDER_RECT_RADIUS,x:0,y:0,height:this.size_.height,width:this.size_.width,class:"blocklyFieldRect"},this.fieldGroup_)},Blockly.Field.prototype.createTextElement_=function(){this.textElement_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.TEXT,{class:"blocklyText"},this.fieldGroup_),this.getConstants().FIELD_TEXT_BASELINE_CENTER&&this.textElement_.setAttribute("dominant-baseline","central"),this.textContent_=document.createTextNode(""),this.textElement_.appendChild(this.textContent_)},Blockly.Field.prototype.setDataAttribute_=function(){null!==this.getArgTypes()&&(this.sourceBlock_.isShadow()?this.sourceBlock_.svgGroup_.setAttribute("data-argument-type",this.getArgTypes()):this.fieldGroup_.setAttribute("data-argument-type",this.getArgTypes()))},Blockly.Field.prototype.bindEvents_=function(){Blockly.Tooltip.bindMouseEvents(this.getClickTarget_()),this.mouseDownWrapper_=Blockly.browserEvents.conditionalBind(this.getClickTarget_(),"mousedown",this,this.onMouseDown_)},Blockly.Field.prototype.fromXml=function(t){this.setValue(t.textContent)},Blockly.Field.prototype.toXml=function(t){return t.textContent=this.getValue(),t},Blockly.Field.prototype.dispose=function(){Blockly.DropDownDiv.hideIfOwner(this),Blockly.WidgetDiv.hideIfOwner(this),this.getTotalFields_()>1&&Blockly.Tooltip.unbindMouseEvents(this.getClickTarget_()),this.mouseDownWrapper_&&Blockly.browserEvents.unbind(this.mouseDownWrapper_),Blockly.utils.dom.removeNode(this.fieldGroup_),this.disposed=!0},Blockly.Field.prototype.updateEditable=function(){var t=this.fieldGroup_;this.EDITABLE&&t&&(this.sourceBlock_.isEditable()?(Blockly.utils.dom.addClass(t,"blocklyEditableText"),Blockly.utils.dom.removeClass(t,"blocklyNonEditableText"),t.style.cursor=this.CURSOR):(Blockly.utils.dom.addClass(t,"blocklyNonEditableText"),Blockly.utils.dom.removeClass(t,"blocklyEditableText"),t.style.cursor=""))},Blockly.Field.prototype.isClickable=function(){return!!this.sourceBlock_&&this.sourceBlock_.isEditable()&&!!this.showEditor_&&"function"==typeof this.showEditor_},Blockly.Field.prototype.isCurrentlyEditable=function(){return this.EDITABLE&&!!this.sourceBlock_&&this.sourceBlock_.isEditable()},Blockly.Field.prototype.isSerializable=function(){var t=!1;return this.name&&(this.SERIALIZABLE?t=!0:this.EDITABLE&&(console.warn("Detected an editable field that was not serializable. Please define SERIALIZABLE property as true on all editable custom fields. Proceeding with serialization."),t=!0)),t},Blockly.Field.prototype.isVisible=function(){return this.visible_},Blockly.Field.prototype.setVisible=function(t){if(this.visible_!=t){this.visible_=t;var e=this.getSvgRoot();e&&(e.style.display=t?"block":"none")}},Blockly.Field.prototype.addArgType=function(t){null==this.argType_&&(this.argType_=[]),this.argType_.push(t)},Blockly.Field.prototype.getArgTypes=function(){return null===this.argType_||0===this.argType_.length?null:this.argType_.join(" ")},Blockly.Field.prototype.setValidator=function(t){this.validator_=t},Blockly.Field.prototype.getValidator=function(){return this.validator_},Blockly.Field.prototype.getSvgRoot=function(){return this.fieldGroup_},Blockly.Field.prototype.applyColour=function(){},Blockly.Field.prototype.render_=function(){this.textContent_&&(this.textContent_.nodeValue=this.getDisplayText_()),this.updateSize_()},Blockly.Field.prototype.showEditor=function(t){this.isClickable()&&this.showEditor_(t)},Blockly.Field.prototype.updateSize_=function(t){var e=this.getConstants(),o=null!=t?t:this.borderRect_?this.getConstants().FIELD_BORDER_RECT_X_PADDING:0,i=2*o,l=e.FIELD_TEXT_HEIGHT,s=0;this.textElement_&&(i+=s=Blockly.utils.dom.getFastTextWidth(this.textElement_,e.FIELD_TEXT_FONTSIZE,e.FIELD_TEXT_FONTWEIGHT,e.FIELD_TEXT_FONTFAMILY)),this.borderRect_&&(l=Math.max(l,e.FIELD_BORDER_RECT_HEIGHT)),this.size_.height=l,this.size_.width=i,this.positionTextElement_(o,s),this.positionBorderRect_()},Blockly.Field.prototype.positionTextElement_=function(t,e){if(this.textElement_){var o=this.getConstants(),i=this.size_.height/2;this.textElement_.setAttribute("x",this.sourceBlock_.RTL?this.size_.width-e-t:t),this.textElement_.setAttribute("y",o.FIELD_TEXT_BASELINE_CENTER?i:i-o.FIELD_TEXT_HEIGHT/2+o.FIELD_TEXT_BASELINE)}},Blockly.Field.prototype.positionBorderRect_=function(){this.borderRect_&&(this.borderRect_.setAttribute("width",this.size_.width),this.borderRect_.setAttribute("height",this.size_.height),this.borderRect_.setAttribute("rx",this.getConstants().FIELD_BORDER_RECT_RADIUS),this.borderRect_.setAttribute("ry",this.getConstants().FIELD_BORDER_RECT_RADIUS))},Blockly.Field.prototype.getSize=function(){return this.isVisible()?(this.isDirty_?(this.render_(),this.isDirty_=!1):this.visible_&&0==this.size_.width&&!this.sourceBlock_.isInsertionMarker_&&(console.warn("Deprecated use of setting size_.width to 0 to rerender a field. Set field.isDirty_ to true instead."),this.render_()),this.size_):new Blockly.utils.Size(0,0)},Blockly.Field.prototype.getScaledBBox=function(){if(this.borderRect_)t=this.borderRect_.getBoundingClientRect(),o=Blockly.utils.style.getPageOffset(this.borderRect_),i=t.width,l=t.height;else{var t=this.sourceBlock_.getHeightWidth(),e=this.sourceBlock_.workspace.scale,o=this.getAbsoluteXY_(),i=t.width*e,l=t.height*e;Blockly.utils.userAgent.GECKO?(o.x+=1.5*e,o.y+=1.5*e,i+=1*e,l+=1*e):(Blockly.utils.userAgent.EDGE||Blockly.utils.userAgent.IE||(o.x-=.5*e,o.y-=.5*e),i+=1*e,l+=1*e)}return new Blockly.utils.Rect(o.y,o.y+l,o.x,o.x+i)},Blockly.Field.prototype.getDisplayText_=function(){var t=this.getText();return t?(t.length>this.maxDisplayLength&&(t=t.substring(0,this.maxDisplayLength-2)+"…"),t=t.replace(/\s/g,Blockly.Field.NBSP),this.sourceBlock_&&this.sourceBlock_.RTL&&(t+="‏"),t):Blockly.Field.NBSP},Blockly.Field.prototype.getText=function(){if(this.getText_){var t=this.getText_.call(this);if(null!==t)return String(t)}return String(this.getValue())},Blockly.Field.prototype.markDirty=function(){this.isDirty_=!0,this.constants_=null},Blockly.Field.prototype.forceRerender=function(){this.isDirty_=!0,this.sourceBlock_&&this.sourceBlock_.rendered&&(this.sourceBlock_.render(),this.sourceBlock_.bumpNeighbours(),this.updateMarkers_())},Blockly.Field.prototype.setValue=function(t){if(null!==t){var e=this.doClassValidation_(t);if(!((t=this.processValidation_(t,e))instanceof Error)){var o=this.getValidator();if(!(o&&(e=o.call(this,t),(t=this.processValidation_(t,e))instanceof Error))){var i=this.sourceBlock_;if(!i||!i.disposed){var l=this.getValue();l!==t?(i&&Blockly.Events.isEnabled()&&Blockly.Events.fire(new(Blockly.Events.get(Blockly.Events.BLOCK_CHANGE))(i,"field",this.name||null,l,t)),this.doValueUpdate_(t),this.isDirty_&&this.forceRerender()):this.doValueUpdate_(t)}}}}},Blockly.Field.prototype.processValidation_=function(t,e){return null===e?(this.doValueInvalid_(t),this.isDirty_&&this.forceRerender(),Error()):(void 0!==e&&(t=e),t)},Blockly.Field.prototype.getValue=function(){return this.value_},Blockly.Field.prototype.doClassValidation_=function(t){return null==t?null:t},Blockly.Field.prototype.doValueUpdate_=function(t){this.value_=t,this.isDirty_=!0},Blockly.Field.prototype.doValueInvalid_=function(t){},Blockly.Field.prototype.onMouseDown_=function(t){if(this.sourceBlock_&&this.sourceBlock_.workspace){var e=this.sourceBlock_.workspace.getGesture(t);e&&e.setStartField(this)}},Blockly.Field.prototype.setTooltip=function(t){t||""===t||(t=this.sourceBlock_);var e=this.getClickTarget_();e?e.tooltip=t:this.tooltip_=t},Blockly.Field.prototype.getTooltip=function(){var t=this.getClickTarget_();return t?Blockly.Tooltip.getTooltipOfObject(t):Blockly.Tooltip.getTooltipOfObject({tooltip:this.tooltip_})},Blockly.Field.prototype.getClickTarget_=function(){if(this.clickTarget_)return this.clickTarget_;if(!this.sourceBlock_||!this.sourceBlock_.getSvgRoot)return null;for(var t,e=0,o=0,i=0;t=this.sourceBlock_.inputList[i];i++){for(var l,s=0;l=t.fieldRow[s];s++)l instanceof Blockly.FieldLabel||e++;t.connection&&o++}return e<=1&&this.sourceBlock_.outputConnection&&!o?this.clickTarget_=this.sourceBlock_.getSvgRoot():this.clickTarget_=this.getSvgRoot(),this.clickTarget_},Blockly.Field.prototype.getTotalFields_=function(t=!1){for(var e,o=0,i=0;e=this.sourceBlock_.inputList[i];i++)for(var l,s=0;l=e.fieldRow[s];s++)l instanceof Blockly.FieldLabel&&t||o++;return o},Blockly.Field.prototype.getAbsoluteXY_=function(){return Blockly.utils.style.getPageOffset(this.getClickTarget_())},Blockly.Field.prototype.referencesVariables=function(){return!1},Blockly.Field.prototype.getParentInput=function(){for(var t=null,e=this.sourceBlock_,o=e.inputList,i=0;i<e.inputList.length;i++)for(var l=o[i],s=l.fieldRow,r=0;r<s.length;r++)if(s[r]===this){t=l;break}return t},Blockly.Field.prototype.getFlipRtl=function(){return!1},Blockly.Field.prototype.isTabNavigable=function(){return!1},Blockly.Field.prototype.onShortcut=function(t){return!1},Blockly.Field.prototype.setCursorSvg=function(t){t?(this.fieldGroup_.appendChild(t),this.cursorSvg_=t):this.cursorSvg_=null},Blockly.Field.prototype.setMarkerSvg=function(t){t?(this.fieldGroup_.appendChild(t),this.markerSvg_=t):this.markerSvg_=null},Blockly.Field.prototype.updateMarkers_=function(){var t=this.sourceBlock_.workspace;t.keyboardAccessibilityMode&&this.cursorSvg_&&t.getCursor().draw(),t.keyboardAccessibilityMode&&this.markerSvg_&&t.getMarker(Blockly.MarkerManager.LOCAL_MARKER).draw()};