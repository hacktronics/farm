/**
 * @license
 * Copyright 2011 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.Comment"),goog.require("Blockly.browserEvents"),goog.require("Blockly.Bubble"),goog.require("Blockly.Css"),goog.require("Blockly.Events"),goog.require("Blockly.Events.BlockChange"),goog.require("Blockly.Events.BubbleOpen"),goog.require("Blockly.Icon"),goog.require("Blockly.utils.dom"),goog.require("Blockly.utils.object"),goog.require("Blockly.utils.Svg"),goog.require("Blockly.utils.userAgent"),goog.require("Blockly.Warning"),goog.requireType("Blockly.Block"),goog.requireType("Blockly.BlockSvg"),goog.requireType("Blockly.utils.Coordinate"),goog.requireType("Blockly.utils.Size"),goog.requireType("Blockly.WorkspaceSvg"),Blockly.Comment=function(e){Blockly.Comment.superClass_.constructor.call(this,e),this.model_=e.commentModel,this.model_.text=this.model_.text||"",this.cachedText_="",this.onMouseUpWrapper_=null,this.onWheelWrapper_=null,this.onChangeWrapper_=null,this.onInputWrapper_=null,this.createIcon()},Blockly.utils.object.inherits(Blockly.Comment,Blockly.Icon),Blockly.Comment.prototype.drawIcon_=function(e){Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.PATH,{class:"blocklyIconShape",d:"m 2,2 0,9.2211 3.0026599,0 1.6008929,1.5989 1.8138195,-1.5989 6.6046683,0 0,-9.2211 -13.0220406,0 z",style:"fill: #fff;"},e),Blockly.utils.dom.createSvgElement("rect",{class:"blocklyIconSymbol",x:"4",y:"8",height:"1",width:"6",style:"fill: #575E75;"},e),Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.RECT,{class:"blocklyIconSymbol",x:"4",y:"6",height:"1",width:"6",style:"fill: #575E75;"},e),Blockly.utils.dom.createSvgElement("rect",{class:"blocklyIconSymbol",x:"4",y:"4",height:"1",width:"8",style:"fill: #575E75;"},e)},Blockly.Comment.prototype.createEditor_=function(){return this.svgGroup_=Blockly.utils.dom.createSvgElement("g",{class:"blocklyCommentBubble"},null),this.svgGroup_.translate_="",this.createTextEditor_(),this.svgGroup_.appendChild(this.foreignObject_),this.createTopBarIcons_(),this.resizeTextarea_(),this.block_.isEditable()&&(Blockly.bindEventWithChecks_(this.deleteIcon_,"mousedown",this,this.deleteMouseDown_),Blockly.bindEventWithChecks_(this.deleteIcon_,"mouseup",this,this.deleteMouseUp_),Blockly.bindEventWithChecks_(this.minimizeArrow_,"mousedown",this,this.minimizeMouseUp_)),this.svgGroup_},Blockly.Comment.prototype.createTextEditor_=function(){this.foreignObject_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.FOREIGNOBJECT,{x:Blockly.Bubble.BORDER_WIDTH,y:Blockly.Bubble.BORDER_WIDTH+Blockly.WorkspaceCommentSvg.TOP_BAR_HEIGHT},null);var e=document.createElementNS(Blockly.utils.dom.HTML_NS,"body");e.setAttribute("xmlns",Blockly.utils.dom.HTML_NS),e.className="blocklyMinimalBody",this.textarea_=document.createElementNS(Blockly.utils.dom.HTML_NS,"textarea");var t=this.textarea_;return t.className="blocklyCommentTextarea",t.setAttribute("dir",this.block_.RTL?"RTL":"LTR"),t.value=this.model_.text,this.block_.isEditable()||t.setAttribute("readonly",!0),e.appendChild(t),this.foreignObject_.appendChild(e),this.block_.isEditable()&&(this.onMouseUpWrapper_=Blockly.browserEvents.conditionalBind(t,"mouseup",this,this.startEdit_,!0,!0),this.onWheelWrapper_=Blockly.browserEvents.conditionalBind(t,"wheel",this,function(e){e.stopPropagation()}),this.onChangeWrapper_=Blockly.browserEvents.conditionalBind(t,"change",this,function(e){this.cachedText_!=this.model_.text&&Blockly.Events.fire(new(Blockly.Events.get(Blockly.Events.BLOCK_CHANGE))(this.block_,"comment",null,this.cachedText_,this.model_.text))}),this.onInputWrapper_=Blockly.browserEvents.conditionalBind(t,"input",this,function(e){this.model_.text=t.value}),setTimeout(t.focus.bind(t),0)),this.foreignObject_},Blockly.Comment.prototype.createTopBarIcons_=function(){var e=Blockly.WorkspaceCommentSvg.TOP_BAR_HEIGHT/2+Blockly.WorkspaceCommentSvg.BORDER_WIDTH,t=Blockly.WorkspaceCommentSvg.TOP_BAR_ICON_INSET;this.minimizeArrow_=Blockly.utils.dom.createSvgElement("image",{x:t,y:e-Blockly.WorkspaceCommentSvg.MINIMIZE_ICON_SIZE/2,width:Blockly.WorkspaceCommentSvg.MINIMIZE_ICON_SIZE,height:Blockly.WorkspaceCommentSvg.MINIMIZE_ICON_SIZE},this.svgGroup_),this.minimizeArrow_.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",Blockly.mainWorkspace.options.pathToMedia+"comment-arrow-down.svg"),this.deleteIcon_=Blockly.utils.dom.createSvgElement("g",{class:"blocklyCommentDeleteIcon"},this.svgGroup_),Blockly.utils.dom.createSvgElement("rect",{x:"-12.5",y:"1",width:"27.5",height:"27.5",fill:"transparent",class:"blocklyDeleteIconShape"},this.deleteIcon_),Blockly.WorkspaceCommentSvg.drawDeleteIcon(this.deleteIcon_)},Blockly.Comment.prototype.deleteMouseDown_=function(e){e.stopPropagation()},Blockly.Comment.prototype.deleteMouseUp_=function(e){this.block_.setCommentText(null),e.stopPropagation(),Blockly.Touch.clearTouchIdentifier()},Blockly.Comment.prototype.minimizeMouseUp_=function(e){this.block_.comment.setVisible(!1),e.stopPropagation(),Blockly.Touch.clearTouchIdentifier()},Blockly.Comment.prototype.updateEditable=function(){Blockly.Comment.superClass_.updateEditable.call(this),this.isVisible()&&(this.disposeBubble_(),this.createBubble_())},Blockly.Comment.prototype.onBubbleResize_=function(){this.isVisible()&&(this.model_.size=this.bubble_.getBubbleSize(),this.resizeTextarea_())},Blockly.Comment.prototype.resizeTextarea_=function(){var e=this.model_.size,t=2*Blockly.Bubble.BORDER_WIDTH,o=Blockly.WorkspaceCommentSvg.TOP_BAR_HEIGHT;this.foreignObject_.setAttribute("width",Math.max(e.width-t,0)),this.foreignObject_.setAttribute("height",Math.max(e.height-t-o,0)),this.textarea_.style.width=e.width-t-4+"px",this.textarea_.style.height=e.height-t-o-4+"px",this.RTL?(this.minimizeArrow_.setAttribute("x",e.width-Blockly.WorkspaceCommentSvg.MINIMIZE_ICON_SIZE-Blockly.WorkspaceCommentSvg.TOP_BAR_ICON_INSET),this.minimizeArrow_.setAttribute("transform","translate("+-e.width+", 1)"),this.deleteIcon_.setAttribute("transform","translate("+(-e.width+Blockly.WorkspaceCommentSvg.DELETE_ICON_SIZE+Blockly.WorkspaceCommentSvg.TOP_BAR_ICON_INSET)+",0) scale(-1 1)")):this.deleteIcon_.setAttribute("transform","translate("+(e.width-Blockly.WorkspaceCommentSvg.DELETE_ICON_SIZE-Blockly.WorkspaceCommentSvg.TOP_BAR_ICON_INSET)+",0)")},Blockly.Comment.prototype.setVisible=function(e){e!=this.isVisible()&&(Blockly.Events.fire(new(Blockly.Events.get(Blockly.Events.BUBBLE_OPEN))(this.block_,e,"comment")),this.model_.pinned=e,e?this.createBubble_():(this.model_.xy=this.getRelativePosition(),this.disposeBubble_()))},Blockly.Comment.prototype.setRelativePosition=function(e){this.model_.xy=e,this.bubble_&&(this.bubble_.relativeLeft_=e.x,this.bubble_.relativeTop_=e.y,this.bubble_.positionBubble_(),this.bubble_.renderArrow_())},Blockly.Comment.prototype.getRelativePosition=function(){return this.bubble_?new Blockly.utils.Coordinate(this.bubble_.relativeLeft_,this.bubble_.relativeTop_):this.model_.xy},Blockly.Comment.prototype.createBubble_=function(){Blockly.utils.userAgent.IE?this.createNonEditableBubble_():this.createEditableBubble_()},Blockly.Comment.prototype.createEditableBubble_=function(){this.bubble_=new Blockly.Bubble(this.block_.workspace,this.createEditor_(),this.block_.pathObject.svgPath,this.iconXY_,this.model_.size.width,this.model_.size.height),this.bubble_.setSvgId(this.block_.id),this.bubble_.registerResizeEvent(this.onBubbleResize_.bind(this)),this.applyColour(),this.setRelativePosition(this.model_.xy)},Blockly.Comment.prototype.createNonEditableBubble_=function(){this.paragraphElement_=Blockly.Bubble.textToDom(this.block_.getCommentText()),this.bubble_=Blockly.Bubble.createNonEditableBubble(this.paragraphElement_,this.block_,this.iconXY_),this.applyColour()},Blockly.Comment.prototype.disposeBubble_=function(){this.onMouseUpWrapper_&&(Blockly.browserEvents.unbind(this.onMouseUpWrapper_),this.onMouseUpWrapper_=null),this.onWheelWrapper_&&(Blockly.browserEvents.unbind(this.onWheelWrapper_),this.onWheelWrapper_=null),this.onChangeWrapper_&&(Blockly.browserEvents.unbind(this.onChangeWrapper_),this.onChangeWrapper_=null),this.onInputWrapper_&&(Blockly.browserEvents.unbind(this.onInputWrapper_),this.onInputWrapper_=null),this.bubble_.dispose(),this.bubble_=null,this.textarea_=null,this.foreignObject_=null,this.paragraphElement_=null},Blockly.Comment.prototype.startEdit_=function(e){this.bubble_.promote()&&this.textarea_.focus(),this.cachedText_=this.model_.text},Blockly.Comment.prototype.getBubbleSize=function(){return this.model_.size},Blockly.Comment.prototype.setBubbleSize=function(e,t){this.bubble_?this.bubble_.setBubbleSize(e,t):(this.model_.size.width=e,this.model_.size.height=t)},Blockly.Comment.prototype.updateText=function(){this.textarea_?this.textarea_.value=this.model_.text:this.paragraphElement_&&(this.paragraphElement_.firstChild.textContent=this.model_.text)},Blockly.Comment.prototype.dispose=function(){this.block_.comment=null,Blockly.Icon.prototype.dispose.call(this)},Blockly.Css.register([".blocklyCommentTextarea {","background-color: #FAF6BD;","border: 0;","outline: 0;","margin: 0;","padding: 3px;","resize: none;","display: block;","color: $colour_text;","overflow: hidden;","font-size: 12pt;","line-height: 22px;","}"]);