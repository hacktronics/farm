/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.ASTNode"),goog.require("Blockly.connectionTypes"),goog.require("Blockly.constants"),goog.require("Blockly.utils.Coordinate"),goog.requireType("Blockly.Block"),goog.requireType("Blockly.Connection"),goog.requireType("Blockly.Field"),goog.requireType("Blockly.IASTNodeLocation"),goog.requireType("Blockly.IASTNodeLocationWithBlock"),goog.requireType("Blockly.Input"),goog.requireType("Blockly.Workspace"),Blockly.ASTNode=function(o,e,t){if(!e)throw Error("Cannot create a node without a location.");this.type_=o,this.isConnection_=Blockly.ASTNode.isConnectionType_(o),this.location_=e,this.wsCoordinate_=null,this.processParams_(t||null)},Blockly.ASTNode.Params,Blockly.ASTNode.types={FIELD:"field",BLOCK:"block",INPUT:"input",OUTPUT:"output",NEXT:"next",PREVIOUS:"previous",STACK:"stack",WORKSPACE:"workspace"},Blockly.ASTNode.NAVIGATE_ALL_FIELDS=!1,Blockly.ASTNode.DEFAULT_OFFSET_Y=-20,Blockly.ASTNode.isConnectionType_=function(o){switch(o){case Blockly.ASTNode.types.PREVIOUS:case Blockly.ASTNode.types.NEXT:case Blockly.ASTNode.types.INPUT:case Blockly.ASTNode.types.OUTPUT:return!0}return!1},Blockly.ASTNode.createFieldNode=function(o){return o?new Blockly.ASTNode(Blockly.ASTNode.types.FIELD,o):null},Blockly.ASTNode.createConnectionNode=function(o){if(!o)return null;var e=o.type;return e==Blockly.connectionTypes.INPUT_VALUE||e==Blockly.connectionTypes.NEXT_STATEMENT&&o.getParentInput()?Blockly.ASTNode.createInputNode(o.getParentInput()):e==Blockly.connectionTypes.NEXT_STATEMENT?new Blockly.ASTNode(Blockly.ASTNode.types.NEXT,o):e==Blockly.connectionTypes.OUTPUT_VALUE?new Blockly.ASTNode(Blockly.ASTNode.types.OUTPUT,o):e==Blockly.connectionTypes.PREVIOUS_STATEMENT?new Blockly.ASTNode(Blockly.ASTNode.types.PREVIOUS,o):null},Blockly.ASTNode.createInputNode=function(o){return o&&o.connection?new Blockly.ASTNode(Blockly.ASTNode.types.INPUT,o.connection):null},Blockly.ASTNode.createBlockNode=function(o){return o?new Blockly.ASTNode(Blockly.ASTNode.types.BLOCK,o):null},Blockly.ASTNode.createStackNode=function(o){return o?new Blockly.ASTNode(Blockly.ASTNode.types.STACK,o):null},Blockly.ASTNode.createWorkspaceNode=function(o,e){if(!e||!o)return null;var t={wsCoordinate:e};return new Blockly.ASTNode(Blockly.ASTNode.types.WORKSPACE,o,t)},Blockly.ASTNode.createTopNode=function(o){var e=o.previousConnection||o.outputConnection;return e?Blockly.ASTNode.createConnectionNode(e):Blockly.ASTNode.createBlockNode(o)},Blockly.ASTNode.prototype.processParams_=function(o){o&&o.wsCoordinate&&(this.wsCoordinate_=o.wsCoordinate)},Blockly.ASTNode.prototype.getLocation=function(){return this.location_},Blockly.ASTNode.prototype.getType=function(){return this.type_},Blockly.ASTNode.prototype.getWsCoordinate=function(){return this.wsCoordinate_},Blockly.ASTNode.prototype.isConnection=function(){return this.isConnection_},Blockly.ASTNode.prototype.findNextForInput_=function(){for(var o,e=this.location_.getParentInput(),t=e.getSourceBlock(),l=t.inputList.indexOf(e)+1;o=t.inputList[l];l++){for(var n,c=o.fieldRow,r=0;n=c[r];r++)if(n.isClickable()||Blockly.ASTNode.NAVIGATE_ALL_FIELDS)return Blockly.ASTNode.createFieldNode(n);if(o.connection)return Blockly.ASTNode.createInputNode(o)}return null},Blockly.ASTNode.prototype.findNextForField_=function(){for(var o,e=this.location_,t=e.getParentInput(),l=e.getSourceBlock(),n=l.inputList.indexOf(t),c=t.fieldRow.indexOf(e)+1,r=n;o=l.inputList[r];r++){for(var i=o.fieldRow;c<i.length;){if(i[c].isClickable()||Blockly.ASTNode.NAVIGATE_ALL_FIELDS)return Blockly.ASTNode.createFieldNode(i[c]);c++}if(c=0,o.connection)return Blockly.ASTNode.createInputNode(o)}return null},Blockly.ASTNode.prototype.findPrevForInput_=function(){for(var o,e=this.location_.getParentInput(),t=e.getSourceBlock(),l=t.inputList.indexOf(e);o=t.inputList[l];l--){if(o.connection&&o!==e)return Blockly.ASTNode.createInputNode(o);for(var n,c=o.fieldRow,r=c.length-1;n=c[r];r--)if(n.isClickable()||Blockly.ASTNode.NAVIGATE_ALL_FIELDS)return Blockly.ASTNode.createFieldNode(n)}return null},Blockly.ASTNode.prototype.findPrevForField_=function(){for(var o,e=this.location_,t=e.getParentInput(),l=e.getSourceBlock(),n=l.inputList.indexOf(t),c=t.fieldRow.indexOf(e)-1,r=n;o=l.inputList[r];r--){if(o.connection&&o!==t)return Blockly.ASTNode.createInputNode(o);for(var i=o.fieldRow;c>-1;){if(i[c].isClickable()||Blockly.ASTNode.NAVIGATE_ALL_FIELDS)return Blockly.ASTNode.createFieldNode(i[c]);c--}r-1>=0&&(c=l.inputList[r-1].fieldRow.length-1)}return null},Blockly.ASTNode.prototype.navigateBetweenStacks_=function(o){var e=this.getLocation();if(e instanceof Blockly.Block||(e=e.getSourceBlock()),!e||!e.workspace)return null;for(var t,l=e.getRootBlock(),n=l.workspace.getTopBlocks(!0),c=0;t=n[c];c++)if(l.id==t.id){var r=c+(o?1:-1);return-1==r||r==n.length?null:Blockly.ASTNode.createStackNode(n[r])}throw Error("Couldn't find "+(o?"next":"previous")+" stack?!")},Blockly.ASTNode.prototype.findTopASTNodeForBlock_=function(o){var e=o.previousConnection||o.outputConnection;return e?Blockly.ASTNode.createConnectionNode(e):Blockly.ASTNode.createBlockNode(o)},Blockly.ASTNode.prototype.getOutAstNodeForBlock_=function(o){if(!o)return null;var e,t=(e=o.getTopStackBlock()).previousConnection||e.outputConnection;return t&&t.targetConnection&&t.targetConnection.getParentInput()?Blockly.ASTNode.createInputNode(t.targetConnection.getParentInput()):Blockly.ASTNode.createStackNode(e)},Blockly.ASTNode.prototype.findFirstFieldOrInput_=function(o){for(var e,t=o.inputList,l=0;e=t[l];l++){for(var n,c=e.fieldRow,r=0;n=c[r];r++)if(n.isClickable()||Blockly.ASTNode.NAVIGATE_ALL_FIELDS)return Blockly.ASTNode.createFieldNode(n);if(e.connection)return Blockly.ASTNode.createInputNode(e)}return null},Blockly.ASTNode.prototype.getSourceBlock=function(){return this.getType()===Blockly.ASTNode.types.BLOCK||this.getType()===Blockly.ASTNode.types.STACK?this.getLocation():this.getType()===Blockly.ASTNode.types.WORKSPACE?null:this.getLocation().getSourceBlock()},Blockly.ASTNode.prototype.next=function(){switch(this.type_){case Blockly.ASTNode.types.STACK:return this.navigateBetweenStacks_(!0);case Blockly.ASTNode.types.OUTPUT:var o=this.location_;return Blockly.ASTNode.createBlockNode(o.getSourceBlock());case Blockly.ASTNode.types.FIELD:return this.findNextForField_();case Blockly.ASTNode.types.INPUT:return this.findNextForInput_();case Blockly.ASTNode.types.BLOCK:var e=this.location_.nextConnection;return Blockly.ASTNode.createConnectionNode(e);case Blockly.ASTNode.types.PREVIOUS:o=this.location_;return Blockly.ASTNode.createBlockNode(o.getSourceBlock());case Blockly.ASTNode.types.NEXT:var t=(o=this.location_).targetConnection;return Blockly.ASTNode.createConnectionNode(t)}return null},Blockly.ASTNode.prototype.in=function(){switch(this.type_){case Blockly.ASTNode.types.WORKSPACE:var o=this.location_.getTopBlocks(!0);if(o.length>0)return Blockly.ASTNode.createStackNode(o[0]);break;case Blockly.ASTNode.types.STACK:var e=this.location_;return this.findTopASTNodeForBlock_(e);case Blockly.ASTNode.types.BLOCK:e=this.location_;return this.findFirstFieldOrInput_(e);case Blockly.ASTNode.types.INPUT:var t=this.location_.targetConnection;return Blockly.ASTNode.createConnectionNode(t)}return null},Blockly.ASTNode.prototype.prev=function(){switch(this.type_){case Blockly.ASTNode.types.STACK:return this.navigateBetweenStacks_(!1);case Blockly.ASTNode.types.OUTPUT:return null;case Blockly.ASTNode.types.FIELD:return this.findPrevForField_();case Blockly.ASTNode.types.INPUT:return this.findPrevForInput_();case Blockly.ASTNode.types.BLOCK:var o=this.location_,e=o.previousConnection||o.outputConnection;return Blockly.ASTNode.createConnectionNode(e);case Blockly.ASTNode.types.PREVIOUS:var t=(l=this.location_).targetConnection;if(t&&!t.getParentInput())return Blockly.ASTNode.createConnectionNode(t);break;case Blockly.ASTNode.types.NEXT:var l=this.location_;return Blockly.ASTNode.createBlockNode(l.getSourceBlock())}return null},Blockly.ASTNode.prototype.out=function(){switch(this.type_){case Blockly.ASTNode.types.STACK:var o=(c=this.location_).getRelativeToSurfaceXY(),e=new Blockly.utils.Coordinate(o.x,o.y+Blockly.ASTNode.DEFAULT_OFFSET_Y);return Blockly.ASTNode.createWorkspaceNode(c.workspace,e);case Blockly.ASTNode.types.OUTPUT:var t=(n=this.location_).targetConnection;return t?Blockly.ASTNode.createConnectionNode(t):Blockly.ASTNode.createStackNode(n.getSourceBlock());case Blockly.ASTNode.types.FIELD:var l=this.location_;return Blockly.ASTNode.createBlockNode(l.getSourceBlock());case Blockly.ASTNode.types.INPUT:var n=this.location_;return Blockly.ASTNode.createBlockNode(n.getSourceBlock());case Blockly.ASTNode.types.BLOCK:var c=this.location_;return this.getOutAstNodeForBlock_(c);case Blockly.ASTNode.types.PREVIOUS:n=this.location_;return this.getOutAstNodeForBlock_(n.getSourceBlock());case Blockly.ASTNode.types.NEXT:n=this.location_;return this.getOutAstNodeForBlock_(n.getSourceBlock())}return null};