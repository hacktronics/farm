/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.geras"),goog.provide("Blockly.geras.RenderInfo"),goog.require("Blockly.blockRendering.ExternalValueInput"),goog.require("Blockly.blockRendering.InputRow"),goog.require("Blockly.blockRendering.InRowSpacer"),goog.require("Blockly.blockRendering.RenderInfo"),goog.require("Blockly.blockRendering.Types"),goog.require("Blockly.constants"),goog.require("Blockly.geras.InlineInput"),goog.require("Blockly.geras.StatementInput"),goog.require("Blockly.inputTypes"),goog.require("Blockly.utils.object"),goog.requireType("Blockly.blockRendering.Field"),goog.requireType("Blockly.BlockSvg"),goog.requireType("Blockly.geras.Renderer"),Blockly.geras.RenderInfo=function(e,t){Blockly.geras.RenderInfo.superClass_.constructor.call(this,e,t)},Blockly.utils.object.inherits(Blockly.geras.RenderInfo,Blockly.blockRendering.RenderInfo),Blockly.geras.RenderInfo.prototype.getRenderer=function(){return this.renderer_},Blockly.geras.RenderInfo.prototype.populateBottomRow_=function(){Blockly.geras.RenderInfo.superClass_.populateBottomRow_.call(this),this.block_.inputList.length&&this.block_.inputList[this.block_.inputList.length-1].type==Blockly.inputTypes.STATEMENT||(this.bottomRow.minHeight=this.constants_.MEDIUM_PADDING-this.constants_.DARK_PATH_OFFSET)},Blockly.geras.RenderInfo.prototype.addInput_=function(e,t){this.isInline&&e.type==Blockly.inputTypes.VALUE?(t.elements.push(new Blockly.geras.InlineInput(this.constants_,e)),t.hasInlineInput=!0):e.type==Blockly.inputTypes.STATEMENT?(t.elements.push(new Blockly.geras.StatementInput(this.constants_,e)),t.hasStatement=!0):e.type==Blockly.inputTypes.VALUE?(t.elements.push(new Blockly.blockRendering.ExternalValueInput(this.constants_,e)),t.hasExternalInput=!0):e.type==Blockly.inputTypes.DUMMY&&(t.minHeight=Math.max(t.minHeight,this.constants_.DUMMY_INPUT_MIN_HEIGHT),t.hasDummyInput=!0),this.isInline||null!=t.align||(t.align=e.align)},Blockly.geras.RenderInfo.prototype.addElemSpacing_=function(){for(var e=!1,t=0;n=this.rows[t];t++)n.hasExternalInput&&(e=!0);var n;for(t=0;n=this.rows[t];t++){var s=n.elements;if(n.elements=[],n.startsWithElemSpacer()&&n.elements.push(new Blockly.blockRendering.InRowSpacer(this.constants_,this.getInRowSpacing_(null,s[0]))),s.length){for(var o=0;o<s.length-1;o++){n.elements.push(s[o]);var i=this.getInRowSpacing_(s[o],s[o+1]);n.elements.push(new Blockly.blockRendering.InRowSpacer(this.constants_,i))}if(n.elements.push(s[s.length-1]),n.endsWithElemSpacer()){i=this.getInRowSpacing_(s[s.length-1],null);e&&n.hasDummyInput&&(i+=this.constants_.TAB_WIDTH),n.elements.push(new Blockly.blockRendering.InRowSpacer(this.constants_,i))}}}},Blockly.geras.RenderInfo.prototype.getInRowSpacing_=function(e,t){if(!e)return t&&Blockly.blockRendering.Types.isField(t)&&t.isEditable?this.constants_.MEDIUM_PADDING:t&&Blockly.blockRendering.Types.isInlineInput(t)?this.constants_.MEDIUM_LARGE_PADDING:t&&Blockly.blockRendering.Types.isStatementInput(t)?this.constants_.STATEMENT_INPUT_PADDING_LEFT:this.constants_.LARGE_PADDING;if(!Blockly.blockRendering.Types.isInput(e)&&(!t||Blockly.blockRendering.Types.isStatementInput(t)))return Blockly.blockRendering.Types.isField(e)&&e.isEditable?this.constants_.MEDIUM_PADDING:Blockly.blockRendering.Types.isIcon(e)?2*this.constants_.LARGE_PADDING+1:Blockly.blockRendering.Types.isHat(e)?this.constants_.NO_PADDING:Blockly.blockRendering.Types.isPreviousOrNextConnection(e)?this.constants_.LARGE_PADDING:Blockly.blockRendering.Types.isLeftRoundedCorner(e)?this.constants_.MIN_BLOCK_WIDTH:Blockly.blockRendering.Types.isJaggedEdge(e)?this.constants_.NO_PADDING:this.constants_.LARGE_PADDING;if(Blockly.blockRendering.Types.isInput(e)&&!t){if(Blockly.blockRendering.Types.isExternalInput(e))return this.constants_.NO_PADDING;if(Blockly.blockRendering.Types.isInlineInput(e))return this.constants_.LARGE_PADDING;if(Blockly.blockRendering.Types.isStatementInput(e))return this.constants_.NO_PADDING}if(!Blockly.blockRendering.Types.isInput(e)&&t&&Blockly.blockRendering.Types.isInput(t)){if(Blockly.blockRendering.Types.isField(e)&&e.isEditable){if(Blockly.blockRendering.Types.isInlineInput(t))return this.constants_.SMALL_PADDING;if(Blockly.blockRendering.Types.isExternalInput(t))return this.constants_.SMALL_PADDING}else{if(Blockly.blockRendering.Types.isInlineInput(t))return this.constants_.MEDIUM_LARGE_PADDING;if(Blockly.blockRendering.Types.isExternalInput(t))return this.constants_.MEDIUM_LARGE_PADDING;if(Blockly.blockRendering.Types.isStatementInput(t))return this.constants_.LARGE_PADDING}return this.constants_.LARGE_PADDING-1}if(Blockly.blockRendering.Types.isIcon(e)&&t&&!Blockly.blockRendering.Types.isInput(t))return this.constants_.LARGE_PADDING;if(Blockly.blockRendering.Types.isInlineInput(e)&&t&&Blockly.blockRendering.Types.isField(t))return t.isEditable?this.constants_.MEDIUM_PADDING:this.constants_.LARGE_PADDING;if(Blockly.blockRendering.Types.isLeftSquareCorner(e)&&t){if(Blockly.blockRendering.Types.isHat(t))return this.constants_.NO_PADDING;if(Blockly.blockRendering.Types.isPreviousConnection(t))return t.notchOffset;if(Blockly.blockRendering.Types.isNextConnection(t)){var n=(this.RTL?1:-1)*this.constants_.DARK_PATH_OFFSET/2;return t.notchOffset+n}}if(Blockly.blockRendering.Types.isLeftRoundedCorner(e)&&t){if(Blockly.blockRendering.Types.isPreviousConnection(t))return t.notchOffset-this.constants_.CORNER_RADIUS;if(Blockly.blockRendering.Types.isNextConnection(t)){n=(this.RTL?1:-1)*this.constants_.DARK_PATH_OFFSET/2;return t.notchOffset-this.constants_.CORNER_RADIUS+n}}return Blockly.blockRendering.Types.isField(e)&&t&&Blockly.blockRendering.Types.isField(t)&&e.isEditable==t.isEditable||t&&Blockly.blockRendering.Types.isJaggedEdge(t)?this.constants_.LARGE_PADDING:this.constants_.MEDIUM_PADDING},Blockly.geras.RenderInfo.prototype.getSpacerRowHeight_=function(e,t){return Blockly.blockRendering.Types.isTopRow(e)&&Blockly.blockRendering.Types.isBottomRow(t)?this.constants_.EMPTY_BLOCK_SPACER_HEIGHT:Blockly.blockRendering.Types.isTopRow(e)||Blockly.blockRendering.Types.isBottomRow(t)?this.constants_.NO_PADDING:e.hasExternalInput&&t.hasExternalInput?this.constants_.LARGE_PADDING:!e.hasStatement&&t.hasStatement?this.constants_.BETWEEN_STATEMENT_PADDING_Y:e.hasStatement&&t.hasStatement||!e.hasStatement&&t.hasDummyInput||e.hasDummyInput?this.constants_.LARGE_PADDING:this.constants_.MEDIUM_PADDING},Blockly.geras.RenderInfo.prototype.getElemCenterline_=function(e,t){if(Blockly.blockRendering.Types.isSpacer(t))return e.yPos+t.height/2;if(Blockly.blockRendering.Types.isBottomRow(e)){var n=e.yPos+e.height-e.descenderHeight;return Blockly.blockRendering.Types.isNextConnection(t)?n+t.height/2:n-t.height/2}if(Blockly.blockRendering.Types.isTopRow(e))return Blockly.blockRendering.Types.isHat(t)?e.capline-t.height/2:e.capline+t.height/2;var s=e.yPos;return Blockly.blockRendering.Types.isField(t)||Blockly.blockRendering.Types.isIcon(t)?(s+=t.height/2,(e.hasInlineInput||e.hasStatement)&&t.height+this.constants_.TALL_INPUT_FIELD_OFFSET_Y<=e.height&&(s+=this.constants_.TALL_INPUT_FIELD_OFFSET_Y)):Blockly.blockRendering.Types.isInlineInput(t)?s+=t.height/2:s+=e.height/2,s},Blockly.geras.RenderInfo.prototype.alignRowElements_=function(){if(this.isInline){for(var e=0,t=null,n=this.rows.length-1;s=this.rows[n];n--)s.nextRightEdge=e,Blockly.blockRendering.Types.isInputRow(s)&&(s.hasStatement&&this.alignStatementRow_(s),t&&t.hasStatement&&s.width<t.width?s.nextRightEdge=t.width:e=s.width,t=s);var s,o=0;for(n=0;s=this.rows[n];n++)if(s.hasStatement)o=this.getDesiredRowWidth_(s);else if(Blockly.blockRendering.Types.isSpacer(s))s.width=Math.max(o,s.nextRightEdge);else{var i=s.width,l=Math.max(o,s.nextRightEdge)-i;l>0&&this.addAlignmentPadding_(s,l),o=s.width}}else Blockly.geras.RenderInfo.superClass_.alignRowElements_.call(this)},Blockly.geras.RenderInfo.prototype.getDesiredRowWidth_=function(e){return this.isInline&&e.hasStatement?this.statementEdge+this.constants_.MAX_BOTTOM_WIDTH+this.startX:Blockly.geras.RenderInfo.superClass_.getDesiredRowWidth_.call(this,e)},Blockly.geras.RenderInfo.prototype.finalize_=function(){for(var e,t=0,n=0,s=0;e=this.rows[s];s++){e.yPos=n,e.xPos=this.startX,n+=e.height,t=Math.max(t,e.widthWithConnectedBlocks);var o=n-this.topRow.ascenderHeight;if(e==this.bottomRow&&o<this.constants_.MIN_BLOCK_HEIGHT){var i=this.constants_.MIN_BLOCK_HEIGHT-o;this.bottomRow.height+=i,n+=i}this.recordElemPositions_(e)}this.outputConnection&&this.block_.nextConnection&&this.block_.nextConnection.isConnected()&&(t=Math.max(t,this.block_.nextConnection.targetBlock().getHeightWidth().width-this.constants_.DARK_PATH_OFFSET)),this.bottomRow.baseline=n-this.bottomRow.descenderHeight,this.widthWithChildren=t+this.startX+this.constants_.DARK_PATH_OFFSET,this.width+=this.constants_.DARK_PATH_OFFSET,this.height=n+this.constants_.DARK_PATH_OFFSET,this.startY=this.topRow.capline};