/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.zelos"),goog.provide("Blockly.zelos.RenderInfo"),goog.require("Blockly.blockRendering.InRowSpacer"),goog.require("Blockly.blockRendering.Measurable"),goog.require("Blockly.blockRendering.RenderInfo"),goog.require("Blockly.blockRendering.Types"),goog.require("Blockly.constants"),goog.require("Blockly.FieldImage"),goog.require("Blockly.FieldLabel"),goog.require("Blockly.FieldTextInput"),goog.require("Blockly.inputTypes"),goog.require("Blockly.utils.object"),goog.require("Blockly.zelos.BottomRow"),goog.require("Blockly.zelos.RightConnectionShape"),goog.require("Blockly.zelos.TopRow"),goog.requireType("Blockly.BlockSvg"),goog.requireType("Blockly.zelos.ConstantProvider"),goog.requireType("Blockly.zelos.Renderer"),Blockly.zelos.RenderInfo=function(t,e){Blockly.zelos.RenderInfo.superClass_.constructor.call(this,t,e),this.topRow=new Blockly.zelos.TopRow(this.constants_),this.bottomRow=new Blockly.zelos.BottomRow(this.constants_),this.isInline=!0,this.isMultiRow=!e.getInputsInline()||e.isCollapsed(),this.hasStatementInput=e.statementInputCount>0,this.rightSide=this.outputConnection?new Blockly.zelos.RightConnectionShape(this.constants_):null},Blockly.utils.object.inherits(Blockly.zelos.RenderInfo,Blockly.blockRendering.RenderInfo),Blockly.zelos.RenderInfo.prototype.getRenderer=function(){return this.renderer_},Blockly.zelos.RenderInfo.prototype.measure=function(){this.createRows_(),this.addElemSpacing_(),this.addRowSpacing_(),this.adjustXPosition_(),this.computeBounds_(),this.alignRowElements_(),this.finalize_()},Blockly.zelos.RenderInfo.prototype.shouldStartNewRow_=function(t,e){return!!e&&(t.type==Blockly.inputTypes.STATEMENT||e.type==Blockly.inputTypes.STATEMENT||(t.type==Blockly.inputTypes.VALUE||t.type==Blockly.inputTypes.DUMMY)&&(!this.isInline||this.isMultiRow))},Blockly.zelos.RenderInfo.prototype.getDesiredRowWidth_=function(t){if(t.hasStatement){var e=this.constants_.INSIDE_CORNERS.rightWidth||0;return this.width-this.startX-e}return Blockly.zelos.RenderInfo.superClass_.getDesiredRowWidth_.call(this,t)},Blockly.zelos.RenderInfo.prototype.getInRowSpacing_=function(t,e){return t&&e||!this.outputConnection||!this.outputConnection.isDynamicShape||this.hasStatementInput||this.bottomRow.hasNextConnection?!t&&e&&Blockly.blockRendering.Types.isStatementInput(e)?this.constants_.STATEMENT_INPUT_PADDING_LEFT:t&&Blockly.blockRendering.Types.isLeftRoundedCorner(t)&&e&&(Blockly.blockRendering.Types.isPreviousConnection(e)||Blockly.blockRendering.Types.isNextConnection(e))?e.notchOffset-this.constants_.CORNER_RADIUS:t&&Blockly.blockRendering.Types.isLeftSquareCorner(t)&&e&&Blockly.blockRendering.Types.isHat(e)?this.constants_.NO_PADDING:this.constants_.MEDIUM_PADDING:this.constants_.NO_PADDING},Blockly.zelos.RenderInfo.prototype.getSpacerRowHeight_=function(t,e){if(Blockly.blockRendering.Types.isTopRow(t)&&Blockly.blockRendering.Types.isBottomRow(e))return this.constants_.EMPTY_BLOCK_SPACER_HEIGHT;var n=Blockly.blockRendering.Types.isInputRow(t)&&t.hasStatement,o=Blockly.blockRendering.Types.isInputRow(e)&&e.hasStatement;if(o||n){var i=this.constants_.INSIDE_CORNERS.rightHeight||0,s=Math.max(this.constants_.NOTCH_HEIGHT,i);return o&&n?Math.max(s,this.constants_.DUMMY_INPUT_MIN_HEIGHT):s}return Blockly.blockRendering.Types.isTopRow(t)?t.hasPreviousConnection||this.outputConnection&&!this.hasStatementInput?this.constants_.NO_PADDING:Math.abs(this.constants_.NOTCH_HEIGHT-this.constants_.CORNER_RADIUS):Blockly.blockRendering.Types.isBottomRow(e)?this.outputConnection?!e.hasNextConnection&&this.hasStatementInput?Math.abs(this.constants_.NOTCH_HEIGHT-this.constants_.CORNER_RADIUS):this.constants_.NO_PADDING:Math.max(this.topRow.minHeight,Math.max(this.constants_.NOTCH_HEIGHT,this.constants_.CORNER_RADIUS))-this.constants_.CORNER_RADIUS:this.constants_.MEDIUM_PADDING},Blockly.zelos.RenderInfo.prototype.getSpacerRowWidth_=function(t,e){var n=this.width-this.startX;return Blockly.blockRendering.Types.isInputRow(t)&&t.hasStatement||Blockly.blockRendering.Types.isInputRow(e)&&e.hasStatement?Math.max(n,this.constants_.STATEMENT_INPUT_SPACER_MIN_WIDTH):n},Blockly.zelos.RenderInfo.prototype.getElemCenterline_=function(t,e){if(t.hasStatement&&!Blockly.blockRendering.Types.isSpacer(e)&&!Blockly.blockRendering.Types.isStatementInput(e))return t.yPos+this.constants_.EMPTY_STATEMENT_INPUT_HEIGHT/2;if(Blockly.blockRendering.Types.isInlineInput(e)){var n=e.connectedBlock;if(n&&n.outputConnection&&n.nextConnection)return t.yPos+n.height/2}return Blockly.zelos.RenderInfo.superClass_.getElemCenterline_.call(this,t,e)},Blockly.zelos.RenderInfo.prototype.addInput_=function(t,e){t.type==Blockly.inputTypes.DUMMY&&e.hasDummyInput&&e.align==Blockly.constants.ALIGN.LEFT&&t.align==Blockly.constants.ALIGN.RIGHT&&(e.rightAlignedDummyInput=t),Blockly.zelos.RenderInfo.superClass_.addInput_.call(this,t,e)},Blockly.zelos.RenderInfo.prototype.addAlignmentPadding_=function(t,e){if(t.rightAlignedDummyInput){for(var n,o,i=0;(o=t.elements[i])&&(Blockly.blockRendering.Types.isSpacer(o)&&(n=o),!Blockly.blockRendering.Types.isField(o)||o.parentInput!=t.rightAlignedDummyInput);i++);if(n)return n.width+=e,void(t.width+=e)}Blockly.zelos.RenderInfo.superClass_.addAlignmentPadding_.call(this,t,e)},Blockly.zelos.RenderInfo.prototype.adjustXPosition_=function(){for(var t=this.constants_.NOTCH_OFFSET_LEFT+this.constants_.NOTCH_WIDTH,e=t,n=2;n<this.rows.length-1;n+=2){var o=this.rows[n-1],i=this.rows[n],s=this.rows[n+1],l=2==n?!!this.topRow.hasPreviousConnection:!!o.followsStatement,c=n+2>=this.rows.length-1?!!this.bottomRow.hasNextConnection:!!s.precedesStatement;if(Blockly.blockRendering.Types.isInputRow(i)&&i.hasStatement)i.measure(),e=i.width-i.getLastInput().width+t;else if(l&&(2==n||c)&&Blockly.blockRendering.Types.isInputRow(i)&&!i.hasStatement)for(var h,r=i.xPos,a=null,p=0;h=i.elements[p];p++){if(Blockly.blockRendering.Types.isSpacer(h)&&(a=h),a&&(Blockly.blockRendering.Types.isField(h)||Blockly.blockRendering.Types.isInput(h))&&r<e&&(!Blockly.blockRendering.Types.isField(h)||!(h.field instanceof Blockly.FieldLabel||h.field instanceof Blockly.FieldImage))){var u=e-r;a.width+=u}r+=h.width}}},Blockly.zelos.RenderInfo.prototype.finalizeOutputConnection_=function(){if(this.outputConnection&&this.outputConnection.isDynamicShape){for(var t,e=0,n=0;t=this.rows[n];n++)t.yPos=e,e+=t.height;this.height=e;var o=this.bottomRow.hasNextConnection?this.height-this.bottomRow.descenderHeight:this.height,i=this.outputConnection.shape.height(o),s=this.outputConnection.shape.width(o);this.outputConnection.height=i,this.outputConnection.width=s,this.outputConnection.startX=s,this.outputConnection.connectionOffsetY=this.outputConnection.shape.connectionOffsetY(i),this.outputConnection.connectionOffsetX=this.outputConnection.shape.connectionOffsetX(s);var l=0;this.hasStatementInput||this.bottomRow.hasNextConnection||(l=s,this.rightSide.height=i,this.rightSide.width=l,this.rightSide.centerline=i/2,this.rightSide.xPos=this.width+l),this.startX=s,this.width+=s+l,this.widthWithChildren+=s+l}},Blockly.zelos.RenderInfo.prototype.finalizeHorizontalAlignment_=function(){if(this.outputConnection&&!this.hasStatementInput&&!this.bottomRow.hasNextConnection){for(var t=0,e=0;c=this.rows[e];e++)if(Blockly.blockRendering.Types.isInputRow(c)){var n=c.elements[1],o=c.elements[c.elements.length-2],i=this.getNegativeSpacing_(n),s=this.getNegativeSpacing_(o);t=i+s;var l=this.constants_.MIN_BLOCK_WIDTH+2*this.outputConnection.width;this.width-t<l&&(i=(t=this.width-l)/2,s=t/2),c.elements.unshift(new Blockly.blockRendering.InRowSpacer(this.constants_,-i)),c.elements.push(new Blockly.blockRendering.InRowSpacer(this.constants_,-s))}if(t){this.width-=t,this.widthWithChildren-=t,this.rightSide.xPos-=t;var c;for(e=0;c=this.rows[e];e++)Blockly.blockRendering.Types.isTopOrBottomRow(c)&&(c.elements[1].width-=t,c.elements[1].widthWithConnectedBlocks-=t),c.width-=t,c.widthWithConnectedBlocks-=t}}},Blockly.zelos.RenderInfo.prototype.getNegativeSpacing_=function(t){if(!t)return 0;var e=this.outputConnection.width,n=this.outputConnection.shape.type,o=this.constants_;if(this.isMultiRow&&this.inputRows.length>1){if(n===o.SHAPES.ROUND){var i=this.constants_.MAX_DYNAMIC_CONNECTION_SHAPE_WIDTH,s=this.height/2>i?i:this.height/2,l=this.constants_.SMALL_PADDING;return e-s*(1-Math.sin(Math.acos((s-l)/s)))}return 0}if(Blockly.blockRendering.Types.isInlineInput(t)){var c=t.connectedBlock,h=c?c.pathObject.outputShapeType:t.shape.type;return c&&c.outputConnection&&(c.statementInputCount||c.nextConnection)||n==o.SHAPES.HEXAGONAL&&n!=h?0:e-this.constants_.SHAPE_IN_SHAPE_PADDING[n][h]}return Blockly.blockRendering.Types.isField(t)?n==o.SHAPES.ROUND&&t.field instanceof Blockly.FieldTextInput?e-2.75*o.GRID_UNIT:e-this.constants_.SHAPE_IN_SHAPE_PADDING[n][0]:Blockly.blockRendering.Types.isIcon(t)?this.constants_.SMALL_PADDING:0},Blockly.zelos.RenderInfo.prototype.finalizeVerticalAlignment_=function(){if(!this.outputConnection)for(var t=2;t<this.rows.length-1;t+=2){var e=this.rows[t-1],n=this.rows[t],o=this.rows[t+1],i=2==t,s=i?!!this.topRow.hasPreviousConnection:!!e.followsStatement,l=t+2>=this.rows.length-1?!!this.bottomRow.hasNextConnection:!!o.precedesStatement;if(s){var c=3==n.elements.length&&(n.elements[1].field instanceof Blockly.FieldLabel||n.elements[1].field instanceof Blockly.FieldImage);if(!i&&c)e.height-=this.constants_.SMALL_PADDING,o.height-=this.constants_.SMALL_PADDING,n.height-=this.constants_.MEDIUM_PADDING;else if(i||l){if(l){for(var h,r=!1,a=0;h=n.elements[a];a++)if(Blockly.blockRendering.Types.isInlineInput(h)&&h.connectedBlock&&!h.connectedBlock.isShadow()&&h.connectedBlock.getHeightWidth().height>=40){r=!0;break}r&&(e.height-=this.constants_.SMALL_PADDING,o.height-=this.constants_.SMALL_PADDING)}}else e.height+=this.constants_.SMALL_PADDING}}},Blockly.zelos.RenderInfo.prototype.finalize_=function(){this.finalizeOutputConnection_(),this.finalizeHorizontalAlignment_(),this.finalizeVerticalAlignment_(),Blockly.zelos.RenderInfo.superClass_.finalize_.call(this),this.rightSide&&(this.widthWithChildren+=this.rightSide.width)};