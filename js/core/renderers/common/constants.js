/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.blockRendering.ConstantProvider"),goog.require("Blockly.connectionTypes"),goog.require("Blockly.constants"),goog.require("Blockly.utils"),goog.require("Blockly.utils.colour"),goog.require("Blockly.utils.dom"),goog.require("Blockly.utils.Svg"),goog.require("Blockly.utils.svgPaths"),goog.require("Blockly.utils.userAgent"),goog.requireType("Blockly.blockRendering.Debug"),goog.requireType("Blockly.RenderedConnection"),goog.requireType("Blockly.Theme"),Blockly.blockRendering.ConstantProvider=function(){this.NO_PADDING=0,this.SMALL_PADDING=3,this.MEDIUM_PADDING=5,this.MEDIUM_LARGE_PADDING=8,this.LARGE_PADDING=10,this.TALL_INPUT_FIELD_OFFSET_Y=this.MEDIUM_PADDING,this.TAB_HEIGHT=15,this.TAB_OFFSET_FROM_TOP=5,this.TAB_VERTICAL_OVERLAP=2.5,this.TAB_WIDTH=8,this.NOTCH_WIDTH=15,this.NOTCH_HEIGHT=4,this.MIN_BLOCK_WIDTH=12,this.EMPTY_BLOCK_SPACER_HEIGHT=16,this.DUMMY_INPUT_MIN_HEIGHT=this.TAB_HEIGHT,this.DUMMY_INPUT_SHADOW_MIN_HEIGHT=this.TAB_HEIGHT,this.CORNER_RADIUS=8,this.NOTCH_OFFSET_LEFT=15,this.STATEMENT_INPUT_NOTCH_OFFSET=this.NOTCH_OFFSET_LEFT,this.STATEMENT_BOTTOM_SPACER=0,this.STATEMENT_INPUT_PADDING_LEFT=20,this.BETWEEN_STATEMENT_PADDING_Y=4,this.TOP_ROW_MIN_HEIGHT=this.MEDIUM_PADDING,this.TOP_ROW_PRECEDES_STATEMENT_MIN_HEIGHT=this.LARGE_PADDING,this.BOTTOM_ROW_MIN_HEIGHT=this.MEDIUM_PADDING,this.BOTTOM_ROW_AFTER_STATEMENT_MIN_HEIGHT=this.LARGE_PADDING,this.ADD_START_HATS=!1,this.START_HAT_HEIGHT=15,this.START_HAT_WIDTH=100,this.SPACER_DEFAULT_HEIGHT=15,this.MIN_BLOCK_HEIGHT=24,this.EMPTY_INLINE_INPUT_PADDING=14.5,this.EMPTY_INLINE_INPUT_HEIGHT=this.TAB_HEIGHT+11,this.EXTERNAL_VALUE_INPUT_PADDING=2,this.EMPTY_STATEMENT_INPUT_HEIGHT=this.MIN_BLOCK_HEIGHT,this.START_POINT=Blockly.utils.svgPaths.moveBy(0,0),this.JAGGED_TEETH_HEIGHT=12,this.JAGGED_TEETH_WIDTH=6,this.FIELD_TEXT_FONTSIZE=11,this.FIELD_TEXT_FONTWEIGHT="normal",this.FIELD_TEXT_FONTFAMILY="sans-serif",this.FIELD_TEXT_HEIGHT=-1,this.FIELD_TEXT_BASELINE=-1,this.FIELD_BORDER_RECT_RADIUS=4,this.FIELD_BORDER_RECT_HEIGHT=16,this.FIELD_BORDER_RECT_X_PADDING=5,this.FIELD_BORDER_RECT_Y_PADDING=3,this.FIELD_BORDER_RECT_COLOUR="#fff",this.FIELD_TEXT_BASELINE_CENTER=!Blockly.utils.userAgent.IE&&!Blockly.utils.userAgent.EDGE,this.FIELD_DROPDOWN_BORDER_RECT_HEIGHT=this.FIELD_BORDER_RECT_HEIGHT,this.FIELD_DROPDOWN_NO_BORDER_RECT_SHADOW=!1,this.FIELD_DROPDOWN_COLOURED_DIV=!1,this.FIELD_DROPDOWN_SVG_ARROW=!1,this.FIELD_DROPDOWN_SVG_ARROW_PADDING=this.FIELD_BORDER_RECT_X_PADDING,this.FIELD_DROPDOWN_SVG_ARROW_SIZE=12,this.FIELD_DROPDOWN_SVG_ARROW_DATAURI="data:image/svg+xml;base64,PHN2ZyBpZD0iTGF5ZXJfMSIgZGF0YS1uYW1lPSJMYXllciAxIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMi43MSIgaGVpZ2h0PSI4Ljc5IiB2aWV3Qm94PSIwIDAgMTIuNzEgOC43OSI+PHRpdGxlPmRyb3Bkb3duLWFycm93PC90aXRsZT48ZyBvcGFjaXR5PSIwLjEiPjxwYXRoIGQ9Ik0xMi43MSwyLjQ0QTIuNDEsMi40MSwwLDAsMSwxMiw0LjE2TDguMDgsOC4wOGEyLjQ1LDIuNDUsMCwwLDEtMy40NSwwTDAuNzIsNC4xNkEyLjQyLDIuNDIsMCwwLDEsMCwyLjQ0LDIuNDgsMi40OCwwLDAsMSwuNzEuNzFDMSwwLjQ3LDEuNDMsMCw2LjM2LDBTMTEuNzUsMC40NiwxMiwuNzFBMi40NCwyLjQ0LDAsMCwxLDEyLjcxLDIuNDRaIiBmaWxsPSIjMjMxZjIwIi8+PC9nPjxwYXRoIGQ9Ik02LjM2LDcuNzlhMS40MywxLjQzLDAsMCwxLTEtLjQyTDEuNDIsMy40NWExLjQ0LDEuNDQsMCwwLDEsMC0yYzAuNTYtLjU2LDkuMzEtMC41Niw5Ljg3LDBhMS40NCwxLjQ0LDAsMCwxLDAsMkw3LjM3LDcuMzdBMS40MywxLjQzLDAsMCwxLDYuMzYsNy43OVoiIGZpbGw9IiNmZmYiLz48L3N2Zz4=",this.FIELD_TEXTINPUT_BOX_SHADOW=!1,this.FIELD_COLOUR_FULL_BLOCK=!1,this.FIELD_COLOUR_DEFAULT_WIDTH=26,this.FIELD_COLOUR_DEFAULT_HEIGHT=this.FIELD_BORDER_RECT_HEIGHT,this.FIELD_CHECKBOX_X_OFFSET=this.FIELD_BORDER_RECT_X_PADDING-3,this.randomIdentifier=String(Math.random()).substring(2),this.embossFilterId="",this.embossFilter_=null,this.disabledPatternId="",this.disabledPattern_=null,this.debugFilterId="",this.debugFilter_=null,this.cssNode_=null,this.CURSOR_COLOUR="#cc0a0a",this.MARKER_COLOUR="#4286f4",this.CURSOR_WS_WIDTH=100,this.WS_CURSOR_HEIGHT=5,this.CURSOR_STACK_PADDING=10,this.CURSOR_BLOCK_PADDING=2,this.CURSOR_STROKE_WIDTH=4,this.FULL_BLOCK_FIELDS=!1,this.INSERTION_MARKER_COLOUR="#000000",this.INSERTION_MARKER_OPACITY=.2,this.SHAPES={PUZZLE:1,NOTCH:2}},Blockly.blockRendering.ConstantProvider.prototype.init=function(){this.JAGGED_TEETH=this.makeJaggedTeeth(),this.NOTCH=this.makeNotch(),this.START_HAT=this.makeStartHat(),this.PUZZLE_TAB=this.makePuzzleTab(),this.INSIDE_CORNERS=this.makeInsideCorners(),this.OUTSIDE_CORNERS=this.makeOutsideCorners()},Blockly.blockRendering.ConstantProvider.prototype.setTheme=function(t){this.blockStyles=Object.create(null);var l=t.blockStyles;for(var o in l)this.blockStyles[o]=this.validatedBlockStyle_(l[o]);this.setDynamicProperties_(t)},Blockly.blockRendering.ConstantProvider.prototype.setDynamicProperties_=function(t){this.setFontConstants_(t),this.setComponentConstants_(t),this.ADD_START_HATS=null!=t.startHats?t.startHats:this.ADD_START_HATS},Blockly.blockRendering.ConstantProvider.prototype.setFontConstants_=function(t){this.FIELD_TEXT_FONTFAMILY=t.fontStyle&&null!=t.fontStyle.family?t.fontStyle.family:this.FIELD_TEXT_FONTFAMILY,this.FIELD_TEXT_FONTWEIGHT=t.fontStyle&&null!=t.fontStyle.weight?t.fontStyle.weight:this.FIELD_TEXT_FONTWEIGHT,this.FIELD_TEXT_FONTSIZE=t.fontStyle&&null!=t.fontStyle.size?t.fontStyle.size:this.FIELD_TEXT_FONTSIZE;var l=Blockly.utils.dom.measureFontMetrics("Hg",this.FIELD_TEXT_FONTSIZE+"pt",this.FIELD_TEXT_FONTWEIGHT,this.FIELD_TEXT_FONTFAMILY);this.FIELD_TEXT_HEIGHT=l.height,this.FIELD_TEXT_BASELINE=l.baseline},Blockly.blockRendering.ConstantProvider.prototype.setComponentConstants_=function(t){this.CURSOR_COLOUR=t.getComponentStyle("cursorColour")||this.CURSOR_COLOUR,this.MARKER_COLOUR=t.getComponentStyle("markerColour")||this.MARKER_COLOUR,this.INSERTION_MARKER_COLOUR=t.getComponentStyle("insertionMarkerColour")||this.INSERTION_MARKER_COLOUR,this.INSERTION_MARKER_OPACITY=Number(t.getComponentStyle("insertionMarkerOpacity"))||this.INSERTION_MARKER_OPACITY},Blockly.blockRendering.ConstantProvider.prototype.getBlockStyleForColour=function(t){var l="auto_"+t;return this.blockStyles[l]||(this.blockStyles[l]=this.createBlockStyle_(t)),{style:this.blockStyles[l],name:l}},Blockly.blockRendering.ConstantProvider.prototype.getBlockStyle=function(t){return this.blockStyles[t||""]||(t&&0==t.indexOf("auto_")?this.getBlockStyleForColour(t.substring(5)).style:this.createBlockStyle_("#000000"))},Blockly.blockRendering.ConstantProvider.prototype.createBlockStyle_=function(t){return this.validatedBlockStyle_({colourPrimary:t})},Blockly.blockRendering.ConstantProvider.prototype.validatedBlockStyle_=function(t){var l={};t&&Blockly.utils.object.mixin(l,t);var o=Blockly.utils.parseBlockColour(l.colourPrimary||"#000");return l.colourPrimary=o.hex,l.colourSecondary=l.colourSecondary?Blockly.utils.parseBlockColour(l.colourSecondary).hex:this.generateSecondaryColour_(l.colourPrimary),l.colourTertiary=l.colourTertiary?Blockly.utils.parseBlockColour(l.colourTertiary).hex:this.generateTertiaryColour_(l.colourPrimary),l.hat=l.hat||"",l},Blockly.blockRendering.ConstantProvider.prototype.generateSecondaryColour_=function(t){return Blockly.utils.colour.blend("#fff",t,.6)||t},Blockly.blockRendering.ConstantProvider.prototype.generateTertiaryColour_=function(t){return Blockly.utils.colour.blend("#fff",t,.3)||t},Blockly.blockRendering.ConstantProvider.prototype.dispose=function(){this.embossFilter_&&Blockly.utils.dom.removeNode(this.embossFilter_),this.disabledPattern_&&Blockly.utils.dom.removeNode(this.disabledPattern_),this.debugFilter_&&Blockly.utils.dom.removeNode(this.debugFilter_),this.cssNode_=null},Blockly.blockRendering.ConstantProvider.prototype.makeJaggedTeeth=function(){var t=this.JAGGED_TEETH_HEIGHT,l=this.JAGGED_TEETH_WIDTH;return{height:t,width:l,path:Blockly.utils.svgPaths.line([Blockly.utils.svgPaths.point(l,t/4),Blockly.utils.svgPaths.point(2*-l,t/2),Blockly.utils.svgPaths.point(l,t/4)])}},Blockly.blockRendering.ConstantProvider.prototype.makeStartHat=function(){var t=this.START_HAT_HEIGHT,l=this.START_HAT_WIDTH;return{height:t,width:l,path:Blockly.utils.svgPaths.curve("c",[Blockly.utils.svgPaths.point(30,-t),Blockly.utils.svgPaths.point(70,-t),Blockly.utils.svgPaths.point(l,0)])}},Blockly.blockRendering.ConstantProvider.prototype.makePuzzleTab=function(){var t=this.TAB_WIDTH,l=this.TAB_HEIGHT;function o(o){var e=o?-1:1,i=-e,s=l/2,r=s+2.5,n=s+.5,c=Blockly.utils.svgPaths.point(-t,e*s),T=Blockly.utils.svgPaths.point(t,e*s);return Blockly.utils.svgPaths.curve("c",[Blockly.utils.svgPaths.point(0,e*r),Blockly.utils.svgPaths.point(-t,i*n),c])+Blockly.utils.svgPaths.curve("s",[Blockly.utils.svgPaths.point(t,2.5*i),T])}var e=o(!0),i=o(!1);return{type:this.SHAPES.PUZZLE,width:t,height:l,pathDown:i,pathUp:e}},Blockly.blockRendering.ConstantProvider.prototype.makeNotch=function(){var t=this.NOTCH_WIDTH,l=this.NOTCH_HEIGHT,o=(t-3)/2;function e(t){return Blockly.utils.svgPaths.line([Blockly.utils.svgPaths.point(t*o,l),Blockly.utils.svgPaths.point(3*t,0),Blockly.utils.svgPaths.point(t*o,-l)])}var i=e(1),s=e(-1);return{type:this.SHAPES.NOTCH,width:t,height:l,pathLeft:i,pathRight:s}},Blockly.blockRendering.ConstantProvider.prototype.makeInsideCorners=function(){var t=this.CORNER_RADIUS;return{width:t,height:t,pathTop:Blockly.utils.svgPaths.arc("a","0 0,0",t,Blockly.utils.svgPaths.point(-t,t)),pathBottom:Blockly.utils.svgPaths.arc("a","0 0,0",t,Blockly.utils.svgPaths.point(t,t))}},Blockly.blockRendering.ConstantProvider.prototype.makeOutsideCorners=function(){var t=this.CORNER_RADIUS,l=Blockly.utils.svgPaths.moveBy(0,t)+Blockly.utils.svgPaths.arc("a","0 0,1",t,Blockly.utils.svgPaths.point(t,-t)),o=Blockly.utils.svgPaths.arc("a","0 0,1",t,Blockly.utils.svgPaths.point(t,t)),e=Blockly.utils.svgPaths.arc("a","0 0,1",t,Blockly.utils.svgPaths.point(-t,-t));return{topLeft:l,topRight:o,bottomRight:Blockly.utils.svgPaths.arc("a","0 0,1",t,Blockly.utils.svgPaths.point(-t,t)),bottomLeft:e,rightHeight:t}},Blockly.blockRendering.ConstantProvider.prototype.shapeFor=function(t){switch(t.type){case Blockly.connectionTypes.INPUT_VALUE:case Blockly.connectionTypes.OUTPUT_VALUE:return this.PUZZLE_TAB;case Blockly.connectionTypes.PREVIOUS_STATEMENT:case Blockly.connectionTypes.NEXT_STATEMENT:return this.NOTCH;default:throw Error("Unknown connection type")}},Blockly.blockRendering.ConstantProvider.prototype.createDom=function(t,l,o){this.injectCSS_(l,o);var e=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.DEFS,{},t),i=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.FILTER,{id:"blocklyEmbossFilter"+this.randomIdentifier},e);Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.FEGAUSSIANBLUR,{in:"SourceAlpha",stdDeviation:1,result:"blur"},i);var s=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.FESPECULARLIGHTING,{in:"blur",surfaceScale:1,specularConstant:.5,specularExponent:10,"lighting-color":"white",result:"specOut"},i);Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.FEPOINTLIGHT,{x:-5e3,y:-1e4,z:2e4},s),Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.FECOMPOSITE,{in:"specOut",in2:"SourceAlpha",operator:"in",result:"specOut"},i),Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.FECOMPOSITE,{in:"SourceGraphic",in2:"specOut",operator:"arithmetic",k1:0,k2:1,k3:1,k4:0},i),this.embossFilterId=i.id,this.embossFilter_=i;var r=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.PATTERN,{id:"blocklyDisabledPattern"+this.randomIdentifier,patternUnits:"userSpaceOnUse",width:10,height:10},e);if(Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.RECT,{width:10,height:10,fill:"#aaa"},r),Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.PATH,{d:"M 0 0 L 10 10 M 10 0 L 0 10",stroke:"#cc0"},r),this.disabledPatternId=r.id,this.disabledPattern_=r,Blockly.blockRendering.Debug){var n=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.FILTER,{id:"blocklyDebugFilter"+this.randomIdentifier,height:"160%",width:"180%",y:"-30%",x:"-40%"},e),c=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.FECOMPONENTTRANSFER,{result:"outBlur"},n);Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.FEFUNCA,{type:"table",tableValues:"0 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1"},c),Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.FEFLOOD,{"flood-color":"#ff0000","flood-opacity":.5,result:"outColor"},n),Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.FECOMPOSITE,{in:"outColor",in2:"outBlur",operator:"in",result:"outGlow"},n),this.debugFilterId=n.id,this.debugFilter_=n}},Blockly.blockRendering.ConstantProvider.prototype.injectCSS_=function(t,l){var o=this.getCSS_(l),e="blockly-renderer-style-"+t;this.cssNode_=document.getElementById(e);var i=o.join("\n");if(this.cssNode_)this.cssNode_.firstChild.textContent=i;else{var s=document.createElement("style");s.id=e;var r=document.createTextNode(i);s.appendChild(r),document.head.insertBefore(s,document.head.firstChild),this.cssNode_=s}},Blockly.blockRendering.ConstantProvider.prototype.getCSS_=function(t){return[t+" .blocklyText, ",t+" .blocklyFlyoutLabelText {","font: "+this.FIELD_TEXT_FONTWEIGHT+" "+this.FIELD_TEXT_FONTSIZE+"pt "+this.FIELD_TEXT_FONTFAMILY+";","}",t+" .blocklyText {","fill: #fff;","}",t+" .blocklyNonEditableText>rect,",t+" .blocklyEditableText>rect {","fill: "+this.FIELD_BORDER_RECT_COLOUR+";","fill-opacity: .6;","stroke: none;","}",t+" .blocklyNonEditableText>text,",t+" .blocklyEditableText>text {","fill: #000;","}",t+" .blocklyFlyoutLabelText {","fill: #000;","}",t+" .blocklyText.blocklyBubbleText {","fill: #000;","}",t+" .blocklyEditableText:not(.editing):hover>rect {","stroke: #fff;","stroke-width: 2;","}",t+" .blocklyHtmlInput {","font-family: "+this.FIELD_TEXT_FONTFAMILY+";","font-weight: "+this.FIELD_TEXT_FONTWEIGHT+";","}",t+" .blocklySelected>.blocklyPath {","stroke: #fc3;","stroke-width: 3px;","}",t+" .blocklyHighlightedConnectionPath {","stroke: #fc3;","}",t+" .blocklyReplaceable .blocklyPath {","fill-opacity: .5;","}",t+" .blocklyReplaceable .blocklyPathLight,",t+" .blocklyReplaceable .blocklyPathDark {","display: none;","}",t+" .blocklyInsertionMarker>.blocklyPath {","fill-opacity: "+this.INSERTION_MARKER_OPACITY+";","stroke: none;","}"]};