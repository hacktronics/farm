/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.blockRendering.MarkerSvg"),goog.require("Blockly.ASTNode"),goog.require("Blockly.connectionTypes"),goog.require("Blockly.constants"),goog.require("Blockly.Events"),goog.require("Blockly.Events.MarkerMove"),goog.require("Blockly.utils.dom"),goog.require("Blockly.utils.Svg"),goog.requireType("Blockly.blockRendering.ConstantProvider"),goog.requireType("Blockly.BlockSvg"),goog.requireType("Blockly.Connection"),goog.requireType("Blockly.Field"),goog.requireType("Blockly.IASTNodeLocationSvg"),goog.requireType("Blockly.Marker"),goog.requireType("Blockly.RenderedConnection"),goog.requireType("Blockly.WorkspaceSvg"),Blockly.blockRendering.MarkerSvg=function(t,e,o){this.workspace_=t,this.marker_=o,this.parent_=null,this.constants_=e,this.currentMarkerSvg=null;var r=this.isCursor()?this.constants_.CURSOR_COLOUR:this.constants_.MARKER_COLOUR;this.colour_=o.colour||r},Blockly.blockRendering.MarkerSvg.CURSOR_CLASS="blocklyCursor",Blockly.blockRendering.MarkerSvg.MARKER_CLASS="blocklyMarker",Blockly.blockRendering.MarkerSvg.HEIGHT_MULTIPLIER=3/4,Blockly.blockRendering.MarkerSvg.prototype.getSvgRoot=function(){return this.svgGroup_},Blockly.blockRendering.MarkerSvg.prototype.getMarker=function(){return this.marker_},Blockly.blockRendering.MarkerSvg.prototype.isCursor=function(){return"cursor"==this.marker_.type},Blockly.blockRendering.MarkerSvg.prototype.createDom=function(){var t=this.isCursor()?Blockly.blockRendering.MarkerSvg.CURSOR_CLASS:Blockly.blockRendering.MarkerSvg.MARKER_CLASS;return this.svgGroup_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.G,{class:t},null),this.createDomInternal_(),this.svgGroup_},Blockly.blockRendering.MarkerSvg.prototype.setParent_=function(t){this.isCursor()?(this.parent_&&this.parent_.setCursorSvg(null),t.setCursorSvg(this.getSvgRoot())):(this.parent_&&this.parent_.setMarkerSvg(null),t.setMarkerSvg(this.getSvgRoot())),this.parent_=t},Blockly.blockRendering.MarkerSvg.prototype.draw=function(t,e){if(e){this.constants_=this.workspace_.getRenderer().getConstants();var o=this.isCursor()?this.constants_.CURSOR_COLOUR:this.constants_.MARKER_COLOUR;this.colour_=this.marker_.colour||o,this.applyColour_(e),this.showAtLocation_(e),this.fireMarkerEvent_(t,e);var r=this.currentMarkerSvg.childNodes[0];void 0!==r&&r.beginElement&&r.beginElement()}else this.hide()},Blockly.blockRendering.MarkerSvg.prototype.showAtLocation_=function(t){var e=t.getLocation().type;t.getType()==Blockly.ASTNode.types.BLOCK?this.showWithBlock_(t):t.getType()==Blockly.ASTNode.types.OUTPUT?this.showWithOutput_(t):e==Blockly.connectionTypes.INPUT_VALUE?this.showWithInput_(t):e==Blockly.connectionTypes.NEXT_STATEMENT?this.showWithNext_(t):t.getType()==Blockly.ASTNode.types.PREVIOUS?this.showWithPrevious_(t):t.getType()==Blockly.ASTNode.types.FIELD?this.showWithField_(t):t.getType()==Blockly.ASTNode.types.WORKSPACE?this.showWithCoordinates_(t):t.getType()==Blockly.ASTNode.types.STACK&&this.showWithStack_(t)},Blockly.blockRendering.MarkerSvg.prototype.showWithBlockPrevOutput_=function(t){var e=t.getSourceBlock(),o=e.width,r=e.height,i=r*Blockly.blockRendering.MarkerSvg.HEIGHT_MULTIPLIER,s=this.constants_.CURSOR_BLOCK_PADDING;if(e.previousConnection){var l=this.constants_.shapeFor(e.previousConnection);this.positionPrevious_(o,s,i,l)}else if(e.outputConnection){l=this.constants_.shapeFor(e.outputConnection);this.positionOutput_(o,r,l)}else this.positionBlock_(o,s,i);this.setParent_(e),this.showCurrent_()},Blockly.blockRendering.MarkerSvg.prototype.showWithBlock_=function(t){this.showWithBlockPrevOutput_(t)},Blockly.blockRendering.MarkerSvg.prototype.showWithPrevious_=function(t){this.showWithBlockPrevOutput_(t)},Blockly.blockRendering.MarkerSvg.prototype.showWithOutput_=function(t){this.showWithBlockPrevOutput_(t)},Blockly.blockRendering.MarkerSvg.prototype.showWithCoordinates_=function(t){var e=t.getWsCoordinate(),o=e.x,r=e.y;this.workspace_.RTL&&(o-=this.constants_.CURSOR_WS_WIDTH),this.positionLine_(o,r,this.constants_.CURSOR_WS_WIDTH),this.setParent_(this.workspace_),this.showCurrent_()},Blockly.blockRendering.MarkerSvg.prototype.showWithField_=function(t){var e=t.getLocation(),o=e.getSize().width,r=e.getSize().height;this.positionRect_(0,0,o,r),this.setParent_(e),this.showCurrent_()},Blockly.blockRendering.MarkerSvg.prototype.showWithInput_=function(t){var e=t.getLocation(),o=e.getSourceBlock();this.positionInput_(e),this.setParent_(o),this.showCurrent_()},Blockly.blockRendering.MarkerSvg.prototype.showWithNext_=function(t){var e=t.getLocation(),o=e.getSourceBlock(),r=0,i=e.getOffsetInBlock().y,s=o.getHeightWidth().width;this.workspace_.RTL&&(r=-s),this.positionLine_(r,i,s),this.setParent_(o),this.showCurrent_()},Blockly.blockRendering.MarkerSvg.prototype.showWithStack_=function(t){var e=t.getLocation(),o=e.getHeightWidth(),r=o.width+this.constants_.CURSOR_STACK_PADDING,i=o.height+this.constants_.CURSOR_STACK_PADDING,s=-this.constants_.CURSOR_STACK_PADDING/2,l=s,n=-this.constants_.CURSOR_STACK_PADDING/2;this.workspace_.RTL&&(l=-(r+s)),this.positionRect_(l,n,r,i),this.setParent_(e),this.showCurrent_()},Blockly.blockRendering.MarkerSvg.prototype.showCurrent_=function(){this.hide(),this.currentMarkerSvg.style.display=""},Blockly.blockRendering.MarkerSvg.prototype.positionBlock_=function(t,e,o){var r=Blockly.utils.svgPaths.moveBy(-e,o)+Blockly.utils.svgPaths.lineOnAxis("V",-e)+Blockly.utils.svgPaths.lineOnAxis("H",t+2*e)+Blockly.utils.svgPaths.lineOnAxis("V",o);this.markerBlock_.setAttribute("d",r),this.workspace_.RTL&&this.flipRtl_(this.markerBlock_),this.currentMarkerSvg=this.markerBlock_},Blockly.blockRendering.MarkerSvg.prototype.positionInput_=function(t){var e=t.getOffsetInBlock().x,o=t.getOffsetInBlock().y,r=Blockly.utils.svgPaths.moveTo(0,0)+this.constants_.shapeFor(t).pathDown;this.markerInput_.setAttribute("d",r),this.markerInput_.setAttribute("transform","translate("+e+","+o+")"+(this.workspace_.RTL?" scale(-1 1)":"")),this.currentMarkerSvg=this.markerInput_},Blockly.blockRendering.MarkerSvg.prototype.positionLine_=function(t,e,o){this.markerSvgLine_.setAttribute("x",t),this.markerSvgLine_.setAttribute("y",e),this.markerSvgLine_.setAttribute("width",o),this.currentMarkerSvg=this.markerSvgLine_},Blockly.blockRendering.MarkerSvg.prototype.positionOutput_=function(t,e,o){var r=Blockly.utils.svgPaths.moveBy(t,0)+Blockly.utils.svgPaths.lineOnAxis("h",-(t-o.width))+Blockly.utils.svgPaths.lineOnAxis("v",this.constants_.TAB_OFFSET_FROM_TOP)+o.pathDown+Blockly.utils.svgPaths.lineOnAxis("V",e)+Blockly.utils.svgPaths.lineOnAxis("H",t);this.markerBlock_.setAttribute("d",r),this.workspace_.RTL&&this.flipRtl_(this.markerBlock_),this.currentMarkerSvg=this.markerBlock_},Blockly.blockRendering.MarkerSvg.prototype.positionPrevious_=function(t,e,o,r){var i=Blockly.utils.svgPaths.moveBy(-e,o)+Blockly.utils.svgPaths.lineOnAxis("V",-e)+Blockly.utils.svgPaths.lineOnAxis("H",this.constants_.NOTCH_OFFSET_LEFT)+r.pathLeft+Blockly.utils.svgPaths.lineOnAxis("H",t+2*e)+Blockly.utils.svgPaths.lineOnAxis("V",o);this.markerBlock_.setAttribute("d",i),this.workspace_.RTL&&this.flipRtl_(this.markerBlock_),this.currentMarkerSvg=this.markerBlock_},Blockly.blockRendering.MarkerSvg.prototype.positionRect_=function(t,e,o,r){this.markerSvgRect_.setAttribute("x",t),this.markerSvgRect_.setAttribute("y",e),this.markerSvgRect_.setAttribute("width",o),this.markerSvgRect_.setAttribute("height",r),this.currentMarkerSvg=this.markerSvgRect_},Blockly.blockRendering.MarkerSvg.prototype.flipRtl_=function(t){t.setAttribute("transform","scale(-1 1)")},Blockly.blockRendering.MarkerSvg.prototype.hide=function(){this.markerSvgLine_.style.display="none",this.markerSvgRect_.style.display="none",this.markerInput_.style.display="none",this.markerBlock_.style.display="none"},Blockly.blockRendering.MarkerSvg.prototype.fireMarkerEvent_=function(t,e){var o=e.getSourceBlock(),r=new(Blockly.Events.get(Blockly.Events.MARKER_MOVE))(o,this.isCursor(),t,e);Blockly.Events.fire(r)},Blockly.blockRendering.MarkerSvg.prototype.getBlinkProperties_=function(){return{attributeType:"XML",attributeName:"fill",dur:"1s",values:this.colour_+";transparent;transparent;",repeatCount:"indefinite"}},Blockly.blockRendering.MarkerSvg.prototype.createDomInternal_=function(){if(this.markerSvg_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.G,{width:this.constants_.CURSOR_WS_WIDTH,height:this.constants_.WS_CURSOR_HEIGHT},this.svgGroup_),this.markerSvgLine_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.RECT,{width:this.constants_.CURSOR_WS_WIDTH,height:this.constants_.WS_CURSOR_HEIGHT,style:"display: none"},this.markerSvg_),this.markerSvgRect_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.RECT,{class:"blocklyVerticalMarker",rx:10,ry:10,style:"display: none"},this.markerSvg_),this.markerInput_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.PATH,{transform:"",style:"display: none"},this.markerSvg_),this.markerBlock_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.PATH,{transform:"",style:"display: none",fill:"none","stroke-width":this.constants_.CURSOR_STROKE_WIDTH},this.markerSvg_),this.isCursor()){var t=this.getBlinkProperties_();Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.ANIMATE,t,this.markerSvgLine_),Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.ANIMATE,t,this.markerInput_),t.attributeName="stroke",Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.ANIMATE,t,this.markerBlock_)}return this.markerSvg_},Blockly.blockRendering.MarkerSvg.prototype.applyColour_=function(t){if(this.markerSvgLine_.setAttribute("fill",this.colour_),this.markerSvgRect_.setAttribute("stroke",this.colour_),this.markerInput_.setAttribute("fill",this.colour_),this.markerBlock_.setAttribute("stroke",this.colour_),this.isCursor()){var e=this.colour_+";transparent;transparent;";this.markerSvgLine_.firstChild.setAttribute("values",e),this.markerInput_.firstChild.setAttribute("values",e),this.markerBlock_.firstChild.setAttribute("values",e)}},Blockly.blockRendering.MarkerSvg.prototype.dispose=function(){this.svgGroup_&&Blockly.utils.dom.removeNode(this.svgGroup_)};