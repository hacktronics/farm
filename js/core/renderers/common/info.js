/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.blockRendering.RenderInfo"),goog.require("Blockly.blockRendering.BottomRow"),goog.require("Blockly.blockRendering.ExternalValueInput"),goog.require("Blockly.blockRendering.Field"),goog.require("Blockly.blockRendering.Hat"),goog.require("Blockly.blockRendering.InlineInput"),goog.require("Blockly.blockRendering.InputRow"),goog.require("Blockly.blockRendering.InRowSpacer"),goog.require("Blockly.blockRendering.JaggedEdge"),goog.require("Blockly.blockRendering.Measurable"),goog.require("Blockly.blockRendering.NextConnection"),goog.require("Blockly.blockRendering.OutputConnection"),goog.require("Blockly.blockRendering.PreviousConnection"),goog.require("Blockly.blockRendering.RoundCorner"),goog.require("Blockly.blockRendering.Row"),goog.require("Blockly.blockRendering.SpacerRow"),goog.require("Blockly.blockRendering.SquareCorner"),goog.require("Blockly.blockRendering.StatementInput"),goog.require("Blockly.blockRendering.TopRow"),goog.require("Blockly.blockRendering.Types"),goog.require("Blockly.constants"),goog.require("Blockly.inputTypes"),goog.requireType("Blockly.blockRendering.ConstantProvider"),goog.requireType("Blockly.blockRendering.Icon"),goog.requireType("Blockly.blockRendering.Renderer"),goog.requireType("Blockly.BlockSvg"),goog.requireType("Blockly.Input"),goog.requireType("Blockly.RenderedConnection"),Blockly.blockRendering.RenderInfo=function(t,e){this.block_=e,this.renderer_=t,this.constants_=this.renderer_.getConstants(),this.outputConnection=e.outputConnection?new Blockly.blockRendering.OutputConnection(this.constants_,e.outputConnection):null,this.isInline=e.getInputsInline()&&!e.isCollapsed(),this.isCollapsed=e.isCollapsed(),this.isInsertionMarker=e.isInsertionMarker(),this.RTL=e.RTL,this.height=0,this.widthWithChildren=0,this.width=0,this.statementEdge=0,this.rows=[],this.inputRows=[],this.hiddenIcons=[],this.topRow=new Blockly.blockRendering.TopRow(this.constants_),this.bottomRow=new Blockly.blockRendering.BottomRow(this.constants_),this.startX=0,this.startY=0},Blockly.blockRendering.RenderInfo.prototype.getRenderer=function(){return this.renderer_},Blockly.blockRendering.RenderInfo.prototype.measure=function(){this.createRows_(),this.addElemSpacing_(),this.addRowSpacing_(),this.computeBounds_(),this.alignRowElements_(),this.finalize_()},Blockly.blockRendering.RenderInfo.prototype.createRows_=function(){this.populateTopRow_(),this.rows.push(this.topRow);var t=new Blockly.blockRendering.InputRow(this.constants_);this.inputRows.push(t);for(var e,n=this.block_.getIcons(),o=0;e=n[o];o++){var i=new Blockly.blockRendering.Icon(this.constants_,e);this.isCollapsed&&e.collapseHidden?this.hiddenIcons.push(i):t.elements.push(i)}var s,l=null;for(o=0;s=this.block_.inputList[o];o++)if(s.isVisible()){this.shouldStartNewRow_(s,l)&&(this.rows.push(t),t=new Blockly.blockRendering.InputRow(this.constants_),this.inputRows.push(t));for(var r,c=0;r=s.fieldRow[c];c++)t.elements.push(new Blockly.blockRendering.Field(this.constants_,r,s));this.addInput_(s,t),l=s}this.isCollapsed&&(this.block_.inputList.find(function(t){return t.type==Blockly.NEXT_STATEMENT})?t=this.addCollapsedRow_(t):(t.hasJaggedEdge=!0,t.elements.push(new Blockly.blockRendering.JaggedEdge(this.constants_))));(t.elements.length||t.hasDummyInput)&&this.rows.push(t),this.populateBottomRow_(),this.rows.push(this.bottomRow)},Blockly.blockRendering.RenderInfo.prototype.populateTopRow_=function(){var t=!!this.block_.previousConnection,e=(this.block_.hat?"cap"===this.block_.hat:this.constants_.ADD_START_HATS)&&!this.outputConnection&&!t,n=this.topRow.hasLeftSquareCorner(this.block_)?Blockly.blockRendering.SquareCorner:Blockly.blockRendering.RoundCorner;if(this.topRow.elements.push(new n(this.constants_)),e){var o=new Blockly.blockRendering.Hat(this.constants_);this.topRow.elements.push(o),this.topRow.capline=o.ascenderHeight}else t&&(this.topRow.hasPreviousConnection=!0,this.topRow.connection=new Blockly.blockRendering.PreviousConnection(this.constants_,this.block_.previousConnection),this.topRow.elements.push(this.topRow.connection));this.block_.inputList.length&&this.block_.inputList[0].type==Blockly.inputTypes.STATEMENT&&!this.block_.isCollapsed()?this.topRow.minHeight=this.constants_.TOP_ROW_PRECEDES_STATEMENT_MIN_HEIGHT:this.topRow.minHeight=this.constants_.TOP_ROW_MIN_HEIGHT,n=this.topRow.hasRightSquareCorner(this.block_)?Blockly.blockRendering.SquareCorner:Blockly.blockRendering.RoundCorner,this.topRow.elements.push(new n(this.constants_,"right"))},Blockly.blockRendering.RenderInfo.prototype.populateBottomRow_=function(){this.bottomRow.hasNextConnection=!!this.block_.nextConnection;var t=this.block_.inputList.length&&(this.block_.inputList[this.block_.inputList.length-1].type==Blockly.inputTypes.STATEMENT||this.rows[this.rows.length-1].isCollapsedStack);this.bottomRow.minHeight=t?this.constants_.BOTTOM_ROW_AFTER_STATEMENT_MIN_HEIGHT:this.constants_.BOTTOM_ROW_MIN_HEIGHT,this.bottomRow.hasLeftSquareCorner(this.block_)?this.bottomRow.elements.push(new Blockly.blockRendering.SquareCorner(this.constants_)):this.bottomRow.elements.push(new Blockly.blockRendering.RoundCorner(this.constants_)),this.bottomRow.hasNextConnection&&(this.bottomRow.connection=new Blockly.blockRendering.NextConnection(this.constants_,this.block_.nextConnection),this.bottomRow.elements.push(this.bottomRow.connection)),this.bottomRow.hasRightSquareCorner(this.block_)?this.bottomRow.elements.push(new Blockly.blockRendering.SquareCorner(this.constants_,"right")):this.bottomRow.elements.push(new Blockly.blockRendering.RoundCorner(this.constants_,"right"))},Blockly.blockRendering.RenderInfo.prototype.addInput_=function(t,e){this.isInline&&t.type==Blockly.inputTypes.VALUE?(e.elements.push(new Blockly.blockRendering.InlineInput(this.constants_,t)),e.hasInlineInput=!0):t.type==Blockly.inputTypes.STATEMENT?(e.elements.push(new Blockly.blockRendering.StatementInput(this.constants_,t)),e.hasStatement=!0):t.type==Blockly.inputTypes.VALUE?(e.elements.push(new Blockly.blockRendering.ExternalValueInput(this.constants_,t)),e.hasExternalInput=!0):t.type==Blockly.inputTypes.DUMMY&&(e.minHeight=Math.max(e.minHeight,t.getSourceBlock()&&t.getSourceBlock().isShadow()?this.constants_.DUMMY_INPUT_SHADOW_MIN_HEIGHT:this.constants_.DUMMY_INPUT_MIN_HEIGHT),e.hasDummyInput=!0),null==e.align&&(e.align=t.align)},Blockly.blockRendering.RenderInfo.prototype.addCollapsedRow_=function(t){},Blockly.blockRendering.RenderInfo.prototype.shouldStartNewRow_=function(t,e){return!!e&&(t.type==Blockly.inputTypes.STATEMENT||e.type==Blockly.inputTypes.STATEMENT||(t.type==Blockly.inputTypes.VALUE||t.type==Blockly.inputTypes.DUMMY)&&!this.isInline)},Blockly.blockRendering.RenderInfo.prototype.addElemSpacing_=function(){for(var t,e=0;t=this.rows[e];e++){var n=t.elements;if(t.elements=[],t.startsWithElemSpacer()&&t.elements.push(new Blockly.blockRendering.InRowSpacer(this.constants_,this.getInRowSpacing_(null,n[0]))),n.length){for(var o=0;o<n.length-1;o++){t.elements.push(n[o]);var i=this.getInRowSpacing_(n[o],n[o+1]);t.elements.push(new Blockly.blockRendering.InRowSpacer(this.constants_,i))}t.elements.push(n[n.length-1]),t.endsWithElemSpacer()&&t.elements.push(new Blockly.blockRendering.InRowSpacer(this.constants_,this.getInRowSpacing_(n[n.length-1],null)))}}},Blockly.blockRendering.RenderInfo.prototype.getInRowSpacing_=function(t,e){if(!t&&e&&Blockly.blockRendering.Types.isStatementInput(e))return this.constants_.STATEMENT_INPUT_PADDING_LEFT;if(t&&Blockly.blockRendering.Types.isInput(t)&&!e){if(Blockly.blockRendering.Types.isExternalInput(t))return this.constants_.NO_PADDING;if(Blockly.blockRendering.Types.isInlineInput(t))return this.constants_.LARGE_PADDING;if(Blockly.blockRendering.Types.isStatementInput(t))return this.constants_.NO_PADDING}return t&&Blockly.blockRendering.Types.isLeftSquareCorner(t)&&e&&(Blockly.blockRendering.Types.isPreviousConnection(e)||Blockly.blockRendering.Types.isNextConnection(e))?e.notchOffset:t&&Blockly.blockRendering.Types.isLeftRoundedCorner(t)&&e&&(Blockly.blockRendering.Types.isPreviousConnection(e)||Blockly.blockRendering.Types.isNextConnection(e))?e.notchOffset-this.constants_.CORNER_RADIUS:this.constants_.MEDIUM_PADDING},Blockly.blockRendering.RenderInfo.prototype.computeBounds_=function(){for(var t=0,e=0,n=0,o=0;l=this.rows[o];o++){if(l.measure(),e=Math.max(e,l.width),l.hasStatement){var i=l.getLastInput(),s=l.width-i.width;t=Math.max(t,s)}n=Math.max(n,l.widthWithConnectedBlocks)}this.statementEdge=t,this.width=e;var l;for(o=0;l=this.rows[o];o++)l.hasStatement&&(l.statementEdge=this.statementEdge);this.widthWithChildren=Math.max(e,n),this.outputConnection&&(this.startX=this.outputConnection.width,this.width+=this.outputConnection.width,this.widthWithChildren+=this.outputConnection.width)},Blockly.blockRendering.RenderInfo.prototype.alignRowElements_=function(){for(var t,e=0;t=this.rows[e];e++)if(t.hasStatement)this.alignStatementRow_(t);else{var n=t.width,o=this.getDesiredRowWidth_(t)-n;o>0&&this.addAlignmentPadding_(t,o),Blockly.blockRendering.Types.isTopOrBottomRow(t)&&(t.widthWithConnectedBlocks=t.width)}},Blockly.blockRendering.RenderInfo.prototype.getDesiredRowWidth_=function(t){return this.width-this.startX},Blockly.blockRendering.RenderInfo.prototype.addAlignmentPadding_=function(t,e){var n=t.getFirstSpacer(),o=t.getLastSpacer();(t.hasExternalInput||t.hasStatement)&&(t.widthWithConnectedBlocks+=e),t.align==Blockly.constants.ALIGN.LEFT?o.width+=e:t.align==Blockly.constants.ALIGN.CENTRE?(n.width+=e/2,o.width+=e/2):t.align==Blockly.constants.ALIGN.RIGHT?n.width+=e:o.width+=e,t.width+=e},Blockly.blockRendering.RenderInfo.prototype.alignStatementRow_=function(t){var e=t.getLastInput(),n=t.width-e.width,o=this.statementEdge,i=o-n;i>0&&this.addAlignmentPadding_(t,i),n=t.width,o=this.getDesiredRowWidth_(t),e.width+=o-n,e.height=Math.max(e.height,t.height),t.width+=o-n,t.widthWithConnectedBlocks=Math.max(t.width,this.statementEdge+t.connectedBlockWidths)},Blockly.blockRendering.RenderInfo.prototype.addRowSpacing_=function(){var t=this.rows;this.rows=[];for(var e=0;e<t.length;e++)this.rows.push(t[e]),e!=t.length-1&&this.rows.push(this.makeSpacerRow_(t[e],t[e+1]))},Blockly.blockRendering.RenderInfo.prototype.makeSpacerRow_=function(t,e){var n=this.getSpacerRowHeight_(t,e),o=this.getSpacerRowWidth_(t,e),i=new Blockly.blockRendering.SpacerRow(this.constants_,n,o);return t.hasStatement&&(i.followsStatement=!0),e.hasStatement&&(i.precedesStatement=!0),i},Blockly.blockRendering.RenderInfo.prototype.getSpacerRowWidth_=function(t,e){return this.width-this.startX},Blockly.blockRendering.RenderInfo.prototype.getSpacerRowHeight_=function(t,e){return this.constants_.MEDIUM_PADDING},Blockly.blockRendering.RenderInfo.prototype.getElemCenterline_=function(t,e){if(Blockly.blockRendering.Types.isSpacer(e))return t.yPos+e.height/2;if(Blockly.blockRendering.Types.isBottomRow(t)){var n=t.yPos+t.height-t.descenderHeight;return Blockly.blockRendering.Types.isNextConnection(e)?n+e.height/2:n-e.height/2}return Blockly.blockRendering.Types.isTopRow(t)?Blockly.blockRendering.Types.isHat(e)?t.capline-e.height/2:t.capline+e.height/2:t.yPos+t.height/2},Blockly.blockRendering.RenderInfo.prototype.recordElemPositions_=function(t){for(var e,n=t.xPos,o=0;e=t.elements[o];o++)Blockly.blockRendering.Types.isSpacer(e)&&(e.height=t.height),e.xPos=n,e.centerline=this.getElemCenterline_(t,e),n+=e.width},Blockly.blockRendering.RenderInfo.prototype.finalize_=function(){for(var t,e=0,n=0,o=0;t=this.rows[o];o++)t.yPos=n,t.xPos=this.startX,n+=t.height,e=Math.max(e,t.widthWithConnectedBlocks),this.recordElemPositions_(t);this.outputConnection&&this.block_.nextConnection&&this.block_.nextConnection.isConnected()&&(e=Math.max(e,this.block_.nextConnection.targetBlock().getHeightWidth().width)),this.widthWithChildren=e+this.startX,this.height=n,this.startY=this.topRow.capline,this.bottomRow.baseline=n-this.bottomRow.descenderHeight};