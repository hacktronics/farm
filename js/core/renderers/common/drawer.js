/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.blockRendering.Drawer"),goog.require("Blockly.blockRendering.RenderInfo"),goog.require("Blockly.blockRendering.Row"),goog.require("Blockly.blockRendering.Types"),goog.require("Blockly.utils.svgPaths"),goog.requireType("Blockly.blockRendering.ConstantProvider"),goog.requireType("Blockly.blockRendering.Field"),goog.requireType("Blockly.blockRendering.Icon"),goog.requireType("Blockly.blockRendering.InlineInput"),goog.requireType("Blockly.BlockSvg"),Blockly.blockRendering.Drawer=function(t,o){this.block_=t,this.info_=o,this.topLeft_=t.getRelativeToSurfaceXY(),this.outlinePath_="",this.inlinePath_="",this.constants_=o.getRenderer().getConstants()},Blockly.blockRendering.Drawer.prototype.draw=function(){this.hideHiddenIcons_(),this.drawOutline_(),this.drawInternals_(),this.block_.pathObject.setPath(this.outlinePath_+"\n"+this.inlinePath_),this.info_.RTL&&this.block_.pathObject.flipRTL(),Blockly.blockRendering.useDebugger&&this.block_.renderingDebugger.drawDebug(this.block_,this.info_),this.recordSizeOnBlock_()},Blockly.blockRendering.Drawer.prototype.recordSizeOnBlock_=function(){this.block_.height=this.info_.height,this.block_.width=this.info_.widthWithChildren},Blockly.blockRendering.Drawer.prototype.hideHiddenIcons_=function(){for(var t,o=0;t=this.info_.hiddenIcons[o];o++)t.icon.iconGroup_.setAttribute("display","none")},Blockly.blockRendering.Drawer.prototype.drawOutline_=function(){this.drawTop_();for(var t=1;t<this.info_.rows.length-1;t++){var o=this.info_.rows[t];o.hasJaggedEdge?this.drawJaggedEdge_(o):o.isCollapsedStack?this.drawCollapsedStack_(o):o.hasStatement?this.drawStatementInput_(o):o.hasExternalInput?this.drawValueInput_(o):this.drawRightSideRow_(o)}this.drawBottom_(),this.drawLeft_()},Blockly.blockRendering.Drawer.prototype.drawTop_=function(){var t=this.info_.topRow,o=t.elements;this.positionPreviousConnection_(),this.outlinePath_+=Blockly.utils.svgPaths.moveBy(t.xPos,this.info_.startY);for(var n,e=0;n=o[e];e++)Blockly.blockRendering.Types.isLeftRoundedCorner(n)?this.outlinePath_+=this.constants_.OUTSIDE_CORNERS.topLeft:Blockly.blockRendering.Types.isRightRoundedCorner(n)?this.outlinePath_+=this.constants_.OUTSIDE_CORNERS.topRight:Blockly.blockRendering.Types.isPreviousConnection(n)?this.outlinePath_+=n.shape.pathLeft:Blockly.blockRendering.Types.isHat(n)?this.outlinePath_+=this.constants_.START_HAT.path:Blockly.blockRendering.Types.isSpacer(n)&&(this.outlinePath_+=Blockly.utils.svgPaths.lineOnAxis("h",n.width));this.outlinePath_+=Blockly.utils.svgPaths.lineOnAxis("v",t.height)},Blockly.blockRendering.Drawer.prototype.drawJaggedEdge_=function(t){var o=t.height-this.constants_.JAGGED_TEETH.height;this.outlinePath_+=this.constants_.JAGGED_TEETH.path+Blockly.utils.svgPaths.lineOnAxis("v",o)},Blockly.blockRendering.Drawer.prototype.drawValueInput_=function(t){var o=t.getLastInput();this.positionExternalValueConnection_(t);var n="function"==typeof o.shape.pathDown?o.shape.pathDown(o.height):o.shape.pathDown;this.outlinePath_+=Blockly.utils.svgPaths.lineOnAxis("H",o.xPos+o.width)+n+Blockly.utils.svgPaths.lineOnAxis("v",t.height-o.connectionHeight)},Blockly.blockRendering.Drawer.prototype.drawStatementInput_=function(t){var o=t.getLastInput(),n=o.xPos+o.notchOffset+o.shape.width,e=o.shape.pathRight+Blockly.utils.svgPaths.lineOnAxis("h",-(o.notchOffset-this.constants_.INSIDE_CORNERS.width))+this.constants_.INSIDE_CORNERS.pathTop,i=t.height-2*this.constants_.INSIDE_CORNERS.height;this.outlinePath_+=Blockly.utils.svgPaths.lineOnAxis("H",n)+e+Blockly.utils.svgPaths.lineOnAxis("v",i)+this.constants_.INSIDE_CORNERS.pathBottom+Blockly.utils.svgPaths.lineOnAxis("H",t.xPos+t.width),this.positionStatementInputConnection_(t)},Blockly.blockRendering.Drawer.prototype.drawCollapsedStack_=function(t){},Blockly.blockRendering.Drawer.prototype.drawRightSideRow_=function(t){this.outlinePath_+=Blockly.utils.svgPaths.lineOnAxis("V",t.yPos+t.height)},Blockly.blockRendering.Drawer.prototype.drawBottom_=function(){var t=this.info_.bottomRow,o=t.elements;this.positionNextConnection_();for(var n,e=0,i="",s=o.length-1;n=o[s];s--)Blockly.blockRendering.Types.isNextConnection(n)?i+=n.shape.pathRight:Blockly.blockRendering.Types.isLeftSquareCorner(n)?i+=Blockly.utils.svgPaths.lineOnAxis("H",t.xPos):Blockly.blockRendering.Types.isLeftRoundedCorner(n)?i+=this.constants_.OUTSIDE_CORNERS.bottomLeft:Blockly.blockRendering.Types.isRightRoundedCorner(n)?(i+=this.constants_.OUTSIDE_CORNERS.bottomRight,e=this.constants_.OUTSIDE_CORNERS.rightHeight):Blockly.blockRendering.Types.isSpacer(n)&&(i+=Blockly.utils.svgPaths.lineOnAxis("h",-1*n.width));this.outlinePath_+=Blockly.utils.svgPaths.lineOnAxis("V",t.baseline-e),this.outlinePath_+=i},Blockly.blockRendering.Drawer.prototype.drawLeft_=function(){var t=this.info_.outputConnection;if(this.positionOutputConnection_(),t){var o=t.connectionOffsetY+t.height,n="function"==typeof t.shape.pathUp?t.shape.pathUp(t.height):t.shape.pathUp;this.outlinePath_+=Blockly.utils.svgPaths.lineOnAxis("V",o)+n}this.outlinePath_+="z"},Blockly.blockRendering.Drawer.prototype.drawInternals_=function(){for(var t,o=0;t=this.info_.rows[o];o++)for(var n,e=0;n=t.elements[e];e++)Blockly.blockRendering.Types.isInlineInput(n)?this.drawInlineInput_(n):(Blockly.blockRendering.Types.isIcon(n)||Blockly.blockRendering.Types.isField(n))&&this.layoutField_(n)},Blockly.blockRendering.Drawer.prototype.layoutField_=function(t){if(Blockly.blockRendering.Types.isField(t))var o=t.field.getSvgRoot();else if(Blockly.blockRendering.Types.isIcon(t))o=t.icon.iconGroup_;var n=t.centerline-t.height/2,e=t.xPos,i="";this.info_.RTL&&(e=-(e+t.width),t.flipRtl&&(e+=t.width,i="scale(-1 1)")),Blockly.blockRendering.Types.isIcon(t)?(o.setAttribute("display","block"),o.setAttribute("transform","translate("+e+","+n+")"),t.icon.computeIconLocation()):o.setAttribute("transform","translate("+e+","+n+")"+i),this.info_.isInsertionMarker&&o.setAttribute("display","none")},Blockly.blockRendering.Drawer.prototype.drawInlineInput_=function(t){var o=t.width,n=t.height,e=t.centerline-n/2,i=t.connectionOffsetY,s=t.connectionHeight+i,l=t.xPos+t.connectionWidth;this.inlinePath_+=Blockly.utils.svgPaths.moveTo(l,e)+Blockly.utils.svgPaths.lineOnAxis("v",i)+t.shape.pathDown+Blockly.utils.svgPaths.lineOnAxis("v",n-s)+Blockly.utils.svgPaths.lineOnAxis("h",o-t.connectionWidth)+Blockly.utils.svgPaths.lineOnAxis("v",-n)+"z",this.positionInlineInputConnection_(t)},Blockly.blockRendering.Drawer.prototype.positionInlineInputConnection_=function(t){var o=t.centerline-t.height/2;if(t.connectionModel){var n=t.xPos+t.connectionWidth+t.connectionOffsetX;this.info_.RTL&&(n*=-1),t.connectionModel.setOffsetInBlock(n,o+t.connectionOffsetY)}},Blockly.blockRendering.Drawer.prototype.positionStatementInputConnection_=function(t){var o=t.getLastInput();if(o.connectionModel){var n=t.xPos+t.statementEdge+o.notchOffset;this.info_.RTL&&(n*=-1),o.connectionModel.setOffsetInBlock(n,t.yPos)}},Blockly.blockRendering.Drawer.prototype.positionExternalValueConnection_=function(t){var o=t.getLastInput();if(o.connectionModel){var n=t.xPos+t.width;this.info_.RTL&&(n*=-1),o.connectionModel.setOffsetInBlock(n,t.yPos)}},Blockly.blockRendering.Drawer.prototype.positionPreviousConnection_=function(){var t=this.info_.topRow;if(t.connection){var o=t.xPos+t.notchOffset,n=this.info_.RTL?-o:o;t.connection.connectionModel.setOffsetInBlock(n,0)}},Blockly.blockRendering.Drawer.prototype.positionNextConnection_=function(){var t=this.info_.bottomRow;if(t.connection){var o=t.connection,n=o.xPos,e=this.info_.RTL?-n:n;o.connectionModel.setOffsetInBlock(e,t.baseline)}},Blockly.blockRendering.Drawer.prototype.positionOutputConnection_=function(){if(this.info_.outputConnection){var t=this.info_.startX+this.info_.outputConnection.connectionOffsetX,o=this.info_.RTL?-t:t;this.block_.outputConnection.setOffsetInBlock(o,this.info_.outputConnection.connectionOffsetY)}};