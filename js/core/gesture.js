/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.Gesture"),goog.require("Blockly.blockAnimations"),goog.require("Blockly.BlockDragger"),goog.require("Blockly.browserEvents"),goog.require("Blockly.BubbleDragger"),goog.require("Blockly.constants"),goog.require("Blockly.Events"),goog.require("Blockly.Events.Click"),goog.require("Blockly.pxtBlocklyUtils"),goog.require("Blockly.Tooltip"),goog.require("Blockly.Touch"),goog.require("Blockly.utils"),goog.require("Blockly.utils.Coordinate"),goog.require("Blockly.Workspace"),goog.require("Blockly.WorkspaceDragger"),goog.requireType("Blockly.BlockSvg"),goog.requireType("Blockly.Field"),goog.requireType("Blockly.IBlockDragger"),goog.requireType("Blockly.IBubble"),goog.requireType("Blockly.IFlyout"),goog.requireType("Blockly.WorkspaceSvg"),Blockly.Gesture=function(t,e){this.mouseDownXY_=null,this.currentDragDeltaXY_=new Blockly.utils.Coordinate(0,0),this.startBubble_=null,this.startField_=null,this.startBlock_=null,this.targetBlock_=null,this.startWorkspace_=null,this.creatorWorkspace_=e,this.hasExceededDragRadius_=!1,this.isDraggingWorkspace_=!1,this.isDraggingBlock_=!1,this.isDraggingBubble_=!1,this.mostRecentEvent_=t,this.onMoveWrapper_=null,this.onUpWrapper_=null,this.bubbleDragger_=null,this.blockDragger_=null,this.workspaceDragger_=null,this.flyout_=null,this.calledUpdateIsDragging_=!1,this.hasStarted_=!1,this.isEnding_=!1,this.shouldDuplicateOnDrag_=!1,this.healStack_=!Blockly.DRAG_STACK},Blockly.Gesture.prototype.dispose=function(){Blockly.Touch.clearTouchIdentifier(),Blockly.Tooltip.unblock(),this.creatorWorkspace_.clearGesture(),this.onMoveWrapper_&&Blockly.browserEvents.unbind(this.onMoveWrapper_),this.onUpWrapper_&&Blockly.browserEvents.unbind(this.onUpWrapper_),this.blockDragger_&&this.blockDragger_.dispose(),this.workspaceDragger_&&this.workspaceDragger_.dispose(),this.bubbleDragger_&&this.bubbleDragger_.dispose()},Blockly.Gesture.prototype.updateFromEvent_=function(t){var e=new Blockly.utils.Coordinate(t.clientX,t.clientY);this.updateDragDelta_(e)&&(this.updateIsDragging_(),Blockly.longStop_()),this.mostRecentEvent_=t},Blockly.Gesture.prototype.updateDragDelta_=function(t){if(this.currentDragDeltaXY_=Blockly.utils.Coordinate.difference(t,this.mouseDownXY_),!this.hasExceededDragRadius_){var e=Blockly.utils.Coordinate.magnitude(this.currentDragDeltaXY_),r=this.flyout_?Blockly.FLYOUT_DRAG_RADIUS:Blockly.DRAG_RADIUS;return this.hasExceededDragRadius_=e>r,this.hasExceededDragRadius_}return!1},Blockly.Gesture.prototype.updateIsDraggingFromFlyout_=function(){return!!this.targetBlock_&&(!!this.flyout_.isBlockCreatable_(this.targetBlock_)&&(!(this.flyout_.isScrollable()&&!this.flyout_.isDragTowardWorkspace(this.currentDragDeltaXY_))&&(this.startWorkspace_=this.flyout_.targetWorkspace,this.startWorkspace_.updateScreenCalculationsIfScrolled(),Blockly.Events.getGroup()||Blockly.Events.setGroup(!0),this.startBlock_=null,this.targetBlock_=this.flyout_.createBlock(this.targetBlock_),this.targetBlock_.select(),!0)))},Blockly.Gesture.prototype.updateIsDraggingBubble_=function(){return!!this.startBubble_&&(this.isDraggingBubble_=!0,this.startDraggingBubble_(),!0)},Blockly.Gesture.prototype.updateIsDraggingBlock_=function(){return!!this.targetBlock_&&(this.flyout_?this.isDraggingBlock_=this.updateIsDraggingFromFlyout_():(this.targetBlock_.isMovable()||this.shouldDuplicateOnDrag_)&&(this.isDraggingBlock_=!0),!!this.isDraggingBlock_&&(this.startDraggingBlock_(),!0))},Blockly.Gesture.prototype.updateIsDraggingWorkspace_=function(){(this.flyout_?this.flyout_.isScrollable():this.startWorkspace_&&this.startWorkspace_.isDraggable())&&(this.workspaceDragger_=new Blockly.WorkspaceDragger(this.startWorkspace_),this.isDraggingWorkspace_=!0,this.workspaceDragger_.startDrag())},Blockly.Gesture.prototype.updateIsDragging_=function(){if(this.calledUpdateIsDragging_)throw Error("updateIsDragging_ should only be called once per gesture.");this.calledUpdateIsDragging_=!0,this.updateIsDraggingBubble_()||this.updateIsDraggingBlock_()||this.updateIsDraggingWorkspace_()},Blockly.Gesture.prototype.startDraggingBlock_=function(){this.shouldDuplicateOnDrag_&&this.duplicateOnDrag_();var t=Blockly.registry.getClassFromOptions(Blockly.registry.Type.BLOCK_DRAGGER,this.creatorWorkspace_.options,!0);this.blockDragger_=new t(this.targetBlock_,this.startWorkspace_),this.blockDragger_.startDrag(this.currentDragDeltaXY_,this.healStack_),this.blockDragger_.drag(this.mostRecentEvent_,this.currentDragDeltaXY_)},Blockly.Gesture.prototype.startDraggingBubble_=function(){this.bubbleDragger_=new Blockly.BubbleDragger(this.startBubble_,this.startWorkspace_),this.bubbleDragger_.startBubbleDrag(),this.bubbleDragger_.dragBubble(this.mostRecentEvent_,this.currentDragDeltaXY_)},Blockly.Gesture.prototype.doStart=function(t){Blockly.utils.isTargetInput(t)?this.cancel():(this.hasStarted_=!0,Blockly.blockAnimations.disconnectUiStop(),this.startWorkspace_.updateScreenCalculationsIfScrolled(),this.startWorkspace_.isMutator&&this.startWorkspace_.resize(),Blockly.hideChaff(!!this.flyout_),this.startWorkspace_.markFocused(),this.mostRecentEvent_=t,Blockly.Tooltip.block(),this.targetBlock_&&this.targetBlock_.select(),Blockly.utils.isRightButton(t)?this.handleRightClick(t):("touchstart"!=t.type.toLowerCase()&&"pointerdown"!=t.type.toLowerCase()||"mouse"==t.pointerType||Blockly.longStart(t,this),this.mouseDownXY_=new Blockly.utils.Coordinate(t.clientX,t.clientY),this.healStack_=t.altKey||t.ctrlKey||t.metaKey,this.bindMouseEvents(t)))},Blockly.Gesture.prototype.bindMouseEvents=function(t){this.onMoveWrapper_=Blockly.browserEvents.conditionalBind(document,"mousemove",null,this.handleMove.bind(this)),this.onUpWrapper_=Blockly.browserEvents.conditionalBind(document,"mouseup",null,this.handleUp.bind(this)),t.preventDefault(),t.stopPropagation()},Blockly.Gesture.prototype.handleMove=function(t){this.updateFromEvent_(t),this.isDraggingWorkspace_?this.workspaceDragger_.drag(this.currentDragDeltaXY_):this.isDraggingBlock_?this.blockDragger_.drag(this.mostRecentEvent_,this.currentDragDeltaXY_):this.isDraggingBubble_&&this.bubbleDragger_.dragBubble(this.mostRecentEvent_,this.currentDragDeltaXY_),t.preventDefault(),t.stopPropagation()},Blockly.Gesture.prototype.handleUp=function(t){this.updateFromEvent_(t),Blockly.longStop_(),this.isEnding_?console.log("Trying to end a gesture recursively."):(this.isEnding_=!0,this.isDraggingBubble_?this.bubbleDragger_.endBubbleDrag(t,this.currentDragDeltaXY_):this.isDraggingBlock_?this.blockDragger_.endDrag(t,this.currentDragDeltaXY_):this.isDraggingWorkspace_?this.workspaceDragger_.endDrag(this.currentDragDeltaXY_):this.isBubbleClick_()?this.doBubbleClick_():this.isFieldClick_()?this.doFieldClick_(t):this.isBlockClick_()?this.doBlockClick_():this.isWorkspaceClick_()&&this.doWorkspaceClick_(t),t.preventDefault(),t.stopPropagation(),this.dispose())},Blockly.Gesture.prototype.cancel=function(){this.isEnding_||(this.isEnding_=!0,Blockly.longStop_(),this.isDraggingBubble_?this.bubbleDragger_.endBubbleDrag(this.mostRecentEvent_,this.currentDragDeltaXY_):this.isDraggingBlock_?this.blockDragger_.endDrag(this.mostRecentEvent_,this.currentDragDeltaXY_):this.isDraggingWorkspace_&&this.workspaceDragger_.endDrag(this.currentDragDeltaXY_),this.dispose())},Blockly.Gesture.prototype.handleRightClick=function(t){this.targetBlock_?(this.bringBlockToFront_(),Blockly.hideChaff(!!this.flyout_),this.targetBlock_.showContextMenu(t)):this.startBubble_?this.startBubble_.showContextMenu(t):this.startWorkspace_&&!this.flyout_&&(Blockly.hideChaff(),this.startWorkspace_.showContextMenu(t)),t.preventDefault(),t.stopPropagation(),this.dispose()},Blockly.Gesture.prototype.handleWsStart=function(t,e){if(this.hasStarted_)throw Error("Tried to call gesture.handleWsStart, but the gesture had already been started.");this.setStartWorkspace_(e),this.mostRecentEvent_=t,this.doStart(t)},Blockly.Gesture.prototype.fireWorkspaceClick_=function(t){Blockly.Events.fire(new(Blockly.Events.get(Blockly.Events.CLICK))(null,t.id,"workspace"))},Blockly.Gesture.prototype.handleFlyoutStart=function(t,e){if(this.hasStarted_)throw Error("Tried to call gesture.handleFlyoutStart, but the gesture had already been started.");this.setStartFlyout_(e),this.handleWsStart(t,e.getWorkspace())},Blockly.Gesture.prototype.handleBlockStart=function(t,e){if(this.hasStarted_)throw Error("Tried to call gesture.handleBlockStart, but the gesture had already been started.");this.setStartBlock(e),this.mostRecentEvent_=t},Blockly.Gesture.prototype.handleBubbleStart=function(t,e){if(this.hasStarted_)throw Error("Tried to call gesture.handleBubbleStart, but the gesture had already been started.");this.setStartBubble(e),this.mostRecentEvent_=t},Blockly.Gesture.prototype.doBubbleClick_=function(){this.startBubble_.setFocus&&this.startBubble_.setFocus(),this.startBubble_.select&&this.startBubble_.select()},Blockly.Gesture.prototype.doFieldClick_=function(){this.startField_.showEditor(this.mostRecentEvent_),this.bringBlockToFront_()},Blockly.Gesture.prototype.doBlockClick_=function(){if(this.flyout_&&this.flyout_.autoClose){if(this.targetBlock_.isEnabled())Blockly.Events.getGroup()||Blockly.Events.setGroup(!0),this.flyout_.createBlock(this.targetBlock_).scheduleSnapAndBump()}else{var t=new(Blockly.Events.get(Blockly.Events.CLICK))(this.startBlock_,this.startWorkspace_.id,"block");Blockly.Events.fire(t)}this.bringBlockToFront_(),Blockly.Events.setGroup(!1)},Blockly.Gesture.prototype.doWorkspaceClick_=function(t){var e=this.creatorWorkspace_;Blockly.selected&&Blockly.selected.unselect(),this.fireWorkspaceClick_(this.startWorkspace_||e)},Blockly.Gesture.prototype.bringBlockToFront_=function(){this.targetBlock_&&!this.flyout_&&this.targetBlock_.bringToFront()},Blockly.Gesture.prototype.setStartField=function(t){if(this.hasStarted_)throw Error("Tried to call gesture.setStartField, but the gesture had already been started.");this.startField_||(this.startField_=t)},Blockly.Gesture.prototype.setStartBubble=function(t){this.startBubble_||(this.startBubble_=t)},Blockly.Gesture.prototype.setStartBlock=function(t){this.startBlock_||this.startBubble_||(this.startBlock_=t,this.shouldDuplicateOnDrag_=!t.disabled&&!t.getInheritedDisabled()&&!t.isInFlyout&&Blockly.pxtBlocklyUtils.isShadowArgumentReporter(t),t.isInFlyout&&t!=t.getRootBlock()?this.setTargetBlock_(t.getRootBlock()):this.setTargetBlock_(t))},Blockly.Gesture.prototype.setTargetBlock_=function(t){t.isShadow()&&!this.shouldDuplicateOnDrag_?this.setTargetBlock_(t.getParent()):this.targetBlock_=t},Blockly.Gesture.prototype.setStartWorkspace_=function(t){this.startWorkspace_||(this.startWorkspace_=t)},Blockly.Gesture.prototype.setStartFlyout_=function(t){this.flyout_||(this.flyout_=t)},Blockly.Gesture.prototype.isBubbleClick_=function(){return!!this.startBubble_&&!this.hasExceededDragRadius_},Blockly.Gesture.prototype.isBlockClick_=function(){return!!this.startBlock_&&!this.hasExceededDragRadius_&&!this.isFieldClick_()},Blockly.Gesture.prototype.isFieldClick_=function(){return!!this.startField_&&this.startField_.isClickable()&&!this.hasExceededDragRadius_&&(!this.flyout_||!this.flyout_.autoClose)},Blockly.Gesture.prototype.isWorkspaceClick_=function(){return!this.startBlock_&&!this.startBubble_&&!this.startField_&&!this.hasExceededDragRadius_},Blockly.Gesture.prototype.isDragging=function(){return this.isDraggingWorkspace_||this.isDraggingBlock_||this.isDraggingBubble_},Blockly.Gesture.prototype.hasStarted=function(){return this.hasStarted_},Blockly.Gesture.prototype.getInsertionMarkers=function(){return this.blockDragger_?this.blockDragger_.getInsertionMarkers():[]},Blockly.Gesture.prototype.getCurrentDragger=function(){return this.isDraggingBlock_?this.blockDragger_:this.isDraggingWorkspace_?this.workspaceDragger_:this.isDraggingBubble_?this.bubbleDragger_:null},Blockly.Gesture.inProgress=function(){for(var t,e=Blockly.Workspace.getAll(),r=0;t=e[r];r++)if(t.currentGesture_)return!0;return!1},Blockly.Gesture.prototype.forceStartBlockDrag=function(t,e){this.handleBlockStart(t,e),this.handleWsStart(t,e.workspace),this.isDraggingBlock_=!0,this.hasExceededDragRadius_=!0,this.startDraggingBlock_()},Blockly.Gesture.prototype.duplicateOnDrag_=function(){var t=null;Blockly.Events.disable();try{this.startWorkspace_.setResizesEnabled(!1);var e=Blockly.Xml.blockToDom(this.targetBlock_);if("variables_get_reporter"==e.getAttribute("type")){var r=e.firstChild;if(!r)throw"unable to create a variable_get block from a variables_get_reporter block, block has no VAR field";var s=document.createElement("block");s.setAttribute("type","variables_get");var o=document.createElement("field");o.setAttribute("name",r.getAttribute("name")),o.setAttribute("id",r.getAttribute("id")),o.textContent=r.textContent,s.appendChild(o),e=s}this.targetBlock_.inputList[0]&&this.targetBlock_.inputList[0].fieldRow[0]&&this.targetBlock_.inputList[0].fieldRow[0].clearHover&&this.targetBlock_.inputList[0].fieldRow[0].clearHover(),t=Blockly.Xml.domToBlock(e,this.startWorkspace_);var l=this.targetBlock_.getRelativeToSurfaceXY();t.moveBy(l.x,l.y),t.setShadow(!1),t.setMovable(!0)}finally{Blockly.Events.enable()}t?(Blockly.Events.isEnabled()&&Blockly.Events.fire(new Blockly.Events.BlockCreate(t)),t.select(),this.targetBlock_=t):console.error("Something went wrong while duplicating a block.")};