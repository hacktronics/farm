/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.HorizontalFlyout"),goog.require("Blockly.Block"),goog.require("Blockly.constants"),goog.require("Blockly.DropDownDiv"),goog.require("Blockly.Flyout"),goog.require("Blockly.registry"),goog.require("Blockly.Scrollbar"),goog.require("Blockly.utils"),goog.require("Blockly.utils.object"),goog.require("Blockly.utils.Rect"),goog.require("Blockly.utils.toolbox"),goog.require("Blockly.WidgetDiv"),goog.requireType("Blockly.Options"),goog.requireType("Blockly.utils.Coordinate"),Blockly.HorizontalFlyout=function(t){Blockly.HorizontalFlyout.superClass_.constructor.call(this,t),this.horizontalLayout=!0},Blockly.utils.object.inherits(Blockly.HorizontalFlyout,Blockly.Flyout),Blockly.HorizontalFlyout.prototype.setMetrics_=function(t){if(this.isVisible()){var o=this.workspace_.getMetricsManager(),i=o.getScrollMetrics(),e=o.getViewMetrics(),s=o.getAbsoluteMetrics();"number"==typeof t.x&&(this.workspace_.scrollX=-(i.left+(i.width-e.width)*t.x)),this.workspace_.translate(this.workspace_.scrollX+s.left,this.workspace_.scrollY+s.top)}},Blockly.HorizontalFlyout.prototype.getX=function(){return 0},Blockly.HorizontalFlyout.prototype.getY=function(){if(!this.isVisible())return 0;var t=this.targetWorkspace.getMetricsManager(),o=t.getAbsoluteMetrics(),i=t.getViewMetrics(),e=t.getToolboxMetrics(),s=this.toolboxPosition_==Blockly.utils.toolbox.Position.TOP;return this.targetWorkspace.toolboxPosition==this.toolboxPosition_?this.targetWorkspace.getToolbox()?s?e.height:i.height-this.height_:s?0:i.height:s?0:i.height+o.top-this.height_},Blockly.HorizontalFlyout.prototype.position=function(){if(this.isVisible()&&this.targetWorkspace.isVisible()){var t=this.targetWorkspace.getMetricsManager().getViewMetrics();this.width_=t.width;var o=t.width-2*this.CORNER_RADIUS,i=this.height_-this.CORNER_RADIUS;this.setBackgroundPath_(o,i);var e=this.getX(),s=this.getY();this.positionAt_(this.width_,this.height_,e,s)}},Blockly.HorizontalFlyout.prototype.setBackgroundPath_=function(t,o){var i=this.toolboxPosition_==Blockly.utils.toolbox.Position.TOP,e=["M 0,"+(i?0:this.CORNER_RADIUS)];i?(e.push("h",t+2*this.CORNER_RADIUS),e.push("v",o),e.push("a",this.CORNER_RADIUS,this.CORNER_RADIUS,0,0,1,-this.CORNER_RADIUS,this.CORNER_RADIUS),e.push("h",-t),e.push("a",this.CORNER_RADIUS,this.CORNER_RADIUS,0,0,1,-this.CORNER_RADIUS,-this.CORNER_RADIUS),e.push("z")):(e.push("a",this.CORNER_RADIUS,this.CORNER_RADIUS,0,0,1,this.CORNER_RADIUS,-this.CORNER_RADIUS),e.push("h",t),e.push("a",this.CORNER_RADIUS,this.CORNER_RADIUS,0,0,1,this.CORNER_RADIUS,this.CORNER_RADIUS),e.push("v",o),e.push("h",-t-2*this.CORNER_RADIUS),e.push("z")),this.svgBackground_.setAttribute("d",e.join(" "))},Blockly.HorizontalFlyout.prototype.scrollToStart=function(){this.workspace_.scrollbar.setX(this.RTL?1/0:0)},Blockly.HorizontalFlyout.prototype.wheel_=function(t){var o=Blockly.utils.getScrollDeltaPixels(t),i=o.x||o.y;if(i){var e=this.workspace_.getMetricsManager(),s=e.getScrollMetrics(),l=e.getViewMetrics().left-s.left+i;this.workspace_.scrollbar.setX(l),Blockly.WidgetDiv.hide(),Blockly.DropDownDiv.hideWithoutAnimation()}t.preventDefault(),t.stopPropagation()},Blockly.HorizontalFlyout.prototype.layout_=function(t,o){this.workspace_.scale=this.targetWorkspace.scale;var i=this.MARGIN,e=i+this.tabWidth_,s=i;this.RTL&&(t=t.reverse());for(var l,r=0;l=t[r];r++)if("block"==l.type){for(var h,c=l.block,a=c.getDescendants(!1),n=0;h=a[n];n++)h.isInFlyout=!0;c.render();var g=c.getSvgRoot(),u=c.getHeightWidth(),y=c.outputConnection?this.tabWidth_:0;if(this.RTL)var p=e+u.width;else p=e-y;c.moveBy(p,s);var R=this.createRect_(c,p,s,u,r);e+=u.width+o[r],this.addBlockListeners_(g,c,R)}else"button"==l.type&&(this.initFlyoutButton_(l.button,e,s),e+=l.button.width+o[r])},Blockly.HorizontalFlyout.prototype.isDragTowardWorkspace=function(t){var o=t.x,i=t.y,e=Math.atan2(i,o)/Math.PI*180,s=this.dragAngleRange_;return e<90+s&&e>90-s||e>-90-s&&e<-90+s},Blockly.HorizontalFlyout.prototype.getClientRect=function(){if(!this.svgGroup_||this.autoClose||!this.isVisible())return null;var t=this.svgGroup_.getBoundingClientRect(),o=1e9,i=t.top;if(this.toolboxPosition_==Blockly.utils.toolbox.Position.TOP){var e=t.height;return new Blockly.utils.Rect(-o,i+e,-o,o)}return new Blockly.utils.Rect(i,o,-o,o)},Blockly.HorizontalFlyout.prototype.reflowInternal_=function(){this.workspace_.scale=this.getFlyoutScale();for(var t=0,o=this.workspace_.getTopBlocks(!1),i=0;e=o[i];i++)t=Math.max(t,e.getHeightWidth().height);if(t+=1.5*this.MARGIN,t*=this.workspace_.scale,t+=Blockly.Scrollbar.scrollbarThickness,this.height_!=t){var e;for(i=0;e=o[i];i++)e.flyoutRect_&&this.moveRectToBlock_(e.flyoutRect_,e);this.targetWorkspace.toolboxPosition!=this.toolboxPosition_||this.toolboxPosition_!=Blockly.utils.toolbox.Position.TOP||this.targetWorkspace.getToolbox()||this.targetWorkspace.translate(this.targetWorkspace.scrollX,this.targetWorkspace.scrollY+t),this.height_=t,this.position(),this.targetWorkspace.recordDragTargets()}},Blockly.registry.register(Blockly.registry.Type.FLYOUTS_HORIZONTAL_TOOLBOX,Blockly.registry.DEFAULT,Blockly.HorizontalFlyout);