/**
 * @license
 * Copyright 2011 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.inject"),goog.require("Blockly.BlockDragSurfaceSvg"),goog.require("Blockly.browserEvents"),goog.require("Blockly.Css"),goog.require("Blockly.DropDownDiv"),goog.require("Blockly.Events"),goog.require("Blockly.Grid"),goog.require("Blockly.Msg"),goog.require("Blockly.Options"),goog.require("Blockly.ScrollbarPair"),goog.require("Blockly.Tooltip"),goog.require("Blockly.utils"),goog.require("Blockly.utils.aria"),goog.require("Blockly.utils.dom"),goog.require("Blockly.utils.math"),goog.require("Blockly.utils.Svg"),goog.require("Blockly.utils.userAgent"),goog.require("Blockly.Workspace"),goog.require("Blockly.WorkspaceDragSurfaceSvg"),goog.require("Blockly.WorkspaceSvg"),goog.require("Blockly.WidgetDiv"),goog.requireType("Blockly.BlockSvg"),Blockly.inject=function(o,e){if(Blockly.checkBlockColourConstants(),"string"==typeof o&&(o=document.getElementById(o)||document.querySelector(o)),!o||!Blockly.utils.dom.containsNode(document,o))throw Error("Error: container is not in current document.");var l=new Blockly.Options(e||{}),t=document.createElement("div");t.className="injectionDiv",t.tabIndex=0,Blockly.utils.aria.setState(t,Blockly.utils.aria.State.LABEL,Blockly.Msg.WORKSPACE_ARIA_LABEL),o.appendChild(t),Blockly.utils.dom.startTextWidthCache();var n=Blockly.createDom_(t,l),c=new Blockly.BlockDragSurfaceSvg(t),r=new Blockly.WorkspaceDragSurfaceSvg(t),i=Blockly.createMainWorkspace_(n,l,c,r);return Blockly.init_(i),Blockly.mainWorkspace=i,Blockly.svgResize(i),t.addEventListener("focusin",function(){Blockly.mainWorkspace=i}),i},Blockly.createDom_=function(o,e){o.setAttribute("dir","LTR"),Blockly.Css.inject(e.hasCss,e.pathToMedia);var l=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.SVG,{xmlns:Blockly.utils.dom.SVG_NS,"xmlns:html":Blockly.utils.dom.HTML_NS,"xmlns:xlink":Blockly.utils.dom.XLINK_NS,version:"1.1",class:"blocklySvg",tabindex:"0"},o),t=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.DEFS,{},l),n=String(Math.random()).substring(2);return e.gridPattern=Blockly.Grid.createDom(n,e.gridOptions,t),l},Blockly.createMainWorkspace_=function(o,e,l,t){e.parentWorkspace=null;var n=new Blockly.WorkspaceSvg(e,l,t),c=n.options;if(n.scale=c.zoomOptions.startScale,o.appendChild(n.createDom("blocklyMainBackground")),Blockly.utils.dom.addClass(n.getInjectionDiv(),n.getRenderer().getClassName()),Blockly.utils.dom.addClass(n.getInjectionDiv(),n.getTheme().getClassName()),!c.hasCategories&&c.languageTree){var r=n.addFlyout(Blockly.utils.Svg.SVG);Blockly.utils.dom.insertAfter(r,o)}return c.hasTrashcan&&n.addTrashcan(),c.zoomOptions&&c.zoomOptions.controls&&n.addZoomControls(),n.getThemeManager().subscribe(o,"workspaceBackgroundColour","background-color"),n.translate(0,0),n.addChangeListener(Blockly.bumpIntoBoundsHandler_(n)),Blockly.svgResize(n),Blockly.WidgetDiv.createDom(),Blockly.DropDownDiv.createDom(),Blockly.Tooltip.createDom(),n},Blockly.extractObjectFromEvent_=function(o,e){var l=null;switch(e.type){case Blockly.Events.BLOCK_CREATE:case Blockly.Events.BLOCK_MOVE:(l=o.getBlockById(e.blockId))&&(l=l.getRootBlock());break;case Blockly.Events.COMMENT_CREATE:case Blockly.Events.COMMENT_MOVE:l=o.getCommentById(e.commentId)}return l},Blockly.bumpTopObjectsIntoBounds_=function(o){var e=o.getMetricsManager();if(e.hasFixedEdges()&&!o.isDragging())for(var l,t=e.getScrollMetrics(!0),n=o.getTopBoundedElements(),c=0;l=n[c];c++)Blockly.bumpObjectIntoBounds_(o,t,l)},Blockly.bumpIntoBoundsHandler_=function(o){return function(e){var l=o.getMetricsManager();if(l.hasFixedEdges()&&!o.isDragging())if(-1!==Blockly.Events.BUMP_EVENTS.indexOf(e.type)){var t=l.getScrollMetrics(!0),n=Blockly.extractObjectFromEvent_(o,e);if(!n)return;var c=Blockly.Events.getGroup();Blockly.Events.setGroup(e.group),Blockly.bumpObjectIntoBounds_(o,t,n)&&!e.group&&console.warn("Moved object in bounds but there was no event group. This may break undo."),null!==c&&Blockly.Events.setGroup(c)}else if(e.type===Blockly.Events.VIEWPORT_CHANGE){var r=e;r.scale>r.oldScale&&Blockly.bumpTopObjectsIntoBounds_(o)}}},Blockly.bumpObjectIntoBounds_=function(o,e,l){var t=l.getBoundingRectangle(),n=t.bottom-t.top,c=t.right-t.left,r=e.top,i=e.top+e.height-n,s=Blockly.utils.math.clamp(r,t.top,i)-t.top,a=e.left,u=e.left+e.width-c;o.RTL?a=Math.min(u,a):u=Math.max(a,u);var k=Blockly.utils.math.clamp(a,t.left,u)-t.left;return!(!k&&!s)&&(l.moveBy(k,s),!0)},Blockly.init_=function(o){var e=o.options,l=o.getParentSvg();Blockly.browserEvents.conditionalBind(l.parentNode,"contextmenu",null,function(o){Blockly.utils.isTargetInput(o)||o.preventDefault()});var t=Blockly.browserEvents.conditionalBind(window,"resize",null,function(){Blockly.utils.resizeTracker(o),Blockly.hideChaff(!0),Blockly.svgResize(o),Blockly.bumpTopObjectsIntoBounds_(o)});if(o.setResizeHandlerWrapper(t),Blockly.inject.bindDocumentEvents_(),e.languageTree){var n=o.getToolbox(),c=o.getFlyout(!0);n?n.init():c&&(c.init(o),c.show(e.languageTree),"function"==typeof c.scrollToStart&&c.scrollToStart())}if(e.hasTrashcan&&o.trashcan.init(),e.zoomOptions&&e.zoomOptions.controls&&o.zoomControls_.init(),e.moveOptions&&e.moveOptions.scrollbars){var r=!0===e.moveOptions.scrollbars||!!e.moveOptions.scrollbars.horizontal,i=!0===e.moveOptions.scrollbars||!!e.moveOptions.scrollbars.vertical;o.scrollbar=new Blockly.ScrollbarPair(o,r,i,"blocklyMainWorkspaceScrollbar"),o.scrollbar.resize()}else o.setMetrics({x:.5,y:.5});e.hasSounds&&Blockly.inject.loadSounds_(e.pathToMedia,o)},Blockly.inject.bindDocumentEvents_=function(){Blockly.documentEventsBound_||(Blockly.browserEvents.conditionalBind(document,"scroll",null,function(){for(var o,e=Blockly.Workspace.getAll(),l=0;o=e[l];l++)o.updateInverseScreenCTM&&o.updateInverseScreenCTM()}),Blockly.browserEvents.conditionalBind(document,"keydown",null,Blockly.onKeyDown),Blockly.browserEvents.bind(document,"touchend",null,Blockly.longStop_),Blockly.browserEvents.bind(document,"touchcancel",null,Blockly.longStop_),Blockly.utils.userAgent.IPAD&&Blockly.browserEvents.conditionalBind(window,"orientationchange",document,function(){Blockly.svgResize(Blockly.getMainWorkspace())})),Blockly.documentEventsBound_=!0},Blockly.inject.loadSounds_=function(o,e){var l=e.getAudioManager();l.load([o+"click.mp3",o+"click.wav",o+"click.ogg"],"click"),l.load([o+"disconnect.wav",o+"disconnect.mp3",o+"disconnect.ogg"],"disconnect"),l.load([o+"delete.mp3",o+"delete.ogg",o+"delete.wav"],"delete");var t=[],n=function(){for(;t.length;)Blockly.browserEvents.unbind(t.pop());l.preload()};t.push(Blockly.browserEvents.conditionalBind(document,"mousemove",null,n,!0)),t.push(Blockly.browserEvents.conditionalBind(document,"touchstart",null,n,!0))};