/**
 * @license
 * Copyright 2012 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.Xml"),goog.require("Blockly.constants"),goog.require("Blockly.Events"),goog.require("Blockly.inputTypes"),goog.require("Blockly.utils"),goog.require("Blockly.utils.dom"),goog.require("Blockly.utils.Size"),goog.require("Blockly.utils.xml"),goog.requireType("Blockly.Block"),goog.requireType("Blockly.Comment"),goog.requireType("Blockly.Connection"),goog.requireType("Blockly.Field"),goog.requireType("Blockly.VariableModel"),goog.requireType("Blockly.Workspace"),Blockly.Xml.workspaceToDom=function(e,o){var t=Blockly.utils.xml.createElement("xml"),l=Blockly.Xml.variablesToDom(e.getAllVariables(e));l.hasChildNodes()&&t.appendChild(l);for(var n,i=e.getTopComments(!0),r=0;n=i[r];r++)t.appendChild(n.toXmlWithXY(o));var a,c=e.getTopBlocks(!0);for(r=0;a=c[r];r++)t.appendChild(Blockly.Xml.blockToDomWithXY(a,o));return t},Blockly.Xml.variablesToDom=function(e){for(var o,t=Blockly.utils.xml.createElement("variables"),l=0;o=e[l];l++){var n=Blockly.utils.xml.createElement("variable");n.appendChild(Blockly.utils.xml.createTextNode(o.name)),o.type&&n.setAttribute("type",o.type),n.id=o.getId(),t.appendChild(n)}return t},Blockly.Xml.blockToDomWithXY=function(e,o){if(e.isInsertionMarker()&&!(e=e.getChildren(!1)[0]))return new DocumentFragment;var t;e.workspace.RTL&&(t=e.workspace.getWidth());var l=Blockly.Xml.blockToDom(e,o),n=e.getRelativeToSurfaceXY();return l.setAttribute("x",Math.round(e.workspace.RTL?t-n.x:n.x)),l.setAttribute("y",Math.round(n.y)),l},Blockly.Xml.fieldToDom_=function(e){if(e.isSerializable()){var o=Blockly.utils.xml.createElement("field");return o.setAttribute("name",e.name||""),e.toXml(o)}return null},Blockly.Xml.allFieldsToDom_=function(e,o){for(var t,l=0;t=e.inputList[l];l++)for(var n,i=0;n=t.fieldRow[i];i++){var r=Blockly.Xml.fieldToDom_(n);r&&o.appendChild(r)}},Blockly.Xml.blockToDom=function(e,o){if(e.isInsertionMarker()){var t=e.getChildren(!1)[0];return t?Blockly.Xml.blockToDom(t):new DocumentFragment}var l=Blockly.utils.xml.createElement(e.isShadow()?"shadow":"block");if(l.setAttribute("type",e.type),o||l.setAttribute("id",e.id),e.mutationToDom){var n=e.mutationToDom();n&&(n.hasChildNodes()||n.hasAttributes())&&l.appendChild(n)}if(Blockly.Xml.allFieldsToDom_(e,l),e.isBreakpointSet()){var i=Blockly.utils.xml.createElement("breakpoint");l.appendChild(i)}var r=e.getCommentText();if(r){var a=e.commentModel.size,c=e.commentModel.pinned,s=(e.getCommentIcon&&e.getCommentIcon()&&e.getCommentIcon().getRelativePosition(),Blockly.utils.xml.createElement("comment"));s.appendChild(Blockly.utils.xml.createTextNode(r)),s.setAttribute("pinned",c),s.setAttribute("h",a.height),s.setAttribute("w",a.width),l.appendChild(s)}if(e.data){var d=Blockly.utils.xml.createElement("data");d.appendChild(Blockly.utils.xml.createTextNode(e.data)),l.appendChild(d)}for(var m,u=0;m=e.inputList[u];u++){var p=!0;if(m.type!=Blockly.inputTypes.DUMMY){var k=m.connection.targetBlock();m.type==Blockly.inputTypes.VALUE?B=Blockly.utils.xml.createElement("value"):m.type==Blockly.inputTypes.STATEMENT&&(B=Blockly.utils.xml.createElement("statement")),!(g=m.connection.getShadowDom())||k&&k.isShadow()||B.appendChild(Blockly.Xml.cloneShadow_(g,o)),k&&(y=Blockly.Xml.blockToDom(k,o)).nodeType==Blockly.utils.dom.NodeType.ELEMENT_NODE&&(B.appendChild(y),p=!1),B.setAttribute("name",m.name),p||l.appendChild(B)}}null!=e.inputsInline&&e.inputsInline!=e.inputsInlineDefault&&l.setAttribute("inline",e.inputsInline),e.isCollapsed()&&l.setAttribute("collapsed",!0),e.isEnabled()||l.setAttribute("disabled",!0),e.isDeletable()||e.isShadow()||l.setAttribute("deletable",!1),e.isMovablePersisted()||e.isShadow()||l.setAttribute("movable",!1),e.isEditablePersisted()||l.setAttribute("editable",!1);var y,B,g,f=e.getNextBlock();f&&((y=Blockly.Xml.blockToDom(f,o)).nodeType==Blockly.utils.dom.NodeType.ELEMENT_NODE&&((B=Blockly.utils.xml.createElement("next")).appendChild(y),l.appendChild(B)));return!(g=e.nextConnection&&e.nextConnection.getShadowDom())||f&&f.isShadow()||B.appendChild(Blockly.Xml.cloneShadow_(g,o)),l},Blockly.Xml.cloneShadow_=function(e,o){for(var t,l=e=e.cloneNode(!0);l;)if(o&&"shadow"==l.nodeName&&l.removeAttribute("id"),l.firstChild)l=l.firstChild;else{for(;l&&!l.nextSibling;)t=l,l=l.parentNode,t.nodeType==Blockly.utils.dom.NodeType.TEXT_NODE&&""==t.data.trim()&&l.firstChild!=t&&Blockly.utils.dom.removeNode(t);l&&(t=l,l=l.nextSibling,t.nodeType==Blockly.utils.dom.NodeType.TEXT_NODE&&""==t.data.trim()&&Blockly.utils.dom.removeNode(t))}return e},Blockly.Xml.domToText=function(e){return Blockly.utils.xml.domToText(e).replace(/<(\w+)([^<]*)\/>/g,"<$1$2></$1>")},Blockly.Xml.domToPrettyText=function(e){for(var o=Blockly.Xml.domToText(e).split("<"),t="",l=1;l<o.length;l++){var n=o[l];"/"==n[0]&&(t=t.substring(2)),o[l]=t+"<"+n,"/"!=n[0]&&"/>"!=n.slice(-2)&&(t+="  ")}var i=o.join("\n");return(i=i.replace(/(<(\w+)\b[^>]*>[^\n]*)\n *<\/\2>/g,"$1</$2>")).replace(/^\n/,"")},Blockly.Xml.textToDom=function(e){e=e.replace(/xmlns=\"(.*?)\"/,'xmlns="'+Blockly.utils.xml.NAME_SPACE+'"');var o=Blockly.utils.xml.textToDomDocument(e);if(!o||!o.documentElement||o.getElementsByTagName("parsererror").length)throw Error("textToDom was unable to parse: "+e);return o.documentElement},Blockly.Xml.clearWorkspaceAndLoadFromXml=function(e,o){o.setResizesEnabled(!1),o.clear();var t=Blockly.Xml.domToWorkspace(e,o);return o.setResizesEnabled(!0),t},Blockly.Xml.domToWorkspace=function(e,o){if(e instanceof Blockly.Workspace){var t=e;e=o,o=t,console.warn("Deprecated call to Blockly.Xml.domToWorkspace, swap the arguments.")}var l;o.loadingEventsDisabled=!0,o.RTL&&(l=o.getWidth());var n=[];Blockly.utils.dom.startTextWidthCache();var i=Blockly.Events.getGroup();i||Blockly.Events.setGroup(!0),o.setResizesEnabled&&o.setResizesEnabled(!1);var r=!0;try{for(var a,c=0;a=e.childNodes[c];c++){var s=a.nodeName.toLowerCase(),d=a;if("block"==s||"shadow"==s&&!Blockly.Events.recordUndo){var m=Blockly.Xml.domToBlock(d,o);n.push(m.id);var u=d.hasAttribute("x")?parseInt(d.getAttribute("x"),10):10,p=d.hasAttribute("y")?parseInt(d.getAttribute("y"),10):10;isNaN(u)||isNaN(p)||m.moveBy(o.RTL?l-u:u,p),r=!1}else{if("shadow"==s)throw TypeError("Shadow block cannot be a top-level block.");if("comment"==s)o.rendered?Blockly.WorkspaceCommentSvg?Blockly.WorkspaceCommentSvg.fromXml(d,o,l):console.warn("Missing require for Blockly.WorkspaceCommentSvg, ignoring workspace comment."):Blockly.WorkspaceComment?Blockly.WorkspaceComment.fromXml(d,o):console.warn("Missing require for Blockly.WorkspaceComment, ignoring workspace comment.");else if("variables"==s){if(!r)throw Error("'variables' tag must exist once before block and shadow tag elements in the workspace XML, but it was found in another location.");Blockly.Xml.domToVariables(d,o),r=!1}}}}finally{i||Blockly.Events.setGroup(!1),Blockly.utils.dom.stopTextWidthCache()}return o.setResizesEnabled&&o.setResizesEnabled(!0),o.loadingEventsDisabled=!1,o.getAllBlocks(!1).forEach(function(e){e.onLoadedIntoWorkspace()}),Blockly.Events.fire(new(Blockly.Events.get(Blockly.Events.FINISHED_LOADING))(o)),n},Blockly.Xml.appendDomToWorkspace=function(e,o){var t;Object.prototype.hasOwnProperty.call(o,"scale")&&(t=o.getBlocksBoundingBox());var l=Blockly.Xml.domToWorkspace(e,o);if(t&&t.top!=t.bottom){for(var n,i,r=t.bottom,a=o.RTL?t.right:t.left,c=1/0,s=-1/0,d=1/0,m=0;m<l.length;m++){var u=o.getBlockById(l[m]).getRelativeToSurfaceXY();u.y<d&&(d=u.y),u.x<c&&(c=u.x),u.x>s&&(s=u.x)}n=r-d+10,i=o.RTL?a-s:a-c;for(m=0;m<l.length;m++){o.getBlockById(l[m]).moveBy(i,n)}}return l},Blockly.Xml.domToBlock=function(e,o){if(e instanceof Blockly.Workspace){var t=e;e=o,o=t,console.warn("Deprecated call to Blockly.Xml.domToBlock, swap the arguments.")}Blockly.Events.disable();var l=o.getAllVariables();try{var n=Blockly.Xml.domToBlockHeadless_(e,o),i=n.getDescendants(!1);if(o.rendered){n.setConnectionTracking(!1);for(var r=i.length-1;r>=0;r--)i[r].initSvg();for(r=i.length-1;r>=0;r--)i[r].render(!1);setTimeout(function(){if(!n.disposed){if(n.outputConnection&&n.outputConnection.targetConnection&&n.outputConnection.targetConnection.sourceBlock_){if(!n.outputConnection.targetConnection.sourceBlock_.inputList.find(e=>e.connection===n.outputConnection.targetConnection).isVisible())return}n.setConnectionTracking(!0)}},1),n.updateDisabled(),o.resizeContents()}else for(r=i.length-1;r>=0;r--)i[r].initModel()}finally{Blockly.Events.enable()}if(Blockly.Events.isEnabled()){var a=Blockly.Variables.getAddedVariables(o,l);for(r=0;r<a.length;r++){var c=a[r];Blockly.Events.fire(new(Blockly.Events.get(Blockly.Events.VAR_CREATE))(c))}Blockly.Events.fire(new(Blockly.Events.get(Blockly.Events.CREATE))(n))}return n},Blockly.Xml.domToVariables=function(e,o){for(var t,l=0;t=e.childNodes[l];l++)if(t.nodeType==Blockly.utils.dom.NodeType.ELEMENT_NODE){var n=t.getAttribute("type"),i=t.getAttribute("id"),r=t.textContent;o.createVariable(r,n,i)}},Blockly.Xml.childNodeTagMap,Blockly.Xml.mapSupportedXmlTags_=function(e){for(var o,t={mutation:[],comment:[],data:[],field:[],input:[],next:[],breakpoint:[]},l=0;o=e.childNodes[l];l++)if(o.nodeType!=Blockly.utils.dom.NodeType.TEXT_NODE)switch(o.nodeName.toLowerCase()){case"mutation":t.mutation.push(o);break;case"comment":if(!Blockly.Comment){console.warn("Missing require for Blockly.Comment, ignoring block comment.");break}t.comment.push(o);break;case"data":t.data.push(o);break;case"title":case"field":t.field.push(o);break;case"value":case"statement":t.input.push(o);break;case"next":t.next.push(o);break;case"breakpoint":t.breakpoint.push(o);break;default:console.warn("Ignoring unknown tag: "+o.nodeName)}return t},Blockly.Xml.applyMutationTagNodes_=function(e,o){for(var t,l=!1,n=0;t=e[n];n++)o.domToMutation&&(o.domToMutation(t),o.initSvg&&(l=!0));return l},Blockly.Xml.applyCommentTagNodes_=function(e,o){for(var t,l=0;t=e[l];l++){var n=t.textContent,i="true"==t.getAttribute("pinned"),r=parseInt(t.getAttribute("w"),10),a=parseInt(t.getAttribute("h"),10);o.setCommentText(n),o.commentModel.pinned=i,isNaN(r)||isNaN(a)||(o.commentModel.size=new Blockly.utils.Size(r,a));var c=parseInt(t.getAttribute("relx"),10),s=parseInt(t.getAttribute("rely"),10);isNaN(c)||isNaN(s)||(o.commentModel.xy=new Blockly.utils.Coordinate(c,s)),i&&o.getCommentIcon&&!o.isInFlyout&&setTimeout(function(){o.getCommentIcon().setVisible(!0)},1)}},Blockly.Xml.applyDataTagNodes_=function(e,o){for(var t,l=0;t=e[l];l++)o.data=t.textContent},Blockly.Xml.applyFieldTagNodes_=function(e,o){for(var t,l=0;t=e[l];l++){var n=t.getAttribute("name");Blockly.Xml.domToField_(o,n,t)}},Blockly.Xml.findChildBlocks_=function(e){for(var o,t={childBlockElement:null,childShadowElement:null},l=0;o=e.childNodes[l];l++)o.nodeType==Blockly.utils.dom.NodeType.ELEMENT_NODE&&("block"==o.nodeName.toLowerCase()?t.childBlockElement=o:"shadow"==o.nodeName.toLowerCase()&&(t.childShadowElement=o));return t},Blockly.Xml.applyInputTagNodes_=function(e,o,t,l){for(var n,i=0;n=e[i];i++){var r=n.getAttribute("name"),a=t.getInput(r);if(a){var c=Blockly.Xml.findChildBlocks_(n);if(c.childBlockElement){if(!a.connection)throw TypeError("Input connection does not exist.");Blockly.Xml.domToBlockHeadless_(c.childBlockElement,o,a.connection,!1)}c.childShadowElement&&a.connection.setShadowDom(c.childShadowElement)}}},Blockly.Xml.applyNextTagNodes_=function(e,o,t){for(var l,n=0;l=e[n];n++){var i=Blockly.Xml.findChildBlocks_(l);if(i.childBlockElement){if(!t.nextConnection)throw TypeError("Next statement does not exist.");if(t.nextConnection.isConnected())throw TypeError("Next statement is already connected.");Blockly.Xml.domToBlockHeadless_(i.childBlockElement,o,t.nextConnection,!0)}i.childShadowElement&&t.nextConnection&&t.nextConnection.setShadowDom(i.childShadowElement)}},Blockly.Xml.applyBreakpointTagNodes_=function(e,o){e&&e.length>0&&o.setBreakpoint(!0)},Blockly.Xml.domToBlockHeadless_=function(e,o,t,l){var n=null,i=e.getAttribute("type");if(!i)throw TypeError("Block type unspecified: "+e.outerHTML);var r=e.getAttribute("id");n=o.newBlock(i,r);var a=Blockly.Xml.mapSupportedXmlTags_(e),c=Blockly.Xml.applyMutationTagNodes_(a.mutation,n);if(Blockly.Xml.applyCommentTagNodes_(a.comment,n),Blockly.Xml.applyDataTagNodes_(a.data,n),t)if(l){if(!n.previousConnection)throw TypeError("Next block does not have previous statement.");t.connect(n.previousConnection)}else if(n.outputConnection)t.connect(n.outputConnection);else{if(!n.previousConnection)throw TypeError("Child block does not have output or previous statement.");t.connect(n.previousConnection)}Blockly.Xml.applyFieldTagNodes_(a.field,n),Blockly.Xml.applyInputTagNodes_(a.input,o,n,i),Blockly.Xml.applyNextTagNodes_(a.next,o,n),Blockly.Xml.applyBreakpointTagNodes_(a.breakpoint,n),c&&n.initSvg();var s=e.getAttribute("inline");s&&n.setInputsInline("true"==s);var d=e.getAttribute("disabled");d&&n.setEnabled("true"!=d&&"disabled"!=d);var m=e.getAttribute("deletable");m&&n.setDeletable("true"==m);var u=e.getAttribute("movable");u&&n.setMovable("true"==u);var p=e.getAttribute("editable");p&&n.setEditable("true"==p);var k=e.getAttribute("collapsed");return k&&n.setCollapsed("true"==k),"shadow"==e.nodeName.toLowerCase()&&n.setShadow(!0),n},Blockly.Xml.domToField_=function(e,o,t){var l=e.getField(o);l?l.fromXml(t):console.warn("Ignoring non-existent field "+o+" in block "+e.type)},Blockly.Xml.deleteNext=function(e){for(var o,t=0;o=e.childNodes[t];t++)if("next"==o.nodeName.toLowerCase()){e.removeChild(o);break}};