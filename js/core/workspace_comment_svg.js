/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.WorkspaceCommentSvg"),goog.require("Blockly.Css"),goog.require("Blockly.Events"),goog.require("Blockly.Events.CommentCreate"),goog.require("Blockly.Events.CommentDelete"),goog.require("Blockly.Events.CommentMove"),goog.require("Blockly.Events.Selected"),goog.require("Blockly.utils"),goog.require("Blockly.utils.Coordinate"),goog.require("Blockly.utils.dom"),goog.require("Blockly.utils.object"),goog.require("Blockly.utils.Rect"),goog.require("Blockly.utils.Svg"),goog.require("Blockly.WorkspaceComment"),goog.requireType("Blockly.IBoundedElement"),goog.requireType("Blockly.IBubble"),goog.requireType("Blockly.ICopyable"),Blockly.WorkspaceCommentSvg=function(e,t,o,l,s,r){this.onMouseUpWrapper_=null,this.onMouseMoveWrapper_=null,this.svgGroup_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.G,{class:"blocklyComment"},null),this.svgGroup_.translate_="",this.svgRect_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.RECT,{class:"blocklyCommentRect",x:0,y:0,rx:Blockly.WorkspaceCommentSvg.BORDER_WIDTH,ry:Blockly.WorkspaceCommentSvg.BORDER_WIDTH}),this.svgGroup_.appendChild(this.svgRect_),this.rendered_=!1,this.useDragSurface_=Blockly.utils.is3dSupported()&&!!e.blockDragSurface_,Blockly.WorkspaceCommentSvg.superClass_.constructor.call(this,e,t,o,l,s,r),this.render()},Blockly.utils.object.inherits(Blockly.WorkspaceCommentSvg,Blockly.WorkspaceComment),Blockly.WorkspaceCommentSvg.DEFAULT_SIZE=200,Blockly.WorkspaceCommentSvg.prototype.dispose=function(){this.workspace&&(Blockly.selected==this&&(this.unselect(),this.workspace.cancelCurrentGesture()),Blockly.Events.isEnabled()&&Blockly.Events.fire(new(Blockly.Events.get(Blockly.Events.COMMENT_DELETE))(this)),Blockly.utils.dom.removeNode(this.svgGroup_),this.svgGroup_=null,this.svgRect_=null,this.disposeInternal_(),Blockly.Events.disable(),Blockly.WorkspaceCommentSvg.superClass_.dispose.call(this),Blockly.Events.enable())},Blockly.WorkspaceCommentSvg.prototype.initSvg=function(e){if(!this.workspace.rendered)throw TypeError("Workspace is headless.");this.workspace.options.readOnly||this.eventsInit_||(Blockly.browserEvents.conditionalBind(this.svgRectTarget_,"mousedown",this,this.pathMouseDown_),Blockly.browserEvents.conditionalBind(this.svgHandleTarget_,"mousedown",this,this.pathMouseDown_)),this.eventsInit_=!0,this.updateMovable(),this.getSvgRoot().parentNode||this.workspace.getBubbleCanvas().appendChild(this.getSvgRoot()),!e&&this.textarea_&&this.textarea_.select()},Blockly.WorkspaceCommentSvg.prototype.pathMouseDown_=function(e){var t=this.workspace.getGesture(e);t&&t.handleBubbleStart(e,this)},Blockly.WorkspaceCommentSvg.prototype.showContextMenu=function(e){if(!this.workspace.options.readOnly&&!this.workspace.options.debugMode){var t=[];this.isDeletable()&&this.isMovable()&&(t.push(Blockly.ContextMenu.commentDuplicateOption(this)),t.push(Blockly.ContextMenu.commentDeleteOption(this))),Blockly.ContextMenu.show(e,t,this.RTL)}},Blockly.WorkspaceCommentSvg.prototype.select=function(){if(Blockly.selected!=this){var e=null;if(Blockly.selected){e=Blockly.selected.id,Blockly.Events.disable();try{Blockly.selected.unselect()}finally{Blockly.Events.enable()}}var t=new(Blockly.Events.get(Blockly.Events.SELECTED))(e,this.id,this.workspace.id);Blockly.Events.fire(t),Blockly.selected=this,this.addSelect()}},Blockly.WorkspaceCommentSvg.prototype.unselect=function(){if(Blockly.selected==this){var e=new(Blockly.Events.get(Blockly.Events.SELECTED))(this.id,null,this.workspace.id);Blockly.Events.fire(e),Blockly.selected=null,this.removeSelect(),this.blurFocus()}},Blockly.WorkspaceCommentSvg.prototype.addSelect=function(){Blockly.utils.dom.addClass(this.svgGroup_,"blocklySelected"),this.setFocus()},Blockly.WorkspaceCommentSvg.prototype.removeSelect=function(){Blockly.utils.dom.removeClass(this.svgGroup_,"blocklySelected"),this.blurFocus()},Blockly.WorkspaceCommentSvg.prototype.addFocus=function(){Blockly.utils.dom.addClass(this.svgGroup_,"blocklyFocused")},Blockly.WorkspaceCommentSvg.prototype.removeFocus=function(){Blockly.utils.dom.removeClass(this.svgGroup_,"blocklyFocused")},Blockly.WorkspaceCommentSvg.prototype.getRelativeToSurfaceXY=function(){var e=0,t=0,o=this.useDragSurface_?this.workspace.blockDragSurface_.getGroup():null,l=this.getSvgRoot();if(l)do{var s=Blockly.utils.getRelativeXY(l);if(e+=s.x,t+=s.y,this.useDragSurface_&&this.workspace.blockDragSurface_.getCurrentBlock()==l){var r=this.workspace.blockDragSurface_.getSurfaceTranslation();e+=r.x,t+=r.y}l=l.parentNode}while(l&&l!=this.workspace.getBubbleCanvas()&&l!=o);return this.xy_=new Blockly.utils.Coordinate(e,t),this.xy_},Blockly.WorkspaceCommentSvg.prototype.moveBy=function(e,t){var o=new(Blockly.Events.get(Blockly.Events.COMMENT_MOVE))(this),l=this.getRelativeToSurfaceXY();this.translate(l.x+e,l.y+t),this.xy_=new Blockly.utils.Coordinate(l.x+e,l.y+t),o.recordNew(),Blockly.Events.fire(o),this.workspace.resizeContents()},Blockly.WorkspaceCommentSvg.prototype.translate=function(e,t){this.xy_=new Blockly.utils.Coordinate(e,t),this.getSvgRoot().setAttribute("transform","translate("+e+","+t+")")},Blockly.WorkspaceCommentSvg.prototype.moveToDragSurface=function(){if(this.useDragSurface_){var e=this.getRelativeToSurfaceXY();this.clearTransformAttributes_(),this.workspace.blockDragSurface_.translateSurface(e.x,e.y),this.workspace.blockDragSurface_.setBlocksAndShow(this.getSvgRoot())}},Blockly.WorkspaceCommentSvg.prototype.moveOffDragSurface=function(e){this.useDragSurface_&&(this.translate(e.x,e.y),this.workspace.blockDragSurface_.clearAndHide(this.workspace.getCanvas()))},Blockly.WorkspaceCommentSvg.prototype.moveDuringDrag=function(e,t){e?e.translateSurface(t.x,t.y):(this.svgGroup_.translate_="translate("+t.x+","+t.y+")",this.svgGroup_.setAttribute("transform",this.svgGroup_.translate_+this.svgGroup_.skew_))},Blockly.WorkspaceCommentSvg.prototype.moveTo=function(e,t){this.translate(e,t)},Blockly.WorkspaceCommentSvg.prototype.clearTransformAttributes_=function(){this.getSvgRoot().removeAttribute("transform")},Blockly.WorkspaceCommentSvg.prototype.getBubbleSize=function(){if(this.rendered_)return{width:parseInt(this.svgRect_.getAttribute("width")),height:parseInt(this.svgRect_.getAttribute("height"))};this.getHeightWidth()},Blockly.WorkspaceCommentSvg.prototype.getBoundingRectangle=function(){var e,t,o=this.getRelativeToSurfaceXY(),l=this.getHeightWidth(),s=o.y,r=o.y+l.height;return this.RTL?(e=o.x-l.width,t=o.x):(e=o.x,t=o.x+l.width),new Blockly.utils.Rect(s,r,e,t)},Blockly.WorkspaceCommentSvg.prototype.updateMovable=function(){this.isMovable()?Blockly.utils.dom.addClass(this.svgGroup_,"blocklyDraggable"):Blockly.utils.dom.removeClass(this.svgGroup_,"blocklyDraggable")},Blockly.WorkspaceCommentSvg.prototype.setMovable=function(e){Blockly.WorkspaceCommentSvg.superClass_.setMovable.call(this,e),this.updateMovable()},Blockly.WorkspaceCommentSvg.prototype.setEditable=function(e){Blockly.WorkspaceCommentSvg.superClass_.setEditable.call(this,e),this.textarea_&&(this.textarea_.readOnly=!e)},Blockly.WorkspaceCommentSvg.prototype.setDragging=function(e){if(e){var t=this.getSvgRoot();t.translate_="",t.skew_="",Blockly.utils.dom.addClass(this.svgGroup_,"blocklyDragging")}else Blockly.utils.dom.removeClass(this.svgGroup_,"blocklyDragging")},Blockly.WorkspaceCommentSvg.prototype.getSvgRoot=function(){return this.svgGroup_},Blockly.WorkspaceCommentSvg.prototype.getContent=function(){return this.textarea_?this.textarea_.value:this.content_},Blockly.WorkspaceCommentSvg.prototype.setContent=function(e){Blockly.WorkspaceCommentSvg.superClass_.setContent.call(this,e),this.textarea_&&(this.textarea_.value=e)},Blockly.WorkspaceCommentSvg.prototype.setDeleteStyle=function(e){e?Blockly.utils.dom.addClass(this.svgGroup_,"blocklyDraggingDelete"):Blockly.utils.dom.removeClass(this.svgGroup_,"blocklyDraggingDelete")},Blockly.WorkspaceCommentSvg.prototype.setAutoLayout=function(e){},Blockly.WorkspaceCommentSvg.fromXml=function(e,t,o){Blockly.Events.disable();try{var l=Blockly.WorkspaceComment.parseAttributes(e),s=new Blockly.WorkspaceCommentSvg(t,l.content,l.h,l.w,l.minimized,l.id);if(t.rendered&&(s.initSvg(!0),s.render(!1)),!isNaN(l.x)&&!isNaN(l.y))if(t.RTL){var r=o||t.getWidth();s.moveBy(r-l.x,l.y)}else s.moveBy(l.x,l.y);s.data=e.getAttribute("data")}finally{Blockly.Events.enable()}return Blockly.WorkspaceComment.fireCreateEvent(s),s},Blockly.WorkspaceCommentSvg.prototype.toXmlWithXY=function(e){var t;this.workspace.RTL&&(t=this.workspace.getWidth());var o=this.toXml(e),l=this.getRelativeToSurfaceXY();return o.setAttribute("x",Math.round(this.workspace.RTL?t-l.x:l.x)),o.setAttribute("y",Math.round(l.y)),o.setAttribute("h",this.getHeight()),o.setAttribute("w",this.getWidth()),o},Blockly.WorkspaceCommentSvg.prototype.toCopyData=function(){return{xml:this.toXmlWithXY(),source:this.workspace,typeCounts:null}},Blockly.WorkspaceCommentSvg.prototype.getHeightWidth=function(){console.warn("method is overriden by workspace_comment_render_svg.js")},Blockly.Css.register([".blocklyCommentForeignObject {","position: relative;","z-index: 0;","}",".blocklyComment > image {","cursor: pointer","}",".blocklyCommentRect {","fill: #E7DE8E;","stroke: #bcA903;","stroke-width: 1px;","}",".blocklyCommentTarget {","fill: transparent;","stroke: #F9F3A1;","}",".blocklyCommentTargetFocused {","fill: none;","}",".blocklyCommentText {","fill: #000;","pointer-events: none;","}",".blocklyCommentHandleTarget {","fill: none;","}",".blocklyCommentHandleTargetFocused {","fill: transparent;","}",".blocklyFocused>.blocklyCommentRect {","fill: #FFB900;","stroke: #B9B272;","}",".blocklySelected>.blocklyCommentTarget {","stroke: #FFB900;","stroke-width: 1px;","}",".blocklyCommentForeignObject {","position: relative;","z-index: 0;","}",".blocklyCommentRect {","fill: #FAF6BD;","stroke: #F9F3A1;","stroke-width: 1px","}",".blocklyCommentTarget {","fill: transparent;","stroke: #F9F3A1;","}",".blocklyCommentTargetFocused {","fill: none;","}",".blocklyCommentHandleTarget {","fill: none;","}",".blocklyCommentHandleTargetFocused {","fill: transparent;","}",".blocklyUneditableComment {","fill: $colour_text;","}",".blocklyCommentDeleteIcon {","cursor: pointer;","fill: #000;","display: none;","}",".blocklyFocused > .blocklyCommentDeleteIcon,",".blocklyCommentBubble > .blocklyCommentDeleteIcon {","display: block;","}",".blocklySelected > .blocklyCommentDeleteIcon {","display: block;","}",".blocklyDeleteIconShape.blocklyDeleteIconHighlighted {","fill: rgba(255, 255, 255, 0.20);","}",".blocklyCommentDeleteIcon {","cursor: pointer;","fill: #000;","display: none","}",".blocklySelected > .blocklyCommentDeleteIcon {","display: block","}"]);