/**
 * @license
 * Copyright 2012 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.FieldTextInput"),goog.require("Blockly.browserEvents"),goog.require("Blockly.Colours"),goog.require("Blockly.DropDownDiv"),goog.require("Blockly.Events"),goog.require("Blockly.Events.BlockChange"),goog.require("Blockly.Field"),goog.require("Blockly.fieldRegistry"),goog.require("Blockly.Msg"),goog.require("Blockly.pxtBlocklyUtils"),goog.require("Blockly.utils"),goog.require("Blockly.utils.aria"),goog.require("Blockly.utils.Coordinate"),goog.require("Blockly.utils.dom"),goog.require("Blockly.utils.KeyCodes"),goog.require("Blockly.utils.object"),goog.require("Blockly.utils.userAgent"),goog.require("Blockly.WidgetDiv"),goog.requireType("Blockly.BlockSvg"),goog.requireType("Blockly.WorkspaceSvg"),Blockly.FieldTextInput=function(t,e,l){this.spellcheck_=!0,Blockly.FieldTextInput.superClass_.constructor.call(this,t,e,l),this.htmlInput_=null,this.onKeyDownWrapper_=null,this.onKeyInputWrapper_=null,this.fullBlockClickTarget_=!1,this.workspace_=null},Blockly.utils.object.inherits(Blockly.FieldTextInput,Blockly.Field),Blockly.FieldTextInput.prototype.DEFAULT_VALUE="",Blockly.FieldTextInput.fromJson=function(t){var e=Blockly.utils.replaceMessageReferences(t.text);return new Blockly.FieldTextInput(e,void 0,t)},Blockly.FieldTextInput.ANIMATION_TIME=.25,Blockly.FieldTextInput.TEXT_MEASURE_PADDING_MAGIC=45,Blockly.FieldTextInput.prototype.htmlInput_=null,Blockly.FieldTextInput.prototype.SERIALIZABLE=!0,Blockly.FieldTextInput.BORDERRADIUS=4,Blockly.FieldTextInput.prototype.CURSOR="text",Blockly.FieldTextInput.prototype.configure_=function(t){Blockly.FieldTextInput.superClass_.configure_.call(this,t),"boolean"==typeof t.spellcheck&&(this.spellcheck_=t.spellcheck)},Blockly.FieldTextInput.prototype.initView=function(){if(this.getConstants().FULL_BLOCK_FIELDS){for(var t,e=0,l=0,o=0;t=this.sourceBlock_.inputList[o];o++){for(var i=0;t.fieldRow[i];i++)e++;t.connection&&l++}this.fullBlockClickTarget_=e<=1&&this.sourceBlock_.outputConnection&&!l}else this.fullBlockClickTarget_=!1;this.fullBlockClickTarget_?this.clickTarget_=this.sourceBlock_.getSvgRoot():this.createBorderRect_(),this.createTextElement_()},Blockly.FieldTextInput.prototype.autoCapitalize_=!0,Blockly.FieldTextInput.prototype.onMouseOver_=function(t){if(!this.sourceBlock_.isInFlyout){var e=this.sourceBlock_.workspace.getGesture(t);e&&e.isDragging()||this.sourceBlock_.pathObject.svgPath&&Blockly.utils.dom.addClass(this.sourceBlock_.pathObject.svgPath,"blocklyFieldHover")}},Blockly.FieldTextInput.prototype.onMouseOut_=function(t){if(!this.sourceBlock_.isInFlyout){var e=this.sourceBlock_.workspace.getGesture(t);e&&e.isDragging()||this.sourceBlock_.pathObject.svgPath&&Blockly.utils.dom.removeClass(this.sourceBlock_.pathObject.svgPath,"blocklyFieldHover")}},Blockly.FieldTextInput.prototype.dispose=function(){this.mouseOverWrapper_&&(Blockly.unbindEvent_(this.mouseOverWrapper_),this.mouseOverWrapper_=null),this.mouseOutWrapper_&&(Blockly.unbindEvent_(this.mouseOutWrapper_),this.mouseOutWrapper_=null),Blockly.WidgetDiv.hideIfOwner(this),Blockly.FieldTextInput.superClass_.dispose.call(this)},Blockly.FieldTextInput.prototype.doClassValidation_=function(t){return null==t?null:String(t)},Blockly.FieldTextInput.prototype.doValueInvalid_=function(t){if(this.isBeingEdited_){this.isTextValid_=!1;var e=this.value_;this.value_=this.htmlInput_.untypedDefaultValue_,this.sourceBlock_&&Blockly.Events.isEnabled()&&Blockly.Events.fire(new(Blockly.Events.get(Blockly.Events.BLOCK_CHANGE))(this.sourceBlock_,"field",this.name||null,e,this.value_))}},Blockly.FieldTextInput.prototype.doValueUpdate_=function(t){this.isTextValid_=!0,this.value_=t,this.isBeingEdited_||(this.isDirty_=!0)},Blockly.FieldTextInput.prototype.applyColour=function(){this.sourceBlock_&&this.getConstants().FULL_BLOCK_FIELDS&&(this.borderRect_?this.borderRect_.setAttribute("stroke",this.sourceBlock_.style.colourTertiary):this.sourceBlock_.pathObject.svgPath.setAttribute("fill",this.getConstants().FIELD_BORDER_RECT_COLOUR))},Blockly.FieldTextInput.prototype.render_=function(){if(Blockly.FieldTextInput.superClass_.render_.call(this),this.isBeingEdited_){this.resizeEditor_();var t=this.htmlInput_;this.isTextValid_?(Blockly.utils.dom.removeClass(t,"blocklyInvalidInput"),Blockly.utils.aria.setState(t,Blockly.utils.aria.State.INVALID,!1)):(Blockly.utils.dom.addClass(t,"blocklyInvalidInput"),Blockly.utils.aria.setState(t,Blockly.utils.aria.State.INVALID,!0))}},Blockly.FieldTextInput.prototype.setSpellcheck=function(t){t!=this.spellcheck_&&(this.spellcheck_=t,this.htmlInput_&&this.htmlInput_.setAttribute("spellcheck",this.spellcheck_))},Blockly.FieldTextInput.prototype.setAutoCapitalize=function(t){this.autoCapitalize_=t},Blockly.FieldTextInput.prototype.setRestrictor=function(t){this.restrictor_=t},Blockly.FieldTextInput.prototype.showEditor_=function(t,e,l,o,i){this.workspace_=this.sourceBlock_.workspace;var s=e||!1,n=l||!1;!s&&(Blockly.utils.userAgent.MOBILE||Blockly.utils.userAgent.ANDROID||Blockly.utils.userAgent.IPAD)?this.showPromptEditor_():this.showInlineEditor_(s,n,o,i)},Blockly.FieldTextInput.prototype.showPromptEditor_=function(){Blockly.prompt(Blockly.Msg.CHANGE_VALUE_TITLE,this.getText(),function(t){this.setValue(this.getValueFromEditorText_(t))}.bind(this))},Blockly.FieldTextInput.prototype.showInlineEditor_=function(t,e,l,o){Blockly.WidgetDiv.show(this,this.sourceBlock_.RTL,this.widgetDispose_.bind(this)),this.htmlInput_=this.widgetCreate_(e,l,o),this.isBeingEdited_=!0,o&&o.call(this),t||(this.focus(),this.htmlInput_.setSelectionRange(0,99999))},Blockly.FieldTextInput.prototype.widgetCreate_=function(t,e,l){var o=Blockly.WidgetDiv.DIV;Blockly.utils.dom.addClass(this.getClickTarget_(),"editing");var i=document.createElement("input");i.className="blocklyHtmlInput",i.setAttribute("spellcheck",this.spellcheck_),t&&i.setAttribute("readonly","true"),this.autoCapitalize_||i.setAttribute("autocapitalize","none");var s=this.workspace_.getScale(),n=this.getConstants().FIELD_TEXT_FONTSIZE*s+"pt";o.style.fontSize=n,i.style.fontSize=n;var r=Blockly.FieldTextInput.BORDERRADIUS*s+"px";if(this.fullBlockClickTarget_){var u=this.getScaledBBox();r=(u.bottom-u.top)/2+"px";var c=this.sourceBlock_.getParent()?this.sourceBlock_.getParent().style.colourTertiary:this.sourceBlock_.style.colourTertiary;i.style.border=1*s+"px solid "+c,o.style.borderRadius=r,o.style.transition="box-shadow 0.25s ease 0s",this.getConstants().FIELD_TEXTINPUT_BOX_SHADOW&&(o.style.boxShadow="rgba(255, 255, 255, 0.3) 0px 0px 0px "+4*s+"px")}return i.style.borderRadius=r,o.appendChild(i),i.value=i.defaultValue=this.getEditorText_(this.value_),i.untypedDefaultValue_=this.value_,i.oldValue_=null,this.resizeEditor_(),this.bindInputEvents_(i),i},Blockly.FieldTextInput.prototype.widgetDispose_=function(){this.isBeingEdited_=!1,this.isTextValid_=!0,this.forceRerender(),this.onFinishEditing_&&this.onFinishEditing_(this.value_),this.unbindInputEvents_(),this.htmlInput_.dropDownArrowMouseWrapper_&&Blockly.unbindEvent_(this.htmlInput_.dropDownArrowMouseWrapper_);var t=Blockly.WidgetDiv.DIV.style;t.width="auto",t.height="auto",t.fontSize="",t.transition="",t.boxShadow="",this.htmlInput_=null,Blockly.utils.dom.removeClass(this.getClickTarget_(),"editing")},Blockly.FieldTextInput.prototype.bindInputEvents_=function(t){this.onKeyDownWrapper_=Blockly.browserEvents.conditionalBind(t,"keydown",this,this.onHtmlInputKeyDown_),this.onKeyInputWrapper_=Blockly.browserEvents.conditionalBind(t,"input",this,this.onHtmlInputChange_)},Blockly.FieldTextInput.prototype.unbindInputEvents_=function(){this.onKeyDownWrapper_&&(Blockly.browserEvents.unbind(this.onKeyDownWrapper_),this.onKeyDownWrapper_=null),this.onKeyInputWrapper_&&(Blockly.browserEvents.unbind(this.onKeyInputWrapper_),this.onKeyInputWrapper_=null)},Blockly.FieldTextInput.prototype.onHtmlInputKeyDown_=function(t){t.keyCode==Blockly.utils.KeyCodes.ENTER?(Blockly.WidgetDiv.hide(),Blockly.DropDownDiv.hideWithoutAnimation()):t.keyCode==Blockly.utils.KeyCodes.ESC?(this.setValue(this.htmlInput_.untypedDefaultValue_),Blockly.WidgetDiv.hide(),Blockly.DropDownDiv.hideWithoutAnimation()):t.keyCode==Blockly.utils.KeyCodes.TAB&&(Blockly.WidgetDiv.hide(),Blockly.DropDownDiv.hideWithoutAnimation(),this.sourceBlock_.tab(this,!t.shiftKey),t.preventDefault())},Blockly.FieldTextInput.GECKO_KEYCODE_WHITELIST=[97,99,118,120],Blockly.FieldTextInput.prototype.onHtmlInputChange_=function(t){var e=this.htmlInput_.value;if(e!==this.htmlInput_.oldValue_){this.htmlInput_.oldValue_=e,Blockly.Events.setGroup(!0);var l=this.getValueFromEditorText_(e);this.setValue(l),this.forceRerender(),this.resizeEditor_(),Blockly.Events.setGroup(!1)}this.text_=this.htmlInput_.value,this.forceRerender(),Blockly.Events.setGroup(!1),this.resizeEditor_()},Blockly.FieldTextInput.prototype.focus=function(){this.htmlInput_.focus({preventScroll:!0}),this.htmlInput_.select()},Blockly.FieldTextInput.prototype.setEditorValue_=function(t){this.isDirty_=!0,this.isBeingEdited_&&(this.htmlInput_.value=this.getEditorText_(t)),this.setValue(t)},Blockly.FieldTextInput.prototype.resizeEditor_=function(){var t=Blockly.WidgetDiv.DIV,e=this.getScaledBBox();t.style.width=e.right-e.left+"px",t.style.height=e.bottom-e.top+"px";var l=this.sourceBlock_.RTL?e.right-t.offsetWidth:e.left,o=new Blockly.utils.Coordinate(l,e.top);t.style.left=o.x+"px",t.style.top=o.y+"px"},Blockly.FieldTextInput.prototype.isTabNavigable=function(){return!0},Blockly.FieldTextInput.prototype.getText_=function(){return this.isBeingEdited_&&this.htmlInput_?this.htmlInput_.value:null},Blockly.FieldTextInput.prototype.getEditorText_=function(t){return String(t)},Blockly.FieldTextInput.prototype.getValueFromEditorText_=function(t){return t},Blockly.fieldRegistry.register("field_input",Blockly.FieldTextInput);