/**
 * @license
 * Copyright 2011 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.ContextMenu"),goog.require("Blockly.browserEvents"),goog.require("Blockly.constants"),goog.require("Blockly.Events"),goog.require("Blockly.Events.BlockCreate"),goog.require("Blockly.Menu"),goog.require("Blockly.MenuItem"),goog.require("Blockly.Msg"),goog.require("Blockly.utils"),goog.require("Blockly.utils.aria"),goog.require("Blockly.utils.Coordinate"),goog.require("Blockly.utils.dom"),goog.require("Blockly.utils.Rect"),goog.require("Blockly.utils.userAgent"),goog.require("Blockly.WidgetDiv"),goog.require("Blockly.Xml"),goog.require("Blockly.MenuSeparator"),goog.requireType("Blockly.Block"),goog.requireType("Blockly.WorkspaceSvg"),Blockly.ContextMenu.currentBlock=null,Blockly.ContextMenu.menu_=null,Blockly.ContextMenu.show=function(e,o,l){if(Blockly.WidgetDiv.show(Blockly.ContextMenu,l,Blockly.ContextMenu.dispose),o.length){var t=Blockly.ContextMenu.populate_(o,l);Blockly.ContextMenu.menu_=t,Blockly.ContextMenu.position_(t,e,l),setTimeout(function(){t.focus()},1),Blockly.ContextMenu.currentBlock=null}else Blockly.ContextMenu.hide()},Blockly.ContextMenu.populate_=function(e,o){var l=new Blockly.Menu;l.setRole(Blockly.utils.aria.Role.MENU);for(var t,n=0;t=e[n];n++){var c=t.separator?new Blockly.MenuSeparator:new Blockly.MenuItem(t.text);if(c.setRightToLeft(o),!t.separator&&(c.setRole(Blockly.utils.aria.Role.MENUITEM),l.addChild(c),c.setEnabled(t.enabled),t.enabled)){var i=function(e){Blockly.ContextMenu.hide(),this.callback(this.scope)};c.onAction(i,t)}}return l},Blockly.ContextMenu.position_=function(e,o,l){var t=Blockly.utils.getViewportBBox(),n=new Blockly.utils.Rect(o.clientY+t.top,o.clientY+t.top,o.clientX+t.left,o.clientX+t.left);Blockly.ContextMenu.createWidget_(e);var c=e.getSize();l&&(n.left+=c.width,n.right+=c.width,t.left+=c.width,t.right+=c.width),Blockly.WidgetDiv.positionWithAnchor(t,n,c,l),e.focus()},Blockly.ContextMenu.createWidget_=function(e){var o=Blockly.WidgetDiv.DIV;e.render(o);var l=e.getElement();Blockly.utils.dom.addClass(l,"blocklyContextMenu"),Blockly.browserEvents.conditionalBind(l,"contextmenu",null,Blockly.utils.noEvent),e.focus()},Blockly.ContextMenu.hide=function(){Blockly.WidgetDiv.hideIfOwner(Blockly.ContextMenu),Blockly.ContextMenu.currentBlock=null},Blockly.ContextMenu.dispose=function(){Blockly.ContextMenu.menu_&&(Blockly.ContextMenu.menu_.dispose(),Blockly.ContextMenu.menu_=null)},Blockly.ContextMenu.callbackFactory=function(e,o){return function(){Blockly.Events.disable();try{var l=Blockly.Xml.domToBlock(o,e.workspace),t=e.getRelativeToSurfaceXY();e.RTL?t.x-=Blockly.SNAP_RADIUS:t.x+=Blockly.SNAP_RADIUS,t.y+=2*Blockly.SNAP_RADIUS,l.moveBy(t.x,t.y)}finally{Blockly.Events.enable()}Blockly.Events.isEnabled()&&!l.isShadow()&&Blockly.Events.fire(new(Blockly.Events.get(Blockly.Events.BLOCK_CREATE))(l)),l.select()}},Blockly.ContextMenu.commentDeleteOption=function(e){return{text:Blockly.Msg.REMOVE_COMMENT,enabled:!e.workspace.options.debugMode,callback:function(){Blockly.Events.setGroup(!0),e.dispose(!0,!0),Blockly.Events.setGroup(!1)}}},Blockly.ContextMenu.commentDuplicateOption=function(e){return{text:Blockly.Msg.DUPLICATE_COMMENT,enabled:!e.workspace.options.debugMode,callback:function(){Blockly.duplicate(e)}}},Blockly.ContextMenu.workspaceCommentOption=function(e,o){if(!Blockly.WorkspaceCommentSvg)throw Error("Missing require for Blockly.WorkspaceCommentSvg");var l={enabled:!Blockly.utils.userAgent.IE&&!e.options.debugMode};return l.text=Blockly.Msg.ADD_COMMENT,l.callback=function(){!function(){var l=new Blockly.WorkspaceCommentSvg(e,Blockly.Msg.WORKSPACE_COMMENT_DEFAULT_TEXT,Blockly.WorkspaceCommentSvg.DEFAULT_SIZE,Blockly.WorkspaceCommentSvg.DEFAULT_SIZE),t=e.getInjectionDiv().getBoundingClientRect(),n=new Blockly.utils.Coordinate(o.clientX-t.left,o.clientY-t.top),c=e.getOriginOffsetInPixels(),i=Blockly.utils.Coordinate.difference(n,c);i.scale(1/e.scale);var r=i.x,u=i.y;l.moveBy(r,u),e.rendered&&(l.initSvg(),l.render(),l.select())}()},l};