/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.InsertionMarkerManager"),goog.require("Blockly.blockAnimations"),goog.require("Blockly.ComponentManager"),goog.require("Blockly.connectionTypes"),goog.require("Blockly.constants"),goog.require("Blockly.Events"),goog.requireType("Blockly.BlockSvg"),goog.requireType("Blockly.RenderedConnection"),goog.requireType("Blockly.utils.Coordinate"),goog.requireType("Blockly.WorkspaceSvg"),Blockly.InsertionMarkerManager=function(e){Blockly.selected=e,this.topBlock_=e,this.workspace_=e.workspace,this.lastOnStack_=null,this.lastMarker_=null,this.firstMarker_=this.createMarkerBlock_(this.topBlock_),this.closestConnection_=null,this.localConnection_=null,this.connectionLine_=null,this.connectionIndicator_=null,this.wouldDeleteBlock_=!1,this.markerConnection_=null,this.highlightedBlock_=null,this.fadedBlock_=null,this.availableConnections_=this.initAvailableConnections_()},Blockly.InsertionMarkerManager.PREVIEW_TYPE={INSERTION_MARKER:0,INPUT_OUTLINE:1,REPLACEMENT_FADE:2},Blockly.InsertionMarkerManager.DUPLICATE_BLOCK_ERROR="The insertion marker manager tried to create a marker but the result is missing %1. If you are using a mutator, make sure your domToMutation method is properly defined.",Blockly.InsertionMarkerManager.prototype.dispose=function(){this.availableConnections_.length=0,Blockly.Events.disable();try{this.firstMarker_&&this.firstMarker_.dispose(),this.lastMarker_&&this.lastMarker_.dispose()}finally{Blockly.Events.enable()}},Blockly.InsertionMarkerManager.prototype.updateAvailableConnections=function(){this.availableConnections_=this.initAvailableConnections_()},Blockly.InsertionMarkerManager.prototype.wouldDeleteBlock=function(){return this.wouldDeleteBlock_},Blockly.InsertionMarkerManager.prototype.wouldConnectBlock=function(){return!!this.closestConnection_},Blockly.InsertionMarkerManager.prototype.applyConnections=function(){if(this.closestConnection_&&(Blockly.Events.disable(),this.hidePreview_(),Blockly.Events.enable(),this.localConnection_.connect(this.closestConnection_),this.topBlock_.rendered)){var e=this.localConnection_.isSuperior()?this.closestConnection_:this.localConnection_;Blockly.blockAnimations.connectionUiEffect(e.getSourceBlock()),this.topBlock_.getRootBlock().bringToFront()}},Blockly.InsertionMarkerManager.prototype.update=function(e,t){var n=this.getCandidate_(e);this.wouldDeleteBlock_=this.shouldDelete_(n,t),(this.wouldDeleteBlock_||this.shouldUpdatePreviews_(n,e))&&(Blockly.Events.disable(),this.maybeHidePreview_(n),this.maybeShowPreview_(n),Blockly.Events.enable()),this.updateConnectionLine_(e)},Blockly.InsertionMarkerManager.prototype.createMarkerBlock_=function(e){var t=e.type;Blockly.Events.disable();try{this.workspace_.loadingEventsDisabled=!0;var n=this.workspace_.newBlock(t);if(this.workspace_.loadingEventsDisabled=!1,n.setInsertionMarker(!0),e.mutationToDom){var o=e.mutationToDom();o&&n.domToMutation(o)}for(var i=0;i<e.inputList.length;i++){var l=e.inputList[i];if(l.name!=Blockly.constants.COLLAPSED_INPUT_NAME&&!l.isVisible()){var r=n.inputList[i];if(!r)throw new Error(Blockly.InsertionMarkerManager.DUPLICATE_BLOCK_ERROR.replace("%1","an input"));for(var s=0;s<l.fieldRow.length;s++){var c=l.fieldRow[s],a=r.fieldRow[s];if(!a)throw new Error(Blockly.InsertionMarkerManager.DUPLICATE_BLOCK_ERROR.replace("%1","a field"));a.setValue(c.getValue())}}}n.setCollapsed(e.isCollapsed()),n.setInputsInline(e.getInputsInline()),n.initSvg(),n.getSvgRoot().setAttribute("visibility","hidden")}finally{Blockly.Events.enable()}return n},Blockly.InsertionMarkerManager.prototype.initAvailableConnections_=function(){var e=this.topBlock_.getConnections_(!1),t=this.topBlock_.lastConnectionInStack(!0);if(t&&t!=this.topBlock_.nextConnection){if(e.push(t),this.lastOnStack_=t,this.lastMarker_){Blockly.Events.disable();try{this.lastMarker_.dispose()}finally{Blockly.Events.enable()}}this.lastMarker_=this.createMarkerBlock_(t.getSourceBlock())}return e},Blockly.InsertionMarkerManager.prototype.shouldUpdatePreviews_=function(e,t){var n=e.local,o=e.closest,i=e.radius;if(!n||!o)return!(!this.localConnection_||!this.closestConnection_);if(this.localConnection_&&this.closestConnection_){if(this.closestConnection_==o&&this.localConnection_==n)return!1;var l=this.localConnection_.x+t.x-this.closestConnection_.x,r=this.localConnection_.y+t.y-this.closestConnection_.y,s=Math.sqrt(l*l+r*r);return!(o&&i>s-Blockly.CURRENT_CONNECTION_PREFERENCE)}return!this.localConnection_&&!this.closestConnection_||(console.error("Only one of localConnection_ and closestConnection_ was set."),console.error("Returning true from shouldUpdatePreviews, but it's not clear why."),!0)},Blockly.InsertionMarkerManager.prototype.getCandidate_=function(e){for(var t=this.getStartRadius_(),n=null,o=null,i=0;i<this.availableConnections_.length;i++){var l=this.availableConnections_[i],r=l.closest(t,e);r.connection&&(n=r.connection,o=l,t=r.radius)}return{closest:n,local:o,radius:t}},Blockly.InsertionMarkerManager.prototype.getStartRadius_=function(){return this.closestConnection_&&this.localConnection_?Blockly.CONNECTING_SNAP_RADIUS:Blockly.SNAP_RADIUS},Blockly.InsertionMarkerManager.prototype.shouldDelete_=function(e,t){if(t&&this.workspace_.getComponentManager().hasCapability(t.id,Blockly.ComponentManager.Capability.DELETE_AREA))return t.wouldDelete(this.topBlock_,e&&!!e.closest);return!1},Blockly.InsertionMarkerManager.prototype.maybeShowPreview_=function(e){if(!this.wouldDeleteBlock_){var t=e.closest,n=e.local;t&&(t==this.closestConnection_||t.getSourceBlock().isInsertionMarker()?console.log("Trying to connect to an insertion marker"):(this.closestConnection_=t,this.localConnection_=n,this.showPreview_()))}},Blockly.InsertionMarkerManager.prototype.showPreview_=function(){var e=this.closestConnection_,t=this.workspace_.getRenderer();switch(t.getConnectionPreviewMethod(e,this.localConnection_,this.topBlock_)){case Blockly.InsertionMarkerManager.PREVIEW_TYPE.INPUT_OUTLINE:this.showInsertionInputOutline_();break;case Blockly.InsertionMarkerManager.PREVIEW_TYPE.INSERTION_MARKER:this.showInsertionMarker_();break;case Blockly.InsertionMarkerManager.PREVIEW_TYPE.REPLACEMENT_FADE:this.showReplacementFade_()}e&&t.shouldHighlightConnection(e)&&e.highlight()},Blockly.InsertionMarkerManager.prototype.createConnectionLine_=function(){if(!this.connectionLine_){this.connectionLine_=Blockly.utils.dom.createSvgElement("line",{class:"blocklyConnectionLine",x1:0,y1:0,x2:0,y2:0},this.localConnection_.sourceBlock_.getSvgRoot()),this.connectionIndicator_=Blockly.utils.dom.createSvgElement("g",{class:"blocklyInputConnectionIndicator"},this.closestConnection_.sourceBlock_.getSvgRoot()),Blockly.utils.dom.createSvgElement("circle",{r:Blockly.CONNECTION_INDICATOR_RADIUS},this.connectionIndicator_);var e=this.closestConnection_.offsetInBlock_;this.connectionIndicator_.setAttribute("transform","translate("+e.x+","+e.y+")")}},Blockly.InsertionMarkerManager.prototype.updateConnectionLine_=function(e){if(this.closestConnection_&&this.localConnection_&&this.connectionLine_){var t=Blockly.CONNECTION_INDICATOR_RADIUS,n=this.localConnection_.offsetInBlock_,o=this.closestConnection_.x-this.localConnection_.x-e.x+n.x,i=this.closestConnection_.y-this.localConnection_.y-e.y+n.y,l=Math.atan2(i-n.y,o-n.x);Math.sqrt(Math.pow(o-n.x,2)+Math.pow(i-n.y,2))<2*t+1?Blockly.utils.dom.addClass(this.connectionLine_,"hidden"):(Blockly.utils.dom.removeClass(this.connectionLine_,"hidden"),this.connectionLine_.setAttribute("x1",n.x+Math.cos(l)*t),this.connectionLine_.setAttribute("y1",n.y+Math.sin(l)*t),this.connectionLine_.setAttribute("x2",o-Math.cos(l)*t),this.connectionLine_.setAttribute("y2",i-Math.sin(l)*t))}},Blockly.InsertionMarkerManager.prototype.hideConnectionLine_=function(){this.localConnection_&&this.connectionLine_&&(this.localConnection_.sourceBlock_.getSvgRoot().removeChild(this.connectionLine_),this.connectionLine_=null,this.closestConnection_.sourceBlock_.getSvgRoot().removeChild(this.connectionIndicator_),this.connectionIndicator_=null)},Blockly.InsertionMarkerManager.prototype.maybeHidePreview_=function(e){if(e.closest){var t=this.closestConnection_&&this.localConnection_,n=this.closestConnection_!=e.closest,o=this.localConnection_!=e.local;t&&(n||o||this.wouldDeleteBlock_)&&this.hidePreview_()}else this.hidePreview_();this.markerConnection_=null,this.closestConnection_=null,this.localConnection_=null},Blockly.InsertionMarkerManager.prototype.hidePreview_=function(){this.closestConnection_&&this.closestConnection_.targetBlock()&&this.workspace_.getRenderer().shouldHighlightConnection(this.closestConnection_)&&this.closestConnection_.unhighlight(),this.fadedBlock_?this.hideReplacementFade_():this.highlightedBlock_?this.hideInsertionInputOutline_():this.markerConnection_&&this.hideInsertionMarker_()},Blockly.InsertionMarkerManager.prototype.showInsertionMarker_=function(){var e=this.localConnection_,t=this.closestConnection_,n=this.lastOnStack_&&e==this.lastOnStack_?this.lastMarker_:this.firstMarker_,o=n.getMatchingConnection(e.getSourceBlock(),e);if(o==this.markerConnection_)throw Error("Made it to showInsertionMarker_ even though the marker isn't changing");n.render(),n.rendered=!0,n.getSvgRoot().setAttribute("visibility","visible"),o&&t&&n.positionNearConnection(o,t),t&&o.connect(t),this.markerConnection_=o},Blockly.InsertionMarkerManager.prototype.hideInsertionMarker_=function(){if(this.markerConnection_){var e=this.markerConnection_,t=e.getSourceBlock(),n=t.nextConnection,o=t.previousConnection,i=t.outputConnection,l=e==n&&!(o&&o.targetConnection),r=e.type==Blockly.connectionTypes.INPUT_VALUE&&!(i&&i.targetConnection);if(l||r)e.targetBlock().unplug(!1);else if(e.type==Blockly.connectionTypes.NEXT_STATEMENT&&e!=n){var s=e.targetConnection;s.getSourceBlock().unplug(!1);var c=o?o.targetConnection:null;t.unplug(!0),c&&c.connect(s)}else t.unplug(!0);if(e.targetConnection)throw Error("markerConnection_ still connected at the end of disconnectInsertionMarker");this.markerConnection_=null;var a=t.getSvgRoot();a&&a.setAttribute("visibility","hidden")}else console.log("No insertion marker connection to disconnect")},Blockly.InsertionMarkerManager.prototype.showInsertionInputOutline_=function(){var e=this.closestConnection_;this.highlightedBlock_=e.getSourceBlock(),this.highlightedBlock_.highlightShapeForInput(e,!0),this.createConnectionLine_()},Blockly.InsertionMarkerManager.prototype.hideInsertionInputOutline_=function(){this.highlightedBlock_.highlightShapeForInput(this.closestConnection_,!1),this.highlightedBlock_=null,this.hideConnectionLine_()},Blockly.InsertionMarkerManager.prototype.showReplacementFade_=function(){this.fadedBlock_=this.closestConnection_.targetBlock(),this.fadedBlock_.fadeForReplacement(!0),this.createConnectionLine_()},Blockly.InsertionMarkerManager.prototype.hideReplacementFade_=function(){this.fadedBlock_.fadeForReplacement(!1),this.fadedBlock_=null,this.hideConnectionLine_()},Blockly.InsertionMarkerManager.prototype.getInsertionMarkers=function(){var e=[];return this.firstMarker_&&e.push(this.firstMarker_),this.lastMarker_&&e.push(this.lastMarker_),e};