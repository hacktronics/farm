/**
 * @license
 * Copyright 2016 Massachusetts Institute of Technology
 * All rights reserved.
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.DropDownDiv"),goog.require("Blockly.utils.dom"),goog.require("Blockly.utils.math"),goog.require("Blockly.utils.Rect"),goog.require("Blockly.utils.style"),goog.requireType("Blockly.BlockSvg"),goog.requireType("Blockly.Field"),goog.requireType("Blockly.utils.Size"),goog.requireType("Blockly.WorkspaceSvg"),Blockly.DropDownDiv=function(){},Blockly.DropDownDiv.boundsElement_=null,Blockly.DropDownDiv.owner_=null,Blockly.DropDownDiv.positionToField_=null,Blockly.DropDownDiv.ARROW_SIZE=16,Blockly.DropDownDiv.BORDER_SIZE=1,Blockly.DropDownDiv.ARROW_HORIZONTAL_PADDING=12,Blockly.DropDownDiv.PADDING_Y=20,Blockly.DropDownDiv.ANIMATION_TIME=.25,Blockly.DropDownDiv.animateOutTimer_=null,Blockly.DropDownDiv.onHide_=null,Blockly.DropDownDiv.rendererClassName_="",Blockly.DropDownDiv.themeClassName_="",Blockly.DropDownDiv.BoundsInfo,Blockly.DropDownDiv.PositionMetrics,Blockly.DropDownDiv.createDom=function(){if(!Blockly.DropDownDiv.DIV_){var o=document.createElement("div");o.className="blocklyDropDownDiv",(Blockly.parentContainer||document.body).appendChild(o),Blockly.DropDownDiv.DIV_=o;var l=document.createElement("div");l.className="blocklyDropDownContent",o.appendChild(l),Blockly.DropDownDiv.content_=l;var D=document.createElement("div");D.className="blocklyDropDownArrow",o.appendChild(D),Blockly.DropDownDiv.arrow_=D,Blockly.DropDownDiv.DIV_.style.opacity=0,Blockly.DropDownDiv.DIV_.style.transition="transform "+Blockly.DropDownDiv.ANIMATION_TIME+"s, opacity "+Blockly.DropDownDiv.ANIMATION_TIME+"s",o.addEventListener("focusin",function(){Blockly.utils.dom.addClass(o,"blocklyFocused")}),o.addEventListener("focusout",function(){Blockly.utils.dom.removeClass(o,"blocklyFocused")})}},Blockly.DropDownDiv.setBoundsElement=function(o){Blockly.DropDownDiv.boundsElement_=o},Blockly.DropDownDiv.getContentDiv=function(){return Blockly.DropDownDiv.content_},Blockly.DropDownDiv.clearContent=function(){Blockly.DropDownDiv.content_.textContent="",Blockly.DropDownDiv.content_.style.width=""},Blockly.DropDownDiv.setColour=function(o,l){Blockly.DropDownDiv.DIV_.style.backgroundColor=o,Blockly.DropDownDiv.DIV_.style.borderColor=l},Blockly.DropDownDiv.showPositionedByBlock=function(o,l,D,i){return Blockly.DropDownDiv.showPositionedByRect_(Blockly.DropDownDiv.getScaledBboxOfBlock_(l),o,D,i)},Blockly.DropDownDiv.showPositionedByField=function(o,l,D){return Blockly.DropDownDiv.positionToField_=!0,Blockly.DropDownDiv.showPositionedByRect_(Blockly.DropDownDiv.getScaledBboxOfField_(o),o,l,D)},Blockly.DropDownDiv.getScaledBboxOfBlock_=function(o){var l=o.getSvgRoot(),D=l.getBBox(),i=o.workspace.scale,n=D.height*i,e=D.width*i,r=Blockly.utils.style.getPageOffset(l);return new Blockly.utils.Rect(r.y,r.y+n,r.x,r.x+e)},Blockly.DropDownDiv.getScaledBboxOfField_=function(o){var l=o.getScaledBBox();return new Blockly.utils.Rect(l.top,l.bottom,l.left,l.right)},Blockly.DropDownDiv.showPositionedByRect_=function(o,l,D,i){var n=o.left+(o.right-o.left)/2,e=o.bottom,r=n,t=o.top;i&&(t+=i);for(var c=l.getSourceBlock(),y=c.workspace;y.options.parentWorkspace;)y=y.options.parentWorkspace;return Blockly.DropDownDiv.setBoundsElement(y.getParentSvg().parentNode),Blockly.DropDownDiv.show(l,c.RTL,n,e,r,t,D)},Blockly.DropDownDiv.show=function(o,l,D,i,n,e,r){Blockly.DropDownDiv.owner_=o,Blockly.DropDownDiv.onHide_=r||null;var t=Blockly.DropDownDiv.DIV_;t.style.direction=l?"rtl":"ltr";var c=Blockly.getMainWorkspace();return Blockly.DropDownDiv.rendererClassName_=c.getRenderer().getClassName(),Blockly.DropDownDiv.themeClassName_=c.getTheme().getClassName(),Blockly.utils.dom.addClass(t,Blockly.DropDownDiv.rendererClassName_),Blockly.utils.dom.addClass(t,Blockly.DropDownDiv.themeClassName_),Blockly.DropDownDiv.positionInternal_(D,i,n,e)},Blockly.DropDownDiv.getBoundsInfo_=function(){var o=Blockly.utils.style.getPageOffset(Blockly.DropDownDiv.boundsElement_),l=Blockly.utils.style.getSize(Blockly.DropDownDiv.boundsElement_);return{left:o.x,right:o.x+l.width,top:o.y,bottom:o.y+l.height,width:l.width,height:l.height}},Blockly.DropDownDiv.getPositionMetrics_=function(o,l,D,i){var n=Blockly.DropDownDiv.getBoundsInfo_(),e=Blockly.utils.style.getSize(Blockly.DropDownDiv.DIV_);return l+e.height<n.bottom?Blockly.DropDownDiv.getPositionBelowMetrics_(o,l,n,e):i-e.height>n.top?Blockly.DropDownDiv.getPositionAboveMetrics_(D,i,n,e):l+e.height<document.documentElement.clientHeight?Blockly.DropDownDiv.getPositionBelowMetrics_(o,l,n,e):i-e.height>document.documentElement.clientTop?Blockly.DropDownDiv.getPositionAboveMetrics_(D,i,n,e):Blockly.DropDownDiv.getPositionTopOfPageMetrics_(o,n,e)},Blockly.DropDownDiv.getPositionBelowMetrics_=function(o,l,D,i){var n=Blockly.DropDownDiv.getPositionX(o,D.left,D.right,i.width),e=-(Blockly.DropDownDiv.ARROW_SIZE/2+Blockly.DropDownDiv.BORDER_SIZE),r=l+Blockly.DropDownDiv.PADDING_Y;return{initialX:n.divX,initialY:l,finalX:n.divX,finalY:r,arrowX:n.arrowX,arrowY:e,arrowAtTop:!0,arrowVisible:!0}},Blockly.DropDownDiv.getPositionAboveMetrics_=function(o,l,D,i){var n=Blockly.DropDownDiv.getPositionX(o,D.left,D.right,i.width),e=i.height-2*Blockly.DropDownDiv.BORDER_SIZE-Blockly.DropDownDiv.ARROW_SIZE/2,r=l-i.height-Blockly.DropDownDiv.PADDING_Y,t=l-i.height;return{initialX:n.divX,initialY:t,finalX:n.divX,finalY:r,arrowX:n.arrowX,arrowY:e,arrowAtTop:!1,arrowVisible:!0}},Blockly.DropDownDiv.getPositionTopOfPageMetrics_=function(o,l,D){var i=Blockly.DropDownDiv.getPositionX(o,l.left,l.right,D.width);return{initialX:i.divX,initialY:0,finalX:i.divX,finalY:0,arrowAtTop:null,arrowX:null,arrowY:null,arrowVisible:!1}},Blockly.DropDownDiv.getPositionX=function(o,l,D,i){var n,e;n=e=o,e-=i/2,e=Blockly.utils.math.clamp(l,e,D-i);var r=(n-=Blockly.DropDownDiv.ARROW_SIZE/2)-e,t=Blockly.DropDownDiv.ARROW_HORIZONTAL_PADDING;return{arrowX:r=Blockly.utils.math.clamp(t,r,i-t-Blockly.DropDownDiv.ARROW_SIZE),divX:e}},Blockly.DropDownDiv.isVisible=function(){return!!Blockly.DropDownDiv.owner_},Blockly.DropDownDiv.isDisplayed=function(){return"none"!=Blockly.DropDownDiv.DIV_.style.display},Blockly.DropDownDiv.hideIfOwner=function(o,l){return Blockly.DropDownDiv.owner_===o&&(l?Blockly.DropDownDiv.hideWithoutAnimation():Blockly.DropDownDiv.hide(),!0)},Blockly.DropDownDiv.hide=function(){var o=Blockly.DropDownDiv.DIV_;o.style.transform="translate(0, 0)",o.style.opacity=0,Blockly.DropDownDiv.animateOutTimer_=setTimeout(function(){Blockly.DropDownDiv.hideWithoutAnimation()},1e3*Blockly.DropDownDiv.ANIMATION_TIME),Blockly.DropDownDiv.onHide_&&(Blockly.DropDownDiv.onHide_(),Blockly.DropDownDiv.onHide_=null)},Blockly.DropDownDiv.hideWithoutAnimation=function(){if(Blockly.DropDownDiv.isVisible()){Blockly.DropDownDiv.animateOutTimer_&&clearTimeout(Blockly.DropDownDiv.animateOutTimer_);var o=Blockly.DropDownDiv.DIV_;o.style.transform="",o.style.left="",o.style.top="",o.style.opacity=0,o.style.display="none",o.style.backgroundColor="",o.style.borderColor="",Blockly.DropDownDiv.onHide_&&(Blockly.DropDownDiv.onHide_(),Blockly.DropDownDiv.onHide_=null),Blockly.DropDownDiv.clearContent(),Blockly.DropDownDiv.owner_=null,Blockly.DropDownDiv.rendererClassName_&&(Blockly.utils.dom.removeClass(o,Blockly.DropDownDiv.rendererClassName_),Blockly.DropDownDiv.rendererClassName_=""),Blockly.DropDownDiv.themeClassName_&&(Blockly.utils.dom.removeClass(o,Blockly.DropDownDiv.themeClassName_),Blockly.DropDownDiv.themeClassName_=""),Blockly.getMainWorkspace().markFocused()}},Blockly.DropDownDiv.positionInternal_=function(o,l,D,i){var n=Blockly.DropDownDiv.getPositionMetrics_(o,l,D,i);n.arrowVisible?(Blockly.DropDownDiv.arrow_.style.display="",Blockly.DropDownDiv.arrow_.style.transform="translate("+n.arrowX+"px,"+n.arrowY+"px) rotate(45deg)",Blockly.DropDownDiv.arrow_.setAttribute("class",n.arrowAtTop?"blocklyDropDownArrow blocklyArrowTop":"blocklyDropDownArrow blocklyArrowBottom")):Blockly.DropDownDiv.arrow_.style.display="none";var e=Math.floor(n.initialX),r=Math.floor(n.initialY),t=Math.floor(n.finalX),c=Math.floor(n.finalY),y=Blockly.DropDownDiv.DIV_;y.style.left=e+"px",y.style.top=r+"px",y.style.display="block",y.style.opacity=1;var s=t-e,p=c-r;return y.style.transform="translate("+s+"px,"+p+"px)",!!n.arrowAtTop},Blockly.DropDownDiv.repositionForWindowResize=function(){if(Blockly.DropDownDiv.isVisible()&&Blockly.DropDownDiv.isDisplayed()){var o=Blockly.DropDownDiv.owner_,l=o.getSourceBlock(),D=Blockly.DropDownDiv.positionToField_?Blockly.DropDownDiv.getScaledBboxOfField_(o):Blockly.DropDownDiv.getScaledBboxOfBlock_(l),i=D.left+(D.right-D.left)/2,n=D.bottom,e=i,r=D.top;Blockly.DropDownDiv.positionInternal_(i,n,e,r)}else Blockly.DropDownDiv.hideWithoutAnimation()};