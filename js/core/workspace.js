/**
 * @license
 * Copyright 2012 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.Workspace"),goog.require("Blockly.ConnectionChecker"),goog.require("Blockly.Events"),goog.require("Blockly.IASTNodeLocation"),goog.require("Blockly.Options"),goog.require("Blockly.registry"),goog.require("Blockly.utils"),goog.require("Blockly.utils.math"),goog.require("Blockly.VariableMap"),goog.requireType("Blockly.Block"),goog.requireType("Blockly.ConnectionDB"),goog.requireType("Blockly.Events.Abstract"),goog.requireType("Blockly.IConnectionChecker"),goog.requireType("Blockly.utils.toolbox"),goog.requireType("Blockly.VariableModel"),Blockly.Workspace=function(o){this.id=Blockly.utils.genUid(),Blockly.Workspace.WorkspaceDB_[this.id]=this,this.options=o||new Blockly.Options({}),this.RTL=!!this.options.RTL,this.horizontalLayout=!!this.options.horizontalLayout,this.toolboxPosition=this.options.toolboxPosition,this.loadingEventsDisabled=!1;var t=Blockly.registry.getClassFromOptions(Blockly.registry.Type.CONNECTION_CHECKER,this.options,!0);this.connectionChecker=new t(this),this.topBlocks_=[],this.topComments_=[],this.commentDB_=Object.create(null),this.listeners_=[],this.tapListeners_=[],this.undoStack_=[],this.redoStack_=[],this.blockDB_=Object.create(null),this.typedBlocksDB_=Object.create(null),this.variableMap_=new Blockly.VariableMap(this),this.potentialVariableMap_=null},Blockly.Workspace.prototype.rendered=!1,Blockly.Workspace.prototype.isClearing=!1,Blockly.Workspace.prototype.MAX_UNDO=1024,Blockly.Workspace.prototype.connectionDBList=null,Blockly.Workspace.prototype.dispose=function(){this.listeners_.length=0,this.clear(),delete Blockly.Workspace.WorkspaceDB_[this.id]},Blockly.Workspace.SCAN_ANGLE=3,Blockly.Workspace.prototype.sortObjects_=function(o,t){var e=o.getRelativeToSurfaceXY(),l=t.getRelativeToSurfaceXY();return e.y+Blockly.Workspace.prototype.sortObjects_.offset*e.x-(l.y+Blockly.Workspace.prototype.sortObjects_.offset*l.x)},Blockly.Workspace.prototype.addTopBlock=function(o){this.topBlocks_.push(o)},Blockly.Workspace.prototype.removeTopBlock=function(o){if(!Blockly.utils.arrayRemove(this.topBlocks_,o))throw Error("Block not present in workspace's list of top-most blocks.")},Blockly.Workspace.prototype.getTopBlocks=function(o){var t=[].concat(this.topBlocks_);return o&&t.length>1&&(this.sortObjects_.offset=Math.sin(Blockly.utils.math.toRadians(Blockly.Workspace.SCAN_ANGLE)),this.RTL&&(this.sortObjects_.offset*=-1),t.sort(this.sortObjects_)),t},Blockly.Workspace.prototype.addTypedBlock=function(o){this.typedBlocksDB_[o.type]||(this.typedBlocksDB_[o.type]=[]),this.typedBlocksDB_[o.type].push(o)},Blockly.Workspace.prototype.removeTypedBlock=function(o){this.typedBlocksDB_[o.type].splice(this.typedBlocksDB_[o.type].indexOf(o),1),this.typedBlocksDB_[o.type].length||delete this.typedBlocksDB_[o.type]},Blockly.Workspace.prototype.getBlocksByType=function(o,t){if(!this.typedBlocksDB_[o])return[];var e=this.typedBlocksDB_[o].slice(0);return t&&e.length>1&&(this.sortObjects_.offset=Math.sin(Blockly.utils.math.toRadians(Blockly.Workspace.SCAN_ANGLE)),this.RTL&&(this.sortObjects_.offset*=-1),e.sort(this.sortObjects_)),e},Blockly.Workspace.prototype.addTopComment=function(o){this.topComments_.push(o),this.commentDB_[o.id]&&console.warn('Overriding an existing comment on this workspace, with id "'+o.id+'"'),this.commentDB_[o.id]=o},Blockly.Workspace.prototype.removeTopComment=function(o){if(!Blockly.utils.arrayRemove(this.topComments_,o))throw Error("Comment not present in workspace's list of top-most comments.");delete this.commentDB_[o.id]},Blockly.Workspace.prototype.getTopComments=function(o){var t=[].concat(this.topComments_);return o&&t.length>1&&(this.sortObjects_.offset=Math.sin(Blockly.utils.math.toRadians(Blockly.Workspace.SCAN_ANGLE)),this.RTL&&(this.sortObjects_.offset*=-1),t.sort(this.sortObjects_)),t},Blockly.Workspace.prototype.getAllBlocks=function(o){if(o)for(var t=this.getTopBlocks(!0),e=[],l=0;l<t.length;l++)e.push.apply(e,t[l].getDescendants(!0));else for(e=this.getTopBlocks(!1),l=0;l<e.length;l++)e.push.apply(e,e[l].getChildren(!1));return e.filter(function(o){return!o.isInsertionMarker()})},Blockly.Workspace.prototype.clear=function(){this.isClearing=!0;try{var o=Blockly.Events.getGroup();for(o||Blockly.Events.setGroup(!0);this.topBlocks_.length;)this.topBlocks_[0].dispose(!1);for(;this.topComments_.length;)this.topComments_[this.topComments_.length-1].dispose(!1);o||Blockly.Events.setGroup(!1),this.variableMap_.clear(),Blockly.DropDownDiv&&Blockly.DropDownDiv.hideWithoutAnimation(),Blockly.WidgetDiv&&Blockly.WidgetDiv.hide(!0),this.potentialVariableMap_&&this.potentialVariableMap_.clear()}finally{this.isClearing=!1}},Blockly.Workspace.prototype.renameVariableById=function(o,t){this.variableMap_.renameVariableById(o,t)},Blockly.Workspace.prototype.createVariable=function(o,t,e){return this.variableMap_.createVariable(o,t,e)},Blockly.Workspace.prototype.getVariableUsesById=function(o){return this.variableMap_.getVariableUsesById(o)},Blockly.Workspace.prototype.deleteVariableById=function(o){this.variableMap_.deleteVariableById(o)},Blockly.Workspace.prototype.getVariable=function(o,t){return this.variableMap_.getVariable(o,t)},Blockly.Workspace.prototype.getVariableById=function(o){return this.variableMap_.getVariableById(o)},Blockly.Workspace.prototype.getVariablesOfType=function(o){return this.variableMap_.getVariablesOfType(o)},Blockly.Workspace.prototype.getVariableTypes=function(){return this.variableMap_.getVariableTypes(this)},Blockly.Workspace.prototype.getAllVariables=function(){return this.variableMap_.getAllVariables()},Blockly.Workspace.prototype.getAllVariableNames=function(){return this.variableMap_.getAllVariableNames()},Blockly.Workspace.prototype.getWidth=function(){return 0},Blockly.Workspace.prototype.newBlock=function(o,t){var e=new Blockly.Block(this,o,t);return this.loadingEventsDisabled||e.onLoadedIntoWorkspace(),e},Blockly.Workspace.prototype.remainingCapacity=function(){return isNaN(this.options.maxBlocks)?1/0:this.options.maxBlocks-this.getAllBlocks(!1).length},Blockly.Workspace.prototype.remainingCapacityOfType=function(o){return this.options.maxInstances?(void 0!==this.options.maxInstances[o]?this.options.maxInstances[o]:1/0)-this.getBlocksByType(o,!1).length:1/0},Blockly.Workspace.prototype.isCapacityAvailable=function(o){if(!this.hasBlockLimits())return!0;var t=0;for(var e in o){if(o[e]>this.remainingCapacityOfType(e))return!1;t+=o[e]}return!(t>this.remainingCapacity())},Blockly.Workspace.prototype.hasBlockLimits=function(){return this.options.maxBlocks!=1/0||!!this.options.maxInstances},Blockly.Workspace.prototype.getUndoStack=function(){return this.undoStack_},Blockly.Workspace.prototype.getRedoStack=function(){return this.redoStack_},Blockly.Workspace.prototype.undo=function(o){var t=o?this.redoStack_:this.undoStack_,e=o?this.undoStack_:this.redoStack_,l=t.pop();if(l){for(var r=[l];t.length&&l.group&&l.group==t[t.length-1].group;)r.push(t.pop());for(var s=0;i=r[s];s++)e.push(i);r=Blockly.Events.filter(r,o),Blockly.Events.recordUndo=!1;try{var i;for(s=0;i=r[s];s++)i.run(o)}finally{Blockly.Events.recordUndo=!0}}},Blockly.Workspace.prototype.clearUndo=function(){this.undoStack_.length=0,this.redoStack_.length=0,Blockly.Events.clearPendingUndo()},Blockly.Workspace.prototype.addChangeListener=function(o){return this.listeners_.push(o),o},Blockly.Workspace.prototype.removeChangeListener=function(o){Blockly.utils.arrayRemove(this.listeners_,o)},Blockly.Workspace.prototype.fireChangeListener=function(o){if(o.recordUndo)for(this.undoStack_.push(o),this.redoStack_.length=0;this.undoStack_.length>this.MAX_UNDO&&this.MAX_UNDO>=0;)this.undoStack_.shift();for(var t,e=0;t=this.listeners_[e];e++)t(o)},Blockly.Workspace.prototype.getBlockById=function(o){return this.blockDB_[o]||null},Blockly.Workspace.prototype.getCommentById=function(o){return this.commentDB_[o]||null},Blockly.Workspace.prototype.addCommentById=function(o){this.commentDB_[o.id]&&console.warn('Overriding an existing comment on this workspace, with id "'+o.id+'"'),this.commentDB_[o.id]=o},Blockly.Workspace.prototype.removeCommentById=function(o){delete this.commentDB_[o]},Blockly.Workspace.prototype.setBlockById=function(o,t){this.blockDB_[o]=t},Blockly.Workspace.prototype.removeBlockById=function(o){delete this.blockDB_[o]},Blockly.Workspace.prototype.getCommentById=function(o){return this.commentDB_[o]||null},Blockly.Workspace.prototype.allInputsFilled=function(o){for(var t,e=this.getTopBlocks(!1),l=0;t=e[l];l++)if(!t.allInputsFilled(o))return!1;return!0},Blockly.Workspace.prototype.getPotentialVariableMap=function(){return this.potentialVariableMap_},Blockly.Workspace.prototype.createPotentialVariableMap=function(){this.potentialVariableMap_=new Blockly.VariableMap(this)},Blockly.Workspace.prototype.getVariableMap=function(){return this.variableMap_},Blockly.Workspace.prototype.setVariableMap=function(o){this.variableMap_=o},Blockly.Workspace.WorkspaceDB_=Object.create(null),Blockly.Workspace.getById=function(o){return Blockly.Workspace.WorkspaceDB_[o]||null},Blockly.Workspace.prototype.setDebugModeOption=function(o){this.options.debugMode=o},Blockly.Workspace.getAll=function(){var o=[];for(var t in Blockly.Workspace.WorkspaceDB_)o.push(Blockly.Workspace.WorkspaceDB_[t]);return o};