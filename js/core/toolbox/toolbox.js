/**
 * @license
 * Copyright 2020 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.Toolbox"),goog.require("Blockly.BlockSvg"),goog.require("Blockly.browserEvents"),goog.require("Blockly.CollapsibleToolboxCategory"),goog.require("Blockly.ComponentManager"),goog.require("Blockly.constants"),goog.require("Blockly.Css"),goog.require("Blockly.DeleteArea"),goog.require("Blockly.Events"),goog.require("Blockly.Events.ToolboxItemSelect"),goog.require("Blockly.IAutoHideable"),goog.require("Blockly.IKeyboardAccessible"),goog.require("Blockly.IStyleable"),goog.require("Blockly.IToolbox"),goog.require("Blockly.Options"),goog.require("Blockly.registry"),goog.require("Blockly.Touch"),goog.require("Blockly.utils"),goog.require("Blockly.utils.aria"),goog.require("Blockly.utils.dom"),goog.require("Blockly.utils.Rect"),goog.require("Blockly.utils.toolbox"),goog.requireType("Blockly.ICollapsibleToolboxItem"),goog.requireType("Blockly.IDraggable"),goog.requireType("Blockly.IFlyout"),goog.requireType("Blockly.ISelectableToolboxItem"),goog.requireType("Blockly.IToolboxItem"),goog.requireType("Blockly.ShortcutRegistry"),goog.requireType("Blockly.WorkspaceSvg"),Blockly.Toolbox=function(t){Blockly.Toolbox.superClass_.constructor.call(this),this.workspace_=t,this.id="toolbox",this.toolboxDef_=t.options.languageTree||{contents:[]},this.horizontalLayout_=t.options.horizontalLayout,this.HtmlDiv=null,this.contentsDiv_=null,this.isVisible_=!1,this.contents_=[],this.width_=0,this.height_=0,this.RTL=t.options.RTL,this.flyout_=null,this.contentMap_=Object.create(null),this.toolboxPosition=t.options.toolboxPosition,this.selectedItem_=null,this.previouslySelectedItem_=null,this.boundEvents_=[]},Blockly.utils.object.inherits(Blockly.Toolbox,Blockly.DeleteArea),Blockly.Toolbox.prototype.onShortcut=function(t){return!1},Blockly.Toolbox.prototype.init=function(){var t=this.workspace_,o=t.getParentSvg();this.flyout_=this.createFlyout_(),this.HtmlDiv=this.createDom_(this.workspace_),Blockly.utils.dom.insertAfter(this.flyout_.createDom("svg"),o),this.setVisible(!0),this.flyout_.init(t),this.render(this.toolboxDef_);var e=t.getThemeManager();e.subscribe(this.HtmlDiv,"toolboxBackgroundColour","background-color"),e.subscribe(this.HtmlDiv,"toolboxForegroundColour","color"),this.workspace_.getComponentManager().addComponent({component:this,weight:1,capabilities:[Blockly.ComponentManager.Capability.AUTOHIDEABLE,Blockly.ComponentManager.Capability.DELETE_AREA,Blockly.ComponentManager.Capability.DRAG_TARGET]})},Blockly.Toolbox.prototype.createDom_=function(t){var o=t.getParentSvg(),e=this.createContainer_();return this.contentsDiv_=this.createContentsContainer_(),this.contentsDiv_.tabIndex=0,Blockly.utils.aria.setRole(this.contentsDiv_,Blockly.utils.aria.Role.TREE),e.appendChild(this.contentsDiv_),o.parentNode.insertBefore(e,o),this.attachEvents_(e,this.contentsDiv_),e},Blockly.Toolbox.prototype.createContainer_=function(){var t=document.createElement("div");return t.setAttribute("layout",this.isHorizontal()?"h":"v"),Blockly.utils.dom.addClass(t,"blocklyToolboxDiv"),Blockly.utils.dom.addClass(t,"blocklyNonSelectable"),t.setAttribute("dir",this.RTL?"RTL":"LTR"),t},Blockly.Toolbox.prototype.createContentsContainer_=function(){var t=document.createElement("div");return Blockly.utils.dom.addClass(t,"blocklyToolboxContents"),this.isHorizontal()&&(t.style.flexDirection="row"),t},Blockly.Toolbox.prototype.attachEvents_=function(t,o){var e=Blockly.browserEvents.conditionalBind(t,"click",this,this.onClick_,!1,!0);this.boundEvents_.push(e);var l=Blockly.browserEvents.conditionalBind(o,"keydown",this,this.onKeyDown_,!1,!0);this.boundEvents_.push(l)},Blockly.Toolbox.prototype.onClick_=function(t){if(Blockly.utils.isRightButton(t)||t.target==this.HtmlDiv)Blockly.hideChaff(!1);else{var o=t.target.getAttribute("id");if(o){var e=this.getToolboxItemById(o);e&&e.isSelectable()&&(this.setSelectedItem(e),e.onClick(t))}Blockly.hideChaff(!0)}Blockly.Touch.clearTouchIdentifier()},Blockly.Toolbox.prototype.onKeyDown_=function(t){var o=!1;switch(t.keyCode){case Blockly.utils.KeyCodes.DOWN:o=this.selectNext_();break;case Blockly.utils.KeyCodes.UP:o=this.selectPrevious_();break;case Blockly.utils.KeyCodes.LEFT:o=this.selectParent_();break;case Blockly.utils.KeyCodes.RIGHT:o=this.selectChild_();break;case Blockly.utils.KeyCodes.ENTER:case Blockly.utils.KeyCodes.SPACE:if(this.selectedItem_&&this.selectedItem_.isCollapsible())this.selectedItem_.toggleExpanded(),o=!0;break;default:o=!1}!o&&this.selectedItem_&&this.selectedItem_.onKeyDown&&(o=this.selectedItem_.onKeyDown(t)),o&&t.preventDefault()},Blockly.Toolbox.prototype.createFlyout_=function(){var t=this.workspace_,o=new Blockly.Options({parentWorkspace:t,rtl:t.RTL,oneBasedIndex:t.options.oneBasedIndex,horizontalLayout:t.horizontalLayout,renderer:t.options.renderer,rendererOverrides:t.options.rendererOverrides,move:{scrollbars:!0}});o.toolboxPosition=t.options.toolboxPosition;return new(t.horizontalLayout?Blockly.registry.getClassFromOptions(Blockly.registry.Type.FLYOUTS_HORIZONTAL_TOOLBOX,t.options,!0):Blockly.registry.getClassFromOptions(Blockly.registry.Type.FLYOUTS_VERTICAL_TOOLBOX,t.options,!0))(o)},Blockly.Toolbox.prototype.render=function(t){this.toolboxDef_=t;for(var o=0;o<this.contents_.length;o++){var e=this.contents_[o];e&&e.dispose()}this.contents_=[],this.contentMap_=Object.create(null),this.renderContents_(t.contents),this.position(),this.handleToolboxItemResize()},Blockly.Toolbox.prototype.renderContents_=function(t){for(var o,e=document.createDocumentFragment(),l=0;o=t[l];l++)this.createToolboxItem_(o,e);this.contentsDiv_.appendChild(e)},Blockly.Toolbox.prototype.createToolboxItem_=function(t,o){var e=t.kind;"CATEGORY"==e.toUpperCase()&&Blockly.utils.toolbox.isCategoryCollapsible(t)&&(e=Blockly.CollapsibleToolboxCategory.registrationName);var l=Blockly.registry.getClass(Blockly.registry.Type.TOOLBOX_ITEM,e.toLowerCase());if(l){var i=new l(t,this);this.addToolboxItem_(i),i.init();var s=i.getDiv();s&&o.appendChild(s),i.getClickTarget&&i.getClickTarget().setAttribute("id",i.getId())}},Blockly.Toolbox.prototype.addToolboxItem_=function(t){if(this.contents_.push(t),this.contentMap_[t.getId()]=t,t.isCollapsible())for(var o,e=t,l=0;o=e.getChildToolboxItems()[l];l++)this.addToolboxItem_(o)},Blockly.Toolbox.prototype.getToolboxItems=function(){return this.contents_},Blockly.Toolbox.prototype.addStyle=function(t){Blockly.utils.dom.addClass(this.HtmlDiv,t)},Blockly.Toolbox.prototype.removeStyle=function(t){Blockly.utils.dom.removeClass(this.HtmlDiv,t)},Blockly.Toolbox.prototype.getClientRect=function(){if(!this.HtmlDiv||!this.isVisible_)return null;var t=1e7,o=this.HtmlDiv.getBoundingClientRect(),e=o.top,l=e+o.height,i=o.left,s=i+o.width;return this.toolboxPosition==Blockly.utils.toolbox.Position.TOP?new Blockly.utils.Rect(-t,l,-t,t):this.toolboxPosition==Blockly.utils.toolbox.Position.BOTTOM?new Blockly.utils.Rect(e,t,-t,t):this.toolboxPosition==Blockly.utils.toolbox.Position.LEFT?new Blockly.utils.Rect(-t,t,-t,s):new Blockly.utils.Rect(-t,t,i,t)},Blockly.Toolbox.prototype.wouldDelete=function(t,o){if(t instanceof Blockly.BlockSvg){var e=t;this.updateWouldDelete_(!e.getParent()&&e.isDeletable())}else this.updateWouldDelete_(t.isDeletable());return this.wouldDelete_},Blockly.Toolbox.prototype.onDragEnter=function(t){this.updateCursorDeleteStyle_(!0)},Blockly.Toolbox.prototype.onDragExit=function(t){this.updateCursorDeleteStyle_(!1)},Blockly.Toolbox.prototype.onDrop=function(t){this.updateCursorDeleteStyle_(!1)},Blockly.Toolbox.prototype.updateWouldDelete_=function(t){t!==this.wouldDelete_&&(this.updateCursorDeleteStyle_(!1),this.wouldDelete_=t,this.updateCursorDeleteStyle_(!0))},Blockly.Toolbox.prototype.updateCursorDeleteStyle_=function(t){var o=this.wouldDelete_?"blocklyToolboxDelete":"blocklyToolboxGrab";t?this.addStyle(o):this.removeStyle(o)},Blockly.Toolbox.prototype.getToolboxItemById=function(t){return this.contentMap_[t]||null},Blockly.Toolbox.prototype.getWidth=function(){return this.width_},Blockly.Toolbox.prototype.getHeight=function(){return this.height_},Blockly.Toolbox.prototype.getFlyout=function(){return this.flyout_},Blockly.Toolbox.prototype.setFlyout=function(t){this.flyout_=t},Blockly.Toolbox.prototype.getWorkspace=function(){return this.workspace_},Blockly.Toolbox.prototype.getSelectedItem=function(){return this.selectedItem_},Blockly.Toolbox.prototype.getPreviouslySelectedItem=function(){return this.previouslySelectedItem_},Blockly.Toolbox.prototype.isHorizontal=function(){return this.horizontalLayout_},Blockly.Toolbox.prototype.position=function(){var t=this.workspace_.getMetrics(),o=this.HtmlDiv;o&&(this.horizontalLayout_?(o.style.left="0",o.style.height="auto",o.style.width="100%",this.height_=o.offsetHeight,this.width_=t.viewWidth,this.toolboxPosition==Blockly.utils.toolbox.Position.TOP?o.style.top="0":o.style.bottom="0"):(this.toolboxPosition==Blockly.utils.toolbox.Position.RIGHT?o.style.right="0":o.style.left="0",o.style.height="100%",this.width_=o.offsetWidth,this.height_=t.viewHeight),this.flyout_.position())},Blockly.Toolbox.prototype.handleToolboxItemResize=function(){var t=this.workspace_,o=this.HtmlDiv.getBoundingClientRect(),e=this.toolboxPosition==Blockly.utils.toolbox.Position.LEFT?t.scrollX+o.width:t.scrollX,l=this.toolboxPosition==Blockly.utils.toolbox.Position.TOP?t.scrollY+o.height:t.scrollY;t.translate(e,l),Blockly.svgResize(t)},Blockly.Toolbox.prototype.clearSelection=function(){this.setSelectedItem(null)},Blockly.Toolbox.prototype.refreshTheme=function(){for(var t=0;t<this.contents_.length;t++){var o=this.contents_[t];o.refreshTheme&&o.refreshTheme()}},Blockly.Toolbox.prototype.refreshSelection=function(){this.selectedItem_&&this.selectedItem_.isSelectable()&&this.selectedItem_.getContents().length&&this.flyout_.show(this.selectedItem_.getContents())},Blockly.Toolbox.prototype.setVisible=function(t){this.isVisible_!==t&&(this.HtmlDiv.style.display=t?"block":"none",this.isVisible_=t,this.workspace_.recordDragTargets())},Blockly.Toolbox.prototype.autoHide=function(t){!t&&this.flyout_&&this.flyout_.autoClose&&this.clearSelection()},Blockly.Toolbox.prototype.setSelectedItem=function(t){var o=this.selectedItem_;!t&&!o||t&&!t.isSelectable()||(this.shouldDeselectItem_(o,t)&&null!=o&&this.deselectItem_(o),this.shouldSelectItem_(o,t)&&null!=t&&this.selectItem_(o,t),this.updateFlyout_(o,t),this.fireSelectEvent_(o,t))},Blockly.Toolbox.prototype.shouldDeselectItem_=function(t,o){return null!=t&&(!t.isCollapsible()||t!=o)},Blockly.Toolbox.prototype.shouldSelectItem_=function(t,o){return null!=o&&o!=t},Blockly.Toolbox.prototype.deselectItem_=function(t){this.selectedItem_=null,this.previouslySelectedItem_=t,t.setSelected(!1),Blockly.utils.aria.setState(this.contentsDiv_,Blockly.utils.aria.State.ACTIVEDESCENDANT,"")},Blockly.Toolbox.prototype.selectItem_=function(t,o){this.selectedItem_=o,this.previouslySelectedItem_=t,o.setSelected(!0),Blockly.utils.aria.setState(this.contentsDiv_,Blockly.utils.aria.State.ACTIVEDESCENDANT,o.getId())},Blockly.Toolbox.prototype.selectItemByPosition=function(t){if(t>-1&&t<this.contents_.length){var o=this.contents_[t];o.isSelectable()&&this.setSelectedItem(o)}},Blockly.Toolbox.prototype.updateFlyout_=function(t,o){(t!=o||o.isCollapsible())&&o&&o.getContents().length?(this.flyout_.show(o.getContents()),this.flyout_.scrollToStart()):this.flyout_.hide()},Blockly.Toolbox.prototype.fireSelectEvent_=function(t,o){var e=t&&t.getName(),l=o&&o.getName();t==o&&(l=null);var i=new(Blockly.Events.get(Blockly.Events.TOOLBOX_ITEM_SELECT))(e,l,this.workspace_.id);Blockly.Events.fire(i)},Blockly.Toolbox.prototype.selectParent_=function(){return!!this.selectedItem_&&(this.selectedItem_.isCollapsible()&&this.selectedItem_.isExpanded()?(this.selectedItem_.setExpanded(!1),!0):!(!this.selectedItem_.getParent()||!this.selectedItem_.getParent().isSelectable())&&(this.setSelectedItem(this.selectedItem_.getParent()),!0))},Blockly.Toolbox.prototype.selectChild_=function(){if(!this.selectedItem_||!this.selectedItem_.isCollapsible())return!1;var t=this.selectedItem_;return t.isExpanded()?(this.selectNext_(),!0):(t.setExpanded(!0),!0)},Blockly.Toolbox.prototype.selectNext_=function(){if(!this.selectedItem_)return!1;var t=this.contents_.indexOf(this.selectedItem_)+1;if(t>-1&&t<this.contents_.length){for(var o=this.contents_[t];o&&!o.isSelectable();)o=this.contents_[++t];if(o&&o.isSelectable())return this.setSelectedItem(o),!0}return!1},Blockly.Toolbox.prototype.selectPrevious_=function(){if(!this.selectedItem_)return!1;var t=this.contents_.indexOf(this.selectedItem_)-1;if(t>-1&&t<this.contents_.length){for(var o=this.contents_[t];o&&!o.isSelectable();)o=this.contents_[--t];if(o&&o.isSelectable())return this.setSelectedItem(o),!0}return!1},Blockly.Toolbox.prototype.dispose=function(){this.workspace_.getComponentManager().removeComponent("toolbox"),this.flyout_.dispose();for(var t=0;t<this.contents_.length;t++){this.contents_[t].dispose()}for(var o=0;o<this.boundEvents_.length;o++)Blockly.browserEvents.unbind(this.boundEvents_[o]);this.boundEvents_=[],this.contents_=[],this.workspace_.getThemeManager().unsubscribe(this.HtmlDiv),Blockly.utils.dom.removeNode(this.HtmlDiv)},Blockly.Css.register([".blocklyToolboxDelete {",'cursor: url("<<<PATH>>>/handdelete.cur"), auto;',"}",".blocklyToolboxGrab {",'cursor: url("<<<PATH>>>/handclosed.cur"), auto;',"cursor: grabbing;","cursor: -webkit-grabbing;","}",".blocklyToolboxDiv {","background-color: #A2B129;","color: #fff;","overflow-x: visible;","overflow-y: auto;","padding: 4px 0 4px 0;","position: absolute;","z-index: 70;","-webkit-tap-highlight-color: transparent;","}",".blocklyToolboxContents {","display: flex;","flex-wrap: wrap;","flex-direction: column;","}",".blocklyToolboxContents:focus {","outline: none;","}"]),Blockly.registry.register(Blockly.registry.Type.TOOLBOX,Blockly.registry.DEFAULT,Blockly.Toolbox);