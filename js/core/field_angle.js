/**
 * @license
 * Copyright 2013 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.FieldAngle"),goog.require("Blockly.browserEvents"),goog.require("Blockly.Css"),goog.require("Blockly.DropDownDiv"),goog.require("Blockly.fieldRegistry"),goog.require("Blockly.FieldTextInput"),goog.require("Blockly.utils.dom"),goog.require("Blockly.utils.KeyCodes"),goog.require("Blockly.utils.math"),goog.require("Blockly.utils.object"),goog.require("Blockly.utils.Svg"),goog.require("Blockly.utils.userAgent"),goog.require("Blockly.WidgetDiv"),Blockly.FieldAngle=function(l,e,i){this.clockwise_=Blockly.FieldAngle.CLOCKWISE,this.offset_=Blockly.FieldAngle.OFFSET,this.wrap_=Blockly.FieldAngle.WRAP,this.round_=Blockly.FieldAngle.ROUND,Blockly.FieldAngle.superClass_.constructor.call(this,l,e,i),this.editor_=null,this.gauge_=null,this.line_=null,this.clickWrapper_=null,this.clickSurfaceWrapper_=null,this.moveSurfaceWrapper_=null,this.addArgType("angle")},Blockly.utils.object.inherits(Blockly.FieldAngle,Blockly.FieldTextInput),Blockly.FieldAngle.prototype.DEFAULT_VALUE=0,Blockly.FieldAngle.fromJson=function(l){return new Blockly.FieldAngle(l.angle,void 0,l)},Blockly.FieldAngle.prototype.SERIALIZABLE=!0,Blockly.FieldAngle.ROUND=15,Blockly.FieldAngle.HALF=60,Blockly.FieldAngle.CLOCKWISE=!0,Blockly.FieldAngle.OFFSET=90,Blockly.FieldAngle.WRAP=180,Blockly.FieldAngle.HANDLE_RADIUS=10,Blockly.FieldAngle.ARROW_WIDTH=Blockly.FieldAngle.HANDLE_RADIUS,Blockly.FieldAngle.RADIUS=Blockly.FieldAngle.HALF-Blockly.FieldAngle.HANDLE_RADIUS-1,Blockly.FieldAngle.CENTER_RADIUS=2,Blockly.FieldAngle.ARROW_SVG_DATAURI="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjxzdmcKICAgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIgogICB4bWxuczpjYz0iaHR0cDovL2NyZWF0aXZlY29tbW9ucy5vcmcvbnMjIgogICB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiCiAgIHhtbG5zOnN2Zz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIKICAgeG1sbnM6c29kaXBvZGk9Imh0dHA6Ly9zb2RpcG9kaS5zb3VyY2Vmb3JnZS5uZXQvRFREL3NvZGlwb2RpLTAuZHRkIgogICB4bWxuczppbmtzY2FwZT0iaHR0cDovL3d3dy5pbmtzY2FwZS5vcmcvbmFtZXNwYWNlcy9pbmtzY2FwZSIKICAgd2lkdGg9IjhweCIKICAgaGVpZ2h0PSIxMHB4IgogICB2aWV3Qm94PSIwIDAgOCAxMCIKICAgdmVyc2lvbj0iMS4xIgogICBpZD0ic3ZnMiIKICAgaW5rc2NhcGU6dmVyc2lvbj0iMC45MSByMTM3MjUiCiAgIHNvZGlwb2RpOmRvY25hbWU9ImFycm93LnN2ZyI+CiAgPG1ldGFkYXRhCiAgICAgaWQ9Im1ldGFkYXRhMTYiPgogICAgPHJkZjpSREY+CiAgICAgIDxjYzpXb3JrCiAgICAgICAgIHJkZjphYm91dD0iIj4KICAgICAgICA8ZGM6Zm9ybWF0PmltYWdlL3N2Zyt4bWw8L2RjOmZvcm1hdD4KICAgICAgICA8ZGM6dHlwZQogICAgICAgICAgIHJkZjpyZXNvdXJjZT0iaHR0cDovL3B1cmwub3JnL2RjL2RjbWl0eXBlL1N0aWxsSW1hZ2UiIC8+CiAgICAgIDwvY2M6V29yaz4KICAgIDwvcmRmOlJERj4KICA8L21ldGFkYXRhPgogIDxzb2RpcG9kaTpuYW1lZHZpZXcKICAgICBwYWdlY29sb3I9IiNmZmZmZmYiCiAgICAgYm9yZGVyY29sb3I9IiM2NjY2NjYiCiAgICAgYm9yZGVyb3BhY2l0eT0iMSIKICAgICBvYmplY3R0b2xlcmFuY2U9IjEwIgogICAgIGdyaWR0b2xlcmFuY2U9IjEwIgogICAgIGd1aWRldG9sZXJhbmNlPSIxMCIKICAgICBpbmtzY2FwZTpwYWdlb3BhY2l0eT0iMCIKICAgICBpbmtzY2FwZTpwYWdlc2hhZG93PSIyIgogICAgIGlua3NjYXBlOndpbmRvdy13aWR0aD0iMTE3OSIKICAgICBpbmtzY2FwZTp3aW5kb3ctaGVpZ2h0PSI3MTAiCiAgICAgaWQ9Im5hbWVkdmlldzE0IgogICAgIHNob3dncmlkPSJmYWxzZSIKICAgICBpbmtzY2FwZTp6b29tPSIyMy42IgogICAgIGlua3NjYXBlOmN4PSI0IgogICAgIGlua3NjYXBlOmN5PSI1IgogICAgIGlua3NjYXBlOndpbmRvdy14PSIwIgogICAgIGlua3NjYXBlOndpbmRvdy15PSIwIgogICAgIGlua3NjYXBlOndpbmRvdy1tYXhpbWl6ZWQ9IjAiCiAgICAgaW5rc2NhcGU6Y3VycmVudC1sYXllcj0ic3ZnMiIgLz4KICA8IS0tIEdlbmVyYXRvcjogU2tldGNoIDQzLjIgKDM5MDY5KSAtIGh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaCAtLT4KICA8dGl0bGUKICAgICBpZD0idGl0bGU0Ij5hcnJvdzwvdGl0bGU+CiAgPGRlc2MKICAgICBpZD0iZGVzYzYiPkNyZWF0ZWQgd2l0aCBTa2V0Y2guPC9kZXNjPgogIDxkZWZzCiAgICAgaWQ9ImRlZnM4IiAvPgogIDxnCiAgICAgaWQ9IlBhZ2UtMSIKICAgICBzdHJva2U9Im5vbmUiCiAgICAgc3Ryb2tlLXdpZHRoPSIxIgogICAgIGZpbGw9Im5vbmUiCiAgICAgZmlsbC1ydWxlPSJldmVub2RkIgogICAgIHRyYW5zZm9ybT0icm90YXRlKDkwLCA0LCA1KSIKICAgICBzdHlsZT0iZmlsbDojMDAwMDAwIj4KICAgIDxnCiAgICAgICBpZD0iYXJyb3ciCiAgICAgICB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtNC4wMDAwMDAsIC0zLjAwMDAwMCkiCiAgICAgICBmaWxsPSIjNEM5N0ZGIgogICAgICAgc3R5bGU9ImZpbGw6IzAwMDAwMCI+CiAgICAgIDxwYXRoCiAgICAgICAgIGQ9Ik04LjAxODkxMDgzLDYuNjgyMjMwNTUgTDMuNTA5OTE2MDEsNy40MzM3Mjk2OSBDMy4yNDY3OTEzMSw3LjQ3NzU4MzggMy4wMTg5MTA4Myw3LjczOTQyMTUxIDMuMDE4OTEwODMsOC4wMTU1NjM4OCBDMy4wMTg5MTA4Myw4LjI4MzYzMDI5IDMuMjM4NzQxMzQsOC41NTIyMDIzIDMuNTA5OTE2MDEsOC41OTczOTgwOCBMOC4wMTg5MTA4Myw5LjM0ODg5NzIyIEw4LjAxODkxMDgzLDExLjAxODUzMzcgQzguMDE4OTEwODMsMTEuNTYyNTI3NiA4LjM4MzI2Njg2LDExLjc1MjAwMzIgOC44MzI3MjI3OSwxMS40MjY4ODQ3IEwxMi42NDEwMTc2LDguNjcyMTE1ODcgQzEzLjA5ODE2MzgsOC4zNDE0MzQ1NSAxMy4wOTU3MjIzLDcuODE0NzA1MTggMTIuNjUyNzQxMSw3LjQ4MzIwODA2IEw4LjgyMDk5OTM2LDQuNjE1NzkyNTMgQzguMzc1NTc2NjQsNC4yODI0NjgzOCA4LjAxODkxMDgzLDQuNDYxOTQ5NDggOC4wMTg5MTA4Myw1LjAxMjU5NDAyIEw4LjAxODkxMDgzLDYuNjgyMjMwNTUgWiIKICAgICAgICAgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoOC4wMDE2NzMsIDguMDE3MjM3KSByb3RhdGUoLTkwLjAwMDAwMCkgdHJhbnNsYXRlKC04LjAwMTY3MywgLTguMDE3MjM3KSAiCiAgICAgICAgIGlkPSJwYXRoMTIiCiAgICAgICAgIHN0eWxlPSJmaWxsOiMwMDAwMDAiIC8+CiAgICA8L2c+CiAgPC9nPgo8L3N2Zz4K",Blockly.FieldAngle.prototype.configure_=function(l){switch(Blockly.FieldAngle.superClass_.configure_.call(this,l),l.mode){case"compass":this.clockwise_=!0,this.offset_=90;break;case"protractor":this.clockwise_=!1,this.offset_=0}var e=l.clockwise;"boolean"==typeof e&&(this.clockwise_=e);var i=l.offset;null!=i&&(i=Number(i),isNaN(i)||(this.offset_=i));var o=l.wrap;null!=o&&(o=Number(o),isNaN(o)||(this.wrap_=o));var t=l.round;null!=t&&(t=Number(t),isNaN(t)||(this.round_=t))},Blockly.FieldAngle.prototype.initView=function(){Blockly.FieldAngle.superClass_.initView.call(this),this.symbol_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.TSPAN,{},null),this.symbol_.appendChild(document.createTextNode("Â°")),this.textElement_.appendChild(this.symbol_)},Blockly.FieldAngle.prototype.render_=function(){Blockly.FieldAngle.superClass_.render_.call(this),this.updateGraph_()},Blockly.FieldAngle.prototype.showEditor_=function(l){var e=Blockly.utils.userAgent.MOBILE||Blockly.utils.userAgent.ANDROID||Blockly.utils.userAgent.IPAD;Blockly.FieldAngle.superClass_.showEditor_.call(this,l,e),this.dropdownCreate_(),Blockly.DropDownDiv.getContentDiv().appendChild(this.editor_),Blockly.DropDownDiv.setColour(this.sourceBlock_.style.colourPrimary,this.sourceBlock_.style.colourTertiary),Blockly.DropDownDiv.showPositionedByField(this,this.dropdownDispose_.bind(this)),this.updateGraph_()},Blockly.FieldAngle.prototype.dropdownCreate_=function(){var l=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.SVG,{xmlns:Blockly.utils.dom.SVG_NS,"xmlns:html":Blockly.utils.dom.HTML_NS,"xmlns:xlink":Blockly.utils.dom.XLINK_NS,version:"1.1",height:2*Blockly.FieldAngle.HALF+"px",width:2*Blockly.FieldAngle.HALF+"px",style:"touch-action: none"},null),e=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.CIRCLE,{cx:Blockly.FieldAngle.HALF,cy:Blockly.FieldAngle.HALF,r:Blockly.FieldAngle.RADIUS,class:"blocklyAngleCircle"},l);this.gauge_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.PATH,{class:"blocklyAngleGauge"},l),this.line_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.LINE,{x1:Blockly.FieldAngle.HALF,y1:Blockly.FieldAngle.HALF,class:"blocklyAngleLine"},l);for(var i=0;i<360;i+=15)Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.LINE,{x1:Blockly.FieldAngle.HALF+Blockly.FieldAngle.RADIUS,y1:Blockly.FieldAngle.HALF,x2:Blockly.FieldAngle.HALF+Blockly.FieldAngle.RADIUS-(i%45==0?10:5),y2:Blockly.FieldAngle.HALF,class:"blocklyAngleMarks",transform:"rotate("+i+","+Blockly.FieldAngle.HALF+","+Blockly.FieldAngle.HALF+")"},l);Blockly.utils.dom.createSvgElement("circle",{cx:Blockly.FieldAngle.HALF,cy:Blockly.FieldAngle.HALF,r:Blockly.FieldAngle.CENTER_RADIUS,class:"blocklyAngleCenterPoint"},l),this.handle_=Blockly.utils.dom.createSvgElement("g",{},l),Blockly.utils.dom.createSvgElement("circle",{cx:0,cy:0,r:Blockly.FieldAngle.HANDLE_RADIUS,class:"blocklyAngleDragHandle"},this.handle_),this.arrowSvg_=Blockly.utils.dom.createSvgElement("image",{width:Blockly.FieldAngle.ARROW_WIDTH,height:Blockly.FieldAngle.ARROW_WIDTH,x:-Blockly.FieldAngle.ARROW_WIDTH/2,y:-Blockly.FieldAngle.ARROW_WIDTH/2},this.handle_),this.arrowSvg_.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",Blockly.FieldAngle.ARROW_SVG_DATAURI),this.clickWrapper_=Blockly.browserEvents.conditionalBind(l,"click",this,this.hide_),this.clickSurfaceWrapper_=Blockly.browserEvents.conditionalBind(e,"click",this,this.onMouseMove_,!0,!0),this.moveSurfaceWrapper_=Blockly.browserEvents.conditionalBind(e,"mousemove",this,this.onMouseMove_,!0,!0),this.editor_=l},Blockly.FieldAngle.prototype.dropdownDispose_=function(){this.clickWrapper_&&(Blockly.browserEvents.unbind(this.clickWrapper_),this.clickWrapper_=null),this.clickSurfaceWrapper_&&(Blockly.browserEvents.unbind(this.clickSurfaceWrapper_),this.clickSurfaceWrapper_=null),this.moveSurfaceWrapper_&&(Blockly.browserEvents.unbind(this.moveSurfaceWrapper_),this.moveSurfaceWrapper_=null),this.gauge_=null,this.line_=null},Blockly.FieldAngle.prototype.onMouseUp=function(){Blockly.unbindEvent_(this.mouseMoveWrapper_),Blockly.unbindEvent_(this.mouseUpWrapper_)},Blockly.FieldAngle.prototype.onMouseMove_=function(l){var e=this.gauge_.ownerSVGElement.getBoundingClientRect(),i=l.clientX-e.left-Blockly.FieldAngle.HALF,o=l.clientY-e.top-Blockly.FieldAngle.HALF,t=Math.atan(-o/i);isNaN(t)||(t=Blockly.utils.math.toDegrees(t),i<0?t+=180:o>0&&(t+=360),t=this.clockwise_?this.offset_+360-t:360-(this.offset_-t),this.displayMouseOrKeyboardValue_(t))},Blockly.FieldAngle.prototype.displayMouseOrKeyboardValue_=function(l){this.round_&&(l=Math.round(l/this.round_)*this.round_),(l=this.wrapValue_(l))!=this.value_&&this.setEditorValue_(l)},Blockly.FieldAngle.prototype.updateGraph_=function(){if(this.gauge_){var l=Number(this.getText())+this.offset_;l%=360;var e=Blockly.utils.math.toRadians(l),i=["M ",Blockly.FieldAngle.HALF,",",Blockly.FieldAngle.HALF],o=Blockly.FieldAngle.HALF,t=Blockly.FieldAngle.HALF;if(!isNaN(e)){var g=Number(this.clockwise_),c=Blockly.utils.math.toRadians(this.offset_),s=Math.cos(c)*Blockly.FieldAngle.RADIUS,n=Math.sin(c)*-Blockly.FieldAngle.RADIUS;g&&(e=2*c-e),o+=Math.cos(e)*Blockly.FieldAngle.RADIUS,t-=Math.sin(e)*Blockly.FieldAngle.RADIUS;var A=Math.abs(Math.floor((e-c)/Math.PI)%2);g&&(A=1-A),i.push(" l ",s,",",n," A ",Blockly.FieldAngle.RADIUS,",",Blockly.FieldAngle.RADIUS," 0 ",A," ",g," ",o,",",t," z")}this.gauge_.setAttribute("d",i.join("")),this.line_.setAttribute("x2",o),this.line_.setAttribute("y2",t),this.handle_.setAttribute("transform","translate("+o+","+t+")")}},Blockly.FieldAngle.prototype.onHtmlInputKeyDown_=function(l){var e;if(Blockly.FieldAngle.superClass_.onHtmlInputKeyDown_.call(this,l),l.keyCode===Blockly.utils.KeyCodes.LEFT?e=this.sourceBlock_.RTL?1:-1:l.keyCode===Blockly.utils.KeyCodes.RIGHT?e=this.sourceBlock_.RTL?-1:1:l.keyCode===Blockly.utils.KeyCodes.DOWN?e=-1:l.keyCode===Blockly.utils.KeyCodes.UP&&(e=1),e){var i=this.getValue();this.displayMouseOrKeyboardValue_(i+e*this.round_),l.preventDefault(),l.stopPropagation()}},Blockly.FieldAngle.prototype.doClassValidation_=function(l){var e=Number(l);return isNaN(e)||!isFinite(e)?null:this.wrapValue_(e)},Blockly.FieldAngle.prototype.wrapValue_=function(l){return(l%=360)<0&&(l+=360),l>this.wrap_&&(l-=360),l},Blockly.Css.register([".blocklyAngleCenterPoint {","stroke: #fff;","stroke-width: 1;","fill: #fff;","}",".blocklyAngleDragHandle {","stroke: #fff;","stroke-width: 5;","stroke-opacity: 0.25;","fill: #fff;","cursor: pointer;","}",".blocklyAngleMarks {","stroke: #fff;","stroke-width: 1;","stroke-opacity: 0.5;","}",".blocklyAngleGauge {","fill: #fff;","fill-opacity: 0.20;","}",".blocklyAngleLine {","stroke: #fff;","stroke-width: 1;","stroke-linecap: round;","pointer-events: none;","}"]),Blockly.fieldRegistry.register("field_angle",Blockly.FieldAngle);