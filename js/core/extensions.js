/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.Extensions"),goog.require("Blockly.utils"),goog.requireType("Blockly.Block"),Blockly.Extensions.ALL_=Object.create(null),Blockly.Extensions.register=function(o,t){if("string"!=typeof o||""==o.trim())throw Error('Error: Invalid extension name "'+o+'"');if(Blockly.Extensions.ALL_[o])throw Error('Error: Extension "'+o+'" is already registered.');if("function"!=typeof t)throw Error('Error: Extension "'+o+'" must be a function');Blockly.Extensions.ALL_[o]=t},Blockly.Extensions.registerMixin=function(o,t){if(!t||"object"!=typeof t)throw Error('Error: Mixin "'+o+'" must be a object');Blockly.Extensions.register(o,function(){this.mixin(t)})},Blockly.Extensions.registerMutator=function(o,t,e,n){var i='Error when registering mutator "'+o+'": ';Blockly.Extensions.checkHasFunction_(i,t.domToMutation,"domToMutation"),Blockly.Extensions.checkHasFunction_(i,t.mutationToDom,"mutationToDom");var r=Blockly.Extensions.checkMutatorDialog_(t,i);if(e&&"function"!=typeof e)throw Error('Extension "'+o+'" is not a function');Blockly.Extensions.register(o,function(){if(r){if(!Blockly.Mutator)throw Error(i+"Missing require for Blockly.Mutator");this.setMutator(new Blockly.Mutator(n||[]))}this.mixin(t),e&&e.apply(this)})},Blockly.Extensions.unregister=function(o){Blockly.Extensions.ALL_[o]?delete Blockly.Extensions.ALL_[o]:console.warn('No extension mapping for name "'+o+'" found to unregister')},Blockly.Extensions.apply=function(o,t,e){var n=Blockly.Extensions.ALL_[o];if("function"!=typeof n)throw Error('Error: Extension "'+o+'" not found.');if(e)Blockly.Extensions.checkNoMutatorProperties_(o,t);else var i=Blockly.Extensions.getMutatorProperties_(t);if(n.apply(t),e){var r='Error after applying mutator "'+o+'": ';Blockly.Extensions.checkBlockHasMutatorProperties_(r,t)}else if(!Blockly.Extensions.mutatorPropertiesMatch_(i,t))throw Error('Error when applying extension "'+o+'": mutation properties changed when applying a non-mutator extension.')},Blockly.Extensions.checkHasFunction_=function(o,t,e){if(!t)throw Error(o+'missing required property "'+e+'"');if("function"!=typeof t)throw Error(o+'" required property "'+e+'" must be a function')},Blockly.Extensions.checkNoMutatorProperties_=function(o,t){if(Blockly.Extensions.getMutatorProperties_(t).length)throw Error('Error: tried to apply mutation "'+o+'" to a block that already has mutator functions.  Block id: '+t.id)},Blockly.Extensions.checkMutatorDialog_=function(o,t){var e=void 0!==o.compose,n=void 0!==o.decompose;if(e&&n){if("function"!=typeof o.compose)throw Error(t+"compose must be a function.");if("function"!=typeof o.decompose)throw Error(t+"decompose must be a function.");return!0}if(!e&&!n)return!1;throw Error(t+'Must have both or neither of "compose" and "decompose"')},Blockly.Extensions.checkBlockHasMutatorProperties_=function(o,t){if("function"!=typeof t.domToMutation)throw Error(o+'Applying a mutator didn\'t add "domToMutation"');if("function"!=typeof t.mutationToDom)throw Error(o+'Applying a mutator didn\'t add "mutationToDom"');Blockly.Extensions.checkMutatorDialog_(t,o)},Blockly.Extensions.getMutatorProperties_=function(o){var t=[];return void 0!==o.domToMutation&&t.push(o.domToMutation),void 0!==o.mutationToDom&&t.push(o.mutationToDom),void 0!==o.compose&&t.push(o.compose),void 0!==o.decompose&&t.push(o.decompose),t},Blockly.Extensions.mutatorPropertiesMatch_=function(o,t){var e=Blockly.Extensions.getMutatorProperties_(t);if(e.length!=o.length)return!1;for(var n=0;n<e.length;n++)if(o[n]!=e[n])return!1;return!0},Blockly.Extensions.buildTooltipForDropdown=function(o,t){var e=[];"object"==typeof document&&Blockly.utils.runAfterPageLoad(function(){for(var o in t)Blockly.utils.checkMessageReferences(t[o])});return function(){this.type&&-1==e.indexOf(this.type)&&(Blockly.Extensions.checkDropdownOptionsInTable_(this,o,t),e.push(this.type)),this.setTooltip(function(){var n=String(this.getFieldValue(o)),i=t[n];if(null==i){if(-1==e.indexOf(this.type)){var r="No tooltip mapping for value "+n+" of field "+o;null!=this.type&&(r+=" of block type "+this.type),console.warn(r+".")}}else i=Blockly.utils.replaceMessageReferences(i);return i}.bind(this))}},Blockly.Extensions.checkDropdownOptionsInTable_=function(o,t,e){var n=o.getField(t);if(!n.isOptionListDynamic())for(var i=n.getOptions(),r=0;r<i.length;++r){var s=i[r][1];null==e[s]&&console.warn("No tooltip mapping for value "+s+" of field "+t+" of block type "+o.type)}},Blockly.Extensions.buildTooltipWithFieldText=function(o,t){"object"==typeof document&&Blockly.utils.runAfterPageLoad(function(){Blockly.utils.checkMessageReferences(o)});return function(){this.setTooltip(function(){var e=this.getField(t);return Blockly.utils.replaceMessageReferences(o).replace("%1",e?e.getText():"")}.bind(this))}},Blockly.Extensions.extensionParentTooltip_=function(){this.tooltipWhenNotConnected_=this.tooltip,this.setTooltip(function(){var o=this.getParent();return o&&o.getInputsInline()&&o.tooltip||this.tooltipWhenNotConnected_}.bind(this))},Blockly.Extensions.register("parent_tooltip_when_inline",Blockly.Extensions.extensionParentTooltip_);