/**
 * @license
 * Copyright 2012 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.Bubble"),goog.require("Blockly.browserEvents"),goog.require("Blockly.IBubble"),goog.require("Blockly.Scrollbar"),goog.require("Blockly.Touch"),goog.require("Blockly.utils"),goog.require("Blockly.utils.Coordinate"),goog.require("Blockly.utils.dom"),goog.require("Blockly.utils.math"),goog.require("Blockly.utils.Size"),goog.require("Blockly.utils.Svg"),goog.require("Blockly.utils.userAgent"),goog.require("Blockly.Workspace"),goog.requireType("Blockly.BlockDragSurfaceSvg"),goog.requireType("Blockly.BlockSvg"),goog.requireType("Blockly.MetricsManager"),goog.requireType("Blockly.WorkspaceSvg"),Blockly.Bubble=function(e,t,l,o,i,r){this.workspace_=e,this.content_=t,this.shape_=l,this.resizeCallback_=null,this.moveCallback_=null,this.onMouseDownBubbleWrapper_=null,this.onMouseDownResizeWrapper_=null,this.disposed=!1;var s=Blockly.Bubble.ARROW_ANGLE;if(this.workspace_.RTL&&(s=-s),this.arrow_radians_=Blockly.utils.math.toRadians(s),e.getBubbleCanvas().appendChild(this.createDom_(t,!(!i||!r))),this.setAnchorLocation(o),!i||!r){var u=this.content_.getBBox();i=u.width+2*Blockly.Bubble.BORDER_WIDTH,r=u.height+2*Blockly.Bubble.BORDER_WIDTH}this.setBubbleSize(i,r),this.positionBubble_(),this.renderArrow_(),this.rendered_=!0},Blockly.Bubble.BORDER_WIDTH=1,Blockly.Bubble.RESIZE_SIZE=12*Blockly.Bubble.BORDER_WIDTH,Blockly.Bubble.ARROW_THICKNESS=5,Blockly.Bubble.ARROW_ANGLE=20,Blockly.Bubble.ARROW_BEND=4,Blockly.Bubble.ANCHOR_RADIUS=8,Blockly.Bubble.LINE_THICKNESS=1,Blockly.Bubble.onMouseUpWrapper_=null,Blockly.Bubble.onMouseMoveWrapper_=null,Blockly.Bubble.unbindDragEvents_=function(){Blockly.Bubble.onMouseUpWrapper_&&(Blockly.browserEvents.unbind(Blockly.Bubble.onMouseUpWrapper_),Blockly.Bubble.onMouseUpWrapper_=null),Blockly.Bubble.onMouseMoveWrapper_&&(Blockly.browserEvents.unbind(Blockly.Bubble.onMouseMoveWrapper_),Blockly.Bubble.onMouseMoveWrapper_=null)},Blockly.Bubble.bubbleMouseUp_=function(e){Blockly.Touch.clearTouchIdentifier(),Blockly.Bubble.unbindDragEvents_()},Blockly.Bubble.prototype.rendered_=!1,Blockly.Bubble.prototype.anchorXY_=null,Blockly.Bubble.prototype.relativeLeft_=0,Blockly.Bubble.prototype.relativeTop_=0,Blockly.Bubble.prototype.width_=0,Blockly.Bubble.prototype.height_=0,Blockly.Bubble.prototype.autoLayout_=!0,Blockly.Bubble.prototype.useArrow_=!1,Blockly.Bubble.prototype.createDom_=function(e,t){this.bubbleGroup_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.G,{},null);var l={filter:"url(#"+this.workspace_.getRenderer().getConstants().embossFilterId+")"};!Blockly.utils.userAgent.JAVA_FX&&this.useArrow_||(l={});var o=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.G,l,this.bubbleGroup_);if(this.bubbleArrow_=Blockly.utils.dom.createSvgElement(this.useArrow_?Blockly.utils.Svg.PATH:Blockly.utils.Svg.LINE,{},o),this.bubbleBack_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.RECT,{class:"blocklyDraggable",x:0,y:0,rx:Blockly.Bubble.BORDER_WIDTH,ry:Blockly.Bubble.BORDER_WIDTH},o),this.bubbleGroup_.appendChild(e),t){this.resizeGroup_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.G,{class:this.workspace_.RTL?"blocklyResizeSW":"blocklyResizeSE"},this.bubbleGroup_);var i=Blockly.Bubble.RESIZE_SIZE;Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.POLYGON,{points:"0,x x,x x,0".replace(/x/g,i.toString())},this.resizeGroup_),Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.LINE,{class:"blocklyResizeLine",x1:i/3,y1:i-1,x2:i-1,y2:i/3},this.resizeGroup_),Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.LINE,{class:"blocklyResizeLine",x1:2*i/3,y1:i-1,x2:i-1,y2:2*i/3},this.resizeGroup_)}else this.resizeGroup_=null;return this.workspace_.options.readOnly||(this.onMouseDownBubbleWrapper_=Blockly.browserEvents.conditionalBind(this.bubbleBack_,"mousedown",this,this.bubbleMouseDown_),this.resizeGroup_&&(this.onMouseDownResizeWrapper_=Blockly.browserEvents.conditionalBind(this.resizeGroup_,"mousedown",this,this.resizeMouseDown_))),this.bubbleGroup_},Blockly.Bubble.prototype.getSvgRoot=function(){return this.bubbleGroup_},Blockly.Bubble.prototype.setSvgId=function(e){this.bubbleGroup_.dataset&&(this.bubbleGroup_.dataset.blockId=e)},Blockly.Bubble.prototype.bubbleMouseDown_=function(e){var t=this.workspace_.getGesture(e);t&&t.handleBubbleStart(e,this)},Blockly.Bubble.prototype.showContextMenu=function(e){},Blockly.Bubble.prototype.isDeletable=function(){return!1},Blockly.Bubble.prototype.setDeleteStyle=function(e){},Blockly.Bubble.prototype.resizeMouseDown_=function(e){this.promote(),Blockly.Bubble.unbindDragEvents_(),Blockly.utils.isRightButton(e)||(this.workspace_.startDrag(e,new Blockly.utils.Coordinate(this.workspace_.RTL?-this.width_:this.width_,this.height_)),Blockly.Bubble.onMouseUpWrapper_=Blockly.browserEvents.conditionalBind(document,"mouseup",this,Blockly.Bubble.bubbleMouseUp_),Blockly.Bubble.onMouseMoveWrapper_=Blockly.browserEvents.conditionalBind(document,"mousemove",this,this.resizeMouseMove_),Blockly.hideChaff()),e.stopPropagation()},Blockly.Bubble.prototype.resizeMouseMove_=function(e){this.autoLayout_=!1;var t=this.workspace_.moveDrag(e);this.setBubbleSize(this.workspace_.RTL?-t.x:t.x,t.y),this.workspace_.RTL&&this.positionBubble_()},Blockly.Bubble.prototype.registerResizeEvent=function(e){this.resizeCallback_=e},Blockly.Bubble.prototype.registerMoveEvent=function(e){this.moveCallback_=e},Blockly.Bubble.prototype.promote=function(){var e=this.bubbleGroup_.parentNode;return e.lastChild!==this.bubbleGroup_&&(e.appendChild(this.bubbleGroup_),!0)},Blockly.Bubble.prototype.setAnchorLocation=function(e){this.anchorXY_=e,this.rendered_&&this.positionBubble_()},Blockly.Bubble.prototype.layoutBubble_=function(){var e=this.workspace_.getMetricsManager().getViewMetrics(!0),t=this.getOptimalRelativeLeft_(e),l=this.getOptimalRelativeTop_(e),o=this.shape_.getBBox(),i={x:t,y:-this.height_-this.workspace_.getRenderer().getConstants().MIN_BLOCK_HEIGHT},r={x:-this.width_-30,y:l},s={x:o.width,y:l},u={x:t,y:o.height},b=o.width<o.height?s:u,h=o.width<o.height?u:s,c=this.getOverlap_(i,e),a=this.getOverlap_(r,e),n=this.getOverlap_(b,e),B=this.getOverlap_(h,e),_=Math.max(c,a,n,B);return c==_?(this.relativeLeft_=i.x,void(this.relativeTop_=i.y)):a==_?(this.relativeLeft_=r.x,void(this.relativeTop_=r.y)):n==_?(this.relativeLeft_=b.x,void(this.relativeTop_=b.y)):(this.relativeLeft_=h.x,void(this.relativeTop_=h.y))},Blockly.Bubble.prototype.getOverlap_=function(e,t){var l={x:this.workspace_.RTL?this.anchorXY_.x-e.x-this.width_:e.x+this.anchorXY_.x,y:e.y+this.anchorXY_.y},o={x:l.x+this.width_,y:l.y+this.height_},i={x:t.left,y:t.top},r={x:t.left+t.width,y:t.top+t.height},s=Math.min(o.x,r.x)-Math.max(l.x,i.x),u=Math.min(o.y,r.y)-Math.max(l.y,i.y);return Math.max(0,Math.min(1,s*u/(this.width_*this.height_)))},Blockly.Bubble.prototype.getOptimalRelativeLeft_=function(e){var t=-this.width_/4;if(this.width_>e.width)return t;if(this.workspace_.RTL)var l=(r=this.anchorXY_.x-t)-this.width_,o=e.left+e.width,i=e.left+Blockly.Scrollbar.scrollbarThickness/this.workspace_.scale;else{var r=(l=t+this.anchorXY_.x)+this.width_;i=e.left,o=e.left+e.width-Blockly.Scrollbar.scrollbarThickness/this.workspace_.scale}return this.workspace_.RTL?l<i?t=-(i-this.anchorXY_.x+this.width_):r>o&&(t=-(o-this.anchorXY_.x)):l<i?t=i-this.anchorXY_.x:r>o&&(t=o-this.anchorXY_.x-this.width_),t},Blockly.Bubble.prototype.getOptimalRelativeTop_=function(e){var t=-this.height_/4;if(this.height_>e.height)return t;var l=this.anchorXY_.y+t,o=l+this.height_,i=e.top,r=e.top+e.height-Blockly.Scrollbar.scrollbarThickness/this.workspace_.scale,s=this.anchorXY_.y;return l<i?t=i-s:o>r&&(t=r-s-this.height_),t},Blockly.Bubble.prototype.positionBubble_=function(){var e=this.anchorXY_.x;this.workspace_.RTL?e-=this.relativeLeft_:e+=this.relativeLeft_;var t=this.relativeTop_+this.anchorXY_.y;this.moveTo(e,t)},Blockly.Bubble.prototype.moveTo=function(e,t){this.bubbleGroup_.setAttribute("transform","translate("+e+","+t+")")},Blockly.Bubble.prototype.setDragging=function(e){!e&&this.moveCallback_&&this.moveCallback_()},Blockly.Bubble.prototype.getBubbleSize=function(){return new Blockly.utils.Size(this.width_,this.height_)},Blockly.Bubble.prototype.setBubbleSize=function(e,t){var l=2*Blockly.Bubble.BORDER_WIDTH;if(e=Math.max(e,l+45),t=Math.max(t,l+20),this.width_=e,this.height_=t,this.bubbleBack_.setAttribute("width",e),this.bubbleBack_.setAttribute("height",t),this.resizeGroup_){var o=Blockly.Bubble.RESIZE_SIZE;this.workspace_.RTL?this.resizeGroup_.setAttribute("transform","translate("+o+","+(t-l)+") scale(-1 1)"):this.resizeGroup_.setAttribute("transform","translate("+(e-o)+","+(t-o)+")")}this.autoLayout_&&this.layoutBubble_(),this.positionBubble_(),this.renderArrow_(),this.resizeCallback_&&this.resizeCallback_()},Blockly.Bubble.prototype.renderArrow_=function(){this.useArrow_?this.drawArrow_():this.drawLine_()},Blockly.Bubble.prototype.drawArrow_=function(){var e=[],t=this.width_/2,l=this.height_/2,o=-this.relativeLeft_,i=-this.relativeTop_;if(t==o&&l==i)e.push("M "+t+","+l);else{var r=i-l,s=o-t;this.workspace_.RTL&&(s*=-1);var u=Math.sqrt(r*r+s*s),b=Math.acos(s/u);r<0&&(b=2*Math.PI-b);var h=b+Math.PI/2;h>2*Math.PI&&(h-=2*Math.PI);var c=Math.sin(h),a=Math.cos(h),n=this.getBubbleSize(),B=(n.width+n.height)/Blockly.Bubble.ARROW_THICKNESS;B=Math.min(B,n.width,n.height)/4;var _=1-Blockly.Bubble.ANCHOR_RADIUS/u;o=t+_*s,i=l+_*r;var y=t+B*a,p=l+B*c,k=t-B*a,v=l-B*c,g=b+this.arrow_radians_;g>2*Math.PI&&(g-=2*Math.PI);var d=Math.sin(g)*u/Blockly.Bubble.ARROW_BEND,w=Math.cos(g)*u/Blockly.Bubble.ARROW_BEND;e.push("M"+y+","+p),e.push("C"+(y+w)+","+(p+d)+" "+o+","+i+" "+o+","+i),e.push("C"+o+","+i+" "+(k+w)+","+(v+d)+" "+k+","+v)}e.push("z"),this.bubbleArrow_.setAttribute("d",e.join(" "))},Blockly.Bubble.prototype.drawLine_=function(){var e=this.width_/2,t=Blockly.WorkspaceCommentSvg.TOP_BAR_HEIGHT/2,l=-this.relativeLeft_,o=-this.relativeTop_;if(e!=l||t!=o){var i=o-t,r=l-e;this.workspace_.RTL&&(r*=-1,r-=this.width_);var s=e,u=t;this.bubbleArrow_.setAttribute("x1",s),this.bubbleArrow_.setAttribute("y1",u),this.bubbleArrow_.setAttribute("x2",s+r),this.bubbleArrow_.setAttribute("y2",u+i),this.bubbleArrow_.setAttribute("stroke-width",Blockly.Bubble.LINE_THICKNESS)}},Blockly.Bubble.prototype.setColour=function(e,t){this.bubbleBack_.setAttribute("fill",e),this.useArrow_?this.bubbleArrow_.setAttribute("fill",e):(this.bubbleBack_.setAttribute("stroke",t),this.bubbleArrow_.setAttribute("stroke",t))},Blockly.Bubble.prototype.dispose=function(){this.onMouseDownBubbleWrapper_&&Blockly.browserEvents.unbind(this.onMouseDownBubbleWrapper_),this.onMouseDownResizeWrapper_&&Blockly.browserEvents.unbind(this.onMouseDownResizeWrapper_),Blockly.Bubble.unbindDragEvents_(),Blockly.utils.dom.removeNode(this.bubbleGroup_),this.disposed=!0},Blockly.Bubble.prototype.moveDuringDrag=function(e,t){e?e.translateSurface(t.x,t.y):this.moveTo(t.x,t.y),this.workspace_.RTL?this.relativeLeft_=this.anchorXY_.x-t.x-this.width_:this.relativeLeft_=t.x-this.anchorXY_.x,this.relativeTop_=t.y-this.anchorXY_.y,this.renderArrow_()},Blockly.Bubble.prototype.getRelativeToSurfaceXY=function(){return new Blockly.utils.Coordinate(this.workspace_.RTL?-this.relativeLeft_+this.anchorXY_.x-this.width_:this.anchorXY_.x+this.relativeLeft_,this.anchorXY_.y+this.relativeTop_)},Blockly.Bubble.prototype.setAutoLayout=function(e){this.autoLayout_=e},Blockly.Bubble.textToDom=function(e){for(var t=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.TEXT,{class:"blocklyText blocklyBubbleText blocklyNoPointerEvents",y:Blockly.Bubble.BORDER_WIDTH},null),l=e.split("\n"),o=0;o<l.length;o++){var i=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.TSPAN,{dy:"1em",x:Blockly.Bubble.BORDER_WIDTH},t),r=document.createTextNode(l[o]);i.appendChild(r)}return t},Blockly.Bubble.createNonEditableBubble=function(e,t,l){var o=new Blockly.Bubble(t.workspace,e,t.pathObject.svgPath,l,null,null);if(o.setSvgId(t.id),t.RTL)for(var i,r=e.getBBox().width,s=0;i=e.childNodes[s];s++)i.setAttribute("text-anchor","end"),i.setAttribute("x",r+Blockly.Bubble.BORDER_WIDTH);return o};