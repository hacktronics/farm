/**
 * @license
 * Copyright 2011 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.ConnectionDB"),goog.require("Blockly.connectionTypes"),goog.require("Blockly.constants"),goog.require("Blockly.RenderedConnection"),goog.requireType("Blockly.IConnectionChecker"),goog.requireType("Blockly.utils.Coordinate"),Blockly.ConnectionDB=function(n){this.connections_=[],this.connectionChecker_=n},Blockly.ConnectionDB.prototype.addConnection=function(n,o){var t=this.calculateIndexForYPos_(o);this.connections_.splice(t,0,n)},Blockly.ConnectionDB.prototype.findIndexOfConnection_=function(n,o){if(!this.connections_.length)return-1;var t=this.calculateIndexForYPos_(o);if(t>=this.connections_.length)return-1;o=n.y;for(var e=t;e>=0&&this.connections_[e].y==o;){if(this.connections_[e]==n)return e;e--}for(e=t;e<this.connections_.length&&this.connections_[e].y==o;){if(this.connections_[e]==n)return e;e++}return-1},Blockly.ConnectionDB.prototype.calculateIndexForYPos_=function(n){if(!this.connections_.length)return 0;for(var o=0,t=this.connections_.length;o<t;){var e=Math.floor((o+t)/2);if(this.connections_[e].y<n)o=e+1;else{if(!(this.connections_[e].y>n)){o=e;break}t=e}}return o},Blockly.ConnectionDB.prototype.removeConnection=function(n,o){var t=this.findIndexOfConnection_(n,o);if(-1==t)throw Error("Unable to find connection in connectionDB.");this.connections_.splice(t,1)},Blockly.ConnectionDB.prototype.getNeighbours=function(n,o){for(var t=this.connections_,e=n.x,c=n.y,i=0,r=t.length-2,s=r;i<s;)t[s].y<c?i=s:r=s,s=Math.floor((i+r)/2);var l=[];function y(n){var i=e-t[n].x,r=c-t[n].y;return Math.sqrt(i*i+r*r)<=o&&l.push(t[n]),r<o}if(i=s,r=s,t.length){for(;i>=0&&y(i);)i--;do{r++}while(r<t.length&&y(r))}return l},Blockly.ConnectionDB.prototype.isInYRange_=function(n,o,t){return Math.abs(this.connections_[n].y-o)<=t},Blockly.ConnectionDB.prototype.searchForClosest=function(n,o,t){if(!this.connections_.length)return{connection:null,radius:o};var e=n.y,c=n.x;n.x=c+t.x,n.y=e+t.y;for(var i,r=this.calculateIndexForYPos_(n.y),s=null,l=o,y=r-1;y>=0&&this.isInYRange_(y,n.y,o);)i=this.connections_[y],this.connectionChecker_.canConnect(n,i,!0,l)&&(s=i,l=i.distanceFrom(n)),y--;for(var h=r;h<this.connections_.length&&this.isInYRange_(h,n.y,o);)i=this.connections_[h],this.connectionChecker_.canConnect(n,i,!0,l)&&(s=i,l=i.distanceFrom(n)),h++;return n.x=c,n.y=e,{connection:s,radius:l}},Blockly.ConnectionDB.init=function(n){var o=[];return o[Blockly.connectionTypes.INPUT_VALUE]=new Blockly.ConnectionDB(n),o[Blockly.connectionTypes.OUTPUT_VALUE]=new Blockly.ConnectionDB(n),o[Blockly.connectionTypes.NEXT_STATEMENT]=new Blockly.ConnectionDB(n),o[Blockly.connectionTypes.PREVIOUS_STATEMENT]=new Blockly.ConnectionDB(n),o};