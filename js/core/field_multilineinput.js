/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.FieldMultilineInput"),goog.require("Blockly.Css"),goog.require("Blockly.Field"),goog.require("Blockly.fieldRegistry"),goog.require("Blockly.FieldTextInput"),goog.require("Blockly.utils"),goog.require("Blockly.utils.aria"),goog.require("Blockly.utils.dom"),goog.require("Blockly.utils.KeyCodes"),goog.require("Blockly.utils.object"),goog.require("Blockly.utils.Svg"),goog.require("Blockly.utils.userAgent"),goog.require("Blockly.WidgetDiv"),Blockly.FieldMultilineInput=function(t,e,l){Blockly.FieldMultilineInput.superClass_.constructor.call(this,t,e,l),this.textGroup_=null,this.maxLines_=1/0,this.isOverflowedY_=!1},Blockly.utils.object.inherits(Blockly.FieldMultilineInput,Blockly.FieldTextInput),Blockly.FieldMultilineInput.prototype.configure_=function(t){Blockly.FieldMultilineInput.superClass_.configure_.call(this,t),t.maxLines&&this.setMaxLines(t.maxLines)},Blockly.FieldMultilineInput.fromJson=function(t){var e=Blockly.utils.replaceMessageReferences(t.text);return new Blockly.FieldMultilineInput(e,void 0,t)},Blockly.FieldMultilineInput.prototype.toXml=function(t){return t.textContent=this.getValue().replace(/\n/g,"&#10;"),t},Blockly.FieldMultilineInput.prototype.fromXml=function(t){this.setValue(t.textContent.replace(/&#10;/g,"\n"))},Blockly.FieldMultilineInput.prototype.initView=function(){this.createBorderRect_(),this.textGroup_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.G,{class:"blocklyEditableText"},this.fieldGroup_)},Blockly.FieldMultilineInput.prototype.getDisplayText_=function(){var t=this.getText();if(!t)return Blockly.Field.NBSP;var e=t.split("\n");t="";for(var l=this.isOverflowedY_?this.maxLines_:e.length,i=0;i<l;i++){var s=e[i];s.length>this.maxDisplayLength?s=s.substring(0,this.maxDisplayLength-4)+"...":this.isOverflowedY_&&i===l-1&&(s=s.substring(0,s.length-3)+"..."),t+=s=s.replace(/\s/g,Blockly.Field.NBSP),i!==l-1&&(t+="\n")}return this.sourceBlock_.RTL&&(t+="â€"),t},Blockly.FieldMultilineInput.prototype.doValueUpdate_=function(t){Blockly.FieldMultilineInput.superClass_.doValueUpdate_.call(this,t),this.isOverflowedY_=this.value_.split("\n").length>this.maxLines_},Blockly.FieldMultilineInput.prototype.render_=function(){for(var t;t=this.textGroup_.firstChild;)this.textGroup_.removeChild(t);for(var e=this.getDisplayText_().split("\n"),l=0,i=0;i<e.length;i++){var s=this.getConstants().FIELD_TEXT_HEIGHT+this.getConstants().FIELD_BORDER_RECT_Y_PADDING;Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.TEXT,{class:"blocklyText blocklyMultilineText",x:this.getConstants().FIELD_BORDER_RECT_X_PADDING,y:l+this.getConstants().FIELD_BORDER_RECT_Y_PADDING,dy:this.getConstants().FIELD_TEXT_BASELINE},this.textGroup_).appendChild(document.createTextNode(e[i])),l+=s}if(this.isBeingEdited_){var o=this.htmlInput_;this.isOverflowedY_?Blockly.utils.dom.addClass(o,"blocklyHtmlTextAreaInputOverflowedY"):Blockly.utils.dom.removeClass(o,"blocklyHtmlTextAreaInputOverflowedY")}if(this.updateSize_(),this.isBeingEdited_){this.sourceBlock_.RTL?setTimeout(this.resizeEditor_.bind(this),0):this.resizeEditor_();o=this.htmlInput_;this.isTextValid_?(Blockly.utils.dom.removeClass(o,"blocklyInvalidInput"),Blockly.utils.aria.setState(o,Blockly.utils.aria.State.INVALID,!1)):(Blockly.utils.dom.addClass(o,"blocklyInvalidInput"),Blockly.utils.aria.setState(o,Blockly.utils.aria.State.INVALID,!0))}},Blockly.FieldMultilineInput.prototype.updateSize_=function(){for(var t=this.textGroup_.childNodes,e=0,l=0,i=0;i<t.length;i++){var s=t[i],o=Blockly.utils.dom.getTextWidth(s);o>e&&(e=o),l+=this.getConstants().FIELD_TEXT_HEIGHT+(i>0?this.getConstants().FIELD_BORDER_RECT_Y_PADDING:0)}if(this.isBeingEdited_){var n=this.value_.split("\n"),r=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.TEXT,{class:"blocklyText blocklyMultilineText"}),u=this.getConstants().FIELD_TEXT_FONTSIZE,a=this.getConstants().FIELD_TEXT_FONTWEIGHT,c=this.getConstants().FIELD_TEXT_FONTFAMILY;for(i=0;i<n.length;i++){n[i].length>this.maxDisplayLength&&(n[i]=n[i].substring(0,this.maxDisplayLength)),r.textContent=n[i];var d=Blockly.utils.dom.getFastTextWidth(r,u,a,c);d>e&&(e=d)}e+=this.htmlInput_.offsetWidth-this.htmlInput_.clientWidth}this.borderRect_&&(l+=2*this.getConstants().FIELD_BORDER_RECT_Y_PADDING,e+=2*this.getConstants().FIELD_BORDER_RECT_X_PADDING,this.borderRect_.setAttribute("width",e),this.borderRect_.setAttribute("height",l)),this.size_.width=e,this.size_.height=l,this.positionBorderRect_()},Blockly.FieldMultilineInput.prototype.showEditor_=function(t,e){Blockly.FieldMultilineInput.superClass_.showEditor_.call(this,t,e),this.forceRerender()},Blockly.FieldMultilineInput.prototype.widgetCreate_=function(){var t=Blockly.WidgetDiv.DIV,e=this.workspace_.getScale(),l=document.createElement("textarea");l.className="blocklyHtmlInput blocklyHtmlTextAreaInput",l.setAttribute("spellcheck",this.spellcheck_);var i=this.getConstants().FIELD_TEXT_FONTSIZE*e+"pt";t.style.fontSize=i,l.style.fontSize=i;var s=Blockly.FieldTextInput.BORDERRADIUS*e+"px";l.style.borderRadius=s;var o=this.getConstants().FIELD_BORDER_RECT_X_PADDING*e,n=this.getConstants().FIELD_BORDER_RECT_Y_PADDING*e/2;l.style.padding=n+"px "+o+"px "+n+"px "+o+"px";var r=this.getConstants().FIELD_TEXT_HEIGHT+this.getConstants().FIELD_BORDER_RECT_Y_PADDING;return l.style.lineHeight=r*e+"px",t.appendChild(l),l.value=l.defaultValue=this.getEditorText_(this.value_),l.untypedDefaultValue_=this.value_,l.oldValue_=null,Blockly.utils.userAgent.GECKO?setTimeout(this.resizeEditor_.bind(this),0):this.resizeEditor_(),this.bindInputEvents_(l),l},Blockly.FieldMultilineInput.prototype.setMaxLines=function(t){"number"==typeof t&&t>0&&t!==this.maxLines_&&(this.maxLines_=t,this.forceRerender())},Blockly.FieldMultilineInput.prototype.getMaxLines=function(){return this.maxLines_},Blockly.FieldMultilineInput.prototype.onHtmlInputKeyDown_=function(t){t.keyCode!==Blockly.utils.KeyCodes.ENTER&&Blockly.FieldMultilineInput.superClass_.onHtmlInputKeyDown_.call(this,t)},Blockly.Css.register([".blocklyHtmlTextAreaInput {","font-family: monospace;","resize: none;","overflow: hidden;","height: 100%;","text-align: left;","}",".blocklyHtmlTextAreaInputOverflowedY {","overflow-y: scroll;","}"]),Blockly.fieldRegistry.register("field_multilinetext",Blockly.FieldMultilineInput);