/**
 * @license
 * Copyright 2018 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.Events.BlockBase"),goog.provide("Blockly.Events.BlockChange"),goog.provide("Blockly.Events.BlockCreate"),goog.provide("Blockly.Events.BlockDelete"),goog.provide("Blockly.Events.BlockMove"),goog.provide("Blockly.Events.Change"),goog.provide("Blockly.Events.Create"),goog.provide("Blockly.Events.Delete"),goog.provide("Blockly.Events.Move"),goog.require("Blockly.connectionTypes"),goog.require("Blockly.Events"),goog.require("Blockly.Events.Abstract"),goog.require("Blockly.registry"),goog.require("Blockly.utils.Coordinate"),goog.require("Blockly.utils.object"),goog.require("Blockly.utils.xml"),goog.require("Blockly.Xml"),goog.requireType("Blockly.Block"),Blockly.Events.BlockBase=function(e){Blockly.Events.BlockBase.superClass_.constructor.call(this),this.isBlank=void 0===e,this.blockId=this.isBlank?"":e.id,this.workspaceId=this.isBlank?"":e.workspace.id},Blockly.utils.object.inherits(Blockly.Events.BlockBase,Blockly.Events.Abstract),Blockly.Events.BlockBase.prototype.toJson=function(){var e=Blockly.Events.BlockBase.superClass_.toJson.call(this);return e.blockId=this.blockId,e},Blockly.Events.BlockBase.prototype.fromJson=function(e){Blockly.Events.BlockBase.superClass_.fromJson.call(this,e),this.blockId=e.blockId},Blockly.Events.BlockChange=function(e,o,t,l,n){Blockly.Events.Change.superClass_.constructor.call(this,e),e&&(this.element=void 0===o?"":o,this.name=void 0===t?"":t,this.oldValue=void 0===l?"":l,this.newValue=void 0===n?"":n)},Blockly.utils.object.inherits(Blockly.Events.BlockChange,Blockly.Events.BlockBase),Blockly.Events.Change=Blockly.Events.BlockChange,Blockly.Events.BlockChange.prototype.type=Blockly.Events.CHANGE,Blockly.Events.BlockChange.prototype.toJson=function(){var e=Blockly.Events.BlockChange.superClass_.toJson.call(this);return e.element=this.element,this.name&&(e.name=this.name),e.oldValue=this.oldValue,e.newValue=this.newValue,e},Blockly.Events.BlockChange.prototype.fromJson=function(e){Blockly.Events.BlockChange.superClass_.fromJson.call(this,e),this.element=e.element,this.name=e.name,this.oldValue=e.oldValue,this.newValue=e.newValue},Blockly.Events.BlockChange.prototype.isNull=function(){return this.oldValue==this.newValue},Blockly.Events.BlockChange.prototype.run=function(e){var o=this.getEventWorkspace_().getBlockById(this.blockId);if(o){o.mutator&&o.mutator.setVisible(!1);var t=e?this.newValue:this.oldValue;switch(this.element){case"field":var l=o.getField(this.name);l?l.setValue(t):console.warn("Can't set non-existent field: "+this.name);break;case"breakpoint":o.enableBreakpoint(t);break;case"comment":o.setCommentText(t||null);break;case"collapsed":o.setCollapsed(!!t);break;case"disabled":o.setEnabled(!t);break;case"inline":o.setInputsInline(!!t);break;case"mutation":var n="";if(o.mutationToDom){var s=o.mutationToDom();n=s&&Blockly.Xml.domToText(s)}if(o.domToMutation){var c=Blockly.Xml.textToDom(t||"<mutation/>");o.domToMutation(c),o.initSvg(),o.rendered&&o.render()}Blockly.Events.fire(new Blockly.Events.BlockChange(o,"mutation",null,n,t));break;default:console.warn("Unknown change type: "+this.element)}}else console.warn("Can't change non-existent block: "+this.blockId)},Blockly.Events.Create=function(e){Blockly.Events.Create.superClass_.constructor.call(this,e),e&&(e.isShadow()&&(this.recordUndo=!1),e.workspace.rendered?this.xml=Blockly.Xml.blockToDomWithXY(e):this.xml=Blockly.Xml.blockToDom(e),this.ids=Blockly.Events.getDescendantIds(e))},Blockly.utils.object.inherits(Blockly.Events.Create,Blockly.Events.BlockBase),Blockly.Events.BlockCreate=Blockly.Events.Create,Blockly.Events.Create.prototype.type=Blockly.Events.CREATE,Blockly.Events.Create.prototype.toJson=function(){var e=Blockly.Events.Create.superClass_.toJson.call(this);return e.xml=Blockly.Xml.domToText(this.xml),e.ids=this.ids,this.recordUndo||(e.recordUndo=this.recordUndo),e},Blockly.Events.Create.prototype.fromJson=function(e){Blockly.Events.Create.superClass_.fromJson.call(this,e),this.xml=Blockly.Xml.textToDom(e.xml),this.ids=e.ids,void 0!==e.recordUndo&&(this.recordUndo=e.recordUndo)},Blockly.Events.Create.prototype.run=function(e){var o=this.getEventWorkspace_();if(e){var t=Blockly.utils.xml.createElement("xml");t.appendChild(this.xml),Blockly.Xml.domToWorkspace(t,o)}else for(var l,n=0;l=this.ids[n];n++){var s=o.getBlockById(l);s?s.dispose(!1):l==this.blockId&&console.warn("Can't uncreate non-existent block: "+l)}},Blockly.Events.Delete=function(e){if(Blockly.Events.Delete.superClass_.constructor.call(this,e),e){if(e.getParent())throw Error("Connected blocks cannot be deleted.");e.isShadow()&&(this.recordUndo=!1),e.workspace.rendered?this.oldXml=Blockly.Xml.blockToDomWithXY(e):this.oldXml=Blockly.Xml.blockToDom(e),this.ids=Blockly.Events.getDescendantIds(e)}},Blockly.utils.object.inherits(Blockly.Events.Delete,Blockly.Events.BlockBase),Blockly.Events.BlockDelete=Blockly.Events.Delete,Blockly.Events.Delete.prototype.type=Blockly.Events.DELETE,Blockly.Events.Delete.prototype.toJson=function(){var e=Blockly.Events.Delete.superClass_.toJson.call(this);return e.oldXml=Blockly.Xml.domToText(this.oldXml),e.ids=this.ids,this.recordUndo||(e.recordUndo=this.recordUndo),e},Blockly.Events.Delete.prototype.fromJson=function(e){Blockly.Events.Delete.superClass_.fromJson.call(this,e),this.oldXml=Blockly.Xml.textToDom(e.oldXml),this.ids=e.ids,void 0!==e.recordUndo&&(this.recordUndo=e.recordUndo)},Blockly.Events.Delete.prototype.run=function(e){var o=this.getEventWorkspace_();if(e)for(var t,l=0;t=this.ids[l];l++){var n=o.getBlockById(t);n?n.dispose(!1):t==this.blockId&&console.warn("Can't delete non-existent block: "+t)}else{var s=Blockly.utils.xml.createElement("xml");s.appendChild(this.oldXml),Blockly.Xml.domToWorkspace(s,o)}},Blockly.Events.Move=function(e){if(Blockly.Events.Move.superClass_.constructor.call(this,e),e){e.isShadow()&&(this.recordUndo=!1);var o=this.currentLocation_();this.oldParentId=o.parentId,this.oldInputName=o.inputName,this.oldCoordinate=o.coordinate}},Blockly.utils.object.inherits(Blockly.Events.Move,Blockly.Events.BlockBase),Blockly.Events.BlockMove=Blockly.Events.Move,Blockly.Events.Move.prototype.type=Blockly.Events.MOVE,Blockly.Events.Move.prototype.toJson=function(){var e=Blockly.Events.Move.superClass_.toJson.call(this);return this.newParentId&&(e.newParentId=this.newParentId),this.newInputName&&(e.newInputName=this.newInputName),this.newCoordinate&&(e.newCoordinate=Math.round(this.newCoordinate.x)+","+Math.round(this.newCoordinate.y)),this.recordUndo||(e.recordUndo=this.recordUndo),e},Blockly.Events.Move.prototype.fromJson=function(e){if(Blockly.Events.Move.superClass_.fromJson.call(this,e),this.newParentId=e.newParentId,this.newInputName=e.newInputName,e.newCoordinate){var o=e.newCoordinate.split(",");this.newCoordinate=new Blockly.utils.Coordinate(Number(o[0]),Number(o[1]))}void 0!==e.recordUndo&&(this.recordUndo=e.recordUndo)},Blockly.Events.Move.prototype.recordNew=function(){var e=this.currentLocation_();this.newParentId=e.parentId,this.newInputName=e.inputName,this.newCoordinate=e.coordinate},Blockly.Events.Move.prototype.currentLocation_=function(){var e=this.getEventWorkspace_().getBlockById(this.blockId),o={},t=e.getParent();if(t){o.parentId=t.id;var l=t.getInputWithBlock(e);l&&(o.inputName=l.name)}else o.coordinate=e.getRelativeToSurfaceXY();return o},Blockly.Events.Move.prototype.isNull=function(){return this.oldParentId==this.newParentId&&this.oldInputName==this.newInputName&&Blockly.utils.Coordinate.equals(this.oldCoordinate,this.newCoordinate)},Blockly.Events.Move.prototype.run=function(e){var o=this.getEventWorkspace_(),t=o.getBlockById(this.blockId);if(t){var l=e?this.newParentId:this.oldParentId,n=e?this.newInputName:this.oldInputName,s=e?this.newCoordinate:this.oldCoordinate,c=null;if(!l||(c=o.getBlockById(l)))if(t.getParent()&&t.unplug(),s){var r=t.getRelativeToSurfaceXY();t.moveBy(s.x-r.x,s.y-r.y)}else{var i,a=t.outputConnection||t.previousConnection,k=a.type;if(n){var d=c.getInput(n);d&&(i=d.connection)}else k==Blockly.connectionTypes.PREVIOUS_STATEMENT&&(i=c.nextConnection);i?a.connect(i):console.warn("Can't connect to non-existent input: "+n)}else console.warn("Can't connect to non-existent block: "+l)}else console.warn("Can't move non-existent block: "+this.blockId)},Blockly.registry.register(Blockly.registry.Type.EVENT,Blockly.Events.CREATE,Blockly.Events.Create),Blockly.registry.register(Blockly.registry.Type.EVENT,Blockly.Events.DELETE,Blockly.Events.Delete),Blockly.registry.register(Blockly.registry.Type.EVENT,Blockly.Events.CHANGE,Blockly.Events.BlockChange),Blockly.registry.register(Blockly.registry.Type.EVENT,Blockly.Events.MOVE,Blockly.Events.Move);