/**
 * @license
 * Copyright 2016 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.Events"),goog.require("Blockly.registry"),goog.require("Blockly.utils"),goog.requireType("Blockly.Block"),goog.requireType("Blockly.Events.Abstract"),goog.requireType("Blockly.Workspace"),Blockly.Events.group_="",Blockly.Events.recordUndo=!0,Blockly.Events.disabled_=0,Blockly.Events.CREATE="create",Blockly.Events.BLOCK_CREATE=Blockly.Events.CREATE,Blockly.Events.DELETE="delete",Blockly.Events.BLOCK_DELETE=Blockly.Events.DELETE,Blockly.Events.CHANGE="change",Blockly.Events.BLOCK_CHANGE=Blockly.Events.CHANGE,Blockly.Events.MOVE="move",Blockly.Events.BLOCK_MOVE=Blockly.Events.MOVE,Blockly.Events.VAR_CREATE="var_create",Blockly.Events.VAR_DELETE="var_delete",Blockly.Events.VAR_RENAME="var_rename",Blockly.Events.UI="ui",Blockly.Events.END_DRAG="end_drag",Blockly.Events.BLOCK_DRAG="drag",Blockly.Events.SELECTED="selected",Blockly.Events.CLICK="click",Blockly.Events.MARKER_MOVE="marker_move",Blockly.Events.BUBBLE_OPEN="bubble_open",Blockly.Events.TRASHCAN_OPEN="trashcan_open",Blockly.Events.TOOLBOX_ITEM_SELECT="toolbox_item_select",Blockly.Events.THEME_CHANGE="theme_change",Blockly.Events.VIEWPORT_CHANGE="viewport_change",Blockly.Events.COMMENT_CREATE="comment_create",Blockly.Events.COMMENT_DELETE="comment_delete",Blockly.Events.COMMENT_CHANGE="comment_change",Blockly.Events.COMMENT_MOVE="comment_move",Blockly.Events.FINISHED_LOADING="finished_loading",Blockly.Events.BumpEvent,Blockly.Events.BUMP_EVENTS=[Blockly.Events.BLOCK_CREATE,Blockly.Events.BLOCK_MOVE,Blockly.Events.COMMENT_CREATE,Blockly.Events.COMMENT_MOVE],Blockly.Events.FIRE_QUEUE_=[],Blockly.Events.fire=function(e){Blockly.Events.isEnabled()&&(Blockly.Events.FIRE_QUEUE_.length||setTimeout(Blockly.Events.fireNow_,0),Blockly.Events.FIRE_QUEUE_.push(e))},Blockly.Events.fireNow_=function(){var e=Blockly.Events.filter(Blockly.Events.FIRE_QUEUE_,!0);Blockly.Events.FIRE_QUEUE_.length=0;for(var l,n=0;l=e[n];n++)if(l.workspaceId){var t=Blockly.Workspace.getById(l.workspaceId);t&&t.fireChangeListener(l)}},Blockly.Events.filter=function(e,l){var n=e.slice();l||n.reverse();for(var t=[],o=Object.create(null),E=0;v=n[E];E++)if(!v.isNull()){var c=[v.isUiEvent?Blockly.Events.UI:v.type,v.blockId,v.workspaceId].join(" "),s=o[c],r=s?s.event:null;s?v.type==Blockly.Events.MOVE&&s.index==E-1?(r.newParentId=v.newParentId,r.newInputName=v.newInputName,r.newCoordinate=v.newCoordinate,s.index=E):v.type==Blockly.Events.CHANGE&&v.element==r.element&&v.name==r.name?r.newValue=v.newValue:v.type==Blockly.Events.VIEWPORT_CHANGE?(r.viewTop=v.viewTop,r.viewLeft=v.viewLeft,r.scale=v.scale,r.oldScale=v.oldScale):(v.type!=Blockly.Events.CLICK||r.type!=Blockly.Events.BUBBLE_OPEN&&"breakpointSet"!=r.element)&&(o[c]={event:v,index:E},t.push(v)):(o[c]={event:v,index:E},t.push(v))}n=t.filter(function(e){return!e.isNull()}),l||n.reverse();var v;for(E=1;v=n[E];E++)v.type==Blockly.Events.CHANGE&&"mutation"==v.element&&n.unshift(n.splice(E,1)[0]);return n},Blockly.Events.clearPendingUndo=function(){for(var e,l=0;e=Blockly.Events.FIRE_QUEUE_[l];l++)e.recordUndo=!1},Blockly.Events.disable=function(){Blockly.Events.disabled_++},Blockly.Events.enable=function(){Blockly.Events.disabled_--},Blockly.Events.isEnabled=function(){return 0==Blockly.Events.disabled_},Blockly.Events.getGroup=function(){return Blockly.Events.group_},Blockly.Events.setGroup=function(e){Blockly.Events.group_="boolean"==typeof e?e?Blockly.utils.genUid():"":e},Blockly.Events.getDescendantIds=function(e){for(var l,n=[],t=e.getDescendants(!1),o=0;l=t[o];o++)n[o]=l.id;return n},Blockly.Events.fromJson=function(e,l){var n=Blockly.Events.get(e.type);if(!n)throw Error("Unknown event type.");var t=new n;return t.fromJson(e),t.workspaceId=l.id,t},Blockly.Events.get=function(e){return Blockly.registry.getClass(Blockly.registry.Type.EVENT,e)},Blockly.Events.disableOrphans=function(e){if(e.type==Blockly.Events.MOVE||e.type==Blockly.Events.CREATE){if(!e.workspaceId)return;var l=Blockly.Workspace.getById(e.workspaceId),n=l.getBlockById(e.blockId);if(n){var t=Blockly.Events.recordUndo;try{Blockly.Events.recordUndo=!1;var o=n.getParent();if(o&&o.isEnabled())for(var E,c=n.getDescendants(!1),s=0;E=c[s];s++)E.setEnabled(!0);else if((n.outputConnection||n.previousConnection)&&!l.isDragging())do{n.setEnabled(!1),n=n.getNextBlock()}while(n)}finally{Blockly.Events.recordUndo=t}}}};