/**
 * @license
 * Copyright 2016 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.FieldNumber"),goog.require("Blockly.fieldRegistry"),goog.require("Blockly.FieldTextInput"),goog.require("Blockly.Touch"),goog.require("Blockly.utils.aria"),goog.require("Blockly.utils.object"),goog.require("Blockly.utils.userAgent"),Blockly.FieldNumber=function(t,e,l,i,o,r){this.getNumRestrictor(e,l,i);this.min_=-1/0,this.max_=1/0,this.precision_=0,this.decimalPlaces_=null,Blockly.FieldNumber.superClass_.constructor.call(this,t,o,r),r||this.setConstraints(e,l,i),this.addArgType("number")},Blockly.utils.object.inherits(Blockly.FieldNumber,Blockly.FieldTextInput),Blockly.FieldNumber.prototype.DEFAULT_VALUE=0,Blockly.FieldNumber.fromJson=function(t){return new Blockly.FieldNumber(t.value,void 0,void 0,void 0,void 0,t)},Blockly.FieldNumber.prototype.SERIALIZABLE=!0,Blockly.FieldNumber.DROPDOWN_WIDTH=168,Blockly.FieldNumber.NUMPAD_BUTTONS=["7","8","9","4","5","6","1","2","3",".","0","-"," "],Blockly.FieldNumber.NUMPAD_DELETE_ICON="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 40 40'%3E%3Cpath d='M28.89,11.45H16.79a2.86,2.86,0,0,0-2,.84L9.09,18a2.85,2.85,0,0,0,0,4l5.69,5.69a2.86,2.86,0,0,0,2,.84h12.1a2.86,2.86,0,0,0,2.86-2.86V14.31A2.86,2.86,0,0,0,28.89,11.45ZM27.15,22.73a1,1,0,0,1,0,1.41,1,1,0,0,1-.71.3,1,1,0,0,1-.71-0.3L23,21.41l-2.73,2.73a1,1,0,0,1-1.41,0,1,1,0,0,1,0-1.41L21.59,20l-2.73-2.73a1,1,0,0,1,0-1.41,1,1,0,0,1,1.41,0L23,18.59l2.73-2.73a1,1,0,1,1,1.42,1.41L24.42,20Z' fill='%23"+Blockly.Colours.numPadText.substr(1)+"'/%3E%3C/svg%3E",Blockly.FieldNumber.activeField_=null,Blockly.FieldNumber.prototype.getNumRestrictor=function(t,e,l){this.setConstraints(t,e,l);var i="[\\d]";return this.decimalAllowed_&&(i+="|[\\.]"),this.negativeAllowed_&&(i+="|[-]"),new RegExp(i)},Blockly.FieldNumber.prototype.configure_=function(t){Blockly.FieldNumber.superClass_.configure_.call(this,t),this.setMinInternal_(t.min),this.setMaxInternal_(t.max),this.setPrecisionInternal_(t.precision)},Blockly.FieldNumber.prototype.setConstraints=function(t,e,l){this.decimalAllowed_=null==l||isNaN(l)||0==l||Math.floor(l)!=l,this.negativeAllowed_=null==t||isNaN(t)||t<0,this.setMinInternal_(t),this.setMaxInternal_(e),this.setPrecisionInternal_(l),this.setValue(this.getValue())},Blockly.FieldNumber.prototype.setMin=function(t){this.setMinInternal_(t),this.setValue(this.getValue())},Blockly.FieldNumber.prototype.setMinInternal_=function(t){null==t?this.min_=-1/0:(t=Number(t),isNaN(t)||(this.min_=t))},Blockly.FieldNumber.prototype.getMin=function(){return this.min_},Blockly.FieldNumber.prototype.setMax=function(t){this.setMaxInternal_(t),this.setValue(this.getValue())},Blockly.FieldNumber.prototype.setMaxInternal_=function(t){null==t?this.max_=1/0:(t=Number(t),isNaN(t)||(this.max_=t))},Blockly.FieldNumber.prototype.getMax=function(){return this.max_},Blockly.FieldNumber.prototype.setPrecision=function(t){this.setPrecisionInternal_(t),this.setValue(this.getValue())},Blockly.FieldNumber.prototype.setPrecisionInternal_=function(t){this.precision_=Number(t)||0;var e=String(this.precision_);-1!=e.indexOf("e")&&(e=this.precision_.toLocaleString("en-US",{maximumFractionDigits:20}));var l=e.indexOf(".");this.decimalPlaces_=-1==l?t?0:null:e.length-l-1},Blockly.FieldNumber.prototype.getPrecision=function(){return this.precision_},Blockly.FieldNumber.prototype.showEditor_=function(t,e){Blockly.FieldNumber.activeField_=this;var l=void 0!==e?e:Blockly.utils.userAgent.MOBILE||Blockly.utils.userAgent.ANDROID||Blockly.utils.userAgent.IPAD;Blockly.FieldNumber.superClass_.showEditor_.call(this,t,l,l),l&&this.showNumPad_()},Blockly.FieldNumber.prototype.showNumPad_=function(){Blockly.DropDownDiv.hideWithoutAnimation(),Blockly.DropDownDiv.clearContent();var t=Blockly.DropDownDiv.getContentDiv();t.setAttribute("role","menu"),t.setAttribute("aria-haspopup","true"),this.addButtons_(t);var e=this.sourceBlock_.parentBlock_?this.sourceBlock_.parentBlock_.getColour():Blockly.Colours.numPadBackground,l=this.sourceBlock_.parentBlock_?this.sourceBlock_.parentBlock_.style.colourTertiary:Blockly.Colours.numPadBorder;Blockly.DropDownDiv.setColour(e,l),t.style.width=Blockly.FieldNumber.DROPDOWN_WIDTH+"px",Blockly.DropDownDiv.showPositionedByField(this,this.onHide_.bind(this)),this.htmlInput_.select()},Blockly.FieldNumber.prototype.addButtons_=function(t){for(var e,l=this.sourceBlock_.parentBlock_?this.sourceBlock_.parentBlock_.getColour():Blockly.Colours.numPadBackground,i=this.sourceBlock_.parentBlock_?this.sourceBlock_.parentBlock_.style.colourTertiary:this.sourceBlock_.style.colourTertiary,o=Blockly.FieldNumber.NUMPAD_BUTTONS,r=0;e=o[r];r++){var s=document.createElement("button");if(s.setAttribute("role","menuitem"),s.setAttribute("class","blocklyNumPadButton"),s.setAttribute("style","background:"+l+";border: 1px solid "+i+";"),s.title=e,s.innerHTML=e,Blockly.bindEvent_(s,"mousedown",this,this.numPadButtonTouch),"."!=e||this.decimalAllowed_){if("-"==e&&!this.negativeAllowed_)continue;if(" "==e&&!this.negativeAllowed_)continue;" "==e&&this.negativeAllowed_&&s.setAttribute("style","visibility: hidden")}else s.setAttribute("style","visibility: hidden");t.appendChild(s)}var n=document.createElement("button");n.setAttribute("role","menuitem"),n.setAttribute("class","blocklyNumPadButton"),n.setAttribute("style","background:"+l+";border: 1px solid "+i+";"),n.title="Delete";var u=document.createElement("img");u.src=Blockly.FieldNumber.NUMPAD_DELETE_ICON,n.appendChild(u),Blockly.bindEvent_(n,"mousedown",this,this.numPadEraseButtonTouch),t.appendChild(n)},Blockly.FieldNumber.prototype.numPadButtonTouch=function(t){var e=t.target.innerText,l=this.htmlInput_.value,i=this.htmlInput_.selectionStart,o=this.htmlInput_.selectionEnd,r=l.slice(0,i)+e+l.slice(o);o-i==0&&(r=l+e),this.updateDisplay_(r),Blockly.Touch.clearTouchIdentifier(),t.preventDefault()},Blockly.FieldNumber.prototype.numPadEraseButtonTouch=function(t){var e=this.htmlInput_.value,l=this.htmlInput_.selectionStart,i=this.htmlInput_.selectionEnd,o=e.slice(0,l)+e.slice(i);i-l==0&&(o=0==i?e.slice(0,e.length-1):e.slice(0,l-1)+e.slice(l)),this.updateDisplay_(o),Blockly.Touch.clearTouchIdentifier(),t.preventDefault()},Blockly.FieldNumber.prototype.updateDisplay_=function(t){this.htmlInput_.value=t,Blockly.FieldNumber.superClass_.resizeEditor_.call(this),this.htmlInput_.setSelectionRange(t.length,t.length),this.htmlInput_.scrollLeft=this.htmlInput_.scrollWidth,this.onHtmlInputChange_({})},Blockly.FieldNumber.prototype.onHide_=function(){Blockly.DropDownDiv.content_.removeAttribute("role"),Blockly.DropDownDiv.content_.removeAttribute("aria-haspopup")},Blockly.FieldNumber.prototype.doClassValidation_=function(t){if(null===t)return null;var e=String(t);e=(e=(e=e.replace(/O/gi,"0")).replace(/,/g,"")).replace(/infinity/i,"Infinity");var l=Number(e||0);return isNaN(l)?null:(this.precision_&&isFinite(l)&&(l=Math.round(l/this.precision_)*this.precision_),null!=this.decimalPlaces_&&(l=Number(l.toFixed(this.decimalPlaces_))),l)},Blockly.FieldNumber.prototype.widgetCreate_=function(t,e,l){var i=Blockly.FieldNumber.superClass_.widgetCreate_.call(this,t,e,l);return this.min_>-1/0&&Blockly.utils.aria.setState(i,Blockly.utils.aria.State.VALUEMIN,this.min_),this.max_<1/0&&Blockly.utils.aria.setState(i,Blockly.utils.aria.State.VALUEMAX,this.max_),i},Blockly.fieldRegistry.register("field_number",Blockly.FieldNumber);