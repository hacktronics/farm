/**
 * @license
 * Copyright 2012 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.FieldColour"),goog.require("Blockly.browserEvents"),goog.require("Blockly.Css"),goog.require("Blockly.DropDownDiv"),goog.require("Blockly.Events.BlockChange"),goog.require("Blockly.Field"),goog.require("Blockly.fieldRegistry"),goog.require("Blockly.utils.aria"),goog.require("Blockly.utils.colour"),goog.require("Blockly.utils.dom"),goog.require("Blockly.utils.IdGenerator"),goog.require("Blockly.utils.KeyCodes"),goog.require("Blockly.utils.object"),goog.require("Blockly.utils.Size"),Blockly.FieldColour=function(o,l,e){Blockly.FieldColour.superClass_.constructor.call(this,o,l,e),this.picker_=null,this.highlightedIndex_=null,this.onClickWrapper_=null,this.onMouseMoveWrapper_=null,this.onMouseEnterWrapper_=null,this.onMouseLeaveWrapper_=null,this.onKeyDownWrapper_=null,this.addArgType("colour")},Blockly.utils.object.inherits(Blockly.FieldColour,Blockly.Field),Blockly.FieldColour.fromJson=function(o){return new Blockly.FieldColour(o.colour,void 0,o)},Blockly.FieldColour.prototype.SERIALIZABLE=!0,Blockly.FieldColour.prototype.CURSOR="default",Blockly.FieldColour.prototype.isDirty_=!1,Blockly.FieldColour.prototype.colours_=null,Blockly.FieldColour.prototype.titles_=null,Blockly.FieldColour.prototype.columns_=0,Blockly.FieldColour.prototype.configure_=function(o){Blockly.FieldColour.superClass_.configure_.call(this,o),o.colourOptions&&(this.colours_=o.colourOptions,this.titles_=o.colourTitles),o.columns&&(this.columns_=o.columns)},Blockly.FieldColour.prototype.initView=function(){this.size_=new Blockly.utils.Size(this.getConstants().FIELD_COLOUR_DEFAULT_WIDTH,this.getConstants().FIELD_COLOUR_DEFAULT_HEIGHT),this.getConstants().FIELD_COLOUR_FULL_BLOCK?this.clickTarget_=this.sourceBlock_.getSvgRoot():(this.createBorderRect_(),this.borderRect_.style.fillOpacity="1")},Blockly.FieldColour.prototype.applyColour=function(){this.getConstants().FIELD_COLOUR_FULL_BLOCK?(this.sourceBlock_.pathObject.svgPath.setAttribute("fill",this.getValue()),this.sourceBlock_.pathObject.svgPath.setAttribute("stroke","#fff")):this.borderRect_&&(this.borderRect_.style.fill=this.getValue())},Blockly.FieldColour.prototype.doClassValidation_=function(o){return"string"!=typeof o?null:Blockly.utils.colour.parse(o)},Blockly.FieldColour.prototype.doValueUpdate_=function(o){this.value_=o,this.borderRect_?this.borderRect_.style.fill=o:this.sourceBlock_&&this.sourceBlock_.rendered&&(this.sourceBlock_.pathObject.svgPath.setAttribute("fill",o),this.sourceBlock_.pathObject.svgPath.setAttribute("stroke","#fff"))},Blockly.FieldColour.prototype.getText=function(){var o=this.value_;return/^#(.)\1(.)\2(.)\3$/.test(o)&&(o="#"+o[1]+o[3]+o[5]),o},Blockly.FieldColour.COLOURS=["#ffffff","#cccccc","#c0c0c0","#999999","#666666","#333333","#000000","#ffcccc","#ff6666","#ff0000","#cc0000","#990000","#660000","#330000","#ffcc99","#ff9966","#ff9900","#ff6600","#cc6600","#993300","#663300","#ffff99","#ffff66","#ffcc66","#ffcc33","#cc9933","#996633","#663333","#ffffcc","#ffff33","#ffff00","#ffcc00","#999900","#666600","#333300","#99ff99","#66ff99","#33ff33","#33cc00","#009900","#006600","#003300","#99ffff","#33ffff","#66cccc","#00cccc","#339999","#336666","#003333","#ccffff","#66ffff","#33ccff","#3366ff","#3333ff","#000099","#000066","#ccccff","#9999ff","#6666cc","#6633ff","#6600cc","#333399","#330099","#ffccff","#ff99ff","#cc66cc","#cc33cc","#993399","#663366","#330033"],Blockly.FieldColour.prototype.DEFAULT_VALUE=Blockly.FieldColour.COLOURS[0],Blockly.FieldColour.TITLES=[],Blockly.FieldColour.COLUMNS=7,Blockly.FieldColour.prototype.setColours=function(o,l){return this.colours_=o,l&&(this.titles_=l),this},Blockly.FieldColour.prototype.setColumns=function(o){return this.columns_=o,this},Blockly.FieldColour.prototype.showEditor_=function(){this.dropdownCreate_(),Blockly.DropDownDiv.getContentDiv().appendChild(this.picker_),Blockly.DropDownDiv.showPositionedByField(this,this.dropdownDispose_.bind(this)),this.picker_.focus({preventScroll:!0})},Blockly.FieldColour.prototype.onClick_=function(o){var l=o.target,e=l&&l.label;null!==e&&(this.setValue(e),Blockly.DropDownDiv.hideIfOwner(this))},Blockly.FieldColour.prototype.onKeyDown_=function(o){var l=!1;if(o.keyCode===Blockly.utils.KeyCodes.UP)this.moveHighlightBy_(0,-1),l=!0;else if(o.keyCode===Blockly.utils.KeyCodes.DOWN)this.moveHighlightBy_(0,1),l=!0;else if(o.keyCode===Blockly.utils.KeyCodes.LEFT)this.moveHighlightBy_(-1,0),l=!0;else if(o.keyCode===Blockly.utils.KeyCodes.RIGHT)this.moveHighlightBy_(1,0),l=!0;else if(o.keyCode===Blockly.utils.KeyCodes.ENTER){var e=this.getHighlighted_();if(e){var t=e&&e.label;null!==t&&this.setValue(t)}Blockly.DropDownDiv.hideWithoutAnimation(),l=!0}l&&o.stopPropagation()},Blockly.FieldColour.prototype.moveHighlightBy_=function(o,l){var e=this.colours_||Blockly.FieldColour.COLOURS,t=this.columns_||Blockly.FieldColour.COLUMNS,i=this.highlightedIndex_%t,r=Math.floor(this.highlightedIndex_/t);i+=o,r+=l,o<0?i<0&&r>0?(i=t-1,r--):i<0&&(i=0):o>0?i>t-1&&r<Math.floor(e.length/t)-1?(i=0,r++):i>t-1&&i--:l<0?r<0&&(r=0):l>0&&r>Math.floor(e.length/t)-1&&(r=Math.floor(e.length/t)-1);var s=this.picker_.childNodes[r].childNodes[i],c=r*t+i;this.setHighlightedCell_(s,c)},Blockly.FieldColour.prototype.onMouseMove_=function(o){var l=o.target,e=l&&Number(l.getAttribute("data-index"));null!==e&&e!==this.highlightedIndex_&&this.setHighlightedCell_(l,e)},Blockly.FieldColour.prototype.onMouseEnter_=function(){this.picker_.focus({preventScroll:!0})},Blockly.FieldColour.prototype.onMouseLeave_=function(){this.picker_.blur();var o=this.getHighlighted_();o&&Blockly.utils.dom.removeClass(o,"blocklyColourHighlighted")},Blockly.FieldColour.prototype.getHighlighted_=function(){var o=this.columns_||Blockly.FieldColour.COLUMNS,l=this.highlightedIndex_%o,e=Math.floor(this.highlightedIndex_/o),t=this.picker_.childNodes[e];return t?t.childNodes[l]:null},Blockly.FieldColour.prototype.setHighlightedCell_=function(o,l){var e=this.getHighlighted_();e&&Blockly.utils.dom.removeClass(e,"blocklyColourHighlighted"),Blockly.utils.dom.addClass(o,"blocklyColourHighlighted"),this.highlightedIndex_=l,Blockly.utils.aria.setState(this.picker_,Blockly.utils.aria.State.ACTIVEDESCENDANT,o.getAttribute("id"))},Blockly.FieldColour.prototype.dropdownCreate_=function(){var o,l=this.columns_||Blockly.FieldColour.COLUMNS,e=this.colours_||Blockly.FieldColour.COLOURS,t=this.titles_||Blockly.FieldColour.TITLES,i=this.getValue(),r=document.createElement("table");r.className="blocklyColourTable",r.tabIndex=0,r.dir="ltr",Blockly.utils.aria.setRole(r,Blockly.utils.aria.Role.GRID),Blockly.utils.aria.setState(r,Blockly.utils.aria.State.EXPANDED,!0),Blockly.utils.aria.setState(r,Blockly.utils.aria.State.ROWCOUNT,Math.floor(e.length/l)),Blockly.utils.aria.setState(r,Blockly.utils.aria.State.COLCOUNT,l);for(var s=0;s<e.length;s++){s%l==0&&(o=document.createElement("tr"),Blockly.utils.aria.setRole(o,Blockly.utils.aria.Role.ROW),r.appendChild(o));var c=document.createElement("td");o.appendChild(c),c.label=e[s],c.title=t[s]||e[s],c.id=Blockly.utils.IdGenerator.getNextUniqueId(),c.setAttribute("data-index",s),Blockly.utils.aria.setRole(c,Blockly.utils.aria.Role.GRIDCELL),Blockly.utils.aria.setState(c,Blockly.utils.aria.State.LABEL,e[s]),Blockly.utils.aria.setState(c,Blockly.utils.aria.State.SELECTED,e[s]==i),c.style.backgroundColor=e[s],e[s]==i&&(c.className="blocklyColourSelected",this.highlightedIndex_=s)}this.onClickWrapper_=Blockly.browserEvents.conditionalBind(r,"click",this,this.onClick_,!0),this.onMouseMoveWrapper_=Blockly.browserEvents.conditionalBind(r,"mousemove",this,this.onMouseMove_,!0),this.onMouseEnterWrapper_=Blockly.browserEvents.conditionalBind(r,"mouseenter",this,this.onMouseEnter_,!0),this.onMouseLeaveWrapper_=Blockly.browserEvents.conditionalBind(r,"mouseleave",this,this.onMouseLeave_,!0),this.onKeyDownWrapper_=Blockly.browserEvents.conditionalBind(r,"keydown",this,this.onKeyDown_),this.picker_=r},Blockly.FieldColour.prototype.dropdownDispose_=function(){this.onClickWrapper_&&(Blockly.browserEvents.unbind(this.onClickWrapper_),this.onClickWrapper_=null),this.onMouseMoveWrapper_&&(Blockly.browserEvents.unbind(this.onMouseMoveWrapper_),this.onMouseMoveWrapper_=null),this.onMouseEnterWrapper_&&(Blockly.browserEvents.unbind(this.onMouseEnterWrapper_),this.onMouseEnterWrapper_=null),this.onMouseLeaveWrapper_&&(Blockly.browserEvents.unbind(this.onMouseLeaveWrapper_),this.onMouseLeaveWrapper_=null),this.onKeyDownWrapper_&&(Blockly.browserEvents.unbind(this.onKeyDownWrapper_),this.onKeyDownWrapper_=null),this.picker_=null,this.highlightedIndex_=null},Blockly.Css.register([".blocklyColourTable {","outline: none;","border-radius: 11px;","border-collapse: separate;","border-spacing: 4px;","}",".blocklyColourTable > tr > td {","height: 22px;","width: 22px;","margin: 0;","border: 0;","text-align: center;","cursor: pointer;","border-radius: 4px;","border: 2px solid rgba(0,0,0,.1);","}",".blocklyColourTable > tr > td:hover {","border: 1px solid #FFF;","box-sizing: border-box;","}",".blocklyColourTable > tr > td.blocklyColourSelected {","border: 1px solid #000;","box-sizing: border-box;","color: #fff;","}",".blocklyColourTable>tr>td.blocklyColourHighlighted {","border-color: #eee;","box-shadow: 2px 2px 7px 2px rgba(0,0,0,.3);","position: relative;","}",".blocklyColourSelected, .blocklyColourSelected:hover {","border-color: #eee !important;","outline: 1px solid #333;","position: relative;","}"]),Blockly.fieldRegistry.register("field_colour",Blockly.FieldColour);