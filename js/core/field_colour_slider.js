/**
 * @license
 * Visual Blocks Editor
 *
 * Copyright 2012 Google Inc.
 * https://developers.google.com/blockly/
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
"use strict";goog.provide("Blockly.FieldColourSlider"),goog.require("Blockly.Field"),goog.require("Blockly.fieldRegistry"),goog.require("Blockly.DropDownDiv"),goog.require("goog.dom"),goog.require("goog.events"),goog.require("goog.style"),goog.require("Blockly.utils.colour"),goog.require("Blockly.utils.object"),goog.require("goog.ui.Slider"),Blockly.FieldColourSlider=function(e,t){Blockly.FieldColourSlider.superClass_.constructor.call(this,e,t),this.addArgType("colour")},Blockly.utils.object.inherits(Blockly.FieldColourSlider,Blockly.Field),Blockly.FieldColourSlider.fromJson=function(e){return new Blockly.FieldColourSlider(e.colour)},Blockly.FieldColourSlider.prototype.init=function(e){Blockly.FieldColourSlider.superClass_.init.call(this,e),this.setValue(this.getValue())},Blockly.FieldColourSlider.prototype.getValue=function(){return this.colour_},Blockly.FieldColourSlider.prototype.setValue=function(e){this.sourceBlock_&&Blockly.Events.isEnabled()&&this.colour_!=e&&Blockly.Events.fire(new Blockly.Events.BlockChange(this.sourceBlock_,"field",this.name,this.colour_,e)),this.colour_=e,this.sourceBlock_&&this.sourceBlock_.setColour(e,e,this.sourceBlock_.style.colourTertiary),this.updateSliderHandles_(),this.updateDom_()},Blockly.FieldColourSlider.prototype.createColourStops_=function(e){for(var t=[],o=0;o<=360;o+=20)switch(e){case"hue":t.push(Blockly.utils.colour.hsvToHex(o,this.saturation_,this.brightness_));break;case"saturation":t.push(Blockly.utils.colour.hsvToHex(this.hue_,o/360,this.brightness_));break;case"brightness":t.push(Blockly.utils.colour.hsvToHex(this.hue_,this.saturation_,255*o/360));break;default:throw new Error("Unknown channel for colour sliders: "+e)}return t},Blockly.FieldColourSlider.prototype.setGradient_=function(e,t){var o=this.createColourStops_(t).join(",");goog.style.setStyle(e,"background","-moz-linear-gradient(left, "+o+")"),goog.style.setStyle(e,"background","-webkit-linear-gradient(left, "+o+")"),goog.style.setStyle(e,"background","-o-linear-gradient(left, "+o+")"),goog.style.setStyle(e,"background","-ms-linear-gradient(left, "+o+")"),goog.style.setStyle(e,"background","linear-gradient(left, "+o+")")},Blockly.FieldColourSlider.prototype.updateDom_=function(){this.hueSlider_&&(this.setGradient_(this.hueSlider_.getElement(),"hue"),this.setGradient_(this.saturationSlider_.getElement(),"saturation"),this.setGradient_(this.brightnessSlider_.getElement(),"brightness"),this.hueReadout_.textContent=Math.floor(100*this.hue_/360).toFixed(0),this.saturationReadout_.textContent=Math.floor(100*this.saturation_).toFixed(0),this.brightnessReadout_.textContent=Math.floor(100*this.brightness_/255).toFixed(0))},Blockly.FieldColourSlider.prototype.updateSliderHandles_=function(){this.hueSlider_&&(this.hueSlider_.setValue(this.hue_),this.saturationSlider_.setValue(this.saturation_),this.brightnessSlider_.setValue(this.brightness_))},Blockly.FieldColourSlider.prototype.getText=function(){var e=this.colour_,t=e.match(/^#(.)\1(.)\2(.)\3$/);return t&&(e="#"+t[1]+t[2]+t[3]),e},Blockly.FieldColourSlider.prototype.createLabelDom_=function(e){var t=document.createElement("div");t.setAttribute("class","blocklyColourPickerLabel");var o=document.createElement("span");o.setAttribute("class","blocklyColourPickerReadout");var l=document.createElement("span");return l.setAttribute("class","blocklyColourPickerLabelText"),l.textContent=e,t.appendChild(l),t.appendChild(o),[t,o]},Blockly.FieldColourSlider.prototype.sliderCallbackFactory_=function(e){var t=this;return function(o){var l=o.target.getValue(),i=Blockly.utils.colour.hexToHsv(t.getValue());switch(e){case"hue":i[0]=t.hue_=l;break;case"saturation":i[1]=t.saturation_=l;break;case"brightness":i[2]=t.brightness_=l}var r=Blockly.utils.colour.hsvToHex(i[0],i[1],i[2]);null!==r&&t.setValue(r,!0)}},Blockly.FieldColourSlider.prototype.showEditor_=function(){Blockly.DropDownDiv.hideWithoutAnimation(),Blockly.DropDownDiv.clearContent();var e=Blockly.DropDownDiv.getContentDiv(),t=Blockly.utils.colour.hexToHsv(this.getValue());this.hue_=t[0],this.saturation_=t[1],this.brightness_=t[2];var o=this.createLabelDom_("Hue");e.appendChild(o[0]),this.hueReadout_=o[1],this.hueSlider_=new goog.ui.Slider,this.hueSlider_.setUnitIncrement(5),this.hueSlider_.setMinimum(0),this.hueSlider_.setMaximum(360),this.hueSlider_.render(e);var l=this.createLabelDom_("Saturation");e.appendChild(l[0]),this.saturationReadout_=l[1],this.saturationSlider_=new goog.ui.Slider,this.saturationSlider_.setUnitIncrement(.01),this.saturationSlider_.setStep(.001),this.saturationSlider_.setMinimum(0),this.saturationSlider_.setMaximum(1),this.saturationSlider_.render(e);var i=this.createLabelDom_("Brightness");e.appendChild(i[0]),this.brightnessReadout_=i[1],this.brightnessSlider_=new goog.ui.Slider,this.brightnessSlider_.setUnitIncrement(2),this.brightnessSlider_.setMinimum(0),this.brightnessSlider_.setMaximum(255),this.brightnessSlider_.render(e),Blockly.FieldColourSlider.hueChangeEventKey_=goog.events.listen(this.hueSlider_,goog.ui.Component.EventType.CHANGE,this.sliderCallbackFactory_("hue")),Blockly.FieldColourSlider.saturationChangeEventKey_=goog.events.listen(this.saturationSlider_,goog.ui.Component.EventType.CHANGE,this.sliderCallbackFactory_("saturation")),Blockly.FieldColourSlider.brightnessChangeEventKey_=goog.events.listen(this.brightnessSlider_,goog.ui.Component.EventType.CHANGE,this.sliderCallbackFactory_("brightness")),Blockly.DropDownDiv.setColour("#ffffff","#dddddd"),Blockly.DropDownDiv.setCategory(this.sourceBlock_.parentBlock_.getCategory()),Blockly.DropDownDiv.showPositionedByBlock(this,this.sourceBlock_),this.setValue(this.getValue())},Blockly.FieldColourSlider.prototype.dispose=function(){Blockly.FieldColourSlider.hueChangeEventKey_&&goog.events.unlistenByKey(Blockly.FieldColourSlider.hueChangeEventKey_),Blockly.FieldColourSlider.saturationChangeEventKey_&&goog.events.unlistenByKey(Blockly.FieldColourSlider.saturationChangeEventKey_),Blockly.FieldColourSlider.brightnessChangeEventKey_&&goog.events.unlistenByKey(Blockly.FieldColourSlider.brightnessChangeEventKey_),Blockly.Events.setGroup(!1),Blockly.FieldColourSlider.superClass_.dispose.call(this)},Blockly.fieldRegistry.register("field_colour_slider",Blockly.FieldColourSlider);