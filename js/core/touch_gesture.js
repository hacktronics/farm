/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.TouchGesture"),goog.require("Blockly.browserEvents"),goog.require("Blockly.Gesture"),goog.require("Blockly.utils"),goog.require("Blockly.utils.Coordinate"),goog.require("Blockly.utils.object"),goog.requireType("Blockly.WorkspaceSvg"),Blockly.TouchGesture=function(t,o){Blockly.TouchGesture.superClass_.constructor.call(this,t,o),this.isMultiTouch_=!1,this.cachedPoints_=Object.create(null),this.previousScale_=0,this.startDistance_=0,this.onStartWrapper_=null,this.isPinchZoomEnabled_=null},Blockly.utils.object.inherits(Blockly.TouchGesture,Blockly.Gesture),Blockly.TouchGesture.ZOOM_IN_MULTIPLIER=5,Blockly.TouchGesture.ZOOM_OUT_MULTIPLIER=6,Blockly.TouchGesture.prototype.doStart=function(t){this.isPinchZoomEnabled_=this.startWorkspace_.options.zoomOptions&&this.startWorkspace_.options.zoomOptions.pinch,Blockly.TouchGesture.superClass_.doStart.call(this,t),!this.isEnding_&&Blockly.Touch.isTouchEvent(t)&&this.handleTouchStart(t)},Blockly.TouchGesture.prototype.bindMouseEvents=function(t){this.onStartWrapper_=Blockly.browserEvents.conditionalBind(document,"mousedown",null,this.handleStart.bind(this),!0),this.onMoveWrapper_=Blockly.browserEvents.conditionalBind(document,"mousemove",null,this.handleMove.bind(this),!0),this.onUpWrapper_=Blockly.browserEvents.conditionalBind(document,"mouseup",null,this.handleUp.bind(this),!0),t.preventDefault(),t.stopPropagation()},Blockly.TouchGesture.prototype.handleStart=function(t){this.isDragging()||Blockly.Touch.isTouchEvent(t)&&(this.handleTouchStart(t),this.isMultiTouch()&&Blockly.longStop_())},Blockly.TouchGesture.prototype.handleMove=function(t){this.isDragging()?Blockly.Touch.shouldHandleEvent(t)&&Blockly.TouchGesture.superClass_.handleMove.call(this,t):this.isMultiTouch()?(Blockly.Touch.isTouchEvent(t)&&this.handleTouchMove(t),Blockly.longStop_()):Blockly.TouchGesture.superClass_.handleMove.call(this,t)},Blockly.TouchGesture.prototype.handleUp=function(t){if(Blockly.Touch.isTouchEvent(t)&&!this.isDragging()&&this.handleTouchEnd(t),!this.isMultiTouch()||this.isDragging()){if(!Blockly.Touch.shouldHandleEvent(t))return;Blockly.TouchGesture.superClass_.handleUp.call(this,t)}else t.preventDefault(),t.stopPropagation(),this.dispose()},Blockly.TouchGesture.prototype.isMultiTouch=function(){return this.isMultiTouch_},Blockly.TouchGesture.prototype.dispose=function(){Blockly.TouchGesture.superClass_.dispose.call(this),this.onStartWrapper_&&Blockly.browserEvents.unbind(this.onStartWrapper_)},Blockly.TouchGesture.prototype.handleTouchStart=function(t){var o=Blockly.Touch.getTouchIdentifierFromEvent(t);this.cachedPoints_[o]=this.getTouchPoint(t);var e=Object.keys(this.cachedPoints_);if(2==e.length){var s=this.cachedPoints_[e[0]],c=this.cachedPoints_[e[1]];this.startDistance_=Blockly.utils.Coordinate.distance(s,c),this.isMultiTouch_=!0,t.preventDefault()}},Blockly.TouchGesture.prototype.handleTouchMove=function(t){var o=Blockly.Touch.getTouchIdentifierFromEvent(t);this.cachedPoints_[o]=this.getTouchPoint(t);var e=Object.keys(this.cachedPoints_);this.isPinchZoomEnabled_&&2===e.length?this.handlePinch_(t):Blockly.TouchGesture.superClass_.handleMove.call(this,t)},Blockly.TouchGesture.prototype.handlePinch_=function(t){var o=Object.keys(this.cachedPoints_),e=this.cachedPoints_[o[0]],s=this.cachedPoints_[o[1]],c=Blockly.utils.Coordinate.distance(e,s)/this.startDistance_;if(this.previousScale_>0&&this.previousScale_<1/0){var l=c-this.previousScale_,i=l>0?l*Blockly.TouchGesture.ZOOM_IN_MULTIPLIER:l*Blockly.TouchGesture.ZOOM_OUT_MULTIPLIER,h=this.startWorkspace_,n=Blockly.utils.mouseToSvg(t,h.getParentSvg(),h.getInverseScreenCTM());h.zoom(n.x,n.y,i)}this.previousScale_=c,t.preventDefault()},Blockly.TouchGesture.prototype.handleTouchEnd=function(t){var o=Blockly.Touch.getTouchIdentifierFromEvent(t);this.cachedPoints_[o]&&delete this.cachedPoints_[o],Object.keys(this.cachedPoints_).length<2&&(this.cachedPoints_=Object.create(null),this.previousScale_=0)},Blockly.TouchGesture.prototype.getTouchPoint=function(t){return this.startWorkspace_?new Blockly.utils.Coordinate(t.pageX?t.pageX:t.changedTouches[0].pageX,t.pageY?t.pageY:t.changedTouches[0].pageY):null};