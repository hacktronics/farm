/**
 * @license
 * Copyright 2011 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.Trashcan"),goog.require("Blockly.browserEvents"),goog.require("Blockly.ComponentManager"),goog.require("Blockly.constants"),goog.require("Blockly.DeleteArea"),goog.require("Blockly.Events"),goog.require("Blockly.Events.TrashcanOpen"),goog.require("Blockly.IAutoHideable"),goog.require("Blockly.IPositionable"),goog.require("Blockly.Options"),goog.require("Blockly.registry"),goog.require("Blockly.uiPosition"),goog.require("Blockly.utils"),goog.require("Blockly.utils.dom"),goog.require("Blockly.utils.Rect"),goog.require("Blockly.utils.Svg"),goog.require("Blockly.utils.toolbox"),goog.require("Blockly.Xml"),goog.requireType("Blockly.Events.Abstract"),goog.requireType("Blockly.IDraggable"),goog.requireType("Blockly.IFlyout"),goog.requireType("Blockly.utils.Rect"),goog.requireType("Blockly.WorkspaceSvg"),Blockly.Trashcan=function(t){if(Blockly.Trashcan.superClass_.constructor.call(this),this.workspace_=t,this.id="trashcan",this.contents_=[],this.flyout=null,!(this.workspace_.options.maxTrashcanContents<=0)){var o=new Blockly.Options({scrollbars:!0,parentWorkspace:this.workspace_,rtl:this.workspace_.RTL,oneBasedIndex:this.workspace_.options.oneBasedIndex,renderer:this.workspace_.options.renderer,rendererOverrides:this.workspace_.options.rendererOverrides,move:{scrollbars:!0}});if(this.workspace_.horizontalLayout){o.toolboxPosition=this.workspace_.toolboxPosition==Blockly.utils.toolbox.Position.TOP?Blockly.utils.toolbox.Position.BOTTOM:Blockly.utils.toolbox.Position.TOP;var i=Blockly.registry.getClassFromOptions(Blockly.registry.Type.FLYOUTS_HORIZONTAL_TOOLBOX,this.workspace_.options,!0);this.flyout=new i(o)}else{o.toolboxPosition=this.workspace_.toolboxPosition==Blockly.utils.toolbox.Position.RIGHT?Blockly.utils.toolbox.Position.LEFT:Blockly.utils.toolbox.Position.RIGHT;var e=Blockly.registry.getClassFromOptions(Blockly.registry.Type.FLYOUTS_VERTICAL_TOOLBOX,this.workspace_.options,!0);this.flyout=new e(o)}this.workspace_.addChangeListener(this.onDelete_.bind(this))}},Blockly.utils.object.inherits(Blockly.Trashcan,Blockly.DeleteArea),Blockly.Trashcan.prototype.WIDTH_=47,Blockly.Trashcan.prototype.BODY_HEIGHT_=44,Blockly.Trashcan.prototype.LID_HEIGHT_=16,Blockly.Trashcan.prototype.MARGIN_VERTICAL_=20,Blockly.Trashcan.prototype.MARGIN_HORIZONTAL_=20,Blockly.Trashcan.prototype.MARGIN_HOTSPOT_=10,Blockly.Trashcan.prototype.SPRITE_LEFT_=0,Blockly.Trashcan.prototype.SPRITE_TOP_=32,Blockly.Trashcan.prototype.HAS_BLOCKS_LID_ANGLE_=.1,Blockly.Trashcan.ANIMATION_LENGTH_=80,Blockly.Trashcan.ANIMATION_FRAMES_=4,Blockly.Trashcan.OPACITY_MIN_=.4,Blockly.Trashcan.OPACITY_MAX_=.8,Blockly.Trashcan.MAX_LID_ANGLE_=45,Blockly.Trashcan.prototype.isLidOpen=!1,Blockly.Trashcan.prototype.minOpenness_=0,Blockly.Trashcan.prototype.svgGroup_=null,Blockly.Trashcan.prototype.svgLid_=null,Blockly.Trashcan.prototype.lidTask_=0,Blockly.Trashcan.prototype.lidOpen_=0,Blockly.Trashcan.prototype.left_=0,Blockly.Trashcan.prototype.top_=0,Blockly.Trashcan.prototype.initialized_=!1,Blockly.Trashcan.prototype.createDom=function(){var t;this.svgGroup_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.G,{class:"blocklyTrash"},null);var o=String(Math.random()).substring(2);t=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.CLIPPATH,{id:"blocklyTrashBodyClipPath"+o},this.svgGroup_),Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.RECT,{width:this.WIDTH_,height:this.BODY_HEIGHT_,y:this.LID_HEIGHT_},t);var i=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.IMAGE,{width:Blockly.SPRITE.width,x:-this.SPRITE_LEFT_,height:Blockly.SPRITE.height,y:-this.SPRITE_TOP_,"clip-path":"url(#blocklyTrashBodyClipPath"+o+")"},this.svgGroup_);return i.setAttributeNS(Blockly.utils.dom.XLINK_NS,"xlink:href",this.workspace_.options.pathToMedia+Blockly.SPRITE.url),t=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.CLIPPATH,{id:"blocklyTrashLidClipPath"+o},this.svgGroup_),Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.RECT,{width:this.WIDTH_,height:this.LID_HEIGHT_},t),this.svgLid_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.IMAGE,{width:Blockly.SPRITE.width,x:-this.SPRITE_LEFT_,height:Blockly.SPRITE.height,y:-this.SPRITE_TOP_,"clip-path":"url(#blocklyTrashLidClipPath"+o+")"},this.svgGroup_),this.svgLid_.setAttributeNS(Blockly.utils.dom.XLINK_NS,"xlink:href",this.workspace_.options.pathToMedia+Blockly.SPRITE.url),Blockly.browserEvents.bind(this.svgGroup_,"mousedown",this,this.blockMouseDownWhenOpenable_),Blockly.browserEvents.bind(this.svgGroup_,"mouseup",this,this.click),Blockly.browserEvents.bind(i,"mouseover",this,this.mouseOver_),Blockly.browserEvents.bind(i,"mouseout",this,this.mouseOut_),this.animateLid_(),this.svgGroup_},Blockly.Trashcan.prototype.init=function(){this.workspace_.options.maxTrashcanContents>0&&(Blockly.utils.dom.insertAfter(this.flyout.createDom(Blockly.utils.Svg.SVG),this.workspace_.getParentSvg()),this.flyout.init(this.workspace_)),this.workspace_.getComponentManager().addComponent({component:this,weight:1,capabilities:[Blockly.ComponentManager.Capability.AUTOHIDEABLE,Blockly.ComponentManager.Capability.DELETE_AREA,Blockly.ComponentManager.Capability.DRAG_TARGET,Blockly.ComponentManager.Capability.POSITIONABLE]}),this.initialized_=!0,this.setLidOpen(!1)},Blockly.Trashcan.prototype.dispose=function(){this.workspace_.getComponentManager().removeComponent("trashcan"),this.svgGroup_&&(Blockly.utils.dom.removeNode(this.svgGroup_),this.svgGroup_=null),this.svgLid_=null,this.workspace_=null,clearTimeout(this.lidTask_)},Blockly.Trashcan.prototype.hasContents_=function(){return!!this.contents_.length},Blockly.Trashcan.prototype.contentsIsOpen=function(){return this.flyout.isVisible()},Blockly.Trashcan.prototype.openFlyout=function(){if(!this.contentsIsOpen()){var t=this.contents_.map(Blockly.Xml.textToDom);this.flyout.show(t),this.fireUiEvent_(!0)}},Blockly.Trashcan.prototype.closeFlyout=function(){this.contentsIsOpen()&&(this.flyout.hide(),this.fireUiEvent_(!1))},Blockly.Trashcan.prototype.autoHide=function(t){!t&&this.flyout&&this.closeFlyout()},Blockly.Trashcan.prototype.emptyContents=function(){this.hasContents_()&&(this.contents_.length=0,this.setMinOpenness_(0),this.closeFlyout())},Blockly.Trashcan.prototype.position=function(t,o){if(this.initialized_){var i=Blockly.uiPosition.getCornerOppositeToolbox(this.workspace_,t),e=this.BODY_HEIGHT_+this.LID_HEIGHT_,s=Blockly.uiPosition.getStartPositionRect(i,new Blockly.utils.Size(this.WIDTH_,e),this.MARGIN_HORIZONTAL_,this.MARGIN_VERTICAL_,t,this.workspace_),l=i.vertical===Blockly.uiPosition.verticalPosition.TOP?Blockly.uiPosition.bumpDirection.DOWN:Blockly.uiPosition.bumpDirection.UP,n=Blockly.uiPosition.bumpPositionRect(s,this.MARGIN_VERTICAL_,l,o);this.top_=n.top,this.left_=n.left,this.svgGroup_.setAttribute("transform","translate("+this.left_+","+this.top_+")")}},Blockly.Trashcan.prototype.getBoundingRectangle=function(){var t=this.top_+this.BODY_HEIGHT_+this.LID_HEIGHT_,o=this.left_+this.WIDTH_;return new Blockly.utils.Rect(this.top_,t,this.left_,o)},Blockly.Trashcan.prototype.getClientRect=function(){if(!this.svgGroup_)return null;var t=this.svgGroup_.getBoundingClientRect(),o=t.top+this.SPRITE_TOP_-this.MARGIN_HOTSPOT_,i=o+this.LID_HEIGHT_+this.BODY_HEIGHT_+2*this.MARGIN_HOTSPOT_,e=t.left+this.SPRITE_LEFT_-this.MARGIN_HOTSPOT_,s=e+this.WIDTH_+2*this.MARGIN_HOTSPOT_;return new Blockly.utils.Rect(o,i,e,s)},Blockly.Trashcan.prototype.onDragOver=function(t){this.setLidOpen(this.wouldDelete_)},Blockly.Trashcan.prototype.onDragExit=function(t){this.setLidOpen(!1)},Blockly.Trashcan.prototype.onDrop=function(t){setTimeout(this.setLidOpen.bind(this,!1),100)},Blockly.Trashcan.prototype.setLidOpen=function(t){this.isLidOpen!=t&&(clearTimeout(this.lidTask_),this.isLidOpen=t,this.animateLid_())},Blockly.Trashcan.prototype.animateLid_=function(){var t=Blockly.Trashcan.ANIMATION_FRAMES_,o=1/(t+1);this.lidOpen_+=this.isLidOpen?o:-o,this.lidOpen_=Math.min(Math.max(this.lidOpen_,this.minOpenness_),1),this.setLidAngle_(this.lidOpen_*Blockly.Trashcan.MAX_LID_ANGLE_);var i=Blockly.Trashcan.OPACITY_MIN_,e=Blockly.Trashcan.OPACITY_MAX_,s=i+this.lidOpen_*(e-i);this.svgGroup_.style.opacity=s,this.lidOpen_>this.minOpenness_&&this.lidOpen_<1&&(this.lidTask_=setTimeout(this.animateLid_.bind(this),Blockly.Trashcan.ANIMATION_LENGTH_/t))},Blockly.Trashcan.prototype.setLidAngle_=function(t){var o=this.workspace_.toolboxPosition==Blockly.utils.toolbox.Position.RIGHT||this.workspace_.horizontalLayout&&this.workspace_.RTL;this.svgLid_.setAttribute("transform","rotate("+(o?-t:t)+","+(o?4:this.WIDTH_-4)+","+(this.LID_HEIGHT_-2)+")")},Blockly.Trashcan.prototype.setMinOpenness_=function(t){this.minOpenness_=t,this.isLidOpen||this.setLidAngle_(t*Blockly.Trashcan.MAX_LID_ANGLE_)},Blockly.Trashcan.prototype.closeLid=function(){this.setLidOpen(!1)},Blockly.Trashcan.prototype.click=function(){this.hasContents_()&&this.openFlyout()},Blockly.Trashcan.prototype.fireUiEvent_=function(t){var o=new(Blockly.Events.get(Blockly.Events.TRASHCAN_OPEN))(t,this.workspace_.id);Blockly.Events.fire(o)},Blockly.Trashcan.prototype.blockMouseDownWhenOpenable_=function(t){!this.contentsIsOpen()&&this.hasContents_()&&t.stopPropagation()},Blockly.Trashcan.prototype.mouseOver_=function(){this.hasContents_()&&this.setLidOpen(!0)},Blockly.Trashcan.prototype.mouseOut_=function(){this.setLidOpen(!1)},Blockly.Trashcan.prototype.onDelete_=function(t){if(!(this.workspace_.options.maxTrashcanContents<=0)&&t.type==Blockly.Events.BLOCK_DELETE&&t.oldXml.tagName&&"shadow"!=t.oldXml.tagName.toLowerCase()){var o=this.cleanBlockXML_(t.oldXml);if(-1!=this.contents_.indexOf(o))return;for(this.contents_.unshift(o);this.contents_.length>this.workspace_.options.maxTrashcanContents;)this.contents_.pop();this.setMinOpenness_(this.HAS_BLOCKS_LID_ANGLE_)}},Blockly.Trashcan.prototype.cleanBlockXML_=function(t){for(var o=t.cloneNode(!0),i=o;i;){i.removeAttribute&&(i.removeAttribute("x"),i.removeAttribute("y"),i.removeAttribute("id"),i.removeAttribute("disabled"),"comment"==i.nodeName&&(i.removeAttribute("h"),i.removeAttribute("w"),i.removeAttribute("pinned")));var e=i.firstChild||i.nextSibling;if(!e)for(e=i.parentNode;e;){if(e.nextSibling){e=e.nextSibling;break}e=e.parentNode}i=e}return Blockly.Xml.domToText(o)};