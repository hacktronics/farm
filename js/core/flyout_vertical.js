/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.VerticalFlyout"),goog.require("Blockly.Block"),goog.require("Blockly.constants"),goog.require("Blockly.DropDownDiv"),goog.require("Blockly.Flyout"),goog.require("Blockly.registry"),goog.require("Blockly.Scrollbar"),goog.require("Blockly.utils"),goog.require("Blockly.utils.object"),goog.require("Blockly.utils.Rect"),goog.require("Blockly.utils.toolbox"),goog.require("Blockly.WidgetDiv"),goog.requireType("Blockly.Options"),goog.requireType("Blockly.utils.Coordinate"),Blockly.VerticalFlyout=function(t){Blockly.VerticalFlyout.superClass_.constructor.call(this,t)},Blockly.utils.object.inherits(Blockly.VerticalFlyout,Blockly.Flyout),Blockly.VerticalFlyout.registryName="verticalFlyout",Blockly.VerticalFlyout.prototype.setMetrics_=function(t){if(this.isVisible()){var o=this.workspace_.getMetricsManager(),i=o.getScrollMetrics(),e=o.getViewMetrics(),s=o.getAbsoluteMetrics();"number"==typeof t.y&&(this.workspace_.scrollY=-(i.top+(i.height-e.height)*t.y)),"number"==typeof t.x&&(this.workspace_.scrollX=-(i.left+(i.width-e.width)*t.x)),this.workspace_.translate(this.workspace_.scrollX+s.left,this.workspace_.scrollY+s.top)}},Blockly.VerticalFlyout.prototype.getX=function(){if(!this.isVisible())return 0;var t=this.targetWorkspace.getMetricsManager(),o=t.getAbsoluteMetrics(),i=t.getViewMetrics(),e=t.getToolboxMetrics();return this.targetWorkspace.toolboxPosition==this.toolboxPosition_?this.targetWorkspace.getToolbox()?this.toolboxPosition_==Blockly.utils.toolbox.Position.LEFT?e.width:i.width-this.width_:this.toolboxPosition_==Blockly.utils.toolbox.Position.LEFT?0:i.width:this.toolboxPosition_==Blockly.utils.toolbox.Position.LEFT?0:i.width+o.left-this.width_},Blockly.VerticalFlyout.prototype.getY=function(){return 0},Blockly.VerticalFlyout.prototype.position=function(){if(this.isVisible()&&this.targetWorkspace.isVisible()){var t=this.targetWorkspace.getMetricsManager().getViewMetrics();this.height_=t.height;var o=this.width_-this.CORNER_RADIUS,i=t.height-2*this.CORNER_RADIUS;this.setBackgroundPath_(o,i);var e=this.getX(),s=this.getY();this.positionAt_(this.width_,this.height_,e,s)}},Blockly.VerticalFlyout.prototype.setBackgroundPath_=function(t,o){var i=this.toolboxPosition_==Blockly.utils.toolbox.Position.RIGHT,e=t+this.CORNER_RADIUS,s=["M "+(i?e:0)+",0"];s.push("h",i?-t:t),s.push("a",this.CORNER_RADIUS,this.CORNER_RADIUS,0,0,i?0:1,i?-this.CORNER_RADIUS:this.CORNER_RADIUS,this.CORNER_RADIUS),s.push("v",Math.max(0,o)),s.push("a",this.CORNER_RADIUS,this.CORNER_RADIUS,0,0,i?0:1,i?this.CORNER_RADIUS:-this.CORNER_RADIUS,this.CORNER_RADIUS),s.push("h",i?t:-t),s.push("z"),this.svgBackground_.setAttribute("d",s.join(" "))},Blockly.VerticalFlyout.prototype.scrollToStart=function(){this.workspace_.scrollbar.setY(0),this.workspace_.scrollbar.setX(0)},Blockly.VerticalFlyout.prototype.wheel_=function(t){var o=Blockly.utils.getScrollDeltaPixels(t);if(o.y){var i=this.workspace_.getMetricsManager(),e=i.getScrollMetrics(),s=i.getViewMetrics(),l=s.top-e.top+o.y;if(this.workspace_.scrollbar.setY(l),o.x){var r=s.left-e.left+o.x;this.workspace_.scrollbar.setX(r)}Blockly.WidgetDiv.hide(),Blockly.DropDownDiv.hideWithoutAnimation()}t.preventDefault(),t.stopPropagation()},Blockly.VerticalFlyout.prototype.layout_=function(t,o){this.workspace_.scale=this.targetWorkspace.scale;for(var i,e=this.MARGIN,s=this.RTL?e:e+this.tabWidth_,l=e,r=0;i=t[r];r++)if("block"==i.type){for(var c,h=i.block,a=h.getDescendants(!1),u=0;c=a[u];u++)c.isInFlyout=!0;h.render();var n=h.getSvgRoot(),g=h.getHeightWidth(),y=h.outputConnection?s-this.tabWidth_:s;h.moveBy(y,l);var k=this.createRect_(h,this.RTL?y-g.width:y,l,g,r);this.addBlockListeners_(n,h,k),l+=g.height+o[r]}else"button"==i.type&&(this.initFlyoutButton_(i.button,s,l),l+=i.button.height+o[r])},Blockly.VerticalFlyout.prototype.isDragTowardWorkspace=function(t){var o=t.x,i=t.y,e=Math.atan2(i,o)/Math.PI*180,s=this.dragAngleRange_;return e<s&&e>-s||e<-180+s||e>180-s},Blockly.VerticalFlyout.prototype.getClientRect=function(){if(!this.svgGroup_||this.autoClose||!this.isVisible())return null;var t=this.svgGroup_.getBoundingClientRect(),o=1e9,i=t.left;if(this.toolboxPosition_==Blockly.utils.toolbox.Position.LEFT){var e=t.width;return new Blockly.utils.Rect(-o,o,-o,i+e)}return new Blockly.utils.Rect(-o,o,i,o)},Blockly.VerticalFlyout.prototype.reflowInternal_=function(){this.workspace_.scale=this.getFlyoutScale();for(var t=0,o=this.workspace_.getTopBlocks(!1),i=0;s=o[i];i++){var e=s.getHeightWidth().width;s.outputConnection&&(e-=this.tabWidth_),t=Math.max(t,e)}for(i=0;c=this.buttons_[i];i++)t=Math.max(t,c.width);if(t+=1.5*this.MARGIN+this.tabWidth_,t*=this.workspace_.scale,t+=Blockly.Scrollbar.scrollbarThickness,this.width_!=t){var s;for(i=0;s=o[i];i++){if(this.RTL){var l=s.getRelativeToSurfaceXY().x,r=t/this.workspace_.scale-this.MARGIN;s.outputConnection||(r-=this.tabWidth_),s.moveBy(r-l,0)}s.flyoutRect_&&this.moveRectToBlock_(s.flyoutRect_,s)}if(this.RTL){var c;for(i=0;c=this.buttons_[i];i++){var h=c.getPosition().y,a=t/this.workspace_.scale-c.width-this.MARGIN-this.tabWidth_;c.moveTo(a,h)}}this.targetWorkspace.toolboxPosition!=this.toolboxPosition_||this.toolboxPosition_!=Blockly.utils.toolbox.Position.LEFT||this.targetWorkspace.getToolbox()||this.targetWorkspace.translate(this.targetWorkspace.scrollX+t,this.targetWorkspace.scrollY),this.width_=t,this.position(),this.targetWorkspace.recordDragTargets()}},Blockly.registry.register(Blockly.registry.Type.FLYOUTS_VERTICAL_TOOLBOX,Blockly.registry.DEFAULT,Blockly.VerticalFlyout);