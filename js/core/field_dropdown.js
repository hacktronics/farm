/**
 * @license
 * Copyright 2012 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.FieldDropdown"),goog.require("Blockly.DropDownDiv"),goog.require("Blockly.Events"),goog.require("Blockly.Field"),goog.require("Blockly.fieldRegistry"),goog.require("Blockly.Menu"),goog.require("Blockly.MenuItem"),goog.require("Blockly.MenuSeparator"),goog.require("Blockly.utils"),goog.require("Blockly.utils.aria"),goog.require("Blockly.utils.Coordinate"),goog.require("Blockly.utils.dom"),goog.require("Blockly.utils.object"),goog.require("Blockly.utils.string"),goog.require("Blockly.utils.Svg"),goog.require("Blockly.utils.userAgent"),Blockly.FieldDropdown=function(t,e,o){"function"!=typeof t&&Blockly.FieldDropdown.validateOptions_(t),this.menuGenerator_=t,this.generatedOptions_=null,this.prefixField=null,this.suffixField=null,this.trimOptions_(),this.selectedOption_=this.getOptions(!1)[0],Blockly.FieldDropdown.superClass_.constructor.call(this,this.selectedOption_[1],e,o),this.selectedMenuItem_=null,this.menu_=null,this.imageElement_=null,this.arrow_=null,this.svgArrow_=null,this.addArgType("dropdown")},Blockly.utils.object.inherits(Blockly.FieldDropdown,Blockly.Field),Blockly.FieldDropdown.ImageProperties,Blockly.FieldDropdown.fromJson=function(t){return new Blockly.FieldDropdown(t.options,void 0,t)},Blockly.FieldDropdown.prototype.EDITABLE=!1,Blockly.FieldDropdown.prototype.fromXml=function(t){this.isOptionListDynamic()&&this.getOptions(!1),this.setValue(t.textContent)},Blockly.FieldDropdown.prototype.SERIALIZABLE=!0,Blockly.FieldDropdown.CHECKMARK_OVERHANG=25,Blockly.FieldDropdown.MAX_MENU_HEIGHT_VH=.45,Blockly.FieldDropdown.IMAGE_Y_OFFSET=5,Blockly.FieldDropdown.IMAGE_Y_PADDING=2*Blockly.FieldDropdown.IMAGE_Y_OFFSET,Blockly.FieldDropdown.ARROW_CHAR=Blockly.utils.userAgent.ANDROID?"▼":"▾",Blockly.FieldDropdown.prototype.CURSOR="pointer",Blockly.FieldDropdown.prototype.initView=function(){this.shouldAddBorderRect_()?this.createBorderRect_():this.clickTarget_=this.sourceBlock_.getSvgRoot(),this.createTextElement_(),this.imageElement_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.IMAGE,{},this.fieldGroup_),this.getConstants().FIELD_DROPDOWN_SVG_ARROW?this.createSVGArrow_():this.createTextArrow_(),this.borderRect_&&Blockly.utils.dom.addClass(this.borderRect_,"blocklyDropdownRect")},Blockly.FieldDropdown.prototype.shouldAddBorderRect_=function(){return!this.getConstants().FIELD_DROPDOWN_NO_BORDER_RECT_SHADOW||this.getConstants().FIELD_DROPDOWN_NO_BORDER_RECT_SHADOW&&!this.sourceBlock_.isShadow()},Blockly.FieldDropdown.prototype.createTextArrow_=function(){this.arrow_=Blockly.utils.dom.createSvgElement(Blockly.utils.Svg.TSPAN,{},this.textElement_),this.arrow_.appendChild(document.createTextNode(this.sourceBlock_.RTL?Blockly.FieldDropdown.ARROW_CHAR+" ":" "+Blockly.FieldDropdown.ARROW_CHAR)),this.sourceBlock_.RTL?this.textElement_.insertBefore(this.arrow_,this.textContent_):this.textElement_.appendChild(this.arrow_)},Blockly.FieldDropdown.prototype.createSVGArrow_=function(){var t=Blockly.utils.userAgent.IE||Blockly.utils.userAgent.IOS,e=t?"image":"use",o=t?this.getConstants().FIELD_DROPDOWN_SVG_ARROW_DATAURI:"#"+(this.getConstants().dropdownArrowImageId||"blocklyDropdownArrowSvg");this.svgArrow_=Blockly.utils.dom.createSvgElement(e,{height:this.getConstants().FIELD_DROPDOWN_SVG_ARROW_SIZE+"px",width:this.getConstants().FIELD_DROPDOWN_SVG_ARROW_SIZE+"px"},this.fieldGroup_),this.svgArrow_.setAttributeNS(Blockly.utils.dom.XLINK_NS,"xlink:href",o)},Blockly.FieldDropdown.prototype.showEditor_=function(t){this.dropdownCreate_(),t&&"number"==typeof t.clientX?this.menu_.openingCoords=new Blockly.utils.Coordinate(t.clientX,t.clientY):this.menu_.openingCoords=null,this.menu_.render(Blockly.DropDownDiv.getContentDiv());var e=this.menu_.getElement();if(Blockly.utils.dom.addClass(e,"blocklyDropdownMenu"),this.getConstants().FIELD_DROPDOWN_COLOURED_DIV){var o=this.sourceBlock_.isShadow()?this.sourceBlock_.getParent().getColour():this.sourceBlock_.getColour(),i=this.sourceBlock_.isShadow()?this.sourceBlock_.getParent().style.colourTertiary:this.sourceBlock_.style.colourTertiary;Blockly.DropDownDiv.setColour(o,i)}Blockly.DropDownDiv.showPositionedByField(this,this.dropdownDispose_.bind(this)),this.menu_.focus(),this.selectedMenuItem_&&this.menu_.setHighlighted(this.selectedMenuItem_),this.applyColour()},Blockly.FieldDropdown.prototype.dropdownCreate_=function(){var t=new Blockly.Menu;t.setRole(Blockly.utils.aria.Role.LISTBOX),this.menu_=t;var e=this.getOptions(!1);this.selectedMenuItem_=null;for(var o=0;o<e.length;o++){var i=e[o][0],l=e[o][1];if("SEPARATOR"===l){(s=new Blockly.MenuSeparator).setRightToLeft(this.sourceBlock_.RTL),s.setColour(this.sourceBlock_.style.colourTertiary),t.addChild(s)}else{if("object"==typeof i){var r=new Image(i.width,i.height);r.src=i.src,r.alt=i.alt||"",i=r}var s;(s=new Blockly.MenuItem(i,l)).setRole(Blockly.utils.aria.Role.OPTION),s.setRightToLeft(this.sourceBlock_.RTL),s.setCheckable(!0),t.addChild(s),s.setChecked(l==this.value_),l==this.value_&&(this.selectedMenuItem_=s),s.onAction(this.handleMenuActionEvent_,this)}}},Blockly.FieldDropdown.prototype.dropdownDispose_=function(){this.menu_&&this.menu_.dispose(),this.menu_=null,this.selectedMenuItem_=null,this.applyColour()},Blockly.FieldDropdown.prototype.handleMenuActionEvent_=function(t){Blockly.DropDownDiv.hideIfOwner(this,!0),this.onItemSelected_(this.menu_,t)},Blockly.FieldDropdown.prototype.onItemSelected_=function(t,e){var o=e.getValue();null!==o&&(this.setValue(o),this.sourceBlock_.workspace&&Blockly.Events.fire(new Blockly.Events.Ui(this.sourceBlock_,"itemSelected",void 0,o)))},Blockly.FieldDropdown.prototype.trimOptions_=function(){var t=this.menuGenerator_;if(Array.isArray(t)){for(var e=!1,o=0;o<t.length;o++){var i=t[o][0];"string"==typeof i?t[o][0]=Blockly.utils.replaceMessageReferences(i):(null!=i.alt&&(t[o][0].alt=Blockly.utils.replaceMessageReferences(i.alt)),e=!0)}if(!(e||t.length<2)){var l=[];for(o=0;o<t.length;o++)l.push(t[o][0]);var r=Blockly.utils.string.shortestStringLength(l),s=Blockly.utils.string.commonWordPrefix(l,r),n=Blockly.utils.string.commonWordSuffix(l,r);(s||n)&&(r<=s+n||(s&&(this.prefixField=l[0].substring(0,s-1)),n&&(this.suffixField=l[0].substr(1-n)),this.menuGenerator_=Blockly.FieldDropdown.applyTrim_(t,s,n)))}}},Blockly.FieldDropdown.applyTrim_=function(t,e,o){for(var i=[],l=0;l<t.length;l++){var r=t[l][0],s=t[l][1];r=r.substring(e,r.length-o),i[l]=[r,s]}return i},Blockly.FieldDropdown.prototype.isOptionListDynamic=function(){return"function"==typeof this.menuGenerator_},Blockly.FieldDropdown.prototype.getOptions=function(t){return this.isOptionListDynamic()?(this.generatedOptions_&&t||(this.generatedOptions_=this.menuGenerator_.call(this),Blockly.FieldDropdown.validateOptions_(this.generatedOptions_)),this.generatedOptions_):this.menuGenerator_},Blockly.FieldDropdown.prototype.doClassValidation_=function(t){for(var e,o=!1,i=this.getOptions(!0),l=0;e=i[l];l++)if(e[1]==t){o=!0;break}return o||this.sourceBlock_&&console.warn("Cannot set the dropdown's value to an unavailable option. Block type: "+this.sourceBlock_.type+", Field name: "+this.name+", Value: "+t),t},Blockly.FieldDropdown.prototype.doValueUpdate_=function(t){Blockly.FieldDropdown.superClass_.doValueUpdate_.call(this,t);for(var e,o=this.getOptions(!0),i=0;e=o[i];i++)e[1]==this.value_&&(this.selectedOption_=e)},Blockly.FieldDropdown.prototype.applyColour=function(){this.borderRect_&&(this.borderRect_.setAttribute("stroke",this.sourceBlock_.style.colourTertiary),this.menu_?this.borderRect_.setAttribute("fill",this.sourceBlock_.style.colourTertiary):this.borderRect_.setAttribute("fill","transparent")),this.sourceBlock_&&this.arrow_&&(this.sourceBlock_.isShadow()?this.arrow_.style.fill=this.sourceBlock_.style.colourSecondary:this.arrow_.style.fill=this.sourceBlock_.style.colourPrimary)},Blockly.FieldDropdown.prototype.render_=function(){this.textContent_.nodeValue="",this.imageElement_.style.display="none";var t=this.selectedOption_&&this.selectedOption_[0];t&&"object"==typeof t?this.renderSelectedImage_(t):this.renderSelectedText_(),this.positionBorderRect_()},Blockly.FieldDropdown.prototype.renderSelectedImage_=function(t){this.imageElement_.style.display="",this.imageElement_.setAttributeNS(Blockly.utils.dom.XLINK_NS,"xlink:href",t.src),this.imageElement_.setAttribute("height",t.height),this.imageElement_.setAttribute("width",t.width);var e=Number(t.height),o=Number(t.width),i=!!this.borderRect_,l=Math.max(i?this.getConstants().FIELD_DROPDOWN_BORDER_RECT_HEIGHT:0,e+Blockly.FieldDropdown.IMAGE_Y_PADDING),r=i?this.getConstants().FIELD_BORDER_RECT_X_PADDING:0,s=0;s=this.svgArrow_?this.positionSVGArrow_(o+r,l/2-this.getConstants().FIELD_DROPDOWN_SVG_ARROW_SIZE/2):Blockly.utils.dom.getFastTextWidth(this.arrow_,this.getConstants().FIELD_TEXT_FONTSIZE,this.getConstants().FIELD_TEXT_FONTWEIGHT,this.getConstants().FIELD_TEXT_FONTFAMILY),this.size_.width=o+s+2*r,this.size_.height=l;var n=0;if(this.sourceBlock_.RTL){var c=r+s;this.imageElement_.setAttribute("x",c)}else n=o+s,this.textElement_.setAttribute("text-anchor","end"),this.imageElement_.setAttribute("x",r);this.imageElement_.setAttribute("y",l/2-e/2),this.positionTextElement_(n+r,o+s)},Blockly.FieldDropdown.prototype.renderSelectedText_=function(){this.textContent_.nodeValue=this.getDisplayText_(),Blockly.utils.dom.addClass(this.textElement_,"blocklyDropdownText"),this.textElement_.setAttribute("text-anchor","start");var t=!!this.borderRect_,e=Math.max(t?this.getConstants().FIELD_DROPDOWN_BORDER_RECT_HEIGHT:0,this.getConstants().FIELD_TEXT_HEIGHT),o=Blockly.utils.dom.getFastTextWidth(this.textElement_,this.getConstants().FIELD_TEXT_FONTSIZE,this.getConstants().FIELD_TEXT_FONTWEIGHT,this.getConstants().FIELD_TEXT_FONTFAMILY),i=t?this.getConstants().FIELD_BORDER_RECT_X_PADDING:0,l=0;this.svgArrow_&&(l=this.positionSVGArrow_(o+i,e/2-this.getConstants().FIELD_DROPDOWN_SVG_ARROW_SIZE/2)),this.size_.width=o+l+2*i,this.size_.height=e,this.positionTextElement_(i,o)},Blockly.FieldDropdown.prototype.positionSVGArrow_=function(t,e){if(!this.svgArrow_)return 0;var o=!!this.borderRect_?this.getConstants().FIELD_BORDER_RECT_X_PADDING:0,i=this.getConstants().FIELD_DROPDOWN_SVG_ARROW_PADDING,l=this.getConstants().FIELD_DROPDOWN_SVG_ARROW_SIZE,r=this.sourceBlock_.RTL?o:t+i;return this.svgArrow_.setAttribute("transform","translate("+r+","+e+")"),l+i},Blockly.FieldDropdown.prototype.getText_=function(){if(!this.selectedOption_)return null;var t=this.selectedOption_[0];return"object"==typeof t?t.alt:t},Blockly.FieldDropdown.validateOptions_=function(t){if(!Array.isArray(t))throw TypeError("FieldDropdown options must be an array.");if(!t.length)throw TypeError("FieldDropdown options must not be an empty array.");for(var e=!1,o=0;o<t.length;++o){var i=t[o];Array.isArray(i)?"string"!=typeof i[1]?(e=!0,console.error("Invalid option["+o+"]: Each FieldDropdown option id must be a string. Found "+i[1]+" in: ",i)):i[0]&&"string"!=typeof i[0]&&"string"!=typeof i[0].src&&(e=!0,console.error("Invalid option["+o+"]: Each FieldDropdown option must have a string label or image description. Found"+i[0]+" in: ",i)):(e=!0,console.error("Invalid option["+o+"]: Each FieldDropdown option must be an array. Found: ",i))}if(e)throw TypeError("Found invalid FieldDropdown options.")},Blockly.fieldRegistry.register("field_dropdown",Blockly.FieldDropdown);