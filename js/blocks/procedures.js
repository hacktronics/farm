/**
 * @license
 * Copyright 2012 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.Blocks.procedures"),goog.require("Blockly"),goog.require("Blockly.Blocks"),goog.require("Blockly.Comment"),goog.require("Blockly.FieldCheckbox"),goog.require("Blockly.FieldLabel"),goog.require("Blockly.FieldTextInput"),goog.require("Blockly.Mutator"),goog.require("Blockly.Warning"),Blockly.Blocks.procedures_defnoreturn={init:function(){var e=Blockly.Procedures.findLegalName("",this),t=new Blockly.FieldTextInput(e,Blockly.Procedures.rename);t.setSpellcheck(!1),this.appendDummyInput().appendField(Blockly.Msg.PROCEDURES_DEFNORETURN_TITLE).appendField(t,"NAME").appendField("","PARAMS"),this.setMutator(new Blockly.Mutator(["procedures_mutatorarg"])),(this.workspace.options.comments||this.workspace.options.parentWorkspace&&this.workspace.options.parentWorkspace.options.comments)&&Blockly.Msg.PROCEDURES_DEFNORETURN_COMMENT&&this.setCommentText(Blockly.Msg.PROCEDURES_DEFNORETURN_COMMENT),this.setStyle("procedure_blocks"),this.setTooltip(Blockly.Msg.PROCEDURES_DEFNORETURN_TOOLTIP),this.setHelpUrl(Blockly.Msg.PROCEDURES_DEFNORETURN_HELPURL),this.arguments_=[],this.argumentVarModels_=[],this.setStatements_(!0),this.statementConnection_=null},setStatements_:function(e){this.hasStatements_!==e&&(e?(this.appendStatementInput("STACK").appendField(Blockly.Msg.PROCEDURES_DEFNORETURN_DO),this.getInput("RETURN")&&this.moveInputBefore("STACK","RETURN")):this.removeInput("STACK",!0),this.hasStatements_=e)},updateParams_:function(){var e="";this.arguments_.length&&(e=Blockly.Msg.PROCEDURES_BEFORE_PARAMS+" "+this.arguments_.join(", ")),Blockly.Events.disable();try{this.setFieldValue(e,"PARAMS")}finally{Blockly.Events.enable()}},mutationToDom:function(e){var t=Blockly.utils.xml.createElement("mutation");e&&t.setAttribute("name",this.getFieldValue("NAME"));for(var s=0;s<this.argumentVarModels_.length;s++){var r=Blockly.utils.xml.createElement("arg"),l=this.argumentVarModels_[s];r.setAttribute("name",l.name),r.setAttribute("varid",l.getId()),e&&this.paramIds_&&r.setAttribute("paramId",this.paramIds_[s]),t.appendChild(r)}return this.hasStatements_||t.setAttribute("statements","false"),t},domToMutation:function(e){this.arguments_=[],this.argumentVarModels_=[];for(var t,s=0;t=e.childNodes[s];s++)if("arg"==t.nodeName.toLowerCase()){var r=t.getAttribute("name"),l=t.getAttribute("varid")||t.getAttribute("varId");this.arguments_.push(r);var o=Blockly.Variables.getOrCreateVariablePackage(this.workspace,l,r,"");null!=o?this.argumentVarModels_.push(o):console.log("Failed to create a variable with name "+r+", ignoring.")}this.updateParams_(),Blockly.Procedures.mutateCallers(this),this.setStatements_("false"!==e.getAttribute("statements"))},decompose:function(e){var t=Blockly.utils.xml.createElement("block");t.setAttribute("type","procedures_mutatorcontainer");var s=Blockly.utils.xml.createElement("statement");s.setAttribute("name","STACK"),t.appendChild(s);for(var r=s,l=0;l<this.arguments_.length;l++){var o=Blockly.utils.xml.createElement("block");o.setAttribute("type","procedures_mutatorarg");var a=Blockly.utils.xml.createElement("field");a.setAttribute("name","NAME");var n=Blockly.utils.xml.createTextNode(this.arguments_[l]);a.appendChild(n),o.appendChild(a);var i=Blockly.utils.xml.createElement("next");o.appendChild(i),r.appendChild(o),r=i}var u=Blockly.Xml.domToBlock(t,e);return"procedures_defreturn"==this.type?u.setFieldValue(this.hasStatements_,"STATEMENTS"):u.removeInput("STATEMENT_INPUT"),Blockly.Procedures.mutateCallers(this),u},compose:function(e){this.arguments_=[],this.paramIds_=[],this.argumentVarModels_=[];for(var t=e.getInputTargetBlock("STACK");t&&!t.isInsertionMarker();){var s=t.getFieldValue("NAME");this.arguments_.push(s);var r=this.workspace.getVariable(s,"");this.argumentVarModels_.push(r),this.paramIds_.push(t.id),t=t.nextConnection&&t.nextConnection.targetBlock()}this.updateParams_(),Blockly.Procedures.mutateCallers(this);var l=e.getFieldValue("STATEMENTS");if(null!==l&&(l="TRUE"==l,this.hasStatements_!=l))if(l)this.setStatements_(!0),Blockly.Mutator.reconnect(this.statementConnection_,this,"STACK"),this.statementConnection_=null;else{var o=this.getInput("STACK").connection;if(this.statementConnection_=o.targetConnection,this.statementConnection_){var a=o.targetBlock();a.unplug(),a.bumpNeighbours()}this.setStatements_(!1)}},getProcedureDef:function(){return[this.getFieldValue("NAME"),this.arguments_,!1]},getVars:function(){return this.arguments_},getVarModels:function(){return this.argumentVarModels_},renameVarById:function(e,t){var s=this.workspace.getVariableById(e);if(""==s.type){for(var r=s.name,l=this.workspace.getVariableById(t),o=!1,a=0;a<this.argumentVarModels_.length;a++)this.argumentVarModels_[a].getId()==e&&(this.arguments_[a]=l.name,this.argumentVarModels_[a]=l,o=!0);o&&(this.displayRenamedVar_(r,l.name),Blockly.Procedures.mutateCallers(this))}},updateVarName:function(e){for(var t=e.name,s=!1,r=0;r<this.argumentVarModels_.length;r++)if(this.argumentVarModels_[r].getId()==e.getId()){var l=this.arguments_[r];this.arguments_[r]=t,s=!0}s&&(this.displayRenamedVar_(l,t),Blockly.Procedures.mutateCallers(this))},displayRenamedVar_:function(e,t){if(this.updateParams_(),this.mutator&&this.mutator.isVisible())for(var s,r=this.mutator.workspace_.getAllBlocks(!1),l=0;s=r[l];l++)"procedures_mutatorarg"==s.type&&Blockly.Names.equals(e,s.getFieldValue("NAME"))&&s.setFieldValue(t,"NAME")},customContextMenu:function(e){if(!this.isInFlyout){var t={enabled:!this.options.debugMode},s=this.getFieldValue("NAME");t.text=Blockly.Msg.PROCEDURES_CREATE_DO.replace("%1",s);var r=Blockly.utils.xml.createElement("mutation");r.setAttribute("name",s);for(var l=0;l<this.arguments_.length;l++){var o=Blockly.utils.xml.createElement("arg");o.setAttribute("name",this.arguments_[l]),r.appendChild(o)}var a=Blockly.utils.xml.createElement("block");if(a.setAttribute("type",this.callType_),a.appendChild(r),t.callback=Blockly.ContextMenu.callbackFactory(this,a),e.push(t),!this.isCollapsed())for(l=0;l<this.argumentVarModels_.length;l++){var n={enabled:!this.inDebugWorkspace()},i=this.argumentVarModels_[l];n.text=Blockly.Msg.VARIABLES_SET_CREATE_GET.replace("%1",i.name);var u=Blockly.Variables.generateVariableFieldDom(i),c=Blockly.utils.xml.createElement("block");c.setAttribute("type","variables_get"),c.appendChild(u),n.callback=Blockly.ContextMenu.callbackFactory(this,c),e.push(n)}}},callType_:"procedures_callnoreturn"},Blockly.Blocks.procedures_defreturn={init:function(){var e=Blockly.Procedures.findLegalName("",this),t=new Blockly.FieldTextInput(e,Blockly.Procedures.rename);t.setSpellcheck(!1),this.appendDummyInput().appendField(Blockly.Msg.PROCEDURES_DEFRETURN_TITLE).appendField(t,"NAME").appendField("","PARAMS"),this.appendValueInput("RETURN").setAlign(Blockly.ALIGN_RIGHT).appendField(Blockly.Msg.PROCEDURES_DEFRETURN_RETURN),this.setMutator(new Blockly.Mutator(["procedures_mutatorarg"])),(this.workspace.options.comments||this.workspace.options.parentWorkspace&&this.workspace.options.parentWorkspace.options.comments)&&Blockly.Msg.PROCEDURES_DEFRETURN_COMMENT&&this.setCommentText(Blockly.Msg.PROCEDURES_DEFRETURN_COMMENT),this.setStyle("procedure_blocks"),this.setTooltip(Blockly.Msg.PROCEDURES_DEFRETURN_TOOLTIP),this.setHelpUrl(Blockly.Msg.PROCEDURES_DEFRETURN_HELPURL),this.arguments_=[],this.argumentVarModels_=[],this.setStatements_(!0),this.statementConnection_=null},setStatements_:Blockly.Blocks.procedures_defnoreturn.setStatements_,updateParams_:Blockly.Blocks.procedures_defnoreturn.updateParams_,mutationToDom:Blockly.Blocks.procedures_defnoreturn.mutationToDom,domToMutation:Blockly.Blocks.procedures_defnoreturn.domToMutation,decompose:Blockly.Blocks.procedures_defnoreturn.decompose,compose:Blockly.Blocks.procedures_defnoreturn.compose,getProcedureDef:function(){return[this.getFieldValue("NAME"),this.arguments_,!0]},getVars:Blockly.Blocks.procedures_defnoreturn.getVars,getVarModels:Blockly.Blocks.procedures_defnoreturn.getVarModels,renameVarById:Blockly.Blocks.procedures_defnoreturn.renameVarById,updateVarName:Blockly.Blocks.procedures_defnoreturn.updateVarName,displayRenamedVar_:Blockly.Blocks.procedures_defnoreturn.displayRenamedVar_,customContextMenu:Blockly.Blocks.procedures_defnoreturn.customContextMenu,callType_:"procedures_callreturn"},Blockly.Blocks.procedures_mutatorcontainer={init:function(){this.appendDummyInput().appendField(Blockly.Msg.PROCEDURES_MUTATORCONTAINER_TITLE),this.appendStatementInput("STACK"),this.appendDummyInput("STATEMENT_INPUT").appendField(Blockly.Msg.PROCEDURES_ALLOW_STATEMENTS).appendField(new Blockly.FieldCheckbox("TRUE"),"STATEMENTS"),this.setStyle("procedure_blocks"),this.setTooltip(Blockly.Msg.PROCEDURES_MUTATORCONTAINER_TOOLTIP),this.contextMenu=!1}},Blockly.Blocks.procedures_mutatorarg={init:function(){var e=new Blockly.FieldTextInput(Blockly.Procedures.DEFAULT_ARG,this.validator_);e.oldShowEditorFn_=e.showEditor_;e.showEditor_=function(){this.createdVariables_=[],this.oldShowEditorFn_()},this.appendDummyInput().appendField(Blockly.Msg.PROCEDURES_MUTATORARG_TITLE).appendField(e,"NAME"),this.setPreviousStatement(!0),this.setNextStatement(!0),this.setStyle("procedure_blocks"),this.setTooltip(Blockly.Msg.PROCEDURES_MUTATORARG_TOOLTIP),this.contextMenu=!1,e.onFinishEditing_=this.deleteIntermediateVars_,e.createdVariables_=[],e.onFinishEditing_("x")},validator_:function(e){var t=this.getSourceBlock(),s=Blockly.Mutator.findParentWs(t.workspace);if(!(e=e.replace(/[\s\xa0]+/g," ").replace(/^ | $/g,"")))return null;for(var r=(t.workspace.targetWorkspace||t.workspace).getAllBlocks(!1),l=e.toLowerCase(),o=0;o<r.length;o++)if(r[o].id!=this.getSourceBlock().id){var a=r[o].getFieldValue("NAME");if(a&&a.toLowerCase()==l)return null}if(t.isInFlyout)return e;var n=s.getVariable(e,"");return n&&n.name!=e&&s.renameVariableById(n.getId(),e),n||(n=s.createVariable(e,""))&&this.createdVariables_&&this.createdVariables_.push(n),e},deleteIntermediateVars_:function(e){var t=Blockly.Mutator.findParentWs(this.getSourceBlock().workspace);if(t)for(var s=0;s<this.createdVariables_.length;s++){var r=this.createdVariables_[s];r.name!=e&&t.deleteVariableById(r.getId())}}},Blockly.Blocks.procedures_callnoreturn={init:function(){this.appendDummyInput("TOPROW").appendField("","NAME"),this.setPreviousStatement(!0),this.setNextStatement(!0),this.setStyle("procedure_blocks"),this.setHelpUrl(Blockly.Msg.PROCEDURES_CALLNORETURN_HELPURL),this.arguments_=[],this.argumentVarModels_=[],this.quarkConnections_={},this.quarkIds_=null,this.previousEnabledState_=!0},getProcedureCall:function(){return this.getFieldValue("NAME")},renameProcedure:function(e,t){if(Blockly.Names.equals(e,this.getProcedureCall())){this.setFieldValue(t,"NAME");var s=this.outputConnection?Blockly.Msg.PROCEDURES_CALLRETURN_TOOLTIP:Blockly.Msg.PROCEDURES_CALLNORETURN_TOOLTIP;this.setTooltip(s.replace("%1",t))}},setProcedureParameters_:function(e,t){var s=Blockly.Procedures.getDefinition(this.getProcedureCall(),this.workspace),r=s&&s.mutator&&s.mutator.isVisible();if(r||(this.quarkConnections_={},this.quarkIds_=null),t)if(e.join("\n")!=this.arguments_.join("\n")){if(t.length!=e.length)throw RangeError("paramNames and paramIds must be the same length.");this.setCollapsed(!1),this.quarkIds_||(this.quarkConnections_={},this.quarkIds_=[]);var l=this.rendered;this.rendered=!1;for(var o=0;o<this.arguments_.length;o++){var a=this.getInput("ARG"+o);if(a){var n=a.connection.targetConnection;this.quarkConnections_[this.quarkIds_[o]]=n,r&&n&&-1==t.indexOf(this.quarkIds_[o])&&(n.disconnect(),n.getSourceBlock().bumpNeighbours())}}this.arguments_=[].concat(e),this.argumentVarModels_=[];for(o=0;o<this.arguments_.length;o++){var i=Blockly.Variables.getOrCreateVariablePackage(this.workspace,null,this.arguments_[o],"");this.argumentVarModels_.push(i)}if(this.updateShape_(),this.quarkIds_=t,this.quarkIds_)for(o=0;o<this.arguments_.length;o++){var u=this.quarkIds_[o];if(u in this.quarkConnections_){n=this.quarkConnections_[u];Blockly.Mutator.reconnect(n,this,"ARG"+o)||delete this.quarkConnections_[u]}}this.rendered=l,this.rendered&&this.render()}else this.quarkIds_=t},updateShape_:function(){for(var e=0;e<this.arguments_.length;e++){var t=this.getField("ARGNAME"+e);if(t){Blockly.Events.disable();try{t.setValue(this.arguments_[e])}finally{Blockly.Events.enable()}}else{t=new Blockly.FieldLabel(this.arguments_[e]),this.appendValueInput("ARG"+e).setAlign(Blockly.ALIGN_RIGHT).appendField(t,"ARGNAME"+e).init()}}for(;this.getInput("ARG"+e);)this.removeInput("ARG"+e),e++;var s=this.getInput("TOPROW");s&&(this.arguments_.length?this.getField("WITH")||(s.appendField(Blockly.Msg.PROCEDURES_CALL_BEFORE_PARAMS,"WITH"),s.init()):this.getField("WITH")&&s.removeField("WITH"))},mutationToDom:function(){var e=Blockly.utils.xml.createElement("mutation");e.setAttribute("name",this.getProcedureCall());for(var t=0;t<this.arguments_.length;t++){var s=Blockly.utils.xml.createElement("arg");s.setAttribute("name",this.arguments_[t]),e.appendChild(s)}return e},domToMutation:function(e){var t=e.getAttribute("name");this.renameProcedure(this.getProcedureCall(),t);for(var s,r=[],l=[],o=0;s=e.childNodes[o];o++)"arg"==s.nodeName.toLowerCase()&&(r.push(s.getAttribute("name")),l.push(s.getAttribute("paramId")));this.setProcedureParameters_(r,l)},getVars:function(){return this.arguments_},getVarModels:function(){return this.argumentVarModels_},onchange:function(e){if(this.workspace&&!this.workspace.isFlyout&&e.recordUndo)if(e.type==Blockly.Events.BLOCK_CREATE&&-1!=e.ids.indexOf(this.id)){var t=this.getProcedureCall();if(!(c=Blockly.Procedures.getDefinition(t,this.workspace))||c.type==this.defType_&&JSON.stringify(c.getVars())==JSON.stringify(this.arguments_)||(c=null),!c){Blockly.Events.setGroup(e.group);var s=Blockly.utils.xml.createElement("xml"),r=Blockly.utils.xml.createElement("block");r.setAttribute("type",this.defType_);var l=this.getRelativeToSurfaceXY(),o=l.x+Blockly.SNAP_RADIUS*(this.RTL?-1:1),a=l.y+2*Blockly.SNAP_RADIUS;r.setAttribute("x",o),r.setAttribute("y",a);var n=this.mutationToDom();r.appendChild(n);var i=Blockly.utils.xml.createElement("field");i.setAttribute("name","NAME");var u=this.getProcedureCall();u||(u=Blockly.Procedures.findLegalName("",this),this.renameProcedure("",u)),i.appendChild(Blockly.utils.xml.createTextNode(u)),r.appendChild(i),s.appendChild(r),Blockly.Xml.domToWorkspace(s,this.workspace),Blockly.Events.setGroup(!1)}}else if(e.type==Blockly.Events.BLOCK_DELETE){t=this.getProcedureCall();(c=Blockly.Procedures.getDefinition(t,this.workspace))||(Blockly.Events.setGroup(e.group),this.dispose(!0),Blockly.Events.setGroup(!1))}else if(e.type==Blockly.Events.CHANGE&&"disabled"==e.element){var c;t=this.getProcedureCall();if((c=Blockly.Procedures.getDefinition(t,this.workspace))&&c.id==e.blockId){var d=Blockly.Events.getGroup();d&&console.log("Saw an existing group while responding to a definition change"),Blockly.Events.setGroup(e.group),e.newValue?(this.previousEnabledState_=this.isEnabled(),this.setEnabled(!1)):this.setEnabled(this.previousEnabledState_),Blockly.Events.setGroup(d)}}},customContextMenu:function(e){if(this.workspace.isMovable()){var t={enabled:!0};t.text=Blockly.Msg.PROCEDURES_HIGHLIGHT_DEF;var s=this.getProcedureCall(),r=this.workspace;t.callback=function(){var e=Blockly.Procedures.getDefinition(s,r);e&&(r.centerOnBlock(e.id),e.select())},e.push(t)}},defType_:"procedures_defnoreturn"},Blockly.Blocks.procedures_callreturn={init:function(){this.appendDummyInput("TOPROW").appendField("","NAME"),this.setOutput(!0),this.setStyle("procedure_blocks"),this.setHelpUrl(Blockly.Msg.PROCEDURES_CALLRETURN_HELPURL),this.arguments_=[],this.argumentVarModels_=[],this.quarkConnections_={},this.quarkIds_=null,this.previousEnabledState_=!0},getProcedureCall:Blockly.Blocks.procedures_callnoreturn.getProcedureCall,renameProcedure:Blockly.Blocks.procedures_callnoreturn.renameProcedure,setProcedureParameters_:Blockly.Blocks.procedures_callnoreturn.setProcedureParameters_,updateShape_:Blockly.Blocks.procedures_callnoreturn.updateShape_,mutationToDom:Blockly.Blocks.procedures_callnoreturn.mutationToDom,domToMutation:Blockly.Blocks.procedures_callnoreturn.domToMutation,getVars:Blockly.Blocks.procedures_callnoreturn.getVars,getVarModels:Blockly.Blocks.procedures_callnoreturn.getVarModels,onchange:Blockly.Blocks.procedures_callnoreturn.onchange,customContextMenu:Blockly.Blocks.procedures_callnoreturn.customContextMenu,defType_:"procedures_defreturn"},Blockly.Blocks.procedures_ifreturn={init:function(){this.appendValueInput("CONDITION").setCheck("Boolean").appendField(Blockly.Msg.CONTROLS_IF_MSG_IF),this.appendValueInput("VALUE").appendField(Blockly.Msg.PROCEDURES_DEFRETURN_RETURN),this.setInputsInline(!0),this.setPreviousStatement(!0),this.setNextStatement(!0),this.setStyle("procedure_blocks"),this.setTooltip(Blockly.Msg.PROCEDURES_IFRETURN_TOOLTIP),this.setHelpUrl(Blockly.Msg.PROCEDURES_IFRETURN_HELPURL),this.hasReturnValue_=!0},mutationToDom:function(){var e=Blockly.utils.xml.createElement("mutation");return e.setAttribute("value",Number(this.hasReturnValue_)),e},domToMutation:function(e){var t=e.getAttribute("value");this.hasReturnValue_=1==t,this.hasReturnValue_||(this.removeInput("VALUE"),this.appendDummyInput("VALUE").appendField(Blockly.Msg.PROCEDURES_DEFRETURN_RETURN))},onchange:function(e){if(this.workspace.isDragging&&!this.workspace.isDragging()){var t=!1,s=this;do{if(-1!=this.FUNCTION_TYPES.indexOf(s.type)){t=!0;break}s=s.getSurroundParent()}while(s);t?("procedures_defnoreturn"==s.type&&this.hasReturnValue_?(this.removeInput("VALUE"),this.appendDummyInput("VALUE").appendField(Blockly.Msg.PROCEDURES_DEFRETURN_RETURN),this.hasReturnValue_=!1):"procedures_defreturn"!=s.type||this.hasReturnValue_||(this.removeInput("VALUE"),this.appendValueInput("VALUE").appendField(Blockly.Msg.PROCEDURES_DEFRETURN_RETURN),this.hasReturnValue_=!0),this.setWarningText(null),this.isInFlyout||this.setEnabled(!0)):(this.setWarningText(Blockly.Msg.PROCEDURES_IFRETURN_WARNING),this.isInFlyout||this.getInheritedDisabled()||this.setEnabled(!1))}},FUNCTION_TYPES:["procedures_defnoreturn","procedures_defreturn"]};