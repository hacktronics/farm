/**
 * @license
 * Copyright 2012 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
"use strict";goog.provide("Blockly.Blocks.logic"),goog.provide("Blockly.Constants.Logic"),goog.require("Blockly"),goog.require("Blockly.Blocks"),goog.require("Blockly.FieldDropdown"),goog.require("Blockly.FieldLabel"),goog.require("Blockly.Mutator"),goog.require("Blockly.PXTBlockly.Extensions"),Blockly.Constants.Logic.HUE=210,Blockly.Blocks.controls_if={init:function(){Blockly.Extensions.apply("inline-svgs",this,!1),this.elseifCount_=0,this.elseCount_=0,this.setHelpUrl(Blockly.Msg.CONTROLS_IF_HELPURL),this.appendValueInput("IF0").setCheck("Boolean").appendField(Blockly.Msg.CONTROLS_IF_MSG_IF),this.appendDummyInput("THEN0").appendField(Blockly.Msg.CONTROLS_IF_MSG_THEN),this.appendStatementInput("DO0"),this.setOutputShape(Blockly.OUTPUT_SHAPE_HEXAGONAL),this.updateShape_(),this.setInputsInline(!0),this.setColour(Blockly.Msg.LOGIC_HUE),this.setPreviousStatement(!0),this.setNextStatement(!0),Blockly.Constants.Logic.CONTROLS_IF_TOOLTIP_EXTENSION.call(this)},mutationToDom:function(){if(!this.elseifCount_&&!this.elseCount_)return null;var t=Blockly.utils.xml.createElement("mutation");return this.elseifCount_&&t.setAttribute("elseif",this.elseifCount_),this.elseCount_&&t.setAttribute("else",1),t},domToMutation:function(t){t&&(this.elseifCount_=parseInt(t.getAttribute("elseif"),10)||0,this.elseCount_=parseInt(t.getAttribute("else"),10)||0,this.rebuildShape_())},storeConnections_:function(t){t||(t=0),this.valueConnections_=[null],this.statementConnections_=[null],this.elseStatementConnection_=null;for(var e=1;e<=this.elseifCount_;e++)t!=e&&(this.valueConnections_.push(this.getInput("IF"+e).connection.targetConnection),this.statementConnections_.push(this.getInput("DO"+e).connection.targetConnection));this.getInput("ELSE")&&(this.elseStatementConnection_=this.getInput("ELSE").connection.targetConnection)},restoreConnections_:function(){for(var t=1;t<=this.elseifCount_;t++)Blockly.Mutator.reconnect(this.valueConnections_[t],this,"IF"+t),Blockly.Mutator.reconnect(this.statementConnections_[t],this,"DO"+t);this.getInput("ELSE")&&Blockly.Mutator.reconnect(this.elseStatementConnection_,this,"ELSE")},addElse_:function(){this.storeConnections_();this.update_(function(){this.elseCount_++}),this.restoreConnections_()},removeElse_:function(){this.storeConnections_();this.update_(function(){this.elseCount_--}),this.restoreConnections_()},addElseIf_:function(){this.storeConnections_();this.update_(function(){this.elseifCount_++}),this.restoreConnections_()},removeElseIf_:function(t){this.storeConnections_(t);this.update_(function(){this.elseifCount_--}),this.restoreConnections_()},update_:function(t){Blockly.Events.setGroup(!0);var e=this,n=e.mutationToDom(),o=n&&Blockly.Xml.domToText(n),s=e.rendered;e.rendered=!1,t&&t.call(this),this.updateShape_(),e.rendered=s,e.initSvg();var i=Blockly.Events.getGroup(),l=e.mutationToDom(),_=l&&Blockly.Xml.domToText(l);o!=_&&(Blockly.Events.fire(new Blockly.Events.BlockChange(e,"mutation",null,o,_)),setTimeout(function(){Blockly.Events.setGroup(i),e.bumpNeighbours(),Blockly.Events.setGroup(!1)},Blockly.BUMP_DELAY)),e.rendered&&e.render(),Blockly.Events.setGroup(!1)},updateShape_:function(){var t=this;this.getInput("ELSE")&&(this.removeInput("ELSE"),this.removeInput("ELSETITLE"),this.removeInput("ELSEBUTTONS"));for(var e=1;this.getInput("IF"+e);)this.removeInput("IF"+e),this.removeInput("IFTITLE"+e),this.removeInput("IFBUTTONS"+e),this.removeInput("DO"+e),e++;for(e=1;e<=this.elseifCount_;e++){var n=function(e){return function(){t.removeElseIf_(e)}}(e);this.appendValueInput("IF"+e).setCheck("Boolean").appendField(Blockly.Msg.CONTROLS_IF_MSG_ELSEIF),this.appendDummyInput("IFTITLE"+e).appendField(Blockly.Msg.CONTROLS_IF_MSG_THEN),this.appendDummyInput("IFBUTTONS"+e).appendField(new Blockly.FieldImage(this.REMOVE_IMAGE_DATAURI,24,24,"*",n,!1)).setAlign(Blockly.ALIGN_RIGHT),this.appendStatementInput("DO"+e)}this.elseCount_&&(this.appendDummyInput("ELSETITLE").appendField(Blockly.Msg.CONTROLS_IF_MSG_ELSE),this.appendDummyInput("ELSEBUTTONS").setAlign(Blockly.ALIGN_RIGHT).appendField(new Blockly.FieldImage(this.REMOVE_IMAGE_DATAURI,24,24,"*",t.removeElse_.bind(t),!1)),this.appendStatementInput("ELSE")),this.getInput("ADDBUTTON")&&this.removeInput("ADDBUTTON");t=this;var o=function(){0==t.elseCount_?t.addElse_():(t.elseifCount_||(t.elseifCount_=0),t.addElseIf_())};this.appendDummyInput("ADDBUTTON").appendField(new Blockly.FieldImage(this.ADD_IMAGE_DATAURI,24,24,"*",o,!1))},rebuildShape_:function(){var t=[null],e=[null],n=null;this.getInput("ELSE")&&(n=this.getInput("ELSE").connection.targetConnection);for(var o=1;this.getInput("IF"+o);){var s=this.getInput("IF"+o),i=this.getInput("DO"+o);t.push(s.connection.targetConnection),e.push(i.connection.targetConnection),o++}this.updateShape_(),this.reconnectChildBlocks_(t,e,n)},reconnectChildBlocks_:function(t,e,n){for(var o=1;o<=this.elseifCount_;o++)Blockly.Mutator.reconnect(t[o],this,"IF"+o),Blockly.Mutator.reconnect(e[o],this,"DO"+o);Blockly.Mutator.reconnect(n,this,"ELSE")}},Blockly.defineBlocksWithJsonArray([{type:"logic_boolean",message0:"%1",args0:[{type:"field_dropdown",name:"BOOL",options:[["%{BKY_LOGIC_BOOLEAN_TRUE}","TRUE"],["%{BKY_LOGIC_BOOLEAN_FALSE}","FALSE"]]}],output:"Boolean",outputShape:Blockly.OUTPUT_SHAPE_HEXAGONAL,style:"logic_blocks",tooltip:"%{BKY_LOGIC_BOOLEAN_TOOLTIP}",helpUrl:"%{BKY_LOGIC_BOOLEAN_HELPURL}"},{type:"controls_ifelse",message0:"%{BKY_CONTROLS_IF_MSG_IF} %1 %{BKY_CONTROLS_IF_MSG_THEN}",args0:[{type:"input_value",name:"IF0",check:"Boolean"}],message1:"%1",args1:[{type:"input_statement",name:"DO0"}],message2:"%{BKY_CONTROLS_IF_MSG_ELSE}",message3:"%1",args3:[{type:"input_statement",name:"ELSE"}],previousStatement:null,nextStatement:null,style:"logic_blocks",tooltip:"%{BKYCONTROLS_IF_TOOLTIP_2}",helpUrl:"%{BKY_CONTROLS_IF_HELPURL}",extensions:["controls_if_tooltip"]},{type:"logic_compare",message0:"%1 %2 %3",args0:[{type:"input_value",name:"A"},{type:"field_dropdown",name:"OP",options:[["=","EQ"],["≠","NEQ"],["‏<","LT"],["‏≤","LTE"],["‏>","GT"],["‏≥","GTE"]]},{type:"input_value",name:"B"}],inputsInline:!0,output:"Boolean",outputShape:Blockly.OUTPUT_SHAPE_HEXAGONAL,style:"logic_blocks",helpUrl:"%{BKY_LOGIC_COMPARE_HELPURL}",extensions:["logic_compare","logic_op_tooltip"]},{type:"logic_operation",message0:"%1 %2 %3",args0:[{type:"input_value",name:"A",check:"Boolean"},{type:"field_dropdown",name:"OP",options:[["%{BKY_LOGIC_OPERATION_AND}","AND"],["%{BKY_LOGIC_OPERATION_OR}","OR"]]},{type:"input_value",name:"B",check:"Boolean"}],inputsInline:!0,output:"Boolean",outputShape:Blockly.OUTPUT_SHAPE_HEXAGONAL,style:"logic_blocks",helpUrl:"%{BKY_LOGIC_OPERATION_HELPURL}",extensions:["logic_op_tooltip"]},{type:"logic_negate",message0:"%{BKY_LOGIC_NEGATE_TITLE}",args0:[{type:"input_value",name:"BOOL",check:"Boolean"}],output:"Boolean",outputShape:Blockly.OUTPUT_SHAPE_HEXAGONAL,style:"logic_blocks",tooltip:"%{BKY_LOGIC_NEGATE_TOOLTIP}",helpUrl:"%{BKY_LOGIC_NEGATE_HELPURL}"},{type:"logic_null",message0:"%{BKY_LOGIC_NULL}",output:null,style:"logic_blocks",tooltip:"%{BKY_LOGIC_NULL_TOOLTIP}",helpUrl:"%{BKY_LOGIC_NULL_HELPURL}"},{type:"logic_ternary",message0:"%{BKY_LOGIC_TERNARY_CONDITION} %1",args0:[{type:"input_value",name:"IF",check:"Boolean"}],message1:"%{BKY_LOGIC_TERNARY_IF_TRUE} %1",args1:[{type:"input_value",name:"THEN"}],message2:"%{BKY_LOGIC_TERNARY_IF_FALSE} %1",args2:[{type:"input_value",name:"ELSE"}],output:null,style:"logic_blocks",tooltip:"%{BKY_LOGIC_TERNARY_TOOLTIP}",helpUrl:"%{BKY_LOGIC_TERNARY_HELPURL}",extensions:["logic_ternary"]}]),Blockly.defineBlocksWithJsonArray([{type:"controls_if_if",message0:"%{BKY_CONTROLS_IF_IF_TITLE_IF}",nextStatement:null,enableContextMenu:!1,style:"logic_blocks",tooltip:"%{BKY_CONTROLS_IF_IF_TOOLTIP}"},{type:"controls_if_elseif",message0:"%{BKY_CONTROLS_IF_ELSEIF_TITLE_ELSEIF}",previousStatement:null,nextStatement:null,enableContextMenu:!1,style:"logic_blocks",tooltip:"%{BKY_CONTROLS_IF_ELSEIF_TOOLTIP}"},{type:"controls_if_else",message0:"%{BKY_CONTROLS_IF_ELSE_TITLE_ELSE}",previousStatement:null,enableContextMenu:!1,style:"logic_blocks",tooltip:"%{BKY_CONTROLS_IF_ELSE_TOOLTIP}"}]),Blockly.Constants.Logic.TOOLTIPS_BY_OP={EQ:"%{BKY_LOGIC_COMPARE_TOOLTIP_EQ}",NEQ:"%{BKY_LOGIC_COMPARE_TOOLTIP_NEQ}",LT:"%{BKY_LOGIC_COMPARE_TOOLTIP_LT}",LTE:"%{BKY_LOGIC_COMPARE_TOOLTIP_LTE}",GT:"%{BKY_LOGIC_COMPARE_TOOLTIP_GT}",GTE:"%{BKY_LOGIC_COMPARE_TOOLTIP_GTE}",AND:"%{BKY_LOGIC_OPERATION_TOOLTIP_AND}",OR:"%{BKY_LOGIC_OPERATION_TOOLTIP_OR}"},Blockly.Extensions.register("logic_op_tooltip",Blockly.Extensions.buildTooltipForDropdown("OP",Blockly.Constants.Logic.TOOLTIPS_BY_OP)),Blockly.Constants.Logic.CONTROLS_IF_MUTATOR_MIXIN={elseifCount_:0,elseCount_:0,suppressPrefixSuffix:!0,mutationToDom:function(){if(!this.elseifCount_&&!this.elseCount_)return null;var t=Blockly.utils.xml.createElement("mutation");return this.elseifCount_&&t.setAttribute("elseif",this.elseifCount_),this.elseCount_&&t.setAttribute("else",1),t},domToMutation:function(t){this.elseifCount_=parseInt(t.getAttribute("elseif"),10)||0,this.elseCount_=parseInt(t.getAttribute("else"),10)||0,this.rebuildShape_()},decompose:function(t){var e=t.newBlock("controls_if_if");e.initSvg();for(var n=e.nextConnection,o=1;o<=this.elseifCount_;o++){var s=t.newBlock("controls_if_elseif");s.initSvg(),n.connect(s.previousConnection),n=s.nextConnection}if(this.elseCount_){var i=t.newBlock("controls_if_else");i.initSvg(),n.connect(i.previousConnection)}return e},compose:function(t){var e=t.nextConnection.targetBlock();this.elseifCount_=0,this.elseCount_=0;for(var n=[null],o=[null],s=null;e&&!e.isInsertionMarker();){switch(e.type){case"controls_if_elseif":this.elseifCount_++,n.push(e.valueConnection_),o.push(e.statementConnection_);break;case"controls_if_else":this.elseCount_++,s=e.statementConnection_;break;default:throw TypeError("Unknown block type: "+e.type)}e=e.nextConnection&&e.nextConnection.targetBlock()}this.updateShape_(),this.reconnectChildBlocks_(n,o,s)},saveConnections:function(t){for(var e=t.nextConnection.targetBlock(),n=1;e;){switch(e.type){case"controls_if_elseif":var o=this.getInput("IF"+n),s=this.getInput("DO"+n);e.valueConnection_=o&&o.connection.targetConnection,e.statementConnection_=s&&s.connection.targetConnection,n++;break;case"controls_if_else":s=this.getInput("ELSE");e.statementConnection_=s&&s.connection.targetConnection;break;default:throw TypeError("Unknown block type: "+e.type)}e=e.nextConnection&&e.nextConnection.targetBlock()}},rebuildShape_:function(){var t=[null],e=[null],n=null;this.getInput("ELSE")&&(n=this.getInput("ELSE").connection.targetConnection);for(var o=1;this.getInput("IF"+o);){var s=this.getInput("IF"+o),i=this.getInput("DO"+o);t.push(s.connection.targetConnection),e.push(i.connection.targetConnection),o++}this.updateShape_(),this.reconnectChildBlocks_(t,e,n)},updateShape_:function(){this.getInput("ELSE")&&this.removeInput("ELSE");for(var t=1;this.getInput("IF"+t);)this.removeInput("IF"+t),this.removeInput("DO"+t),t++;for(t=1;t<=this.elseifCount_;t++)this.appendValueInput("IF"+t).setCheck("Boolean").appendField(Blockly.Msg.CONTROLS_IF_MSG_ELSEIF),this.appendStatementInput("DO"+t).appendField(Blockly.Msg.CONTROLS_IF_MSG_THEN);this.elseCount_&&this.appendStatementInput("ELSE").appendField(Blockly.Msg.CONTROLS_IF_MSG_ELSE)},reconnectChildBlocks_:function(t,e,n){for(var o=1;o<=this.elseifCount_;o++)Blockly.Mutator.reconnect(t[o],this,"IF"+o),Blockly.Mutator.reconnect(e[o],this,"DO"+o);Blockly.Mutator.reconnect(n,this,"ELSE")}},Blockly.Constants.Logic.CONTROLS_IF_TOOLTIP_EXTENSION=function(){this.setTooltip(function(){return this.elseifCount_||this.elseCount_?!this.elseifCount_&&this.elseCount_?Blockly.Msg.CONTROLS_IF_TOOLTIP_2:this.elseifCount_&&!this.elseCount_?Blockly.Msg.CONTROLS_IF_TOOLTIP_3:this.elseifCount_&&this.elseCount_?Blockly.Msg.CONTROLS_IF_TOOLTIP_4:"":Blockly.Msg.CONTROLS_IF_TOOLTIP_1}.bind(this))},Blockly.Extensions.register("controls_if_tooltip",Blockly.Constants.Logic.CONTROLS_IF_TOOLTIP_EXTENSION),Blockly.Constants.Logic.LOGIC_COMPARE_ONCHANGE_MIXIN={onchange:function(t){this.prevBlocks_||(this.prevBlocks_=[null,null]);var e=this.getInputTargetBlock("A"),n=this.getInputTargetBlock("B");if(e&&n&&!this.workspace.connectionChecker.doTypeChecks(e.outputConnection,n.outputConnection)){Blockly.Events.setGroup(t.group);var o=this.prevBlocks_[0];o!==e&&(e.unplug(),!o||o.isDisposed()||o.isShadow()||this.getInput("A").connection.connect(o.outputConnection));var s=this.prevBlocks_[1];s!==n&&(n.unplug(),!s||s.isDisposed()||s.isShadow()||this.getInput("B").connection.connect(s.outputConnection)),this.bumpNeighbours(),Blockly.Events.setGroup(!1)}this.prevBlocks_[0]=this.getInputTargetBlock("A"),this.prevBlocks_[1]=this.getInputTargetBlock("B")}},Blockly.Constants.Logic.LOGIC_COMPARE_EXTENSION=function(){this.mixin(Blockly.Constants.Logic.LOGIC_COMPARE_ONCHANGE_MIXIN)},Blockly.Extensions.register("logic_compare",Blockly.Constants.Logic.LOGIC_COMPARE_EXTENSION),Blockly.Constants.Logic.LOGIC_TERNARY_ONCHANGE_MIXIN={prevParentConnection_:null,onchange:function(t){var e=this.getInputTargetBlock("THEN"),n=this.getInputTargetBlock("ELSE"),o=this.outputConnection.targetConnection;if((e||n)&&o)for(var s=0;s<2;s++){var i=1==s?e:n;i&&!i.workspace.connectionChecker.doTypeChecks(i.outputConnection,o)&&(Blockly.Events.setGroup(t.group),o===this.prevParentConnection_?(this.unplug(),o.getSourceBlock().bumpNeighbours()):(i.unplug(),i.bumpNeighbours()),Blockly.Events.setGroup(!1))}this.prevParentConnection_=o}},Blockly.Extensions.registerMixin("logic_ternary",Blockly.Constants.Logic.LOGIC_TERNARY_ONCHANGE_MIXIN);