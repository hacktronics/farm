/**
 * @license Portions of this code are from MochiKit, received by
 * The Closure Authors under the MIT license. All other code is Copyright
 * 2005-2009 The Closure Authors. All Rights Reserved.
 */
goog.provide("goog.async.Deferred"),goog.provide("goog.async.Deferred.AlreadyCalledError"),goog.provide("goog.async.Deferred.CanceledError"),goog.require("goog.Promise"),goog.require("goog.Thenable"),goog.require("goog.array"),goog.require("goog.asserts"),goog.require("goog.debug.Error"),goog.async.Deferred=function(e,r){if(this.sequence_=[],this.onCancelFunction_=e,this.defaultScope_=r||null,this.fired_=!1,this.hadError_=!1,this.result_=void 0,this.blocked_=!1,this.blocking_=!1,this.silentlyCanceled_=!1,this.unhandledErrorId_=0,this.parent_=null,this.branches_=0,goog.async.Deferred.LONG_STACK_TRACES&&(this.constructorStack_=null,Error.captureStackTrace)){var o={stack:""};Error.captureStackTrace(o,goog.async.Deferred),"string"==typeof o.stack&&(this.constructorStack_=o.stack.replace(/^[^\n]*\n/,""))}},goog.async.Deferred.STRICT_ERRORS=goog.define("goog.async.Deferred.STRICT_ERRORS",!1),goog.async.Deferred.LONG_STACK_TRACES=goog.define("goog.async.Deferred.LONG_STACK_TRACES",!1),goog.async.Deferred.prototype.cancel=function(e){if(this.hasFired())this.result_ instanceof goog.async.Deferred&&this.result_.cancel();else{if(this.parent_){var r=this.parent_;delete this.parent_,e?r.cancel(e):r.branchCancel_()}this.onCancelFunction_?this.onCancelFunction_.call(this.defaultScope_,this):this.silentlyCanceled_=!0,this.hasFired()||this.errback(new goog.async.Deferred.CanceledError(this))}},goog.async.Deferred.prototype.branchCancel_=function(){this.branches_--,this.branches_<=0&&this.cancel()},goog.async.Deferred.prototype.continue_=function(e,r){this.blocked_=!1,this.updateResult_(e,r)},goog.async.Deferred.prototype.updateResult_=function(e,r){this.fired_=!0,this.result_=r,this.hadError_=!e,this.fire_()},goog.async.Deferred.prototype.check_=function(){if(this.hasFired()){if(!this.silentlyCanceled_)throw new goog.async.Deferred.AlreadyCalledError(this);this.silentlyCanceled_=!1}},goog.async.Deferred.prototype.callback=function(e){this.check_(),this.assertNotDeferred_(e),this.updateResult_(!0,e)},goog.async.Deferred.prototype.errback=function(e){this.check_(),this.assertNotDeferred_(e),this.makeStackTraceLong_(e),this.updateResult_(!1,e)},goog.async.Deferred.prototype.makeStackTraceLong_=function(e){goog.async.Deferred.LONG_STACK_TRACES&&this.constructorStack_&&goog.isObject(e)&&e.stack&&/^[^\n]+(\n   [^\n]+)+/.test(e.stack)&&(e.stack=e.stack+"\nDEFERRED OPERATION:\n"+this.constructorStack_)},goog.async.Deferred.prototype.assertNotDeferred_=function(e){goog.asserts.assert(!(e instanceof goog.async.Deferred),"An execution sequence may not be initiated with a blocking Deferred.")},goog.async.Deferred.prototype.addCallback=function(e,r){return this.addCallbacks(e,null,r)},goog.async.Deferred.prototype.addErrback=function(e,r){return this.addCallbacks(null,e,r)},goog.async.Deferred.prototype.addBoth=function(e,r){return this.addCallbacks(e,e,r)},goog.async.Deferred.prototype.addFinally=function(e,r){return this.addCallbacks(e,function(r){var o=e.call(this,r);if(void 0===o)throw r;return o},r)},goog.async.Deferred.prototype.addCallbacks=function(e,r,o){return goog.asserts.assert(!this.blocking_,"Blocking Deferreds can not be re-used"),this.sequence_.push([e,r,o]),this.hasFired()&&this.fire_(),this},goog.async.Deferred.prototype.then=function(e,r,o){var t,n,a=new goog.Promise(function(e,r){t=e,n=r});return this.addCallbacks(t,function(e){e instanceof goog.async.Deferred.CanceledError?a.cancel():n(e)}),a.then(e,r,o)},goog.Thenable.addImplementation(goog.async.Deferred),goog.async.Deferred.prototype.chainDeferred=function(e){return this.addCallbacks(e.callback,e.errback,e),this},goog.async.Deferred.prototype.awaitDeferred=function(e){return e instanceof goog.async.Deferred?this.addCallback(goog.bind(e.branch,e)):this.addCallback(function(){return e})},goog.async.Deferred.prototype.branch=function(e){var r=new goog.async.Deferred;return this.chainDeferred(r),e&&(r.parent_=this,this.branches_++),r},goog.async.Deferred.prototype.hasFired=function(){return this.fired_},goog.async.Deferred.prototype.isError=function(e){return e instanceof Error},goog.async.Deferred.prototype.hasErrback_=function(){return goog.array.some(this.sequence_,function(e){return goog.isFunction(e[1])})},goog.async.Deferred.prototype.fire_=function(){this.unhandledErrorId_&&this.hasFired()&&this.hasErrback_()&&(goog.async.Deferred.unscheduleError_(this.unhandledErrorId_),this.unhandledErrorId_=0),this.parent_&&(this.parent_.branches_--,delete this.parent_);for(var e=this.result_,r=!1,o=!1;this.sequence_.length&&!this.blocked_;){var t=this.sequence_.shift(),n=t[0],a=t[1],s=t[2],c=this.hadError_?a:n;if(c)try{var i=c.call(s||this.defaultScope_,e);void 0!==i&&(this.hadError_=this.hadError_&&(i==e||this.isError(i)),this.result_=e=i),(goog.Thenable.isImplementedBy(e)||"function"==typeof goog.global.Promise&&e instanceof goog.global.Promise)&&(o=!0,this.blocked_=!0)}catch(o){e=o,this.hadError_=!0,this.makeStackTraceLong_(e),this.hasErrback_()||(r=!0)}}if(this.result_=e,o){var g=goog.bind(this.continue_,this,!0),d=goog.bind(this.continue_,this,!1);e instanceof goog.async.Deferred?(e.addCallbacks(g,d),e.blocking_=!0):e.then(g,d)}else!goog.async.Deferred.STRICT_ERRORS||!this.isError(e)||e instanceof goog.async.Deferred.CanceledError||(this.hadError_=!0,r=!0);r&&(this.unhandledErrorId_=goog.async.Deferred.scheduleError_(e))},goog.async.Deferred.succeed=function(e){var r=new goog.async.Deferred;return r.callback(e),r},goog.async.Deferred.fromPromise=function(e){var r=new goog.async.Deferred;return e.then(function(e){r.callback(e)},function(e){r.errback(e)}),r},goog.async.Deferred.fail=function(e){var r=new goog.async.Deferred;return r.errback(e),r},goog.async.Deferred.canceled=function(){var e=new goog.async.Deferred;return e.cancel(),e},goog.async.Deferred.when=function(e,r,o){return e instanceof goog.async.Deferred?e.branch(!0).addCallback(r,o):goog.async.Deferred.succeed(e).addCallback(r,o)},goog.async.Deferred.AlreadyCalledError=function(e){goog.debug.Error.call(this),this.deferred=e},goog.inherits(goog.async.Deferred.AlreadyCalledError,goog.debug.Error),goog.async.Deferred.AlreadyCalledError.prototype.message="Deferred has already fired",goog.async.Deferred.AlreadyCalledError.prototype.name="AlreadyCalledError",goog.async.Deferred.CanceledError=function(e){goog.debug.Error.call(this),this.deferred=e},goog.inherits(goog.async.Deferred.CanceledError,goog.debug.Error),goog.async.Deferred.CanceledError.prototype.message="Deferred was canceled",goog.async.Deferred.CanceledError.prototype.name="CanceledError",goog.async.Deferred.Error_=function(e){this.id_=goog.global.setTimeout(goog.bind(this.throwError,this),0),this.error_=e},goog.async.Deferred.Error_.prototype.throwError=function(){throw goog.asserts.assert(goog.async.Deferred.errorMap_[this.id_],"Cannot throw an error that is not scheduled."),delete goog.async.Deferred.errorMap_[this.id_],this.error_},goog.async.Deferred.Error_.prototype.resetTimer=function(){goog.global.clearTimeout(this.id_)},goog.async.Deferred.errorMap_={},goog.async.Deferred.scheduleError_=function(e){var r=new goog.async.Deferred.Error_(e);return goog.async.Deferred.errorMap_[r.id_]=r,r.id_},goog.async.Deferred.unscheduleError_=function(e){var r=goog.async.Deferred.errorMap_[e];r&&(r.resetTimer(),delete goog.async.Deferred.errorMap_[e])},goog.async.Deferred.assertNoErrors=function(){var e=goog.async.Deferred.errorMap_;for(var r in e){var o=e[r];o.resetTimer(),o.throwError()}};