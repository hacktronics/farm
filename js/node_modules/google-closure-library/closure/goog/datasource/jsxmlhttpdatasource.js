goog.provide("goog.ds.JsXmlHttpDataSource"),goog.require("goog.Uri"),goog.require("goog.ds.DataManager"),goog.require("goog.ds.FastDataNode"),goog.require("goog.ds.LoadState"),goog.require("goog.ds.logger"),goog.require("goog.events"),goog.require("goog.log"),goog.require("goog.net.EventType"),goog.require("goog.net.XhrIo"),goog.ds.JsXmlHttpDataSource=function(t,o,e,g,s){goog.ds.FastDataNode.call(this,{},o,null),t?(this.uri_=new goog.Uri(t),this.xhr_=new goog.net.XhrIo,this.usePost_=!!s,goog.events.listen(this.xhr_,goog.net.EventType.COMPLETE,this.completed_,!1,this)):this.uri_=null,this.startText_=e,this.endText_=g},goog.inherits(goog.ds.JsXmlHttpDataSource,goog.ds.FastDataNode),goog.ds.JsXmlHttpDataSource.prototype.startText_,goog.ds.JsXmlHttpDataSource.prototype.endText_,goog.ds.JsXmlHttpDataSource.prototype.getLoadState=function(){return this.loadState_},goog.ds.JsXmlHttpDataSource.prototype.setQueryData=function(t){this.queryData_=t},goog.ds.JsXmlHttpDataSource.prototype.load=function(){if(goog.log.info(goog.ds.logger,"Sending JS request for DataSource "+this.getDataName()+" to "+this.uri_),this.uri_)if(this.usePost_){var t;t=this.queryData_?this.queryData_:this.uri_.getQueryData().toString();var o=this.uri_.clone();o.setQueryData(null),this.xhr_.send(String(o),"POST",t)}else this.xhr_.send(String(this.uri_));else this.loadState_=goog.ds.LoadState.NOT_LOADED},goog.ds.JsXmlHttpDataSource.prototype.success_=function(){goog.ds.DataManager.getInstance().fireDataChange(this.getDataName())},goog.ds.JsXmlHttpDataSource.prototype.completed_=function(t){if(this.xhr_.isSuccess()){goog.log.info(goog.ds.logger,"Got data for DataSource "+this.getDataName());var o=this.xhr_.getResponseText();if(this.startText_){var e=o.indexOf(this.startText_);o=o.substring(e+this.startText_.length)}if(this.endText_){var g=o.lastIndexOf(this.endText_);o=o.substring(0,g)}try{var s=JSON.parse(o);this.extendWith(s),this.loadState_=goog.ds.LoadState.LOADED}catch(t){this.loadState_=goog.ds.LoadState.FAILED,goog.log.error(goog.ds.logger,"Failed to parse data: "+t.message)}goog.global.setTimeout(goog.bind(this.success_,this),0)}else goog.log.info(goog.ds.logger,"Data retrieve failed for DataSource "+this.getDataName()),this.loadState_=goog.ds.LoadState.FAILED};