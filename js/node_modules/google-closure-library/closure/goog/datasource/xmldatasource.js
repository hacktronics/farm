goog.provide("goog.ds.XmlDataSource"),goog.provide("goog.ds.XmlHttpDataSource"),goog.require("goog.Uri"),goog.require("goog.dom.NodeType"),goog.require("goog.dom.xml"),goog.require("goog.ds.BasicNodeList"),goog.require("goog.ds.DataManager"),goog.require("goog.ds.DataNode"),goog.require("goog.ds.LoadState"),goog.require("goog.ds.logger"),goog.require("goog.log"),goog.require("goog.net.XhrIo"),goog.require("goog.string"),goog.ds.XmlDataSource=function(o,t,e){this.parent_=t,this.dataName_=e||(o?o.nodeName:""),this.setNode_(o)},goog.ds.XmlDataSource.ATTRIBUTE_SELECTOR_="@*",goog.ds.XmlDataSource.prototype.setNode_=function(o){if(this.node_=o,null!=o)switch(o.nodeType){case goog.dom.NodeType.ATTRIBUTE:case goog.dom.NodeType.TEXT:this.value_=o.nodeValue;break;case goog.dom.NodeType.ELEMENT:1==o.childNodes.length&&o.firstChild.nodeType==goog.dom.NodeType.TEXT&&(this.value_=o.firstChild.nodeValue)}},goog.ds.XmlDataSource.prototype.createChildNodes_=function(){if(!this.childNodeList_){var o=new goog.ds.BasicNodeList;if(null!=this.node_)for(var t,e=this.node_.childNodes,a=0;t=e[a];a++)if(t.nodeType!=goog.dom.NodeType.TEXT||!goog.ds.XmlDataSource.isEmptyTextNodeValue_(t.nodeValue)){var g=new goog.ds.XmlDataSource(t,this,t.nodeName);o.add(g)}this.childNodeList_=o}},goog.ds.XmlDataSource.prototype.createAttributes_=function(){if(!this.attributes_){var o=new goog.ds.BasicNodeList;if(null!=this.node_&&null!=this.node_.attributes)for(var t,e=this.node_.attributes,a=0;t=e[a];a++){var g=new goog.ds.XmlDataSource(t,this,t.nodeName);o.add(g)}this.attributes_=o}},goog.ds.XmlDataSource.prototype.get=function(){return this.createChildNodes_(),this.value_},goog.ds.XmlDataSource.prototype.set=function(o){throw new Error("Can't set on XmlDataSource yet")},goog.ds.XmlDataSource.prototype.getChildNodes=function(o){if(o&&o==goog.ds.XmlDataSource.ATTRIBUTE_SELECTOR_)return this.createAttributes_(),this.attributes_;if(null==o||o==goog.ds.STR_ALL_CHILDREN_SELECTOR)return this.createChildNodes_(),this.childNodeList_;throw new Error("Unsupported selector")},goog.ds.XmlDataSource.prototype.getChildNode=function(o){if(goog.string.startsWith(o,goog.ds.STR_ATTRIBUTE_START)){var t=this.node_.getAttributeNode(o.substring(1));return t?new goog.ds.XmlDataSource(t,this):null}return this.getChildNodes().get(o)},goog.ds.XmlDataSource.prototype.getChildNodeValue=function(o){var t;return goog.string.startsWith(o,goog.ds.STR_ATTRIBUTE_START)?(t=this.node_.getAttributeNode(o.substring(1)))?t.nodeValue:null:(t=this.getChildNode(o))?t.get():null},goog.ds.XmlDataSource.prototype.getDataName=function(){return this.dataName_},goog.ds.XmlDataSource.prototype.setDataName=function(o){this.dataName_=o},goog.ds.XmlDataSource.prototype.getDataPath=function(){var o="";return this.parent_&&(o=this.parent_.getDataPath()+(-1!=this.dataName_.indexOf(goog.ds.STR_ARRAY_START)?"":goog.ds.STR_PATH_SEPARATOR)),o+this.dataName_},goog.ds.XmlDataSource.prototype.load=function(){},goog.ds.XmlDataSource.prototype.getLoadState=function(){return this.node_?goog.ds.LoadState.LOADED:goog.ds.LoadState.NOT_LOADED},goog.ds.XmlDataSource.isEmptyTextNodeValue_=function(o){return/^[\r\n\t ]*$/.test(o)},goog.ds.XmlDataSource.createChildlessDocument_=function(){return goog.dom.xml.createDocument("nothing")},goog.ds.XmlHttpDataSource=function(o,t){goog.ds.XmlDataSource.call(this,null,null,t),this.uri_=o?new goog.Uri(o):null},goog.inherits(goog.ds.XmlHttpDataSource,goog.ds.XmlDataSource),goog.ds.XmlHttpDataSource.prototype.loadState_=goog.ds.LoadState.NOT_LOADED,goog.ds.XmlHttpDataSource.prototype.load=function(){this.uri_?(goog.log.info(goog.ds.logger,"Sending XML request for DataSource "+this.getDataName()+" to "+this.uri_),this.loadState_=goog.ds.LoadState.LOADING,goog.net.XhrIo.send(this.uri_,goog.bind(this.complete_,this))):(this.node_=goog.ds.XmlDataSource.createChildlessDocument_(),this.loadState_=goog.ds.LoadState.NOT_LOADED)},goog.ds.XmlHttpDataSource.prototype.getLoadState=function(){return this.loadState_},goog.ds.XmlHttpDataSource.prototype.complete_=function(o){var t=o.target;t&&t.isSuccess()?this.success_(t):this.failure_()},goog.ds.XmlHttpDataSource.prototype.success_=function(o){goog.log.info(goog.ds.logger,"Got data for DataSource "+this.getDataName());var t=o.getResponseXml();t&&!t.hasChildNodes()&&goog.isObject(o.getResponseText())&&(t=goog.dom.xml.loadXml(o.getResponseText())),t&&t.hasChildNodes()?(this.loadState_=goog.ds.LoadState.LOADED,this.node_=t.documentElement):(this.loadState_=goog.ds.LoadState.FAILED,this.node_=goog.ds.XmlDataSource.createChildlessDocument_()),this.getDataName()&&goog.ds.DataManager.getInstance().fireDataChange(this.getDataName())},goog.ds.XmlHttpDataSource.prototype.failure_=function(){goog.log.info(goog.ds.logger,"Data retrieve failed for DataSource "+this.getDataName()),this.loadState_=goog.ds.LoadState.FAILED,this.node_=goog.ds.XmlDataSource.createChildlessDocument_(),this.getDataName()&&goog.ds.DataManager.getInstance().fireDataChange(this.getDataName())};