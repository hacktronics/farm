goog.provide("goog.ds.DataManager"),goog.require("goog.ds.BasicNodeList"),goog.require("goog.ds.DataNode"),goog.require("goog.ds.Expr"),goog.require("goog.object"),goog.require("goog.string"),goog.require("goog.structs"),goog.require("goog.structs.Map"),goog.ds.DataManager=function(){this.dataSources_=new goog.ds.BasicNodeList,this.autoloads_=new goog.structs.Map,this.listenerMap_={},this.listenersByFunction_={},this.aliases_={},this.eventCount_=0,this.indexedListenersByFunction_={}},goog.ds.DataManager.instance_=null,goog.inherits(goog.ds.DataManager,goog.ds.DataNode),goog.ds.DataManager.getInstance=function(){return goog.ds.DataManager.instance_||(goog.ds.DataManager.instance_=new goog.ds.DataManager),goog.ds.DataManager.instance_},goog.ds.DataManager.clearInstance=function(){goog.ds.DataManager.instance_=null},goog.ds.DataManager.prototype.addDataSource=function(t,e,a){var o=!!e,n=a||t.getDataName();goog.string.startsWith(n,"$")||(n="$"+n),t.setDataName(n),this.dataSources_.add(t),this.autoloads_.set(n,o)},goog.ds.DataManager.prototype.aliasDataSource=function(t,e){if(this.aliasListener_||(this.aliasListener_=goog.bind(this.listenForAlias_,this)),this.aliases_[t]){var a=this.aliases_[t].getSource();this.removeListeners(this.aliasListener_,a+"/...",t)}this.aliases_[t]=goog.ds.Expr.create(e),this.addListener(this.aliasListener_,e+"/...",t),this.fireDataChange(t)},goog.ds.DataManager.prototype.listenForAlias_=function(t,e){var a=this.aliases_[e];if(a){var o=a.getSource();0==t.indexOf(o)?this.fireDataChange(e+t.substring(o.length)):this.fireDataChange(e)}},goog.ds.DataManager.prototype.getDataSource=function(t){return this.aliases_[t]?this.aliases_[t].getNode():this.dataSources_.get(t)},goog.ds.DataManager.prototype.get=function(){return this.dataSources_},goog.ds.DataManager.prototype.set=function(t){throw new Error("Can't set on DataManager")},goog.ds.DataManager.prototype.getChildNodes=function(t){return t?new goog.ds.BasicNodeList([this.getChildNode(t)]):this.dataSources_},goog.ds.DataManager.prototype.getChildNode=function(t){return this.getDataSource(t)},goog.ds.DataManager.prototype.getChildNodeValue=function(t){var e=this.getDataSource(t);return e?e.get():null},goog.ds.DataManager.prototype.getDataName=function(){return""},goog.ds.DataManager.prototype.getDataPath=function(){return""},goog.ds.DataManager.prototype.load=function(){for(var t=this.dataSources_.getCount(),e=0;e<t;e++){var a=this.dataSources_.getByIndex(e);this.autoloads_.get(a.getDataName())&&a.load()}},goog.ds.DataManager.prototype.getLoadState=goog.abstractMethod,goog.ds.DataManager.prototype.isList=function(){return!1},goog.ds.DataManager.prototype.getEventCount=function(){return this.eventCount_},goog.ds.DataManager.prototype.addListener=function(t,e,a){var o=0;goog.string.endsWith(e,"/...")?(o=1e3,e=e.substring(0,e.length-4)):goog.string.endsWith(e,"/*")&&(o=1,e=e.substring(0,e.length-2));var n=e+":"+(a=a||"")+":"+goog.getUid(t),s={dataPath:e,id:a,fn:t},i=goog.ds.Expr.create(e),g=goog.getUid(t);for(this.listenersByFunction_[g]||(this.listenersByFunction_[g]={}),this.listenersByFunction_[g][n]={listener:s,items:[]};i;){var r={listener:s,maxAncestors:o},d=this.listenerMap_[i.getSource()];null==d&&(d={},this.listenerMap_[i.getSource()]=d),d[n]=r,o=0,i=i.getParent(),this.listenersByFunction_[g][n].items.push({key:n,obj:d})}},goog.ds.DataManager.prototype.addIndexedListener=function(t,e,a){var o=e.indexOf("*");if(-1!=o){var n=e.substring(0,o)+"...",s="$";goog.string.endsWith(e,"/...")&&(e=e.substring(0,e.length-4),s="");var i=goog.string.regExpEscape(e).replace(/\\\*/g,"([^\\/]+)")+s,g=new RegExp(i),r=function(e,o){var n=g.exec(e);n&&(n.shift(),t(e,a,n))};this.addListener(r,n,a);var d=goog.getUid(t);this.indexedListenersByFunction_[d]||(this.indexedListenersByFunction_[d]={});var u=e+":"+a;this.indexedListenersByFunction_[d][u]={listener:{dataPath:n,fn:r,id:a}}}else this.addListener(t,e,a)},goog.ds.DataManager.prototype.removeIndexedListeners=function(t,e,a){this.removeListenersByFunction_(this.indexedListenersByFunction_,!0,t,e,a)},goog.ds.DataManager.prototype.removeListeners=function(t,e,a){e&&goog.string.endsWith(e,"/...")?e=e.substring(0,e.length-4):e&&goog.string.endsWith(e,"/*")&&(e=e.substring(0,e.length-2)),this.removeListenersByFunction_(this.listenersByFunction_,!1,t,e,a)},goog.ds.DataManager.prototype.removeListenersByFunction_=function(t,e,a,o,n){var s=t[goog.getUid(a)];if(null!=s)for(var i in s){var g=s[i],r=g.listener;if(!(o&&o!=r.dataPath||n&&n!=r.id)){if(e&&this.removeListeners(r.fn,r.dataPath,r.id),g.items)for(var d=0;d<g.items.length;d++){var u=g.items[d];delete u.obj[u.key]}delete s[i]}}},goog.ds.DataManager.prototype.getListenerCount=function(){var t=0;return goog.object.forEach(this.listenerMap_,function(e){t+=goog.structs.getCount(e)}),t},goog.ds.DataManager.prototype.runWithoutFiringDataChanges=function(t){if(this.disableFiring_)throw new Error("Can not nest calls to runWithoutFiringDataChanges");this.disableFiring_=!0;try{t()}finally{this.disableFiring_=!1}},goog.ds.DataManager.prototype.fireDataChange=function(t){if(!this.disableFiring_){for(var e=goog.ds.Expr.create(t),a=0;e;){var o=this.listenerMap_[e.getSource()];if(o)for(var n in o){var s=o[n],i=s.listener;a<=s.maxAncestors&&i.fn(t,i.id)}a++,e=e.getParent()}this.eventCount_++}};