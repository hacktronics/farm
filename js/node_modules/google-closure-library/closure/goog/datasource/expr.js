goog.provide("goog.ds.Expr"),goog.require("goog.ds.BasicNodeList"),goog.require("goog.ds.EmptyNodeList"),goog.require("goog.string"),goog.ds.Expr=function(t){t&&this.setSource_(t)},goog.ds.Expr.prototype.setSource_=function(t,o,s,r){if(this.src_=t,!s&&!r&&(goog.string.endsWith(t,goog.ds.Expr.String_.CAN_BE_EMPTY)&&(this.canBeEmpty_=!0,t=t.substring(0,t.length-1)),goog.string.endsWith(t,"()")&&(goog.string.endsWith(t,goog.ds.Expr.String_.NAME_EXPR)||goog.string.endsWith(t,goog.ds.Expr.String_.COUNT_EXPR)||goog.string.endsWith(t,goog.ds.Expr.String_.POSITION_EXPR)))){var g=t.lastIndexOf(goog.ds.Expr.String_.SEPARATOR);-1!=g?(this.exprFn_=t.substring(g+1),t=t.substring(0,g)):(this.exprFn_=t,t=goog.ds.Expr.String_.CURRENT_NODE_EXPR),this.exprFn_==goog.ds.Expr.String_.COUNT_EXPR&&(this.isCount_=!0)}this.parts_=o||t.split("/"),this.size_=this.parts_.length,this.last_=this.parts_[this.size_-1],this.root_=this.parts_[0],1==this.size_?(this.rootExpr_=this,this.isAbsolute_=goog.string.startsWith(t,"$")):(this.rootExpr_=goog.ds.Expr.createInternal_(this.root_,null,this,null),this.isAbsolute_=this.rootExpr_.isAbsolute_,this.root_=this.rootExpr_.root_),1!=this.size_||this.isAbsolute_||(this.isCurrent_=t==goog.ds.Expr.String_.CURRENT_NODE_EXPR||t==goog.ds.Expr.String_.EMPTY_EXPR,this.isJustAttribute_=goog.string.startsWith(t,goog.ds.Expr.String_.ATTRIBUTE_START),this.isAllChildNodes_=t==goog.ds.Expr.String_.ALL_CHILD_NODES_EXPR,this.isAllAttributes_=t==goog.ds.Expr.String_.ALL_ATTRIBUTES_EXPR,this.isAllElements_=t==goog.ds.Expr.String_.ALL_ELEMENTS_EXPR)},goog.ds.Expr.prototype.getSource=function(){return this.src_},goog.ds.Expr.prototype.getLast=function(){return this.last_},goog.ds.Expr.prototype.getParent=function(){return this.parentExprSet_||(this.size_>1&&(this.parentExpr_=goog.ds.Expr.createInternal_(null,this.parts_.slice(0,this.parts_.length-1),this,null)),this.parentExprSet_=!0),this.parentExpr_},goog.ds.Expr.prototype.getNext=function(){return this.nextExprSet_||(this.size_>1&&(this.nextExpr_=goog.ds.Expr.createInternal_(null,this.parts_.slice(1),null,this)),this.nextExprSet_=!0),this.nextExpr_},goog.ds.Expr.prototype.getValue=function(t){if(null==t?t=goog.ds.DataManager.getInstance():this.isAbsolute_&&(t=t.getDataRoot?t.getDataRoot():goog.ds.DataManager.getInstance()),this.isCount_)return this.getNodes(t).getCount();if(1==this.size_)return t.getChildNodeValue(this.root_);if(0==this.size_)return t.get();var o=t.getChildNode(this.root_);return null==o?null:this.getNext().getValue(o)},goog.ds.Expr.prototype.getNodes=function(t,o){return this.getNodes_(t,!1,o)},goog.ds.Expr.prototype.getNode=function(t,o){return this.getNodes_(t,!0,o)},goog.ds.Expr.prototype.getNodes_=function(t,o,s){if(null==t?t=goog.ds.DataManager.getInstance():this.isAbsolute_&&(t=t.getDataRoot?t.getDataRoot():goog.ds.DataManager.getInstance()),0==this.size_&&o)return t;if(0!=this.size_||o){if(1==this.size_){if(o)return t.getChildNode(this.root_,s);var r=t.getChildNode(this.root_);return r&&r.isList()?r.getChildNodes():t.getChildNodes(this.root_)}var g=t.getChildNode(this.root_,s);return null==g&&o?null:null!=g||o?this.getNext().getNodes_(g,o,s):new goog.ds.EmptyNodeList}return new goog.ds.BasicNodeList([t])},goog.ds.Expr.prototype.canBeEmpty_=!1,goog.ds.Expr.prototype.parts_=[],goog.ds.Expr.prototype.size_=null,goog.ds.Expr.prototype.root_,goog.ds.Expr.prototype.last_=null,goog.ds.Expr.prototype.isCurrent_=!1,goog.ds.Expr.prototype.isJustAttribute_=!1,goog.ds.Expr.prototype.isAllChildNodes_=!1,goog.ds.Expr.prototype.isAllAttributes_=!1,goog.ds.Expr.prototype.isAllElements_=!1,goog.ds.Expr.prototype.exprFn_=null,goog.ds.Expr.prototype.parentExpr_=null,goog.ds.Expr.prototype.nextExpr_=null,goog.ds.Expr.create=function(t){var o=goog.ds.Expr.cache_[t];return null==o&&(o=new goog.ds.Expr(t),goog.ds.Expr.cache_[t]=o),o},goog.ds.Expr.createInternal_=function(t,o,s,r){var g=t||o.join("/"),e=goog.ds.Expr.cache_[g];return null==e&&((e=new goog.ds.Expr).setSource_(g,o,s,r),goog.ds.Expr.cache_[g]=e),e},goog.ds.Expr.cache_={},goog.ds.Expr.String_={SEPARATOR:"/",CURRENT_NODE_EXPR:".",EMPTY_EXPR:"",ATTRIBUTE_START:"@",ALL_CHILD_NODES_EXPR:"*|text()",ALL_ATTRIBUTES_EXPR:"@*",ALL_ELEMENTS_EXPR:"*",NAME_EXPR:"name()",COUNT_EXPR:"count()",POSITION_EXPR:"position()",INDEX_START:"[",INDEX_END:"]",CAN_BE_EMPTY:"?"},goog.ds.Expr.CURRENT=goog.ds.Expr.create(goog.ds.Expr.String_.CURRENT_NODE_EXPR),goog.ds.Expr.ALL_CHILD_NODES=goog.ds.Expr.create(goog.ds.Expr.String_.ALL_CHILD_NODES_EXPR),goog.ds.Expr.ALL_ELEMENTS=goog.ds.Expr.create(goog.ds.Expr.String_.ALL_ELEMENTS_EXPR),goog.ds.Expr.ALL_ATTRIBUTES=goog.ds.Expr.create(goog.ds.Expr.String_.ALL_ATTRIBUTES_EXPR),goog.ds.Expr.NAME=goog.ds.Expr.create(goog.ds.Expr.String_.NAME_EXPR),goog.ds.Expr.COUNT=goog.ds.Expr.create(goog.ds.Expr.String_.COUNT_EXPR),goog.ds.Expr.POSITION=goog.ds.Expr.create(goog.ds.Expr.String_.POSITION_EXPR);