goog.provide("goog.dom.annotate"),goog.provide("goog.dom.annotate.AnnotateFn"),goog.require("goog.array"),goog.require("goog.asserts"),goog.require("goog.dom"),goog.require("goog.dom.NodeType"),goog.require("goog.dom.TagName"),goog.require("goog.dom.safe"),goog.require("goog.html.SafeHtml"),goog.require("goog.object"),goog.dom.annotate.AnnotateFn,goog.dom.annotate.annotateTerms=function(o,e,t,a,g,n){a&&(e=goog.dom.annotate.lowercaseTerms_(e));var r=+n>0?goog.now()+n:0;return goog.dom.annotate.annotateTermsInNode_(o,e,t,a,g||[],r,0)},goog.dom.annotate.MAX_RECURSION_=200,goog.dom.annotate.NODES_TO_SKIP_=goog.object.createSet(goog.dom.TagName.SCRIPT,goog.dom.TagName.STYLE,goog.dom.TagName.TEXTAREA),goog.dom.annotate.annotateTermsInNode_=function(o,e,t,a,g,n,r){if(n>0&&goog.now()>=n||r>goog.dom.annotate.MAX_RECURSION_)return!1;var m=!1;if(o.nodeType==goog.dom.NodeType.TEXT){var s=goog.dom.annotate.helpAnnotateText_(o.nodeValue,e,t,a);if(null!=s){var d=goog.dom.getDomHelper(o).createElement(goog.dom.TagName.SPAN);goog.dom.safe.setInnerHtml(d,s);for(var i,l=o.parentNode;null!=(i=d.firstChild);)l.insertBefore(i,o);l.removeChild(o),m=!0}}else if(o.hasChildNodes()&&!goog.dom.annotate.NODES_TO_SKIP_[o.tagName]){var f=o.className.split(/\s+/);if(!goog.array.some(f,function(o){return goog.array.contains(g,o)})){++r;for(var u=o.firstChild;u;){var N=u.nextSibling,T=goog.dom.annotate.annotateTermsInNode_(u,e,t,a,g,n,r);m=m||T,u=N}}}return m},goog.dom.annotate.NONWORD_RE_=/\W/,goog.dom.annotate.annotateText=function(o,e,t,a){return a&&(e=goog.dom.annotate.lowercaseTerms_(e)),goog.dom.annotate.helpAnnotateText_(o,e,t,a)},goog.dom.annotate.helpAnnotateText_=function(o,e,t,a){for(var g=!1,n=a?o.toLowerCase():o,r=n.length,m=e.length,s=new Array(m),d=0;d<m;d++){var i=e[d],l=[],f=i[0];if(""!=f)for(var u=i[1],N=f.length,T=0;T<r;){if(-1==(E=n.indexOf(f,T)))break;var h=E-1,_=E+N;(!u||(h<0||goog.dom.annotate.NONWORD_RE_.test(n.charAt(h)))&&(_>=r||goog.dom.annotate.NONWORD_RE_.test(n.charAt(_))))&&(l.push(E),g=!0),T=E+N}s[d]=l}if(g){var v=[];for(T=0;;){var c,p=-1;for(d=0;d<m;d++){l=s[d];if(!goog.array.isEmpty(l)){for(var E=l[0];E>=0&&E<T;)l.shift(),E=goog.array.isEmpty(l)?-1:l[0];E>=0&&(p<0||E<p)&&(c=d,p=E)}}if(p<0)break;goog.asserts.assertNumber(c),s[c].shift(),v.push(o.substr(T,p-T));N=e[c][0].length;var S=goog.html.SafeHtml.htmlEscape(o.substr(p,N));v.push(t(goog.asserts.assertNumber(c),S)),T=p+N}return v.push(o.substr(T)),goog.html.SafeHtml.concat(v)}return null},goog.dom.annotate.lowercaseTerms_=function(o){for(var e=[],t=0;t<o.length;++t){var a=o[t];e[t]=[a[0].toLowerCase(),a[1]]}return e};