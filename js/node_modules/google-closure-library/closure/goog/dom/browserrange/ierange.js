goog.provide("goog.dom.browserrange.IeRange"),goog.require("goog.array"),goog.require("goog.dom"),goog.require("goog.dom.NodeType"),goog.require("goog.dom.RangeEndpoint"),goog.require("goog.dom.TagName"),goog.require("goog.dom.browserrange.AbstractRange"),goog.require("goog.dom.safe"),goog.require("goog.html.uncheckedconversions"),goog.require("goog.log"),goog.require("goog.string"),goog.dom.browserrange.IeRange=function(e,o){this.parentNode_=null,this.startNode_=null,this.endNode_=null,this.startOffset_=-1,this.endOffset_=-1,this.range_=e,this.doc_=o},goog.inherits(goog.dom.browserrange.IeRange,goog.dom.browserrange.AbstractRange),goog.dom.browserrange.IeRange.logger_=goog.log.getLogger("goog.dom.browserrange.IeRange"),goog.dom.browserrange.IeRange.getBrowserRangeForNode_=function(e){var o=goog.dom.getOwnerDocument(e).body.createTextRange();if(e.nodeType==goog.dom.NodeType.ELEMENT)o.moveToElementText(e),goog.dom.browserrange.canContainRangeEndpoint(e)&&!e.childNodes.length&&o.collapse(!1);else{for(var t=0,r=e;r=r.previousSibling;){var n=r.nodeType;if(n==goog.dom.NodeType.TEXT)t+=r.length;else if(n==goog.dom.NodeType.ELEMENT){o.moveToElementText(r);break}}r||o.moveToElementText(e.parentNode),o.collapse(!r),t&&o.move("character",t),o.moveEnd("character",e.length)}return o},goog.dom.browserrange.IeRange.getBrowserRangeForNodes_=function(e,o,t,r){var n,g=!1;e.nodeType==goog.dom.NodeType.ELEMENT&&(o>e.childNodes.length&&goog.log.error(goog.dom.browserrange.IeRange.logger_,"Cannot have startOffset > startNode child count"),g=!(n=e.childNodes[o]),e=n||e.lastChild||e,o=0);var a=goog.dom.browserrange.IeRange.getBrowserRangeForNode_(e);if(o&&a.move("character",o),e==t&&o==r)return a.collapse(!0),a;g&&a.collapse(!1),g=!1,t.nodeType==goog.dom.NodeType.ELEMENT&&(r>t.childNodes.length&&goog.log.error(goog.dom.browserrange.IeRange.logger_,"Cannot have endOffset > endNode child count"),t=(n=t.childNodes[r])||t.lastChild||t,r=0,g=!n);var s=goog.dom.browserrange.IeRange.getBrowserRangeForNode_(t);return s.collapse(!g),r&&s.moveEnd("character",r),a.setEndPoint("EndToEnd",s),a},goog.dom.browserrange.IeRange.createFromNodeContents=function(e){var o=new goog.dom.browserrange.IeRange(goog.dom.browserrange.IeRange.getBrowserRangeForNode_(e),goog.dom.getOwnerDocument(e));if(goog.dom.browserrange.canContainRangeEndpoint(e)){for(var t,r=e;(t=r.firstChild)&&goog.dom.browserrange.canContainRangeEndpoint(t);)r=t;for(o.startNode_=r,o.startOffset_=0,r=e;(t=r.lastChild)&&goog.dom.browserrange.canContainRangeEndpoint(t);)r=t;o.endNode_=r,o.endOffset_=r.nodeType==goog.dom.NodeType.ELEMENT?r.childNodes.length:r.length,o.parentNode_=e}else o.startNode_=o.endNode_=o.parentNode_=e.parentNode,o.startOffset_=goog.array.indexOf(o.parentNode_.childNodes,e),o.endOffset_=o.startOffset_+1;return o},goog.dom.browserrange.IeRange.createFromNodes=function(e,o,t,r){var n=new goog.dom.browserrange.IeRange(goog.dom.browserrange.IeRange.getBrowserRangeForNodes_(e,o,t,r),goog.dom.getOwnerDocument(e));return n.startNode_=e,n.startOffset_=o,n.endNode_=t,n.endOffset_=r,n},goog.dom.browserrange.IeRange.prototype.clone=function(){var e=new goog.dom.browserrange.IeRange(this.range_.duplicate(),this.doc_);return e.parentNode_=this.parentNode_,e.startNode_=this.startNode_,e.endNode_=this.endNode_,e},goog.dom.browserrange.IeRange.prototype.getBrowserRange=function(){return this.range_},goog.dom.browserrange.IeRange.prototype.clearCachedValues_=function(){this.parentNode_=this.startNode_=this.endNode_=null,this.startOffset_=this.endOffset_=-1},goog.dom.browserrange.IeRange.prototype.getContainer=function(){if(!this.parentNode_){var e=this.range_.text,o=this.range_.duplicate(),t=e.replace(/ +$/,""),r=e.length-t.length;r&&o.moveEnd("character",-r);var n=o.parentElement(),g=o.htmlText,a=goog.string.stripNewlines(g).length;if(this.isCollapsed()&&a>0)return this.parentNode_=n;for(;a>goog.string.stripNewlines(n.outerHTML).length;)n=n.parentNode;for(;1==n.childNodes.length&&n.innerText==goog.dom.browserrange.IeRange.getNodeText_(n.firstChild)&&goog.dom.browserrange.canContainRangeEndpoint(n.firstChild);)n=n.firstChild;0==e.length&&(n=this.findDeepestContainer_(n)),this.parentNode_=n}return this.parentNode_},goog.dom.browserrange.IeRange.prototype.findDeepestContainer_=function(e){for(var o=e.childNodes,t=0,r=o.length;t<r;t++){var n=o[t];if(goog.dom.browserrange.canContainRangeEndpoint(n)){var g=goog.dom.browserrange.IeRange.getBrowserRangeForNode_(n),a=goog.dom.RangeEndpoint.START,s=goog.dom.RangeEndpoint.END,d=g.htmlText!=n.outerHTML;if(this.isCollapsed()&&d?this.compareBrowserRangeEndpoints(g,a,a)>=0&&this.compareBrowserRangeEndpoints(g,a,s)<=0:this.range_.inRange(g))return this.findDeepestContainer_(n)}}return e},goog.dom.browserrange.IeRange.prototype.getStartNode=function(){return this.startNode_||(this.startNode_=this.getEndpointNode_(goog.dom.RangeEndpoint.START),this.isCollapsed()&&(this.endNode_=this.startNode_)),this.startNode_},goog.dom.browserrange.IeRange.prototype.getStartOffset=function(){return this.startOffset_<0&&(this.startOffset_=this.getOffset_(goog.dom.RangeEndpoint.START),this.isCollapsed()&&(this.endOffset_=this.startOffset_)),this.startOffset_},goog.dom.browserrange.IeRange.prototype.getEndNode=function(){return this.isCollapsed()?this.getStartNode():(this.endNode_||(this.endNode_=this.getEndpointNode_(goog.dom.RangeEndpoint.END)),this.endNode_)},goog.dom.browserrange.IeRange.prototype.getEndOffset=function(){return this.isCollapsed()?this.getStartOffset():(this.endOffset_<0&&(this.endOffset_=this.getOffset_(goog.dom.RangeEndpoint.END),this.isCollapsed()&&(this.startOffset_=this.endOffset_)),this.endOffset_)},goog.dom.browserrange.IeRange.prototype.compareBrowserRangeEndpoints=function(e,o,t){return this.range_.compareEndPoints((o==goog.dom.RangeEndpoint.START?"Start":"End")+"To"+(t==goog.dom.RangeEndpoint.START?"Start":"End"),e)},goog.dom.browserrange.IeRange.prototype.getEndpointNode_=function(e,o){var t=o||this.getContainer();if(!t||!t.firstChild)return t;for(var r=goog.dom.RangeEndpoint.START,n=goog.dom.RangeEndpoint.END,g=e==r,a=0,s=t.childNodes.length;a<s;a++){var d,i=g?a:s-a-1,h=t.childNodes[i];try{d=goog.dom.browserrange.createRangeFromNodeContents(h)}catch(e){continue}var m=d.getBrowserRange();if(this.isCollapsed()){if(goog.dom.browserrange.canContainRangeEndpoint(h)){if(d.containsRange(this))return this.getEndpointNode_(e,h)}else if(0==this.compareBrowserRangeEndpoints(m,r,r))return this.startOffset_=this.endOffset_=i,t}else{if(this.containsRange(d))return goog.dom.browserrange.canContainRangeEndpoint(h)?this.getEndpointNode_(e,h):(g?this.startOffset_=i:this.endOffset_=i+1,t);if(this.compareBrowserRangeEndpoints(m,r,n)<0&&this.compareBrowserRangeEndpoints(m,n,r)>0)return this.getEndpointNode_(e,h)}}return t},goog.dom.browserrange.IeRange.prototype.compareNodeEndpoints_=function(e,o,t){return this.range_.compareEndPoints((o==goog.dom.RangeEndpoint.START?"Start":"End")+"To"+(t==goog.dom.RangeEndpoint.START?"Start":"End"),goog.dom.browserrange.createRangeFromNodeContents(e).getBrowserRange())},goog.dom.browserrange.IeRange.prototype.getOffset_=function(e,o){var t=e==goog.dom.RangeEndpoint.START,r=o||(t?this.getStartNode():this.getEndNode());if(r.nodeType==goog.dom.NodeType.ELEMENT){for(var n=r.childNodes,g=n.length,a=t?1:-1,s=t?0:g-1;s>=0&&s<g;s+=a){var d=n[s];if(!goog.dom.browserrange.canContainRangeEndpoint(d))if(0==this.compareNodeEndpoints_(d,e,e))return t?s:s+1}return-1==s?0:s}var i=this.range_.duplicate(),h=goog.dom.browserrange.IeRange.getBrowserRangeForNode_(r);i.setEndPoint(t?"EndToEnd":"StartToStart",h);var m=i.text.length;return t?r.length-m:m},goog.dom.browserrange.IeRange.getNodeText_=function(e){return e.nodeType==goog.dom.NodeType.TEXT?e.nodeValue:e.innerText},goog.dom.browserrange.IeRange.prototype.isRangeInDocument=function(){var e=this.doc_.body.createTextRange();return e.moveToElementText(this.doc_.body),this.containsRange(new goog.dom.browserrange.IeRange(e,this.doc_),!0)},goog.dom.browserrange.IeRange.prototype.isCollapsed=function(){return 0==this.range_.compareEndPoints("StartToEnd",this.range_)},goog.dom.browserrange.IeRange.prototype.getText=function(){return this.range_.text},goog.dom.browserrange.IeRange.prototype.getValidHtml=function(){return this.range_.htmlText},goog.dom.browserrange.IeRange.prototype.select=function(e){this.range_.select()},goog.dom.browserrange.IeRange.prototype.removeContents=function(){if(!this.isCollapsed()&&this.range_.htmlText){var e=this.getStartNode(),o=this.getEndNode(),t=this.range_.text,r=this.range_.duplicate();r.moveStart("character",1),r.moveStart("character",-1),r.text==t&&(this.range_=r),this.range_.text="",this.clearCachedValues_();var n=this.getStartNode(),g=this.getStartOffset();try{var a=e.nextSibling;e==o&&e.parentNode&&e.nodeType==goog.dom.NodeType.TEXT&&a&&a.nodeType==goog.dom.NodeType.TEXT&&(e.nodeValue+=a.nodeValue,goog.dom.removeNode(a),this.range_=goog.dom.browserrange.IeRange.getBrowserRangeForNode_(n),this.range_.move("character",g),this.clearCachedValues_())}catch(e){}}},goog.dom.browserrange.IeRange.getDomHelper_=function(e){return goog.dom.getDomHelper(e.parentElement())},goog.dom.browserrange.IeRange.pasteElement_=function(e,o,t){var r;t=t||goog.dom.browserrange.IeRange.getDomHelper_(e);var n=r=o.id;return r||(r=o.id=goog.string.createUniqueString()),e.pasteHTML(o.outerHTML),(o=t.getElement(r))&&(n||o.removeAttribute("id")),o},goog.dom.browserrange.IeRange.prototype.surroundContents=function(e){return goog.dom.removeNode(e),goog.dom.safe.setInnerHtml(goog.asserts.assert(e),goog.html.uncheckedconversions.safeHtmlFromStringKnownToSatisfyTypeContract(goog.string.Const.from("IE more or less guarantees that range.htmlText is well-formed & valid."),this.range_.htmlText)),(e=goog.dom.browserrange.IeRange.pasteElement_(this.range_,e))&&this.range_.moveToElementText(e),this.clearCachedValues_(),e},goog.dom.browserrange.IeRange.insertNode_=function(e,o,t,r){var n;if(r=r||goog.dom.browserrange.IeRange.getDomHelper_(e),o.nodeType!=goog.dom.NodeType.ELEMENT&&(n=!0,o=r.createDom(goog.dom.TagName.DIV,null,o)),e.collapse(t),o=goog.dom.browserrange.IeRange.pasteElement_(e,o,r),n){var g=o.firstChild;r.flattenElement(o),o=g}return o},goog.dom.browserrange.IeRange.prototype.insertNode=function(e,o){var t=goog.dom.browserrange.IeRange.insertNode_(this.range_.duplicate(),e,o);return this.clearCachedValues_(),t},goog.dom.browserrange.IeRange.prototype.surroundWithNodes=function(e,o){var t=this.range_.duplicate(),r=this.range_.duplicate();goog.dom.browserrange.IeRange.insertNode_(t,e,!0),goog.dom.browserrange.IeRange.insertNode_(r,o,!1),this.clearCachedValues_()},goog.dom.browserrange.IeRange.prototype.collapse=function(e){this.range_.collapse(e),e?(this.endNode_=this.startNode_,this.endOffset_=this.startOffset_):(this.startNode_=this.endNode_,this.startOffset_=this.endOffset_)};