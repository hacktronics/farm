goog.provide("goog.Promise"),goog.require("goog.Thenable"),goog.require("goog.asserts"),goog.require("goog.async.FreeList"),goog.require("goog.async.run"),goog.require("goog.async.throwException"),goog.require("goog.debug.Error"),goog.require("goog.promise.Resolver"),goog.Promise=function(o,e){if(this.state_=goog.Promise.State_.PENDING,this.result_=void 0,this.parent_=null,this.callbackEntries_=null,this.callbackEntriesTail_=null,this.executing_=!1,goog.Promise.UNHANDLED_REJECTION_DELAY>0?this.unhandledRejectionId_=0:0==goog.Promise.UNHANDLED_REJECTION_DELAY&&(this.hadUnhandledRejection_=!1),goog.Promise.LONG_STACK_TRACES&&(this.stack_=[],this.addStackTrace_(new Error("created")),this.currentStep_=0),o!=goog.nullFunction)try{var t=this;o.call(e,function(o){t.resolve_(goog.Promise.State_.FULFILLED,o)},function(o){if(goog.DEBUG&&!(o instanceof goog.Promise.CancellationError))try{throw o instanceof Error?o:new Error("Promise rejected.")}catch(o){}t.resolve_(goog.Promise.State_.REJECTED,o)})}catch(o){this.resolve_(goog.Promise.State_.REJECTED,o)}},goog.Promise.LONG_STACK_TRACES=goog.define("goog.Promise.LONG_STACK_TRACES",!1),goog.Promise.UNHANDLED_REJECTION_DELAY=goog.define("goog.Promise.UNHANDLED_REJECTION_DELAY",0),goog.Promise.State_={PENDING:0,BLOCKED:1,FULFILLED:2,REJECTED:3},goog.Promise.CallbackEntry_=function(){this.child=null,this.onFulfilled=null,this.onRejected=null,this.context=null,this.next=null,this.always=!1},goog.Promise.CallbackEntry_.prototype.reset=function(){this.child=null,this.onFulfilled=null,this.onRejected=null,this.context=null,this.always=!1},goog.Promise.DEFAULT_MAX_UNUSED=goog.define("goog.Promise.DEFAULT_MAX_UNUSED",100),goog.Promise.freelist_=new goog.async.FreeList(function(){return new goog.Promise.CallbackEntry_},function(o){o.reset()},goog.Promise.DEFAULT_MAX_UNUSED),goog.Promise.getCallbackEntry_=function(o,e,t){var n=goog.Promise.freelist_.get();return n.onFulfilled=o,n.onRejected=e,n.context=t,n},goog.Promise.returnEntry_=function(o){goog.Promise.freelist_.put(o)},goog.Promise.resolve=function(o){if(o instanceof goog.Promise)return o;var e=new goog.Promise(goog.nullFunction);return e.resolve_(goog.Promise.State_.FULFILLED,o),e},goog.Promise.reject=function(o){return new goog.Promise(function(e,t){t(o)})},goog.Promise.resolveThen_=function(o,e,t){goog.Promise.maybeThen_(o,e,t,null)||goog.async.run(goog.partial(e,o))},goog.Promise.race=function(o){return new goog.Promise(function(e,t){o.length||e(void 0);for(var n,i=0;i<o.length;i++)n=o[i],goog.Promise.resolveThen_(n,e,t)})},goog.Promise.all=function(o){return new goog.Promise(function(e,t){var n=o.length,i=[];if(n)for(var r,s=function(o,t){n--,i[o]=t,0==n&&e(i)},g=function(o){t(o)},l=0;l<o.length;l++)r=o[l],goog.Promise.resolveThen_(r,goog.partial(s,l),g);else e(i)})},goog.Promise.allSettled=function(o){return new goog.Promise(function(e,t){var n=o.length,i=[];if(n)for(var r,s=function(o,t,r){n--,i[o]=t?{fulfilled:!0,value:r}:{fulfilled:!1,reason:r},0==n&&e(i)},g=0;g<o.length;g++)r=o[g],goog.Promise.resolveThen_(r,goog.partial(s,g,!0),goog.partial(s,g,!1));else e(i)})},goog.Promise.firstFulfilled=function(o){return new goog.Promise(function(e,t){var n=o.length,i=[];if(n)for(var r,s=function(o){e(o)},g=function(o,e){n--,i[o]=e,0==n&&t(i)},l=0;l<o.length;l++)r=o[l],goog.Promise.resolveThen_(r,s,goog.partial(g,l));else e(void 0)})},goog.Promise.withResolver=function(){var o,e,t=new goog.Promise(function(t,n){o=t,e=n});return new goog.Promise.Resolver_(t,o,e)},goog.Promise.prototype.then=function(o,e,t){return null!=o&&goog.asserts.assertFunction(o,"opt_onFulfilled should be a function."),null!=e&&goog.asserts.assertFunction(e,"opt_onRejected should be a function. Did you pass opt_context as the second argument instead of the third?"),goog.Promise.LONG_STACK_TRACES&&this.addStackTrace_(new Error("then")),this.addChildPromise_(goog.isFunction(o)?o:null,goog.isFunction(e)?e:null,t)},goog.Thenable.addImplementation(goog.Promise),goog.Promise.prototype.thenVoid=function(o,e,t){null!=o&&goog.asserts.assertFunction(o,"opt_onFulfilled should be a function."),null!=e&&goog.asserts.assertFunction(e,"opt_onRejected should be a function. Did you pass opt_context as the second argument instead of the third?"),goog.Promise.LONG_STACK_TRACES&&this.addStackTrace_(new Error("then")),this.addCallbackEntry_(goog.Promise.getCallbackEntry_(o||goog.nullFunction,e||null,t))},goog.Promise.prototype.thenAlways=function(o,e){goog.Promise.LONG_STACK_TRACES&&this.addStackTrace_(new Error("thenAlways"));var t=goog.Promise.getCallbackEntry_(o,o,e);return t.always=!0,this.addCallbackEntry_(t),this},goog.Promise.prototype.thenCatch=function(o,e){return goog.Promise.LONG_STACK_TRACES&&this.addStackTrace_(new Error("thenCatch")),this.addChildPromise_(null,o,e)},goog.Promise.prototype.cancel=function(o){if(this.state_==goog.Promise.State_.PENDING){var e=new goog.Promise.CancellationError(o);goog.async.run(function(){this.cancelInternal_(e)},this)}},goog.Promise.prototype.cancelInternal_=function(o){this.state_==goog.Promise.State_.PENDING&&(this.parent_?(this.parent_.cancelChild_(this,o),this.parent_=null):this.resolve_(goog.Promise.State_.REJECTED,o))},goog.Promise.prototype.cancelChild_=function(o,e){if(this.callbackEntries_){for(var t=0,n=null,i=null,r=this.callbackEntries_;r&&(r.always||(t++,r.child==o&&(n=r),!(n&&t>1)));r=r.next)n||(i=r);n&&(this.state_==goog.Promise.State_.PENDING&&1==t?this.cancelInternal_(e):(i?this.removeEntryAfter_(i):this.popEntry_(),this.executeCallback_(n,goog.Promise.State_.REJECTED,e)))}},goog.Promise.prototype.addCallbackEntry_=function(o){this.hasEntry_()||this.state_!=goog.Promise.State_.FULFILLED&&this.state_!=goog.Promise.State_.REJECTED||this.scheduleCallbacks_(),this.queueEntry_(o)},goog.Promise.prototype.addChildPromise_=function(o,e,t){var n=goog.Promise.getCallbackEntry_(null,null,null);return n.child=new goog.Promise(function(i,r){n.onFulfilled=o?function(e){try{var n=o.call(t,e);i(n)}catch(o){r(o)}}:i,n.onRejected=e?function(o){try{var n=e.call(t,o);void 0===n&&o instanceof goog.Promise.CancellationError?r(o):i(n)}catch(o){r(o)}}:r}),n.child.parent_=this,this.addCallbackEntry_(n),n.child},goog.Promise.prototype.unblockAndFulfill_=function(o){goog.asserts.assert(this.state_==goog.Promise.State_.BLOCKED),this.state_=goog.Promise.State_.PENDING,this.resolve_(goog.Promise.State_.FULFILLED,o)},goog.Promise.prototype.unblockAndReject_=function(o){goog.asserts.assert(this.state_==goog.Promise.State_.BLOCKED),this.state_=goog.Promise.State_.PENDING,this.resolve_(goog.Promise.State_.REJECTED,o)},goog.Promise.prototype.resolve_=function(o,e){this.state_==goog.Promise.State_.PENDING&&(this===e&&(o=goog.Promise.State_.REJECTED,e=new TypeError("Promise cannot resolve to itself")),this.state_=goog.Promise.State_.BLOCKED,goog.Promise.maybeThen_(e,this.unblockAndFulfill_,this.unblockAndReject_,this)||(this.result_=e,this.state_=o,this.parent_=null,this.scheduleCallbacks_(),o!=goog.Promise.State_.REJECTED||e instanceof goog.Promise.CancellationError||goog.Promise.addUnhandledRejection_(this,e)))},goog.Promise.maybeThen_=function(o,e,t,n){if(o instanceof goog.Promise)return o.thenVoid(e,t,n),!0;if(goog.Thenable.isImplementedBy(o))return o.then(e,t,n),!0;if(goog.isObject(o)){const r=o;try{var i=r.then;if(goog.isFunction(i))return goog.Promise.tryThen_(r,i,e,t,n),!0}catch(o){return t.call(n,o),!0}}return!1},goog.Promise.tryThen_=function(o,e,t,n,i){var r=!1,s=function(o){r||(r=!0,n.call(i,o))};try{e.call(o,function(o){r||(r=!0,t.call(i,o))},s)}catch(o){s(o)}},goog.Promise.prototype.scheduleCallbacks_=function(){this.executing_||(this.executing_=!0,goog.async.run(this.executeCallbacks_,this))},goog.Promise.prototype.hasEntry_=function(){return!!this.callbackEntries_},goog.Promise.prototype.queueEntry_=function(o){goog.asserts.assert(null!=o.onFulfilled),this.callbackEntriesTail_?(this.callbackEntriesTail_.next=o,this.callbackEntriesTail_=o):(this.callbackEntries_=o,this.callbackEntriesTail_=o)},goog.Promise.prototype.popEntry_=function(){var o=null;return this.callbackEntries_&&(o=this.callbackEntries_,this.callbackEntries_=o.next,o.next=null),this.callbackEntries_||(this.callbackEntriesTail_=null),null!=o&&goog.asserts.assert(null!=o.onFulfilled),o},goog.Promise.prototype.removeEntryAfter_=function(o){goog.asserts.assert(this.callbackEntries_),goog.asserts.assert(null!=o),o.next==this.callbackEntriesTail_&&(this.callbackEntriesTail_=o),o.next=o.next.next},goog.Promise.prototype.executeCallbacks_=function(){for(var o=null;o=this.popEntry_();)goog.Promise.LONG_STACK_TRACES&&this.currentStep_++,this.executeCallback_(o,this.state_,this.result_);this.executing_=!1},goog.Promise.prototype.executeCallback_=function(o,e,t){if(e==goog.Promise.State_.REJECTED&&o.onRejected&&!o.always&&this.removeUnhandledRejection_(),o.child)o.child.parent_=null,goog.Promise.invokeCallback_(o,e,t);else try{o.always?o.onFulfilled.call(o.context):goog.Promise.invokeCallback_(o,e,t)}catch(o){goog.Promise.handleRejection_.call(null,o)}goog.Promise.returnEntry_(o)},goog.Promise.invokeCallback_=function(o,e,t){e==goog.Promise.State_.FULFILLED?o.onFulfilled.call(o.context,t):o.onRejected&&o.onRejected.call(o.context,t)},goog.Promise.prototype.addStackTrace_=function(o){if(goog.Promise.LONG_STACK_TRACES&&"string"==typeof o.stack){var e=o.stack.split("\n",4)[3],t=o.message;t+=Array(11-t.length).join(" "),this.stack_.push(t+e)}},goog.Promise.prototype.appendLongStack_=function(o){if(goog.Promise.LONG_STACK_TRACES&&o&&"string"==typeof o.stack&&this.stack_.length){for(var e=["Promise trace:"],t=this;t;t=t.parent_){for(var n=this.currentStep_;n>=0;n--)e.push(t.stack_[n]);e.push("Value: ["+(t.state_==goog.Promise.State_.REJECTED?"REJECTED":"FULFILLED")+"] <"+String(t.result_)+">")}o.stack+="\n\n"+e.join("\n")}},goog.Promise.prototype.removeUnhandledRejection_=function(){if(goog.Promise.UNHANDLED_REJECTION_DELAY>0)for(var o=this;o&&o.unhandledRejectionId_;o=o.parent_)goog.global.clearTimeout(o.unhandledRejectionId_),o.unhandledRejectionId_=0;else if(0==goog.Promise.UNHANDLED_REJECTION_DELAY)for(o=this;o&&o.hadUnhandledRejection_;o=o.parent_)o.hadUnhandledRejection_=!1},goog.Promise.addUnhandledRejection_=function(o,e){goog.Promise.UNHANDLED_REJECTION_DELAY>0?o.unhandledRejectionId_=goog.global.setTimeout(function(){o.appendLongStack_(e),goog.Promise.handleRejection_.call(null,e)},goog.Promise.UNHANDLED_REJECTION_DELAY):0==goog.Promise.UNHANDLED_REJECTION_DELAY&&(o.hadUnhandledRejection_=!0,goog.async.run(function(){o.hadUnhandledRejection_&&(o.appendLongStack_(e),goog.Promise.handleRejection_.call(null,e))}))},goog.Promise.handleRejection_=goog.async.throwException,goog.Promise.setUnhandledRejectionHandler=function(o){goog.Promise.handleRejection_=o},goog.Promise.CancellationError=function(o){goog.Promise.CancellationError.base(this,"constructor",o)},goog.inherits(goog.Promise.CancellationError,goog.debug.Error),goog.Promise.CancellationError.prototype.name="cancel",goog.Promise.Resolver_=function(o,e,t){this.promise=o,this.resolve=e,this.reject=t};