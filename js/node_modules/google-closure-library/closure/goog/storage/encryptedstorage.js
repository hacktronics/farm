goog.provide("goog.storage.EncryptedStorage"),goog.forwardDeclare("goog.storage.mechanism.IterableMechanism"),goog.require("goog.crypt"),goog.require("goog.crypt.Arc4"),goog.require("goog.crypt.Sha1"),goog.require("goog.crypt.base64"),goog.require("goog.json"),goog.require("goog.json.Serializer"),goog.require("goog.storage.CollectableStorage"),goog.require("goog.storage.ErrorCode"),goog.require("goog.storage.RichStorage"),goog.storage.EncryptedStorage=function(o,r){goog.storage.EncryptedStorage.base(this,"constructor",o),this.secret_=goog.crypt.stringToByteArray(r),this.cleartextSerializer_=new goog.json.Serializer},goog.inherits(goog.storage.EncryptedStorage,goog.storage.CollectableStorage),goog.storage.EncryptedStorage.SALT_KEY="salt",goog.storage.EncryptedStorage.prototype.hashKeyWithSecret_=function(o){var r=new goog.crypt.Sha1;return r.update(goog.crypt.stringToByteArray(o)),r.update(this.secret_),goog.crypt.base64.encodeByteArray(r.digest(),goog.crypt.base64.Alphabet.WEBSAFE_DOT_PADDING)},goog.storage.EncryptedStorage.prototype.encryptValue_=function(o,r,e){if(!(o.length>0))throw new Error("Non-empty salt must be provided");var t=new goog.crypt.Sha1;t.update(goog.crypt.stringToByteArray(r)),t.update(o),t.update(this.secret_);var g=new goog.crypt.Arc4;g.setKey(t.digest()),g.discard(1536);var a=goog.crypt.stringToByteArray(e);return g.crypt(a),goog.crypt.byteArrayToString(a)},goog.storage.EncryptedStorage.prototype.decryptValue_=function(o,r,e){return this.encryptValue_(o,r,e)},goog.storage.EncryptedStorage.prototype.set=function(o,r,e){if(void 0!==r){for(var t=[],g=0;g<8;++g)t[g]=Math.floor(256*Math.random());var a=new goog.storage.RichStorage.Wrapper(this.encryptValue_(t,o,this.cleartextSerializer_.serialize(r)));a[goog.storage.EncryptedStorage.SALT_KEY]=t,goog.storage.EncryptedStorage.base(this,"set",this.hashKeyWithSecret_(o),a,e)}else goog.storage.EncryptedStorage.prototype.remove.call(this,o)},goog.storage.EncryptedStorage.prototype.getWrapper=function(o,r){var e=goog.storage.EncryptedStorage.base(this,"getWrapper",this.hashKeyWithSecret_(o),r);if(e){var t=goog.storage.RichStorage.Wrapper.unwrap(e),g=e[goog.storage.EncryptedStorage.SALT_KEY];if("string"!=typeof t||!goog.isArray(g)||!g.length)throw goog.storage.ErrorCode.INVALID_VALUE;var a=this.decryptValue_(g,o,t);try{e[goog.storage.RichStorage.DATA_KEY]=JSON.parse(a)}catch(o){throw goog.storage.ErrorCode.DECRYPTION_ERROR}return e}},goog.storage.EncryptedStorage.prototype.remove=function(o){goog.storage.EncryptedStorage.base(this,"remove",this.hashKeyWithSecret_(o))};