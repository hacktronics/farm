goog.provide("goog.ui.ac.InputHandler"),goog.require("goog.Disposable"),goog.require("goog.Timer"),goog.require("goog.a11y.aria"),goog.require("goog.a11y.aria.Role"),goog.require("goog.a11y.aria.State"),goog.require("goog.dom"),goog.require("goog.dom.selection"),goog.require("goog.events.EventHandler"),goog.require("goog.events.EventType"),goog.require("goog.events.KeyCodes"),goog.require("goog.events.KeyHandler"),goog.require("goog.string"),goog.require("goog.userAgent"),goog.require("goog.userAgent.product"),goog.ui.ac.InputHandler=function(e,t,o,i){goog.Disposable.call(this);var n=i||150;this.multi_=null==o||o,this.setSeparators(e||goog.ui.ac.InputHandler.STANDARD_LIST_SEPARATORS),this.literals_=t||"",this.preventSelectionOnTab_=!1,this.preventDefaultOnTab_=this.multi_,this.timer_=n>0?new goog.Timer(n):null,this.eh_=new goog.events.EventHandler(this),this.activateHandler_=new goog.events.EventHandler(this),this.keyHandler_=new goog.events.KeyHandler,this.lastKeyCode_=-1},goog.inherits(goog.ui.ac.InputHandler,goog.Disposable),goog.tagUnsealableClass(goog.ui.ac.InputHandler),goog.ui.ac.InputHandler.REQUIRES_ASYNC_BLUR_=(goog.userAgent.product.IPHONE||goog.userAgent.product.IPAD)&&!goog.userAgent.isVersionOrHigher("533.17.9"),goog.ui.ac.InputHandler.STANDARD_LIST_SEPARATORS=",;",goog.ui.ac.InputHandler.QUOTE_LITERALS='"',goog.ui.ac.InputHandler.prototype.ac_,goog.ui.ac.InputHandler.prototype.separators_,goog.ui.ac.InputHandler.prototype.defaultSeparator_,goog.ui.ac.InputHandler.prototype.trimmer_,goog.ui.ac.InputHandler.prototype.separatorCheck_,goog.ui.ac.InputHandler.prototype.whitespaceWrapEntries_=!0,goog.ui.ac.InputHandler.prototype.generateNewTokenOnLiteral_=!0,goog.ui.ac.InputHandler.prototype.upsideDown_=!1,goog.ui.ac.InputHandler.prototype.separatorUpdates_=!0,goog.ui.ac.InputHandler.prototype.separatorSelects_=!0,goog.ui.ac.InputHandler.prototype.activeTimeoutId_=null,goog.ui.ac.InputHandler.prototype.activeElement_=null,goog.ui.ac.InputHandler.prototype.lastValue_="",goog.ui.ac.InputHandler.prototype.waitingForIme_=!1,goog.ui.ac.InputHandler.prototype.rowJustSelected_=!1,goog.ui.ac.InputHandler.prototype.updateDuringTyping_=!0,goog.ui.ac.InputHandler.prototype.attachAutoComplete=function(e){this.ac_=e},goog.ui.ac.InputHandler.prototype.getAutoComplete=function(){return this.ac_},goog.ui.ac.InputHandler.prototype.getActiveElement=function(){return this.activeElement_},goog.ui.ac.InputHandler.prototype.getValue=function(){return this.activeElement_.value},goog.ui.ac.InputHandler.prototype.setValue=function(e){this.activeElement_.value=e},goog.ui.ac.InputHandler.prototype.getCursorPosition=function(){return goog.dom.selection.getStart(this.activeElement_)},goog.ui.ac.InputHandler.prototype.setCursorPosition=function(e){goog.dom.selection.setStart(this.activeElement_,e),goog.dom.selection.setEnd(this.activeElement_,e)},goog.ui.ac.InputHandler.prototype.attachInput=function(e){if(goog.dom.isElement(e)){var t=e;goog.a11y.aria.setRole(t,goog.a11y.aria.Role.COMBOBOX),goog.a11y.aria.setState(t,goog.a11y.aria.State.AUTOCOMPLETE,"list")}if(this.eh_.listen(e,goog.events.EventType.FOCUS,this.handleFocus),this.eh_.listen(e,goog.events.EventType.BLUR,this.handleBlur),!this.activeElement_&&(this.activateHandler_.listen(e,goog.events.EventType.KEYDOWN,this.onKeyDownOnInactiveElement_),goog.dom.isElement(e))){var o=goog.dom.getOwnerDocument(e);goog.dom.getActiveElement(o)==e&&this.processFocus(e)}},goog.ui.ac.InputHandler.prototype.detachInput=function(e){if(goog.dom.isElement(e)){var t=e;goog.a11y.aria.removeRole(t),goog.a11y.aria.removeState(t,goog.a11y.aria.State.AUTOCOMPLETE)}e==this.activeElement_&&this.handleBlur(),this.eh_.unlisten(e,goog.events.EventType.FOCUS,this.handleFocus),this.eh_.unlisten(e,goog.events.EventType.BLUR,this.handleBlur),this.activeElement_||this.activateHandler_.unlisten(e,goog.events.EventType.KEYDOWN,this.onKeyDownOnInactiveElement_)},goog.ui.ac.InputHandler.prototype.attachInputs=function(e){for(var t=0;t<arguments.length;t++)this.attachInput(arguments[t])},goog.ui.ac.InputHandler.prototype.detachInputs=function(e){for(var t=0;t<arguments.length;t++)this.detachInput(arguments[t])},goog.ui.ac.InputHandler.prototype.selectRow=function(e,t){return this.activeElement_&&this.setTokenText(e.toString(),t),!1},goog.ui.ac.InputHandler.prototype.setTokenText=function(e,t){if(void 0!==t?t:this.multi_){var o=this.getTokenIndex_(this.getValue(),this.getCursorPosition()),i=this.splitInput_(this.getValue()),n=e;if(this.separatorCheck_&&!this.separatorCheck_.test(n)&&(n=goog.string.trimRight(n)+this.defaultSeparator_),this.whitespaceWrapEntries_&&(0==o||goog.string.isEmptyOrWhitespace(i[o-1])||(n=" "+n),o==i.length-1&&(n+=" ")),n!=i[o]){i[o]=n;var s=this.activeElement_;(goog.userAgent.GECKO||goog.userAgent.IE&&goog.userAgent.isVersionOrHigher("9"))&&s.blur(),s.value=i.join("");for(var r=0,a=0;a<=o;a++)r+=i[a].length;s.focus(),this.setCursorPosition(r)}}else this.setValue(e);this.rowJustSelected_=!0},goog.ui.ac.InputHandler.prototype.disposeInternal=function(){goog.ui.ac.InputHandler.superClass_.disposeInternal.call(this),null!=this.activeTimeoutId_&&window.clearTimeout(this.activeTimeoutId_),this.eh_.dispose(),delete this.eh_,this.activateHandler_.dispose(),this.keyHandler_.dispose(),goog.dispose(this.timer_)},goog.ui.ac.InputHandler.prototype.setSeparators=function(e,t){this.separators_=e,this.defaultSeparator_=null!=t?t:this.separators_.substring(0,1);var o=this.multi_?"[\\s"+this.separators_+"]+":"[\\s]+";this.trimmer_=new RegExp("^"+o+"|"+o+"$","g"),this.separatorCheck_=new RegExp("\\s*["+this.separators_+"]$")},goog.ui.ac.InputHandler.prototype.setUpsideDown=function(e){this.upsideDown_=e},goog.ui.ac.InputHandler.prototype.setWhitespaceWrapEntries=function(e){this.whitespaceWrapEntries_=e},goog.ui.ac.InputHandler.prototype.setGenerateNewTokenOnLiteral=function(e){this.generateNewTokenOnLiteral_=e},goog.ui.ac.InputHandler.prototype.setTrimmingRegExp=function(e){this.trimmer_=e},goog.ui.ac.InputHandler.prototype.setEndsWithSeparatorRegExp=function(e){this.separatorCheck_=e},goog.ui.ac.InputHandler.prototype.setPreventDefaultOnTab=function(e){this.preventDefaultOnTab_=e},goog.ui.ac.InputHandler.prototype.setPreventSelectionOnTab=function(e){this.preventSelectionOnTab_=e},goog.ui.ac.InputHandler.prototype.setSeparatorCompletes=function(e){this.separatorUpdates_=e,this.separatorSelects_=e},goog.ui.ac.InputHandler.prototype.setSeparatorSelects=function(e){this.separatorSelects_=e},goog.ui.ac.InputHandler.prototype.getThrottleTime=function(){return this.timer_?this.timer_.getInterval():-1},goog.ui.ac.InputHandler.prototype.setRowJustSelected=function(e){this.rowJustSelected_=e},goog.ui.ac.InputHandler.prototype.setThrottleTime=function(e){if(e<0)return this.timer_.dispose(),void(this.timer_=null);this.timer_?this.timer_.setInterval(e):this.timer_=new goog.Timer(e)},goog.ui.ac.InputHandler.prototype.getUpdateDuringTyping=function(){return this.updateDuringTyping_},goog.ui.ac.InputHandler.prototype.setUpdateDuringTyping=function(e){this.updateDuringTyping_=e},goog.ui.ac.InputHandler.prototype.handleKeyEvent=function(e){switch(e.keyCode){case goog.events.KeyCodes.DOWN:if(this.ac_.isOpen())return this.moveDown_(),e.preventDefault(),!0;if(!this.multi_)return this.update(!0),e.preventDefault(),!0;break;case goog.events.KeyCodes.UP:if(this.ac_.isOpen())return this.moveUp_(),e.preventDefault(),!0;break;case goog.events.KeyCodes.TAB:if(!this.ac_.isOpen()||e.shiftKey||this.preventSelectionOnTab_)this.ac_.dismiss();else if(this.update(),this.ac_.selectHilited()&&this.preventDefaultOnTab_)return e.preventDefault(),!0;break;case goog.events.KeyCodes.ENTER:if(this.ac_.isOpen()){if(this.update(),this.ac_.selectHilited())return e.preventDefault(),e.stopPropagation(),!0}else this.ac_.dismiss();break;case goog.events.KeyCodes.ESC:if(this.ac_.isOpen())return this.ac_.dismiss(),e.preventDefault(),e.stopPropagation(),!0;break;case goog.events.KeyCodes.WIN_IME:if(!this.waitingForIme_)return this.startWaitingForIme_(),!0;break;default:this.timer_&&!this.updateDuringTyping_&&(this.timer_.stop(),this.timer_.start())}return this.handleSeparator_(e)},goog.ui.ac.InputHandler.prototype.handleSeparator_=function(e){var t=this.multi_&&e.charCode&&-1!=this.separators_.indexOf(String.fromCharCode(e.charCode));return this.separatorUpdates_&&t&&this.update(),!!(this.separatorSelects_&&t&&this.ac_.selectHilited())&&(e.preventDefault(),!0)},goog.ui.ac.InputHandler.prototype.needKeyUpListener=function(){return!1},goog.ui.ac.InputHandler.prototype.handleKeyUp=function(e){return!1},goog.ui.ac.InputHandler.prototype.addEventHandlers_=function(){this.keyHandler_.attach(this.activeElement_),this.eh_.listen(this.keyHandler_,goog.events.KeyHandler.EventType.KEY,this.onKey_),this.needKeyUpListener()&&this.eh_.listen(this.activeElement_,goog.events.EventType.KEYUP,this.handleKeyUp),this.eh_.listen(this.activeElement_,goog.events.EventType.MOUSEDOWN,this.onMouseDown_),goog.userAgent.IE&&this.eh_.listen(this.activeElement_,goog.events.EventType.KEYPRESS,this.onIeKeyPress_)},goog.ui.ac.InputHandler.prototype.removeEventHandlers_=function(){this.eh_.unlisten(this.keyHandler_,goog.events.KeyHandler.EventType.KEY,this.onKey_),this.keyHandler_.detach(),this.eh_.unlisten(this.activeElement_,goog.events.EventType.KEYUP,this.handleKeyUp),this.eh_.unlisten(this.activeElement_,goog.events.EventType.MOUSEDOWN,this.onMouseDown_),goog.userAgent.IE&&this.eh_.unlisten(this.activeElement_,goog.events.EventType.KEYPRESS,this.onIeKeyPress_),this.waitingForIme_&&this.stopWaitingForIme_()},goog.ui.ac.InputHandler.prototype.handleFocus=function(e){this.processFocus(e.target||null)},goog.ui.ac.InputHandler.prototype.processFocus=function(e){this.activateHandler_.removeAll(),this.ac_&&this.ac_.cancelDelayedDismiss(),e!=this.activeElement_&&(this.activeElement_=e,this.timer_&&(this.timer_.start(),this.eh_.listen(this.timer_,goog.Timer.TICK,this.onTick_)),this.lastValue_=this.getValue(),this.addEventHandlers_())},goog.ui.ac.InputHandler.prototype.handleBlur=function(e){goog.ui.ac.InputHandler.REQUIRES_ASYNC_BLUR_?this.activeTimeoutId_=window.setTimeout(goog.bind(this.processBlur,this),0):this.processBlur()},goog.ui.ac.InputHandler.prototype.processBlur=function(){this.activeElement_&&(this.removeEventHandlers_(),this.activeElement_=null,this.timer_&&(this.timer_.stop(),this.eh_.unlisten(this.timer_,goog.Timer.TICK,this.onTick_)),this.ac_&&this.ac_.dismissOnDelay())},goog.ui.ac.InputHandler.prototype.onTick_=function(e){this.update()},goog.ui.ac.InputHandler.prototype.onKeyDownOnInactiveElement_=function(e){this.handleFocus(e)},goog.ui.ac.InputHandler.prototype.onKey_=function(e){this.lastKeyCode_=e.keyCode,this.ac_&&this.handleKeyEvent(e)},goog.ui.ac.InputHandler.prototype.onKeyPress_=function(e){this.waitingForIme_&&this.lastKeyCode_!=goog.events.KeyCodes.WIN_IME&&this.stopWaitingForIme_()},goog.ui.ac.InputHandler.prototype.onKeyUp_=function(e){this.waitingForIme_&&(e.keyCode==goog.events.KeyCodes.ENTER||e.keyCode==goog.events.KeyCodes.M&&e.ctrlKey)&&this.stopWaitingForIme_()},goog.ui.ac.InputHandler.prototype.onMouseDown_=function(e){this.ac_&&this.handleMouseDown(e)},goog.ui.ac.InputHandler.prototype.handleMouseDown=function(e){},goog.ui.ac.InputHandler.prototype.startWaitingForIme_=function(){this.waitingForIme_||(this.eh_.listen(this.activeElement_,goog.events.EventType.KEYUP,this.onKeyUp_),this.eh_.listen(this.activeElement_,goog.events.EventType.KEYPRESS,this.onKeyPress_),this.waitingForIme_=!0)},goog.ui.ac.InputHandler.prototype.stopWaitingForIme_=function(){this.waitingForIme_&&(this.waitingForIme_=!1,this.eh_.unlisten(this.activeElement_,goog.events.EventType.KEYPRESS,this.onKeyPress_),this.eh_.unlisten(this.activeElement_,goog.events.EventType.KEYUP,this.onKeyUp_))},goog.ui.ac.InputHandler.prototype.onIeKeyPress_=function(e){this.handleSeparator_(e)},goog.ui.ac.InputHandler.prototype.update=function(e){if(this.activeElement_&&(e||this.getValue()!=this.lastValue_)){if(e||!this.rowJustSelected_){var t=this.parseToken();this.ac_&&(this.ac_.setTarget(this.activeElement_),this.ac_.setToken(t,this.getValue()))}this.lastValue_=this.getValue()}this.rowJustSelected_=!1},goog.ui.ac.InputHandler.prototype.parseToken=function(){return this.parseToken_()},goog.ui.ac.InputHandler.prototype.moveUp_=function(){return this.upsideDown_?this.ac_.hiliteNext():this.ac_.hilitePrev()},goog.ui.ac.InputHandler.prototype.moveDown_=function(){return this.upsideDown_?this.ac_.hilitePrev():this.ac_.hiliteNext()},goog.ui.ac.InputHandler.prototype.parseToken_=function(){var e=this.getCursorPosition(),t=this.getValue();return this.trim_(this.splitInput_(t)[this.getTokenIndex_(t,e)])},goog.ui.ac.InputHandler.prototype.trim_=function(e){return this.trimmer_?String(e).replace(this.trimmer_,""):e},goog.ui.ac.InputHandler.prototype.getTokenIndex_=function(e,t){var o=this.splitInput_(e);if(t==e.length)return o.length-1;for(var i=0,n=0,s=0;n<o.length&&s<=t;n++)s+=o[n].length,i=n;return i},goog.ui.ac.InputHandler.prototype.splitInput_=function(e){if(!this.multi_)return[e];for(var t=String(e).split(""),o=[],i=[],n=0,s=!1;n<t.length;n++)this.literals_&&-1!=this.literals_.indexOf(t[n])?(this.generateNewTokenOnLiteral_&&!s&&(o.push(i.join("")),i.length=0),i.push(t[n]),s=!s):s||-1==this.separators_.indexOf(t[n])?i.push(t[n]):(i.push(t[n]),o.push(i.join("")),i.length=0);return o.push(i.join("")),o};