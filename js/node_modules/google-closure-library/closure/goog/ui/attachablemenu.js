goog.provide("goog.ui.AttachableMenu"),goog.require("goog.a11y.aria"),goog.require("goog.a11y.aria.State"),goog.require("goog.array"),goog.require("goog.asserts"),goog.require("goog.dom"),goog.require("goog.dom.classlist"),goog.require("goog.events.Event"),goog.require("goog.events.KeyCodes"),goog.require("goog.string"),goog.require("goog.style"),goog.require("goog.ui.ItemEvent"),goog.require("goog.ui.MenuBase"),goog.require("goog.ui.PopupBase"),goog.require("goog.userAgent"),goog.ui.AttachableMenu=function(e){goog.ui.MenuBase.call(this,e)},goog.inherits(goog.ui.AttachableMenu,goog.ui.MenuBase),goog.tagUnsealableClass(goog.ui.AttachableMenu),goog.ui.AttachableMenu.prototype.selectedElement_=null,goog.ui.AttachableMenu.prototype.itemClassName_="menu-item",goog.ui.AttachableMenu.prototype.selectedItemClassName_="menu-item-selected",goog.ui.AttachableMenu.prototype.lastKeyDown_=goog.now(),goog.ui.AttachableMenu.prototype.disposeInternal=function(){goog.ui.AttachableMenu.superClass_.disposeInternal.call(this),this.selectedElement_=null},goog.ui.AttachableMenu.prototype.getItemClassName=function(){return this.itemClassName_},goog.ui.AttachableMenu.prototype.setItemClassName=function(e){this.itemClassName_=e},goog.ui.AttachableMenu.prototype.getSelectedItemClassName=function(){return this.selectedItemClassName_},goog.ui.AttachableMenu.prototype.setSelectedItemClassName=function(e){this.selectedItemClassName_=e},goog.ui.AttachableMenu.prototype.getSelectedItem=function(){return this.selectedElement_},goog.ui.AttachableMenu.prototype.setSelectedItem=function(e){var t=e;this.selectedElement_&&goog.dom.classlist.remove(this.selectedElement_,this.selectedItemClassName_),this.selectedElement_=t;var o=this.getElement();if(goog.asserts.assert(o,"The attachable menu DOM element cannot be null."),this.selectedElement_){goog.dom.classlist.add(this.selectedElement_,this.selectedItemClassName_),t.id&&goog.a11y.aria.setState(o,goog.a11y.aria.State.ACTIVEDESCENDANT,t.id);var s=this.selectedElement_.offsetTop,g=this.selectedElement_.offsetHeight,n=o.scrollTop,i=o.offsetHeight;s<n?o.scrollTop=s:s+g>n+i&&(o.scrollTop=s+g-i)}else goog.a11y.aria.setState(o,goog.a11y.aria.State.ACTIVEDESCENDANT,"")},goog.ui.AttachableMenu.prototype.showPopupElement=function(){var e=this.getElement();goog.style.setElementShown(e,!0),e.scrollTop=0,e.style.visibility="visible"},goog.ui.AttachableMenu.prototype.onShow=function(){goog.ui.AttachableMenu.superClass_.onShow.call(this);var e=this.getElement();goog.userAgent.IE?e.firstChild.focus():e.focus()},goog.ui.AttachableMenu.prototype.getNextPrevItem=function(e){var t,o=this.getElement().getElementsByTagName("*"),s=o.length;if(this.selectedElement_)for(var g=0;g<s;g++)if(o[g]==this.selectedElement_){t=e?g-1:g+1;break}void 0===t&&(t=e?s-1:0);for(g=0;g<s;g++){var n=t+(e?-1:1)*g%s;if(n<0?n+=s:n>=s&&(n-=s),this.isMenuItem_(o[n]))return o[n]}return null},goog.ui.AttachableMenu.prototype.onMouseOver=function(e){var t=this.getAncestorMenuItem_(e.target);null!=t&&goog.now()-this.lastKeyDown_>goog.ui.PopupBase.DEBOUNCE_DELAY_MS&&this.setSelectedItem(t)},goog.ui.AttachableMenu.prototype.onMouseOut=function(e){null!=this.getAncestorMenuItem_(e.target)&&goog.now()-this.lastKeyDown_>goog.ui.PopupBase.DEBOUNCE_DELAY_MS&&this.setSelectedItem(null)},goog.ui.AttachableMenu.prototype.onMouseDown=goog.events.Event.preventDefault,goog.ui.AttachableMenu.prototype.onMouseUp=function(e){var t=this.getAncestorMenuItem_(e.target);null!=t&&(this.setVisible(!1),this.onItemSelected_(t))},goog.ui.AttachableMenu.prototype.onKeyDown=function(e){switch(e.keyCode){case goog.events.KeyCodes.DOWN:this.setSelectedItem(this.getNextPrevItem(!1)),this.lastKeyDown_=goog.now();break;case goog.events.KeyCodes.UP:this.setSelectedItem(this.getNextPrevItem(!0)),this.lastKeyDown_=goog.now();break;case goog.events.KeyCodes.ENTER:this.selectedElement_&&(this.onItemSelected_(),this.setVisible(!1));break;case goog.events.KeyCodes.ESC:this.setVisible(!1);break;default:if(e.charCode){var t=String.fromCharCode(e.charCode);this.selectByName_(t,1,!0)}}e.preventDefault(),e.stopPropagation(),this.dispatchEvent(e)},goog.ui.AttachableMenu.prototype.selectByName_=function(e,t,o){var s,g=this.getElement().getElementsByTagName("*"),n=g.length;if(0!=n){this.selectedElement_&&-1!=(s=goog.array.indexOf(g,this.selectedElement_))||(s=0);var i=s,a=new RegExp("^"+goog.string.regExpEscape(e),"i"),l=o&&this.selectedElement_,u=t||1;do{if(g[s]!=l&&this.isMenuItem_(g[s]))if(goog.dom.getTextContent(g[s]).match(a))break;(s+=u)==n?s=0:s<0&&(s=n-1)}while(s!=i);this.selectedElement_!=g[s]&&this.setSelectedItem(g[s])}},goog.ui.AttachableMenu.prototype.onItemSelected_=function(e){this.dispatchEvent(new goog.ui.ItemEvent(goog.ui.MenuBase.Events.ITEM_ACTION,this,e||this.selectedElement_))},goog.ui.AttachableMenu.prototype.isMenuItem_=function(e){return!!e&&goog.dom.classlist.contains(e,this.itemClassName_)},goog.ui.AttachableMenu.prototype.getAncestorMenuItem_=function(e){if(e)for(var t=goog.dom.getOwnerDocument(e).body;null!=e&&e!=t;){if(this.isMenuItem_(e))return e;e=e.parentNode}return null};