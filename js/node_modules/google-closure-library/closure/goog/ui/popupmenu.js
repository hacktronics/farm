goog.provide("goog.ui.PopupMenu"),goog.require("goog.events"),goog.require("goog.events.BrowserEvent"),goog.require("goog.events.BrowserEvent.MouseButton"),goog.require("goog.events.EventType"),goog.require("goog.events.KeyCodes"),goog.require("goog.positioning.AnchoredViewportPosition"),goog.require("goog.positioning.Corner"),goog.require("goog.positioning.MenuAnchoredPosition"),goog.require("goog.positioning.Overflow"),goog.require("goog.positioning.ViewportClientPosition"),goog.require("goog.structs.Map"),goog.require("goog.style"),goog.require("goog.ui.Component"),goog.require("goog.ui.Menu"),goog.require("goog.ui.PopupBase"),goog.ui.PopupMenu=function(e,o){goog.ui.Menu.call(this,e,o),this.setAllowAutoFocus(!0),this.setVisible(!1,!0),this.targets_=new goog.structs.Map},goog.inherits(goog.ui.PopupMenu,goog.ui.Menu),goog.tagUnsealableClass(goog.ui.PopupMenu),goog.ui.PopupMenu.prototype.toggleMode_=!1,goog.ui.PopupMenu.prototype.shiftOverride_=!1,goog.ui.PopupMenu.prototype.lastHide_=0,goog.ui.PopupMenu.prototype.currentAnchor_=null,goog.ui.PopupMenu.prototype.decorateInternal=function(e){goog.ui.PopupMenu.superClass_.decorateInternal.call(this,e);var o=e.getAttribute("for")||e.htmlFor;o&&this.attach(this.getDomHelper().getElement(o),goog.positioning.Corner.BOTTOM_LEFT)},goog.ui.PopupMenu.prototype.enterDocument=function(){goog.ui.PopupMenu.superClass_.enterDocument.call(this),this.targets_.forEach(this.attachEvent_,this);var e=this.getHandler();e.listen(this,goog.ui.Component.EventType.ACTION,this.onAction_),e.listen(this.getDomHelper().getDocument(),goog.events.EventType.MOUSEDOWN,this.onDocClick,!0)},goog.ui.PopupMenu.prototype.attach=function(e,o,t,i,n){if(!this.isAttachTarget(e)){var g=this.createAttachTarget(e,o,t,i,n);this.isInDocument()&&this.attachEvent_(g);var s=goog.partial(this.onMenuKeyboardAction_,e);this.getElement()&&this.getHandler().listen(this.getElement(),goog.events.EventType.KEYDOWN,s)}},goog.ui.PopupMenu.prototype.onMenuKeyboardAction_=function(e,o){if(o.keyCode!=goog.events.KeyCodes.ESC){var t=this.getChildAt(this.getHighlightedIndex());if(t){var i=t.getElement(),n=new goog.events.BrowserEvent(o.getBrowserEvent(),i);n.target=i,o.keyCode!=goog.events.KeyCodes.SPACE&&o.keyCode!=goog.events.KeyCodes.ENTER||goog.events.fireListeners(i,goog.events.EventType.KEYDOWN,!1,n),o.keyCode==goog.events.KeyCodes.SPACE&&this.hide()}}else e.focus()},goog.ui.PopupMenu.prototype.createAttachTarget=function(e,o,t,i,n){if(!e)return null;var g={element_:e,targetCorner_:o,menuCorner_:t,eventType_:i?goog.events.EventType.CONTEXTMENU:goog.events.EventType.MOUSEDOWN,margin_:n};return this.targets_.set(goog.getUid(e),g),g},goog.ui.PopupMenu.prototype.getAttachTarget=function(e){return e?this.targets_.get(goog.getUid(e)):null},goog.ui.PopupMenu.prototype.isAttachTarget=function(e){return!!e&&this.targets_.containsKey(goog.getUid(e))},goog.ui.PopupMenu.prototype.getAttachedElement=function(){return this.currentAnchor_},goog.ui.PopupMenu.prototype.attachEvent_=function(e){this.getHandler().listen(e.element_,e.eventType_,this.onTargetClick_),e.eventType_!=goog.events.EventType.CONTEXTMENU&&this.getHandler().listen(e.element_,goog.events.EventType.KEYDOWN,this.onTargetKeyboardAction_)},goog.ui.PopupMenu.prototype.detachAll=function(){if(this.isInDocument())for(var e=this.targets_.getKeys(),o=0;o<e.length;o++)this.detachEvent_(this.targets_.get(e[o]));this.targets_.clear()},goog.ui.PopupMenu.prototype.detach=function(e){if(!this.isAttachTarget(e))throw new Error("Menu not attached to provided element, unable to detach.");var o=goog.getUid(e);this.isInDocument()&&this.detachEvent_(this.targets_.get(o)),this.targets_.remove(o)},goog.ui.PopupMenu.prototype.detachEvent_=function(e){this.getHandler().unlisten(e.element_,e.eventType_,this.onTargetClick_)},goog.ui.PopupMenu.prototype.setToggleMode=function(e){this.toggleMode_=e},goog.ui.PopupMenu.prototype.setShiftOverride=function(e){this.shiftOverride_=e},goog.ui.PopupMenu.prototype.getToggleMode=function(){return this.toggleMode_},goog.ui.PopupMenu.prototype.getShiftOverride=function(){return this.shiftOverride_},goog.ui.PopupMenu.prototype.showWithPosition=function(e,o,t,i){var n=this.isVisible();if(this.isOrWasRecentlyVisible()&&this.toggleMode_)this.hide();else if(this.currentAnchor_=i||null,this.dispatchEvent(goog.ui.Component.EventType.BEFORE_SHOW)){var g=void 0!==o?o:goog.positioning.Corner.TOP_START;n||(this.getElement().style.visibility="hidden"),goog.style.setElementShown(this.getElement(),!0),e.reposition(this.getElement(),g,t),n||(this.getElement().style.visibility="visible"),this.setHighlightedIndex(-1),this.setVisible(!0)}},goog.ui.PopupMenu.prototype.showMenu=function(e,o,t){var i=void 0!==e.targetCorner_?new goog.positioning.AnchoredViewportPosition(e.element_,e.targetCorner_,!0):new goog.positioning.ViewportClientPosition(o,t);i.setLastResortOverflow&&i.setLastResortOverflow(goog.positioning.Overflow.ADJUST_X|goog.positioning.Overflow.ADJUST_Y),this.showWithPosition(i,e.menuCorner_,e.margin_,e.element_)},goog.ui.PopupMenu.prototype.showAt=function(e,o,t){this.showWithPosition(new goog.positioning.ViewportClientPosition(e,o),t)},goog.ui.PopupMenu.prototype.showAtElement=function(e,o,t){this.showWithPosition(new goog.positioning.MenuAnchoredPosition(e,o,!0),t,null,e)},goog.ui.PopupMenu.prototype.hide=function(){this.isVisible()&&(this.setVisible(!1),this.isVisible()||(this.lastHide_=goog.now(),this.currentAnchor_=null))},goog.ui.PopupMenu.prototype.isOrWasRecentlyVisible=function(){return this.isVisible()||this.wasRecentlyHidden()},goog.ui.PopupMenu.prototype.wasRecentlyHidden=function(){return goog.now()-this.lastHide_<goog.ui.PopupBase.DEBOUNCE_DELAY_MS},goog.ui.PopupMenu.prototype.onAction_=function(e){this.hide()},goog.ui.PopupMenu.prototype.onTargetClick_=function(e){this.shiftOverride_&&e.shiftKey&&e.button==goog.events.BrowserEvent.MouseButton.RIGHT||this.onTargetActivation_(e)},goog.ui.PopupMenu.prototype.onTargetKeyboardAction_=function(e){e.keyCode!=goog.events.KeyCodes.SPACE&&e.keyCode!=goog.events.KeyCodes.ENTER&&e.keyCode!=goog.events.KeyCodes.DOWN||this.onTargetActivation_(e),e.keyCode==goog.events.KeyCodes.DOWN&&this.highlightFirst()},goog.ui.PopupMenu.prototype.onTargetActivation_=function(e){for(var o=this.targets_.getKeys(),t=0;t<o.length;t++){var i=this.targets_.get(o[t]);if(i.element_==e.currentTarget)return this.showMenu(i,e.clientX,e.clientY),e.preventDefault(),void e.stopPropagation()}},goog.ui.PopupMenu.prototype.onDocClick=function(e){this.isVisible()&&!this.containsElement(e.target)&&this.hide()},goog.ui.PopupMenu.prototype.handleBlur=function(e){goog.ui.PopupMenu.superClass_.handleBlur.call(this,e),this.hide()},goog.ui.PopupMenu.prototype.disposeInternal=function(){goog.ui.PopupMenu.superClass_.disposeInternal.call(this),this.targets_&&(this.targets_.clear(),delete this.targets_)};