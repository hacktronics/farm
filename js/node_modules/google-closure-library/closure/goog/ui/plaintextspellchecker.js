goog.provide("goog.ui.PlainTextSpellChecker"),goog.require("goog.Timer"),goog.require("goog.a11y.aria"),goog.require("goog.asserts"),goog.require("goog.dom"),goog.require("goog.dom.TagName"),goog.require("goog.events.EventHandler"),goog.require("goog.events.EventType"),goog.require("goog.events.KeyCodes"),goog.require("goog.events.KeyHandler"),goog.require("goog.spell.SpellCheck"),goog.require("goog.style"),goog.require("goog.ui.AbstractSpellChecker"),goog.require("goog.ui.Component"),goog.require("goog.userAgent"),goog.ui.PlainTextSpellChecker=function(e,t){goog.ui.AbstractSpellChecker.call(this,e,t),this.overlay_=this.getDomHelper().createDom(goog.dom.TagName.DIV),goog.style.setPreWrap(this.overlay_),this.boundContinueAsyncFn_=goog.bind(this.continueAsync_,this),this.endOfLineMatcher_=new RegExp("(.*)(\n|\r\n){0,1}","g")},goog.inherits(goog.ui.PlainTextSpellChecker,goog.ui.AbstractSpellChecker),goog.ui.PlainTextSpellChecker.prototype.invalidWordClassName=goog.getCssName("goog-spellcheck-invalidword"),goog.ui.PlainTextSpellChecker.prototype.correctedWordClassName=goog.getCssName("goog-spellcheck-correctedword"),goog.ui.PlainTextSpellChecker.prototype.correctionPaneClassName=goog.getCssName("goog-spellcheck-correctionpane"),goog.ui.PlainTextSpellChecker.prototype.dictionaryPreScanSize_=1e3,goog.ui.PlainTextSpellChecker.prototype.winSize_,goog.ui.PlainTextSpellChecker.prototype.eventHandler_,goog.ui.PlainTextSpellChecker.prototype.keyHandler_,goog.ui.PlainTextSpellChecker.prototype.textArrayIndex_,goog.ui.PlainTextSpellChecker.prototype.textArray_,goog.ui.PlainTextSpellChecker.prototype.textArrayProcess_,goog.ui.PlainTextSpellChecker.prototype.createDom=function(){this.setElementInternal(this.getDomHelper().createElement(goog.dom.TagName.TEXTAREA))},goog.ui.PlainTextSpellChecker.prototype.enterDocument=function(){goog.ui.PlainTextSpellChecker.superClass_.enterDocument.call(this),this.eventHandler_=new goog.events.EventHandler(this),this.keyHandler_=new goog.events.KeyHandler(this.overlay_),this.initSuggestionsMenu(),this.initAccessibility_()},goog.ui.PlainTextSpellChecker.prototype.exitDocument=function(){goog.ui.PlainTextSpellChecker.superClass_.exitDocument.call(this),this.eventHandler_&&(this.eventHandler_.dispose(),this.eventHandler_=void 0),this.keyHandler_&&(this.keyHandler_.dispose(),this.keyHandler_=void 0)},goog.ui.PlainTextSpellChecker.prototype.initSuggestionsMenu=function(){goog.ui.PlainTextSpellChecker.superClass_.initSuggestionsMenu.call(this),this.eventHandler_.listen(this.getMenu(),goog.ui.Component.EventType.HIDE,this.onCorrectionHide_)},goog.ui.PlainTextSpellChecker.prototype.check=function(){var e=this.getElement().value;this.getElement().readOnly=!0,goog.dom.removeChildren(this.overlay_),this.overlay_.className=this.correctionPaneClassName,this.getElement().parentNode!=this.overlay_.parentNode&&this.getElement().parentNode.appendChild(this.overlay_),goog.style.setElementShown(this.overlay_,!1),this.preChargeDictionary_(e)},goog.ui.PlainTextSpellChecker.prototype.finishCheck_=function(){this.positionOverlay_(),goog.style.setElementShown(this.getElement(),!1),goog.style.setElementShown(this.overlay_,!0);var e=this.eventHandler_;e.listen(this.overlay_,goog.events.EventType.CLICK,this.onWordClick_),e.listen(this.keyHandler_,goog.events.KeyHandler.EventType.KEY,this.handleOverlayKeyEvent);var t=goog.dom.getWindow(this.getDomHelper().getDocument())||window;this.winSize_=goog.dom.getViewportSize(t),e.listen(t,goog.events.EventType.RESIZE,this.onWindowResize_),goog.ui.PlainTextSpellChecker.superClass_.check.call(this)},goog.ui.PlainTextSpellChecker.prototype.preChargeDictionary_=function(e){this.eventHandler_.listen(this.spellCheck,goog.spell.SpellCheck.EventType.READY,this.onDictionaryCharged_,!0),this.populateDictionary(e,this.dictionaryPreScanSize_)},goog.ui.PlainTextSpellChecker.prototype.onDictionaryCharged_=function(e){e.stopPropagation(),this.eventHandler_.unlisten(this.spellCheck,goog.spell.SpellCheck.EventType.READY,this.onDictionaryCharged_,!0),this.checkAsync_(this.getElement().value)},goog.ui.PlainTextSpellChecker.prototype.spellCheckLoop_=function(){for(var e=this.textArrayIndex_;e<this.textArray_.length;++e){var t=this.textArray_[e];if(this.textArrayProcess_[e]){var o=this.processTextAsync(this.overlay_,t);if(o==goog.ui.AbstractSpellChecker.AsyncResult.PENDING)return this.textArrayIndex_=e+1,goog.Timer.callOnce(this.boundContinueAsyncFn_),o}else this.processRange(this.overlay_,t)}return this.textArray_=[],this.textArrayProcess_=[],goog.ui.AbstractSpellChecker.AsyncResult.DONE},goog.ui.PlainTextSpellChecker.prototype.initTextArray_=function(e){if(!this.excludeMarker)return this.textArray_=[e],void(this.textArrayProcess_=[!0]);this.textArray_=[],this.textArrayProcess_=[],this.excludeMarker.lastIndex=0;for(var t,o=0;(t=this.excludeMarker.exec(e))&&0!=t[0].length;){var i=t[0],s=e.substr(o,t.index-o);s&&(this.textArray_.push(s),this.textArrayProcess_.push(!0)),this.textArray_.push(i),this.textArrayProcess_.push(!1),o=this.excludeMarker.lastIndex}var n=e.substr(o);n&&(this.textArray_.push(n),this.textArrayProcess_.push(!0))},goog.ui.PlainTextSpellChecker.prototype.checkAsync_=function(e){this.initializeAsyncMode(),this.initTextArray_(e),this.textArrayIndex_=0,this.spellCheckLoop_()!=goog.ui.AbstractSpellChecker.AsyncResult.PENDING&&(this.finishAsyncProcessing(),this.finishCheck_())},goog.ui.PlainTextSpellChecker.prototype.continueAsync_=function(){this.continueAsyncProcessing()!=goog.ui.AbstractSpellChecker.AsyncResult.PENDING?this.spellCheckLoop_()!=goog.ui.AbstractSpellChecker.AsyncResult.PENDING&&(this.finishAsyncProcessing(),this.finishCheck_()):goog.Timer.callOnce(this.boundContinueAsyncFn_)},goog.ui.PlainTextSpellChecker.prototype.processWord=function(e,t,o){e.appendChild(this.createWordElement(t,o))},goog.ui.PlainTextSpellChecker.prototype.processRange=function(e,t){var o;for(this.endOfLineMatcher_.lastIndex=0;(o=this.endOfLineMatcher_.exec(t))&&0!=o[0].length;)e.appendChild(this.getDomHelper().createTextNode(o[1])),o[2]&&e.appendChild(this.getDomHelper().createElement(goog.dom.TagName.BR))},goog.ui.PlainTextSpellChecker.prototype.resume=function(){var e=this.isVisible();if(goog.ui.PlainTextSpellChecker.superClass_.resume.call(this),goog.style.setElementShown(this.overlay_,!1),goog.style.setElementShown(this.getElement(),!0),this.getElement().readOnly=!1,e){this.getElement().value=goog.dom.getRawTextContent(this.overlay_),goog.dom.removeChildren(this.overlay_);var t=this.eventHandler_;t.unlisten(this.overlay_,goog.events.EventType.CLICK,this.onWordClick_),t.unlisten(this.keyHandler_,goog.events.KeyHandler.EventType.KEY,this.handleOverlayKeyEvent);var o=goog.dom.getWindow(this.getDomHelper().getDocument())||window;t.unlisten(o,goog.events.EventType.RESIZE,this.onWindowResize_)}},goog.ui.PlainTextSpellChecker.prototype.getElementProperties=function(e){return e==goog.spell.SpellCheck.WordStatus.INVALID?{class:this.invalidWordClassName}:e==goog.spell.SpellCheck.WordStatus.CORRECTED?{class:this.correctedWordClassName}:{class:""}},goog.ui.PlainTextSpellChecker.prototype.onWordClick_=function(e){e.target.className!=this.invalidWordClassName&&e.target.className!=this.correctedWordClassName||(this.showSuggestionsMenu(e.target,e),e.stopPropagation())},goog.ui.PlainTextSpellChecker.prototype.onWindowResize_=function(e){var t=goog.dom.getWindow(this.getDomHelper().getDocument())||window,o=goog.dom.getViewportSize(t);o.width==this.winSize_.width&&o.height==this.winSize_.height||(goog.style.setElementShown(this.overlay_,!1),goog.style.setElementShown(this.getElement(),!0),goog.userAgent.IE?goog.Timer.callOnce(this.resizeOverlay_,100,this):this.resizeOverlay_(),this.winSize_=o)},goog.ui.PlainTextSpellChecker.prototype.resizeOverlay_=function(){this.positionOverlay_(),goog.style.setElementShown(this.getElement(),!1),goog.style.setElementShown(this.overlay_,!0)},goog.ui.PlainTextSpellChecker.prototype.positionOverlay_=function(){goog.style.setPosition(this.overlay_,goog.style.getPosition(this.getElement())),goog.style.setSize(this.overlay_,goog.style.getSize(this.getElement()))},goog.ui.PlainTextSpellChecker.prototype.disposeInternal=function(){this.getDomHelper().removeNode(this.overlay_),delete this.overlay_,delete this.boundContinueAsyncFn_,delete this.endOfLineMatcher_,goog.ui.PlainTextSpellChecker.superClass_.disposeInternal.call(this)},goog.ui.PlainTextSpellChecker.prototype.initAccessibility_=function(){goog.asserts.assert(this.overlay_,"The plain text spell checker DOM element cannot be null."),goog.a11y.aria.setRole(this.overlay_,"region"),goog.a11y.aria.setState(this.overlay_,"live","assertive"),this.overlay_.tabIndex=0;var e=goog.getMsg("Spell Checker");this.overlay_.title=e},goog.ui.PlainTextSpellChecker.prototype.handleOverlayKeyEvent=function(e){var t=!1;switch(e.keyCode){case goog.events.KeyCodes.RIGHT:e.ctrlKey&&(t=this.navigate(goog.ui.AbstractSpellChecker.Direction.NEXT));break;case goog.events.KeyCodes.LEFT:e.ctrlKey&&(t=this.navigate(goog.ui.AbstractSpellChecker.Direction.PREVIOUS));break;case goog.events.KeyCodes.DOWN:if(this.getFocusedElementIndex()){var o=this.getDomHelper().getElement(this.makeElementId(this.getFocusedElementIndex()));if(o){var i=goog.style.getPosition(o),s=goog.style.getSize(o);i.x+=s.width/2,i.y+=s.height/2,this.showSuggestionsMenu(o,i),t=!0}}}return t&&e.preventDefault(),t},goog.ui.PlainTextSpellChecker.prototype.onCorrectionAction=function(e){goog.ui.PlainTextSpellChecker.superClass_.onCorrectionAction.call(this,e),e.target!=this.getMenuEdit()&&this.reFocus_()},goog.ui.PlainTextSpellChecker.prototype.onCorrectionHide_=function(e){this.reFocus_()},goog.ui.PlainTextSpellChecker.prototype.reFocus_=function(){var e=this.getElementByIndex(this.getFocusedElementIndex());e?e.focus():this.overlay_.focus()};