goog.provide("goog.ui.ComboBox"),goog.provide("goog.ui.ComboBoxItem"),goog.require("goog.Timer"),goog.require("goog.asserts"),goog.require("goog.dom"),goog.require("goog.dom.InputType"),goog.require("goog.dom.TagName"),goog.require("goog.dom.classlist"),goog.require("goog.events.EventType"),goog.require("goog.events.InputHandler"),goog.require("goog.events.KeyCodes"),goog.require("goog.events.KeyHandler"),goog.require("goog.log"),goog.require("goog.positioning.Corner"),goog.require("goog.positioning.MenuAnchoredPosition"),goog.require("goog.string"),goog.require("goog.style"),goog.require("goog.ui.Component"),goog.require("goog.ui.ItemEvent"),goog.require("goog.ui.LabelInput"),goog.require("goog.ui.Menu"),goog.require("goog.ui.MenuItem"),goog.require("goog.ui.MenuSeparator"),goog.require("goog.ui.registry"),goog.require("goog.userAgent"),goog.ui.ComboBox=function(o,t,e){goog.ui.Component.call(this,o),this.labelInput_=e||new goog.ui.LabelInput,this.enabled_=!0,this.menu_=t||new goog.ui.Menu(this.getDomHelper()),this.setupMenu_()},goog.inherits(goog.ui.ComboBox,goog.ui.Component),goog.tagUnsealableClass(goog.ui.ComboBox),goog.ui.ComboBox.BLUR_DISMISS_TIMER_MS=250,goog.ui.ComboBox.prototype.logger_=goog.log.getLogger("goog.ui.ComboBox"),goog.ui.ComboBox.prototype.enabled_,goog.ui.ComboBox.prototype.keyHandler_,goog.ui.ComboBox.prototype.inputHandler_=null,goog.ui.ComboBox.prototype.lastToken_=null,goog.ui.ComboBox.prototype.labelInput_=null,goog.ui.ComboBox.prototype.menu_=null,goog.ui.ComboBox.prototype.visibleCount_=-1,goog.ui.ComboBox.prototype.input_=null,goog.ui.ComboBox.prototype.matchFunction_=goog.string.startsWith,goog.ui.ComboBox.prototype.button_=null,goog.ui.ComboBox.prototype.defaultText_="",goog.ui.ComboBox.prototype.fieldName_="",goog.ui.ComboBox.prototype.dismissTimer_=null,goog.ui.ComboBox.prototype.useDropdownArrow_=!1,goog.ui.ComboBox.prototype.createDom=function(){this.input_=this.getDomHelper().createDom(goog.dom.TagName.INPUT,{name:this.fieldName_,type:goog.dom.InputType.TEXT,autocomplete:"off"}),this.button_=this.getDomHelper().createDom(goog.dom.TagName.SPAN,goog.getCssName("goog-combobox-button")),this.setElementInternal(this.getDomHelper().createDom(goog.dom.TagName.SPAN,goog.getCssName("goog-combobox"),this.input_,this.button_)),this.useDropdownArrow_&&(goog.dom.setTextContent(this.button_,"â–¼"),goog.style.setUnselectable(this.button_,!0)),this.input_.setAttribute("label",this.defaultText_),this.labelInput_.decorate(this.input_),this.menu_.setFocusable(!1),this.menu_.isInDocument()||this.addChild(this.menu_,!0)},goog.ui.ComboBox.prototype.setEnabled=function(o){this.enabled_=o,this.labelInput_.setEnabled(o),goog.dom.classlist.enable(goog.asserts.assert(this.getElement()),goog.getCssName("goog-combobox-disabled"),!o)},goog.ui.ComboBox.prototype.isEnabled=function(){return this.enabled_},goog.ui.ComboBox.prototype.enterDocument=function(){goog.ui.ComboBox.superClass_.enterDocument.call(this);var o=this.getHandler();o.listen(this.getElement(),goog.events.EventType.MOUSEDOWN,this.onComboMouseDown_),o.listen(this.getDomHelper().getDocument(),goog.events.EventType.MOUSEDOWN,this.onDocClicked_),o.listen(this.input_,goog.events.EventType.BLUR,this.onInputBlur_),this.keyHandler_=new goog.events.KeyHandler(this.input_),o.listen(this.keyHandler_,goog.events.KeyHandler.EventType.KEY,this.handleKeyEvent),this.inputHandler_=new goog.events.InputHandler(this.input_),o.listen(this.inputHandler_,goog.events.InputHandler.EventType.INPUT,this.onInputEvent_),o.listen(this.menu_,goog.ui.Component.EventType.ACTION,this.onMenuSelected_)},goog.ui.ComboBox.prototype.exitDocument=function(){this.keyHandler_.dispose(),delete this.keyHandler_,this.inputHandler_.dispose(),this.inputHandler_=null,goog.ui.ComboBox.superClass_.exitDocument.call(this)},goog.ui.ComboBox.prototype.canDecorate=function(){return!1},goog.ui.ComboBox.prototype.disposeInternal=function(){goog.ui.ComboBox.superClass_.disposeInternal.call(this),this.clearDismissTimer_(),this.labelInput_.dispose(),this.menu_.dispose(),this.labelInput_=null,this.menu_=null,this.input_=null,this.button_=null},goog.ui.ComboBox.prototype.dismiss=function(){this.clearDismissTimer_(),this.hideMenu_(),this.menu_.setHighlightedIndex(-1)},goog.ui.ComboBox.prototype.addItem=function(o){this.menu_.addChild(o,!0),this.visibleCount_=-1},goog.ui.ComboBox.prototype.addItemAt=function(o,t){this.menu_.addChildAt(o,t,!0),this.visibleCount_=-1},goog.ui.ComboBox.prototype.removeItem=function(o){var t=this.menu_.removeChild(o,!0);t&&(t.dispose(),this.visibleCount_=-1)},goog.ui.ComboBox.prototype.removeAllItems=function(){for(var o=this.getItemCount()-1;o>=0;--o)this.removeItem(this.getItemAt(o))},goog.ui.ComboBox.prototype.removeItemAt=function(o){var t=this.menu_.removeChildAt(o,!0);t&&(t.dispose(),this.visibleCount_=-1)},goog.ui.ComboBox.prototype.getItemAt=function(o){return this.menu_.getChildAt(o)},goog.ui.ComboBox.prototype.getItemCount=function(){return this.menu_.getChildCount()},goog.ui.ComboBox.prototype.getMenu=function(){return this.menu_},goog.ui.ComboBox.prototype.getInputElement=function(){return this.input_},goog.ui.ComboBox.prototype.getLabelInput=function(){return this.labelInput_},goog.ui.ComboBox.prototype.getNumberOfVisibleItems_=function(){if(-1==this.visibleCount_){for(var o=0,t=0,e=this.menu_.getChildCount();t<e;t++){var i=this.menu_.getChildAt(t);i instanceof goog.ui.MenuSeparator||!i.isVisible()||o++}this.visibleCount_=o}return this.visibleCount_},goog.ui.ComboBox.prototype.setMatchFunction=function(o){this.matchFunction_=o},goog.ui.ComboBox.prototype.getMatchFunction=function(){return this.matchFunction_},goog.ui.ComboBox.prototype.setDefaultText=function(o){this.defaultText_=o,this.labelInput_&&this.labelInput_.setLabel(this.defaultText_)},goog.ui.ComboBox.prototype.getDefaultText=function(){return this.defaultText_},goog.ui.ComboBox.prototype.setFieldName=function(o){this.fieldName_=o},goog.ui.ComboBox.prototype.getFieldName=function(){return this.fieldName_},goog.ui.ComboBox.prototype.setUseDropdownArrow=function(o){this.useDropdownArrow_=!!o},goog.ui.ComboBox.prototype.setValue=function(o){this.labelInput_.getValue()!=o&&(this.labelInput_.setValue(o),this.handleInputChange_())},goog.ui.ComboBox.prototype.getValue=function(){return this.labelInput_.getValue()},goog.ui.ComboBox.prototype.getToken=function(){return goog.string.htmlEscape(this.getTokenText_())},goog.ui.ComboBox.prototype.getTokenText_=function(){return goog.string.trim(this.labelInput_.getValue().toLowerCase())},goog.ui.ComboBox.prototype.setupMenu_=function(){var o=this.menu_;o.setVisible(!1),o.setAllowAutoFocus(!1),o.setAllowHighlightDisabled(!0)},goog.ui.ComboBox.prototype.maybeShowMenu_=function(o){var t=this.menu_.isVisible(),e=this.getNumberOfVisibleItems_();t&&0==e?(goog.log.fine(this.logger_,"no matching items, hiding"),this.hideMenu_()):!t&&e>0&&(o&&(goog.log.fine(this.logger_,"showing menu"),this.setItemVisibilityFromToken_(""),this.setItemHighlightFromToken_(this.getTokenText_())),goog.Timer.callOnce(this.clearDismissTimer_,1,this),this.showMenu_()),this.positionMenu()},goog.ui.ComboBox.prototype.positionMenu=function(){this.menu_&&this.menu_.isVisible()&&new goog.positioning.MenuAnchoredPosition(this.getElement(),goog.positioning.Corner.BOTTOM_START,!0).reposition(this.menu_.getElement(),goog.positioning.Corner.TOP_START)},goog.ui.ComboBox.prototype.showMenu_=function(){this.menu_.setVisible(!0),goog.dom.classlist.add(goog.asserts.assert(this.getElement()),goog.getCssName("goog-combobox-active"))},goog.ui.ComboBox.prototype.hideMenu_=function(){this.menu_.setVisible(!1),goog.dom.classlist.remove(goog.asserts.assert(this.getElement()),goog.getCssName("goog-combobox-active"))},goog.ui.ComboBox.prototype.clearDismissTimer_=function(){this.dismissTimer_&&(goog.Timer.clear(this.dismissTimer_),this.dismissTimer_=null)},goog.ui.ComboBox.prototype.onComboMouseDown_=function(o){this.enabled_&&(o.target==this.getElement()||o.target==this.input_||goog.dom.contains(this.button_,o.target))&&(this.menu_.isVisible()?(goog.log.fine(this.logger_,"Menu is visible, dismissing"),this.dismiss()):(goog.log.fine(this.logger_,"Opening dropdown"),this.maybeShowMenu_(!0),goog.userAgent.OPERA&&this.input_.focus(),this.input_.select(),this.menu_.setMouseButtonPressed(!0),o.preventDefault())),o.stopPropagation()},goog.ui.ComboBox.prototype.onDocClicked_=function(o){goog.dom.contains(this.menu_.getElement(),o.target)||this.dismiss()},goog.ui.ComboBox.prototype.onMenuSelected_=function(o){var t=o.target;if(this.dispatchEvent(new goog.ui.ItemEvent(goog.ui.Component.EventType.ACTION,this,t))){var e=t.getCaption();goog.log.fine(this.logger_,"Menu selection: "+e+". Dismissing menu"),this.labelInput_.getValue()!=e&&(this.labelInput_.setValue(e),this.dispatchEvent(goog.ui.Component.EventType.CHANGE)),this.dismiss()}o.stopPropagation()},goog.ui.ComboBox.prototype.onInputBlur_=function(o){this.clearDismissTimer_(),this.dismissTimer_=goog.Timer.callOnce(this.dismiss,goog.ui.ComboBox.BLUR_DISMISS_TIMER_MS,this)},goog.ui.ComboBox.prototype.handleKeyEvent=function(o){var t=this.menu_.isVisible();if(t&&this.menu_.handleKeyEvent(o))return!0;var e=!1;switch(o.keyCode){case goog.events.KeyCodes.ESC:t&&(goog.log.fine(this.logger_,"Dismiss on Esc: "+this.labelInput_.getValue()),this.dismiss(),e=!0);break;case goog.events.KeyCodes.TAB:if(t){var i=this.menu_.getHighlighted();i&&(goog.log.fine(this.logger_,"Select on Tab: "+this.labelInput_.getValue()),i.performActionInternal(o),e=!0)}break;case goog.events.KeyCodes.UP:case goog.events.KeyCodes.DOWN:t||(goog.log.fine(this.logger_,"Up/Down - maybe show menu"),this.maybeShowMenu_(!0),e=!0)}return e&&o.preventDefault(),e},goog.ui.ComboBox.prototype.onInputEvent_=function(o){goog.log.fine(this.logger_,"Key is modifying: "+this.labelInput_.getValue()),this.handleInputChange_()},goog.ui.ComboBox.prototype.handleInputChange_=function(){var o=this.getTokenText_();this.setItemVisibilityFromToken_(o),goog.dom.getActiveElement(this.getDomHelper().getDocument())==this.input_&&this.maybeShowMenu_(!1);var t=this.menu_.getHighlighted();""!=o&&t&&t.isVisible()||this.setItemHighlightFromToken_(o),this.lastToken_=o,this.dispatchEvent(goog.ui.Component.EventType.CHANGE)},goog.ui.ComboBox.prototype.setItemVisibilityFromToken_=function(o){for(var t=!1,e=0,i=!this.matchFunction_(o,this.lastToken_),g=0,n=this.menu_.getChildCount();g<n;g++){var s=this.menu_.getChildAt(g);if(s instanceof goog.ui.MenuSeparator)s.setVisible(t),t=!1;else if(s instanceof goog.ui.MenuItem){if(!s.isVisible()&&!i)continue;var u=s.getCaption(),r=this.isItemSticky_(s)||u&&this.matchFunction_(u.toLowerCase(),o);"function"==typeof s.setFormatFromToken&&s.setFormatFromToken(o),s.setVisible(!!r),t=r||t}else t=s.isVisible()||t;s instanceof goog.ui.MenuSeparator||!s.isVisible()||e++}this.visibleCount_=e},goog.ui.ComboBox.prototype.setItemHighlightFromToken_=function(o){if(""!=o){for(var t=0,e=this.menu_.getChildCount();t<e;t++){var i=this.menu_.getChildAt(t),g=i.getCaption();if(g&&this.matchFunction_(g.toLowerCase(),o))return this.menu_.setHighlightedIndex(t),void(i.setFormatFromToken&&i.setFormatFromToken(o))}this.menu_.setHighlightedIndex(-1)}else this.menu_.setHighlightedIndex(-1)},goog.ui.ComboBox.prototype.isItemSticky_=function(o){return"function"==typeof o.isSticky&&o.isSticky()},goog.ui.ComboBoxItem=function(o,t,e,i){goog.ui.ComboBoxItem.base(this,"constructor",o,t,e,i)},goog.inherits(goog.ui.ComboBoxItem,goog.ui.MenuItem),goog.tagUnsealableClass(goog.ui.ComboBoxItem),goog.ui.registry.setDecoratorByClassName(goog.getCssName("goog-combobox-item"),function(){return new goog.ui.ComboBoxItem(null)}),goog.ui.ComboBoxItem.prototype.isSticky_=!1,goog.ui.ComboBoxItem.prototype.setSticky=function(o){this.isSticky_=o},goog.ui.ComboBoxItem.prototype.isSticky=function(){return this.isSticky_},goog.ui.ComboBoxItem.prototype.setFormatFromToken=function(o){if(this.isEnabled()){var t=this.getCaption(),e=t.toLowerCase().indexOf(o);if(e>=0){var i=this.getDomHelper();this.setContent([i.createTextNode(t.substr(0,e)),i.createDom(goog.dom.TagName.B,null,t.substr(e,o.length)),i.createTextNode(t.substr(e+o.length))])}}};