goog.provide("goog.ui.FilteredMenu"),goog.require("goog.a11y.aria"),goog.require("goog.a11y.aria.AutoCompleteValues"),goog.require("goog.a11y.aria.State"),goog.require("goog.dom"),goog.require("goog.dom.InputType"),goog.require("goog.dom.TagName"),goog.require("goog.events"),goog.require("goog.events.EventType"),goog.require("goog.events.InputHandler"),goog.require("goog.events.KeyCodes"),goog.require("goog.string"),goog.require("goog.style"),goog.require("goog.ui.Component"),goog.require("goog.ui.FilterObservingMenuItem"),goog.require("goog.ui.Menu"),goog.require("goog.ui.MenuItem"),goog.require("goog.userAgent"),goog.ui.FilteredMenu=function(e,t){goog.ui.Menu.call(this,t,e)},goog.inherits(goog.ui.FilteredMenu,goog.ui.Menu),goog.tagUnsealableClass(goog.ui.FilteredMenu),goog.ui.FilteredMenu.EventType={FILTER_CHANGED:"filterchange"},goog.ui.FilteredMenu.Id_={CONTENT_ELEMENT:"content-el"},goog.ui.FilteredMenu.prototype.filterInput_,goog.ui.FilteredMenu.prototype.inputHandler_,goog.ui.FilteredMenu.prototype.maxLength_=0,goog.ui.FilteredMenu.prototype.label_="",goog.ui.FilteredMenu.prototype.labelEl_,goog.ui.FilteredMenu.prototype.allowMultiple_=!1,goog.ui.FilteredMenu.prototype.enteredItems_,goog.ui.FilteredMenu.prototype.filterFromIndex_=0,goog.ui.FilteredMenu.prototype.filterStr_,goog.ui.FilteredMenu.prototype.contentElement_,goog.ui.FilteredMenu.prototype.persistentChildren_,goog.ui.FilteredMenu.prototype.createDom=function(){goog.ui.FilteredMenu.superClass_.createDom.call(this);var e=this.getDomHelper(),t=e.createDom(goog.dom.TagName.DIV,goog.getCssName(this.getRenderer().getCssClass(),"filter"),this.labelEl_=e.createDom(goog.dom.TagName.DIV,null,this.label_),this.filterInput_=e.createDom(goog.dom.TagName.INPUT,{type:goog.dom.InputType.TEXT})),i=this.getElement();e.appendChild(i,t);var o=this.makeId(goog.ui.FilteredMenu.Id_.CONTENT_ELEMENT);this.contentElement_=e.createDom(goog.dom.TagName.DIV,{class:goog.getCssName(this.getRenderer().getCssClass(),"content"),id:o}),e.appendChild(i,this.contentElement_),this.initFilterInput_(),goog.a11y.aria.setState(this.filterInput_,goog.a11y.aria.State.AUTOCOMPLETE,goog.a11y.aria.AutoCompleteValues.LIST),goog.a11y.aria.setState(this.filterInput_,goog.a11y.aria.State.OWNS,o),goog.a11y.aria.setState(this.filterInput_,goog.a11y.aria.State.EXPANDED,!0)},goog.ui.FilteredMenu.prototype.initFilterInput_=function(){this.setFocusable(!0),this.setKeyEventTarget(this.filterInput_),goog.userAgent.GECKO&&this.filterInput_.setAttribute("autocomplete","off"),this.maxLength_&&(this.filterInput_.maxLength=this.maxLength_)},goog.ui.FilteredMenu.prototype.setUpFilterListeners_=function(){!this.inputHandler_&&this.filterInput_&&(this.inputHandler_=new goog.events.InputHandler(this.filterInput_),goog.style.setUnselectable(this.filterInput_,!1),goog.events.listen(this.inputHandler_,goog.events.InputHandler.EventType.INPUT,this.handleFilterEvent,!1,this),goog.events.listen(this.filterInput_.parentNode,goog.events.EventType.CLICK,this.onFilterLabelClick_,!1,this),this.allowMultiple_&&(this.enteredItems_=[]))},goog.ui.FilteredMenu.prototype.tearDownFilterListeners_=function(){this.inputHandler_&&(goog.events.unlisten(this.inputHandler_,goog.events.InputHandler.EventType.INPUT,this.handleFilterEvent,!1,this),goog.events.unlisten(this.filterInput_.parentNode,goog.events.EventType.CLICK,this.onFilterLabelClick_,!1,this),this.inputHandler_.dispose(),this.inputHandler_=void 0,this.enteredItems_=void 0)},goog.ui.FilteredMenu.prototype.setVisible=function(e,t,i){var o=goog.ui.FilteredMenu.superClass_.setVisible.call(this,e,t,i);return o&&e&&this.isInDocument()?(this.setFilter(""),this.setUpFilterListeners_()):o&&!e&&this.tearDownFilterListeners_(),o},goog.ui.FilteredMenu.prototype.disposeInternal=function(){this.tearDownFilterListeners_(),this.filterInput_=void 0,this.labelEl_=void 0,goog.ui.FilteredMenu.superClass_.disposeInternal.call(this)},goog.ui.FilteredMenu.prototype.setFilterLabel=function(e){this.label_=e||"",this.labelEl_&&goog.dom.setTextContent(this.labelEl_,this.label_)},goog.ui.FilteredMenu.prototype.getFilterLabel=function(){return this.label_},goog.ui.FilteredMenu.prototype.setFilter=function(e){this.filterInput_&&(this.filterInput_.value=e,this.filterItems_(e))},goog.ui.FilteredMenu.prototype.getFilter=function(){return this.filterInput_&&"string"==typeof this.filterInput_.value?this.filterInput_.value:""},goog.ui.FilteredMenu.prototype.setFilterFromIndex=function(e){this.filterFromIndex_=e},goog.ui.FilteredMenu.prototype.getFilterFromIndex=function(){return this.filterFromIndex_},goog.ui.FilteredMenu.prototype.getEnteredItems=function(){return this.enteredItems_||[]},goog.ui.FilteredMenu.prototype.setAllowMultiple=function(e){this.allowMultiple_=e},goog.ui.FilteredMenu.prototype.getAllowMultiple=function(){return this.allowMultiple_},goog.ui.FilteredMenu.prototype.setPersistentVisibility=function(e,t){this.persistentChildren_||(this.persistentChildren_={}),this.persistentChildren_[e.getId()]=t},goog.ui.FilteredMenu.prototype.hasPersistentVisibility=function(e){return!(!this.persistentChildren_||!this.persistentChildren_[e.getId()])},goog.ui.FilteredMenu.prototype.handleFilterEvent=function(e){this.filterItems_(this.filterInput_.value);var t=this.getHighlighted();t&&t.isVisible()||this.highlightFirst(),this.dispatchEvent(goog.ui.FilteredMenu.EventType.FILTER_CHANGED)},goog.ui.FilteredMenu.prototype.filterItems_=function(e){if(this.filterStr_!=e){if(this.labelEl_&&(this.labelEl_.style.visibility=""==e?"visible":"hidden"),this.allowMultiple_&&this.enteredItems_){var t=e.match(/^(.+),[ ]*([^,]*)$/),i=t&&t[1]?t[1].split(","):[];if(","==e.substr(e.length-1,1)||i.length!=this.enteredItems_.length){var o=i[i.length-1]||"";if(this.getHighlighted()&&""!=o)0==(l=this.getHighlighted().getCaption()).toLowerCase().indexOf(o.toLowerCase())&&(i[i.length-1]=l,this.filterInput_.value=i.join(",")+",");this.enteredItems_=i,this.dispatchEvent(goog.ui.Component.EventType.CHANGE),this.setHighlightedIndex(-1)}t&&(e=t.length>2?goog.string.trim(t[2]):"")}for(var n,g=new RegExp("(^|[- ,_/.:])"+goog.string.regExpEscape(e),"i"),r=this.filterFromIndex_;n=this.getChildAt(r);r++)if(n instanceof goog.ui.FilterObservingMenuItem)n.callObserver(e);else if(!this.hasPersistentVisibility(n)){var l;if(l=n.getCaption()){var s=l.match(g);if(""==e||s){n.setVisible(!0);var u=l.indexOf(s[0]);u&&u++,this.boldContent(n,u,e.length)}else n.setVisible(!1)}else n.setVisible(""==e)}this.filterStr_=e}},goog.ui.FilteredMenu.prototype.boldContent=function(e,t,i){var o,n=e.getCaption();if(0==i)o=this.getDomHelper().createTextNode(n);else{var g=n.substr(0,t),r=n.substr(t,i),l=n.substr(t+i);o=this.getDomHelper().createDom(goog.dom.TagName.SPAN,null,g,this.getDomHelper().createDom(goog.dom.TagName.B,null,r),l)}var s=e.getAccelerator&&e.getAccelerator();s?e.setContent([o,this.getDomHelper().createDom(goog.dom.TagName.SPAN,goog.ui.MenuItem.ACCELERATOR_CLASS,s)]):e.setContent(o)},goog.ui.FilteredMenu.prototype.handleKeyEventInternal=function(e){return!(e.shiftKey||e.ctrlKey||e.altKey||e.keyCode==goog.events.KeyCodes.HOME||e.keyCode==goog.events.KeyCodes.END)&&(e.keyCode==goog.events.KeyCodes.ESC?(this.dispatchEvent(goog.ui.Component.EventType.BLUR),!0):goog.ui.FilteredMenu.superClass_.handleKeyEventInternal.call(this,e))},goog.ui.FilteredMenu.prototype.setHighlightedIndex=function(e){goog.ui.FilteredMenu.superClass_.setHighlightedIndex.call(this,e);var t=this.getContentElement(),i=this.getHighlighted()?this.getHighlighted().getElement():null;if(this.filterInput_&&goog.a11y.aria.setActiveDescendant(this.filterInput_,i),i&&goog.dom.contains(t,i)){var o=goog.userAgent.IE&&!goog.userAgent.isVersionOrHigher(8)?0:t.offsetTop,n=i.offsetTop+i.offsetHeight-o-(t.clientHeight+t.scrollTop)+1;t.scrollTop+=Math.max(n,0),n=t.scrollTop-(i.offsetTop-o)+1,t.scrollTop-=Math.max(n,0)}},goog.ui.FilteredMenu.prototype.onFilterLabelClick_=function(e){this.filterInput_.focus()},goog.ui.FilteredMenu.prototype.getContentElement=function(){return this.contentElement_||this.getElement()},goog.ui.FilteredMenu.prototype.getFilterInputElement=function(){return this.filterInput_||null},goog.ui.FilteredMenu.prototype.decorateInternal=function(e){this.setElementInternal(e),this.decorateContent(e);var t=this.getDomHelper().getElementsByTagNameAndClass(goog.dom.TagName.DIV,goog.getCssName(this.getRenderer().getCssClass(),"filter"),e)[0];this.labelEl_=goog.dom.getFirstElementChild(t),this.filterInput_=goog.dom.getNextElementSibling(this.labelEl_),this.contentElement_=goog.dom.getNextElementSibling(t),this.getRenderer().decorateChildren(this,t.parentNode,this.contentElement_),this.initFilterInput_()};