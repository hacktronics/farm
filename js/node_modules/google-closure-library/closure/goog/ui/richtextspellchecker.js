goog.provide("goog.ui.RichTextSpellChecker"),goog.require("goog.Timer"),goog.require("goog.asserts"),goog.require("goog.dom"),goog.require("goog.dom.NodeType"),goog.require("goog.dom.Range"),goog.require("goog.events.EventHandler"),goog.require("goog.events.EventType"),goog.require("goog.events.KeyCodes"),goog.require("goog.events.KeyHandler"),goog.require("goog.math.Coordinate"),goog.require("goog.spell.SpellCheck"),goog.require("goog.string.StringBuffer"),goog.require("goog.style"),goog.require("goog.ui.AbstractSpellChecker"),goog.require("goog.ui.Component"),goog.require("goog.ui.PopupMenu"),goog.ui.RichTextSpellChecker=function(e,o){goog.ui.AbstractSpellChecker.call(this,e,o),this.workBuffer_=new goog.string.StringBuffer,this.boundContinueAsyncFn_=goog.bind(this.continueAsync_,this),this.eventHandler_=new goog.events.EventHandler(this),this.registerDisposable(this.eventHandler_),this.keyHandler_=new goog.events.KeyHandler,this.registerDisposable(this.keyHandler_)},goog.inherits(goog.ui.RichTextSpellChecker,goog.ui.AbstractSpellChecker),goog.tagUnsealableClass(goog.ui.RichTextSpellChecker),goog.ui.RichTextSpellChecker.prototype.rootNode_,goog.ui.RichTextSpellChecker.prototype.rootNodeIframe_=!1,goog.ui.RichTextSpellChecker.prototype.currentNode_,goog.ui.RichTextSpellChecker.prototype.elementsInserted_=0,goog.ui.RichTextSpellChecker.prototype.dictionaryPreScanSize_=1e3,goog.ui.RichTextSpellChecker.prototype.wordClassName=goog.getCssName("goog-spellcheck-word"),goog.ui.RichTextSpellChecker.prototype.editorDom_,goog.ui.RichTextSpellChecker.prototype.excludeTags,goog.ui.RichTextSpellChecker.prototype.invalidWordCssText="background: yellow;",goog.ui.RichTextSpellChecker.prototype.createDom=function(){throw new Error("Render not supported for goog.ui.RichTextSpellChecker.")},goog.ui.RichTextSpellChecker.prototype.decorateInternal=function(e){if(this.setElementInternal(e),this.rootNodeIframe_=e.contentDocument||e.contentWindow,this.rootNodeIframe_){var o=e.contentDocument||e.contentWindow.document;this.rootNode_=o.body,this.editorDom_=goog.dom.getDomHelper(o)}else this.rootNode_=e,this.editorDom_=goog.dom.getDomHelper(e)},goog.ui.RichTextSpellChecker.prototype.enterDocument=function(){goog.ui.RichTextSpellChecker.superClass_.enterDocument.call(this);var e=goog.asserts.assertElement(this.rootNode_,"The rootNode_ of a richtextspellchecker must be an Element.");this.keyHandler_.attach(e),this.initSuggestionsMenu()},goog.ui.RichTextSpellChecker.prototype.initSuggestionsMenu=function(){goog.ui.RichTextSpellChecker.base(this,"initSuggestionsMenu");var e=goog.asserts.assertInstanceof(this.getMenu(),goog.ui.PopupMenu,"The menu of a richtextspellchecker must be a PopupMenu.");this.eventHandler_.listen(e,goog.ui.Component.EventType.HIDE,this.onCorrectionHide_)},goog.ui.RichTextSpellChecker.prototype.check=function(){this.blockReadyEvents(),this.preChargeDictionary_(this.rootNode_,this.dictionaryPreScanSize_),this.unblockReadyEvents(),this.eventHandler_.listen(this.spellCheck,goog.spell.SpellCheck.EventType.READY,this.onDictionaryCharged_,!0),this.spellCheck.processPending()},goog.ui.RichTextSpellChecker.prototype.preChargeDictionary_=function(e,o){for(;e;){var t=this.nextNode_(e);if(this.isExcluded_(e))e=t;else{if(e.nodeType==goog.dom.NodeType.TEXT){if(e.nodeValue&&(o-=this.populateDictionary(e.nodeValue,o))<=0)return}else e.nodeType==goog.dom.NodeType.ELEMENT&&e.firstChild&&(t=e.firstChild);e=t}}},goog.ui.RichTextSpellChecker.prototype.onDictionaryCharged_=function(e){e.stopPropagation(),this.eventHandler_.unlisten(this.spellCheck,goog.spell.SpellCheck.EventType.READY,this.onDictionaryCharged_,!0),this.clearWordElements(),this.initializeAsyncMode(),this.elementsInserted_=0,this.processNode_(this.rootNode_)!=goog.ui.AbstractSpellChecker.AsyncResult.PENDING?(this.finishAsyncProcessing(),this.finishCheck_()):goog.Timer.callOnce(this.boundContinueAsyncFn_)},goog.ui.RichTextSpellChecker.prototype.continueAsync_=function(){var e=this.continueAsyncProcessing();e!=goog.ui.AbstractSpellChecker.AsyncResult.PENDING&&(e=this.processNode_(this.currentNode_))!=goog.ui.AbstractSpellChecker.AsyncResult.PENDING?(this.finishAsyncProcessing(),this.finishCheck_()):goog.Timer.callOnce(this.boundContinueAsyncFn_)},goog.ui.RichTextSpellChecker.prototype.finishCheck_=function(){delete this.currentNode_,this.spellCheck.processPending(),this.isVisible()||this.eventHandler_.listen(this.rootNode_,goog.events.EventType.CLICK,this.onWordClick_).listen(this.keyHandler_,goog.events.KeyHandler.EventType.KEY,this.handleRootNodeKeyEvent),goog.ui.RichTextSpellChecker.superClass_.check.call(this)},goog.ui.RichTextSpellChecker.prototype.nextNode_=function(e){for(;e!=this.rootNode_;){if(e.nextSibling)return e.nextSibling;e=e.parentNode}return null},goog.ui.RichTextSpellChecker.prototype.isTextLeaf_=function(e){return null!=e&&e.nodeType==goog.dom.NodeType.TEXT&&!e.firstChild},goog.ui.RichTextSpellChecker.prototype.setExcludeMarker=function(e){if(e){"string"==typeof e&&(e=[e]),this.excludeTags=[],this.excludeMarker=[];for(var o=0;o<e.length;o++){var t=e[o].split(".");2==t.length?(this.excludeTags.push(t[0]),this.excludeMarker.push(t[1])):(this.excludeMarker.push(t[0]),this.excludeTags.push(void 0))}}},goog.ui.RichTextSpellChecker.prototype.isExcluded_=function(e){if(this.excludeMarker&&e.className)for(var o=0;o<this.excludeMarker.length;o++){var t=this.excludeTags[o],i=this.excludeMarker[o];if(!(!i||-1==e.className.indexOf(i)||t&&e.tagName!=t))return!0}return!1},goog.ui.RichTextSpellChecker.prototype.processNode_=function(e){for(delete this.currentNode_;e;){var o=this.nextNode_(e);if(this.isExcluded_(e))e=o;else{if(e.nodeType==goog.dom.NodeType.TEXT){var t=!0;if(e.nodeValue){var i=this.elementsInserted_,r=this.processTextAsync(e,e.nodeValue);if(r==goog.ui.AbstractSpellChecker.AsyncResult.PENDING)return e.nodeValue="",this.currentNode_=e,r;i==this.elementsInserted_&&(t=!1)}t&&goog.dom.removeNode(e)}else if(e.nodeType==goog.dom.NodeType.ELEMENT)if(e.className==this.wordClassName){for(var s=e.firstChild;s;){if(this.isTextLeaf_(s))for(;this.isTextLeaf_(s.nextSibling);)s.nodeValue+=s.nextSibling.nodeValue,goog.dom.removeNode(s.nextSibling);s=s.nextSibling}if(e.firstChild)for(o=e.firstChild;e.firstChild;)e.parentNode.insertBefore(e.firstChild,e);goog.dom.removeNode(e)}else e.firstChild&&(o=e.firstChild);e=o}}},goog.ui.RichTextSpellChecker.prototype.processWord=function(e,o,t){e.parentNode.insertBefore(this.createWordElement(o,t),e),this.elementsInserted_++},goog.ui.RichTextSpellChecker.prototype.processRange=function(e,o){e.nodeType==goog.dom.NodeType.TEXT&&e.nodeValue.length==o.length||(e.parentNode.insertBefore(this.editorDom_.createTextNode(o),e),this.elementsInserted_++)},goog.ui.RichTextSpellChecker.prototype.getElementByIndex=function(e){return this.editorDom_.getElement(this.makeElementId(e))},goog.ui.RichTextSpellChecker.prototype.updateElement=function(e,o,t){t==goog.spell.SpellCheck.WordStatus.VALID&&e!=this.currentNode_&&e.nextSibling!=this.currentNode_?this.removeMarkup(e):goog.dom.setProperties(e,this.getElementProperties(t))},goog.ui.RichTextSpellChecker.prototype.resume=function(){goog.ui.RichTextSpellChecker.superClass_.resume.call(this),this.restoreNode_(this.rootNode_),this.eventHandler_.unlisten(this.rootNode_,goog.events.EventType.CLICK,this.onWordClick_).unlisten(this.keyHandler_,goog.events.KeyHandler.EventType.KEY,this.handleRootNodeKeyEvent)},goog.ui.RichTextSpellChecker.prototype.restoreNode_=function(e){for(;e;)if(this.isExcluded_(e))e=e.nextSibling;else if(e.nodeType!=goog.dom.NodeType.ELEMENT||e.className!=this.wordClassName){if(this.isTextLeaf_(e)){var o=1;for(t=e.nextSibling;this.isTextLeaf_(e.previousSibling);)e=e.previousSibling,++o;for(;this.isTextLeaf_(t);)t=t.nextSibling,++o;if(o>1){for(this.workBuffer_.append(e.nodeValue);this.isTextLeaf_(e.nextSibling);)this.workBuffer_.append(e.nextSibling.nodeValue),goog.dom.removeNode(e.nextSibling);e.nodeValue=this.workBuffer_.toString(),this.workBuffer_.clear()}}e.firstChild&&this.restoreNode_(e.firstChild),e=e.nextSibling}else{for(var t,i=e.firstChild,r=i;r;r=t)t=r.nextSibling,e.parentNode.insertBefore(r,e);t=i||e.nextSibling,goog.dom.removeNode(e),e=t}},goog.ui.RichTextSpellChecker.prototype.getElementProperties=function(e){return{class:this.wordClassName,style:e==goog.spell.SpellCheck.WordStatus.INVALID?this.invalidWordCssText:""}},goog.ui.RichTextSpellChecker.prototype.onWordClick_=function(e){var o=e.target;e.target.className==this.wordClassName&&this.spellCheck.checkWord(goog.dom.getTextContent(o))==goog.spell.SpellCheck.WordStatus.INVALID&&(this.showSuggestionsMenu(o,e),e.stopPropagation())},goog.ui.RichTextSpellChecker.prototype.disposeInternal=function(){goog.ui.RichTextSpellChecker.superClass_.disposeInternal.call(this),this.rootNode_=null,this.editorDom_=null},goog.ui.RichTextSpellChecker.prototype.isEditorIframe=function(){return this.rootNodeIframe_},goog.ui.RichTextSpellChecker.prototype.handleRootNodeKeyEvent=function(e){var o=!1;switch(e.keyCode){case goog.events.KeyCodes.RIGHT:e.ctrlKey&&(o=this.navigate(goog.ui.AbstractSpellChecker.Direction.NEXT));break;case goog.events.KeyCodes.LEFT:e.ctrlKey&&(o=this.navigate(goog.ui.AbstractSpellChecker.Direction.PREVIOUS));break;case goog.events.KeyCodes.DOWN:if(this.getFocusedElementIndex()){var t=this.editorDom_.getElement(this.makeElementId(this.getFocusedElementIndex()));if(t){var i=goog.style.getClientPosition(t);if(this.isEditorIframe()){var r=goog.style.getClientPosition(this.getElementStrict());i=goog.math.Coordinate.sum(r,i)}var s=goog.style.getSize(t);i.x+=s.width/2,i.y+=s.height/2,this.showSuggestionsMenu(t,i),o=!0}}}return o&&e.preventDefault(),o},goog.ui.RichTextSpellChecker.prototype.onCorrectionAction=function(e){goog.ui.RichTextSpellChecker.base(this,"onCorrectionAction",e),e.target!=this.getMenuEdit()&&this.reFocus_()},goog.ui.RichTextSpellChecker.prototype.onCorrectionHide_=function(e){this.reFocus_()},goog.ui.RichTextSpellChecker.prototype.reFocus_=function(){this.getElementStrict().focus();var e=this.getElementByIndex(this.getFocusedElementIndex());e&&this.focusOnElement(e)},goog.ui.RichTextSpellChecker.prototype.focusOnElement=function(e){goog.dom.Range.createCaret(e,0).select()};