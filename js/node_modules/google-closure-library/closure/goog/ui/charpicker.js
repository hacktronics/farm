goog.provide("goog.ui.CharPicker"),goog.require("goog.a11y.aria"),goog.require("goog.a11y.aria.State"),goog.require("goog.array"),goog.require("goog.asserts"),goog.require("goog.dom"),goog.require("goog.dom.TagName"),goog.require("goog.dom.classlist"),goog.require("goog.events"),goog.require("goog.events.Event"),goog.require("goog.events.EventHandler"),goog.require("goog.events.EventType"),goog.require("goog.events.InputHandler"),goog.require("goog.events.KeyCodes"),goog.require("goog.events.KeyHandler"),goog.require("goog.i18n.CharListDecompressor"),goog.require("goog.i18n.CharPickerData"),goog.require("goog.i18n.uChar"),goog.require("goog.i18n.uChar.NameFetcher"),goog.require("goog.structs.Set"),goog.require("goog.style"),goog.require("goog.ui.Button"),goog.require("goog.ui.Component"),goog.require("goog.ui.ContainerScroller"),goog.require("goog.ui.FlatButtonRenderer"),goog.require("goog.ui.HoverCard"),goog.require("goog.ui.LabelInput"),goog.require("goog.ui.Menu"),goog.require("goog.ui.MenuButton"),goog.require("goog.ui.MenuItem"),goog.require("goog.ui.Tooltip"),goog.ui.CharPicker=function(e,t,o,i,g,r,s,n){goog.ui.Component.call(this,n),this.charNameFetcher_=t,this.data_=e,this.initCategory_=i||0,this.initSubcategory_=g||0,this.columnCount_=s||10,this.gridsize_=(r||10)*this.columnCount_,this.recentwidth_=this.columnCount_+1,this.recents_=o||[],this.eventHandler_=new goog.events.EventHandler(this),this.decompressor_=new goog.i18n.CharListDecompressor},goog.inherits(goog.ui.CharPicker,goog.ui.Component),goog.ui.CharPicker.prototype.selectedChar_=null,goog.ui.CharPicker.prototype.layoutAlteringChars_=null,goog.ui.CharPicker.prototype.menu_=null,goog.ui.CharPicker.prototype.menubutton_=null,goog.ui.CharPicker.prototype.submenu_=null,goog.ui.CharPicker.prototype.submenubutton_=null,goog.ui.CharPicker.prototype.itempos,goog.ui.CharPicker.prototype.items,goog.ui.CharPicker.prototype.keyHandler_,goog.ui.CharPicker.prototype.category,goog.ui.CharPicker.prototype.stick_=null,goog.ui.CharPicker.prototype.stickwrap_=null,goog.ui.CharPicker.prototype.grid_=null,goog.ui.CharPicker.prototype.notice_=null,goog.ui.CharPicker.prototype.recentgrid_=null,goog.ui.CharPicker.prototype.input_=null,goog.ui.CharPicker.prototype.okbutton_=null,goog.ui.CharPicker.prototype.charNameEl_=null,goog.ui.CharPicker.prototype.zoomEl_=null,goog.ui.CharPicker.prototype.unicodeEl_=null,goog.ui.CharPicker.prototype.hc_=null,goog.ui.CharPicker.prototype.getSelectedChar=function(){return this.selectedChar_},goog.ui.CharPicker.prototype.getRecentChars=function(){return this.recents_},goog.ui.CharPicker.prototype.createDom=function(){goog.ui.CharPicker.superClass_.createDom.call(this),this.decorateInternal(this.getDomHelper().createElement(goog.dom.TagName.DIV))},goog.ui.CharPicker.prototype.disposeInternal=function(){goog.dispose(this.hc_),this.hc_=null,goog.dispose(this.eventHandler_),this.eventHandler_=null,goog.ui.CharPicker.superClass_.disposeInternal.call(this)},goog.ui.CharPicker.prototype.decorateInternal=function(e){goog.ui.CharPicker.superClass_.decorateInternal.call(this,e);var t=this.decompressor_.toCharList(":2%C^O80V1H2s2G40Q%s0");this.layoutAlteringChars_=new goog.structs.Set(t),this.menu_=new goog.ui.Menu(this.getDomHelper());for(var o=this.data_.categories,i=0;i<this.data_.categories.length;i++)this.menu_.addChild(this.createMenuItem_(i,o[i]),!0);this.menubutton_=new goog.ui.MenuButton("Category Menu",this.menu_,void 0,this.getDomHelper()),this.addChild(this.menubutton_,!0),this.submenu_=new goog.ui.Menu(this.getDomHelper()),this.submenubutton_=new goog.ui.MenuButton("Subcategory Menu",this.submenu_,void 0,this.getDomHelper()),this.addChild(this.submenubutton_,!0);var g=new goog.ui.Component(this.getDomHelper());this.addChild(g,!0);var r=new goog.ui.Component(this.getDomHelper());g.addChild(r,!0),this.stickwrap_=r.getElement();var s=new goog.ui.Component(this.getDomHelper());r.addChild(s,!0),this.stick_=s.getElement(),this.grid_=new goog.ui.Component(this.getDomHelper()),g.addChild(this.grid_,!0),this.notice_=new goog.ui.Component(this.getDomHelper()),this.notice_.setElementInternal(this.getDomHelper().createDom(goog.dom.TagName.DIV)),this.addChild(this.notice_,!0);var n=goog.getMsg("Recent Selections:"),a=new goog.ui.Component(this.getDomHelper());a.setElementInternal(this.getDomHelper().createDom(goog.dom.TagName.SPAN,null,n)),this.addChild(a,!0),this.recentgrid_=new goog.ui.Component(this.getDomHelper()),this.addChild(this.recentgrid_,!0);var h=new goog.ui.Component(this.getDomHelper());h.setElementInternal(this.getDomHelper().createDom(goog.dom.TagName.SPAN,null,"U+")),this.addChild(h,!0);var u=goog.getMsg("Hex Input");this.input_=new goog.ui.LabelInput(u,this.getDomHelper()),this.addChild(this.input_,!0),this.okbutton_=new goog.ui.Button("OK",void 0,this.getDomHelper()),this.addChild(this.okbutton_,!0),this.okbutton_.setEnabled(!1),this.zoomEl_=this.getDomHelper().createDom(goog.dom.TagName.DIV,{id:"zoom",className:goog.getCssName("goog-char-picker-char-zoom")}),this.charNameEl_=this.getDomHelper().createDom(goog.dom.TagName.DIV,{id:"charName",className:goog.getCssName("goog-char-picker-name")}),this.unicodeEl_=this.getDomHelper().createDom(goog.dom.TagName.DIV,{id:"unicode",className:goog.getCssName("goog-char-picker-unicode")});var c=this.getDomHelper().createDom(goog.dom.TagName.DIV,{id:"preview"},this.zoomEl_,this.charNameEl_,this.unicodeEl_);goog.style.setElementShown(c,!1),this.hc_=new goog.ui.HoverCard({DIV:"char"},void 0,this.getDomHelper()),this.hc_.setElement(c);var l=this;goog.events.listen(this.hc_,goog.ui.HoverCard.EventType.BEFORE_SHOW,function(){var e=l.hc_.getAnchorElement(),t=l.getChar_(e);t&&(goog.dom.setTextContent(l.zoomEl_,l.displayChar_(t)),goog.dom.setTextContent(l.unicodeEl_,goog.i18n.uChar.toHexString(t)),goog.dom.setTextContent(l.charNameEl_,""),l.charNameFetcher_.getName(t,function(e){e&&goog.dom.setTextContent(l.charNameEl_,e)}))}),goog.asserts.assert(e),goog.dom.classlist.add(e,goog.getCssName("goog-char-picker")),goog.dom.classlist.add(goog.asserts.assert(this.stick_),goog.getCssName("goog-stick")),goog.dom.classlist.add(goog.asserts.assert(this.stickwrap_),goog.getCssName("goog-stickwrap")),goog.dom.classlist.add(goog.asserts.assert(g.getElement()),goog.getCssName("goog-char-picker-grid-container")),goog.dom.classlist.add(goog.asserts.assert(this.grid_.getElement()),goog.getCssName("goog-char-picker-grid")),goog.dom.classlist.add(goog.asserts.assert(this.recentgrid_.getElement()),goog.getCssName("goog-char-picker-grid")),goog.dom.classlist.add(goog.asserts.assert(this.recentgrid_.getElement()),goog.getCssName("goog-char-picker-recents")),goog.dom.classlist.add(goog.asserts.assert(this.notice_.getElement()),goog.getCssName("goog-char-picker-notice")),goog.dom.classlist.add(goog.asserts.assert(h.getElement()),goog.getCssName("goog-char-picker-uplus")),goog.dom.classlist.add(goog.asserts.assert(this.input_.getElement()),goog.getCssName("goog-char-picker-input-box")),goog.dom.classlist.add(goog.asserts.assert(this.okbutton_.getElement()),goog.getCssName("goog-char-picker-okbutton")),goog.dom.classlist.add(goog.asserts.assert(c),goog.getCssName("goog-char-picker-hovercard")),this.hc_.className=goog.getCssName("goog-char-picker-hovercard"),this.grid_.buttoncount=this.gridsize_,this.recentgrid_.buttoncount=this.recentwidth_,this.populateGridWithButtons_(this.grid_),this.populateGridWithButtons_(this.recentgrid_),this.updateGrid_(this.recentgrid_,this.recents_),this.setSelectedCategory_(this.initCategory_,this.initSubcategory_),new goog.ui.ContainerScroller(this.menu_),new goog.ui.ContainerScroller(this.submenu_),goog.dom.classlist.add(goog.asserts.assert(this.menu_.getElement()),goog.getCssName("goog-char-picker-menu")),goog.dom.classlist.add(goog.asserts.assert(this.submenu_.getElement()),goog.getCssName("goog-char-picker-menu"))},goog.ui.CharPicker.prototype.enterDocument=function(){goog.ui.CharPicker.superClass_.enterDocument.call(this);var e=new goog.events.InputHandler(this.input_.getElement());this.keyHandler_=new goog.events.KeyHandler(this.input_.getElement()),this.eventHandler_.listen(this.menubutton_,goog.ui.Component.EventType.ACTION,goog.events.Event.stopPropagation).listen(this.submenubutton_,goog.ui.Component.EventType.ACTION,goog.events.Event.stopPropagation).listen(this,goog.ui.Component.EventType.ACTION,this.handleSelectedItem_,!0).listen(e,goog.events.InputHandler.EventType.INPUT,this.handleInput_).listen(this.keyHandler_,goog.events.KeyHandler.EventType.KEY,this.handleEnter_).listen(this.recentgrid_,goog.ui.Component.EventType.FOCUS,this.handleFocus_).listen(this.grid_,goog.ui.Component.EventType.FOCUS,this.handleFocus_),goog.events.listen(this.okbutton_.getElement(),goog.events.EventType.MOUSEDOWN,this.handleOkClick_,!0,this),goog.events.listen(this.stickwrap_,goog.events.EventType.SCROLL,this.handleScroll_,!0,this)},goog.ui.CharPicker.prototype.handleFocus_=function(e){var t=e.target.getElement(),o=this.getChar_(t);goog.a11y.aria.setState(t,goog.a11y.aria.State.LABEL,""),o&&this.charNameFetcher_.getName(o,function(e){e&&goog.a11y.aria.setState(t,goog.a11y.aria.State.LABEL,e)})},goog.ui.CharPicker.prototype.handleScroll_=function(e){var t=e.target.scrollHeight,o=e.target.scrollTop,i=Math.ceil(o*this.items.length/(this.columnCount_*t))*this.columnCount_;this.itempos!=i&&(this.itempos=i,this.modifyGridWithItems_(this.grid_,this.items,i)),e.stopPropagation()},goog.ui.CharPicker.prototype.handleSelectedItem_=function(e){var t=e.target.getParent();if(t==this.menu_)this.menu_.setVisible(!1),this.setSelectedCategory_(e.target.getValue());else if(t==this.submenu_)this.submenu_.setVisible(!1),this.setSelectedSubcategory_(e.target.getValue());else if(t==this.grid_){var o=e.target.getElement();this.selectedChar_=this.getChar_(o),this.updateRecents_(this.selectedChar_)}else t==this.recentgrid_&&(this.selectedChar_=this.getChar_(e.target.getElement()))},goog.ui.CharPicker.prototype.handleInput_=function(e){var t=this.getInputChar();if(t){goog.dom.setTextContent(this.zoomEl_,t),goog.dom.setTextContent(this.unicodeEl_,goog.i18n.uChar.toHexString(t)),goog.dom.setTextContent(this.charNameEl_,"");var o=new goog.ui.Tooltip.ElementTooltipPosition(this.input_.getElement());this.hc_.setPosition(o),this.hc_.triggerForElement(this.input_.getElement()),this.okbutton_.setEnabled(!0)}else this.hc_.cancelTrigger(),this.hc_.setVisible(!1),this.okbutton_.setEnabled(!1)},goog.ui.CharPicker.prototype.handleOkClick_=function(e){var t=this.getInputChar();return!(!t||!t.charCodeAt(0))&&(this.selectedChar_=t,this.updateRecents_(t),!0)},goog.ui.CharPicker.prototype.handleEnter_=function(e){return e.keyCode==goog.events.KeyCodes.ENTER&&(!!this.handleOkClick_()&&this.dispatchEvent(goog.ui.Component.EventType.ACTION))},goog.ui.CharPicker.prototype.getChar_=function(e){return e.getAttribute("char")},goog.ui.CharPicker.prototype.createMenuItem_=function(e,t){var o=new goog.ui.MenuItem(t,e,this.getDomHelper());return o.setVisible(!0),o},goog.ui.CharPicker.prototype.setSelectedCategory_=function(e,t){for(this.category=e,this.menubutton_.setCaption(this.data_.categories[e]);this.submenu_.hasChildren();)this.submenu_.removeChildAt(0,!0).dispose();for(var o=this.data_.subcategories[e],i=0;i<o.length;i++){var g=this.createMenuItem_(i,o[i]);this.submenu_.addChild(g,!0)}this.setSelectedSubcategory_(t||0)},goog.ui.CharPicker.prototype.setSelectedSubcategory_=function(e){var t=this.data_.subcategories[this.category][e];this.submenubutton_.setCaption(t),this.setSelectedGrid_(this.category,e)},goog.ui.CharPicker.prototype.setSelectedGrid_=function(e,t){var o=this.data_.charList[e][t],i=this.decompressor_.toCharList(o);this.charNameFetcher_.prefetch(o),this.updateGrid_(this.grid_,i)},goog.ui.CharPicker.prototype.updateGrid_=function(e,t){if(e==this.grid_){var o=goog.getMsg("Please hover over each cell for the character name.");goog.dom.setTextContent(this.notice_.getElement(),this.charNameFetcher_.isNameAvailable(t[0])?o:""),this.items=t,this.stickwrap_.offsetHeight>0?this.stick_.style.height=this.stickwrap_.offsetHeight*t.length/this.gridsize_+"px":this.stick_.style.height=3*this.columnCount_*t.length/this.gridsize_+"em",this.stickwrap_.scrollTop=0}this.modifyGridWithItems_(e,t,0)},goog.ui.CharPicker.prototype.modifyGridWithItems_=function(e,t,o){for(var i=0,g=o;i<e.buttoncount&&g<t.length;i++,g++)this.modifyCharNode_(e.getChildAt(i),t[g]);for(;i<e.buttoncount;i++)e.getChildAt(i).setVisible(!1)},goog.ui.CharPicker.prototype.populateGridWithButtons_=function(e){for(var t=0;t<e.buttoncount;t++){var o=new goog.ui.Button(" ",goog.ui.FlatButtonRenderer.getInstance(),this.getDomHelper());o.setDispatchTransitionEvents(goog.ui.Component.State.FOCUSED,!0),e.addChild(o,!0),o.setVisible(!1);var i=o.getElement();goog.asserts.assert(i,"The button DOM element cannot be null."),goog.a11y.aria.removeRole(i)}},goog.ui.CharPicker.prototype.modifyCharNode_=function(e,t){var o=this.displayChar_(t),i=e.getElement();goog.dom.setTextContent(i,o),i.setAttribute("char",t),e.setVisible(!0)},goog.ui.CharPicker.prototype.updateRecents_=function(e){e&&e.charCodeAt(0)&&!goog.array.contains(this.recents_,e)&&(this.recents_.unshift(e),this.recents_.length>this.recentwidth_&&this.recents_.pop(),this.updateGrid_(this.recentgrid_,this.recents_))},goog.ui.CharPicker.prototype.getInputChar=function(){var e=this.input_.getValue(),t=parseInt(e,16);return goog.i18n.uChar.fromCharCode(t)},goog.ui.CharPicker.prototype.displayChar_=function(e){return this.layoutAlteringChars_.contains(e)?"Â ":e};