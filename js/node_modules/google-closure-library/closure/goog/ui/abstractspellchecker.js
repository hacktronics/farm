goog.provide("goog.ui.AbstractSpellChecker"),goog.provide("goog.ui.AbstractSpellChecker.AsyncResult"),goog.require("goog.a11y.aria"),goog.require("goog.array"),goog.require("goog.asserts"),goog.require("goog.dom"),goog.require("goog.dom.InputType"),goog.require("goog.dom.NodeType"),goog.require("goog.dom.TagName"),goog.require("goog.dom.classlist"),goog.require("goog.dom.selection"),goog.require("goog.events"),goog.require("goog.events.Event"),goog.require("goog.events.EventType"),goog.require("goog.math.Coordinate"),goog.require("goog.spell.SpellCheck"),goog.require("goog.structs.Set"),goog.require("goog.style"),goog.require("goog.ui.Component"),goog.require("goog.ui.MenuItem"),goog.require("goog.ui.MenuSeparator"),goog.require("goog.ui.PopupMenu"),goog.ui.AbstractSpellChecker=function(e,t){goog.ui.Component.call(this,t),this.spellCheck=e,this.wordElements_={},this.inputElements_=[],this.splitRegex_=new RegExp("([^"+goog.spell.SpellCheck.WORD_BOUNDARY_CHARS+"]*)(["+goog.spell.SpellCheck.WORD_BOUNDARY_CHARS+"]*)","g"),goog.events.listen(this.spellCheck,goog.spell.SpellCheck.EventType.WORD_CHANGED,this.onWordChanged_,!1,this)},goog.inherits(goog.ui.AbstractSpellChecker,goog.ui.Component),goog.tagUnsealableClass(goog.ui.AbstractSpellChecker),goog.ui.AbstractSpellChecker.KEY_PREFIX_=":",goog.ui.AbstractSpellChecker.ORIGINAL_="g-spell-original",goog.ui.AbstractSpellChecker.prototype.menu_,goog.ui.AbstractSpellChecker.prototype.menuSeparator_,goog.ui.AbstractSpellChecker.prototype.menuIgnore_,goog.ui.AbstractSpellChecker.prototype.menuEdit_,goog.ui.AbstractSpellChecker.prototype.isVisible_=!1,goog.ui.AbstractSpellChecker.prototype.correctedWords_,goog.ui.AbstractSpellChecker.prototype.suggestionsMenuClassName=goog.getCssName("goog-menu"),goog.ui.AbstractSpellChecker.prototype.markCorrected=!1,goog.ui.AbstractSpellChecker.prototype.activeWord_,goog.ui.AbstractSpellChecker.prototype.activeElement_,goog.ui.AbstractSpellChecker.prototype.asyncMode_=!1,goog.ui.AbstractSpellChecker.prototype.asyncWordsPerBatch_=1e3,goog.ui.AbstractSpellChecker.prototype.asyncText_,goog.ui.AbstractSpellChecker.prototype.asyncRangeStart_,goog.ui.AbstractSpellChecker.prototype.asyncNode_,goog.ui.AbstractSpellChecker.prototype.processedElementsCount_=0,goog.ui.AbstractSpellChecker.prototype.excludeMarker,goog.ui.AbstractSpellChecker.prototype.focusedElementIndex_=0,goog.ui.AbstractSpellChecker.prototype.lastIndex_=0,goog.ui.AbstractSpellChecker.prototype.getSpellCheck=function(){return this.spellCheck},goog.ui.AbstractSpellChecker.prototype.setSpellCheck=function(e){this.spellCheck=e},goog.ui.AbstractSpellChecker.prototype.setHandler=function(e){this.setSpellCheck(e)},goog.ui.AbstractSpellChecker.prototype.getMenu=function(){return this.menu_},goog.ui.AbstractSpellChecker.prototype.getMenuEdit=function(){return this.menuEdit_},goog.ui.AbstractSpellChecker.prototype.getLastIndex=function(){return this.lastIndex_},goog.ui.AbstractSpellChecker.prototype.getNextIndex=function(){return++this.lastIndex_},goog.ui.AbstractSpellChecker.prototype.setExcludeMarker=function(e){this.excludeMarker=e||void 0},goog.ui.AbstractSpellChecker.prototype.check=function(){this.isVisible_=!0,this.markCorrected&&(this.correctedWords_=new goog.structs.Set)},goog.ui.AbstractSpellChecker.prototype.resume=function(){var e;for(this.isVisible_=!1,this.clearWordElements(),this.lastIndex_=0,this.setFocusedElementIndex(0);e=this.inputElements_.pop();)e.parentNode.replaceChild(this.getDomHelper().createTextNode(e.value),e);this.correctedWords_&&this.correctedWords_.clear()},goog.ui.AbstractSpellChecker.prototype.isVisible=function(){return this.isVisible_},goog.ui.AbstractSpellChecker.prototype.clearWordElements=function(){this.wordElements_={}},goog.ui.AbstractSpellChecker.prototype.ignoreWord=function(e){this.spellCheck.setWordStatus(e,goog.spell.SpellCheck.WordStatus.IGNORED)},goog.ui.AbstractSpellChecker.prototype.editWord_=function(e,t){var o=this.getDomHelper().createDom(goog.dom.TagName.INPUT,{type:goog.dom.InputType.TEXT,value:t}),s=goog.style.getSize(e).width;s<50&&(s=50),o.style.width=s+"px",e.parentNode.replaceChild(o,e);try{o.focus(),goog.dom.selection.setCursorPosition(o,t.length)}catch(e){}this.inputElements_.push(o)},goog.ui.AbstractSpellChecker.prototype.replaceWord=function(e,t,o){if(t!=o){e.getAttribute(goog.ui.AbstractSpellChecker.ORIGINAL_)||e.setAttribute(goog.ui.AbstractSpellChecker.ORIGINAL_,t),goog.dom.setTextContent(e,o);var s=this.spellCheck.checkWord(o);this.markCorrected&&this.correctedWords_&&s!=goog.spell.SpellCheck.WordStatus.INVALID&&(this.correctedWords_.add(o),s=goog.spell.SpellCheck.WordStatus.CORRECTED);var r=goog.ui.AbstractSpellChecker.toInternalKey_(t),i=goog.ui.AbstractSpellChecker.toInternalKey_(o),n=this.wordElements_[r];goog.array.remove(n,e),s!=goog.spell.SpellCheck.WordStatus.VALID&&(this.wordElements_[i]?this.wordElements_[i].push(e):this.wordElements_[i]=[e]),this.updateElement(e,o,s),this.dispatchEvent(goog.events.EventType.CHANGE)}},goog.ui.AbstractSpellChecker.prototype.getSuggestions_=function(){var e=this.spellCheck.getSuggestions(this.activeWord_);if(!e[0]){var t=this.activeElement_.getAttribute(goog.ui.AbstractSpellChecker.ORIGINAL_);t&&t!=this.activeWord_&&(e=this.spellCheck.getSuggestions(t))}return e},goog.ui.AbstractSpellChecker.prototype.showSuggestionsMenu=function(e,t){for(this.activeWord_=goog.dom.getTextContent(e),this.activeElement_=e;this.menu_.getChildAt(0)!=this.menuSeparator_;)this.menu_.removeChildAt(0,!0).dispose();for(var o,s=this.getSuggestions_(),r=0;o=s[r];r++)this.menu_.addChildAt(new goog.ui.MenuItem(o,o,this.getDomHelper()),r,!0);if(!s[0]){var i=goog.getMsg("No Suggestions"),n=new goog.ui.MenuItem(i,"",this.getDomHelper());n.setEnabled(!1),this.menu_.addChildAt(n,0,!0)}if(this.markCorrected){var g=this.correctedWords_&&this.correctedWords_.contains(this.activeWord_);this.menuIgnore_.setVisible(!g),this.menuEdit_.setVisible(!0)}else this.menuIgnore_.setVisible(!0),this.menuEdit_.setVisible(!1);if(t){if(!(t instanceof goog.math.Coordinate)){var l=t.clientX,c=t.clientY;if(this.getElement().contentDocument||this.getElement().contentWindow){var p=goog.style.getClientPosition(this.getElement());l+=p.x,c+=p.y}t=new goog.math.Coordinate(l,c)}this.menu_.showAt(t.x,t.y)}else this.menu_.setVisible(!0)},goog.ui.AbstractSpellChecker.prototype.initSuggestionsMenu=function(){this.menu_=new goog.ui.PopupMenu(this.getDomHelper()),this.menuSeparator_=new goog.ui.MenuSeparator(this.getDomHelper());var e=goog.getMsg("Ignore"),t=goog.getMsg("Edit Word");this.menu_.addChild(this.menuSeparator_,!0),this.menuIgnore_=new goog.ui.MenuItem(e,"",this.getDomHelper()),this.menu_.addChild(this.menuIgnore_,!0),this.menuEdit_=new goog.ui.MenuItem(t,"",this.getDomHelper()),this.menuEdit_.setVisible(!1),this.menu_.addChild(this.menuEdit_,!0),this.menu_.setParent(this),this.menu_.render();var o=this.menu_.getElement();goog.asserts.assert(o),goog.dom.classlist.add(o,this.suggestionsMenuClassName),goog.events.listen(this.menu_,goog.ui.Component.EventType.ACTION,this.onCorrectionAction,!1,this)},goog.ui.AbstractSpellChecker.prototype.onCorrectionAction=function(e){var t=this.activeWord_,o=this.activeElement_;e.target==this.menuIgnore_?this.ignoreWord(t):e.target==this.menuEdit_?this.editWord_(o,t):(this.replaceWord(o,t,e.target.getModel()),this.dispatchEvent(goog.ui.Component.EventType.CHANGE)),delete this.activeWord_,delete this.activeElement_},goog.ui.AbstractSpellChecker.prototype.removeMarkup=function(e){var t=e.firstChild,o=t.nodeValue;e.nextSibling&&e.nextSibling.nodeType==goog.dom.NodeType.TEXT?e.previousSibling&&e.previousSibling.nodeType==goog.dom.NodeType.TEXT?(e.previousSibling.nodeValue=e.previousSibling.nodeValue+o+e.nextSibling.nodeValue,this.getDomHelper().removeNode(e.nextSibling)):e.nextSibling.nodeValue=o+e.nextSibling.nodeValue:e.previousSibling&&e.previousSibling.nodeType==goog.dom.NodeType.TEXT?e.previousSibling.nodeValue+=o:e.parentNode.insertBefore(t,e),this.getDomHelper().removeNode(e)},goog.ui.AbstractSpellChecker.prototype.updateElement=function(e,t,o){this.markCorrected&&this.correctedWords_&&this.correctedWords_.contains(t)&&(o=goog.spell.SpellCheck.WordStatus.CORRECTED),o==goog.spell.SpellCheck.WordStatus.VALID?this.removeMarkup(e):goog.dom.setProperties(e,this.getElementProperties(o))},goog.ui.AbstractSpellChecker.prototype.makeElementId=function(e){return this.getId()+"."+(e||this.getNextIndex())},goog.ui.AbstractSpellChecker.prototype.getElementByIndex=function(e){return this.getDomHelper().getElement(this.makeElementId(e))},goog.ui.AbstractSpellChecker.prototype.createWordElement=function(e,t){var o=this.getElementProperties(t);o.id||(o.id=this.makeElementId()),o.tabIndex||(o.tabIndex=-1);var s=this.getDomHelper().createDom(goog.dom.TagName.SPAN,o,e);return goog.a11y.aria.setRole(s,"menuitem"),goog.a11y.aria.setState(s,"haspopup",!0),this.registerWordElement(e,s),s},goog.ui.AbstractSpellChecker.prototype.registerWordElement=function(e,t){var o=goog.ui.AbstractSpellChecker.toInternalKey_(e);this.wordElements_[o]?this.wordElements_[o].push(t):this.wordElements_[o]=[t]},goog.ui.AbstractSpellChecker.prototype.getElementProperties=goog.abstractMethod,goog.ui.AbstractSpellChecker.prototype.onWordChanged_=function(e){var t=goog.ui.AbstractSpellChecker.toInternalKey_(e.word),o=this.wordElements_[t];if(o)for(var s,r=0;s=o[r];r++)this.updateElement(s,e.word,e.status)},goog.ui.AbstractSpellChecker.prototype.disposeInternal=function(){this.isVisible_&&this.resume(),goog.events.unlisten(this.spellCheck,goog.spell.SpellCheck.EventType.WORD_CHANGED,this.onWordChanged_,!1,this),this.menu_&&(this.menu_.dispose(),delete this.menu_,delete this.menuIgnore_,delete this.menuSeparator_),delete this.spellCheck,delete this.wordElements_,goog.ui.AbstractSpellChecker.superClass_.disposeInternal.call(this)},goog.ui.AbstractSpellChecker.prototype.populateDictionary=function(e,t){var o;this.splitRegex_.lastIndex=0;for(var s=0;(o=this.splitRegex_.exec(e))&&0!=o[0].length;){var r=o[1];if(r&&(this.spellCheck.checkWord(r),++s>=t))break}return this.spellCheck.processPending(),s},goog.ui.AbstractSpellChecker.prototype.processWord=function(e,t,o){throw new Error("Need to override processWord_ in derivative class")},goog.ui.AbstractSpellChecker.prototype.processRange=function(e,t){throw new Error("Need to override processRange_ in derivative class")},goog.ui.AbstractSpellChecker.prototype.initializeAsyncMode=function(){if(this.asyncMode_||this.processedElementsCount_||null!=this.asyncText_||this.asyncNode_)throw new Error("Async mode already in progress.");this.asyncMode_=!0,this.processedElementsCount_=0,delete this.asyncText_,this.asyncRangeStart_=0,delete this.asyncNode_,this.blockReadyEvents()},goog.ui.AbstractSpellChecker.prototype.finishAsyncProcessing=function(){if(!this.asyncMode_||null!=this.asyncText_||this.asyncNode_)throw new Error("Async mode not started or there is still text to process.");this.asyncMode_=!1,this.processedElementsCount_=0,this.unblockReadyEvents(),this.spellCheck.processPending()},goog.ui.AbstractSpellChecker.prototype.blockReadyEvents=function(){goog.events.listen(this.spellCheck,goog.spell.SpellCheck.EventType.READY,goog.events.Event.stopPropagation,!0)},goog.ui.AbstractSpellChecker.prototype.unblockReadyEvents=function(){goog.events.unlisten(this.spellCheck,goog.spell.SpellCheck.EventType.READY,goog.events.Event.stopPropagation,!0)},goog.ui.AbstractSpellChecker.prototype.processTextAsync=function(e,t){if(!this.asyncMode_||null!=this.asyncText_||this.asyncNode_)throw new Error("Not in async mode or previous text has not been processed.");this.splitRegex_.lastIndex=0;for(var o,s=0;(o=this.splitRegex_.exec(t))&&0!=o[0].length;){var r=o[1];if(r){var i=this.spellCheck.checkWord(r);if(i!=goog.spell.SpellCheck.WordStatus.VALID){var n=t.substr(s,o.index-s);n&&this.processRange(e,n),s=o.index+r.length,this.processWord(e,r,i)}}if(this.processedElementsCount_++,this.processedElementsCount_>this.asyncWordsPerBatch_)return this.asyncText_=t,this.asyncRangeStart_=s,this.asyncNode_=e,this.processedElementsCount_=0,goog.ui.AbstractSpellChecker.AsyncResult.PENDING}var g=t.substr(s);return g&&this.processRange(e,g),goog.ui.AbstractSpellChecker.AsyncResult.DONE},goog.ui.AbstractSpellChecker.prototype.continueAsyncProcessing=function(){if(!this.asyncMode_||null==this.asyncText_||!this.asyncNode_)throw new Error("Not in async mode or processing not started.");var e=this.asyncNode_,t=this.asyncRangeStart_;goog.asserts.assertNumber(t);for(var o,s=this.asyncText_;(o=this.splitRegex_.exec(s))&&0!=o[0].length;){var r=o[1];if(r){var i=this.spellCheck.checkWord(r);if(i!=goog.spell.SpellCheck.WordStatus.VALID){var n=s.substr(t,o.index-t);n&&this.processRange(e,n),t=o.index+r.length,this.processWord(e,r,i)}}if(this.processedElementsCount_++,this.processedElementsCount_>this.asyncWordsPerBatch_)return this.processedElementsCount_=0,this.asyncRangeStart_=t,goog.ui.AbstractSpellChecker.AsyncResult.PENDING}delete this.asyncText_,this.asyncRangeStart_=0,delete this.asyncNode_;var g=s.substr(t);return g&&this.processRange(e,g),goog.ui.AbstractSpellChecker.AsyncResult.DONE},goog.ui.AbstractSpellChecker.toInternalKey_=function(e){return e in Object.prototype?goog.ui.AbstractSpellChecker.KEY_PREFIX_+e:e},goog.ui.AbstractSpellChecker.prototype.navigate=function(e){var t,o=!1,s=e==goog.ui.AbstractSpellChecker.Direction.NEXT,r=this.getFocusedElementIndex();do{if((r+=s?1:-1)<1||r>this.getLastIndex()){o=!0;break}}while(!(t=this.getElementByIndex(r)));return t&&(this.setFocusedElementIndex(r),this.focusOnElement(t),o=!0),o},goog.ui.AbstractSpellChecker.prototype.getFocusedElementIndex=function(){return this.focusedElementIndex_},goog.ui.AbstractSpellChecker.prototype.setFocusedElementIndex=function(e){this.focusedElementIndex_=e},goog.ui.AbstractSpellChecker.prototype.focusOnElement=function(e){e.focus()},goog.ui.AbstractSpellChecker.Direction={PREVIOUS:0,NEXT:1},goog.ui.AbstractSpellChecker.AsyncResult={PENDING:1,DONE:2};