goog.provide("goog.ui.KeyboardShortcutEvent"),goog.provide("goog.ui.KeyboardShortcutHandler"),goog.provide("goog.ui.KeyboardShortcutHandler.EventType"),goog.provide("goog.ui.KeyboardShortcutHandler.Modifiers"),goog.require("goog.array"),goog.require("goog.asserts"),goog.require("goog.dom.TagName"),goog.require("goog.events"),goog.require("goog.events.Event"),goog.require("goog.events.EventTarget"),goog.require("goog.events.EventType"),goog.require("goog.events.KeyCodes"),goog.require("goog.events.KeyNames"),goog.require("goog.events.Keys"),goog.require("goog.object"),goog.require("goog.ui.KeyboardEventData"),goog.require("goog.ui.SyntheticKeyboardEvent"),goog.require("goog.userAgent"),goog.ui.KeyboardShortcutHandler=function(e){goog.events.EventTarget.call(this),this.shortcuts_={},this.currentTree_=this.shortcuts_,this.lastStrokeTime_=0,this.globalKeys_=goog.object.createSet(goog.ui.KeyboardShortcutHandler.DEFAULT_GLOBAL_KEYS_),this.textInputs_=goog.object.createSet(goog.ui.KeyboardShortcutHandler.DEFAULT_TEXT_INPUTS_),this.alwaysPreventDefault_=!0,this.alwaysStopPropagation_=!1,this.allShortcutsAreGlobal_=!1,this.modifierShortcutsAreGlobal_=!0,this.allowSpaceKeyOnButtons_=!1,this.activeShortcutKeyForGecko_=null,this.initializeKeyListener(e)},goog.inherits(goog.ui.KeyboardShortcutHandler,goog.events.EventTarget),goog.tagUnsealableClass(goog.ui.KeyboardShortcutHandler),goog.ui.KeyboardShortcutHandler.SequenceNode_=function(e){this.shortcut=e||null,this.next=e?null:{}},goog.ui.KeyboardShortcutHandler.createTerminalNode_=function(e){return new goog.ui.KeyboardShortcutHandler.SequenceNode_(e)},goog.ui.KeyboardShortcutHandler.createInternalNode_=function(){return new goog.ui.KeyboardShortcutHandler.SequenceNode_},goog.ui.KeyboardShortcutHandler.SequenceTree_,goog.ui.KeyboardShortcutHandler.MAX_KEY_SEQUENCE_DELAY=1500,goog.ui.KeyboardShortcutHandler.Modifiers={NONE:0,SHIFT:1,CTRL:2,ALT:4,META:8},goog.ui.KeyboardShortcutHandler.DEFAULT_GLOBAL_KEYS_=[goog.events.KeyCodes.ESC,goog.events.KeyCodes.F1,goog.events.KeyCodes.F2,goog.events.KeyCodes.F3,goog.events.KeyCodes.F4,goog.events.KeyCodes.F5,goog.events.KeyCodes.F6,goog.events.KeyCodes.F7,goog.events.KeyCodes.F8,goog.events.KeyCodes.F9,goog.events.KeyCodes.F10,goog.events.KeyCodes.F11,goog.events.KeyCodes.F12,goog.events.KeyCodes.PAUSE],goog.ui.KeyboardShortcutHandler.DEFAULT_TEXT_INPUTS_=["color","date","datetime","datetime-local","email","month","number","password","search","tel","text","time","url","week"],goog.ui.KeyboardShortcutHandler.EventType={SHORTCUT_TRIGGERED:"shortcut",SHORTCUT_PREFIX:"shortcut_"},goog.ui.KeyboardShortcutHandler.nameToKeyCodeCache_,goog.ui.KeyboardShortcutHandler.prototype.keyTarget_,goog.ui.KeyboardShortcutHandler.prototype.isPrintableKey_,goog.ui.KeyboardShortcutHandler.getKeyCode=function(e){if(!goog.ui.KeyboardShortcutHandler.nameToKeyCodeCache_){var o={};for(var t in goog.events.KeyNames)o[goog.events.KeyNames[t]]=goog.events.KeyCodes.normalizeKeyCode(parseInt(t,10));goog.ui.KeyboardShortcutHandler.nameToKeyCodeCache_=o}return goog.ui.KeyboardShortcutHandler.nameToKeyCodeCache_[e]},goog.ui.KeyboardShortcutHandler.prototype.setAlwaysPreventDefault=function(e){this.alwaysPreventDefault_=e},goog.ui.KeyboardShortcutHandler.prototype.getAlwaysPreventDefault=function(){return this.alwaysPreventDefault_},goog.ui.KeyboardShortcutHandler.prototype.setAlwaysStopPropagation=function(e){this.alwaysStopPropagation_=e},goog.ui.KeyboardShortcutHandler.prototype.getAlwaysStopPropagation=function(){return this.alwaysStopPropagation_},goog.ui.KeyboardShortcutHandler.prototype.setAllShortcutsAreGlobal=function(e){this.allShortcutsAreGlobal_=e},goog.ui.KeyboardShortcutHandler.prototype.getAllShortcutsAreGlobal=function(){return this.allShortcutsAreGlobal_},goog.ui.KeyboardShortcutHandler.prototype.setModifierShortcutsAreGlobal=function(e){this.modifierShortcutsAreGlobal_=e},goog.ui.KeyboardShortcutHandler.prototype.getModifierShortcutsAreGlobal=function(){return this.modifierShortcutsAreGlobal_},goog.ui.KeyboardShortcutHandler.prototype.setAllowSpaceKeyOnButtons=function(e){this.allowSpaceKeyOnButtons_=e},goog.ui.KeyboardShortcutHandler.prototype.registerShortcut=function(e,o){goog.ui.KeyboardShortcutHandler.setShortcut_(this.shortcuts_,this.interpretStrokes_(1,arguments),e)},goog.ui.KeyboardShortcutHandler.prototype.unregisterShortcut=function(e){goog.ui.KeyboardShortcutHandler.unsetShortcut_(this.shortcuts_,this.interpretStrokes_(0,arguments))},goog.ui.KeyboardShortcutHandler.prototype.isShortcutRegistered=function(e){return this.checkShortcut_(this.shortcuts_,this.interpretStrokes_(0,arguments))},goog.ui.KeyboardShortcutHandler.prototype.interpretStrokes_=function(e,o){var t;if("string"==typeof o[e])t=goog.array.map(goog.ui.KeyboardShortcutHandler.parseStringShortcut(o[e]),function(e){return goog.asserts.assertNumber(e.keyCode,"A non-modifier key is needed in each stroke."),goog.ui.KeyboardShortcutHandler.makeStroke_(e.key||"",e.keyCode,e.modifiers)});else{var r=o,n=e;for(goog.isArray(o[e])&&(r=o[e],n=0),t=[];n<r.length;n+=2)t.push(goog.ui.KeyboardShortcutHandler.makeStroke_("",r[n],r[n+1]))}return t},goog.ui.KeyboardShortcutHandler.prototype.unregisterAll=function(){this.shortcuts_={}},goog.ui.KeyboardShortcutHandler.prototype.setGlobalKeys=function(e){this.globalKeys_=goog.object.createSet(e)},goog.ui.KeyboardShortcutHandler.prototype.getGlobalKeys=function(){return goog.object.getKeys(this.globalKeys_)},goog.ui.KeyboardShortcutHandler.prototype.disposeInternal=function(){goog.ui.KeyboardShortcutHandler.superClass_.disposeInternal.call(this),this.unregisterAll(),this.clearKeyListener()},goog.ui.KeyboardShortcutHandler.prototype.getEventType=function(e){return goog.ui.KeyboardShortcutHandler.EventType.SHORTCUT_PREFIX+e},goog.ui.KeyboardShortcutHandler.parseStringShortcut=function(e){for(var o,t=(e=e.replace(/[ +]*\+[ +]*/g,"+").replace(/[ ]+/g," ").toLowerCase()).split(" "),r=[],n=0;o=t[n];n++){for(var g,i=o.split("+"),a=null,s=null,u=goog.ui.KeyboardShortcutHandler.Modifiers.NONE,d=0;g=i[d];d++){switch(g){case"shift":u|=goog.ui.KeyboardShortcutHandler.Modifiers.SHIFT;continue;case"ctrl":u|=goog.ui.KeyboardShortcutHandler.Modifiers.CTRL;continue;case"alt":u|=goog.ui.KeyboardShortcutHandler.Modifiers.ALT;continue;case"meta":u|=goog.ui.KeyboardShortcutHandler.Modifiers.META;continue}null!==s&&goog.asserts.fail("At most one non-modifier key can be in a stroke."),s=goog.ui.KeyboardShortcutHandler.getKeyCode(g),goog.asserts.assertNumber(s,"Key name not found in goog.events.KeyNames: "+g),a=g;break}r.push({key:a,keyCode:s,modifiers:u})}return r},goog.ui.KeyboardShortcutHandler.prototype.initializeKeyListener=function(e){this.keyTarget_=e,goog.events.listen(this.keyTarget_,goog.events.EventType.KEYDOWN,this.handleBrowserKeyDown_,void 0,this),goog.events.listen(this.keyTarget_,goog.ui.SyntheticKeyboardEvent.Type.KEYDOWN,this.handleSyntheticKeyDown_,void 0,this),goog.userAgent.WINDOWS&&(goog.events.listen(this.keyTarget_,goog.events.EventType.KEYPRESS,this.handleWindowsBrowserKeyPress_,void 0,this),goog.events.listen(this.keyTarget_,goog.ui.SyntheticKeyboardEvent.Type.KEYPRESS,this.handleWindowsSyntheticKeyPress_,void 0,this)),goog.events.listen(this.keyTarget_,goog.events.EventType.KEYUP,this.handleBrowserKeyUp_,void 0,this),goog.events.listen(this.keyTarget_,goog.ui.SyntheticKeyboardEvent.Type.KEYUP,this.handleSyntheticKeyUp_,void 0,this)},goog.ui.KeyboardShortcutHandler.prototype.handleBrowserKeyUp_=function(e){this.handleKeyUp_(goog.ui.KeyboardEventData.fromBrowserEvent(e))},goog.ui.KeyboardShortcutHandler.prototype.handleSyntheticKeyUp_=function(e){this.handleKeyUp_(e.getData())},goog.ui.KeyboardShortcutHandler.prototype.handleKeyUp_=function(e){goog.userAgent.GECKO&&this.handleGeckoKeyUp_(e),goog.userAgent.WINDOWS&&this.handleWindowsKeyUp_(e)},goog.ui.KeyboardShortcutHandler.prototype.handleGeckoKeyUp_=function(e){goog.events.KeyCodes.SPACE==this.activeShortcutKeyForGecko_&&goog.events.KeyCodes.SPACE==e.getKeyCode()&&e.getPreventDefaultFn()(),this.activeShortcutKeyForGecko_=null},goog.ui.KeyboardShortcutHandler.prototype.isPossiblePrintableKey_=function(e){return goog.userAgent.WINDOWS&&e.getCtrlKey()&&e.getAltKey()},goog.ui.KeyboardShortcutHandler.prototype.handleWindowsBrowserKeyPress_=function(e){this.handleWindowsKeyPress_(goog.ui.KeyboardEventData.fromBrowserEvent(e))},goog.ui.KeyboardShortcutHandler.prototype.handleWindowsSyntheticKeyPress_=function(e){this.handleWindowsKeyPress_(e.getData())},goog.ui.KeyboardShortcutHandler.prototype.handleWindowsKeyPress_=function(e){e.getKeyCode()>32&&this.isPossiblePrintableKey_(e)&&(this.isPrintableKey_=!0)},goog.ui.KeyboardShortcutHandler.prototype.handleWindowsKeyUp_=function(e){!this.isPrintableKey_&&this.isPossiblePrintableKey_(e)&&this.handleKeyDown_(e,!0)},goog.ui.KeyboardShortcutHandler.prototype.clearKeyListener=function(){goog.events.unlisten(this.keyTarget_,goog.events.EventType.KEYDOWN,this.handleBrowserKeyDown_,!1,this),goog.events.unlisten(this.keyTarget_,goog.ui.SyntheticKeyboardEvent.Type.KEYDOWN,this.handleSyntheticKeyDown_,!1,this),goog.userAgent.WINDOWS&&(goog.events.unlisten(this.keyTarget_,goog.events.EventType.KEYPRESS,this.handleWindowsBrowserKeyPress_,!1,this),goog.events.unlisten(this.keyTarget_,goog.ui.SyntheticKeyboardEvent.Type.KEYPRESS,this.handleWindowsSyntheticKeyPress_,!1,this)),goog.events.unlisten(this.keyTarget_,goog.events.EventType.KEYUP,this.handleBrowserKeyUp_,!1,this),goog.events.unlisten(this.keyTarget_,goog.ui.SyntheticKeyboardEvent.Type.KEYUP,this.handleSyntheticKeyUp_,!1,this),this.keyTarget_=null},goog.ui.KeyboardShortcutHandler.setShortcut_=function(e,o,t){var r=o.shift();goog.array.forEach(r,function(t){var r=e[t];if(r&&(0==o.length||r.shortcut))throw new Error("Keyboard shortcut conflicts with existing shortcut")}),o.length?goog.array.forEach(r,function(r){var n=goog.object.setIfUndefined(e,r.toString(),goog.ui.KeyboardShortcutHandler.createInternalNode_()),g=o.slice(0);goog.ui.KeyboardShortcutHandler.setShortcut_(goog.asserts.assert(n.next,"An internal node must have a next map"),g,t)}):goog.array.forEach(r,function(o){e[o]=goog.ui.KeyboardShortcutHandler.createTerminalNode_(t)})},goog.ui.KeyboardShortcutHandler.unsetShortcut_=function(e,o){var t=o.shift();goog.array.forEach(t,function(t){var r=e[t];if(r)if(0==o.length){if(!r.shortcut)return;delete e[t]}else{if(!r.next)return;var n=o.slice(0);goog.ui.KeyboardShortcutHandler.unsetShortcut_(r.next,n),goog.object.isEmpty(r.next)&&delete e[t]}})},goog.ui.KeyboardShortcutHandler.prototype.getNode_=function(e,o){for(var t=0;t<o.length;t++){var r=e[o[t]];if(r)return r}},goog.ui.KeyboardShortcutHandler.prototype.checkShortcut_=function(e,o){for(;o.length>0&&e;){var t=o.shift(),r=this.getNode_(e,t);if(r){if(0==o.length&&r.shortcut)return!0;var n=o.slice(0);if(this.checkShortcut_(r.next,n))return!0}}return!1},goog.ui.KeyboardShortcutHandler.makeStroke_=function(e,o,t){var r=t||0,n=["c_"+o+"_"+r];return""!=e&&n.push("n_"+e+"_"+r),n},goog.ui.KeyboardShortcutHandler.prototype.handleBrowserKeyDown_=function(e){this.handleKeyDown_(goog.ui.KeyboardEventData.fromBrowserEvent(e))},goog.ui.KeyboardShortcutHandler.prototype.handleSyntheticKeyDown_=function(e){this.handleKeyDown_(e.getData())},goog.ui.KeyboardShortcutHandler.prototype.handleKeyDown_=function(e,o){if(this.isValidShortcut_(e))if(o||!this.isPossiblePrintableKey_(e)){var t=goog.events.KeyCodes.normalizeKeyCode(e.getKeyCode()),r=e.getKey(),n=(e.getShiftKey()?goog.ui.KeyboardShortcutHandler.Modifiers.SHIFT:0)|(e.getCtrlKey()?goog.ui.KeyboardShortcutHandler.Modifiers.CTRL:0)|(e.getAltKey()?goog.ui.KeyboardShortcutHandler.Modifiers.ALT:0)|(e.getMetaKey()?goog.ui.KeyboardShortcutHandler.Modifiers.META:0),g=goog.ui.KeyboardShortcutHandler.makeStroke_(r,t,n),i=this.getNode_(this.currentTree_,g);if(i&&!this.hasSequenceTimedOut_()||this.setCurrentTree_(this.shortcuts_),(i=this.getNode_(this.currentTree_,g))&&i.next&&this.setCurrentTree_(i.next),i)if(i.next)e.getPreventDefaultFn()();else{this.setCurrentTree_(this.shortcuts_),this.alwaysPreventDefault_&&e.getPreventDefaultFn()(),this.alwaysStopPropagation_&&e.getStopPropagationFn()();var a=goog.asserts.assertString(i.shortcut,"A terminal node must have a string shortcut identifier."),s=new goog.ui.KeyboardShortcutEvent(goog.ui.KeyboardShortcutHandler.EventType.SHORTCUT_TRIGGERED,a,e.getTarget()),u=this.dispatchEvent(s),d=new goog.ui.KeyboardShortcutEvent(goog.ui.KeyboardShortcutHandler.EventType.SHORTCUT_PREFIX+a,a,e.getTarget());(u&=this.dispatchEvent(d))||e.getPreventDefaultFn()(),goog.userAgent.GECKO&&(this.activeShortcutKeyForGecko_=t)}}else this.isPrintableKey_=!1},goog.ui.KeyboardShortcutHandler.prototype.isValidShortcut_=function(e){var o=e.getKeyCode();if(""!=e.getKey()){var t=e.getKey();if(t==goog.events.Keys.CTRL||t==goog.events.Keys.SHIFT||t==goog.events.Keys.ALT||t==goog.events.Keys.ALTGRAPH)return!1}else if(o==goog.events.KeyCodes.SHIFT||o==goog.events.KeyCodes.CTRL||o==goog.events.KeyCodes.ALT)return!1;var r=e.getRootTarget(),n=r.tagName==goog.dom.TagName.TEXTAREA||r.tagName==goog.dom.TagName.INPUT||r.tagName==goog.dom.TagName.BUTTON||r.tagName==goog.dom.TagName.SELECT,g=!n&&(r.isContentEditable||r.ownerDocument&&"on"==r.ownerDocument.designMode);return!n&&!g||(!(!this.globalKeys_[o]&&!this.allShortcutsAreGlobal_)||!g&&(!(!this.modifierShortcutsAreGlobal_||!(e.getAltKey()||e.getCtrlKey()||e.getMetaKey()))||(r.tagName==goog.dom.TagName.INPUT&&this.textInputs_[r.type]?o==goog.events.KeyCodes.ENTER:(r.tagName==goog.dom.TagName.INPUT||r.tagName==goog.dom.TagName.BUTTON)&&(!!this.allowSpaceKeyOnButtons_||o!=goog.events.KeyCodes.SPACE))))},goog.ui.KeyboardShortcutHandler.prototype.hasSequenceTimedOut_=function(){return goog.now()-this.lastStrokeTime_>=goog.ui.KeyboardShortcutHandler.MAX_KEY_SEQUENCE_DELAY},goog.ui.KeyboardShortcutHandler.prototype.setCurrentTree_=function(e){this.currentTree_=e,this.lastStrokeTime_=goog.now()},goog.ui.KeyboardShortcutEvent=function(e,o,t){goog.events.Event.call(this,e,t),this.identifier=o},goog.inherits(goog.ui.KeyboardShortcutEvent,goog.events.Event);