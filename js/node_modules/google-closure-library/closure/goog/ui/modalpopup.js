goog.provide("goog.ui.ModalPopup"),goog.require("goog.Timer"),goog.require("goog.asserts"),goog.require("goog.dom"),goog.require("goog.dom.TagName"),goog.require("goog.dom.animationFrame"),goog.require("goog.dom.classlist"),goog.require("goog.dom.iframe"),goog.require("goog.events"),goog.require("goog.events.EventType"),goog.require("goog.events.FocusHandler"),goog.require("goog.fx.Transition"),goog.require("goog.string"),goog.require("goog.style"),goog.require("goog.ui.Component"),goog.require("goog.ui.ModalAriaVisibilityHelper"),goog.require("goog.ui.PopupBase"),goog.require("goog.userAgent"),goog.ui.ModalPopup=function(o,t){goog.ui.ModalPopup.base(this,"constructor",t),this.useIframeMask_=!!o,this.lastFocus_=null,this.resizeBackgroundTask_=goog.dom.animationFrame.createTask({mutate:this.resizeBackground_},this)},goog.inherits(goog.ui.ModalPopup,goog.ui.Component),goog.tagUnsealableClass(goog.ui.ModalPopup),goog.ui.ModalPopup.prototype.focusHandler_=null,goog.ui.ModalPopup.prototype.visible_=!1,goog.ui.ModalPopup.prototype.bgEl_=null,goog.ui.ModalPopup.prototype.bgIframeEl_=null,goog.ui.ModalPopup.prototype.tabCatcherElement_=null,goog.ui.ModalPopup.prototype.backwardTabWrapInProgress_=!1,goog.ui.ModalPopup.prototype.popupShowTransition_,goog.ui.ModalPopup.prototype.popupHideTransition_,goog.ui.ModalPopup.prototype.bgShowTransition_,goog.ui.ModalPopup.prototype.bgHideTransition_,goog.ui.ModalPopup.prototype.modalAriaVisibilityHelper_,goog.ui.ModalPopup.prototype.getCssClass=function(){return goog.getCssName("goog-modalpopup")},goog.ui.ModalPopup.prototype.getBackgroundIframe=function(){return this.bgIframeEl_},goog.ui.ModalPopup.prototype.getBackgroundElement=function(){return this.bgEl_},goog.ui.ModalPopup.prototype.createDom=function(){goog.ui.ModalPopup.base(this,"createDom");var o=this.getElement();goog.asserts.assert(o);var t=goog.string.trim(this.getCssClass()).split(" ");goog.dom.classlist.addAll(o,t),goog.dom.setFocusableTabIndex(o,!0),goog.style.setElementShown(o,!1),this.manageBackgroundDom_(),this.createTabCatcher_()},goog.ui.ModalPopup.prototype.manageBackgroundDom_=function(){this.useIframeMask_&&!this.bgIframeEl_&&(this.bgIframeEl_=goog.dom.iframe.createBlank(this.getDomHelper()),this.bgIframeEl_.className=goog.getCssName(this.getCssClass(),"bg"),goog.style.setElementShown(this.bgIframeEl_,!1),goog.style.setOpacity(this.bgIframeEl_,0)),this.bgEl_||(this.bgEl_=this.getDomHelper().createDom(goog.dom.TagName.DIV,goog.getCssName(this.getCssClass(),"bg")),goog.style.setElementShown(this.bgEl_,!1))},goog.ui.ModalPopup.prototype.createTabCatcher_=function(){this.tabCatcherElement_||(this.tabCatcherElement_=this.getDomHelper().createElement(goog.dom.TagName.SPAN),goog.style.setElementShown(this.tabCatcherElement_,!1),goog.dom.setFocusableTabIndex(this.tabCatcherElement_,!0),this.tabCatcherElement_.style.position="absolute")},goog.ui.ModalPopup.prototype.setupBackwardTabWrap=function(){this.backwardTabWrapInProgress_=!0;try{this.tabCatcherElement_.focus()}catch(o){}goog.Timer.callOnce(this.resetBackwardTabWrap_,0,this)},goog.ui.ModalPopup.prototype.resetBackwardTabWrap_=function(){this.backwardTabWrapInProgress_=!1},goog.ui.ModalPopup.prototype.renderBackground_=function(){goog.asserts.assert(!!this.bgEl_,"Background element must not be null."),this.bgIframeEl_&&goog.dom.insertSiblingBefore(this.bgIframeEl_,this.getElement()),goog.dom.insertSiblingBefore(this.bgEl_,this.getElement())},goog.ui.ModalPopup.prototype.canDecorate=function(o){return!!o&&o.tagName==goog.dom.TagName.DIV},goog.ui.ModalPopup.prototype.decorateInternal=function(o){goog.ui.ModalPopup.base(this,"decorateInternal",o);var t=goog.string.trim(this.getCssClass()).split(" ");goog.dom.classlist.addAll(goog.asserts.assert(this.getElement()),t),this.manageBackgroundDom_(),this.createTabCatcher_(),goog.dom.setFocusableTabIndex(this.getElement(),!0),goog.style.setElementShown(this.getElement(),!1)},goog.ui.ModalPopup.prototype.enterDocument=function(){this.renderBackground_(),goog.ui.ModalPopup.base(this,"enterDocument"),goog.dom.insertSiblingAfter(this.tabCatcherElement_,this.getElement()),this.focusHandler_=new goog.events.FocusHandler(this.getDomHelper().getDocument()),this.getHandler().listen(this.focusHandler_,goog.events.FocusHandler.EventType.FOCUSIN,this.onFocus),this.setA11YDetectBackground(!1)},goog.ui.ModalPopup.prototype.exitDocument=function(){this.isVisible()&&this.setVisible(!1),goog.dispose(this.focusHandler_),goog.ui.ModalPopup.base(this,"exitDocument"),goog.dom.removeNode(this.bgIframeEl_),goog.dom.removeNode(this.bgEl_),goog.dom.removeNode(this.tabCatcherElement_)},goog.ui.ModalPopup.prototype.setVisible=function(o){goog.asserts.assert(this.isInDocument(),"ModalPopup must be rendered first."),o!=this.visible_&&(this.popupShowTransition_&&this.popupShowTransition_.stop(),this.bgShowTransition_&&this.bgShowTransition_.stop(),this.popupHideTransition_&&this.popupHideTransition_.stop(),this.bgHideTransition_&&this.bgHideTransition_.stop(),this.isInDocument()&&this.setA11YDetectBackground(o),o?this.show_():this.hide_())},goog.ui.ModalPopup.prototype.setA11YDetectBackground=function(o){this.modalAriaVisibilityHelper_||(this.modalAriaVisibilityHelper_=new goog.ui.ModalAriaVisibilityHelper(this.getElementStrict(),this.dom_)),this.modalAriaVisibilityHelper_.setBackgroundVisibility(o)},goog.ui.ModalPopup.prototype.setTransition=function(o,t,e,i){this.popupShowTransition_=o,this.popupHideTransition_=t,this.bgShowTransition_=e,this.bgHideTransition_=i},goog.ui.ModalPopup.prototype.show_=function(){if(this.dispatchEvent(goog.ui.PopupBase.EventType.BEFORE_SHOW)){try{this.lastFocus_=this.getDomHelper().getDocument().activeElement}catch(o){}this.resizeBackground_(),this.reposition(),this.getHandler().listen(this.getDomHelper().getWindow(),goog.events.EventType.RESIZE,this.resizeBackground_).listen(this.getDomHelper().getWindow(),goog.events.EventType.ORIENTATIONCHANGE,this.resizeBackgroundTask_),this.showPopupElement_(!0),this.focus(),this.visible_=!0,this.popupShowTransition_&&this.bgShowTransition_?(goog.events.listenOnce(this.popupShowTransition_,goog.fx.Transition.EventType.END,this.onShow,!1,this),this.bgShowTransition_.play(),this.popupShowTransition_.play()):this.onShow()}},goog.ui.ModalPopup.prototype.hide_=function(){this.dispatchEvent(goog.ui.PopupBase.EventType.BEFORE_HIDE)&&(this.getHandler().unlisten(this.getDomHelper().getWindow(),goog.events.EventType.RESIZE,this.resizeBackground_).unlisten(this.getDomHelper().getWindow(),goog.events.EventType.ORIENTATIONCHANGE,this.resizeBackgroundTask_),this.visible_=!1,this.popupHideTransition_&&this.bgHideTransition_?(goog.events.listenOnce(this.popupHideTransition_,goog.fx.Transition.EventType.END,this.onHide,!1,this),this.bgHideTransition_.play(),this.popupHideTransition_.play()):this.onHide(),this.returnFocus_())},goog.ui.ModalPopup.prototype.returnFocus_=function(){try{var o=this.getDomHelper(),t=o.getDocument().body,e=o.getDocument().activeElement||t;if(!this.lastFocus_||this.lastFocus_==t)return void(this.lastFocus_=null);(e==t||o.contains(this.getElement(),e))&&this.lastFocus_.focus()}catch(o){}this.lastFocus_=null},goog.ui.ModalPopup.prototype.showPopupElement_=function(o){this.bgIframeEl_&&goog.style.setElementShown(this.bgIframeEl_,o),this.bgEl_&&goog.style.setElementShown(this.bgEl_,o),goog.style.setElementShown(this.getElement(),o),goog.style.setElementShown(this.tabCatcherElement_,o)},goog.ui.ModalPopup.prototype.onShow=function(){this.dispatchEvent(goog.ui.PopupBase.EventType.SHOW)},goog.ui.ModalPopup.prototype.onHide=function(){this.showPopupElement_(!1),this.dispatchEvent(goog.ui.PopupBase.EventType.HIDE)},goog.ui.ModalPopup.prototype.isVisible=function(){return this.visible_},goog.ui.ModalPopup.prototype.focus=function(){this.focusElement_()},goog.ui.ModalPopup.prototype.resizeBackground_=function(){this.bgIframeEl_&&goog.style.setElementShown(this.bgIframeEl_,!1),this.bgEl_&&goog.style.setElementShown(this.bgEl_,!1);var o=this.getDomHelper().getDocument(),t=goog.dom.getWindow(o)||window,e=goog.dom.getViewportSize(t),i=Math.max(e.width,Math.max(o.body.scrollWidth,o.documentElement.scrollWidth)),s=Math.max(e.height,Math.max(o.body.scrollHeight,o.documentElement.scrollHeight));this.bgIframeEl_&&(goog.style.setElementShown(this.bgIframeEl_,!0),goog.style.setSize(this.bgIframeEl_,i,s)),this.bgEl_&&(goog.style.setElementShown(this.bgEl_,!0),goog.style.setSize(this.bgEl_,i,s))},goog.ui.ModalPopup.prototype.reposition=function(){var o=this.getDomHelper().getDocument(),t=goog.dom.getWindow(o)||window;if("fixed"==goog.style.getComputedPosition(this.getElement()))var e=0,i=0;else{var s=this.getDomHelper().getDocumentScroll();e=s.x,i=s.y}var g=goog.style.getSize(this.getElement()),n=goog.dom.getViewportSize(t),a=Math.max(e+n.width/2-g.width/2,0),r=Math.max(i+n.height/2-g.height/2,0);goog.style.setPosition(this.getElement(),a,r),goog.style.setPosition(this.tabCatcherElement_,a,r)},goog.ui.ModalPopup.prototype.onFocus=function(o){this.backwardTabWrapInProgress_?this.resetBackwardTabWrap_():o.target==this.tabCatcherElement_&&goog.Timer.callOnce(this.focusElement_,0,this)},goog.ui.ModalPopup.prototype.getTabCatcherElement=function(){return this.tabCatcherElement_},goog.ui.ModalPopup.prototype.focusElement_=function(){try{goog.userAgent.IE&&this.getDomHelper().getDocument().body.focus(),this.getElement().focus()}catch(o){}},goog.ui.ModalPopup.prototype.disposeInternal=function(){goog.dispose(this.popupShowTransition_),this.popupShowTransition_=null,goog.dispose(this.popupHideTransition_),this.popupHideTransition_=null,goog.dispose(this.bgShowTransition_),this.bgShowTransition_=null,goog.dispose(this.bgHideTransition_),this.bgHideTransition_=null,goog.ui.ModalPopup.base(this,"disposeInternal")};