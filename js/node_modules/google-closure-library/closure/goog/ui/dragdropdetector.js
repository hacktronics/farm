goog.provide("goog.ui.DragDropDetector"),goog.provide("goog.ui.DragDropDetector.EventType"),goog.provide("goog.ui.DragDropDetector.ImageDropEvent"),goog.provide("goog.ui.DragDropDetector.LinkDropEvent"),goog.require("goog.dom"),goog.require("goog.dom.InputType"),goog.require("goog.dom.TagName"),goog.require("goog.events.Event"),goog.require("goog.events.EventHandler"),goog.require("goog.events.EventTarget"),goog.require("goog.events.EventType"),goog.require("goog.math.Coordinate"),goog.require("goog.string"),goog.require("goog.style"),goog.require("goog.userAgent"),goog.ui.DragDropDetector=function(o){goog.ui.DragDropDetector.base(this,"constructor");var e=goog.dom.createDom(goog.dom.TagName.IFRAME,{frameborder:0});e.className=goog.userAgent.IE?goog.getCssName(goog.ui.DragDropDetector.BASE_CSS_NAME_,"ie-editable-iframe"):goog.getCssName(goog.ui.DragDropDetector.BASE_CSS_NAME_,"w3c-editable-iframe"),e.src=o||goog.ui.DragDropDetector.DEFAULT_FILE_PATH_,this.element_=e,this.handler_=new goog.events.EventHandler(this),this.handler_.listen(e,goog.events.EventType.LOAD,this.initIframe_),goog.userAgent.IE?(this.textInput_=goog.dom.createDom(goog.dom.TagName.INPUT,{type:goog.dom.InputType.TEXT,className:goog.getCssName(goog.ui.DragDropDetector.BASE_CSS_NAME_,"ie-input")}),this.root_=goog.dom.createDom(goog.dom.TagName.DIV,goog.getCssName(goog.ui.DragDropDetector.BASE_CSS_NAME_,"ie-div"),this.textInput_,e)):this.root_=e,document.body.appendChild(this.root_)},goog.inherits(goog.ui.DragDropDetector,goog.events.EventTarget),goog.ui.DragDropDetector.EventType={IMAGE_DROPPED:"onimagedrop",LINK_DROPPED:"onlinkdrop"},goog.ui.DragDropDetector.DROP_EVENT_TYPE_=goog.userAgent.IE?goog.events.EventType.DROP:"dragdrop",goog.ui.DragDropDetector.INIT_POSITION=-1e4,goog.ui.DragDropDetector.BASE_CSS_NAME_=goog.getCssName("goog-dragdrop"),goog.ui.DragDropDetector.MSG_DRAG_DROP_LOCAL_FILE_ERROR=goog.getMsg("It is not possible to drag and drop image files at this time.\nPlease drag an image from your web browser."),goog.ui.DragDropDetector.MSG_DRAG_DROP_PROTECTED_FILE_ERROR=goog.getMsg("The image you are trying to drag has been blocked by the hosting site."),goog.ui.DragDropDetector.SPECIAL_CASE_URLS_=[{regex:/^file:\/\/\//,message:goog.ui.DragDropDetector.MSG_DRAG_DROP_LOCAL_FILE_ERROR},{regex:/flickr(.*)spaceball.gif$/,message:goog.ui.DragDropDetector.MSG_DRAG_DROP_PROTECTED_FILE_ERROR}],goog.ui.DragDropDetector.URL_LIKE_REGEX_=/^\S+:\/\/\S*$/,goog.ui.DragDropDetector.DEFAULT_FILE_PATH_="dragdropdetector_target.html",goog.ui.DragDropDetector.prototype.handler_,goog.ui.DragDropDetector.prototype.root_,goog.ui.DragDropDetector.prototype.textInput_,goog.ui.DragDropDetector.prototype.element_,goog.ui.DragDropDetector.prototype.window_=null,goog.ui.DragDropDetector.prototype.document_=null,goog.ui.DragDropDetector.prototype.body_=null,goog.ui.DragDropDetector.prototype.isCoveringScreen_=!1,goog.ui.DragDropDetector.prototype.mousePosition_=null,goog.ui.DragDropDetector.prototype.initIframe_=function(){this.mousePosition_=new goog.math.Coordinate(goog.ui.DragDropDetector.INIT_POSITION,goog.ui.DragDropDetector.INIT_POSITION),this.window_=this.element_.contentWindow,this.document_=this.window_.document,this.body_=this.document_.body,goog.userAgent.GECKO?this.document_.designMode="on":goog.userAgent.IE||(this.body_.contentEditable=!0),this.handler_.listen(document.body,goog.events.EventType.DRAGENTER,this.coverScreen_),goog.userAgent.IE?this.handler_.listen(this.body_,[goog.events.EventType.DRAGENTER,goog.events.EventType.DRAGOVER],goog.ui.DragDropDetector.enforceCopyEffect_).listen(this.body_,goog.events.EventType.MOUSEOUT,this.switchToInput_).listen(this.body_,goog.events.EventType.DRAGLEAVE,this.uncoverScreen_).listen(this.body_,goog.ui.DragDropDetector.DROP_EVENT_TYPE_,function(o){return this.trackMouse_(o),goog.global.setTimeout(goog.bind(this.handleNodeInserted_,this,o),0),!0}).listen(this.root_,[goog.events.EventType.DRAGENTER,goog.events.EventType.DRAGOVER],this.handleNewDrag_).listen(this.root_,[goog.events.EventType.MOUSEMOVE,goog.events.EventType.KEYPRESS],this.uncoverScreen_).listen(this.textInput_,goog.events.EventType.DRAGOVER,goog.events.Event.preventDefault).listen(this.textInput_,goog.ui.DragDropDetector.DROP_EVENT_TYPE_,this.handleInputDrop_):this.handler_.listen(this.body_,goog.ui.DragDropDetector.DROP_EVENT_TYPE_,function(o){this.trackMouse_(o),this.uncoverScreen_()}).listen(this.body_,[goog.events.EventType.MOUSEMOVE,goog.events.EventType.KEYPRESS],this.uncoverScreen_).listen(this.document_,"DOMNodeInserted",this.handleNodeInserted_)},goog.ui.DragDropDetector.enforceCopyEffect_=function(o){var e=o.getBrowserEvent();"copy"!=e.dataTransfer.dropEffect.toLowerCase()&&(e.dataTransfer.dropEffect="copy")},goog.ui.DragDropDetector.prototype.coverScreen_=function(o){goog.userAgent.IE&&"none"==o.getBrowserEvent().dataTransfer.dropEffect||this.isCoveringScreen_||(this.isCoveringScreen_=!0,goog.userAgent.IE?(goog.style.setStyle(this.root_,"top","0"),this.body_.contentEditable=!0,this.switchToInput_(o)):goog.style.setStyle(this.root_,"height","5000px"))},goog.ui.DragDropDetector.prototype.uncoverScreen_=function(){this.isCoveringScreen_&&(this.isCoveringScreen_=!1,goog.userAgent.IE?(this.body_.contentEditable=!1,goog.style.setStyle(this.root_,"top","-5000px")):goog.style.setStyle(this.root_,"height","10px"))},goog.ui.DragDropDetector.prototype.switchToInput_=function(o){this.isCoveringScreen_&&goog.style.setElementShown(this.textInput_,!0)},goog.ui.DragDropDetector.prototype.switchToIframe_=function(o){this.isCoveringScreen_&&goog.style.setElementShown(this.textInput_,!1)},goog.ui.DragDropDetector.prototype.handleNewDrag_=function(o){if("link"==o.getBrowserEvent().dataTransfer.dropEffect)return this.switchToInput_(o),o.preventDefault(),!1;this.switchToIframe_(o)},goog.ui.DragDropDetector.prototype.trackMouse_=function(o){if(this.mousePosition_.x=o.clientX,this.mousePosition_.y=o.clientY,goog.dom.getOwnerDocument(o.target)!=document){var e=goog.style.getClientPosition(this.element_);this.mousePosition_.x+=e.x,this.mousePosition_.y+=e.y}},goog.ui.DragDropDetector.prototype.handleInputDrop_=function(o){this.dispatchEvent(new goog.ui.DragDropDetector.LinkDropEvent(o.getBrowserEvent().dataTransfer.getData("Text"))),this.uncoverScreen_(),o.preventDefault()},goog.ui.DragDropDetector.prototype.clearContents_=function(){goog.userAgent.WEBKIT?goog.global.setTimeout(goog.bind(function(){goog.dom.setTextContent(this,"")},this.body_),0):(this.document_.execCommand("selectAll",!1,null),this.document_.execCommand("delete",!1,null),this.document_.execCommand("selectAll",!1,null))},goog.ui.DragDropDetector.prototype.handleNodeInserted_=function(o){var e;if(-1==this.body_.innerHTML.indexOf("<")&&((e=goog.string.trim(goog.dom.getTextContent(this.body_))).match(goog.ui.DragDropDetector.URL_LIKE_REGEX_)||(e=null)),!e){var t=goog.dom.getElementsByTagName(goog.dom.TagName.IMG,this.body_);if(t&&t.length)e=t[0].src}if(e){for(var g=goog.ui.DragDropDetector.SPECIAL_CASE_URLS_,r=g.length,n=0;n<r;n++){var i=g[n];if(e.match(i.regex)){alert(i.message);break}}if(n==r)return void this.dispatchEvent(new goog.ui.DragDropDetector.ImageDropEvent(e,this.mousePosition_))}var s=goog.dom.getElementsByTagName(goog.dom.TagName.A,this.body_);if(s)for(n=0,r=s.length;n<r;n++)this.dispatchEvent(new goog.ui.DragDropDetector.LinkDropEvent(s[n].href));this.clearContents_(),this.uncoverScreen_()},goog.ui.DragDropDetector.prototype.disposeInternal=function(){goog.ui.DragDropDetector.base(this,"disposeInternal"),this.handler_.dispose(),this.handler_=null},goog.ui.DragDropDetector.ImageDropEvent=function(o,e){goog.ui.DragDropDetector.ImageDropEvent.base(this,"constructor",goog.ui.DragDropDetector.EventType.IMAGE_DROPPED),this.url_=o,this.position_=e},goog.inherits(goog.ui.DragDropDetector.ImageDropEvent,goog.events.Event),goog.ui.DragDropDetector.ImageDropEvent.prototype.getUrl=function(){return this.url_},goog.ui.DragDropDetector.ImageDropEvent.prototype.getPosition=function(){return this.position_},goog.ui.DragDropDetector.LinkDropEvent=function(o){goog.ui.DragDropDetector.LinkDropEvent.base(this,"constructor",goog.ui.DragDropDetector.EventType.LINK_DROPPED),this.url_=o},goog.inherits(goog.ui.DragDropDetector.LinkDropEvent,goog.events.Event),goog.ui.DragDropDetector.LinkDropEvent.prototype.getUrl=function(){return this.url_};