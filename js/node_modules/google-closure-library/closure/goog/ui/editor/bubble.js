goog.provide("goog.ui.editor.Bubble"),goog.require("goog.asserts"),goog.require("goog.dom"),goog.require("goog.dom.TagName"),goog.require("goog.dom.ViewportSizeMonitor"),goog.require("goog.dom.classlist"),goog.require("goog.editor.style"),goog.require("goog.events.EventHandler"),goog.require("goog.events.EventTarget"),goog.require("goog.events.EventType"),goog.require("goog.functions"),goog.require("goog.log"),goog.require("goog.math.Box"),goog.require("goog.object"),goog.require("goog.positioning"),goog.require("goog.positioning.Corner"),goog.require("goog.positioning.Overflow"),goog.require("goog.positioning.OverflowStatus"),goog.require("goog.string"),goog.require("goog.style"),goog.require("goog.ui.Component"),goog.require("goog.ui.PopupBase"),goog.require("goog.userAgent"),goog.ui.editor.Bubble=function(o,e){goog.ui.editor.Bubble.base(this,"constructor"),this.dom_=goog.dom.getDomHelper(o),this.eventHandler_=new goog.events.EventHandler(this),this.viewPortSizeMonitor_=new goog.dom.ViewportSizeMonitor(this.dom_.getWindow()),this.panels_={},this.bubbleContainer_=this.dom_.createDom(goog.dom.TagName.DIV,{className:goog.ui.editor.Bubble.BUBBLE_CLASSNAME}),goog.style.setElementShown(this.bubbleContainer_,!1),goog.dom.appendChild(o,this.bubbleContainer_),goog.style.setStyle(this.bubbleContainer_,"zIndex",e),this.bubbleContents_=this.createBubbleDom(this.dom_,this.bubbleContainer_),this.closeBox_=this.dom_.createDom(goog.dom.TagName.DIV,{className:goog.getCssName("tr_bubble_closebox"),innerHTML:"&nbsp;"}),this.bubbleContents_.appendChild(this.closeBox_),goog.editor.style.makeUnselectable(this.bubbleContainer_,this.eventHandler_),this.popup_=new goog.ui.PopupBase(this.bubbleContainer_)},goog.inherits(goog.ui.editor.Bubble,goog.events.EventTarget),goog.ui.editor.Bubble.BUBBLE_CLASSNAME=goog.getCssName("tr_bubble"),goog.ui.editor.Bubble.prototype.createBubbleDom=function(o,e){return e},goog.ui.editor.Bubble.prototype.logger=goog.log.getLogger("goog.ui.editor.Bubble"),goog.ui.editor.Bubble.prototype.disposeInternal=function(){goog.ui.editor.Bubble.base(this,"disposeInternal"),goog.dom.removeNode(this.bubbleContainer_),this.bubbleContainer_=null,this.eventHandler_.dispose(),this.eventHandler_=null,this.viewPortSizeMonitor_.dispose(),this.viewPortSizeMonitor_=null},goog.ui.editor.Bubble.prototype.getContentElement=function(){return this.bubbleContents_},goog.ui.editor.Bubble.prototype.getContainerElement=function(){return this.bubbleContainer_},goog.ui.editor.Bubble.prototype.getEventHandler=function(){return this.eventHandler_},goog.ui.editor.Bubble.prototype.handleWindowResize_=function(){this.isVisible()&&this.reposition()},goog.ui.editor.Bubble.prototype.setAutoHide=function(o){this.popup_.setAutoHide(o)},goog.ui.editor.Bubble.prototype.hasPanelOfType=function(o){return goog.object.some(this.panels_,function(e){return e.type==o})},goog.ui.editor.Bubble.prototype.addPanel=function(o,e,t,i,g){var n,r=goog.string.createUniqueString(),s=new goog.ui.editor.Bubble.Panel_(this.dom_,r,o,e,t,!g);this.panels_[r]=s;for(var l=0,u=this.bubbleContents_.childNodes.length-1;l<u;l++){var b=this.bubbleContents_.childNodes[l];if(this.panels_[b.id].type>o){n=b;break}}goog.dom.insertSiblingBefore(s.element,n||this.bubbleContents_.lastChild),i(s.getContentElement()),goog.editor.style.makeUnselectable(s.element,this.eventHandler_);var a=goog.object.getCount(this.panels_);return 1==a?this.openBubble_():2==a&&goog.dom.classlist.add(goog.asserts.assert(this.bubbleContainer_),goog.getCssName("tr_multi_bubble")),this.reposition(),r},goog.ui.editor.Bubble.prototype.removePanel=function(o){var e=this.panels_[o];goog.dom.removeNode(e.element),delete this.panels_[o];var t=goog.object.getCount(this.panels_);t<=1&&goog.dom.classlist.remove(goog.asserts.assert(this.bubbleContainer_),goog.getCssName("tr_multi_bubble")),0==t?this.closeBubble_():this.reposition()},goog.ui.editor.Bubble.prototype.openBubble_=function(){this.eventHandler_.listen(this.closeBox_,goog.events.EventType.CLICK,this.closeBubble_).listen(this.viewPortSizeMonitor_,goog.events.EventType.RESIZE,this.handleWindowResize_).listen(this.popup_,goog.ui.PopupBase.EventType.HIDE,this.handlePopupHide),this.popup_.setVisible(!0),this.reposition()},goog.ui.editor.Bubble.prototype.closeBubble_=function(){this.popup_.setVisible(!1)},goog.ui.editor.Bubble.prototype.handlePopupHide=function(){for(var o in this.panels_)goog.dom.removeNode(this.panels_[o].element);this.panels_={},goog.dom.classlist.remove(goog.asserts.assert(this.bubbleContainer_),goog.getCssName("tr_multi_bubble")),this.eventHandler_.removeAll(),this.dispatchEvent(goog.ui.Component.EventType.HIDE)},goog.ui.editor.Bubble.prototype.isVisible=function(){return this.popup_.isVisible()},goog.ui.editor.Bubble.VERTICAL_CLEARANCE_=goog.userAgent.IE?4:2,goog.ui.editor.Bubble.MARGIN_BOX_=new goog.math.Box(goog.ui.editor.Bubble.VERTICAL_CLEARANCE_,0,goog.ui.editor.Bubble.VERTICAL_CLEARANCE_,0),goog.ui.editor.Bubble.prototype.getMarginBox=function(){return goog.ui.editor.Bubble.MARGIN_BOX_},goog.ui.editor.Bubble.prototype.reposition=function(){var o=null,e=!0;for(var t in this.panels_){var i=this.panels_[t];o=i.targetElement,e=e&&i.preferBottomPosition}var g=goog.positioning.OverflowStatus.FAILED,n=goog.style.isRightToLeft(this.bubbleContainer_)!=goog.style.isRightToLeft(o);e&&(g=this.positionAtAnchor_(n?goog.positioning.Corner.BOTTOM_END:goog.positioning.Corner.BOTTOM_START,goog.positioning.Corner.TOP_START,goog.positioning.Overflow.ADJUST_X|goog.positioning.Overflow.FAIL_Y)),g&goog.positioning.OverflowStatus.FAILED&&(g=this.positionAtAnchor_(n?goog.positioning.Corner.TOP_END:goog.positioning.Corner.TOP_START,goog.positioning.Corner.BOTTOM_START,goog.positioning.Overflow.ADJUST_X|goog.positioning.Overflow.FAIL_Y)),g&goog.positioning.OverflowStatus.FAILED&&(g=this.positionAtAnchor_(n?goog.positioning.Corner.BOTTOM_END:goog.positioning.Corner.BOTTOM_START,goog.positioning.Corner.TOP_START,goog.positioning.Overflow.ADJUST_X|goog.positioning.Overflow.ADJUST_Y))&goog.positioning.OverflowStatus.FAILED&&goog.log.warning(this.logger,"reposition(): positionAtAnchor() failed with "+g)},goog.ui.editor.Bubble.prototype.positionAtAnchor_=function(o,e,t){var i=null;for(var g in this.panels_){var n=this.panels_[g].targetElement;i&&!goog.dom.contains(n,i)||(i=this.panels_[g].targetElement)}return goog.positioning.positionAtAnchor(i,o,this.bubbleContainer_,e,null,this.getMarginBox(),t,null,this.getViewportBox())},goog.ui.editor.Bubble.prototype.getViewportBox=goog.functions.NULL,goog.ui.editor.Bubble.Panel_=function(o,e,t,i,g,n){this.type=t,this.targetElement=g,this.preferBottomPosition=n,this.element=o.createDom(goog.dom.TagName.DIV,{className:goog.getCssName("tr_bubble_panel"),id:e},o.createDom(goog.dom.TagName.DIV,{className:goog.getCssName("tr_bubble_panel_title")},i?i+":":""),o.createDom(goog.dom.TagName.DIV,{className:goog.getCssName("tr_bubble_panel_content")}))},goog.ui.editor.Bubble.Panel_.prototype.getContentElement=function(){return this.element.lastChild};