goog.provide("goog.ui.editor.LinkDialog"),goog.provide("goog.ui.editor.LinkDialog.BeforeTestLinkEvent"),goog.provide("goog.ui.editor.LinkDialog.EventType"),goog.provide("goog.ui.editor.LinkDialog.OkEvent"),goog.require("goog.a11y.aria"),goog.require("goog.a11y.aria.State"),goog.require("goog.dom"),goog.require("goog.dom.InputType"),goog.require("goog.dom.TagName"),goog.require("goog.dom.safe"),goog.require("goog.editor.BrowserFeature"),goog.require("goog.editor.Link"),goog.require("goog.editor.focus"),goog.require("goog.editor.node"),goog.require("goog.events.Event"),goog.require("goog.events.EventHandler"),goog.require("goog.events.InputHandler"),goog.require("goog.html.SafeHtml"),goog.require("goog.html.SafeHtmlFormatter"),goog.require("goog.string"),goog.require("goog.string.Unicode"),goog.require("goog.style"),goog.require("goog.ui.Button"),goog.require("goog.ui.Component"),goog.require("goog.ui.LinkButtonRenderer"),goog.require("goog.ui.editor.AbstractDialog"),goog.require("goog.ui.editor.TabPane"),goog.require("goog.ui.editor.messages"),goog.require("goog.userAgent"),goog.require("goog.window"),goog.ui.editor.LinkDialog=function(o,e){goog.ui.editor.LinkDialog.base(this,"constructor",o),this.targetLink_=e,this.eventHandler_=new goog.events.EventHandler(this),this.registerDisposable(this.eventHandler_),this.emailWarning_=null,this.showOpenLinkInNewWindow_=!1,this.focusTextToDisplayOnOpenIfEmpty_=!1,this.isOpenLinkInNewWindowChecked_=!1,this.showRelNoFollow_=!1,this.urlInputHandler_=null,this.emailInputHandler_=null,this.textInputHandler_=null,this.tabPane_=null,this.textToDisplayDiv_=null,this.textToDisplayInput_=null,this.autogenFeatureEnabled_=!0,this.autogenerateTextToDisplay_=!1,this.disableAutogen_=!1,this.openInNewWindowCheckbox_=null,this.relNoFollowCheckbox_=null,this.stopReferrerLeaks_=!1,this.stopTabNabbing_=!1},goog.inherits(goog.ui.editor.LinkDialog,goog.ui.editor.AbstractDialog),goog.ui.editor.LinkDialog.EventType={BEFORE_TEST_LINK:"beforetestlink"},goog.ui.editor.LinkDialog.OkEvent=function(o,e,i,t){goog.ui.editor.LinkDialog.OkEvent.base(this,"constructor",goog.ui.editor.AbstractDialog.EventType.OK),this.linkText=o,this.linkUrl=e,this.openInNewWindow=i,this.noFollow=t},goog.inherits(goog.ui.editor.LinkDialog.OkEvent,goog.events.Event),goog.ui.editor.LinkDialog.BeforeTestLinkEvent=function(o){goog.ui.editor.LinkDialog.BeforeTestLinkEvent.base(this,"constructor",goog.ui.editor.LinkDialog.EventType.BEFORE_TEST_LINK),this.url=o},goog.inherits(goog.ui.editor.LinkDialog.BeforeTestLinkEvent,goog.events.Event),goog.ui.editor.LinkDialog.prototype.setEmailWarning=function(o){this.emailWarning_=o},goog.ui.editor.LinkDialog.prototype.showOpenLinkInNewWindow=function(o){this.showOpenLinkInNewWindow_=!0,this.isOpenLinkInNewWindowChecked_=o},goog.ui.editor.LinkDialog.prototype.focusTextToDisplayOnOpenIfEmpty=function(){this.focusTextToDisplayOnOpenIfEmpty_=!0},goog.ui.editor.LinkDialog.prototype.showRelNoFollow=function(){this.showRelNoFollow_=!0},goog.ui.editor.LinkDialog.prototype.show=function(){goog.ui.editor.LinkDialog.base(this,"show"),this.selectAppropriateTab_(this.textToDisplayInput_.value,this.getTargetUrl_()),this.focusTextToDisplayOnOpenIfEmpty_&&!this.targetLink_.getCurrentText()&&goog.editor.focus.focusInputField(this.textToDisplayInput_),this.syncOkButton_(),this.showOpenLinkInNewWindow_&&(this.targetLink_.isNew()||(this.isOpenLinkInNewWindowChecked_="_blank"==this.targetLink_.getAnchor().target),this.openInNewWindowCheckbox_.checked=this.isOpenLinkInNewWindowChecked_),this.showRelNoFollow_&&(this.relNoFollowCheckbox_.checked=goog.ui.editor.LinkDialog.hasNoFollow(this.targetLink_.getAnchor().rel))},goog.ui.editor.LinkDialog.prototype.hide=function(){this.disableAutogenFlag_(!1),goog.ui.editor.LinkDialog.base(this,"hide")},goog.ui.editor.LinkDialog.prototype.setTextToDisplayVisible=function(o){this.textToDisplayDiv_&&goog.style.setStyle(this.textToDisplayDiv_,"display",o?"block":"none")},goog.ui.editor.LinkDialog.prototype.setStopReferrerLeaks=function(o){this.stopReferrerLeaks_=o},goog.ui.editor.LinkDialog.prototype.setStopTabNabbing=function(o){this.stopTabNabbing_=o},goog.ui.editor.LinkDialog.prototype.setAutogenFeatureEnabled=function(o){this.autogenFeatureEnabled_=o},goog.ui.editor.LinkDialog.hasNoFollow=function(o){return goog.ui.editor.LinkDialog.NO_FOLLOW_REGEX_.test(o)},goog.ui.editor.LinkDialog.removeNoFollow=function(o){return o.replace(goog.ui.editor.LinkDialog.NO_FOLLOW_REGEX_,"")},goog.ui.editor.LinkDialog.prototype.createDialogControl=function(){var o=new goog.ui.editor.AbstractDialog.Builder(this);return o.setTitle(goog.ui.editor.messages.MSG_EDIT_LINK).setContent(this.createDialogContent_()),o.build()},goog.ui.editor.LinkDialog.prototype.createOkEvent=function(){return this.tabPane_.getCurrentTabId()==goog.ui.editor.LinkDialog.Id_.EMAIL_ADDRESS_TAB?this.createOkEventFromEmailTab_():this.createOkEventFromWebTab_()},goog.ui.editor.LinkDialog.NO_FOLLOW_REGEX_=/\bnofollow\b/i,goog.ui.editor.LinkDialog.prototype.createDialogContent_=function(){this.textToDisplayDiv_=this.buildTextToDisplayDiv_();var o=this.dom.createDom(goog.dom.TagName.DIV,null,this.textToDisplayDiv_);return this.tabPane_=new goog.ui.editor.TabPane(this.dom,goog.ui.editor.messages.MSG_LINK_TO),this.registerDisposable(this.tabPane_),this.tabPane_.addTab(goog.ui.editor.LinkDialog.Id_.ON_WEB_TAB,goog.ui.editor.messages.MSG_ON_THE_WEB,goog.ui.editor.messages.MSG_ON_THE_WEB_TIP,goog.ui.editor.LinkDialog.BUTTON_GROUP_,this.buildTabOnTheWeb_()),this.tabPane_.addTab(goog.ui.editor.LinkDialog.Id_.EMAIL_ADDRESS_TAB,goog.ui.editor.messages.MSG_EMAIL_ADDRESS,goog.ui.editor.messages.MSG_EMAIL_ADDRESS_TIP,goog.ui.editor.LinkDialog.BUTTON_GROUP_,this.buildTabEmailAddress_()),this.tabPane_.render(o),this.eventHandler_.listen(this.tabPane_,goog.ui.Component.EventType.SELECT,this.onChangeTab_),this.showOpenLinkInNewWindow_&&o.appendChild(this.buildOpenInNewWindowDiv_()),this.showRelNoFollow_&&o.appendChild(this.buildRelNoFollowDiv_()),o},goog.ui.editor.LinkDialog.prototype.buildTextToDisplayDiv_=function(){var o=this.dom.createTable(1,2);o.cellSpacing="0",o.cellPadding="0",o.style.fontSize="10pt";var e=this.dom.createDom(goog.dom.TagName.DIV),i=goog.html.SafeHtml.create("span",{style:{position:"relative",bottom:"2px","padding-right":"1px","white-space":"nowrap"},id:goog.ui.editor.LinkDialog.Id_.TEXT_TO_DISPLAY_LABEL},[goog.ui.editor.messages.MSG_TEXT_TO_DISPLAY,goog.string.Unicode.NBSP]);goog.dom.safe.setInnerHtml(o.rows[0].cells[0],i),this.textToDisplayInput_=this.dom.createDom(goog.dom.TagName.INPUT,{id:goog.ui.editor.LinkDialog.Id_.TEXT_TO_DISPLAY});var t=this.textToDisplayInput_;return goog.style.setStyle(t,"width","98%"),goog.style.setStyle(o.rows[0].cells[1],"width","100%"),goog.dom.appendChild(o.rows[0].cells[1],t),goog.a11y.aria.setState(t,goog.a11y.aria.State.LABELLEDBY,goog.ui.editor.LinkDialog.Id_.TEXT_TO_DISPLAY_LABEL),t.value=this.targetLink_.getCurrentText(),this.textInputHandler_=new goog.events.InputHandler(t),this.registerDisposable(this.textInputHandler_),this.eventHandler_.listen(this.textInputHandler_,goog.events.InputHandler.EventType.INPUT,this.onTextToDisplayEdit_),goog.dom.appendChild(e,o),e},goog.ui.editor.LinkDialog.prototype.buildOpenInNewWindowDiv_=function(){return this.openInNewWindowCheckbox_=this.dom.createDom(goog.dom.TagName.INPUT,{type:goog.dom.InputType.CHECKBOX}),this.dom.createDom(goog.dom.TagName.DIV,null,this.dom.createDom(goog.dom.TagName.LABEL,null,this.openInNewWindowCheckbox_,goog.ui.editor.messages.MSG_OPEN_IN_NEW_WINDOW))},goog.ui.editor.LinkDialog.prototype.buildRelNoFollowDiv_=function(){var o=new goog.html.SafeHtmlFormatter,e=goog.getMsg("Add '{$relNoFollow}' attribute ({$linkStart}Learn more{$linkEnd})",{relNoFollow:"rel=nofollow",linkStart:o.startTag("a",{href:"http://support.google.com/webmasters/bin/answer.py?hl=en&answer=96569",target:"_blank"}),linkEnd:o.endTag("a")});return this.relNoFollowCheckbox_=this.dom.createDom(goog.dom.TagName.INPUT,{type:goog.dom.InputType.CHECKBOX}),this.dom.createDom(goog.dom.TagName.DIV,null,this.dom.createDom(goog.dom.TagName.LABEL,null,this.relNoFollowCheckbox_,goog.dom.safeHtmlToNode(o.format(e))))},goog.ui.editor.LinkDialog.prototype.buildTabOnTheWeb_=function(){var o=this.dom.createElement(goog.dom.TagName.DIV),e=this.dom.createDom(goog.dom.TagName.DIV,{},this.dom.createDom(goog.dom.TagName.B,{},goog.ui.editor.messages.MSG_WHAT_URL)),i=this.dom.createDom(goog.dom.TagName.INPUT,{id:goog.ui.editor.LinkDialog.Id_.ON_WEB_INPUT,className:goog.ui.editor.LinkDialog.TARGET_INPUT_CLASSNAME_});goog.a11y.aria.setState(i,goog.a11y.aria.State.LABELLEDBY,goog.ui.editor.LinkDialog.Id_.ON_WEB_TAB),goog.userAgent.IE&&!goog.userAgent.isVersionOrHigher("10")||(i.type=goog.dom.InputType.URL),goog.editor.BrowserFeature.NEEDS_99_WIDTH_IN_STANDARDS_MODE&&goog.editor.node.isStandardsMode(i)&&(i.style.width="99%");var t=this.dom.createDom(goog.dom.TagName.DIV,null,i);this.urlInputHandler_=new goog.events.InputHandler(i),this.registerDisposable(this.urlInputHandler_),this.eventHandler_.listen(this.urlInputHandler_,goog.events.InputHandler.EventType.INPUT,this.onUrlOrEmailInputChange_);var g=new goog.ui.Button(goog.ui.editor.messages.MSG_TEST_THIS_LINK,goog.ui.LinkButtonRenderer.getInstance(),this.dom);g.render(t),g.getElement().style.marginTop="1em",this.eventHandler_.listen(g,goog.ui.Component.EventType.ACTION,this.onWebTestLink_);var n=this.dom.createDom(goog.dom.TagName.DIV,goog.ui.editor.LinkDialog.EXPLANATION_TEXT_CLASSNAME_);return goog.dom.safe.setInnerHtml(n,goog.ui.editor.messages.getTrLinkExplanationSafeHtml()),o.appendChild(e),o.appendChild(t),o.appendChild(n),o},goog.ui.editor.LinkDialog.prototype.buildTabEmailAddress_=function(){var o=this.dom.createDom(goog.dom.TagName.DIV),e=this.dom.createDom(goog.dom.TagName.DIV,{},this.dom.createDom(goog.dom.TagName.B,{},goog.ui.editor.messages.MSG_WHAT_EMAIL));goog.dom.appendChild(o,e);var i=this.dom.createDom(goog.dom.TagName.INPUT,{id:goog.ui.editor.LinkDialog.Id_.EMAIL_ADDRESS_INPUT,className:goog.ui.editor.LinkDialog.TARGET_INPUT_CLASSNAME_});if(goog.a11y.aria.setState(i,goog.a11y.aria.State.LABELLEDBY,goog.ui.editor.LinkDialog.Id_.EMAIL_ADDRESS_TAB),goog.editor.BrowserFeature.NEEDS_99_WIDTH_IN_STANDARDS_MODE&&goog.editor.node.isStandardsMode(i)&&(i.style.width="99%"),goog.dom.appendChild(o,i),this.emailInputHandler_=new goog.events.InputHandler(i),this.registerDisposable(this.emailInputHandler_),this.eventHandler_.listen(this.emailInputHandler_,goog.events.InputHandler.EventType.INPUT,this.onUrlOrEmailInputChange_),goog.dom.appendChild(o,this.dom.createDom(goog.dom.TagName.DIV,{id:goog.ui.editor.LinkDialog.Id_.EMAIL_WARNING,className:goog.ui.editor.LinkDialog.EMAIL_WARNING_CLASSNAME_,style:"visibility:hidden"},goog.ui.editor.messages.MSG_INVALID_EMAIL)),this.emailWarning_){var t=this.dom.createDom(goog.dom.TagName.DIV,goog.ui.editor.LinkDialog.EXPLANATION_TEXT_CLASSNAME_);goog.dom.safe.setInnerHtml(t,this.emailWarning_),goog.dom.appendChild(o,t)}return o},goog.ui.editor.LinkDialog.prototype.getTargetUrl_=function(){return this.targetLink_.getAnchor().getAttribute("href")||""},goog.ui.editor.LinkDialog.prototype.selectAppropriateTab_=function(o,e){this.isNewLink_()?this.guessUrlAndSelectTab_(o):goog.editor.Link.isMailto(e)?(this.tabPane_.setSelectedTabId(goog.ui.editor.LinkDialog.Id_.EMAIL_ADDRESS_TAB),this.dom.getElement(goog.ui.editor.LinkDialog.Id_.EMAIL_ADDRESS_INPUT).value=e.substring(e.indexOf(":")+1),this.setAutogenFlagFromCurInput_()):(this.tabPane_.setSelectedTabId(goog.ui.editor.LinkDialog.Id_.ON_WEB_TAB),this.dom.getElement(goog.ui.editor.LinkDialog.Id_.ON_WEB_INPUT).value=this.isNewLink_()?"http://":e,this.setAutogenFlagFromCurInput_())},goog.ui.editor.LinkDialog.prototype.guessUrlAndSelectTab_=function(o){goog.editor.Link.isLikelyEmailAddress(o)?(this.tabPane_.setSelectedTabId(goog.ui.editor.LinkDialog.Id_.EMAIL_ADDRESS_TAB),this.dom.getElement(goog.ui.editor.LinkDialog.Id_.EMAIL_ADDRESS_INPUT).value=o,this.setAutogenFlag_(!0),this.disableAutogenFlag_(!0)):goog.editor.Link.isLikelyUrl(o)?(this.tabPane_.setSelectedTabId(goog.ui.editor.LinkDialog.Id_.ON_WEB_TAB),this.dom.getElement(goog.ui.editor.LinkDialog.Id_.ON_WEB_INPUT).value=o,this.setAutogenFlag_(!0),this.disableAutogenFlag_(!0)):(this.targetLink_.getCurrentText()||this.setAutogenFlag_(!0),this.tabPane_.setSelectedTabId(goog.ui.editor.LinkDialog.Id_.ON_WEB_TAB))},goog.ui.editor.LinkDialog.prototype.syncOkButton_=function(){var o;if(this.tabPane_.getCurrentTabId()==goog.ui.editor.LinkDialog.Id_.EMAIL_ADDRESS_TAB)o=this.dom.getElement(goog.ui.editor.LinkDialog.Id_.EMAIL_ADDRESS_INPUT).value,this.toggleInvalidEmailWarning_(""!=o&&!goog.editor.Link.isLikelyEmailAddress(o));else{if(this.tabPane_.getCurrentTabId()!=goog.ui.editor.LinkDialog.Id_.ON_WEB_TAB)return;o=this.dom.getElement(goog.ui.editor.LinkDialog.Id_.ON_WEB_INPUT).value}this.getOkButtonElement().disabled=goog.string.isEmptyOrWhitespace(o)},goog.ui.editor.LinkDialog.prototype.toggleInvalidEmailWarning_=function(o){this.dom.getElement(goog.ui.editor.LinkDialog.Id_.EMAIL_WARNING).style.visibility=o?"visible":"hidden"},goog.ui.editor.LinkDialog.prototype.onTextToDisplayEdit_=function(){""==this.textToDisplayInput_.value?this.setAutogenFlag_(!0):this.setAutogenFlagFromCurInput_()},goog.ui.editor.LinkDialog.prototype.createOkEventFromWebTab_=function(){var o=this.dom.getElement(goog.ui.editor.LinkDialog.Id_.ON_WEB_INPUT).value;return goog.editor.Link.isLikelyEmailAddress(o)?this.createOkEventFromEmailTab_(goog.ui.editor.LinkDialog.Id_.ON_WEB_INPUT):(o.search(/:/)<0&&(o="http://"+goog.string.trimLeft(o)),this.createOkEventFromUrl_(o))},goog.ui.editor.LinkDialog.prototype.createOkEventFromEmailTab_=function(o){var e=this.dom.getElement(o||goog.ui.editor.LinkDialog.Id_.EMAIL_ADDRESS_INPUT).value;return e="mailto:"+e,this.createOkEventFromUrl_(e)},goog.ui.editor.LinkDialog.prototype.onWebTestLink_=function(){var o=this.dom.getElement(goog.ui.editor.LinkDialog.Id_.ON_WEB_INPUT).value;if(o.search(/:/)<0&&(o="http://"+goog.string.trimLeft(o)),this.dispatchEvent(new goog.ui.editor.LinkDialog.BeforeTestLinkEvent(o))){var e=this.dom.getWindow(),i=goog.dom.getViewportSize(e),t={target:"_blank",width:Math.max(i.width-50,50),height:Math.max(i.height-50,50),toolbar:!0,scrollbars:!0,location:!0,statusbar:!1,menubar:!0,resizable:!0,noreferrer:this.stopReferrerLeaks_,noopener:this.stopTabNabbing_};goog.window.open(o,t,e)}},goog.ui.editor.LinkDialog.prototype.onUrlOrEmailInputChange_=function(){this.autogenerateTextToDisplay_?this.setTextToDisplayFromAuto_():""==this.textToDisplayInput_.value&&this.setAutogenFlagFromCurInput_(),this.syncOkButton_()},goog.ui.editor.LinkDialog.prototype.onChangeTab_=function(o){var e=o.target,i=this.dom.getElement(e.getId()+goog.ui.editor.LinkDialog.Id_.TAB_INPUT_SUFFIX);goog.editor.focus.focusInputField(i),i.style.width="",i.style.width=i.offsetWidth+"px",this.syncOkButton_(),this.setTextToDisplayFromAuto_()},goog.ui.editor.LinkDialog.prototype.setTextToDisplayFromAuto_=function(){if(this.autogenFeatureEnabled_&&this.autogenerateTextToDisplay_){var o=this.tabPane_.getCurrentTabId()+goog.ui.editor.LinkDialog.Id_.TAB_INPUT_SUFFIX;this.textToDisplayInput_.value=this.dom.getElement(o).value}},goog.ui.editor.LinkDialog.prototype.setAutogenFlag_=function(o){this.autogenerateTextToDisplay_=o},goog.ui.editor.LinkDialog.prototype.disableAutogenFlag_=function(o){this.setAutogenFlag_(!o),this.disableAutogen_=o},goog.ui.editor.LinkDialog.prototype.createOkEventFromUrl_=function(o){return this.setTextToDisplayFromAuto_(),this.showOpenLinkInNewWindow_&&(this.isOpenLinkInNewWindowChecked_=this.openInNewWindowCheckbox_.checked),new goog.ui.editor.LinkDialog.OkEvent(this.textToDisplayInput_.value,o,this.showOpenLinkInNewWindow_&&this.isOpenLinkInNewWindowChecked_,this.showRelNoFollow_&&this.relNoFollowCheckbox_.checked)},goog.ui.editor.LinkDialog.prototype.setAutogenFlagFromCurInput_=function(){var o=!1;this.disableAutogen_||(o=this.dom.getElement(this.tabPane_.getCurrentTabId()+goog.ui.editor.LinkDialog.Id_.TAB_INPUT_SUFFIX).value==this.textToDisplayInput_.value);this.setAutogenFlag_(o)},goog.ui.editor.LinkDialog.prototype.isNewLink_=function(){return this.targetLink_.isNew()},goog.ui.editor.LinkDialog.Id_={TEXT_TO_DISPLAY:"linkdialog-text",TEXT_TO_DISPLAY_LABEL:"linkdialog-text-label",ON_WEB_TAB:"linkdialog-onweb",ON_WEB_INPUT:"linkdialog-onweb-tab-input",EMAIL_ADDRESS_TAB:"linkdialog-email",EMAIL_ADDRESS_INPUT:"linkdialog-email-tab-input",EMAIL_WARNING:"linkdialog-email-warning",TAB_INPUT_SUFFIX:"-tab-input"},goog.ui.editor.LinkDialog.BUTTON_GROUP_="linkdialog-buttons",goog.ui.editor.LinkDialog.TARGET_INPUT_CLASSNAME_=goog.getCssName("tr-link-dialog-target-input"),goog.ui.editor.LinkDialog.EMAIL_WARNING_CLASSNAME_=goog.getCssName("tr-link-dialog-email-warning"),goog.ui.editor.LinkDialog.EXPLANATION_TEXT_CLASSNAME_=goog.getCssName("tr-link-dialog-explanation-text");