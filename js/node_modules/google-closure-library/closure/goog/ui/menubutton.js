goog.provide("goog.ui.MenuButton"),goog.require("goog.Timer"),goog.require("goog.a11y.aria"),goog.require("goog.a11y.aria.State"),goog.require("goog.asserts"),goog.require("goog.dom"),goog.require("goog.events.EventType"),goog.require("goog.events.KeyCodes"),goog.require("goog.events.KeyHandler"),goog.require("goog.math.Box"),goog.require("goog.math.Coordinate"),goog.require("goog.math.Rect"),goog.require("goog.positioning"),goog.require("goog.positioning.Corner"),goog.require("goog.positioning.MenuAnchoredPosition"),goog.require("goog.positioning.Overflow"),goog.require("goog.style"),goog.require("goog.ui.Button"),goog.require("goog.ui.Component"),goog.require("goog.ui.IdGenerator"),goog.require("goog.ui.Menu"),goog.require("goog.ui.MenuButtonRenderer"),goog.require("goog.ui.MenuItem"),goog.require("goog.ui.MenuRenderer"),goog.require("goog.ui.SubMenu"),goog.require("goog.ui.registry"),goog.require("goog.userAgent"),goog.require("goog.userAgent.product"),goog.ui.MenuButton=function(e,t,o,n,i){goog.ui.Button.call(this,e,o||goog.ui.MenuButtonRenderer.getInstance(),n),this.setSupportedState(goog.ui.Component.State.OPENED,!0),this.menuPosition_=new goog.positioning.MenuAnchoredPosition(null,goog.positioning.Corner.BOTTOM_START),t&&this.setMenu(t),this.menuMargin_=null,this.timer_=new goog.Timer(500),!goog.userAgent.product.IPHONE&&!goog.userAgent.product.IPAD||goog.userAgent.isVersionOrHigher("533.17.9")||this.setFocusablePopupMenu(!0),this.menuRenderer_=i||goog.ui.MenuRenderer.getInstance()},goog.inherits(goog.ui.MenuButton,goog.ui.Button),goog.tagUnsealableClass(goog.ui.MenuButton),goog.ui.MenuButton.prototype.menu_,goog.ui.MenuButton.prototype.positionElement_,goog.ui.MenuButton.prototype.menuMargin_,goog.ui.MenuButton.prototype.isFocusablePopupMenu_=!1,goog.ui.MenuButton.prototype.timer_,goog.ui.MenuButton.prototype.buttonRect_,goog.ui.MenuButton.prototype.viewportBox_,goog.ui.MenuButton.prototype.originalSize_,goog.ui.MenuButton.prototype.renderMenuAsSibling_=!1,goog.ui.MenuButton.prototype.selectFirstOnEnterOrSpace_=!1,goog.ui.MenuButton.prototype.enterDocument=function(){goog.ui.MenuButton.superClass_.enterDocument.call(this),this.attachKeyDownEventListener_(!0),this.menu_&&this.attachMenuEventListeners_(this.menu_,!0),goog.a11y.aria.setState(this.getElementStrict(),goog.a11y.aria.State.HASPOPUP,!!this.menu_)},goog.ui.MenuButton.prototype.exitDocument=function(){if(goog.ui.MenuButton.superClass_.exitDocument.call(this),this.attachKeyDownEventListener_(!1),this.menu_){this.setOpen(!1),this.menu_.exitDocument(),this.attachMenuEventListeners_(this.menu_,!1);var e=this.menu_.getElement();e&&goog.dom.removeNode(e)}},goog.ui.MenuButton.prototype.disposeInternal=function(){goog.ui.MenuButton.superClass_.disposeInternal.call(this),this.menu_&&(this.menu_.dispose(),delete this.menu_),delete this.positionElement_,this.timer_.dispose()},goog.ui.MenuButton.prototype.handleMouseDown=function(e){goog.ui.MenuButton.superClass_.handleMouseDown.call(this,e),this.isActive()&&(this.setOpen(!this.isOpen(),e),this.menu_&&this.menu_.setMouseButtonPressed(this.isOpen()))},goog.ui.MenuButton.prototype.handleMouseUp=function(e){goog.ui.MenuButton.superClass_.handleMouseUp.call(this,e),this.menu_&&!this.isActive()&&this.menu_.setMouseButtonPressed(!1)},goog.ui.MenuButton.prototype.performActionInternal=function(e){return this.setActive(!1),!0},goog.ui.MenuButton.prototype.handleDocumentMouseDown=function(e){this.menu_&&this.menu_.isVisible()&&!this.containsElement(e.target)&&this.setOpen(!1)},goog.ui.MenuButton.prototype.containsElement=function(e){return e&&goog.dom.contains(this.getElement(),e)||this.menu_&&this.menu_.containsElement(e)||!1},goog.ui.MenuButton.prototype.handleKeyEventInternal=function(e){if(e.keyCode==goog.events.KeyCodes.SPACE){if(e.preventDefault(),e.type!=goog.events.EventType.KEYUP)return!0}else if(e.type!=goog.events.KeyHandler.EventType.KEY)return!1;if(this.menu_&&this.menu_.isVisible()){const t=e.keyCode==goog.events.KeyCodes.ENTER||e.keyCode==goog.events.KeyCodes.SPACE,o=this.menu_.handleKeyEvent(e);return o&&this.menu_&&this.menu_.getOpenItem()instanceof goog.ui.SubMenu||e.keyCode!=goog.events.KeyCodes.ESC&&!t?o:(this.setOpen(!1),!0)}return(e.keyCode==goog.events.KeyCodes.DOWN||e.keyCode==goog.events.KeyCodes.UP||e.keyCode==goog.events.KeyCodes.SPACE||e.keyCode==goog.events.KeyCodes.ENTER)&&(this.setOpen(!0,e),!0)},goog.ui.MenuButton.prototype.handleMenuAction=function(e){this.setOpen(!1)},goog.ui.MenuButton.prototype.handleMenuBlur=function(e){this.isActive()||this.setOpen(!1)},goog.ui.MenuButton.prototype.handleBlur=function(e){this.isFocusablePopupMenu()||this.setOpen(!1),goog.ui.MenuButton.superClass_.handleBlur.call(this,e)},goog.ui.MenuButton.prototype.getMenu=function(){return this.menu_||this.setMenu(new goog.ui.Menu(this.getDomHelper(),this.menuRenderer_)),this.menu_||null},goog.ui.MenuButton.prototype.setMenu=function(e){var t=this.menu_;return e!=t&&(t&&(this.setOpen(!1),this.isInDocument()&&this.attachMenuEventListeners_(t,!1),delete this.menu_),this.isInDocument()&&goog.a11y.aria.setState(this.getElementStrict(),goog.a11y.aria.State.HASPOPUP,!!e),e&&(this.menu_=e,e.setParent(this),e.setVisible(!1),e.setAllowAutoFocus(this.isFocusablePopupMenu()),this.isInDocument()&&this.attachMenuEventListeners_(e,!0))),t},goog.ui.MenuButton.prototype.setMenuPosition=function(e){e&&(this.menuPosition_=e,this.positionElement_=e.element)},goog.ui.MenuButton.prototype.setPositionElement=function(e){this.positionElement_=e,this.positionMenu()},goog.ui.MenuButton.prototype.setMenuMargin=function(e){this.menuMargin_=e},goog.ui.MenuButton.prototype.setSelectFirstOnEnterOrSpace=function(e){this.selectFirstOnEnterOrSpace_=e},goog.ui.MenuButton.prototype.addItem=function(e){this.getMenu().addChild(e,!0)},goog.ui.MenuButton.prototype.addItemAt=function(e,t){this.getMenu().addChildAt(e,t,!0)},goog.ui.MenuButton.prototype.removeItem=function(e){var t=this.getMenu().removeChild(e,!0);t&&t.dispose()},goog.ui.MenuButton.prototype.removeItemAt=function(e){var t=this.getMenu().removeChildAt(e,!0);t&&t.dispose()},goog.ui.MenuButton.prototype.getItemAt=function(e){return this.menu_?this.menu_.getChildAt(e):null},goog.ui.MenuButton.prototype.getItemCount=function(){return this.menu_?this.menu_.getChildCount():0},goog.ui.MenuButton.prototype.setVisible=function(e,t){var o=goog.ui.MenuButton.superClass_.setVisible.call(this,e,t);return o&&!this.isVisible()&&this.setOpen(!1),o},goog.ui.MenuButton.prototype.setEnabled=function(e){goog.ui.MenuButton.superClass_.setEnabled.call(this,e),this.isEnabled()||this.setOpen(!1)},goog.ui.MenuButton.prototype.isAlignMenuToStart=function(){var e=this.menuPosition_.corner;return e==goog.positioning.Corner.BOTTOM_START||e==goog.positioning.Corner.TOP_START},goog.ui.MenuButton.prototype.setAlignMenuToStart=function(e){this.menuPosition_.corner=e?goog.positioning.Corner.BOTTOM_START:goog.positioning.Corner.BOTTOM_END},goog.ui.MenuButton.prototype.setScrollOnOverflow=function(e){if(this.menuPosition_.setLastResortOverflow){var t=goog.positioning.Overflow.ADJUST_X,o=e?goog.positioning.Overflow.RESIZE_HEIGHT:goog.positioning.Overflow.ADJUST_Y;this.menuPosition_.setLastResortOverflow(t|o)}},goog.ui.MenuButton.prototype.isScrollOnOverflow=function(){return this.menuPosition_.getLastResortOverflow&&!!(this.menuPosition_.getLastResortOverflow()&goog.positioning.Overflow.RESIZE_HEIGHT)},goog.ui.MenuButton.prototype.isFocusablePopupMenu=function(){return this.isFocusablePopupMenu_},goog.ui.MenuButton.prototype.setFocusablePopupMenu=function(e){this.isFocusablePopupMenu_=e},goog.ui.MenuButton.prototype.setRenderMenuAsSibling=function(e){this.renderMenuAsSibling_=e},goog.ui.MenuButton.prototype.showMenu=function(){this.setOpen(!0)},goog.ui.MenuButton.prototype.hideMenu=function(){this.setOpen(!1)},goog.ui.MenuButton.prototype.setOpen=function(e,t){if(goog.ui.MenuButton.superClass_.setOpen.call(this,e),this.menu_&&this.hasState(goog.ui.Component.State.OPENED)==e){if(e){if(!this.menu_.isInDocument())if(this.renderMenuAsSibling_){var o=goog.dom.getNextElementSibling(this.getElement());o?this.menu_.renderBefore(o):this.menu_.render(this.getElement().parentNode)}else this.menu_.render();this.viewportBox_=goog.style.getVisibleRectForElement(this.getElement()),this.buttonRect_=goog.style.getBounds(this.getElement()),this.positionMenu();var n=!!t&&(t.keyCode==goog.events.KeyCodes.ENTER||t.keyCode==goog.events.KeyCodes.SPACE);!!t&&(t.keyCode==goog.events.KeyCodes.DOWN||t.keyCode==goog.events.KeyCodes.UP)||n&&this.selectFirstOnEnterOrSpace_?this.menu_.highlightFirst():this.menu_.setHighlightedIndex(-1)}else{this.setActive(!1),this.menu_.setMouseButtonPressed(!1);var i=this.getElement();if(i&&(goog.a11y.aria.setState(i,goog.a11y.aria.State.ACTIVEDESCENDANT,""),goog.a11y.aria.setState(i,goog.a11y.aria.State.OWNS,"")),null!=this.originalSize_){this.originalSize_=void 0;var u=this.menu_.getElement();u&&goog.style.setSize(u,"","")}}this.menu_.setVisible(e,!1,t),this.isDisposed()||this.attachPopupListeners_(e)}this.menu_&&this.menu_.getElement()&&goog.a11y.aria.removeState(this.menu_.getElementStrict(),goog.a11y.aria.State.HIDDEN)},goog.ui.MenuButton.prototype.invalidateMenuSize=function(){this.originalSize_=void 0},goog.ui.MenuButton.prototype.positionMenu=function(){if(this.menu_.isInDocument()){var e=this.positionElement_||this.getElement(),t=this.menuPosition_;this.menuPosition_.element=e;var o=this.menu_.getElement();this.menu_.isVisible()||(o.style.visibility="hidden",goog.style.setElementShown(o,!0)),!this.originalSize_&&this.isScrollOnOverflow()&&(this.originalSize_=goog.style.getSize(o));var n=goog.positioning.flipCornerVertical(t.corner);t.reposition(o,n,this.menuMargin_,this.originalSize_),this.menu_.isVisible()||(goog.style.setElementShown(o,!1),o.style.visibility="visible")}},goog.ui.MenuButton.prototype.onTick_=function(e){var t=goog.style.getBounds(this.getElement()),o=goog.style.getVisibleRectForElement(this.getElement());if(!goog.math.Rect.equals(this.buttonRect_,t)||!goog.math.Box.equals(this.viewportBox_,o)){if(this.menu_.isInDocument()&&o&&this.viewportBox_&&o.getWidth()<this.viewportBox_.getWidth()){var n=this.menu_.getElement();this.menu_.isVisible()||(n.style.visibility="hidden",goog.style.setElementShown(n,!0)),goog.style.setPosition(n,new goog.math.Coordinate(0,0))}this.buttonRect_=t,this.viewportBox_=o,this.positionMenu()}},goog.ui.MenuButton.prototype.attachMenuEventListeners_=function(e,t){var o=this.getHandler(),n=t?o.listen:o.unlisten;n.call(o,e,goog.ui.Component.EventType.ACTION,this.handleMenuAction),n.call(o,e,goog.ui.Component.EventType.CLOSE,this.handleCloseItem),n.call(o,e,goog.ui.Component.EventType.HIGHLIGHT,this.handleHighlightItem),n.call(o,e,goog.ui.Component.EventType.UNHIGHLIGHT,this.handleUnHighlightItem)},goog.ui.MenuButton.prototype.attachKeyDownEventListener_=function(e){var t=this.getHandler();(e?t.listen:t.unlisten).call(t,this.getElement(),goog.events.EventType.KEYDOWN,this.handleKeyDownEvent_)},goog.ui.MenuButton.prototype.handleHighlightItem=function(e){var t=e.target.getElement();t&&this.setAriaActiveDescendant_(t)},goog.ui.MenuButton.prototype.handleKeyDownEvent_=function(e){this.isSupportedState(goog.ui.Component.State.FOCUSED)&&this.getKeyEventTarget()&&this.menu_&&this.menu_.isVisible()&&e.stopPropagation()},goog.ui.MenuButton.prototype.handleUnHighlightItem=function(e){if(!this.menu_.getHighlighted()){var t=this.getElement();goog.asserts.assert(t,"The menu button DOM element cannot be null."),goog.a11y.aria.setState(t,goog.a11y.aria.State.ACTIVEDESCENDANT,""),goog.a11y.aria.setState(t,goog.a11y.aria.State.OWNS,"")}},goog.ui.MenuButton.prototype.handleCloseItem=function(e){if(this.isOpen()&&e.target instanceof goog.ui.MenuItem){var t=e.target,o=t.getElement();t.isVisible()&&t.isHighlighted()&&null!=o&&this.setAriaActiveDescendant_(o)}},goog.ui.MenuButton.prototype.setAriaActiveDescendant_=function(e){var t=this.getElement();goog.asserts.assert(t,"The menu button DOM element cannot be null.");var o=goog.a11y.aria.getActiveDescendant(e)||e;if(!o.id){var n=goog.ui.IdGenerator.getInstance();o.id=n.getNextUniqueId()}goog.a11y.aria.setActiveDescendant(t,o),goog.a11y.aria.setState(t,goog.a11y.aria.State.OWNS,o.id)},goog.ui.MenuButton.prototype.attachPopupListeners_=function(e){var t=this.getHandler(),o=e?t.listen:t.unlisten;o.call(t,this.getDomHelper().getDocument(),goog.events.EventType.MOUSEDOWN,this.handleDocumentMouseDown,!0),this.isFocusablePopupMenu()&&o.call(t,this.menu_,goog.ui.Component.EventType.BLUR,this.handleMenuBlur),o.call(t,this.timer_,goog.Timer.TICK,this.onTick_),e?this.timer_.start():this.timer_.stop()},goog.ui.registry.setDecoratorByClassName(goog.ui.MenuButtonRenderer.CSS_CLASS,function(){return new goog.ui.MenuButton(null)});