goog.provide("goog.labs.net.webChannel.WebChannelBase"),goog.require("goog.Uri"),goog.require("goog.array"),goog.require("goog.asserts"),goog.require("goog.async.run"),goog.require("goog.json"),goog.require("goog.labs.net.webChannel.BaseTestChannel"),goog.require("goog.labs.net.webChannel.Channel"),goog.require("goog.labs.net.webChannel.ChannelRequest"),goog.require("goog.labs.net.webChannel.ConnectionState"),goog.require("goog.labs.net.webChannel.ForwardChannelRequestPool"),goog.require("goog.labs.net.webChannel.WebChannelDebug"),goog.require("goog.labs.net.webChannel.Wire"),goog.require("goog.labs.net.webChannel.WireV8"),goog.require("goog.labs.net.webChannel.netUtils"),goog.require("goog.labs.net.webChannel.requestStats"),goog.require("goog.net.WebChannel"),goog.require("goog.net.XhrIo"),goog.require("goog.net.XmlHttpFactory"),goog.require("goog.net.rpc.HttpCors"),goog.require("goog.object"),goog.require("goog.string"),goog.require("goog.structs"),goog.scope(function(){var e=goog.net.WebChannel,t=goog.labs.net.webChannel.BaseTestChannel,n=goog.labs.net.webChannel.ChannelRequest,a=goog.labs.net.webChannel.ConnectionState,r=goog.labs.net.webChannel.ForwardChannelRequestPool,s=goog.labs.net.webChannel.WebChannelDebug,o=goog.labs.net.webChannel.Wire,i=goog.labs.net.webChannel.WireV8,h=goog.labs.net.webChannel.netUtils,l=goog.labs.net.webChannel.requestStats,u=goog.module.get("goog.net.rpc.HttpCors");goog.labs.net.webChannel.WebChannelBase=function(e,t,n){this.clientVersion_=t||0,this.serverVersion_=0,this.outgoingMaps_=[],this.channelDebug_=new s,this.connState_=n||new a,this.extraHeaders_=null,this.initHeaders_=null,this.httpHeadersOverwriteParam_=null,this.extraParams_=null,this.httpSessionIdParam_=null,this.httpSessionId_=null,this.backChannelRequest_=null,this.path_=null,this.forwardChannelUri_=null,this.backChannelUri_=null,this.hostPrefix_=null,this.allowHostPrefix_=!0,this.nextRid_=0,this.nextMapId_=0,this.failFast_=!!goog.getObjectByName("internalChannelParams.failFast",e),this.handler_=null,this.forwardChannelTimerId_=null,this.backChannelTimerId_=null,this.deadBackChannelTimerId_=null,this.connectionTest_=null,this.useChunked_=null,this.allowChunkedMode_=!0,this.lastArrayId_=-1,this.lastPostResponseArrayId_=-1,this.lastStatusCode_=-1,this.forwardChannelRetryCount_=0,this.backChannelRetryCount_=0,this.backChannelAttemptId_=0,this.baseRetryDelayMs_=goog.getObjectByName("internalChannelParams.baseRetryDelayMs",e)||5e3,this.retryDelaySeedMs_=goog.getObjectByName("internalChannelParams.retryDelaySeedMs",e)||1e4,this.forwardChannelMaxRetries_=goog.getObjectByName("internalChannelParams.forwardChannelMaxRetries",e)||2,this.forwardChannelRequestTimeoutMs_=goog.getObjectByName("internalChannelParams.forwardChannelRequestTimeoutMs",e)||2e4,this.xmlHttpFactory_=e&&e.xmlHttpFactory||void 0,this.backChannelRequestTimeoutMs_=void 0,this.readyStateChangeThrottleMs_=0,this.supportsCrossDomainXhrs_=e&&e.supportsCrossDomainXhr||!1,this.sid_="",this.forwardChannelRequestPool_=new r(e&&e.concurrentRequestLimit),this.wireCodec_=new i,this.backgroundChannelTest_=!e||void 0===e.backgroundChannelTest||e.backgroundChannelTest,this.fastHandshake_=e&&e.fastHandshake||!1,this.fastHandshake_&&!this.backgroundChannelTest_&&(this.channelDebug_.warning("Force backgroundChannelTest when fastHandshake is enabled."),this.backgroundChannelTest_=!0),e&&e.disableRedact&&this.channelDebug_.disableRedact(),e&&e.forceLongPolling&&(this.allowChunkedMode_=!1),this.forwardChannelFlushedCallback_=void 0};var _=goog.labs.net.webChannel.WebChannelBase;_.prototype.channelVersion_=o.LATEST_CHANNEL_VERSION,_.State={CLOSED:0,INIT:1,OPENING:2,OPENED:3},_.prototype.state_=_.State.INIT,_.FORWARD_CHANNEL_RETRY_TIMEOUT=2e4,_.BACK_CHANNEL_MAX_RETRIES=3,_.RTT_ESTIMATE=3e3,_.INACTIVE_CHANNEL_RETRY_FACTOR=2,_.Error={OK:0,REQUEST_FAILED:2,LOGGED_OUT:4,NO_DATA:5,UNKNOWN_SESSION_ID:6,STOP:7,NETWORK:8,BAD_DATA:10,BAD_RESPONSE:11},_.ChannelType_={FORWARD_CHANNEL:1,BACK_CHANNEL:2},_.MAX_MAPS_PER_REQUEST_=1e3,_.MAX_CHARS_PER_GET_=4096,_.OUTSTANDING_DATA_BACKCHANNEL_RETRY_CUTOFF=37500,_.prototype.getServerVersion=function(){return this.serverVersion_},_.prototype.getForwardChannelRequestPool=function(){return this.forwardChannelRequestPool_},_.prototype.getWireCodec=function(){return this.wireCodec_},_.prototype.getChannelDebug=function(){return this.channelDebug_},_.prototype.setChannelDebug=function(e){this.channelDebug_=e},_.prototype.connect=function(e,t,n,a,r){this.channelDebug_.debug("connect()"),l.notifyStatEvent(l.Stat.CONNECT_ATTEMPT),this.path_=t,this.extraParams_=n||{},a&&void 0!==r&&(this.extraParams_.OSID=a,this.extraParams_.OAID=r),this.backgroundChannelTest_&&(this.channelDebug_.debug("connect() bypassed channel-test."),this.connState_.handshakeResult=[],this.connState_.bufferingProxyResult=!1),this.connectTest_(e)},_.prototype.disconnect=function(){if(this.channelDebug_.debug("disconnect()"),this.cancelRequests_(),this.state_==_.State.OPENED){var e=this.nextRid_++,t=this.forwardChannelUri_.clone();t.setParameterValue("SID",this.sid_),t.setParameterValue("RID",e),t.setParameterValue("TYPE","terminate"),this.addAdditionalParams_(t),n.createChannelRequest(this,this.channelDebug_,this.sid_,e).sendCloseRequest(t)}this.onClose_()},_.prototype.getSessionId=function(){return this.sid_},_.prototype.connectTest_=function(e){if(this.channelDebug_.debug("connectTest_()"),this.okToMakeRequest_()){this.connectionTest_=new t(this,this.channelDebug_),null===this.httpHeadersOverwriteParam_&&this.connectionTest_.setExtraHeaders(this.extraHeaders_);var n=e;this.httpHeadersOverwriteParam_&&this.extraHeaders_&&(n=u.setHttpHeadersWithOverwriteParam(e,this.httpHeadersOverwriteParam_,this.extraHeaders_)),this.connectionTest_.connect(n)}},_.prototype.connectChannel_=function(){this.channelDebug_.debug("connectChannel_()"),this.ensureInState_(_.State.INIT,_.State.CLOSED),this.forwardChannelUri_=this.getForwardChannelUri(this.path_),this.ensureForwardChannel_()},_.prototype.cancelRequests_=function(){this.connectionTest_&&(this.connectionTest_.abort(),this.connectionTest_=null),this.backChannelRequest_&&(this.backChannelRequest_.cancel(),this.backChannelRequest_=null),this.backChannelTimerId_&&(goog.global.clearTimeout(this.backChannelTimerId_),this.backChannelTimerId_=null),this.clearDeadBackchannelTimer_(),this.forwardChannelRequestPool_.cancel(),this.forwardChannelTimerId_&&this.clearForwardChannelTimer_()},_.prototype.clearForwardChannelTimer_=function(){"number"==typeof this.forwardChannelTimerId_&&goog.global.clearTimeout(this.forwardChannelTimerId_),this.forwardChannelTimerId_=null},_.prototype.getExtraHeaders=function(){return this.extraHeaders_},_.prototype.setExtraHeaders=function(e){this.extraHeaders_=e},_.prototype.getInitHeaders=function(){return this.initHeaders_},_.prototype.setInitHeaders=function(e){this.initHeaders_=e},_.prototype.setHttpHeadersOverwriteParam=function(e){this.httpHeadersOverwriteParam_=e},_.prototype.setHttpSessionIdParam=function(e){this.httpSessionIdParam_=e},_.prototype.getHttpSessionIdParam=function(){return this.httpSessionIdParam_},_.prototype.setHttpSessionId=function(e){this.httpSessionId_=e},_.prototype.getHttpSessionId=function(){return this.httpSessionId_},_.prototype.getBackgroundChannelTest=function(){return this.backgroundChannelTest_},_.prototype.setReadyStateChangeThrottle=function(e){this.readyStateChangeThrottleMs_=e},_.prototype.setSupportsCrossDomainXhrs=function(e){this.supportsCrossDomainXhrs_=e},_.prototype.getHandler=function(){return this.handler_},_.prototype.setHandler=function(e){this.handler_=e},_.prototype.getAllowHostPrefix=function(){return this.allowHostPrefix_},_.prototype.setAllowHostPrefix=function(e){this.allowHostPrefix_=e},_.prototype.isBuffered=function(){return!this.useChunked_},_.prototype.getAllowChunkedMode=function(){return this.allowChunkedMode_},_.prototype.setAllowChunkedMode=function(e){this.allowChunkedMode_=e},_.prototype.sendMap=function(e,t){goog.asserts.assert(this.state_!=_.State.CLOSED,"Invalid operation: sending map when state is closed"),this.outgoingMaps_.length==_.MAX_MAPS_PER_REQUEST_&&this.channelDebug_.severe(function(){return"Already have "+_.MAX_MAPS_PER_REQUEST_+" queued maps upon queueing "+goog.json.serialize(e)}),this.outgoingMaps_.push(new o.QueuedMap(this.nextMapId_++,e,t)),this.state_==_.State.OPENED&&this.ensureForwardChannel_()},_.prototype.setFailFast=function(e){if(this.failFast_=e,this.channelDebug_.info("setFailFast: "+e),(this.forwardChannelRequestPool_.hasPendingRequest()||this.forwardChannelTimerId_)&&this.forwardChannelRetryCount_>this.getForwardChannelMaxRetries()){var t=this;this.channelDebug_.info(function(){return"Retry count "+t.forwardChannelRetryCount_+" > new maxRetries "+t.getForwardChannelMaxRetries()+". Fail immediately!"}),this.forwardChannelRequestPool_.forceComplete(goog.bind(this.onRequestComplete,this))||(this.clearForwardChannelTimer_(),this.signalError_(_.Error.REQUEST_FAILED))}},_.prototype.getForwardChannelMaxRetries=function(){return this.failFast_?0:this.forwardChannelMaxRetries_},_.prototype.setForwardChannelMaxRetries=function(e){this.forwardChannelMaxRetries_=e},_.prototype.setForwardChannelRequestTimeout=function(e){this.forwardChannelRequestTimeoutMs_=e},_.prototype.getBackChannelMaxRetries=function(){return _.BACK_CHANNEL_MAX_RETRIES},_.prototype.isClosed=function(){return this.state_==_.State.CLOSED},_.prototype.getState=function(){return this.state_},_.prototype.getLastStatusCode=function(){return this.lastStatusCode_},_.prototype.getLastArrayId=function(){return this.lastArrayId_},_.prototype.hasOutstandingRequests=function(){return 0!=this.getOutstandingRequests_()},_.prototype.getOutstandingRequests_=function(){var e=0;return this.backChannelRequest_&&e++,e+=this.forwardChannelRequestPool_.getRequestCount()},_.prototype.ensureForwardChannel_=function(){this.forwardChannelRequestPool_.isFull()||this.forwardChannelTimerId_||(this.forwardChannelTimerId_=!0,goog.async.run(this.onStartForwardChannelTimer_,this),this.forwardChannelRetryCount_=0)},_.prototype.maybeRetryForwardChannel_=function(e){return this.forwardChannelRequestPool_.getRequestCount()>=this.forwardChannelRequestPool_.getMaxSize()-(this.forwardChannelTimerId_?1:0)?(this.channelDebug_.severe("Unexpected retry request is scheduled."),!1):this.forwardChannelTimerId_?(this.channelDebug_.debug("Use the retry request that is already scheduled."),this.outgoingMaps_=e.getPendingMessages().concat(this.outgoingMaps_),!0):!(this.state_==_.State.INIT||this.state_==_.State.OPENING||this.forwardChannelRetryCount_>=this.getForwardChannelMaxRetries())&&(this.channelDebug_.debug("Going to retry POST"),this.forwardChannelTimerId_=l.setTimeout(goog.bind(this.onStartForwardChannelTimer_,this,e),this.getRetryTime_(this.forwardChannelRetryCount_)),this.forwardChannelRetryCount_++,!0)},_.prototype.onStartForwardChannelTimer_=function(e){this.forwardChannelTimerId_&&(this.forwardChannelTimerId_=null,this.startForwardChannel_(e))},_.prototype.startForwardChannel_=function(e){if(this.channelDebug_.debug("startForwardChannel_"),this.okToMakeRequest_())if(this.state_==_.State.INIT){if(e)return void this.channelDebug_.severe("Not supposed to retry the open");this.open_(),this.state_=_.State.OPENING}else if(this.state_==_.State.OPENED){if(e)return void this.makeForwardChannelRequest_(e);if(0==this.outgoingMaps_.length)return void this.channelDebug_.debug("startForwardChannel_ returned: nothing to send");if(this.forwardChannelRequestPool_.isFull())return void this.channelDebug_.severe("startForwardChannel_ returned: connection already in progress");this.makeForwardChannelRequest_(),this.channelDebug_.debug("startForwardChannel_ finished, sent request")}},_.prototype.open_=function(){this.channelDebug_.debug("open_()"),this.nextRid_=Math.floor(1e5*Math.random());var t=this.nextRid_++,a=n.createChannelRequest(this,this.channelDebug_,"",t),r=this.extraHeaders_;this.initHeaders_&&(r?(r=goog.object.clone(r),goog.object.extend(r,this.initHeaders_)):r=this.initHeaders_),null===this.httpHeadersOverwriteParam_&&a.setExtraHeaders(r);var s=this.dequeueOutgoingMaps_(a,this.fastHandshake_?this.getMaxNumMessagesForFastHandshake_():_.MAX_MAPS_PER_REQUEST_),o=this.forwardChannelUri_.clone();o.setParameterValue("RID",t),this.clientVersion_>0&&o.setParameterValue("CVER",this.clientVersion_),this.getBackgroundChannelTest()&&this.getHttpSessionIdParam()&&o.setParameterValue(e.X_HTTP_SESSION_ID,this.getHttpSessionIdParam()),this.addAdditionalParams_(o),this.httpHeadersOverwriteParam_&&r&&u.setHttpHeadersWithOverwriteParam(o,this.httpHeadersOverwriteParam_,r),this.forwardChannelRequestPool_.addRequest(a),this.fastHandshake_?(o.setParameterValue("$req",s),o.setParameterValue("SID","null"),a.setDecodeInitialResponse(),a.xmlHttpPost(o,null,!0)):a.xmlHttpPost(o,s,!0)},_.prototype.getMaxNumMessagesForFastHandshake_=function(){for(var e=0,t=0;t<this.outgoingMaps_.length;t++){var n=this.outgoingMaps_[t].getRawDataSize();if(void 0===n)break;if((e+=n)>_.MAX_CHARS_PER_GET_)return t;if(e===_.MAX_CHARS_PER_GET_||t===this.outgoingMaps_.length-1)return t+1}return _.MAX_MAPS_PER_REQUEST_},_.prototype.makeForwardChannelRequest_=function(e){var t;t=e?e.getRequestId():this.nextRid_++;var a=this.forwardChannelUri_.clone();a.setParameterValue("SID",this.sid_),a.setParameterValue("RID",t),a.setParameterValue("AID",this.lastArrayId_),this.addAdditionalParams_(a),this.httpHeadersOverwriteParam_&&this.extraHeaders_&&u.setHttpHeadersWithOverwriteParam(a,this.httpHeadersOverwriteParam_,this.extraHeaders_);var r,s=n.createChannelRequest(this,this.channelDebug_,this.sid_,t,this.forwardChannelRetryCount_+1);null===this.httpHeadersOverwriteParam_&&s.setExtraHeaders(this.extraHeaders_),e&&this.requeuePendingMaps_(e),r=this.dequeueOutgoingMaps_(s,_.MAX_MAPS_PER_REQUEST_),s.setTimeout(Math.round(.5*this.forwardChannelRequestTimeoutMs_)+Math.round(.5*this.forwardChannelRequestTimeoutMs_*Math.random())),this.forwardChannelRequestPool_.addRequest(s),s.xmlHttpPost(a,r,!0)},_.prototype.addAdditionalParams_=function(e){if(this.handler_){var t=this.handler_.getAdditionalParams(this);t&&goog.structs.forEach(t,function(t,n,a){e.setParameterValue(n,t)})}},_.prototype.dequeueOutgoingMaps_=function(e,t){var n=Math.min(this.outgoingMaps_.length,t),a=this.handler_?goog.bind(this.handler_.badMapError,this.handler_,this):null,r=this.wireCodec_.encodeMessageQueue(this.outgoingMaps_,n,a);return e.setPendingMessages(this.outgoingMaps_.splice(0,n)),r},_.prototype.requeuePendingMaps_=function(e){this.outgoingMaps_=e.getPendingMessages().concat(this.outgoingMaps_)},_.prototype.ensureBackChannel_=function(){this.backChannelRequest_||this.backChannelTimerId_||(this.backChannelAttemptId_=1,goog.async.run(this.onStartBackChannelTimer_,this),this.backChannelRetryCount_=0)},_.prototype.maybeRetryBackChannel_=function(){return this.backChannelRequest_||this.backChannelTimerId_?(this.channelDebug_.severe("Request already in progress"),!1):!(this.backChannelRetryCount_>=this.getBackChannelMaxRetries())&&(this.channelDebug_.debug("Going to retry GET"),this.backChannelAttemptId_++,this.backChannelTimerId_=l.setTimeout(goog.bind(this.onStartBackChannelTimer_,this),this.getRetryTime_(this.backChannelRetryCount_)),this.backChannelRetryCount_++,!0)},_.prototype.onStartBackChannelTimer_=function(){this.backChannelTimerId_=null,this.startBackChannel_()},_.prototype.startBackChannel_=function(){if(this.okToMakeRequest_()){this.channelDebug_.debug("Creating new HttpRequest"),this.backChannelRequest_=n.createChannelRequest(this,this.channelDebug_,this.sid_,"rpc",this.backChannelAttemptId_),null===this.httpHeadersOverwriteParam_&&this.backChannelRequest_.setExtraHeaders(this.extraHeaders_),this.backChannelRequest_.setReadyStateChangeThrottle(this.readyStateChangeThrottleMs_);var e=this.backChannelUri_.clone();e.setParameterValue("RID","rpc"),e.setParameterValue("SID",this.sid_),e.setParameterValue("CI",this.useChunked_?"0":"1"),e.setParameterValue("AID",this.lastArrayId_),this.addAdditionalParams_(e),e.setParameterValue("TYPE","xmlhttp"),this.httpHeadersOverwriteParam_&&this.extraHeaders_&&u.setHttpHeadersWithOverwriteParam(e,this.httpHeadersOverwriteParam_,this.extraHeaders_),this.backChannelRequestTimeoutMs_&&this.backChannelRequest_.setTimeout(this.backChannelRequestTimeoutMs_),this.backChannelRequest_.xmlHttpGet(e,!0,this.hostPrefix_),this.channelDebug_.debug("New Request created")}},_.prototype.okToMakeRequest_=function(){if(this.handler_){var e=this.handler_.okToMakeRequest(this);if(e!=_.Error.OK)return this.channelDebug_.debug("Handler returned error code from okToMakeRequest"),this.signalError_(e),!1}return!0},_.prototype.testConnectionFinished=function(e,t){this.channelDebug_.debug("Test Connection Finished");var n=e.getClientProtocol();n&&this.forwardChannelRequestPool_.applyClientProtocol(n),this.useChunked_=this.allowChunkedMode_&&t,this.lastStatusCode_=e.getLastStatusCode(),this.connectChannel_()},_.prototype.testConnectionFailure=function(e,t){this.channelDebug_.debug("Test Connection Failed"),this.lastStatusCode_=e.getLastStatusCode(),this.signalError_(_.Error.REQUEST_FAILED)},_.prototype.onRequestData=function(e,t){if(this.state_!=_.State.CLOSED&&(this.backChannelRequest_==e||this.forwardChannelRequestPool_.hasRequest(e)))if(this.lastStatusCode_=e.getLastStatusCode(),!e.isInitialResponseDecoded()&&this.forwardChannelRequestPool_.hasRequest(e)&&this.state_==_.State.OPENED){try{n=this.wireCodec_.decodeMessage(t)}catch(e){n=null}goog.isArray(n)&&3==n.length?(this.handlePostResponse_(n,e),this.onForwardChannelFlushed_()):(this.channelDebug_.debug("Bad POST response data returned"),this.signalError_(_.Error.BAD_RESPONSE))}else if((e.isInitialResponseDecoded()||this.backChannelRequest_==e)&&this.clearDeadBackchannelTimer_(),!goog.string.isEmptyOrWhitespace(t)){var n=this.wireCodec_.decodeMessage(t);this.onInput_(n,e)}},_.prototype.onForwardChannelFlushed_=function(){if(this.forwardChannelRequestPool_.getRequestCount()<=1&&this.forwardChannelFlushedCallback_){try{this.forwardChannelFlushedCallback_()}catch(e){this.channelDebug_.dumpException(e,"Exception from forwardChannelFlushedCallback_ ")}this.forwardChannelFlushedCallback_=void 0}},_.prototype.handlePostResponse_=function(e,t){if(0!=e[0]){this.lastPostResponseArrayId_=e[1];var n=this.lastPostResponseArrayId_-this.lastArrayId_;if(0<n){var a=e[2];if(this.channelDebug_.debug(a+" bytes (in "+n+" arrays) are outstanding on the BackChannel"),!this.shouldRetryBackChannel_(a))return;this.deadBackChannelTimerId_||(this.deadBackChannelTimerId_=l.setTimeout(goog.bind(this.onBackChannelDead_,this),2*_.RTT_ESTIMATE))}}else this.handleBackchannelMissing_(t)},_.prototype.handleBackchannelMissing_=function(e){if(this.channelDebug_.debug("Server claims our backchannel is missing."),this.backChannelTimerId_)this.channelDebug_.debug("But we are currently starting the request.");else{if(this.backChannelRequest_){if(!(this.backChannelRequest_.getRequestStartTime()+_.RTT_ESTIMATE<e.getRequestStartTime()))return;this.clearDeadBackchannelTimer_(),this.backChannelRequest_.cancel(),this.backChannelRequest_=null}else this.channelDebug_.warning("We do not have a BackChannel established");this.maybeRetryBackChannel_(),l.notifyStatEvent(l.Stat.BACKCHANNEL_MISSING)}},_.prototype.shouldRetryBackChannel_=function(e){return e<_.OUTSTANDING_DATA_BACKCHANNEL_RETRY_CUTOFF&&!this.isBuffered()&&0==this.backChannelRetryCount_},_.prototype.correctHostPrefix=function(e){return this.allowHostPrefix_?this.handler_?this.handler_.correctHostPrefix(e):e:null},_.prototype.onBackChannelDead_=function(){null!=this.deadBackChannelTimerId_&&(this.deadBackChannelTimerId_=null,this.backChannelRequest_.cancel(),this.backChannelRequest_=null,this.maybeRetryBackChannel_(),l.notifyStatEvent(l.Stat.BACKCHANNEL_DEAD))},_.prototype.clearDeadBackchannelTimer_=function(){null!=this.deadBackChannelTimerId_&&(goog.global.clearTimeout(this.deadBackChannelTimerId_),this.deadBackChannelTimerId_=null)},_.isFatalError_=function(e,t){return e==n.Error.UNKNOWN_SESSION_ID||e==n.Error.STATUS&&t>0},_.prototype.onRequestComplete=function(e){var t;this.channelDebug_.debug("Request complete");var a=null;if(this.backChannelRequest_==e)this.clearDeadBackchannelTimer_(),this.backChannelRequest_=null,t=_.ChannelType_.BACK_CHANNEL;else{if(!this.forwardChannelRequestPool_.hasRequest(e))return;a=e.getPendingMessages(),this.forwardChannelRequestPool_.removeRequest(e),t=_.ChannelType_.FORWARD_CHANNEL}if(this.lastStatusCode_=e.getLastStatusCode(),this.state_!=_.State.CLOSED)if(e.getSuccess())if(t==_.ChannelType_.FORWARD_CHANNEL){var r=e.getPostData()?e.getPostData().length:0;l.notifyTimingEvent(r,goog.now()-e.getRequestStartTime(),this.forwardChannelRetryCount_),this.ensureForwardChannel_(),this.onSuccess_(e)}else this.ensureBackChannel_();else{var s=e.getLastError();if(_.isFatalError_(s,this.lastStatusCode_))this.channelDebug_.debug("Not retrying due to error type");else{var o=this;if(this.channelDebug_.debug(function(){return"Maybe retrying, last error: "+n.errorStringFromCode(s,o.lastStatusCode_)}),t==_.ChannelType_.FORWARD_CHANNEL&&this.maybeRetryForwardChannel_(e))return;if(t==_.ChannelType_.BACK_CHANNEL&&this.maybeRetryBackChannel_())return;this.channelDebug_.debug("Exceeded max number of retries")}switch(a&&a.length>0&&this.forwardChannelRequestPool_.addPendingMessages(a),this.channelDebug_.debug("Error: HTTP request failed"),s){case n.Error.NO_DATA:this.signalError_(_.Error.NO_DATA);break;case n.Error.BAD_DATA:this.signalError_(_.Error.BAD_DATA);break;case n.Error.UNKNOWN_SESSION_ID:this.signalError_(_.Error.UNKNOWN_SESSION_ID);break;default:this.signalError_(_.Error.REQUEST_FAILED)}}},_.prototype.getRetryTime_=function(e){var t=this.baseRetryDelayMs_+Math.floor(Math.random()*this.retryDelaySeedMs_);return this.isActive()||(this.channelDebug_.debug("Inactive channel"),t*=_.INACTIVE_CHANNEL_RETRY_FACTOR),t*=e},_.prototype.setRetryDelay=function(e,t){this.baseRetryDelayMs_=e,this.retryDelaySeedMs_=t},_.prototype.applyControlHeaders_=function(t){if(this.backgroundChannelTest_){var n=t.getXhr();if(n){var a=n.getStreamingResponseHeader(e.X_CLIENT_WIRE_PROTOCOL);if(a&&this.forwardChannelRequestPool_.applyClientProtocol(a),this.getHttpSessionIdParam()){var r=n.getStreamingResponseHeader(e.X_HTTP_SESSION_ID);if(r){this.setHttpSessionId(r);var s=this.getHttpSessionIdParam();this.forwardChannelUri_.setParameterValue(s,r)}else this.channelDebug_.warning("Missing X_HTTP_SESSION_ID in the handshake response")}}}},_.prototype.onInput_=function(e,t){for(var n=this.handler_&&this.handler_.channelHandleMultipleArrays?[]:null,a=0;a<e.length;a++){var r=e[a];if(this.lastArrayId_=r[0],r=r[1],this.state_==_.State.OPENING)if("c"==r[0]){this.sid_=r[1],this.hostPrefix_=this.correctHostPrefix(r[2]);var s=r[3];null!=s&&(this.channelVersion_=s,this.channelDebug_.info("VER="+this.channelVersion_));var o=r[4];null!=o&&(this.serverVersion_=o,this.channelDebug_.info("SVER="+this.serverVersion_));var i=r[5];if(null!=i&&"number"==typeof i&&i>0){var h=1.5*i;this.backChannelRequestTimeoutMs_=h,this.channelDebug_.info("backChannelRequestTimeoutMs_="+h)}this.applyControlHeaders_(t),this.state_=_.State.OPENED,this.handler_&&this.handler_.channelOpened(this),this.startBackchannelAfterHandshake_(t),this.outgoingMaps_.length>0&&this.ensureForwardChannel_()}else"stop"!=r[0]&&"close"!=r[0]||this.signalError_(_.Error.STOP);else this.state_==_.State.OPENED&&("stop"==r[0]||"close"==r[0]?(n&&!goog.array.isEmpty(n)&&(this.handler_.channelHandleMultipleArrays(this,n),n.length=0),"stop"==r[0]?this.signalError_(_.Error.STOP):this.disconnect()):"noop"==r[0]||(n?n.push(r):this.handler_&&this.handler_.channelHandleArray(this,r)),this.backChannelRetryCount_=0)}n&&!goog.array.isEmpty(n)&&this.handler_.channelHandleMultipleArrays(this,n)},_.prototype.startBackchannelAfterHandshake_=function(e){this.backChannelUri_=this.getBackChannelUri(this.hostPrefix_,this.path_),e.isInitialResponseDecoded()?(this.channelDebug_.debug("Upgrade the handshake request to a backchannel."),this.forwardChannelRequestPool_.removeRequest(e),e.resetTimeout(this.backChannelRequestTimeoutMs_),this.backChannelRequest_=e):this.ensureBackChannel_()},_.prototype.ensureInState_=function(e){goog.asserts.assert(goog.array.contains(arguments,this.state_),"Unexpected channel state: %s",this.state_)},_.prototype.signalError_=function(e){if(this.channelDebug_.info("Error code "+e),e==_.Error.REQUEST_FAILED){var t=null;this.handler_&&(t=this.handler_.getNetworkTestImageUri(this)),h.testNetwork(goog.bind(this.testNetworkCallback_,this),t)}else l.notifyStatEvent(l.Stat.ERROR_OTHER);this.onError_(e)},_.prototype.testNetworkCallback_=function(e){e?(this.channelDebug_.info("Successfully pinged google.com"),l.notifyStatEvent(l.Stat.ERROR_OTHER)):(this.channelDebug_.info("Failed to ping google.com"),l.notifyStatEvent(l.Stat.ERROR_NETWORK))},_.prototype.onSuccess_=function(e){this.handler_&&this.handler_.channelSuccess(this,e)},_.prototype.onError_=function(e){this.channelDebug_.debug("HttpChannel: error - "+e),this.state_=_.State.CLOSED,this.handler_&&this.handler_.channelError(this,e),this.onClose_(),this.cancelRequests_()},_.prototype.onClose_=function(){if(this.state_=_.State.CLOSED,this.lastStatusCode_=-1,this.handler_){var e=this.forwardChannelRequestPool_.getPendingMessages();if(0==e.length&&0==this.outgoingMaps_.length)this.handler_.channelClosed(this);else{var t=this;this.channelDebug_.debug(function(){return"Number of undelivered maps, pending: "+e.length+", outgoing: "+t.outgoingMaps_.length}),this.forwardChannelRequestPool_.clearPendingMessages();var n=goog.array.clone(this.outgoingMaps_);this.outgoingMaps_.length=0,this.handler_.channelClosed(this,e,n)}}},_.prototype.getForwardChannelUri=function(e){var t=this.createDataUri(null,e);return this.channelDebug_.debug("GetForwardChannelUri: "+t),t},_.prototype.getConnectionState=function(){return this.connState_},_.prototype.getBackChannelUri=function(e,t){var n=this.createDataUri(this.shouldUseSecondaryDomains()?e:null,t);return this.channelDebug_.debug("GetBackChannelUri: "+n),n},_.prototype.createDataUri=function(e,t,n){var a=goog.Uri.parse(t);if(""!=a.getDomain())e&&a.setDomain(e+"."+a.getDomain()),a.setPort(n||a.getPort());else{var r,s=goog.global.location;r=e?e+"."+s.hostname:s.hostname;var o=n||+s.port;a=goog.Uri.create(s.protocol,null,r,o,t)}this.extraParams_&&goog.object.forEach(this.extraParams_,function(e,t){a.setParameterValue(t,e)});var i=this.getHttpSessionIdParam(),h=this.getHttpSessionId();return i&&h&&a.setParameterValue(i,h),a.setParameterValue("VER",this.channelVersion_),this.addAdditionalParams_(a),a},_.prototype.createXhrIo=function(e){if(e&&!this.supportsCrossDomainXhrs_)throw new Error("Can't create secondary domain capable XhrIo object.");var t=new goog.net.XhrIo(this.xmlHttpFactory_);return t.setWithCredentials(this.supportsCrossDomainXhrs_),t},_.prototype.isActive=function(){return!!this.handler_&&this.handler_.isActive(this)},_.prototype.shouldUseSecondaryDomains=function(){return this.supportsCrossDomainXhrs_},_.prototype.setForwardChannelFlushCallback=function(e){this.forwardChannelFlushedCallback_=e},_.Handler=function(){},_.Handler.prototype.channelHandleMultipleArrays=null,_.Handler.prototype.okToMakeRequest=function(e){return _.Error.OK},_.Handler.prototype.channelOpened=function(e){},_.Handler.prototype.channelHandleArray=function(e,t){},_.Handler.prototype.channelSuccess=function(e,t){},_.Handler.prototype.channelError=function(e,t){},_.Handler.prototype.channelClosed=function(e,t,n){},_.Handler.prototype.getAdditionalParams=function(e){return{}},_.Handler.prototype.getNetworkTestImageUri=function(e){return null},_.Handler.prototype.isActive=function(e){return!0},_.Handler.prototype.badMapError=function(e,t){},_.Handler.prototype.correctHostPrefix=function(e){return e}});