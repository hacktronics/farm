goog.provide("goog.labs.net.webChannel.ChannelRequest"),goog.forwardDeclare("goog.Uri"),goog.forwardDeclare("goog.net.XhrIo"),goog.require("goog.Timer"),goog.require("goog.async.Throttle"),goog.require("goog.events.EventHandler"),goog.require("goog.labs.net.webChannel.Channel"),goog.require("goog.labs.net.webChannel.WebChannelDebug"),goog.require("goog.labs.net.webChannel.environment"),goog.require("goog.labs.net.webChannel.requestStats"),goog.require("goog.net.ErrorCode"),goog.require("goog.net.EventType"),goog.require("goog.net.WebChannel"),goog.require("goog.net.XmlHttp"),goog.require("goog.object"),goog.require("goog.string"),goog.require("goog.userAgent"),goog.labs.net.webChannel.ChannelRequest=function(t,e,n,s,i){this.channel_=t,this.channelDebug_=e,this.sid_=n,this.rid_=s,this.retryId_=i||1,this.eventHandler_=new goog.events.EventHandler(this),this.timeout_=goog.labs.net.webChannel.ChannelRequest.TIMEOUT_MS_,this.pollingTimer_=new goog.Timer(goog.labs.net.webChannel.environment.getPollingInterval()),this.extraHeaders_=null,this.successful_=!1,this.watchDogTimerId_=null,this.watchDogTimeoutTime_=null,this.requestStartTime_=null,this.type_=null,this.baseUri_=null,this.requestUri_=null,this.postData_=null,this.pendingMessages_=[],this.xmlHttp_=null,this.xmlHttpChunkStart_=0,this.verb_=null,this.lastError_=null,this.lastStatusCode_=-1,this.cancelled_=!1,this.readyStateChangeThrottleMs_=0,this.readyStateChangeThrottle_=null,this.decodeChunks_=!1,this.decodeInitialResponse_=!1,this.initialResponseDecoded_=!1},goog.scope(function(){var t=goog.net.WebChannel,e=(goog.labs.net.webChannel.Channel,goog.labs.net.webChannel.ChannelRequest),n=goog.labs.net.webChannel.requestStats,s=(goog.labs.net.webChannel.WebChannelDebug,goog.labs.net.webChannel.environment);e.TIMEOUT_MS_=45e3,e.Type_={XML_HTTP:1,CLOSE_REQUEST:2},e.Error={STATUS:0,NO_DATA:1,TIMEOUT:2,UNKNOWN_SESSION_ID:3,BAD_DATA:4,HANDLER_EXCEPTION:5,BROWSER_OFFLINE:6},e.errorStringFromCode=function(t,n){switch(t){case e.Error.STATUS:return"Non-200 return code ("+n+")";case e.Error.NO_DATA:return"XMLHTTP failure (no data)";case e.Error.TIMEOUT:return"HttpConnection timeout";default:return"Unknown error"}},e.INVALID_CHUNK_={},e.INCOMPLETE_CHUNK_={},e.supportsXhrStreaming=function(){return!goog.userAgent.IE||goog.userAgent.isDocumentModeOrHigher(10)},e.prototype.setExtraHeaders=function(t){this.extraHeaders_=t},e.prototype.setVerb=function(t){this.verb_=t},e.prototype.setTimeout=function(t){this.timeout_=t},e.prototype.setReadyStateChangeThrottle=function(t){this.readyStateChangeThrottleMs_=t},e.prototype.setPendingMessages=function(t){this.pendingMessages_=t},e.prototype.getPendingMessages=function(){return this.pendingMessages_},e.prototype.xmlHttpPost=function(t,n,s){this.type_=e.Type_.XML_HTTP,this.baseUri_=t.clone().makeUnique(),this.postData_=n,this.decodeChunks_=s,this.sendXmlHttp_(null)},e.prototype.xmlHttpGet=function(t,n,s){this.type_=e.Type_.XML_HTTP,this.baseUri_=t.clone().makeUnique(),this.postData_=null,this.decodeChunks_=n,this.sendXmlHttp_(s)},e.prototype.sendXmlHttp_=function(t){this.requestStartTime_=goog.now(),this.ensureWatchDogTimer_(),this.requestUri_=this.baseUri_.clone(),this.requestUri_.setParameterValues("t",this.retryId_),this.xmlHttpChunkStart_=0;var e=this.channel_.shouldUseSecondaryDomains();this.xmlHttp_=this.channel_.createXhrIo(e?t:null),this.readyStateChangeThrottleMs_>0&&(this.readyStateChangeThrottle_=new goog.async.Throttle(goog.bind(this.xmlHttpHandler_,this,this.xmlHttp_),this.readyStateChangeThrottleMs_)),this.eventHandler_.listen(this.xmlHttp_,goog.net.EventType.READY_STATE_CHANGE,this.readyStateChangeHandler_);var s=this.extraHeaders_?goog.object.clone(this.extraHeaders_):{};this.postData_?(this.verb_||(this.verb_="POST"),s["Content-Type"]="application/x-www-form-urlencoded",this.xmlHttp_.send(this.requestUri_,this.verb_,this.postData_,s)):(this.verb_="GET",this.xmlHttp_.send(this.requestUri_,this.verb_,null,s)),n.notifyServerReachabilityEvent(n.ServerReachability.REQUEST_MADE),this.channelDebug_.xmlHttpChannelRequest(this.verb_,this.requestUri_,this.rid_,this.retryId_,this.postData_)},e.prototype.readyStateChangeHandler_=function(t){var e=t.target,n=this.readyStateChangeThrottle_;n&&e.getReadyState()==goog.net.XmlHttp.ReadyState.INTERACTIVE?(this.channelDebug_.debug("Throttling readystatechange."),n.fire()):this.xmlHttpHandler_(e)},e.prototype.xmlHttpHandler_=function(t){n.onStartExecution();try{t==this.xmlHttp_?this.onXmlHttpReadyStateChanged_():this.channelDebug_.warning("Called back with an unexpected xmlhttp")}catch(t){if(this.channelDebug_.debug("Failed call to OnXmlHttpReadyStateChanged_"),this.xmlHttp_&&this.xmlHttp_.getResponseText()){var e=this;this.channelDebug_.dumpException(t,function(){return"ResponseText: "+e.xmlHttp_.getResponseText()})}else this.channelDebug_.dumpException(t,"No response text")}finally{n.onEndExecution()}},e.prototype.onXmlHttpReadyStateChanged_=function(){var i=this.xmlHttp_.getReadyState(),o=this.xmlHttp_.getLastErrorCode(),r=this.xmlHttp_.getStatus();if(!(i<goog.net.XmlHttp.ReadyState.INTERACTIVE||i==goog.net.XmlHttp.ReadyState.INTERACTIVE&&!s.isPollingRequired()&&!this.xmlHttp_.getResponseText())){this.cancelled_||i!=goog.net.XmlHttp.ReadyState.COMPLETE||o==goog.net.ErrorCode.ABORT||(o==goog.net.ErrorCode.TIMEOUT||r<=0?n.notifyServerReachabilityEvent(n.ServerReachability.REQUEST_FAILED):n.notifyServerReachabilityEvent(n.ServerReachability.REQUEST_SUCCEEDED)),this.cancelWatchDogTimer_();var a=this.xmlHttp_.getStatus();this.lastStatusCode_=a;var h=this.xmlHttp_.getResponseText();if(!h){var l=this;this.channelDebug_.debug(function(){return"No response text for uri "+l.requestUri_+" status "+a})}if(this.successful_=200==a,this.channelDebug_.xmlHttpChannelResponseMetaData(this.verb_,this.requestUri_,this.rid_,this.retryId_,i,a),!this.successful_)return 400==a&&h.indexOf("Unknown SID")>0?(this.lastError_=e.Error.UNKNOWN_SESSION_ID,n.notifyStatEvent(n.Stat.REQUEST_UNKNOWN_SESSION_ID),this.channelDebug_.warning("XMLHTTP Unknown SID ("+this.rid_+")")):(this.lastError_=e.Error.STATUS,n.notifyStatEvent(n.Stat.REQUEST_BAD_STATUS),this.channelDebug_.warning("XMLHTTP Bad status "+a+" ("+this.rid_+")")),this.cleanup_(),void this.dispatchFailure_();if(this.shouldCheckInitialResponse_()){var _=this.getInitialResponse_();if(!_)return this.successful_=!1,this.lastError_=e.Error.UNKNOWN_SESSION_ID,n.notifyStatEvent(n.Stat.REQUEST_UNKNOWN_SESSION_ID),this.channelDebug_.warning("XMLHTTP Missing X_HTTP_INITIAL_RESPONSE ("+this.rid_+")"),this.cleanup_(),void this.dispatchFailure_();this.channelDebug_.xmlHttpChannelResponseText(this.rid_,_,"Initial handshake response via "+t.X_HTTP_INITIAL_RESPONSE),this.initialResponseDecoded_=!0,this.safeOnRequestData_(_)}this.decodeChunks_?(this.decodeNextChunks_(i,h),s.isPollingRequired()&&this.successful_&&i==goog.net.XmlHttp.ReadyState.INTERACTIVE&&this.startPolling_()):(this.channelDebug_.xmlHttpChannelResponseText(this.rid_,h,null),this.safeOnRequestData_(h)),i==goog.net.XmlHttp.ReadyState.COMPLETE&&this.cleanup_(),this.successful_&&(this.cancelled_||(i==goog.net.XmlHttp.ReadyState.COMPLETE?this.channel_.onRequestComplete(this):(this.successful_=!1,this.ensureWatchDogTimer_())))}},e.prototype.shouldCheckInitialResponse_=function(){return this.decodeInitialResponse_&&!this.initialResponseDecoded_},e.prototype.getInitialResponse_=function(){if(this.xmlHttp_){var e=this.xmlHttp_.getStreamingResponseHeader(t.X_HTTP_INITIAL_RESPONSE);if(e&&!goog.string.isEmptyOrWhitespace(e))return e}return null},e.prototype.isInitialResponseDecoded=function(){return this.initialResponseDecoded_},e.prototype.setDecodeInitialResponse=function(){this.decodeInitialResponse_=!0},e.prototype.decodeNextChunks_=function(t,s){for(var i=!0;!this.cancelled_&&this.xmlHttpChunkStart_<s.length;){var o=this.getNextChunk_(s);if(o==e.INCOMPLETE_CHUNK_){t==goog.net.XmlHttp.ReadyState.COMPLETE&&(this.lastError_=e.Error.BAD_DATA,n.notifyStatEvent(n.Stat.REQUEST_INCOMPLETE_DATA),i=!1),this.channelDebug_.xmlHttpChannelResponseText(this.rid_,null,"[Incomplete Response]");break}if(o==e.INVALID_CHUNK_){this.lastError_=e.Error.BAD_DATA,n.notifyStatEvent(n.Stat.REQUEST_BAD_DATA),this.channelDebug_.xmlHttpChannelResponseText(this.rid_,s,"[Invalid Chunk]"),i=!1;break}this.channelDebug_.xmlHttpChannelResponseText(this.rid_,o,null),this.safeOnRequestData_(o)}t==goog.net.XmlHttp.ReadyState.COMPLETE&&0==s.length&&(this.lastError_=e.Error.NO_DATA,n.notifyStatEvent(n.Stat.REQUEST_NO_DATA),i=!1),this.successful_=this.successful_&&i,i||(this.channelDebug_.xmlHttpChannelResponseText(this.rid_,s,"[Invalid Chunked Response]"),this.cleanup_(),this.dispatchFailure_())},e.prototype.pollResponse_=function(){if(this.xmlHttp_){var t=this.xmlHttp_.getReadyState(),e=this.xmlHttp_.getResponseText();this.xmlHttpChunkStart_<e.length&&(this.cancelWatchDogTimer_(),this.decodeNextChunks_(t,e),this.successful_&&t!=goog.net.XmlHttp.ReadyState.COMPLETE&&this.ensureWatchDogTimer_())}},e.prototype.startPolling_=function(){this.eventHandler_.listen(this.pollingTimer_,goog.Timer.TICK,this.pollResponse_),this.pollingTimer_.start()},e.prototype.getNextChunk_=function(t){var n=this.xmlHttpChunkStart_,s=t.indexOf("\n",n);if(-1==s)return e.INCOMPLETE_CHUNK_;var i=t.substring(n,s),o=Number(i);if(isNaN(o))return e.INVALID_CHUNK_;var r=s+1;if(r+o>t.length)return e.INCOMPLETE_CHUNK_;var a=t.substr(r,o);return this.xmlHttpChunkStart_=r+o,a},e.prototype.sendCloseRequest=function(t){this.type_=e.Type_.CLOSE_REQUEST,this.baseUri_=t.clone().makeUnique();var n=!1;(goog.global.navigator&&goog.global.navigator.sendBeacon&&(n=goog.global.navigator.sendBeacon(this.baseUri_.toString(),"")),!n&&goog.global.Image)&&((new Image).src=this.baseUri_,n=!0);n||(this.xmlHttp_=this.channel_.createXhrIo(null),this.xmlHttp_.send(this.baseUri_)),this.requestStartTime_=goog.now(),this.ensureWatchDogTimer_()},e.prototype.cancel=function(){this.cancelled_=!0,this.cleanup_()},e.prototype.resetTimeout=function(t){t&&this.setTimeout(t),this.watchDogTimerId_&&(this.cancelWatchDogTimer_(),this.ensureWatchDogTimer_())},e.prototype.ensureWatchDogTimer_=function(){this.watchDogTimeoutTime_=goog.now()+this.timeout_,this.startWatchDogTimer_(this.timeout_)},e.prototype.startWatchDogTimer_=function(t){if(null!=this.watchDogTimerId_)throw new Error("WatchDog timer not null");this.watchDogTimerId_=n.setTimeout(goog.bind(this.onWatchDogTimeout_,this),t)},e.prototype.cancelWatchDogTimer_=function(){this.watchDogTimerId_&&(goog.global.clearTimeout(this.watchDogTimerId_),this.watchDogTimerId_=null)},e.prototype.onWatchDogTimeout_=function(){this.watchDogTimerId_=null;var t=goog.now();t-this.watchDogTimeoutTime_>=0?this.handleTimeout_():(this.channelDebug_.warning("WatchDog timer called too early"),this.startWatchDogTimer_(this.watchDogTimeoutTime_-t))},e.prototype.handleTimeout_=function(){this.successful_&&this.channelDebug_.severe("Received watchdog timeout even though request loaded successfully"),this.channelDebug_.timeoutResponse(this.requestUri_),this.type_!=e.Type_.CLOSE_REQUEST&&(n.notifyServerReachabilityEvent(n.ServerReachability.REQUEST_FAILED),n.notifyStatEvent(n.Stat.REQUEST_TIMEOUT)),this.cleanup_(),this.lastError_=e.Error.TIMEOUT,this.dispatchFailure_()},e.prototype.dispatchFailure_=function(){this.channel_.isClosed()||this.cancelled_||this.channel_.onRequestComplete(this)},e.prototype.cleanup_=function(){if(this.cancelWatchDogTimer_(),goog.dispose(this.readyStateChangeThrottle_),this.readyStateChangeThrottle_=null,this.pollingTimer_.stop(),this.eventHandler_.removeAll(),this.xmlHttp_){var t=this.xmlHttp_;this.xmlHttp_=null,t.abort(),t.dispose()}},e.prototype.getSuccess=function(){return this.successful_},e.prototype.getLastError=function(){return this.lastError_},e.prototype.getLastStatusCode=function(){return this.lastStatusCode_},e.prototype.getSessionId=function(){return this.sid_},e.prototype.getRequestId=function(){return this.rid_},e.prototype.getPostData=function(){return this.postData_},e.prototype.getXhr=function(){return this.xmlHttp_},e.prototype.getRequestStartTime=function(){return this.requestStartTime_},e.prototype.safeOnRequestData_=function(t){try{this.channel_.onRequestData(this,t);var e=n.ServerReachability;n.notifyServerReachabilityEvent(e.BACK_CHANNEL_ACTIVITY)}catch(t){this.channelDebug_.dumpException(t,"Error in httprequest callback")}},e.createChannelRequest=function(t,n,s,i,o){return new e(t,n,s,i,o)}});