goog.provide("goog.labs.net.webChannel.WebChannelBaseTransport"),goog.require("goog.asserts"),goog.require("goog.events.EventTarget"),goog.require("goog.json"),goog.require("goog.labs.net.webChannel.ChannelRequest"),goog.require("goog.labs.net.webChannel.WebChannelBase"),goog.require("goog.labs.net.webChannel.Wire"),goog.require("goog.log"),goog.require("goog.net.WebChannel"),goog.require("goog.net.WebChannelTransport"),goog.require("goog.object"),goog.require("goog.string"),goog.require("goog.string.path"),goog.labs.net.webChannel.WebChannelBaseTransport=function(){if(!goog.labs.net.webChannel.ChannelRequest.supportsXhrStreaming())throw new Error("Environmental error: no available transport.")},goog.scope(function(){var e=goog.labs.net.webChannel.WebChannelBaseTransport,n=goog.labs.net.webChannel.WebChannelBase,t=goog.labs.net.webChannel.Wire;e.prototype.createWebChannel=function(n,t){return new e.Channel(n,t)},e.Channel=function(t,o){e.Channel.base(this,"constructor"),this.channel_=new n(o,goog.net.WebChannelTransport.CLIENT_VERSION),this.url_=t,this.testUrl_=o&&o.testUrl?o.testUrl:goog.string.path.join(this.url_,"test"),this.logger_=goog.log.getLogger("goog.labs.net.webChannel.WebChannelBaseTransport"),this.messageUrlParams_=o&&o.messageUrlParams||null;var a=o&&o.messageHeaders||null;o&&o.clientProtocolHeaderRequired&&(a?goog.object.set(a,goog.net.WebChannel.X_CLIENT_PROTOCOL,goog.net.WebChannel.X_CLIENT_PROTOCOL_WEB_CHANNEL):a=goog.object.create(goog.net.WebChannel.X_CLIENT_PROTOCOL,goog.net.WebChannel.X_CLIENT_PROTOCOL_WEB_CHANNEL)),this.channel_.setExtraHeaders(a);var s=o&&o.initMessageHeaders||null;o&&o.messageContentType&&(s?goog.object.set(s,goog.net.WebChannel.X_WEBCHANNEL_CONTENT_TYPE,o.messageContentType):s=goog.object.create(goog.net.WebChannel.X_WEBCHANNEL_CONTENT_TYPE,o.messageContentType)),o&&o.clientProfile&&(s?goog.object.set(s,goog.net.WebChannel.X_WEBCHANNEL_CLIENT_PROFILE,o.clientProfile):s=goog.object.create(goog.net.WebChannel.X_WEBCHANNEL_CLIENT_PROFILE,o.clientProfile)),this.channel_.setInitHeaders(s);var r=o&&o.httpHeadersOverwriteParam;r&&!goog.string.isEmptyOrWhitespace(r)&&this.channel_.setHttpHeadersOverwriteParam(r),this.supportsCrossDomainXhr_=o&&o.supportsCrossDomainXhr||!1,this.sendRawJson_=o&&o.sendRawJson||!1;var g=o&&o.httpSessionIdParam;g&&!goog.string.isEmptyOrWhitespace(g)&&(this.channel_.setHttpSessionIdParam(g),goog.object.containsKey(this.messageUrlParams_,g)&&(goog.object.remove(this.messageUrlParams_,g),goog.log.warning(this.logger_,"Ignore httpSessionIdParam also specified with messageUrlParams: "+g))),this.channelHandler_=new e.Channel.Handler_(this)},goog.inherits(e.Channel,goog.events.EventTarget),e.Channel.prototype.addEventListener=function(n,t,o,a){e.Channel.base(this,"addEventListener",n,t,o,a)},e.Channel.prototype.removeEventListener=function(n,t,o,a){e.Channel.base(this,"removeEventListener",n,t,o,a)},e.Channel.prototype.open=function(){this.channel_.setHandler(this.channelHandler_),this.supportsCrossDomainXhr_&&this.channel_.setSupportsCrossDomainXhrs(!0),this.channel_.connect(this.testUrl_,this.url_,this.messageUrlParams_||void 0)},e.Channel.prototype.close=function(){this.channel_.disconnect()},e.Channel.prototype.halfClose=function(){throw new Error("Not implemented")},e.Channel.prototype.send=function(e){if(goog.asserts.assert(goog.isObject(e)||"string"==typeof e,"only object type or raw string is supported"),"string"==typeof e)(n={})[t.RAW_DATA_KEY]=e,this.channel_.sendMap(n);else if(this.sendRawJson_){var n;(n={})[t.RAW_DATA_KEY]=goog.json.serialize(e),this.channel_.sendMap(n)}else this.channel_.sendMap(e)},e.Channel.prototype.disposeInternal=function(){this.channel_.setHandler(null),delete this.channelHandler_,this.channel_.disconnect(),delete this.channel_,e.Channel.base(this,"disposeInternal")},e.Channel.MessageEvent=function(n){e.Channel.MessageEvent.base(this,"constructor");var t=n.__sm__;t?(this.metadataKey=goog.object.getAnyKey(t),this.metadataKey?this.data=goog.object.get(t,this.metadataKey):this.data=t):this.data=n},goog.inherits(e.Channel.MessageEvent,goog.net.WebChannel.MessageEvent),e.Channel.ErrorEvent=function(n){e.Channel.ErrorEvent.base(this,"constructor"),this.status=goog.net.WebChannel.ErrorStatus.NETWORK_ERROR,this.errorCode=n},goog.inherits(e.Channel.ErrorEvent,goog.net.WebChannel.ErrorEvent),e.Channel.Handler_=function(n){e.Channel.Handler_.base(this,"constructor"),this.channel_=n},goog.inherits(e.Channel.Handler_,n.Handler),e.Channel.Handler_.prototype.channelOpened=function(e){goog.log.info(this.channel_.logger_,"WebChannel opened on "+this.channel_.url_),this.channel_.dispatchEvent(goog.net.WebChannel.EventType.OPEN)},e.Channel.Handler_.prototype.channelHandleArray=function(n,t){goog.asserts.assert(t,"array expected to be defined"),this.channel_.dispatchEvent(new e.Channel.MessageEvent(t))},e.Channel.Handler_.prototype.channelError=function(n,t){goog.log.info(this.channel_.logger_,"WebChannel aborted on "+this.channel_.url_+" due to channel error: "+t),this.channel_.dispatchEvent(new e.Channel.ErrorEvent(t))},e.Channel.Handler_.prototype.channelClosed=function(e,n,t){goog.log.info(this.channel_.logger_,"WebChannel closed on "+this.channel_.url_),this.channel_.dispatchEvent(goog.net.WebChannel.EventType.CLOSE)},e.Channel.prototype.getRuntimeProperties=function(){return new e.ChannelProperties(this.channel_)},e.ChannelProperties=function(e){this.channel_=e},e.ChannelProperties.prototype.getConcurrentRequestLimit=function(){return this.channel_.getForwardChannelRequestPool().getMaxSize()},e.ChannelProperties.prototype.isSpdyEnabled=function(){return this.getConcurrentRequestLimit()>1},e.ChannelProperties.prototype.getPendingRequestCount=function(){return this.channel_.getForwardChannelRequestPool().getRequestCount()},e.ChannelProperties.prototype.getHttpSessionId=function(){return this.channel_.getHttpSessionId()},e.ChannelProperties.prototype.commit=function(e){this.channel_.setForwardChannelFlushCallback(e)},e.ChannelProperties.prototype.getNonAckedMessageCount=goog.abstractMethod,e.ChannelProperties.prototype.notifyNonAckedMessageCount=goog.abstractMethod,e.ChannelProperties.prototype.onCommit=goog.abstractMethod,e.ChannelProperties.prototype.ackCommit=goog.abstractMethod,e.ChannelProperties.prototype.getLastStatusCode=function(){return this.channel_.getLastStatusCode()}});