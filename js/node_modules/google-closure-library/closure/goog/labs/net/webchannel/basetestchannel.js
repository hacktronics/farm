goog.provide("goog.labs.net.webChannel.BaseTestChannel"),goog.forwardDeclare("goog.labs.net.webChannel.WebChannelBase"),goog.require("goog.labs.net.webChannel.Channel"),goog.require("goog.labs.net.webChannel.ChannelRequest"),goog.require("goog.labs.net.webChannel.WebChannelDebug"),goog.require("goog.labs.net.webChannel.requestStats"),goog.require("goog.net.WebChannel"),goog.labs.net.webChannel.BaseTestChannel=function(t,e){this.channel_=t,this.channelDebug_=e,this.extraHeaders_=null,this.request_=null,this.receivedIntermediateResult_=!1,this.path_=null,this.lastStatusCode_=-1,this.hostPrefix_=null,this.clientProtocol_=null},goog.scope(function(){var t=goog.net.WebChannel,e=goog.labs.net.webChannel.BaseTestChannel,n=(goog.labs.net.webChannel.WebChannelDebug,goog.labs.net.webChannel.ChannelRequest),s=goog.labs.net.webChannel.requestStats;goog.labs.net.webChannel.Channel;e.State_={INIT:0,CONNECTION_TESTING:1},e.prototype.state_=null,e.prototype.setExtraHeaders=function(t){this.extraHeaders_=t},e.prototype.connect=function(o){this.path_=o;var a=this.channel_.getForwardChannelUri(this.path_);s.notifyStatEvent(s.Stat.TEST_STAGE_ONE_START);var i=this.channel_.getConnectionState().handshakeResult;if(null!=i)return this.hostPrefix_=this.channel_.correctHostPrefix(i[0]),this.state_=e.State_.CONNECTION_TESTING,void this.checkBufferingProxy_();a.setParameterValues("MODE","init"),!this.channel_.getBackgroundChannelTest()&&this.channel_.getHttpSessionIdParam()&&a.setParameterValues(t.X_HTTP_SESSION_ID,this.channel_.getHttpSessionIdParam()),this.request_=n.createChannelRequest(this,this.channelDebug_),this.request_.setExtraHeaders(this.extraHeaders_),this.request_.xmlHttpGet(a,!1,null),this.state_=e.State_.INIT},e.prototype.checkBufferingProxy_=function(){this.channelDebug_.debug("TestConnection: starting stage 2");var t=this.channel_.getConnectionState().bufferingProxyResult;if(null!=t)return this.channelDebug_.debug(function(){return"Buffered"}),s.notifyStatEvent(s.Stat.TEST_STAGE_TWO_START),void(t?(s.notifyStatEvent(s.Stat.PROXY),this.channel_.testConnectionFinished(this,!1)):(s.notifyStatEvent(s.Stat.NOPROXY),this.channel_.testConnectionFinished(this,!0)));this.request_=n.createChannelRequest(this,this.channelDebug_),this.request_.setExtraHeaders(this.extraHeaders_);var e=this.channel_.getBackChannelUri(this.hostPrefix_,this.path_);s.notifyStatEvent(s.Stat.TEST_STAGE_TWO_START),e.setParameterValues("TYPE","xmlhttp");var o=this.channel_.getHttpSessionIdParam(),a=this.channel_.getHttpSessionId();o&&a&&e.setParameterValue(o,a),this.request_.xmlHttpGet(e,!1,this.hostPrefix_)},e.prototype.createXhrIo=function(t){return this.channel_.createXhrIo(t)},e.prototype.abort=function(){this.request_&&(this.request_.cancel(),this.request_=null),this.lastStatusCode_=-1},e.prototype.isClosed=function(){return!1},e.prototype.onRequestData=function(t,o){if(this.lastStatusCode_=t.getLastStatusCode(),this.state_==e.State_.INIT){if(this.channelDebug_.debug("TestConnection: Got data for stage 1"),this.applyControlHeaders_(t),!o)return this.channelDebug_.debug("TestConnection: Null responseText"),void this.channel_.testConnectionFailure(this,n.Error.BAD_DATA);try{var a=this.channel_.getWireCodec().decodeMessage(o)}catch(t){return this.channelDebug_.dumpException(t),void this.channel_.testConnectionFailure(this,n.Error.BAD_DATA)}this.hostPrefix_=this.channel_.correctHostPrefix(a[0])}else this.state_==e.State_.CONNECTION_TESTING&&(this.receivedIntermediateResult_?s.notifyStatEvent(s.Stat.TEST_STAGE_TWO_DATA_TWO):"11111"==o?(s.notifyStatEvent(s.Stat.TEST_STAGE_TWO_DATA_ONE),this.receivedIntermediateResult_=!0,this.checkForEarlyNonBuffered_()&&(this.lastStatusCode_=200,this.request_.cancel(),this.channelDebug_.debug("Test connection succeeded; using streaming connection"),s.notifyStatEvent(s.Stat.NOPROXY),this.channel_.testConnectionFinished(this,!0))):(s.notifyStatEvent(s.Stat.TEST_STAGE_TWO_DATA_BOTH),this.receivedIntermediateResult_=!1))},e.prototype.onRequestComplete=function(t){if(this.lastStatusCode_=this.request_.getLastStatusCode(),!this.request_.getSuccess())return this.channelDebug_.debug("TestConnection: request failed, in state "+this.state_),this.state_==e.State_.INIT?s.notifyStatEvent(s.Stat.TEST_STAGE_ONE_FAILED):this.state_==e.State_.CONNECTION_TESTING&&s.notifyStatEvent(s.Stat.TEST_STAGE_TWO_FAILED),void this.channel_.testConnectionFailure(this,this.request_.getLastError());if(this.state_==e.State_.INIT)this.state_=e.State_.CONNECTION_TESTING,this.channelDebug_.debug("TestConnection: request complete for initial check"),this.checkBufferingProxy_();else if(this.state_==e.State_.CONNECTION_TESTING){this.channelDebug_.debug("TestConnection: request complete for stage 2"),this.receivedIntermediateResult_?(this.channelDebug_.debug("Test connection succeeded; using streaming connection"),s.notifyStatEvent(s.Stat.NOPROXY),this.channel_.testConnectionFinished(this,!0)):(this.channelDebug_.debug("Test connection failed; not using streaming"),s.notifyStatEvent(s.Stat.PROXY),this.channel_.testConnectionFinished(this,!1))}},e.prototype.applyControlHeaders_=function(e){if(!this.channel_.getBackgroundChannelTest()){var n=e.getXhr();if(n){var s=n.getStreamingResponseHeader(t.X_CLIENT_WIRE_PROTOCOL);if(this.clientProtocol_=s||null,this.channel_.getHttpSessionIdParam()){var o=n.getStreamingResponseHeader(t.X_HTTP_SESSION_ID);o?this.channel_.setHttpSessionId(o):this.channelDebug_.warning("Missing X_HTTP_SESSION_ID in the handshake response")}}}},e.prototype.getClientProtocol=function(){return this.clientProtocol_},e.prototype.getLastStatusCode=function(){return this.lastStatusCode_},e.prototype.shouldUseSecondaryDomains=function(){return this.channel_.shouldUseSecondaryDomains()},e.prototype.isActive=function(){return this.channel_.isActive()},e.prototype.checkForEarlyNonBuffered_=function(){return n.supportsXhrStreaming()},e.prototype.getForwardChannelUri=goog.abstractMethod,e.prototype.getBackChannelUri=goog.abstractMethod,e.prototype.correctHostPrefix=goog.abstractMethod,e.prototype.createDataUri=goog.abstractMethod,e.prototype.testConnectionFinished=goog.abstractMethod,e.prototype.testConnectionFailure=goog.abstractMethod,e.prototype.getConnectionState=goog.abstractMethod,e.prototype.setHttpSessionIdParam=goog.abstractMethod,e.prototype.getHttpSessionIdParam=goog.abstractMethod,e.prototype.setHttpSessionId=goog.abstractMethod,e.prototype.getHttpSessionId=goog.abstractMethod,e.prototype.getBackgroundChannelTest=goog.abstractMethod});