goog.provide("goog.labs.pubsub.BroadcastPubSub"),goog.require("goog.Disposable"),goog.require("goog.Timer"),goog.require("goog.array"),goog.require("goog.async.run"),goog.require("goog.events.EventHandler"),goog.require("goog.events.EventType"),goog.require("goog.log"),goog.require("goog.math"),goog.require("goog.pubsub.PubSub"),goog.require("goog.storage.Storage"),goog.require("goog.storage.mechanism.HTML5LocalStorage"),goog.require("goog.string"),goog.require("goog.userAgent"),goog.labs.pubsub.BroadcastPubSub=function(){if(goog.labs.pubsub.BroadcastPubSub.base(this,"constructor"),goog.labs.pubsub.BroadcastPubSub.instances_.push(this),this.pubSub_=new goog.pubsub.PubSub,this.registerDisposable(this.pubSub_),this.handler_=new goog.events.EventHandler(this),this.registerDisposable(this.handler_),this.logger_=goog.log.getLogger("goog.labs.pubsub.BroadcastPubSub"),this.mechanism_=new goog.storage.mechanism.HTML5LocalStorage,this.storage_=null,this.ie8LastEventTimes_=null,this.ie8StartupTimestamp_=goog.now()-1,this.mechanism_.isAvailable()){this.storage_=new goog.storage.Storage(this.mechanism_);var o=window;goog.labs.pubsub.BroadcastPubSub.IS_IE8_&&(this.ie8LastEventTimes_={},o=document),this.handler_.listen(o,goog.events.EventType.STORAGE,this.handleStorageEvent_)}},goog.inherits(goog.labs.pubsub.BroadcastPubSub,goog.Disposable),goog.labs.pubsub.BroadcastPubSub.instances_=[],goog.labs.pubsub.BroadcastPubSub.STORAGE_KEY_="_closure_bps",goog.labs.pubsub.BroadcastPubSub.prototype.handleStorageEvent_=function(o){if(goog.labs.pubsub.BroadcastPubSub.IS_IE8_)goog.async.run(this.handleIe8StorageEvent_,this);else{var s=o.getBrowserEvent();if(s.key==goog.labs.pubsub.BroadcastPubSub.STORAGE_KEY_){var u=JSON.parse(s.newValue),b=goog.isObject(u)&&u.args;goog.isArray(b)&&goog.array.every(b,o=>"string"==typeof o)?this.dispatch_(b):goog.log.warning(this.logger_,"storage event contained invalid arguments")}}},goog.labs.pubsub.BroadcastPubSub.prototype.dispatch_=function(o){goog.pubsub.PubSub.prototype.publish.apply(this.pubSub_,o)},goog.labs.pubsub.BroadcastPubSub.prototype.publish=function(o,s){var u=goog.array.toArray(arguments);if(this.storage_){var b=goog.now(),t={args:u,timestamp:b};if(goog.labs.pubsub.BroadcastPubSub.IS_IE8_){var a=null;try{a=this.storage_.get(goog.labs.pubsub.BroadcastPubSub.IE8_EVENTS_KEY_)}catch(o){goog.log.error(this.logger_,"publish encountered invalid event queue at "+goog.labs.pubsub.BroadcastPubSub.IE8_EVENTS_KEY_)}goog.isArray(a)||(a=[]);var g=a[a.length-1],e=g&&g.timestamp||this.ie8StartupTimestamp_;e>=b&&(b=e+goog.labs.pubsub.BroadcastPubSub.IE8_TIMESTAMP_UNIQUE_OFFSET_MS_,t.timestamp=b),a.push(t),this.storage_.set(goog.labs.pubsub.BroadcastPubSub.IE8_EVENTS_KEY_,a),goog.Timer.callOnce(goog.bind(this.cleanupIe8StorageEvents_,this,b),goog.labs.pubsub.BroadcastPubSub.IE8_EVENT_LIFETIME_MS_)}else this.storage_.set(goog.labs.pubsub.BroadcastPubSub.STORAGE_KEY_,t),this.storage_.remove(goog.labs.pubsub.BroadcastPubSub.STORAGE_KEY_)}goog.userAgent.IE||goog.array.forEach(goog.labs.pubsub.BroadcastPubSub.instances_,function(o){goog.async.run(goog.bind(o.dispatch_,o,u))})},goog.labs.pubsub.BroadcastPubSub.prototype.unsubscribe=function(o,s,u){return this.pubSub_.unsubscribe(o,s,u)},goog.labs.pubsub.BroadcastPubSub.prototype.unsubscribeByKey=function(o){return this.pubSub_.unsubscribeByKey(o)},goog.labs.pubsub.BroadcastPubSub.prototype.subscribe=function(o,s,u){return this.pubSub_.subscribe(o,s,u)},goog.labs.pubsub.BroadcastPubSub.prototype.subscribeOnce=function(o,s,u){return this.pubSub_.subscribeOnce(o,s,u)},goog.labs.pubsub.BroadcastPubSub.prototype.getCount=function(o){return this.pubSub_.getCount(o)},goog.labs.pubsub.BroadcastPubSub.prototype.clear=function(o){this.pubSub_.clear(o)},goog.labs.pubsub.BroadcastPubSub.prototype.disposeInternal=function(){goog.array.remove(goog.labs.pubsub.BroadcastPubSub.instances_,this),goog.labs.pubsub.BroadcastPubSub.IS_IE8_&&null!=this.storage_&&0==goog.labs.pubsub.BroadcastPubSub.instances_.length&&this.storage_.remove(goog.labs.pubsub.BroadcastPubSub.IE8_EVENTS_KEY_),goog.labs.pubsub.BroadcastPubSub.base(this,"disposeInternal")},goog.labs.pubsub.BroadcastPubSub.IE8_EVENTS_KEY_PREFIX_="_closure_bps_ie8evt",goog.labs.pubsub.BroadcastPubSub.IE8_EVENT_LIFETIME_MS_=1e4,goog.labs.pubsub.BroadcastPubSub.IE8_QUEUE_LIFETIME_MS_=3e4,goog.labs.pubsub.BroadcastPubSub.IE8_TIMESTAMP_UNIQUE_OFFSET_MS_=.01,goog.labs.pubsub.BroadcastPubSub.IE8_EVENTS_KEY_=goog.labs.pubsub.BroadcastPubSub.IE8_EVENTS_KEY_PREFIX_+goog.math.randomInt(1e9),goog.labs.pubsub.BroadcastPubSub.Ie8Event_,goog.labs.pubsub.BroadcastPubSub.IS_IE8_=goog.userAgent.IE&&8==goog.userAgent.DOCUMENT_MODE,goog.labs.pubsub.BroadcastPubSub.validateIe8Event_=function(o){return goog.isObject(o)&&"number"==typeof o.timestamp&&goog.array.every(o.args,o=>"string"==typeof o)?{timestamp:o.timestamp,args:o.args}:null},goog.labs.pubsub.BroadcastPubSub.filterValidIe8Events_=function(o){return goog.array.filter(goog.array.map(o,goog.labs.pubsub.BroadcastPubSub.validateIe8Event_),o=>null!=o)},goog.labs.pubsub.BroadcastPubSub.filterNewIe8Events_=function(o,s){return goog.array.filter(s,function(s){return s.timestamp>o})},goog.labs.pubsub.BroadcastPubSub.prototype.maybeProcessIe8Events_=function(o,s){if(!s.length)return!1;var u=goog.labs.pubsub.BroadcastPubSub.filterValidIe8Events_(s);if(u.length==s.length){var b=goog.array.peek(u).timestamp,t=this.ie8LastEventTimes_[o]||this.ie8StartupTimestamp_;if(b>t-goog.labs.pubsub.BroadcastPubSub.IE8_QUEUE_LIFETIME_MS_){this.ie8LastEventTimes_[o]=b,u=goog.labs.pubsub.BroadcastPubSub.filterNewIe8Events_(t,u);for(var a,g=0;a=u[g];g++)this.dispatch_(a.args);return!0}}else goog.log.warning(this.logger_,"invalid events found in queue "+o);return!1},goog.labs.pubsub.BroadcastPubSub.prototype.handleIe8StorageEvent_=function(){for(var o=this.mechanism_.getCount(),s=0;s<o;s++){var u=this.mechanism_.key(s);if("string"==typeof u&&goog.string.startsWith(u,goog.labs.pubsub.BroadcastPubSub.IE8_EVENTS_KEY_PREFIX_)){var b=null;try{b=this.storage_.get(u)}catch(o){goog.log.warning(this.logger_,"invalid remote event queue "+u)}goog.isArray(b)&&this.maybeProcessIe8Events_(u,b)||this.storage_.remove(u)}}},goog.labs.pubsub.BroadcastPubSub.prototype.cleanupIe8StorageEvents_=function(o){var s=null;try{s=this.storage_.get(goog.labs.pubsub.BroadcastPubSub.IE8_EVENTS_KEY_)}catch(o){goog.log.error(this.logger_,"cleanup encountered invalid event queue key "+goog.labs.pubsub.BroadcastPubSub.IE8_EVENTS_KEY_)}goog.isArray(s)&&(s=goog.labs.pubsub.BroadcastPubSub.filterNewIe8Events_(o,goog.labs.pubsub.BroadcastPubSub.filterValidIe8Events_(s))).length>0?this.storage_.set(goog.labs.pubsub.BroadcastPubSub.IE8_EVENTS_KEY_,s):this.storage_.remove(goog.labs.pubsub.BroadcastPubSub.IE8_EVENTS_KEY_)};