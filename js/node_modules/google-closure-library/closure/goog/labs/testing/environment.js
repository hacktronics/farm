goog.provide("goog.labs.testing.Environment"),goog.require("goog.Thenable"),goog.require("goog.array"),goog.require("goog.asserts"),goog.require("goog.debug.Console"),goog.require("goog.testing.MockClock"),goog.require("goog.testing.MockControl"),goog.require("goog.testing.PropertyReplacer"),goog.require("goog.testing.TestCase"),goog.require("goog.testing.jsunit"),goog.labs.testing.Environment=goog.defineClass(null,{constructor:function(){var o=goog.labs.testing.EnvironmentTestCase_.getInstance();o.registerEnvironment_(this),goog.labs.testing.Environment.activeTestCase_=o,this.mockControl=null,this.mockClock=null,this.shouldMakeMockControl_=!1,this.mockClockOn=!1,this.console=goog.labs.testing.Environment.console_,this.replacer=new goog.testing.PropertyReplacer},setUpPage:function(){this.mockClockOn&&!this.hasMockClock()&&(this.mockClock=new goog.testing.MockClock(!0))},tearDownPage:function(){this.hasMockClock()&&this.mockClock.dispose()},setUp:goog.nullFunction,tearDown:function(){if(this.mockClock){for(var o=0;o<100;o++)this.mockClock.tick(1e3);this.hasMockClock()&&this.mockClock.reset()}if(this.replacer.reset(),this.mockControl)try{this.mockControl.$verifyAll(),this.mockControl.$replayAll(),this.mockControl.$verifyAll()}finally{this.mockControl.$resetAll(),this.shouldMakeMockControl_&&this.mockControl.$tearDown()}},withMockControl:function(){return this.shouldMakeMockControl_||(this.shouldMakeMockControl_=!0,this.mockControl=new goog.testing.MockControl),this},withMockClock:function(){return this.hasMockClock()||(this.mockClockOn=!0,this.mockClock=new goog.testing.MockClock(!0)),this},hasMockClock:function(){return this.mockClockOn&&!!this.mockClock&&!this.mockClock.isDisposed()},mock:function(o){if(!this.shouldMakeMockControl_)throw new Error("MockControl not available on this environment. Call withMockControl if this environment is expected to contain a MockControl.");return this.mockControl.createStrictMock(o)},looseMock:function(o,t=!1){if(!this.shouldMakeMockControl_)throw new Error("MockControl not available on this environment. Call withMockControl if this environment is expected to contain a MockControl.");return this.mockControl.createLooseMock(o,t)}}),goog.labs.testing.Environment.activeTestCase_=null,goog.labs.testing.Environment.getTestCaseIfActive=function(){return goog.labs.testing.Environment.activeTestCase_},goog.labs.testing.Environment.console_=new goog.debug.Console,goog.labs.testing.Environment.console_.setCapturing(!0),goog.labs.testing.EnvironmentTestCase_=function(){goog.labs.testing.EnvironmentTestCase_.base(this,"constructor",document.title),this.environments_=[],this.testobj_=goog.global,goog.testing.TestCase.initializeTestRunner(this)},goog.inherits(goog.labs.testing.EnvironmentTestCase_,goog.testing.TestCase),goog.addSingletonGetter(goog.labs.testing.EnvironmentTestCase_),goog.labs.testing.EnvironmentTestCase_.prototype.setLifecycleObj=function(o){goog.asserts.assert(this.testobj_==goog.global,"A test method object has already been provided and only one is supported."),this.testobj_=o,this.testobj_.runTests&&(this.runTests=goog.bind(this.testobj_.runTests,this.testobj_)),this.testobj_.shouldRunTests&&(this.shouldRunTests=goog.bind(this.testobj_.shouldRunTests,this.testobj_))},goog.labs.testing.EnvironmentTestCase_.prototype.createTest=function(o,t,e,n){return new goog.labs.testing.EnvironmentTest_(o,t,e,n)},goog.labs.testing.EnvironmentTestCase_.prototype.registerEnvironment_=function(o){this.environments_.push(o)},goog.labs.testing.EnvironmentTestCase_.prototype.setUpPage=function(){var o=goog.array.map(this.environments_,function(o){return()=>o.setUpPage()});return this.testobj_.setUpPage&&o.push(()=>this.testobj_.setUpPage()),this.callAndChainPromises_(o)},goog.labs.testing.EnvironmentTestCase_.prototype.setUp=function(){var o=[];this.testobj_.configureEnvironment&&o.push(()=>this.testobj_.configureEnvironment());var t=this.getCurrentTest();return t instanceof goog.labs.testing.EnvironmentTest_&&goog.array.extend(o,t.configureEnvironments),goog.array.forEach(this.environments_,function(t){o.push(()=>t.setUp())},this),this.testobj_.setUp&&o.push(()=>this.testobj_.setUp()),this.callAndChainPromises_(o)},goog.labs.testing.EnvironmentTestCase_.prototype.callAndChainPromises_=function(o,t){const e=o=>goog.Thenable.isImplementedBy(o)||"function"==typeof goog.global.Promise&&o instanceof goog.global.Promise;let n;const s=o=>{n||(n=o instanceof Error?o:new Error(o))};let i;for(const n of o)if(e(i)){const o=t?o=>(s(o),n()):void 0;i=i.then(()=>n(),o)}else try{i=n()}catch(o){if(!t)throw o;s(o)}const r=()=>{if(n)throw n;return i};return e(i)?i.then(r,r):r()},goog.labs.testing.EnvironmentTestCase_.prototype.tearDown=function(){var o=[];return this.testobj_.tearDown&&o.push(()=>this.testobj_.tearDown()),goog.array.forEachRight(this.environments_,function(t){o.push(()=>t.tearDown())}),this.callAndChainPromises_(o,!0)},goog.labs.testing.EnvironmentTestCase_.prototype.tearDownPage=function(){this.testobj_.tearDownPage&&this.testobj_.tearDownPage(),goog.array.forEachRight(this.environments_,function(o){o.tearDownPage()})},goog.labs.testing.EnvironmentTest_=function(o,t,e,n){goog.labs.testing.EnvironmentTest_.base(this,"constructor",o,t,e,n),this.configureEnvironments=goog.array.map(goog.array.filter(n||[],function(o){return goog.isFunction(o.configureEnvironment)}),function(o){return goog.bind(o.configureEnvironment,o)})},goog.inherits(goog.labs.testing.EnvironmentTest_,goog.testing.TestCase.Test);