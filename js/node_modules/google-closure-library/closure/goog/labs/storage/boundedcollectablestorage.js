goog.provide("goog.labs.storage.BoundedCollectableStorage"),goog.forwardDeclare("goog.storage.mechanism.IterableMechanism"),goog.require("goog.array"),goog.require("goog.asserts"),goog.require("goog.iter"),goog.require("goog.storage.CollectableStorage"),goog.require("goog.storage.ErrorCode"),goog.require("goog.storage.ExpiringStorage"),goog.labs.storage.BoundedCollectableStorage=function(e,o){goog.labs.storage.BoundedCollectableStorage.base(this,"constructor",e),this.maxItems_=o},goog.inherits(goog.labs.storage.BoundedCollectableStorage,goog.storage.CollectableStorage),goog.labs.storage.BoundedCollectableStorage.KEY_LIST_KEY_="bounded-collectable-storage",goog.labs.storage.BoundedCollectableStorage.prototype.rebuildIndex_=function(){var e=[];return goog.iter.forEach(this.mechanism.__iterator__(!0),function(o){if(goog.labs.storage.BoundedCollectableStorage.KEY_LIST_KEY_!=o){var t;try{t=this.getWrapper(o,!0)}catch(e){if(e==goog.storage.ErrorCode.INVALID_VALUE)return;throw e}goog.asserts.assert(t);var g=goog.storage.ExpiringStorage.getCreationTime(t);e.push({key:o,created:g})}},this),goog.array.sort(e,function(e,o){return e.created-o.created}),goog.array.map(e,function(e){return e.key})},goog.labs.storage.BoundedCollectableStorage.prototype.getKeys_=function(e){var o=goog.labs.storage.BoundedCollectableStorage.superClass_.get.call(this,goog.labs.storage.BoundedCollectableStorage.KEY_LIST_KEY_)||null;return o&&goog.isArray(o)||(o=e?this.rebuildIndex_():[]),o},goog.labs.storage.BoundedCollectableStorage.prototype.setKeys_=function(e){goog.labs.storage.BoundedCollectableStorage.superClass_.set.call(this,goog.labs.storage.BoundedCollectableStorage.KEY_LIST_KEY_,e)},goog.labs.storage.BoundedCollectableStorage.removeSubsequence_=function(e,o){if(0==o.length)return goog.array.clone(e);for(var t=[],g=0,r=0;r<o.length&&g<e.length;){for(var a=o[r];g<e.length&&e[g]!=a;)t.push(e[g]),++g;++r}return goog.asserts.assert(r==o.length),goog.asserts.assert(g<e.length),goog.array.concat(t,goog.array.slice(e,g+1))},goog.labs.storage.BoundedCollectableStorage.prototype.collectOversize_=function(e,o){if(e.length<=o)return goog.array.clone(e);var t=goog.array.slice(e,0,e.length-o);return goog.array.forEach(t,function(e){goog.labs.storage.BoundedCollectableStorage.superClass_.remove.call(this,e)},this),goog.labs.storage.BoundedCollectableStorage.removeSubsequence_(e,t)},goog.labs.storage.BoundedCollectableStorage.prototype.collect=function(e){var o=this.getKeys_(!0),t=this.collectInternal(o,e);o=goog.labs.storage.BoundedCollectableStorage.removeSubsequence_(o,t),this.setKeys_(o)},goog.labs.storage.BoundedCollectableStorage.prototype.collectOversize=function(e,o){var t=this.getKeys_(!0);if(!e){var g=this.collectInternal(t,o);t=goog.labs.storage.BoundedCollectableStorage.removeSubsequence_(t,g)}t=this.collectOversize_(t,this.maxItems_),this.setKeys_(t)},goog.labs.storage.BoundedCollectableStorage.prototype.set=function(e,o,t){goog.labs.storage.BoundedCollectableStorage.base(this,"set",e,o,t);var g=this.getKeys_(!0);if(goog.array.remove(g,e),void 0!==o&&(g.push(e),g.length>=this.maxItems_)){var r=this.collectInternal(g);g=goog.labs.storage.BoundedCollectableStorage.removeSubsequence_(g,r),g=this.collectOversize_(g,this.maxItems_)}this.setKeys_(g)},goog.labs.storage.BoundedCollectableStorage.prototype.remove=function(e){goog.labs.storage.BoundedCollectableStorage.base(this,"remove",e);var o=this.getKeys_(!1);void 0!==o&&(goog.array.remove(o,e),this.setKeys_(o))};