goog.provide("goog.labs.mock"),goog.provide("goog.labs.mock.TimeoutError"),goog.provide("goog.labs.mock.VerificationError"),goog.require("goog.array"),goog.require("goog.asserts"),goog.require("goog.debug"),goog.require("goog.debug.Error"),goog.require("goog.functions"),goog.require("goog.labs.mock.timeout"),goog.require("goog.labs.mock.timeout.TimeoutMode"),goog.require("goog.labs.mock.verification"),goog.require("goog.labs.mock.verification.BaseVerificationMode"),goog.require("goog.labs.mock.verification.VerificationMode"),goog.require("goog.object"),goog.setTestOnly("goog.labs.mock"),goog.labs.mock.mock=function(o){var t=new goog.labs.mock.MockObjectManager_(o).getMockedItem();return goog.asserts.assertObject(t),t},goog.labs.mock.mockFunction=function(o){var t=new goog.labs.mock.MockFunctionManager_(o).getMockedItem();return goog.asserts.assertFunction(t),t},goog.labs.mock.mockConstructor=function(o){var t=goog.labs.mock.mockFunction(o);for(var e in o)"superClass_"!=e&&"prototype"!=e&&o.hasOwnProperty(e)&&(t[e]=o[e]);return t},goog.labs.mock.spy=function(o){var t=new goog.labs.mock.MockSpyManager_(o).getMockedItem();return goog.asserts.assert(t),t},goog.labs.mock.verify=function(o,t){var e=t||goog.labs.mock.verification.atLeast(1);return o.$verificationModeSetter(e),o.$callVerifier},goog.labs.mock.waitAndVerify=function(o,...t){goog.asserts.assert(t.length<=2,"At most 2 arguments may be passed as Timeout and Verification modes.");for(var e=0;e<2;e++){var i=t[e];i instanceof goog.labs.mock.timeout.TimeoutMode?o.$timeoutModeSetter(i):i instanceof goog.labs.mock.verification.BaseVerificationMode&&o.$verificationModeSetter(i)}return o.$callWaiter},goog.labs.mock.getFunctionName_=function(o){var t=goog.debug.getFunctionName(o);return""!=t&&"[Anonymous]"!=t||(t="#anonymous"+goog.labs.mock.getUid(o)),t},goog.labs.mock.formatMethodCall_=function(o,t){return t=t||[],o+"("+(t=goog.array.map(t,function(o){return goog.isFunction(o)?"<function "+goog.labs.mock.getFunctionName_(o)+">":goog.isObject(o)&&!goog.isFunction(o)&&!goog.isArray(o)&&o.constructor!=Object?o.toString():goog.labs.mock.formatValue_(o)})).join(", ")+")"},goog.labs.mock.uid_=[],goog.labs.mock.getUid=function(o){var t=goog.array.indexOf(goog.labs.mock.uid_,o);return-1==t&&(t=goog.labs.mock.uid_.length,goog.labs.mock.uid_.push(o)),t},goog.labs.mock.formatValue_=function(o,t){var e=void 0===t||t,i=[],r=[],n=function(o){try{if(void 0===o)r.push("undefined");else if(null===o)r.push("NULL");else if("string"==typeof o)r.push('"'+function(o){return o.replace(/\n/g,"\n")}(o)+'"');else if(goog.isFunction(o)){var t=goog.labs.mock.getFunctionName_(o);r.push("<function "+t+">")}else if(goog.isObject(o))if(goog.array.contains(i,o))e?r.push("<recursive/dupe obj_"+goog.labs.mock.getUid(o)+">"):r.push("<recursive/dupe>");else{for(var g in i.push(o),r.push("{"),o)r.push(" "),r.push('"'+g+'":'),n(o[g]);e&&r.push(" _id:"+goog.labs.mock.getUid(o)),r.push("}")}else r.push(o)}catch(o){r.push("*** "+o+" ***")}};return n(o),r.join("").replace(/"closure_uid_\d+"/g,"_id").replace(/{ /g,"{")},goog.labs.mock.VerificationError=function(o,t,e,i){var r=goog.labs.mock.VerificationError.getVerificationErrorMsg_(o,t,e,i);goog.labs.mock.VerificationError.base(this,"constructor",r)},goog.inherits(goog.labs.mock.VerificationError,goog.debug.Error),goog.labs.mock.VerificationError.prototype.name="VerificationError",goog.labs.mock.TimeoutError=function(o,t,e,i){var r=goog.labs.mock.TimeoutError.getTimeoutErrorMsg_(o,t,e,i);goog.labs.mock.TimeoutError.base(this,"constructor",r)},goog.inherits(goog.labs.mock.TimeoutError,goog.debug.Error),goog.labs.mock.TimeoutError.prototype.name="TimeoutError",goog.labs.mock.PROTOTYPE_FIELDS_=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],goog.labs.mock.VerificationError.getVerificationErrorMsg_=function(o,t,e,i){o=goog.array.filter(o,function(o){return o.getMethodName()==t});var r="\nExpected: "+goog.labs.mock.formatMethodCall_(t,i).toString()+" "+e.describe();return r+="\nRecorded: ",o.length>0?r+=o.join(",\n          "):r+="No recorded calls",r},goog.labs.mock.TimeoutError.getTimeoutErrorMsg_=function(o,t,e,i){return"Function call was either not invoked or never met criteria specified by provided verification mode. "+goog.labs.mock.VerificationError.getVerificationErrorMsg_(o,t,e,i)},goog.labs.mock.MockManager_=function(){this.mockedItem={},this.mockee=null,this.methodBindings=[],this.$stubBinder=null,this.callRecords_=[],this.verificationMode_=goog.labs.mock.verification.atLeast(1),this.timeoutMode_=goog.labs.mock.timeout.timeout(0),this.callListeners_={}},goog.labs.mock.MockManager_.prototype.setVerificationMode_=function(o){this.verificationMode_=o},goog.labs.mock.MockManager_.prototype.setTimeoutMode_=function(o){this.timeoutMode_=o},goog.labs.mock.MockManager_.prototype.handleMockCall_=function(o,t){var e=goog.array.slice(arguments,1);return new goog.labs.mock.StubBinderImpl_(this,o,e)},goog.labs.mock.MockManager_.prototype.getMockedItem=function(){return this.mockedItem},goog.labs.mock.MockManager_.prototype.addBinding=function(o,t,e){var i=[new goog.labs.mock.MethodBinding_(o,t,e)];return goog.array.insertAt(this.methodBindings,i,0),i},goog.labs.mock.MockManager_.prototype.getNextBinding=function(o,t){var e=goog.array.find(this.methodBindings,function(e){return e[0].matches(o,t,!1)});return null==e?null:e.length>1?e.shift().getStub():e[0].getStub()},goog.labs.mock.MockManager_.prototype.getExecutor=function(o,t){return this.getNextBinding(o,t)},goog.labs.mock.MockManager_.prototype.executeStub=function(o,t){var e=goog.array.slice(arguments,1),i=this.recordCall_(o,e);this.callListeners_[o]instanceof Set&&this.callListeners_[o].forEach(o=>{o(i)});var r=this.getExecutor(o,e);if(r)return r.apply(null,e)},goog.labs.mock.MockManager_.prototype.recordCall_=function(o,t){var e=new goog.labs.mock.MethodBinding_(o,t,goog.nullFunction);return this.callRecords_.push(e),e},goog.labs.mock.MockManager_.prototype.verifyInvocation=function(o,t){var e=goog.array.slice(arguments,1),i=goog.array.count(this.callRecords_,function(t){return t.matches(o,e,!0)});if(!this.verificationMode_.verify(i))throw new goog.labs.mock.VerificationError(this.callRecords_,o,this.verificationMode_,e)},goog.labs.mock.MockManager_.prototype.waitForCall=function(o,...t){var e=goog.array.count(this.callRecords_,function(e){return e.matches(o,t,!0)});return new Promise((i,r)=>{if(this.verificationMode_.verify(e))return void i();var n=setTimeout(()=>{r(new goog.labs.mock.TimeoutError(this.callRecords_,o,this.verificationMode_,t)),this.callListeners_[o].delete(g)},this.timeoutMode_.duration);this.callListeners_[o]||(this.callListeners_[o]=new Set);const g=r=>{r.matches(o,t,!0)&&(e++,this.verificationMode_.verify(e)&&(i(),clearTimeout(n),this.callListeners_[o].delete(g)))};this.callListeners_[o].add(g)})},goog.labs.mock.MockObjectManager_=function(o){var t;if(goog.labs.mock.MockObjectManager_.base(this,"constructor"),this.objectStubBinder_={},this.mockee=o,this.objectCallVerifier_={},this.objectCallWaiter_={},goog.isFunction(o)){var e=function(){};goog.inherits(e,o),t=new e}else t=o;var i=function(){};i.prototype=t,this.mockedItem=new i;for(var r=goog.isFunction(o)?o.prototype:o,n=goog.object.getAllPropertyNames(r),g=0;g<goog.labs.mock.PROTOTYPE_FIELDS_.length;g++){var a=goog.labs.mock.PROTOTYPE_FIELDS_[g];goog.array.contains(n,a)||n.push(a)}for(g=0;g<n.length;g++){a=n[g];goog.isFunction(r[a])&&(this.mockedItem[a]=goog.bind(this.executeStub,this,a),this.objectStubBinder_[a]=goog.bind(this.handleMockCall_,this,a),this.objectCallVerifier_[a]=goog.bind(this.verifyInvocation,this,a),this.objectCallWaiter_[a]=goog.bind(this.waitForCall,this,a))}this.mockedItem.$stubBinder=this.objectStubBinder_,this.mockedItem.$callVerifier=this.objectCallVerifier_,this.mockedItem.$callWaiter=this.objectCallWaiter_,this.mockedItem.$verificationModeSetter=goog.bind(this.setVerificationMode_,this),this.mockedItem.$timeoutModeSetter=goog.bind(this.setTimeoutMode_,this)},goog.inherits(goog.labs.mock.MockObjectManager_,goog.labs.mock.MockManager_),goog.labs.mock.MockSpyManager_=function(o){goog.labs.mock.MockSpyManager_.base(this,"constructor",o)},goog.inherits(goog.labs.mock.MockSpyManager_,goog.labs.mock.MockObjectManager_),goog.labs.mock.MockSpyManager_.prototype.getNextBinding=function(o,t){var e=goog.labs.mock.MockSpyManager_.base(this,"getNextBinding",o,t);return e||(e=goog.bind(this.mockee[o],this.mockedItem)),e},goog.labs.mock.MockFunctionManager_=function(o){goog.labs.mock.MockFunctionManager_.base(this,"constructor"),this.func_=o,this.functionStubBinder_=this.useMockedFunctionName_(this.handleMockCall_),this.mockedItem=this.useMockedFunctionName_(this.executeStub),this.mockedItem.$stubBinder=this.functionStubBinder_,this.mockedItem.$callVerifier=this.useMockedFunctionName_(this.verifyInvocation),this.mockedItem.$verificationModeSetter=goog.bind(this.setVerificationMode_,this),this.mockedItem.$timeoutModeSetter=goog.bind(this.setTimeoutMode_,this)},goog.inherits(goog.labs.mock.MockFunctionManager_,goog.labs.mock.MockManager_),goog.labs.mock.MockFunctionManager_.prototype.useMockedFunctionName_=function(o){var t=this;return function(e){var i=goog.array.clone(arguments),r="#mockFor<"+goog.labs.mock.getFunctionName_(t.func_)+">";return goog.array.insertAt(i,r,0),o.apply(t,i)}},goog.labs.mock.StubBinder=function(){},goog.labs.mock.StubBinder.prototype.then=goog.abstractMethod,goog.labs.mock.StubBinder.prototype.thenReturn=goog.abstractMethod,goog.labs.mock.StubBinderImpl_=function(o,t,e){this.mockManager_=o,this.name_=t,this.args_=e,this.sequentialStubsArray_=[]},goog.labs.mock.StubBinderImpl_.prototype.then=function(o){return this.sequentialStubsArray_.length?this.sequentialStubsArray_.push(new goog.labs.mock.MethodBinding_(this.name_,this.args_,o)):this.sequentialStubsArray_=this.mockManager_.addBinding(this.name_,this.args_,o),this},goog.labs.mock.StubBinderImpl_.prototype.thenReturn=function(o){return this.then(goog.functions.constant(o))},goog.labs.mock.when=function(o){return goog.asserts.assert(o.$stubBinder,"Stub binder cannot be null!"),o.$stubBinder},goog.labs.mock.MethodBinding_=function(o,t,e){this.methodName_=o,this.args_=t,this.stub_=e},goog.labs.mock.MethodBinding_.prototype.getStub=function(){return this.stub_},goog.labs.mock.MethodBinding_.prototype.toString=function(){return goog.labs.mock.formatMethodCall_(this.methodName_||"",this.args_)},goog.labs.mock.MethodBinding_.prototype.getMethodName=function(){return this.methodName_||""},goog.labs.mock.MethodBinding_.prototype.matches=function(o,t,e){var i=e?t:this.args_,r=e?this.args_:t;return this.methodName_==o&&goog.array.equals(r,i,function(o,t){return t&&goog.isFunction(t.matches)?t.matches(o):goog.array.defaultCompareEquality(t,o)})};