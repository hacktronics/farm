goog.provide("goog.graphics.CanvasGraphics"),goog.require("goog.dom.TagName"),goog.require("goog.events.EventType"),goog.require("goog.graphics.AbstractGraphics"),goog.require("goog.graphics.CanvasEllipseElement"),goog.require("goog.graphics.CanvasGroupElement"),goog.require("goog.graphics.CanvasImageElement"),goog.require("goog.graphics.CanvasPathElement"),goog.require("goog.graphics.CanvasRectElement"),goog.require("goog.graphics.CanvasTextElement"),goog.require("goog.graphics.Font"),goog.require("goog.graphics.SolidFill"),goog.require("goog.math.Size"),goog.require("goog.style"),goog.graphics.CanvasGraphics=function(t,e,o,a,s){goog.graphics.AbstractGraphics.call(this,t,e,o,a,s)},goog.inherits(goog.graphics.CanvasGraphics,goog.graphics.AbstractGraphics),goog.graphics.CanvasGraphics.prototype.setElementFill=function(t,e){this.redraw()},goog.graphics.CanvasGraphics.prototype.setElementStroke=function(t,e){this.redraw()},goog.graphics.CanvasGraphics.prototype.setElementTransform=function(t,e,o,a,s,i){this.redraw()},goog.graphics.CanvasGraphics.prototype.setElementAffineTransform=function(t,e){this.redraw()},goog.graphics.CanvasGraphics.prototype.pushElementTransform=function(t){var e=this.getContext();e.save();var o=t.getTransform(),a=o.getTranslateX(),s=o.getTranslateY();(a||s)&&e.translate(a,s);var i=o.getShearY();i&&e.rotate(Math.asin(i))},goog.graphics.CanvasGraphics.prototype.popElementTransform=function(){this.getContext().restore()},goog.graphics.CanvasGraphics.prototype.createDom=function(){var t=this.dom_.createDom(goog.dom.TagName.DIV,{style:"position:relative;overflow:hidden"});this.setElementInternal(t),this.canvas_=this.dom_.createDom(goog.dom.TagName.CANVAS),t.appendChild(this.canvas_),this.canvasElement=new goog.graphics.CanvasGroupElement(this),this.lastGroup_=this.canvasElement,this.redrawTimeout_=0,this.updateSize()},goog.graphics.CanvasGraphics.prototype.clearContext_=function(){this.context_=null},goog.graphics.CanvasGraphics.prototype.getContext=function(){return this.getElement()||this.createDom(),this.context_||(this.context_=this.canvas_.getContext("2d"),this.context_.save()),this.context_},goog.graphics.CanvasGraphics.prototype.setCoordOrigin=function(t,e){this.coordLeft=t,this.coordTop=e,this.redraw()},goog.graphics.CanvasGraphics.prototype.setCoordSize=function(t,e){goog.graphics.CanvasGraphics.superClass_.setCoordSize.apply(this,arguments),this.redraw()},goog.graphics.CanvasGraphics.prototype.setSize=function(t,e){this.width=t,this.height=e,this.updateSize(),this.redraw()},goog.graphics.CanvasGraphics.prototype.getPixelSize=function(){var t,e,o=this.width,a=this.height,s="string"==typeof o&&-1!=o.indexOf("%"),i="string"==typeof a&&-1!=a.indexOf("%");return this.isInDocument()||!s&&!i?(s&&(t=this.getElement().parentNode,e=goog.style.getSize(t),o=parseFloat(o)*e.width/100),i&&(t=t||this.getElement().parentNode,e=e||goog.style.getSize(t),a=parseFloat(a)*e.height/100),new goog.math.Size(o,a)):null},goog.graphics.CanvasGraphics.prototype.updateSize=function(){goog.style.setSize(this.getElement(),this.width,this.height);var t=this.getPixelSize();t&&(goog.style.setSize(this.canvas_,t.width,t.height),this.canvas_.width=t.width,this.canvas_.height=t.height,this.clearContext_())},goog.graphics.CanvasGraphics.prototype.reset=function(){var t=this.getContext();t.restore();var e=this.getPixelSize();e.width&&e.height&&t.clearRect(0,0,e.width,e.height),t.save()},goog.graphics.CanvasGraphics.prototype.clear=function(){this.reset(),this.canvasElement.clear();for(var t=this.getElement();t.childNodes.length>1;)t.removeChild(t.lastChild)},goog.graphics.CanvasGraphics.prototype.redraw=function(){if(this.preventRedraw_)this.needsRedraw_=!0;else if(this.isInDocument()){if(this.reset(),this.coordWidth){var t=this.getPixelSize();this.getContext().scale(t.width/this.coordWidth,t.height/this.coordHeight)}(this.coordLeft||this.coordTop)&&this.getContext().translate(-this.coordLeft,-this.coordTop),this.pushElementTransform(this.canvasElement),this.canvasElement.draw(this.context_),this.popElementTransform()}},goog.graphics.CanvasGraphics.prototype.drawElement=function(t){if(!(t instanceof goog.graphics.CanvasTextElement)){var e=this.getContext();if(this.pushElementTransform(t),!t.getFill||!t.getStroke)return t.draw(e),void this.popElementTransform();var o=t.getFill();if(o)if(o instanceof goog.graphics.SolidFill)0!=o.getOpacity()&&(e.globalAlpha=o.getOpacity(),e.fillStyle=o.getColor(),t.draw(e),e.fill(),e.globalAlpha=1);else{var a=e.createLinearGradient(o.getX1(),o.getY1(),o.getX2(),o.getY2());a.addColorStop(0,o.getColor1()),a.addColorStop(1,o.getColor2()),e.fillStyle=a,t.draw(e),e.fill()}var s=t.getStroke();if(s){t.draw(e),e.strokeStyle=s.getColor();var i=s.getWidth();"string"==typeof i&&-1!=i.indexOf("px")&&(i=parseFloat(i)/this.getPixelScaleX()),e.lineWidth=i,e.stroke()}this.popElementTransform()}},goog.graphics.CanvasGraphics.prototype.append=function(t,e){(e=e||this.canvasElement).appendChild(t),this.isDrawable(e)&&this.drawElement(t)},goog.graphics.CanvasGraphics.prototype.drawEllipse=function(t,e,o,a,s,i,r){var n=new goog.graphics.CanvasEllipseElement(null,this,t,e,o,a,s,i);return this.append(n,r),n},goog.graphics.CanvasGraphics.prototype.drawRect=function(t,e,o,a,s,i,r){var n=new goog.graphics.CanvasRectElement(null,this,t,e,o,a,s,i);return this.append(n,r),n},goog.graphics.CanvasGraphics.prototype.drawImage=function(t,e,o,a,s,i){var r=new goog.graphics.CanvasImageElement(null,this,t,e,o,a,s);return this.append(r,i),r},goog.graphics.CanvasGraphics.prototype.drawTextOnLine=function(t,e,o,a,s,i,r,n,g,h){var p=new goog.graphics.CanvasTextElement(this,t,e,o,a,s,i,r,n,g);return this.append(p,h),p},goog.graphics.CanvasGraphics.prototype.drawPath=function(t,e,o,a){var s=new goog.graphics.CanvasPathElement(null,this,t,e,o);return this.append(s,a),s},goog.graphics.CanvasGraphics.prototype.isDrawable=function(t){return this.isInDocument()&&!this.redrawTimeout_&&!this.isRedrawRequired(t)},goog.graphics.CanvasGraphics.prototype.isRedrawRequired=function(t){return t!=this.canvasElement&&t!=this.lastGroup_},goog.graphics.CanvasGraphics.prototype.createGroup=function(t){var e=new goog.graphics.CanvasGroupElement(this);return(t=t||this.canvasElement)!=this.canvasElement&&t!=this.lastGroup_||(this.lastGroup_=e),this.append(e,t),e},goog.graphics.CanvasGraphics.prototype.getTextWidth=goog.abstractMethod,goog.graphics.CanvasGraphics.prototype.disposeInternal=function(){this.context_=null,goog.graphics.CanvasGraphics.superClass_.disposeInternal.call(this)},goog.graphics.CanvasGraphics.prototype.enterDocument=function(){var t=this.getPixelSize();goog.graphics.CanvasGraphics.superClass_.enterDocument.call(this),t||(this.updateSize(),this.dispatchEvent(goog.events.EventType.RESIZE)),this.redraw()},goog.graphics.CanvasGraphics.prototype.suspend=function(){this.preventRedraw_=!0},goog.graphics.CanvasGraphics.prototype.resume=function(){this.preventRedraw_=!1,this.needsRedraw_&&(this.redraw(),this.needsRedraw_=!1)},goog.graphics.CanvasGraphics.prototype.removeElement=function(t){t&&(this.canvasElement.removeElement(t),this.redraw())};