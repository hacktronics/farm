goog.module("goog.html.sanitizer.SafeDomTreeProcessor"),goog.module.declareLegacyNamespace();var Const=goog.require("goog.string.Const"),ElementWeakMap=goog.require("goog.html.sanitizer.ElementWeakMap"),NodeType=goog.require("goog.dom.NodeType"),TagName=goog.require("goog.dom.TagName"),googDom=goog.require("goog.dom"),googLog=goog.require("goog.log"),noclobber=goog.require("goog.html.sanitizer.noclobber"),safe=goog.require("goog.dom.safe"),uncheckedconversions=goog.require("goog.html.uncheckedconversions"),userAgent=goog.require("goog.userAgent"),logger=googLog.getLogger("goog.html.sanitizer.SafeDomTreeProcessor"),SAFE_PARSING_SUPPORTED=!userAgent.IE||userAgent.isDocumentModeOrHigher(10),HTML_SANITIZER_TEMPLATE_SUPPORTED=!userAgent.IE||null==document.documentMode;function getDomTreeWalker(e){var o,r=uncheckedconversions.safeHtmlFromStringKnownToSatisfyTypeContract(Const.from("Never attached to DOM."),e),t=document.createElement("template");if(HTML_SANITIZER_TEMPLATE_SUPPORTED&&"content"in t)safe.unsafeSetInnerHtmlDoNotUseOrElse(t,r),o=t.content;else{var n=document.implementation.createHTMLDocument("x");o=n.body,safe.unsafeSetInnerHtmlDoNotUseOrElse(n.body,r)}return document.createTreeWalker(o,NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_TEXT,null,!1)}var SafeDomTreeProcessor=function(){};SafeDomTreeProcessor.prototype.processToString=function(e){if(!SAFE_PARSING_SUPPORTED)return"";var o=this.processToTree(e);if(noclobber.getElementAttributes(o).length>0){var r=googDom.createElement(TagName.SPAN);r.appendChild(o),o=r}var t=(new XMLSerializer).serializeToString(o);return t.slice(t.indexOf(">")+1,t.lastIndexOf("</"))},SafeDomTreeProcessor.prototype.processToTree=function(e){if(!SAFE_PARSING_SUPPORTED)return googDom.createElement(TagName.SPAN);var o=googDom.createElement(TagName.SPAN);this.processRoot(o);for(var r,t=getDomTreeWalker(e=this.preProcessHtml(e)),n=ElementWeakMap.newWeakMap();r=t.nextNode();){var s=this.createNode_(r);if(s){noclobber.isNodeElement(s)&&n.set(r,s);var a=noclobber.getParentNode(r),g=!1;if(a){var c=noclobber.getNodeType(a),i=noclobber.getNodeName(a).toLowerCase(),l=noclobber.getParentNode(a);if(c!=NodeType.DOCUMENT_FRAGMENT||l){if("body"==i&&l){var m=noclobber.getParentNode(l);m&&!noclobber.getParentNode(m)&&(g=!0)}}else g=!0;var u=null;g||!a?u=o:noclobber.isNodeElement(a)&&(u=n.get(a)),u.content&&(u=u.content),u.appendChild(s)}}else googDom.removeChildren(r)}return n.clear&&n.clear(),o},SafeDomTreeProcessor.prototype.processRoot=function(e){},SafeDomTreeProcessor.prototype.preProcessHtml=function(e){},SafeDomTreeProcessor.prototype.createNode_=function(e){var o=noclobber.getNodeType(e);switch(o){case NodeType.TEXT:return this.createTextNode(e);case NodeType.ELEMENT:return this.createElement_(noclobber.assertNodeIsElement(e));default:return googLog.warning(logger,"Dropping unknown node type: "+o),null}},SafeDomTreeProcessor.prototype.createTextNode=function(e){},SafeDomTreeProcessor.prototype.createElement_=function(e){if("TEMPLATE"==noclobber.getNodeName(e).toUpperCase())return null;var o=this.createElementWithoutAttributes(e);return o?(this.processElementAttributes_(e,o),o):null},SafeDomTreeProcessor.prototype.createElementWithoutAttributes=function(e){},SafeDomTreeProcessor.prototype.processElementAttributes_=function(e,o){var r=noclobber.getElementAttributes(e);if(null!=r)for(var t,n=0;t=r[n];n++)if(t.specified){var s=this.processElementAttribute(e,t);null!==s&&noclobber.setElementAttribute(o,t.name,s)}},SafeDomTreeProcessor.prototype.processElementAttribute=function(e,o){},SafeDomTreeProcessor.SAFE_PARSING_SUPPORTED=SAFE_PARSING_SUPPORTED,exports=SafeDomTreeProcessor;