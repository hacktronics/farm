goog.provide("goog.html.sanitizer.HtmlSanitizer"),goog.provide("goog.html.sanitizer.HtmlSanitizer.Builder"),goog.provide("goog.html.sanitizer.HtmlSanitizerAttributePolicy"),goog.provide("goog.html.sanitizer.HtmlSanitizerPolicy"),goog.provide("goog.html.sanitizer.HtmlSanitizerPolicyContext"),goog.provide("goog.html.sanitizer.HtmlSanitizerPolicyHints"),goog.provide("goog.html.sanitizer.HtmlSanitizerUrlPolicy"),goog.require("goog.array"),goog.require("goog.asserts"),goog.require("goog.dom"),goog.require("goog.dom.TagName"),goog.require("goog.functions"),goog.require("goog.html.SafeHtml"),goog.require("goog.html.SafeStyle"),goog.require("goog.html.SafeStyleSheet"),goog.require("goog.html.SafeUrl"),goog.require("goog.html.sanitizer.AttributeSanitizedWhitelist"),goog.require("goog.html.sanitizer.AttributeWhitelist"),goog.require("goog.html.sanitizer.CssSanitizer"),goog.require("goog.html.sanitizer.SafeDomTreeProcessor"),goog.require("goog.html.sanitizer.TagBlacklist"),goog.require("goog.html.sanitizer.TagWhitelist"),goog.require("goog.html.sanitizer.noclobber"),goog.require("goog.html.uncheckedconversions"),goog.require("goog.object"),goog.require("goog.string"),goog.require("goog.string.Const"),goog.html.sanitizer.HtmlSanitizerPolicyHints,goog.html.sanitizer.HtmlSanitizerPolicyContext,goog.html.sanitizer.HtmlSanitizerPolicy,goog.html.sanitizer.HtmlSanitizerUrlPolicy,goog.html.sanitizer.HtmlSanitizerAttributePolicy,goog.html.sanitizer.HTML_SANITIZER_BOOKKEEPING_PREFIX_="data-sanitizer-",goog.html.sanitizer.HTML_SANITIZER_SANITIZED_ATTR_NAME_=goog.html.sanitizer.HTML_SANITIZER_BOOKKEEPING_PREFIX_+"original-tag",goog.html.sanitizer.HTML_SANITIZER_INVALID_CUSTOM_TAGS_={"ANNOTATION-XML":!0,"COLOR-PROFILE":!0,"FONT-FACE":!0,"FONT-FACE-SRC":!0,"FONT-FACE-URI":!0,"FONT-FACE-FORMAT":!0,"FONT-FACE-NAME":!0,"MISSING-GLYPH":!0},goog.html.sanitizer.RANDOM_CONTAINER_="*",goog.html.sanitizer.HtmlSanitizer=function(t){goog.html.sanitizer.SafeDomTreeProcessor.call(this);var i=t||new goog.html.sanitizer.HtmlSanitizer.Builder;i.installPolicies_(),this.attributeHandlers_=goog.object.clone(i.attributeWhitelist_),this.tagBlacklist_=goog.object.clone(i.tagBlacklist_),this.tagWhitelist_=goog.object.clone(i.tagWhitelist_),this.shouldAddOriginalTagNames_=i.shouldAddOriginalTagNames_,goog.array.forEach(i.dataAttributeWhitelist_,function(t){if(!goog.string.startsWith(t,"data-"))throw new goog.asserts.AssertionError('Only "data-" attributes allowed, got: %s.',[t]);if(goog.string.startsWith(t,goog.html.sanitizer.HTML_SANITIZER_BOOKKEEPING_PREFIX_))throw new goog.asserts.AssertionError('Attributes with "%s" prefix are not allowed, got: %s.',[goog.html.sanitizer.HTML_SANITIZER_BOOKKEEPING_PREFIX_,t]);this.attributeHandlers_["* "+t.toUpperCase()]=goog.html.sanitizer.HtmlSanitizer.cleanUpAttribute_},this),goog.array.forEach(i.customElementTagWhitelist_,function(t){if(t=t.toUpperCase(),!goog.string.contains(t,"-")||goog.html.sanitizer.HTML_SANITIZER_INVALID_CUSTOM_TAGS_[t])throw new goog.asserts.AssertionError("Only valid custom element tag names allowed, got: %s.",[t]);this.tagWhitelist_[t]=!0},this),this.networkRequestUrlPolicy_=i.networkRequestUrlPolicy_,this.styleContainerId_=i.styleContainerId_,this.currentStyleContainerId_=null,this.inlineStyleRules_=i.inlineStyleRules_},goog.inherits(goog.html.sanitizer.HtmlSanitizer,goog.html.sanitizer.SafeDomTreeProcessor),goog.html.sanitizer.HtmlSanitizer.wrapUrlPolicy_=function(t){return function(i,e){var o=goog.html.sanitizer.HtmlSanitizer.cleanUpAttribute_(i),r=t(o,e);return r&&goog.html.SafeUrl.unwrap(r)!=goog.html.SafeUrl.INNOCUOUS_STRING?goog.html.SafeUrl.unwrap(r):null}},goog.html.sanitizer.HtmlSanitizer.Builder=function(){this.attributeWhitelist_={},goog.array.forEach([goog.html.sanitizer.AttributeWhitelist,goog.html.sanitizer.AttributeSanitizedWhitelist],function(t){goog.array.forEach(goog.object.getKeys(t),function(t){this.attributeWhitelist_[t]=goog.html.sanitizer.HtmlSanitizer.cleanUpAttribute_},this)},this),this.attributeOverrideList_={},this.dataAttributeWhitelist_=[],this.customElementTagWhitelist_=[],this.tagBlacklist_=goog.object.clone(goog.html.sanitizer.TagBlacklist),this.tagWhitelist_=goog.object.clone(goog.html.sanitizer.TagWhitelist),this.shouldAddOriginalTagNames_=!1,this.urlPolicy_=goog.html.sanitizer.HtmlSanitizer.defaultUrlPolicy_,this.networkRequestUrlPolicy_=goog.html.sanitizer.HtmlSanitizer.defaultNetworkRequestUrlPolicy_,this.namePolicy_=goog.html.sanitizer.HtmlSanitizer.defaultNamePolicy_,this.tokenPolicy_=goog.html.sanitizer.HtmlSanitizer.defaultTokenPolicy_,this.sanitizeInlineCssPolicy_=goog.functions.NULL,this.styleContainerId_=null,this.inlineStyleRules_=!1,this.policiesInstalled_=!1},goog.html.sanitizer.HtmlSanitizer.Builder.prototype.allowDataAttributes=function(t){return goog.array.extend(this.dataAttributeWhitelist_,t),this},goog.html.sanitizer.HtmlSanitizer.Builder.prototype.allowCustomElementTags=function(t){return goog.array.extend(this.customElementTagWhitelist_,t),this},goog.html.sanitizer.HtmlSanitizer.Builder.prototype.allowFormTag=function(){return delete this.tagBlacklist_.FORM,this},goog.html.sanitizer.HtmlSanitizer.Builder.prototype.allowStyleTag=function(){if(this.inlineStyleRules_)throw new Error("Rules from STYLE tags are already being inlined.");return delete this.tagBlacklist_.STYLE,this.styleContainerId_=goog.html.sanitizer.RANDOM_CONTAINER_,this},goog.html.sanitizer.HtmlSanitizer.Builder.prototype.withStyleContainer=function(t){if("STYLE"in this.tagBlacklist_)throw new Error("STYLE tags must first be allowed through allowStyleTag.");if(null!=t){if(!/^[a-zA-Z][\w-:\.]*$/.test(t))throw new Error("Invalid ID.");this.styleContainerId_=t}else this.styleContainerId_=null;return this},goog.html.sanitizer.HtmlSanitizer.Builder.prototype.inlineStyleRules=function(){if(this.sanitizeInlineCssPolicy_==goog.functions.NULL)throw new Error("Inlining style rules requires allowing STYLE attributes first.");if(!("STYLE"in this.tagBlacklist_))throw new Error("You have already configured the builder to allow STYLE tags in the output. Inlining style rules would prevent STYLE tags from appearing in the output and conflict with such directive.");return this.inlineStyleRules_=!0,this},goog.html.sanitizer.HtmlSanitizer.Builder.prototype.allowCssStyles=function(){return this.sanitizeInlineCssPolicy_=goog.html.sanitizer.HtmlSanitizer.sanitizeCssDeclarationList_,this},goog.html.sanitizer.HtmlSanitizer.Builder.prototype.alsoAllowTagsPrivateDoNotAccessOrElse=function(t){return goog.array.forEach(t,function(t){this.tagWhitelist_[t.toUpperCase()]=!0,delete this.tagBlacklist_[t.toUpperCase()]},this),this},goog.html.sanitizer.HtmlSanitizer.Builder.prototype.alsoAllowAttributesPrivateDoNotAccessOrElse=function(t){return goog.array.forEach(t,function(t){"string"==typeof t&&(t={tagName:"*",attributeName:t,policy:null});var i=goog.html.sanitizer.HtmlSanitizer.attrIdentifier_(t.tagName,t.attributeName);this.attributeWhitelist_[i]=t.policy?t.policy:goog.html.sanitizer.HtmlSanitizer.cleanUpAttribute_,this.attributeOverrideList_[i]=!0},this),this},goog.html.sanitizer.HtmlSanitizer.Builder.prototype.onlyAllowTags=function(t){return this.tagWhitelist_={SPAN:!0},goog.array.forEach(t,function(t){if(t=t.toUpperCase(),!goog.html.sanitizer.TagWhitelist[t])throw new Error("Only whitelisted tags can be allowed. See goog.html.sanitizer.TagWhitelist.");this.tagWhitelist_[t]=!0},this),this},goog.html.sanitizer.HtmlSanitizer.Builder.prototype.onlyAllowAttributes=function(t){var i=this.attributeWhitelist_;return this.attributeWhitelist_={},goog.array.forEach(t,function(t){"string"===goog.typeOf(t)&&(t={tagName:"*",attributeName:t.toUpperCase(),policy:null});var e=goog.html.sanitizer.HtmlSanitizer.attrIdentifier_(t.tagName,t.attributeName);if(!i[e])throw new Error("Only whitelisted attributes can be allowed.");this.attributeWhitelist_[e]=t.policy?t.policy:goog.html.sanitizer.HtmlSanitizer.cleanUpAttribute_},this),this},goog.html.sanitizer.HtmlSanitizer.Builder.prototype.addOriginalTagNames=function(){return this.shouldAddOriginalTagNames_=!0,this},goog.html.sanitizer.HtmlSanitizer.Builder.prototype.withCustomNetworkRequestUrlPolicy=function(t){return this.networkRequestUrlPolicy_=t,this},goog.html.sanitizer.HtmlSanitizer.Builder.prototype.withCustomUrlPolicy=function(t){return this.urlPolicy_=t,this},goog.html.sanitizer.HtmlSanitizer.Builder.prototype.withCustomNamePolicy=function(t){return this.namePolicy_=t,this},goog.html.sanitizer.HtmlSanitizer.Builder.prototype.withCustomTokenPolicy=function(t){return this.tokenPolicy_=t,this},goog.html.sanitizer.HtmlSanitizer.wrapPolicy_=function(t,i){return function(e,o,r,n){var l=t(e,o,r,n);return null==l?null:i(l,o,r,n)}},goog.html.sanitizer.HtmlSanitizer.installDefaultPolicy_=function(t,i,e,o){t[e]&&!i[e]&&(t[e]=goog.html.sanitizer.HtmlSanitizer.wrapPolicy_(t[e],o))},goog.html.sanitizer.HtmlSanitizer.Builder.prototype.build=function(){return new goog.html.sanitizer.HtmlSanitizer(this)},goog.html.sanitizer.HtmlSanitizer.Builder.prototype.installPolicies_=function(){if(this.policiesInstalled_)throw new Error("HtmlSanitizer.Builder.build() can only be used once.");var t=goog.html.sanitizer.HtmlSanitizer.installDefaultPolicy_;t(this.attributeWhitelist_,this.attributeOverrideList_,"* USEMAP",goog.html.sanitizer.HtmlSanitizer.sanitizeUrlFragment_);var i=goog.html.sanitizer.HtmlSanitizer.wrapUrlPolicy_(this.urlPolicy_);goog.array.forEach(["* ACTION","* CITE","* HREF"],function(e){t(this.attributeWhitelist_,this.attributeOverrideList_,e,i)},this);var e=goog.html.sanitizer.HtmlSanitizer.wrapUrlPolicy_(this.networkRequestUrlPolicy_);goog.array.forEach(["* LONGDESC","* SRC","LINK HREF"],function(i){t(this.attributeWhitelist_,this.attributeOverrideList_,i,e)},this);goog.array.forEach(["* FOR","* HEADERS","* NAME"],function(i){t(this.attributeWhitelist_,this.attributeOverrideList_,i,goog.partial(goog.html.sanitizer.HtmlSanitizer.sanitizeName_,this.namePolicy_))},this),t(this.attributeWhitelist_,this.attributeOverrideList_,"A TARGET",goog.partial(goog.html.sanitizer.HtmlSanitizer.allowedAttributeValues_,["_blank","_self"])),t(this.attributeWhitelist_,this.attributeOverrideList_,"* CLASS",goog.partial(goog.html.sanitizer.HtmlSanitizer.sanitizeClasses_,this.tokenPolicy_)),t(this.attributeWhitelist_,this.attributeOverrideList_,"* ID",goog.partial(goog.html.sanitizer.HtmlSanitizer.sanitizeId_,this.tokenPolicy_)),t(this.attributeWhitelist_,this.attributeOverrideList_,"* STYLE",goog.partial(this.sanitizeInlineCssPolicy_,e)),this.policiesInstalled_=!0},goog.html.sanitizer.HtmlSanitizer.defaultUrlPolicy_=goog.html.SafeUrl.sanitize,goog.html.sanitizer.HtmlSanitizer.defaultNetworkRequestUrlPolicy_=goog.functions.NULL,goog.html.sanitizer.HtmlSanitizer.defaultNamePolicy_=goog.functions.NULL,goog.html.sanitizer.HtmlSanitizer.defaultTokenPolicy_=goog.functions.NULL,goog.html.sanitizer.HtmlSanitizer.attrIdentifier_=function(t,i){return t||(t="*"),(t+" "+i).toUpperCase()},goog.html.sanitizer.HtmlSanitizer.sanitizeCssDeclarationList_=function(t,i,e,o){if(!o.cssStyle)return null;var r=goog.html.SafeStyle.unwrap(goog.html.sanitizer.CssSanitizer.sanitizeInlineStyle(o.cssStyle,function(i,o){e.cssProperty=o;var r=t(i,e);return null==r?null:goog.html.uncheckedconversions.safeUrlFromStringKnownToSatisfyTypeContract(goog.string.Const.from("HtmlSanitizerPolicy created with networkRequestUrlPolicy_ when installing '* STYLE' handler."),r)}));return""==r?null:r},goog.html.sanitizer.HtmlSanitizer.cleanUpAttribute_=function(t){return goog.string.trim(t)},goog.html.sanitizer.HtmlSanitizer.allowedAttributeValues_=function(t,i,e){var o=goog.string.trim(i);return goog.array.contains(t,o.toLowerCase())?o:null},goog.html.sanitizer.HtmlSanitizer.sanitizeUrlFragment_=function(t,i){var e=goog.string.trim(t);return e&&"#"==e.charAt(0)?e:null},goog.html.sanitizer.HtmlSanitizer.sanitizeName_=function(t,i,e){return t(goog.string.trim(i),e)},goog.html.sanitizer.HtmlSanitizer.sanitizeClasses_=function(t,i,e){for(var o=i.split(/(?:\s+)/),r=[],n=0;n<o.length;n++){var l=t(o[n],e);l&&r.push(l)}return 0==r.length?null:r.join(" ")},goog.html.sanitizer.HtmlSanitizer.sanitizeId_=function(t,i,e){return t(goog.string.trim(i),e)},goog.html.sanitizer.HtmlSanitizer.getContext_=function(t,i){var e={cssStyle:void 0};return"style"==t&&(e.cssStyle=goog.html.sanitizer.noclobber.getElementStyle(i)),e},goog.html.sanitizer.HtmlSanitizer.prototype.sanitize=function(t){this.currentStyleContainerId_=this.getStyleContainerId_();var i=this.processToString(t);return goog.html.uncheckedconversions.safeHtmlFromStringKnownToSatisfyTypeContract(goog.string.Const.from("Output of HTML sanitizer"),i)},goog.html.sanitizer.HtmlSanitizer.prototype.sanitizeToDomNode=function(t){return this.currentStyleContainerId_=this.getStyleContainerId_(),goog.html.sanitizer.SafeDomTreeProcessor.prototype.processToTree.call(this,t)},goog.html.sanitizer.HtmlSanitizer.prototype.processRoot=function(t){this.currentStyleContainerId_&&this.styleContainerId_==goog.html.sanitizer.RANDOM_CONTAINER_&&(t.id=this.currentStyleContainerId_)},goog.html.sanitizer.HtmlSanitizer.prototype.preProcessHtml=function(t){if(!this.inlineStyleRules_)return t;var i=goog.html.sanitizer.CssSanitizer.safeParseHtmlAndGetInertElement("<div>"+t+"</div>");return goog.asserts.assert(i,"Older browsers that don't support inert parsing should not get to this branch"),goog.html.sanitizer.CssSanitizer.inlineStyleRules(i),i.innerHTML},goog.html.sanitizer.HtmlSanitizer.prototype.getStyleContainerId_=function(){var t=this.styleContainerId_==goog.html.sanitizer.RANDOM_CONTAINER_,i=!("STYLE"in this.tagBlacklist_)&&"STYLE"in this.tagWhitelist_;return t&&i?"sanitizer-"+goog.string.getRandomString():this.styleContainerId_},goog.html.sanitizer.HtmlSanitizer.prototype.createTextNode=function(t){var i=t.data,e=goog.html.sanitizer.noclobber.getParentNode(t);return e&&"style"==goog.html.sanitizer.noclobber.getNodeName(e).toLowerCase()&&!("STYLE"in this.tagBlacklist_)&&"STYLE"in this.tagWhitelist_&&(i=goog.html.SafeStyleSheet.unwrap(goog.html.sanitizer.CssSanitizer.sanitizeStyleSheetString(i,this.currentStyleContainerId_,goog.bind(function(t,i){return this.networkRequestUrlPolicy_(t,{cssProperty:i})},this)))),document.createTextNode(i)},goog.html.sanitizer.HtmlSanitizer.prototype.createElementWithoutAttributes=function(t){var i=goog.html.sanitizer.noclobber.getNodeName(t).toUpperCase();if(i in this.tagBlacklist_)return null;if(this.tagWhitelist_[i])return document.createElement(i);var e=goog.dom.createElement(goog.dom.TagName.SPAN);return this.shouldAddOriginalTagNames_&&goog.html.sanitizer.noclobber.setElementAttribute(e,goog.html.sanitizer.HTML_SANITIZER_SANITIZED_ATTR_NAME_,i.toLowerCase()),e},goog.html.sanitizer.HtmlSanitizer.prototype.processElementAttribute=function(t,i){var e=i.name;if(goog.string.startsWith(e,goog.html.sanitizer.HTML_SANITIZER_BOOKKEEPING_PREFIX_))return null;var o=goog.html.sanitizer.noclobber.getNodeName(t),r=i.value,n={tagName:goog.string.trim(o).toLowerCase(),attributeName:goog.string.trim(e).toLowerCase()},l=goog.html.sanitizer.HtmlSanitizer.getContext_(n.attributeName,t),a=goog.html.sanitizer.HtmlSanitizer.attrIdentifier_(o,e);if(a in this.attributeHandlers_)return(0,this.attributeHandlers_[a])(r,n,l);var s=goog.html.sanitizer.HtmlSanitizer.attrIdentifier_(null,e);return s in this.attributeHandlers_?(0,this.attributeHandlers_[s])(r,n,l):null},goog.html.sanitizer.HtmlSanitizer.sanitize=function(t){return(new goog.html.sanitizer.HtmlSanitizer.Builder).build().sanitize(t)};