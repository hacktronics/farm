goog.provide("goog.messaging.PortChannel"),goog.require("goog.Timer"),goog.require("goog.array"),goog.require("goog.async.Deferred"),goog.require("goog.debug"),goog.require("goog.events"),goog.require("goog.events.EventType"),goog.require("goog.json"),goog.require("goog.log"),goog.require("goog.messaging.AbstractChannel"),goog.require("goog.messaging.DeferredChannel"),goog.require("goog.object"),goog.require("goog.string"),goog.require("goog.userAgent"),goog.messaging.PortChannel=function(o){goog.messaging.PortChannel.base(this,"constructor"),this.port_=o,this.listenerKey_=goog.events.listen(this.port_,goog.events.EventType.MESSAGE,this.deliver_,!1,this)},goog.inherits(goog.messaging.PortChannel,goog.messaging.AbstractChannel),goog.messaging.PortChannel.forEmbeddedWindow=function(o,e,g){if("*"==e)return new goog.messaging.DeferredChannel(goog.async.Deferred.fail(new Error("Invalid origin")));var t=g||new goog.Timer(50),n=goog.partial(goog.dispose,t),r=new goog.async.Deferred(n);return r.addBoth(n),t.start(),goog.events.listen(t,goog.Timer.TICK,function(){var g=new MessageChannel,n=function(o){g.port1.removeEventListener(goog.events.EventType.MESSAGE,n,!0),t.isDisposed()||r.callback(new goog.messaging.PortChannel(g.port1))};g.port1.start(),g.port1.addEventListener(goog.events.EventType.MESSAGE,n,!0);var s={};s[goog.messaging.PortChannel.FLAG]=!0,o.postMessage(s,e,[g.port2])}),new goog.messaging.DeferredChannel(r)},goog.messaging.PortChannel.forGlobalWindow=function(o){if("*"==o)return new goog.messaging.DeferredChannel(goog.async.Deferred.fail(new Error("Invalid origin")));var e=new goog.async.Deferred,g=goog.events.listen(window,goog.events.EventType.MESSAGE,function(t){var n=t.getBrowserEvent(),r=n.data;if(goog.isObject(r)&&r[goog.messaging.PortChannel.FLAG]&&window.parent==n.source&&o==n.origin){var s=n.ports[0];s.postMessage({}),s.start(),e.callback(new goog.messaging.PortChannel(s)),goog.events.unlistenByKey(g)}});return new goog.messaging.DeferredChannel(e)},goog.messaging.PortChannel.FLAG="--goog.messaging.PortChannel",goog.messaging.PortChannel.REQUIRES_SERIALIZATION_=goog.userAgent.WEBKIT&&goog.string.compareVersions(goog.userAgent.VERSION,"533")<0,goog.messaging.PortChannel.prototype.logger=goog.log.getLogger("goog.messaging.PortChannel"),goog.messaging.PortChannel.prototype.send=function(o,e){var g=[],t={serviceName:o,payload:e=this.extractPorts_(g,e)};t[goog.messaging.PortChannel.FLAG]=!0,goog.messaging.PortChannel.REQUIRES_SERIALIZATION_&&(t=goog.json.serialize(t)),this.port_.postMessage(t,g)},goog.messaging.PortChannel.prototype.deliver_=function(o){var e=o.getBrowserEvent(),g=e.data;if(goog.messaging.PortChannel.REQUIRES_SERIALIZATION_)try{g=JSON.parse(g)}catch(o){return}if(goog.isObject(g)&&g[goog.messaging.PortChannel.FLAG]&&this.validateMessage_(g)){var t=g.serviceName,n=g.payload,r=this.getService(t,n);if(!r)return;null!=(n=this.decodePayload(t,this.injectPorts_(e.ports||[],n),r.objectPayload))&&r.callback(n)}},goog.messaging.PortChannel.prototype.validateMessage_=function(o){return"serviceName"in o?"payload"in o||(goog.log.warning(this.logger,"Message object doesn't contain payload: "+goog.debug.deepExpose(o)),!1):(goog.log.warning(this.logger,"Message object doesn't contain service name: "+goog.debug.deepExpose(o)),!1)},goog.messaging.PortChannel.prototype.extractPorts_=function(o,e){return e&&"[object MessagePort]"==Object.prototype.toString.call(e)?(o.push(e),{_port:{type:"real",index:o.length-1}}):goog.isArray(e)?goog.array.map(e,goog.bind(this.extractPorts_,this,o)):e&&e.constructor==Object?goog.object.map(e,function(e,g){return e=this.extractPorts_(o,e),"_port"==g?{type:"escaped",val:e}:e},this):e},goog.messaging.PortChannel.prototype.injectPorts_=function(o,e){return goog.isArray(e)?goog.array.map(e,goog.bind(this.injectPorts_,this,o)):e&&e.constructor==Object?e._port&&"real"==e._port.type?o[e._port.index]:goog.object.map(e,function(e,g){return this.injectPorts_(o,"_port"==g?e.val:e)},this):e},goog.messaging.PortChannel.prototype.disposeInternal=function(){goog.events.unlistenByKey(this.listenerKey_),"[object MessagePort]"==Object.prototype.toString.call(this.port_)?this.port_.close():"[object Worker]"==Object.prototype.toString.call(this.port_)&&this.port_.terminate(),delete this.port_,goog.messaging.PortChannel.base(this,"disposeInternal")};