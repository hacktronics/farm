goog.provide("goog.messaging.BufferedChannel"),goog.require("goog.Disposable"),goog.require("goog.Timer"),goog.require("goog.events"),goog.require("goog.log"),goog.require("goog.messaging.MessageChannel"),goog.require("goog.messaging.MultiChannel"),goog.messaging.BufferedChannel=function(e,g){goog.Disposable.call(this),this.buffer_=[],this.multiChannel_=new goog.messaging.MultiChannel(e),this.userChannel_=this.multiChannel_.createVirtualChannel(goog.messaging.BufferedChannel.USER_CHANNEL_NAME_),this.controlChannel_=this.multiChannel_.createVirtualChannel(goog.messaging.BufferedChannel.CONTROL_CHANNEL_NAME_),this.timer_=new goog.Timer(g||goog.messaging.BufferedChannel.DEFAULT_INTERVAL_MILLIS_),this.timer_.start(),goog.events.listen(this.timer_,goog.Timer.TICK,this.sendReadyPing_,!1,this),this.controlChannel_.registerService(goog.messaging.BufferedChannel.PEER_READY_SERVICE_NAME_,goog.bind(this.setPeerReady_,this))},goog.inherits(goog.messaging.BufferedChannel,goog.Disposable),goog.messaging.BufferedChannel.DEFAULT_INTERVAL_MILLIS_=50,goog.messaging.BufferedChannel.PEER_READY_SERVICE_NAME_="setPeerReady_",goog.messaging.BufferedChannel.USER_CHANNEL_NAME_="user",goog.messaging.BufferedChannel.CONTROL_CHANNEL_NAME_="control",goog.messaging.BufferedChannel.prototype.connect=function(e){e&&e()},goog.messaging.BufferedChannel.prototype.isConnected=function(){return!0},goog.messaging.BufferedChannel.prototype.isPeerReady=function(){return this.peerReady_},goog.messaging.BufferedChannel.prototype.logger_=goog.log.getLogger("goog.messaging.bufferedchannel"),goog.messaging.BufferedChannel.prototype.sendReadyPing_=function(){try{this.controlChannel_.send(goog.messaging.BufferedChannel.PEER_READY_SERVICE_NAME_,this.isPeerReady()?"1":"")}catch(e){throw this.timer_.stop(),e}},goog.messaging.BufferedChannel.prototype.peerReady_,goog.messaging.BufferedChannel.prototype.registerService=function(e,g,n){this.userChannel_.registerService(e,g,n)},goog.messaging.BufferedChannel.prototype.registerDefaultService=function(e){this.userChannel_.registerDefaultService(e)},goog.messaging.BufferedChannel.prototype.send=function(e,g){this.isPeerReady()?this.userChannel_.send(e,g):(goog.log.fine(goog.messaging.BufferedChannel.prototype.logger_,"buffering message "+e),this.buffer_.push({serviceName:e,payload:g}))},goog.messaging.BufferedChannel.prototype.setPeerReady_=function(e){if(e?this.timer_.stop():this.timer_.start(),!this.peerReady_){this.peerReady_=!0,this.sendReadyPing_();for(var g=0;g<this.buffer_.length;g++){var n=this.buffer_[g];goog.log.fine(goog.messaging.BufferedChannel.prototype.logger_,"sending buffered message "+n.serviceName),this.userChannel_.send(n.serviceName,n.payload)}this.buffer_=null}},goog.messaging.BufferedChannel.prototype.disposeInternal=function(){goog.dispose(this.multiChannel_),goog.dispose(this.timer_),goog.messaging.BufferedChannel.base(this,"disposeInternal")};