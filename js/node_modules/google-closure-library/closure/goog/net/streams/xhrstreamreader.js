goog.provide("goog.net.streams.XhrStreamReader"),goog.require("goog.events.EventHandler"),goog.require("goog.log"),goog.require("goog.net.ErrorCode"),goog.require("goog.net.EventType"),goog.require("goog.net.HttpStatus"),goog.require("goog.net.XhrIo"),goog.require("goog.net.XmlHttp"),goog.require("goog.net.streams.Base64PbStreamParser"),goog.require("goog.net.streams.JsonStreamParser"),goog.require("goog.net.streams.PbJsonStreamParser"),goog.require("goog.net.streams.PbStreamParser"),goog.require("goog.string"),goog.require("goog.userAgent"),goog.scope(function(){var t=goog.module.get("goog.net.streams.Base64PbStreamParser"),e=goog.module.get("goog.net.streams.PbJsonStreamParser");goog.net.streams.XhrStreamReader=function(t){this.logger_=goog.log.getLogger("goog.net.streams.XhrStreamReader"),this.xhr_=t,this.parser_=null,this.pos_=0,this.status_=goog.net.streams.XhrStreamReader.Status.INIT,this.statusHandler_=null,this.dataHandler_=null,this.eventHandler_=new goog.events.EventHandler(this),this.eventHandler_.listen(this.xhr_,goog.net.EventType.READY_STATE_CHANGE,this.readyStateChangeHandler_)},goog.net.streams.XhrStreamReader.Status={INIT:0,ACTIVE:1,SUCCESS:2,XHR_ERROR:3,NO_DATA:4,BAD_DATA:5,HANDLER_EXCEPTION:6,TIMEOUT:7,CANCELLED:8},goog.net.streams.XhrStreamReader.isStreamingSupported=function(){return!(goog.userAgent.IE&&!goog.userAgent.isDocumentModeOrHigher(10))&&(!(goog.userAgent.WEBKIT&&!goog.userAgent.isVersionOrHigher("420+"))&&!(goog.userAgent.OPERA&&!goog.userAgent.WEBKIT))},goog.net.streams.XhrStreamReader.prototype.getParserByResponseHeader_=function(){var r=this.xhr_.getStreamingResponseHeader(goog.net.XhrIo.CONTENT_TYPE_HEADER);if(!r)return goog.log.warning(this.logger_,"Content-Type unavailable: "+r),null;if(r=r.toLowerCase(),goog.string.startsWith(r,"application/json"))return goog.string.startsWith(r,"application/json+protobuf")?new e:new goog.net.streams.JsonStreamParser;if(goog.string.startsWith(r,"application/x-protobuf")){var o=this.xhr_.getStreamingResponseHeader(goog.net.XhrIo.CONTENT_TRANSFER_ENCODING);return o?"base64"==o.toLowerCase()?new t:(goog.log.warning(this.logger_,"Unsupported Content-Transfer-Encoding: "+o+"\nFor Content-Type: "+r),null):new goog.net.streams.PbStreamParser}return goog.log.warning(this.logger_,"Unsupported Content-Type: "+r),null},goog.net.streams.XhrStreamReader.prototype.getXhr=function(){return this.xhr_},goog.net.streams.XhrStreamReader.prototype.getStatus=function(){return this.status_},goog.net.streams.XhrStreamReader.prototype.setStatusHandler=function(t){this.statusHandler_=t},goog.net.streams.XhrStreamReader.prototype.setDataHandler=function(t){this.dataHandler_=t},goog.net.streams.XhrStreamReader.prototype.readyStateChangeHandler_=function(t){var e=t.target;try{e==this.xhr_?this.onReadyStateChanged_():goog.log.warning(this.logger_,"Called back with an unexpected xhr.")}catch(t){goog.log.error(this.logger_,"readyStateChangeHandler_ thrown exception "+t),this.updateStatus_(goog.net.streams.XhrStreamReader.Status.HANDLER_EXCEPTION),this.clear_()}},goog.net.streams.XhrStreamReader.prototype.onReadyStateChanged_=function(){var t=this.xhr_.getReadyState(),e=this.xhr_.getLastErrorCode(),r=this.xhr_.getStatus(),o=this.xhr_.getResponseText();if(!(t<goog.net.XmlHttp.ReadyState.INTERACTIVE||t==goog.net.XmlHttp.ReadyState.INTERACTIVE&&!o)){var a=r==goog.net.HttpStatus.OK||r==goog.net.HttpStatus.PARTIAL_CONTENT;if(t==goog.net.XmlHttp.ReadyState.COMPLETE&&(e==goog.net.ErrorCode.TIMEOUT?this.updateStatus_(goog.net.streams.XhrStreamReader.Status.TIMEOUT):e==goog.net.ErrorCode.ABORT?this.updateStatus_(goog.net.streams.XhrStreamReader.Status.CANCELLED):a||this.updateStatus_(goog.net.streams.XhrStreamReader.Status.XHR_ERROR)),a&&!o&&goog.log.warning(this.logger_,"No response text for xhr "+this.xhr_.getLastUri()+" status "+r),this.parser_||(this.parser_=this.getParserByResponseHeader_(),null==this.parser_&&this.updateStatus_(goog.net.streams.XhrStreamReader.Status.BAD_DATA)),this.status_>goog.net.streams.XhrStreamReader.Status.SUCCESS)this.clear_();else{if(o.length>this.pos_){var s=o.substr(this.pos_);this.pos_=o.length;try{var g=this.parser_.parse(s);null!=g&&this.dataHandler_&&this.dataHandler_(g)}catch(t){return goog.log.error(this.logger_,"Invalid response "+t+"\n"+o),this.updateStatus_(goog.net.streams.XhrStreamReader.Status.BAD_DATA),void this.clear_()}}if(t==goog.net.XmlHttp.ReadyState.COMPLETE)return 0==o.length?this.updateStatus_(goog.net.streams.XhrStreamReader.Status.NO_DATA):this.updateStatus_(goog.net.streams.XhrStreamReader.Status.SUCCESS),void this.clear_();this.updateStatus_(goog.net.streams.XhrStreamReader.Status.ACTIVE)}}},goog.net.streams.XhrStreamReader.prototype.updateStatus_=function(t){this.status_!=t&&(this.status_=t,this.statusHandler_&&this.statusHandler_())},goog.net.streams.XhrStreamReader.prototype.clear_=function(){if(this.eventHandler_.removeAll(),this.xhr_){var t=this.xhr_;this.xhr_=null,t.abort(),t.dispose()}}});