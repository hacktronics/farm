goog.provide("goog.net.streams.JsonStreamParser"),goog.provide("goog.net.streams.JsonStreamParser.Options"),goog.require("goog.asserts"),goog.require("goog.net.streams.StreamParser"),goog.require("goog.net.streams.utils"),goog.scope(function(){var e=goog.module.get("goog.net.streams.utils");goog.net.streams.JsonStreamParser=function(e){this.errorMessage_=null,this.result_=[],this.buffer_="",this.stack_=[],this.depth_=0,this.pos_=0,this.slashed_=!1,this.unicodeCount_=0,this.stringInputPattern_=/[\\"]/g,this.streamState_=t.StreamState_.INIT,this.state_=t.State_.INIT,this.deliverMessageAsRawString_=!(!e||!e.deliverMessageAsRawString)},goog.net.streams.JsonStreamParser.Options;var t=goog.net.streams.JsonStreamParser;t.StreamState_={INIT:0,ARRAY_OPEN:1,ARRAY_END:2,INVALID:3},t.State_={INIT:0,VALUE:1,OBJECT_OPEN:2,OBJECT_END:3,ARRAY_OPEN:4,ARRAY_END:5,STRING:6,KEY_START:7,KEY_END:8,TRUE1:9,TRUE2:10,TRUE3:11,FALSE1:12,FALSE2:13,FALSE3:14,FALSE4:15,NULL1:16,NULL2:17,NULL3:18,NUM_DECIMAL_POINT:19,NUM_DIGIT:20},t.prototype.isInputValid=function(){return this.streamState_!=t.StreamState_.INVALID},t.prototype.getErrorMessage=function(){return this.errorMessage_},t.prototype.done=function(){return this.streamState_===t.StreamState_.ARRAY_END},t.prototype.getExtraInput=function(){return this.buffer_},t.prototype.error_=function(e,s){throw this.streamState_=t.StreamState_.INVALID,this.errorMessage_="The stream is broken @"+this.pos_+"/"+s+". With input:\n"+e,new Error(this.errorMessage_)},t.prototype.parse=function(s){goog.asserts.assertString(s);for(var r=this,n=r.stack_,a=r.stringInputPattern_,_=t.State_,o=s.length,i=0,u=-1,c=0;c<o;)switch(r.streamState_){case t.StreamState_.INVALID:return r.error_(s,c),null;case t.StreamState_.ARRAY_END:return f()&&r.error_(s,c),null;case t.StreamState_.INIT:if(f()){var E=s[c++];if(r.pos_++,"["===E){r.streamState_=t.StreamState_.ARRAY_OPEN,i=c,r.state_=_.ARRAY_OPEN;continue}r.error_(s,c)}return null;case t.StreamState_.ARRAY_OPEN:if(g(),0===r.depth_&&r.state_==_.ARRAY_END?(r.streamState_=t.StreamState_.ARRAY_END,r.buffer_=s.substring(c)):-1===u?r.buffer_+=s.substring(i):r.buffer_=s.substring(u),r.result_.length>0){var A=r.result_;return r.result_=[],A}return null}return null;function f(){return function(){for(;c<s.length&&e.isJsonWhitespace(s[c]);)c++,r.pos_++}(),c<o}function g(){for(var t;t=s[c++];)switch(r.pos_++,r.state_){case _.INIT:"{"===t?r.state_=_.OBJECT_OPEN:"["===t?r.state_=_.ARRAY_OPEN:e.isJsonWhitespace(t)||r.error_(s,c);continue;case _.KEY_START:case _.OBJECT_OPEN:if(e.isJsonWhitespace(t))continue;if(r.state_===_.KEY_START)n.push(_.KEY_END);else{if("}"===t){S("{}"),r.state_=N();continue}n.push(_.OBJECT_END)}'"'===t?r.state_=_.STRING:r.error_(s,c);continue;case _.KEY_END:case _.OBJECT_END:if(e.isJsonWhitespace(t))continue;":"===t?(r.state_===_.OBJECT_END&&(n.push(_.OBJECT_END),r.depth_++),r.state_=_.VALUE):"}"===t?(r.depth_--,S(),r.state_=N()):","===t?(r.state_===_.OBJECT_END&&n.push(_.OBJECT_END),r.state_=_.KEY_START):r.error_(s,c);continue;case _.ARRAY_OPEN:case _.VALUE:if(e.isJsonWhitespace(t))continue;if(r.state_===_.ARRAY_OPEN){if(r.depth_++,r.state_=_.VALUE,"]"===t){if(r.depth_--,0===r.depth_)return void(r.state_=_.ARRAY_END);S("[]"),r.state_=N();continue}n.push(_.ARRAY_END)}'"'===t?r.state_=_.STRING:"{"===t?r.state_=_.OBJECT_OPEN:"["===t?r.state_=_.ARRAY_OPEN:"t"===t?r.state_=_.TRUE1:"f"===t?r.state_=_.FALSE1:"n"===t?r.state_=_.NULL1:"-"===t||(-1!=="0123456789".indexOf(t)?r.state_=_.NUM_DIGIT:r.error_(s,c));continue;case _.ARRAY_END:if(","===t)n.push(_.ARRAY_END),r.state_=_.VALUE,1===r.depth_&&(u=c);else if("]"===t){if(r.depth_--,0===r.depth_)return;S(),r.state_=N()}else{if(e.isJsonWhitespace(t))continue;r.error_(s,c)}continue;case _.STRING:var o=c;e:for(;;){for(;r.unicodeCount_>0;)if(t=s[c++],4===r.unicodeCount_?r.unicodeCount_=0:r.unicodeCount_++,!t)break e;if('"'===t&&!r.slashed_){r.state_=N();break}if(!("\\"!==t||r.slashed_||(r.slashed_=!0,t=s[c++])))break;if(r.slashed_){if(r.slashed_=!1,"u"===t&&(r.unicodeCount_=1),t=s[c++])continue;break}a.lastIndex=c;var i=a.exec(s);if(!i){c=s.length+1;break}if(c=i.index+1,!(t=s[i.index]))break}r.pos_+=c-o;continue;case _.TRUE1:if(!t)continue;"r"===t?r.state_=_.TRUE2:r.error_(s,c);continue;case _.TRUE2:if(!t)continue;"u"===t?r.state_=_.TRUE3:r.error_(s,c);continue;case _.TRUE3:if(!t)continue;"e"===t?r.state_=N():r.error_(s,c);continue;case _.FALSE1:if(!t)continue;"a"===t?r.state_=_.FALSE2:r.error_(s,c);continue;case _.FALSE2:if(!t)continue;"l"===t?r.state_=_.FALSE3:r.error_(s,c);continue;case _.FALSE3:if(!t)continue;"s"===t?r.state_=_.FALSE4:r.error_(s,c);continue;case _.FALSE4:if(!t)continue;"e"===t?r.state_=N():r.error_(s,c);continue;case _.NULL1:if(!t)continue;"u"===t?r.state_=_.NULL2:r.error_(s,c);continue;case _.NULL2:if(!t)continue;"l"===t?r.state_=_.NULL3:r.error_(s,c);continue;case _.NULL3:if(!t)continue;"l"===t?r.state_=N():r.error_(s,c);continue;case _.NUM_DECIMAL_POINT:"."===t?r.state_=_.NUM_DIGIT:r.error_(s,c);continue;case _.NUM_DIGIT:if(-1!=="0123456789.eE+-".indexOf(t))continue;c--,r.pos_--,r.state_=N();continue;default:r.error_(s,c)}}function N(){var e=n.pop();return null!=e?e:_.VALUE}function S(e){r.depth_>1||(goog.asserts.assert(""!==e),e||(e=-1===u?r.buffer_+s.substring(i,c):s.substring(u,c)),r.deliverMessageAsRawString_?r.result_.push(e):r.result_.push(goog.asserts.assertInstanceof(JSON.parse(e),Object)),u=c)}}});