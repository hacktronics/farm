goog.provide("goog.net.streams.XhrNodeReadableStream"),goog.require("goog.array"),goog.require("goog.log"),goog.require("goog.net.streams.NodeReadableStream"),goog.require("goog.net.streams.XhrStreamReader"),goog.net.streams.XhrNodeReadableStream=function(e){this.logger_=goog.log.getLogger("goog.net.streams.XhrNodeReadableStream"),this.xhrReader_=e,this.xhrReader_.setDataHandler(goog.bind(this.onData_,this)),this.xhrReader_.setStatusHandler(goog.bind(this.onStatusChange_,this)),this.callbackMap_={},this.callbackOnceMap_={}},goog.net.streams.XhrNodeReadableStream.prototype.on=function(e,a){var t=this.callbackMap_[e];return t||(t=[],this.callbackMap_[e]=t),t.push(a),this},goog.net.streams.XhrNodeReadableStream.prototype.addListener=function(e,a){return this.on(e,a),this},goog.net.streams.XhrNodeReadableStream.prototype.removeListener=function(e,a){var t=this.callbackMap_[e];t&&goog.array.remove(t,a);var o=this.callbackOnceMap_[e];return o&&goog.array.remove(o,a),this},goog.net.streams.XhrNodeReadableStream.prototype.once=function(e,a){var t=this.callbackOnceMap_[e];return t||(t=[],this.callbackOnceMap_[e]=t),t.push(a),this},goog.net.streams.XhrNodeReadableStream.prototype.onData_=function(e){var a=this.callbackMap_[goog.net.streams.NodeReadableStream.EventType.DATA];a&&this.doMessages_(e,a);var t=this.callbackOnceMap_[goog.net.streams.NodeReadableStream.EventType.DATA];t&&this.doMessages_(e,t),this.callbackOnceMap_[goog.net.streams.NodeReadableStream.EventType.DATA]=[]},goog.net.streams.XhrNodeReadableStream.prototype.doMessages_=function(e,a){for(var t=this,o=0;o<e.length;o++){var r=e[o];goog.array.forEach(a,function(e){try{e(r)}catch(e){t.handleError_("message-callback exception (ignored) "+e)}})}},goog.net.streams.XhrNodeReadableStream.prototype.onStatusChange_=function(){var e=this.xhrReader_.getStatus(),a=goog.net.streams.XhrStreamReader.Status,t=goog.net.streams.NodeReadableStream.EventType;switch(e){case a.ACTIVE:this.doStatus_(t.READABLE);break;case a.BAD_DATA:case a.HANDLER_EXCEPTION:case a.NO_DATA:case a.TIMEOUT:case a.XHR_ERROR:this.doStatus_(t.ERROR);break;case a.CANCELLED:this.doStatus_(t.CLOSE);break;case a.SUCCESS:this.doStatus_(t.END)}},goog.net.streams.XhrNodeReadableStream.prototype.doStatus_=function(e){var a=this.callbackMap_[e],t=this;a&&goog.array.forEach(a,function(e){try{e()}catch(e){t.handleError_("status-callback exception (ignored) "+e)}});var o=this.callbackOnceMap_[e];o&&goog.array.forEach(o,function(e){e()}),this.callbackOnceMap_[e]=[]},goog.net.streams.XhrNodeReadableStream.prototype.handleError_=function(e){goog.log.error(this.logger_,e)};