goog.provide("goog.net.streams.PbStreamParser"),goog.require("goog.asserts"),goog.require("goog.net.streams.StreamParser"),goog.net.streams.PbStreamParser=function(){this.errorMessage_=null,this.result_=[],this.streamPos_=0,this.state_=goog.net.streams.PbStreamParser.State_.INIT,this.tag_=0,this.length_=0,this.countLengthBytes_=0,this.messageBuffer_=null,this.countMessageBytes_=0},goog.net.streams.PbStreamParser.State_={INIT:0,LENGTH:1,MESSAGE:2,INVALID:3},goog.net.streams.PbStreamParser.PADDING_TAG_=15,goog.net.streams.PbStreamParser.prototype.isInputValid=function(){return this.state_!=goog.net.streams.PbStreamParser.State_.INVALID},goog.net.streams.PbStreamParser.prototype.getErrorMessage=function(){return this.errorMessage_},goog.net.streams.PbStreamParser.prototype.error_=function(e,t,r){throw this.state_=goog.net.streams.PbStreamParser.State_.INVALID,this.errorMessage_="The stream is broken @"+this.streamPos_+"/"+t+". Error: "+r+". With input:\n"+e,new Error(this.errorMessage_)},goog.net.streams.PbStreamParser.prototype.parse=function(e){goog.asserts.assert(e instanceof Array||e instanceof ArrayBuffer);for(var t=this,r=e instanceof Array?e:new Uint8Array(e),s=0;s<r.length;){switch(t.state_){case goog.net.streams.PbStreamParser.State_.INVALID:t.error_(r,s,"stream already broken");break;case goog.net.streams.PbStreamParser.State_.INIT:o(r[s]);break;case goog.net.streams.PbStreamParser.State_.LENGTH:n(r[s]);break;case goog.net.streams.PbStreamParser.State_.MESSAGE:g(r[s]);break;default:throw new Error("unexpected parser state: "+t.state_)}t.streamPos_++,s++}var a=t.result_;return t.result_=[],a.length>0?a:null;function o(e){128&e&&t.error_(r,s,"invalid tag"),2!=(7&e)&&t.error_(r,s,"invalid wire type"),t.tag_=e>>>3,1!=t.tag_&&2!=t.tag_&&15!=t.tag_&&t.error_(r,s,"unexpected tag"),t.state_=goog.net.streams.PbStreamParser.State_.LENGTH,t.length_=0,t.countLengthBytes_=0}function n(e){t.countLengthBytes_++,5==t.countLengthBytes_&&240&e&&t.error_(r,s,"message length too long"),t.length_|=(127&e)<<7*(t.countLengthBytes_-1),128&e||(t.state_=goog.net.streams.PbStreamParser.State_.MESSAGE,t.countMessageBytes_=0,"undefined"!=typeof Uint8Array?t.messageBuffer_=new Uint8Array(t.length_):t.messageBuffer_=new Array(t.length_),0==t.length_&&_())}function g(e){t.messageBuffer_[t.countMessageBytes_++]=e,t.countMessageBytes_==t.length_&&_()}function _(){if(t.tag_<goog.net.streams.PbStreamParser.PADDING_TAG_){var e={};e[t.tag_]=t.messageBuffer_,t.result_.push(e)}t.state_=goog.net.streams.PbStreamParser.State_.INIT}};