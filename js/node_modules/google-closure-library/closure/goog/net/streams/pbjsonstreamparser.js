goog.module("goog.net.streams.PbJsonStreamParser");var JsonStreamParser=goog.require("goog.net.streams.JsonStreamParser"),StreamParser=goog.require("goog.net.streams.StreamParser"),asserts=goog.require("goog.asserts"),utils=goog.require("goog.net.streams.utils"),PbJsonStreamParser=function(){this.jsonStreamParser_=null,this.errorMessage_=null,this.streamPos_=0,this.state_=State.INIT,this.result_=[],this.statusParsed_=!1},State={INIT:0,ARRAY_OPEN:1,MESSAGES:2,MESSAGES_DONE:3,STATUS:4,ARRAY_END:5,INVALID:6};PbJsonStreamParser.prototype.isInputValid=function(){return null===this.errorMessage_},PbJsonStreamParser.prototype.getErrorMessage=function(){return this.errorMessage_},PbJsonStreamParser.prototype.parse=function(e){asserts.assertString(e);for(var t=this,r=0;r<e.length;){if(!o())return null;switch(t.state_){case State.INVALID:n("stream already broken");break;case State.INIT:"["===e[r]?(t.state_=State.ARRAY_OPEN,r++,t.streamPos_++):n("unexpected input token");break;case State.ARRAY_OPEN:"["===e[r]?(t.state_=State.MESSAGES,S()):","===e[r]||"null,"==e.substr(r,5)?t.state_=State.MESSAGES_DONE:"]"===e[r]?(t.state_=State.ARRAY_END,r++,t.streamPos_++):n("unexpected input token");break;case State.MESSAGES:if(_(t.jsonStreamParser_.parse(e.substring(r))),t.jsonStreamParser_.done()){t.state_=State.MESSAGES_DONE;var s=t.jsonStreamParser_.getExtraInput();t.streamPos_+=e.length-r-s.length,e=s,r=0}else t.streamPos_+=e.length-r,r=e.length;break;case State.MESSAGES_DONE:","===e[r]||"null,"==e.substr(r,5)?(t.state_=State.STATUS,S(),t.jsonStreamParser_.parse("["),r+=","===e[r]?1:5,t.streamPos_++):"]"===e[r]&&(t.state_=State.ARRAY_END,r++,t.streamPos_++);break;case State.STATUS:if(u(t.jsonStreamParser_.parse(e.substring(r))),t.jsonStreamParser_.done()){t.state_=State.ARRAY_END;s=t.jsonStreamParser_.getExtraInput();t.streamPos_+=e.length-r-s.length,e=s,r=0}else t.streamPos_+=e.length-r,r=e.length;break;case State.ARRAY_END:n("extra input after stream end")}}if(t.result_.length>0){var a=t.result_;return t.result_=[],a}return null;function n(e){throw t.state_=State.INVALID,t.errorMessage_="The stream is broken @"+t.streamPos_+"/"+r+". Error: "+e+". With input:\n",new Error(t.errorMessage_)}function o(){for(;r<e.length;){if(!utils.isJsonWhitespace(e[r]))return!0;r++,t.streamPos_++}return!1}function S(){t.jsonStreamParser_=new JsonStreamParser({allowCompactJsonArrayFormat:!0,deliverMessageAsRawString:!0})}function _(e){if(e)for(var r=0;r<e.length;r++){var s={};s[1]=e[r],t.result_.push(s)}}function u(e){if(e){(t.statusParsed_||e.length>1)&&n("extra status: "+e),t.statusParsed_=!0;var r={};r[2]=e[0],t.result_.push(r)}}},exports=PbJsonStreamParser;