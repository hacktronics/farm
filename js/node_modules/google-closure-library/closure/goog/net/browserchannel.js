goog.provide("goog.net.BrowserChannel"),goog.provide("goog.net.BrowserChannel.Error"),goog.provide("goog.net.BrowserChannel.Event"),goog.provide("goog.net.BrowserChannel.Handler"),goog.provide("goog.net.BrowserChannel.LogSaver"),goog.provide("goog.net.BrowserChannel.QueuedMap"),goog.provide("goog.net.BrowserChannel.ServerReachability"),goog.provide("goog.net.BrowserChannel.ServerReachabilityEvent"),goog.provide("goog.net.BrowserChannel.Stat"),goog.provide("goog.net.BrowserChannel.StatEvent"),goog.provide("goog.net.BrowserChannel.State"),goog.provide("goog.net.BrowserChannel.TimingEvent"),goog.require("goog.Uri"),goog.require("goog.array"),goog.require("goog.asserts"),goog.require("goog.debug.TextFormatter"),goog.require("goog.events.Event"),goog.require("goog.events.EventTarget"),goog.require("goog.json"),goog.require("goog.json.NativeJsonProcessor"),goog.require("goog.log"),goog.require("goog.net.BrowserTestChannel"),goog.require("goog.net.ChannelDebug"),goog.require("goog.net.ChannelRequest"),goog.require("goog.net.XhrIo"),goog.require("goog.net.tmpnetwork"),goog.require("goog.object"),goog.require("goog.string"),goog.require("goog.structs"),goog.require("goog.structs.CircularBuffer"),goog.net.BrowserChannel=function(e,n,t,o){this.clientVersion_=e||null,this.state_=goog.net.BrowserChannel.State.INIT,this.outgoingMaps_=[],this.pendingMaps_=[],this.channelDebug_=new goog.net.ChannelDebug,this.parser_=new goog.json.NativeJsonProcessor,this.firstTestResults_=n||null,this.secondTestResults_=null!=t?t:null,this.asyncTest_=o||!1},goog.net.BrowserChannel.QueuedMap=function(e,n,t){this.mapId=e,this.map=n,this.context=t||null},goog.net.BrowserChannel.prototype.extraHeaders_=null,goog.net.BrowserChannel.prototype.extraParams_=null,goog.net.BrowserChannel.prototype.forwardChannelRequest_=null,goog.net.BrowserChannel.prototype.backChannelRequest_=null,goog.net.BrowserChannel.prototype.path_=null,goog.net.BrowserChannel.prototype.forwardChannelUri_=null,goog.net.BrowserChannel.prototype.backChannelUri_=null,goog.net.BrowserChannel.prototype.hostPrefix_=null,goog.net.BrowserChannel.prototype.allowHostPrefix_=!0,goog.net.BrowserChannel.prototype.nextRid_=0,goog.net.BrowserChannel.prototype.nextMapId_=0,goog.net.BrowserChannel.prototype.failFast_=!1,goog.net.BrowserChannel.prototype.handler_=null,goog.net.BrowserChannel.prototype.forwardChannelTimerId_=null,goog.net.BrowserChannel.prototype.backChannelTimerId_=null,goog.net.BrowserChannel.prototype.deadBackChannelTimerId_=null,goog.net.BrowserChannel.prototype.connectionTest_=null,goog.net.BrowserChannel.prototype.useChunked_=null,goog.net.BrowserChannel.prototype.allowChunkedMode_=!0,goog.net.BrowserChannel.prototype.lastArrayId_=-1,goog.net.BrowserChannel.prototype.lastPostResponseArrayId_=-1,goog.net.BrowserChannel.prototype.lastStatusCode_=-1,goog.net.BrowserChannel.prototype.forwardChannelRetryCount_=0,goog.net.BrowserChannel.prototype.backChannelRetryCount_=0,goog.net.BrowserChannel.prototype.backChannelAttemptId_,goog.net.BrowserChannel.prototype.baseRetryDelayMs_=5e3,goog.net.BrowserChannel.prototype.retryDelaySeedMs_=1e4,goog.net.BrowserChannel.prototype.forwardChannelMaxRetries_=2,goog.net.BrowserChannel.prototype.forwardChannelRequestTimeoutMs_=2e4,goog.net.BrowserChannel.prototype.readyStateChangeThrottleMs_=0,goog.net.BrowserChannel.prototype.supportsCrossDomainXhrs_=!1,goog.net.BrowserChannel.LATEST_CHANNEL_VERSION=8,goog.net.BrowserChannel.prototype.channelVersion_=goog.net.BrowserChannel.LATEST_CHANNEL_VERSION,goog.net.BrowserChannel.State={CLOSED:0,INIT:1,OPENING:2,OPENED:3},goog.net.BrowserChannel.FORWARD_CHANNEL_RETRY_TIMEOUT=2e4,goog.net.BrowserChannel.BACK_CHANNEL_MAX_RETRIES=3,goog.net.BrowserChannel.RTT_ESTIMATE=3e3,goog.net.BrowserChannel.INACTIVE_CHANNEL_RETRY_FACTOR=2,goog.net.BrowserChannel.Error={OK:0,REQUEST_FAILED:2,LOGGED_OUT:4,NO_DATA:5,UNKNOWN_SESSION_ID:6,STOP:7,NETWORK:8,BLOCKED:9,BAD_DATA:10,BAD_RESPONSE:11,ACTIVE_X_BLOCKED:12},goog.net.BrowserChannel.ChannelType_={FORWARD_CHANNEL:1,BACK_CHANNEL:2},goog.net.BrowserChannel.MAX_MAPS_PER_REQUEST_=1e3,goog.net.BrowserChannel.statEventTarget_=new goog.events.EventTarget,goog.net.BrowserChannel.Event={},goog.net.BrowserChannel.Event.STAT_EVENT="statevent",goog.net.BrowserChannel.StatEvent=function(e,n){goog.events.Event.call(this,goog.net.BrowserChannel.Event.STAT_EVENT,e),this.stat=n},goog.inherits(goog.net.BrowserChannel.StatEvent,goog.events.Event),goog.net.BrowserChannel.Event.TIMING_EVENT="timingevent",goog.net.BrowserChannel.TimingEvent=function(e,n,t,o){goog.events.Event.call(this,goog.net.BrowserChannel.Event.TIMING_EVENT,e),this.size=n,this.rtt=t,this.retries=o},goog.inherits(goog.net.BrowserChannel.TimingEvent,goog.events.Event),goog.net.BrowserChannel.Event.SERVER_REACHABILITY_EVENT="serverreachability",goog.net.BrowserChannel.ServerReachability={REQUEST_MADE:1,REQUEST_SUCCEEDED:2,REQUEST_FAILED:3,BACK_CHANNEL_ACTIVITY:4},goog.net.BrowserChannel.ServerReachabilityEvent=function(e,n){goog.events.Event.call(this,goog.net.BrowserChannel.Event.SERVER_REACHABILITY_EVENT,e),this.reachabilityType=n},goog.inherits(goog.net.BrowserChannel.ServerReachabilityEvent,goog.events.Event),goog.net.BrowserChannel.Stat={CONNECT_ATTEMPT:0,ERROR_NETWORK:1,ERROR_OTHER:2,TEST_STAGE_ONE_START:3,CHANNEL_BLOCKED:4,TEST_STAGE_TWO_START:5,TEST_STAGE_TWO_DATA_ONE:6,TEST_STAGE_TWO_DATA_TWO:7,TEST_STAGE_TWO_DATA_BOTH:8,TEST_STAGE_ONE_FAILED:9,TEST_STAGE_TWO_FAILED:10,PROXY:11,NOPROXY:12,REQUEST_UNKNOWN_SESSION_ID:13,REQUEST_BAD_STATUS:14,REQUEST_INCOMPLETE_DATA:15,REQUEST_BAD_DATA:16,REQUEST_NO_DATA:17,REQUEST_TIMEOUT:18,BACKCHANNEL_MISSING:19,BACKCHANNEL_DEAD:20,BROWSER_OFFLINE:21,ACTIVE_X_BLOCKED:22},goog.net.BrowserChannel.OUTSTANDING_DATA_BACKCHANNEL_RETRY_CUTOFF=37500,goog.net.BrowserChannel.prototype.getChannelDebug=function(){return this.channelDebug_},goog.net.BrowserChannel.prototype.setChannelDebug=function(e){null!=e&&(this.channelDebug_=e)},goog.net.BrowserChannel.setStartThreadExecutionHook=function(e){goog.net.BrowserChannel.startExecutionHook_=e},goog.net.BrowserChannel.setEndThreadExecutionHook=function(e){goog.net.BrowserChannel.endExecutionHook_=e},goog.net.BrowserChannel.startExecutionHook_=function(){},goog.net.BrowserChannel.endExecutionHook_=function(){},goog.net.BrowserChannel.createChannelRequest=function(e,n,t,o,r){return new goog.net.ChannelRequest(e,n,t,o,r)},goog.net.BrowserChannel.prototype.connect=function(e,n,t,o,r){this.channelDebug_.debug("connect()"),goog.net.BrowserChannel.notifyStatEvent(goog.net.BrowserChannel.Stat.CONNECT_ATTEMPT),this.path_=n,this.extraParams_=t||{},o&&void 0!==r&&(this.extraParams_.OSID=o,this.extraParams_.OAID=r),this.asyncTest_?(goog.net.BrowserChannel.setTimeout(goog.bind(this.connectTest_,this,e),100),this.connectChannel_()):this.connectTest_(e)},goog.net.BrowserChannel.prototype.disconnect=function(){if(this.channelDebug_.debug("disconnect()"),this.cancelRequests_(),this.state_==goog.net.BrowserChannel.State.OPENED){var e=this.nextRid_++,n=this.forwardChannelUri_.clone();n.setParameterValue("SID",this.sid_),n.setParameterValue("RID",e),n.setParameterValue("TYPE","terminate"),this.addAdditionalParams_(n),goog.net.BrowserChannel.createChannelRequest(this,this.channelDebug_,this.sid_,e).sendUsingImgTag(n)}this.onClose_()},goog.net.BrowserChannel.prototype.getSessionId=function(){return this.sid_},goog.net.BrowserChannel.prototype.connectTest_=function(e){this.channelDebug_.debug("connectTest_()"),this.okToMakeRequest_()&&(this.connectionTest_=new goog.net.BrowserTestChannel(this,this.channelDebug_),this.connectionTest_.setExtraHeaders(this.extraHeaders_),this.connectionTest_.setParser(this.parser_),this.connectionTest_.connect(e))},goog.net.BrowserChannel.prototype.connectChannel_=function(){this.channelDebug_.debug("connectChannel_()"),this.ensureInState_(goog.net.BrowserChannel.State.INIT,goog.net.BrowserChannel.State.CLOSED),this.forwardChannelUri_=this.getForwardChannelUri(this.path_),this.ensureForwardChannel_()},goog.net.BrowserChannel.prototype.cancelRequests_=function(){this.connectionTest_&&(this.connectionTest_.abort(),this.connectionTest_=null),this.backChannelRequest_&&(this.backChannelRequest_.cancel(),this.backChannelRequest_=null),this.backChannelTimerId_&&(goog.global.clearTimeout(this.backChannelTimerId_),this.backChannelTimerId_=null),this.clearDeadBackchannelTimer_(),this.forwardChannelRequest_&&(this.forwardChannelRequest_.cancel(),this.forwardChannelRequest_=null),this.forwardChannelTimerId_&&(goog.global.clearTimeout(this.forwardChannelTimerId_),this.forwardChannelTimerId_=null)},goog.net.BrowserChannel.prototype.getExtraHeaders=function(){return this.extraHeaders_},goog.net.BrowserChannel.prototype.setExtraHeaders=function(e){this.extraHeaders_=e},goog.net.BrowserChannel.prototype.setReadyStateChangeThrottle=function(e){this.readyStateChangeThrottleMs_=e},goog.net.BrowserChannel.prototype.setSupportsCrossDomainXhrs=function(e){this.supportsCrossDomainXhrs_=e},goog.net.BrowserChannel.prototype.getHandler=function(){return this.handler_},goog.net.BrowserChannel.prototype.setHandler=function(e){this.handler_=e},goog.net.BrowserChannel.prototype.getAllowHostPrefix=function(){return this.allowHostPrefix_},goog.net.BrowserChannel.prototype.setAllowHostPrefix=function(e){this.allowHostPrefix_=e},goog.net.BrowserChannel.prototype.isBuffered=function(){return!this.useChunked_},goog.net.BrowserChannel.prototype.getAllowChunkedMode=function(){return this.allowChunkedMode_},goog.net.BrowserChannel.prototype.setAllowChunkedMode=function(e){this.allowChunkedMode_=e},goog.net.BrowserChannel.prototype.sendMap=function(e,n){if(this.state_==goog.net.BrowserChannel.State.CLOSED)throw new Error("Invalid operation: sending map when state is closed");this.outgoingMaps_.length==goog.net.BrowserChannel.MAX_MAPS_PER_REQUEST_&&this.channelDebug_.severe("Already have "+goog.net.BrowserChannel.MAX_MAPS_PER_REQUEST_+" queued maps upon queueing "+this.parser_.stringify(e)),this.outgoingMaps_.push(new goog.net.BrowserChannel.QueuedMap(this.nextMapId_++,e,n)),this.state_!=goog.net.BrowserChannel.State.OPENING&&this.state_!=goog.net.BrowserChannel.State.OPENED||this.ensureForwardChannel_()},goog.net.BrowserChannel.prototype.setFailFast=function(e){this.failFast_=e,this.channelDebug_.info("setFailFast: "+e),(this.forwardChannelRequest_||this.forwardChannelTimerId_)&&this.forwardChannelRetryCount_>this.getForwardChannelMaxRetries()&&(this.channelDebug_.info("Retry count "+this.forwardChannelRetryCount_+" > new maxRetries "+this.getForwardChannelMaxRetries()+". Fail immediately!"),this.forwardChannelRequest_?(this.forwardChannelRequest_.cancel(),this.onRequestComplete(this.forwardChannelRequest_)):(goog.global.clearTimeout(this.forwardChannelTimerId_),this.forwardChannelTimerId_=null,this.signalError_(goog.net.BrowserChannel.Error.REQUEST_FAILED)))},goog.net.BrowserChannel.prototype.getForwardChannelMaxRetries=function(){return this.failFast_?0:this.forwardChannelMaxRetries_},goog.net.BrowserChannel.prototype.setForwardChannelMaxRetries=function(e){this.forwardChannelMaxRetries_=e},goog.net.BrowserChannel.prototype.setForwardChannelRequestTimeout=function(e){this.forwardChannelRequestTimeoutMs_=e},goog.net.BrowserChannel.prototype.getBackChannelMaxRetries=function(){return goog.net.BrowserChannel.BACK_CHANNEL_MAX_RETRIES},goog.net.BrowserChannel.prototype.isClosed=function(){return this.state_==goog.net.BrowserChannel.State.CLOSED},goog.net.BrowserChannel.prototype.getState=function(){return this.state_},goog.net.BrowserChannel.prototype.getLastStatusCode=function(){return this.lastStatusCode_},goog.net.BrowserChannel.prototype.getLastArrayId=function(){return this.lastArrayId_},goog.net.BrowserChannel.prototype.hasOutstandingRequests=function(){return 0!=this.outstandingRequests_()},goog.net.BrowserChannel.prototype.setParser=function(e){this.parser_=e},goog.net.BrowserChannel.prototype.outstandingRequests_=function(){var e=0;return this.backChannelRequest_&&e++,this.forwardChannelRequest_&&e++,e},goog.net.BrowserChannel.prototype.ensureForwardChannel_=function(){this.forwardChannelRequest_||this.forwardChannelTimerId_||(this.forwardChannelTimerId_=goog.net.BrowserChannel.setTimeout(goog.bind(this.onStartForwardChannelTimer_,this),0),this.forwardChannelRetryCount_=0)},goog.net.BrowserChannel.prototype.maybeRetryForwardChannel_=function(e){return this.forwardChannelRequest_||this.forwardChannelTimerId_?(this.channelDebug_.severe("Request already in progress"),!1):!(this.state_==goog.net.BrowserChannel.State.INIT||this.forwardChannelRetryCount_>=this.getForwardChannelMaxRetries())&&(this.channelDebug_.debug("Going to retry POST"),this.forwardChannelTimerId_=goog.net.BrowserChannel.setTimeout(goog.bind(this.onStartForwardChannelTimer_,this,e),this.getRetryTime_(this.forwardChannelRetryCount_)),this.forwardChannelRetryCount_++,!0)},goog.net.BrowserChannel.prototype.onStartForwardChannelTimer_=function(e){this.forwardChannelTimerId_=null,this.startForwardChannel_(e)},goog.net.BrowserChannel.prototype.startForwardChannel_=function(e){if(this.channelDebug_.debug("startForwardChannel_"),this.okToMakeRequest_())if(this.state_==goog.net.BrowserChannel.State.INIT){if(e)return void this.channelDebug_.severe("Not supposed to retry the open");this.open_(),this.state_=goog.net.BrowserChannel.State.OPENING}else if(this.state_==goog.net.BrowserChannel.State.OPENED){if(e)return void this.makeForwardChannelRequest_(e);if(0==this.outgoingMaps_.length)return void this.channelDebug_.debug("startForwardChannel_ returned: nothing to send");if(this.forwardChannelRequest_)return void this.channelDebug_.severe("startForwardChannel_ returned: connection already in progress");this.makeForwardChannelRequest_(),this.channelDebug_.debug("startForwardChannel_ finished, sent request")}},goog.net.BrowserChannel.prototype.open_=function(){this.channelDebug_.debug("open_()"),this.nextRid_=Math.floor(1e5*Math.random());var e=this.nextRid_++,n=goog.net.BrowserChannel.createChannelRequest(this,this.channelDebug_,"",e);n.setExtraHeaders(this.extraHeaders_);var t=this.dequeueOutgoingMaps_(),o=this.forwardChannelUri_.clone();o.setParameterValue("RID",e),this.clientVersion_&&o.setParameterValue("CVER",this.clientVersion_),this.addAdditionalParams_(o),n.xmlHttpPost(o,t,!0),this.forwardChannelRequest_=n},goog.net.BrowserChannel.prototype.makeForwardChannelRequest_=function(e){var n,t;e?this.channelVersion_>6?(this.requeuePendingMaps_(),n=this.nextRid_-1,t=this.dequeueOutgoingMaps_()):(n=e.getRequestId(),t=e.getPostData()):(n=this.nextRid_++,t=this.dequeueOutgoingMaps_());var o=this.forwardChannelUri_.clone();o.setParameterValue("SID",this.sid_),o.setParameterValue("RID",n),o.setParameterValue("AID",this.lastArrayId_),this.addAdditionalParams_(o);var r=goog.net.BrowserChannel.createChannelRequest(this,this.channelDebug_,this.sid_,n,this.forwardChannelRetryCount_+1);r.setExtraHeaders(this.extraHeaders_),r.setTimeout(Math.round(.5*this.forwardChannelRequestTimeoutMs_)+Math.round(.5*this.forwardChannelRequestTimeoutMs_*Math.random())),this.forwardChannelRequest_=r,r.xmlHttpPost(o,t,!0)},goog.net.BrowserChannel.prototype.addAdditionalParams_=function(e){if(this.handler_){var n=this.handler_.getAdditionalParams(this);n&&goog.object.forEach(n,function(n,t){e.setParameterValue(t,n)})}},goog.net.BrowserChannel.prototype.dequeueOutgoingMaps_=function(){var e,n=Math.min(this.outgoingMaps_.length,goog.net.BrowserChannel.MAX_MAPS_PER_REQUEST_),t=["count="+n];this.channelVersion_>6&&n>0?(e=this.outgoingMaps_[0].mapId,t.push("ofs="+e)):e=0;for(var o=0;o<n;o++){var r=this.outgoingMaps_[o].mapId,a=this.outgoingMaps_[o].map;this.channelVersion_<=6?r=o:r-=e;try{goog.object.forEach(a,function(e,n,o){t.push("req"+r+"_"+n+"="+encodeURIComponent(e))})}catch(e){t.push("req"+r+"_type="+encodeURIComponent("_badmap")),this.handler_&&this.handler_.badMapError(this,a)}}return this.pendingMaps_=this.pendingMaps_.concat(this.outgoingMaps_.splice(0,n)),t.join("&")},goog.net.BrowserChannel.prototype.requeuePendingMaps_=function(){this.outgoingMaps_=this.pendingMaps_.concat(this.outgoingMaps_),this.pendingMaps_.length=0},goog.net.BrowserChannel.prototype.ensureBackChannel_=function(){this.backChannelRequest_||this.backChannelTimerId_||(this.backChannelAttemptId_=1,this.backChannelTimerId_=goog.net.BrowserChannel.setTimeout(goog.bind(this.onStartBackChannelTimer_,this),0),this.backChannelRetryCount_=0)},goog.net.BrowserChannel.prototype.maybeRetryBackChannel_=function(){return this.backChannelRequest_||this.backChannelTimerId_?(this.channelDebug_.severe("Request already in progress"),!1):!(this.backChannelRetryCount_>=this.getBackChannelMaxRetries())&&(this.channelDebug_.debug("Going to retry GET"),this.backChannelAttemptId_++,this.backChannelTimerId_=goog.net.BrowserChannel.setTimeout(goog.bind(this.onStartBackChannelTimer_,this),this.getRetryTime_(this.backChannelRetryCount_)),this.backChannelRetryCount_++,!0)},goog.net.BrowserChannel.prototype.onStartBackChannelTimer_=function(){this.backChannelTimerId_=null,this.startBackChannel_()},goog.net.BrowserChannel.prototype.startBackChannel_=function(){if(this.okToMakeRequest_()){this.channelDebug_.debug("Creating new HttpRequest"),this.backChannelRequest_=goog.net.BrowserChannel.createChannelRequest(this,this.channelDebug_,this.sid_,"rpc",this.backChannelAttemptId_),this.backChannelRequest_.setExtraHeaders(this.extraHeaders_),this.backChannelRequest_.setReadyStateChangeThrottle(this.readyStateChangeThrottleMs_);var e=this.backChannelUri_.clone();e.setParameterValue("RID","rpc"),e.setParameterValue("SID",this.sid_),e.setParameterValue("CI",this.useChunked_?"0":"1"),e.setParameterValue("AID",this.lastArrayId_),this.addAdditionalParams_(e),goog.net.ChannelRequest.supportsXhrStreaming()?(e.setParameterValue("TYPE","xmlhttp"),this.backChannelRequest_.xmlHttpGet(e,!0,this.hostPrefix_,!1)):(e.setParameterValue("TYPE","html"),this.backChannelRequest_.tridentGet(e,Boolean(this.hostPrefix_))),this.channelDebug_.debug("New Request created")}},goog.net.BrowserChannel.prototype.okToMakeRequest_=function(){if(this.handler_){var e=this.handler_.okToMakeRequest(this);if(e!=goog.net.BrowserChannel.Error.OK)return this.channelDebug_.debug("Handler returned error code from okToMakeRequest"),this.signalError_(e),!1}return!0},goog.net.BrowserChannel.prototype.testConnectionFinished=function(e,n){this.channelDebug_.debug("Test Connection Finished"),this.useChunked_=this.allowChunkedMode_&&n,this.lastStatusCode_=e.getLastStatusCode(),this.asyncTest_||this.connectChannel_()},goog.net.BrowserChannel.prototype.testConnectionFailure=function(e,n){this.channelDebug_.debug("Test Connection Failed"),this.lastStatusCode_=e.getLastStatusCode(),this.signalError_(goog.net.BrowserChannel.Error.REQUEST_FAILED)},goog.net.BrowserChannel.prototype.testConnectionBlocked=function(e){this.channelDebug_.debug("Test Connection Blocked"),this.lastStatusCode_=this.connectionTest_.getLastStatusCode(),this.signalError_(goog.net.BrowserChannel.Error.BLOCKED)},goog.net.BrowserChannel.prototype.onRequestData=function(e,n){if(this.state_!=goog.net.BrowserChannel.State.CLOSED&&(this.backChannelRequest_==e||this.forwardChannelRequest_==e))if(this.lastStatusCode_=e.getLastStatusCode(),this.forwardChannelRequest_==e&&this.state_==goog.net.BrowserChannel.State.OPENED)if(this.channelVersion_>7){try{t=this.parser_.parse(n)}catch(e){t=null}goog.isArray(t)&&3==t.length?this.handlePostResponse_(t):(this.channelDebug_.debug("Bad POST response data returned"),this.signalError_(goog.net.BrowserChannel.Error.BAD_RESPONSE))}else n!=goog.net.ChannelDebug.MAGIC_RESPONSE_COOKIE&&(this.channelDebug_.debug("Bad data returned - missing/invald magic cookie"),this.signalError_(goog.net.BrowserChannel.Error.BAD_RESPONSE));else if(this.backChannelRequest_==e&&this.clearDeadBackchannelTimer_(),!goog.string.isEmptyOrWhitespace(n)){var t=this.parser_.parse(n);goog.asserts.assert(goog.isArray(t)),this.onInput_(t)}},goog.net.BrowserChannel.prototype.handlePostResponse_=function(e){if(0!=e[0]){this.lastPostResponseArrayId_=e[1];var n=this.lastPostResponseArrayId_-this.lastArrayId_;if(0<n){var t=e[2];if(this.channelDebug_.debug(t+" bytes (in "+n+" arrays) are outstanding on the BackChannel"),!this.shouldRetryBackChannel_(t))return;this.deadBackChannelTimerId_||(this.deadBackChannelTimerId_=goog.net.BrowserChannel.setTimeout(goog.bind(this.onBackChannelDead_,this),2*goog.net.BrowserChannel.RTT_ESTIMATE))}}else this.handleBackchannelMissing_()},goog.net.BrowserChannel.prototype.handleBackchannelMissing_=function(){if(this.channelDebug_.debug("Server claims our backchannel is missing."),this.backChannelTimerId_)this.channelDebug_.debug("But we are currently starting the request.");else{if(this.backChannelRequest_){if(!(this.backChannelRequest_.getRequestStartTime()+goog.net.BrowserChannel.RTT_ESTIMATE<this.forwardChannelRequest_.getRequestStartTime()))return;this.clearDeadBackchannelTimer_(),this.backChannelRequest_.cancel(),this.backChannelRequest_=null}else this.channelDebug_.warning("We do not have a BackChannel established");this.maybeRetryBackChannel_(),goog.net.BrowserChannel.notifyStatEvent(goog.net.BrowserChannel.Stat.BACKCHANNEL_MISSING)}},goog.net.BrowserChannel.prototype.shouldRetryBackChannel_=function(e){return e<goog.net.BrowserChannel.OUTSTANDING_DATA_BACKCHANNEL_RETRY_CUTOFF&&!this.isBuffered()&&0==this.backChannelRetryCount_},goog.net.BrowserChannel.prototype.correctHostPrefix=function(e){return this.allowHostPrefix_?this.handler_?this.handler_.correctHostPrefix(e):e:null},goog.net.BrowserChannel.prototype.onBackChannelDead_=function(){null!=this.deadBackChannelTimerId_&&(this.deadBackChannelTimerId_=null,this.backChannelRequest_.cancel(),this.backChannelRequest_=null,this.maybeRetryBackChannel_(),goog.net.BrowserChannel.notifyStatEvent(goog.net.BrowserChannel.Stat.BACKCHANNEL_DEAD))},goog.net.BrowserChannel.prototype.clearDeadBackchannelTimer_=function(){null!=this.deadBackChannelTimerId_&&(goog.global.clearTimeout(this.deadBackChannelTimerId_),this.deadBackChannelTimerId_=null)},goog.net.BrowserChannel.isFatalError_=function(e,n){return e==goog.net.ChannelRequest.Error.UNKNOWN_SESSION_ID||e==goog.net.ChannelRequest.Error.ACTIVE_X_BLOCKED||e==goog.net.ChannelRequest.Error.STATUS&&n>0},goog.net.BrowserChannel.prototype.onRequestComplete=function(e){var n;if(this.channelDebug_.debug("Request complete"),this.backChannelRequest_==e)this.clearDeadBackchannelTimer_(),this.backChannelRequest_=null,n=goog.net.BrowserChannel.ChannelType_.BACK_CHANNEL;else{if(this.forwardChannelRequest_!=e)return;this.forwardChannelRequest_=null,n=goog.net.BrowserChannel.ChannelType_.FORWARD_CHANNEL}if(this.lastStatusCode_=e.getLastStatusCode(),this.state_!=goog.net.BrowserChannel.State.CLOSED)if(e.getSuccess())if(n==goog.net.BrowserChannel.ChannelType_.FORWARD_CHANNEL){var t=e.getPostData()?e.getPostData().length:0;goog.net.BrowserChannel.notifyTimingEvent(t,goog.now()-e.getRequestStartTime(),this.forwardChannelRetryCount_),this.ensureForwardChannel_(),this.onSuccess_(),this.pendingMaps_.length=0}else this.ensureBackChannel_();else{var o=e.getLastError();if(goog.net.BrowserChannel.isFatalError_(o,this.lastStatusCode_))this.channelDebug_.debug("Not retrying due to error type");else{if(this.channelDebug_.debug("Maybe retrying, last error: "+goog.net.ChannelRequest.errorStringFromCode(o,this.lastStatusCode_)),n==goog.net.BrowserChannel.ChannelType_.FORWARD_CHANNEL&&this.maybeRetryForwardChannel_(e))return;if(n==goog.net.BrowserChannel.ChannelType_.BACK_CHANNEL&&this.maybeRetryBackChannel_())return;this.channelDebug_.debug("Exceeded max number of retries")}switch(this.channelDebug_.debug("Error: HTTP request failed"),o){case goog.net.ChannelRequest.Error.NO_DATA:this.signalError_(goog.net.BrowserChannel.Error.NO_DATA);break;case goog.net.ChannelRequest.Error.BAD_DATA:this.signalError_(goog.net.BrowserChannel.Error.BAD_DATA);break;case goog.net.ChannelRequest.Error.UNKNOWN_SESSION_ID:this.signalError_(goog.net.BrowserChannel.Error.UNKNOWN_SESSION_ID);break;case goog.net.ChannelRequest.Error.ACTIVE_X_BLOCKED:this.signalError_(goog.net.BrowserChannel.Error.ACTIVE_X_BLOCKED);break;default:this.signalError_(goog.net.BrowserChannel.Error.REQUEST_FAILED)}}},goog.net.BrowserChannel.prototype.getRetryTime_=function(e){var n=this.baseRetryDelayMs_+Math.floor(Math.random()*this.retryDelaySeedMs_);return this.isActive()||(this.channelDebug_.debug("Inactive channel"),n*=goog.net.BrowserChannel.INACTIVE_CHANNEL_RETRY_FACTOR),n*=e},goog.net.BrowserChannel.prototype.setRetryDelay=function(e,n){this.baseRetryDelayMs_=e,this.retryDelaySeedMs_=n},goog.net.BrowserChannel.prototype.onInput_=function(e){for(var n=this.handler_&&this.handler_.channelHandleMultipleArrays?[]:null,t=0;t<e.length;t++){var o=e[t];if(this.lastArrayId_=o[0],o=o[1],this.state_==goog.net.BrowserChannel.State.OPENING)if("c"==o[0]){this.sid_=o[1],this.hostPrefix_=this.correctHostPrefix(o[2]);var r=o[3];this.channelVersion_=null!=r?r:6,this.state_=goog.net.BrowserChannel.State.OPENED,this.handler_&&this.handler_.channelOpened(this),this.backChannelUri_=this.getBackChannelUri(this.hostPrefix_,this.path_),this.ensureBackChannel_()}else"stop"==o[0]&&this.signalError_(goog.net.BrowserChannel.Error.STOP);else this.state_==goog.net.BrowserChannel.State.OPENED&&("stop"==o[0]?(n&&!goog.array.isEmpty(n)&&(this.handler_.channelHandleMultipleArrays(this,n),n.length=0),this.signalError_(goog.net.BrowserChannel.Error.STOP)):"noop"==o[0]||(n?n.push(o):this.handler_&&this.handler_.channelHandleArray(this,o)),this.backChannelRetryCount_=0)}n&&!goog.array.isEmpty(n)&&this.handler_.channelHandleMultipleArrays(this,n)},goog.net.BrowserChannel.prototype.ensureInState_=function(e){if(!goog.array.contains(arguments,this.state_))throw new Error("Unexpected channel state: "+this.state_)},goog.net.BrowserChannel.prototype.signalError_=function(e){if(this.channelDebug_.info("Error code "+e),e==goog.net.BrowserChannel.Error.REQUEST_FAILED||e==goog.net.BrowserChannel.Error.BLOCKED){var n=null;this.handler_&&(n=this.handler_.getNetworkTestImageUri(this)),goog.net.tmpnetwork.testGoogleCom(goog.bind(this.testGoogleComCallback_,this),n)}else goog.net.BrowserChannel.notifyStatEvent(goog.net.BrowserChannel.Stat.ERROR_OTHER);this.onError_(e)},goog.net.BrowserChannel.prototype.testGoogleComCallback_=function(e){e?(this.channelDebug_.info("Successfully pinged google.com"),goog.net.BrowserChannel.notifyStatEvent(goog.net.BrowserChannel.Stat.ERROR_OTHER)):(this.channelDebug_.info("Failed to ping google.com"),goog.net.BrowserChannel.notifyStatEvent(goog.net.BrowserChannel.Stat.ERROR_NETWORK),this.onError_(goog.net.BrowserChannel.Error.NETWORK))},goog.net.BrowserChannel.prototype.onSuccess_=function(){this.handler_&&this.handler_.channelSuccess(this,this.pendingMaps_)},goog.net.BrowserChannel.prototype.onError_=function(e){this.channelDebug_.debug("HttpChannel: error - "+e),this.state_=goog.net.BrowserChannel.State.CLOSED,this.handler_&&this.handler_.channelError(this,e),this.onClose_(),this.cancelRequests_()},goog.net.BrowserChannel.prototype.onClose_=function(){if(this.state_=goog.net.BrowserChannel.State.CLOSED,this.lastStatusCode_=-1,this.handler_)if(0==this.pendingMaps_.length&&0==this.outgoingMaps_.length)this.handler_.channelClosed(this);else{this.channelDebug_.debug("Number of undelivered maps, pending: "+this.pendingMaps_.length+", outgoing: "+this.outgoingMaps_.length);var e=goog.array.clone(this.pendingMaps_),n=goog.array.clone(this.outgoingMaps_);this.pendingMaps_.length=0,this.outgoingMaps_.length=0,this.handler_.channelClosed(this,e,n)}},goog.net.BrowserChannel.prototype.getForwardChannelUri=function(e){var n=this.createDataUri(null,e);return this.channelDebug_.debug("GetForwardChannelUri: "+n),n},goog.net.BrowserChannel.prototype.getFirstTestResults=function(){return this.firstTestResults_},goog.net.BrowserChannel.prototype.getSecondTestResults=function(){return this.secondTestResults_},goog.net.BrowserChannel.prototype.getBackChannelUri=function(e,n){var t=this.createDataUri(this.shouldUseSecondaryDomains()?e:null,n);return this.channelDebug_.debug("GetBackChannelUri: "+t),t},goog.net.BrowserChannel.prototype.createDataUri=function(e,n,t){var o=goog.Uri.parse(n);if(""!=o.getDomain())e&&o.setDomain(e+"."+o.getDomain()),o.setPort(t||o.getPort());else{var r,a=window.location;r=e?e+"."+a.hostname:a.hostname;var s=t||+a.port;o=goog.Uri.create(a.protocol,null,r,s,n)}return this.extraParams_&&goog.object.forEach(this.extraParams_,function(e,n){o.setParameterValue(n,e)}),o.setParameterValue("VER",this.channelVersion_),this.addAdditionalParams_(o),o},goog.net.BrowserChannel.prototype.createXhrIo=function(e){if(e&&!this.supportsCrossDomainXhrs_)throw new Error("Can't create secondary domain capable XhrIo object.");var n=new goog.net.XhrIo;return n.setWithCredentials(this.supportsCrossDomainXhrs_),n},goog.net.BrowserChannel.prototype.isActive=function(){return!!this.handler_&&this.handler_.isActive(this)},goog.net.BrowserChannel.setTimeout=function(e,n){if(!goog.isFunction(e))throw new Error("Fn must not be null and must be a function");return goog.global.setTimeout(function(){goog.net.BrowserChannel.onStartExecution();try{e()}finally{goog.net.BrowserChannel.onEndExecution()}},n)},goog.net.BrowserChannel.onStartExecution=function(){goog.net.BrowserChannel.startExecutionHook_()},goog.net.BrowserChannel.onEndExecution=function(){goog.net.BrowserChannel.endExecutionHook_()},goog.net.BrowserChannel.getStatEventTarget=function(){return goog.net.BrowserChannel.statEventTarget_},goog.net.BrowserChannel.prototype.notifyServerReachabilityEvent=function(e){var n=goog.net.BrowserChannel.statEventTarget_;n.dispatchEvent(new goog.net.BrowserChannel.ServerReachabilityEvent(n,e))},goog.net.BrowserChannel.notifyStatEvent=function(e){var n=goog.net.BrowserChannel.statEventTarget_;n.dispatchEvent(new goog.net.BrowserChannel.StatEvent(n,e))},goog.net.BrowserChannel.notifyTimingEvent=function(e,n,t){var o=goog.net.BrowserChannel.statEventTarget_;o.dispatchEvent(new goog.net.BrowserChannel.TimingEvent(o,e,n,t))},goog.net.BrowserChannel.prototype.shouldUseSecondaryDomains=function(){return this.supportsCrossDomainXhrs_||!goog.net.ChannelRequest.supportsXhrStreaming()},goog.net.BrowserChannel.LogSaver={},goog.net.BrowserChannel.LogSaver.buffer_=new goog.structs.CircularBuffer(1e3),goog.net.BrowserChannel.LogSaver.enabled_=!1,goog.net.BrowserChannel.LogSaver.formatter_=new goog.debug.TextFormatter,goog.net.BrowserChannel.LogSaver.isEnabled=function(){return goog.net.BrowserChannel.LogSaver.enabled_},goog.net.BrowserChannel.LogSaver.setEnabled=function(e){if(e!=goog.net.BrowserChannel.LogSaver.enabled_){var n=goog.net.BrowserChannel.LogSaver.addLogRecord,t=goog.log.getLogger("goog.net");e?goog.log.addHandler(t,n):goog.log.removeHandler(t,n)}},goog.net.BrowserChannel.LogSaver.addLogRecord=function(e){goog.net.BrowserChannel.LogSaver.buffer_.add(goog.net.BrowserChannel.LogSaver.formatter_.formatRecord(e))},goog.net.BrowserChannel.LogSaver.getBuffer=function(){return goog.net.BrowserChannel.LogSaver.buffer_.getValues().join("")},goog.net.BrowserChannel.LogSaver.clearBuffer=function(){goog.net.BrowserChannel.LogSaver.buffer_.clear()},goog.net.BrowserChannel.Handler=function(){},goog.net.BrowserChannel.Handler.prototype.channelHandleMultipleArrays=null,goog.net.BrowserChannel.Handler.prototype.okToMakeRequest=function(e){return goog.net.BrowserChannel.Error.OK},goog.net.BrowserChannel.Handler.prototype.channelOpened=function(e){},goog.net.BrowserChannel.Handler.prototype.channelHandleArray=function(e,n){},goog.net.BrowserChannel.Handler.prototype.channelSuccess=function(e,n){},goog.net.BrowserChannel.Handler.prototype.channelError=function(e,n){},goog.net.BrowserChannel.Handler.prototype.channelClosed=function(e,n,t){},goog.net.BrowserChannel.Handler.prototype.getAdditionalParams=function(e){return{}},goog.net.BrowserChannel.Handler.prototype.getNetworkTestImageUri=function(e){return null},goog.net.BrowserChannel.Handler.prototype.isActive=function(e){return!0},goog.net.BrowserChannel.Handler.prototype.badMapError=function(e,n){},goog.net.BrowserChannel.Handler.prototype.correctHostPrefix=function(e){return e};