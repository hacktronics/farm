goog.provide("goog.net.xpc.NativeMessagingTransport"),goog.require("goog.Timer"),goog.require("goog.asserts"),goog.require("goog.async.Deferred"),goog.require("goog.events"),goog.require("goog.events.EventHandler"),goog.require("goog.log"),goog.require("goog.net.xpc"),goog.require("goog.net.xpc.CrossPageChannelRole"),goog.require("goog.net.xpc.Transport"),goog.require("goog.net.xpc.TransportTypes"),goog.net.xpc.NativeMessagingTransport=function(e,o,t,n,s){goog.net.xpc.NativeMessagingTransport.base(this,"constructor",t),this.channel_=e,this.protocolVersion_=s||2,goog.asserts.assert(this.protocolVersion_>=1),goog.asserts.assert(this.protocolVersion_<=2),this.peerHostname_=o||"*",this.eventHandler_=new goog.events.EventHandler(this),this.maybeAttemptToConnectTimer_=new goog.Timer(100,this.getWindow()),this.oneSidedHandshake_=!!n,this.setupAckReceived_=new goog.async.Deferred,this.setupAckSent_=new goog.async.Deferred,this.connected_=new goog.async.Deferred,this.endpointId_=goog.net.xpc.getRandomString(10),this.peerEndpointId_=null,this.oneSidedHandshake_?this.channel_.getRole()==goog.net.xpc.CrossPageChannelRole.INNER?this.connected_.awaitDeferred(this.setupAckReceived_):this.connected_.awaitDeferred(this.setupAckSent_):(this.connected_.awaitDeferred(this.setupAckReceived_),2==this.protocolVersion_&&this.connected_.awaitDeferred(this.setupAckSent_)),this.connected_.addCallback(this.notifyConnected_,this),this.connected_.callback(!0),this.eventHandler_.listen(this.maybeAttemptToConnectTimer_,goog.Timer.TICK,this.maybeAttemptToConnect_),goog.log.info(goog.net.xpc.logger,"NativeMessagingTransport created.  protocolVersion="+this.protocolVersion_+", oneSidedHandshake="+this.oneSidedHandshake_+", role="+this.channel_.getRole())},goog.inherits(goog.net.xpc.NativeMessagingTransport,goog.net.xpc.Transport),goog.net.xpc.NativeMessagingTransport.CONNECTION_DELAY_MS_=200,goog.net.xpc.NativeMessagingTransport.prototype.peerProtocolVersion_=null,goog.net.xpc.NativeMessagingTransport.prototype.initialized_=!1,goog.net.xpc.NativeMessagingTransport.prototype.transportType=goog.net.xpc.TransportTypes.NATIVE_MESSAGING,goog.net.xpc.NativeMessagingTransport.MESSAGE_DELIMITER_=",",goog.net.xpc.NativeMessagingTransport.activeCount_={},goog.net.xpc.NativeMessagingTransport.prototype.sendTimerId_=0,goog.net.xpc.NativeMessagingTransport.prototype.couldPeerVersionBe_=function(e){return null==this.peerProtocolVersion_||this.peerProtocolVersion_==e},goog.net.xpc.NativeMessagingTransport.initialize_=function(e){var o=goog.getUid(e),t=goog.net.xpc.NativeMessagingTransport.activeCount_[o];"number"!=typeof t&&(t=0),0==t&&goog.events.listen(e.postMessage?e:e.document,"message",goog.net.xpc.NativeMessagingTransport.messageReceived_,!1,goog.net.xpc.NativeMessagingTransport),goog.net.xpc.NativeMessagingTransport.activeCount_[o]=t+1},goog.net.xpc.NativeMessagingTransport.messageReceived_=function(e){var o=e.getBrowserEvent().data;if("string"!=typeof o)return!1;var t=o.indexOf("|"),n=o.indexOf(":");if(-1==t||-1==n)return!1;var s=o.substring(0,t),i=o.substring(t+1,n),g=o.substring(n+1);goog.log.fine(goog.net.xpc.logger,"messageReceived: channel="+s+", service="+i+", payload="+g);var r=goog.net.xpc.channels[s];if(r)return r.xpcDeliver(i,g,e.getBrowserEvent().origin),!0;var a=goog.net.xpc.NativeMessagingTransport.parseTransportPayload_(g)[0];for(var c in goog.net.xpc.channels){var p=goog.net.xpc.channels[c];if(p.getRole()==goog.net.xpc.CrossPageChannelRole.INNER&&!p.isConnected()&&i==goog.net.xpc.TRANSPORT_SERVICE_&&(a==goog.net.xpc.SETUP||a==goog.net.xpc.SETUP_NTPV2)&&p.isMessageOriginAcceptable(e.getBrowserEvent().origin))return p.updateChannelNameAndCatalog(s),p.xpcDeliver(i,g),!0}return goog.log.info(goog.net.xpc.logger,'channel name mismatch; message ignored"'),!1},goog.net.xpc.NativeMessagingTransport.prototype.transportServiceHandler=function(e){var o=goog.net.xpc.NativeMessagingTransport.parseTransportPayload_(e),t=o[0],n=o[1];switch(t){case goog.net.xpc.SETUP_ACK_:this.setPeerProtocolVersion_(1),this.setupAckReceived_.hasFired()||this.setupAckReceived_.callback(!0);break;case goog.net.xpc.SETUP_ACK_NTPV2:2==this.protocolVersion_&&(this.setPeerProtocolVersion_(2),this.setupAckReceived_.hasFired()||this.setupAckReceived_.callback(!0));break;case goog.net.xpc.SETUP:this.setPeerProtocolVersion_(1),this.sendSetupAckMessage_(1);break;case goog.net.xpc.SETUP_NTPV2:if(2==this.protocolVersion_){var s=this.peerProtocolVersion_;this.setPeerProtocolVersion_(2),this.sendSetupAckMessage_(2),1!=s&&null==this.peerEndpointId_||this.peerEndpointId_==n||(goog.log.info(goog.net.xpc.logger,"Sending SETUP and changing peer ID to: "+n),this.sendSetupMessage_()),this.peerEndpointId_=n}}},goog.net.xpc.NativeMessagingTransport.prototype.sendSetupMessage_=function(){if(goog.asserts.assert(!(1==this.protocolVersion_&&2==this.peerProtocolVersion_)),2==this.protocolVersion_&&this.couldPeerVersionBe_(2)){var e=goog.net.xpc.SETUP_NTPV2;e+=goog.net.xpc.NativeMessagingTransport.MESSAGE_DELIMITER_,e+=this.endpointId_,this.send(goog.net.xpc.TRANSPORT_SERVICE_,e)}this.couldPeerVersionBe_(1)&&this.send(goog.net.xpc.TRANSPORT_SERVICE_,goog.net.xpc.SETUP)},goog.net.xpc.NativeMessagingTransport.prototype.sendSetupAckMessage_=function(e){if(goog.asserts.assert(1!=this.protocolVersion_||2!=e,"Shouldn't try to send a v2 setup ack in v1 mode."),2==this.protocolVersion_&&this.couldPeerVersionBe_(2)&&2==e)this.send(goog.net.xpc.TRANSPORT_SERVICE_,goog.net.xpc.SETUP_ACK_NTPV2);else{if(!this.couldPeerVersionBe_(1)||1!=e)return;this.send(goog.net.xpc.TRANSPORT_SERVICE_,goog.net.xpc.SETUP_ACK_)}this.setupAckSent_.hasFired()||this.setupAckSent_.callback(!0)},goog.net.xpc.NativeMessagingTransport.prototype.setPeerProtocolVersion_=function(e){e>this.peerProtocolVersion_&&(this.peerProtocolVersion_=e),1==this.peerProtocolVersion_&&(this.setupAckSent_.hasFired()||this.oneSidedHandshake_||this.setupAckSent_.callback(!0),this.peerEndpointId_=null)},goog.net.xpc.NativeMessagingTransport.prototype.connect=function(){goog.net.xpc.NativeMessagingTransport.initialize_(this.getWindow()),this.initialized_=!0,this.maybeAttemptToConnect_()},goog.net.xpc.NativeMessagingTransport.prototype.maybeAttemptToConnect_=function(){var e=this.channel_.getRole()==goog.net.xpc.CrossPageChannelRole.OUTER;this.oneSidedHandshake_&&e||this.channel_.isConnected()||this.isDisposed()?this.maybeAttemptToConnectTimer_.stop():(this.maybeAttemptToConnectTimer_.start(),this.sendSetupMessage_())},goog.net.xpc.NativeMessagingTransport.prototype.send=function(e,o){var t=this.channel_.getPeerWindowObject();t?(this.send=function(e,o){var n=this,s=this.channel_.name;this.sendTimerId_=goog.Timer.callOnce(function(){n.sendTimerId_=0;try{var i=t.postMessage?t:t.document;if(!i.postMessage)return void goog.log.warning(goog.net.xpc.logger,"Peer window had no postMessage function.");i.postMessage(s+"|"+e+":"+o,n.peerHostname_),goog.log.fine(goog.net.xpc.logger,"send(): service="+e+" payload="+o+" to hostname="+n.peerHostname_)}catch(e){goog.log.warning(goog.net.xpc.logger,"Error performing postMessage, ignoring.",e)}},0)},this.send(e,o)):goog.log.fine(goog.net.xpc.logger,"send(): window not ready")},goog.net.xpc.NativeMessagingTransport.prototype.notifyConnected_=function(){var e=1==this.protocolVersion_||1==this.peerProtocolVersion_?goog.net.xpc.NativeMessagingTransport.CONNECTION_DELAY_MS_:void 0;this.channel_.notifyConnected(e)},goog.net.xpc.NativeMessagingTransport.prototype.disposeInternal=function(){if(this.initialized_){var e=this.getWindow(),o=goog.getUid(e),t=goog.net.xpc.NativeMessagingTransport.activeCount_[o];goog.net.xpc.NativeMessagingTransport.activeCount_[o]=t-1,1==t&&goog.events.unlisten(e.postMessage?e:e.document,"message",goog.net.xpc.NativeMessagingTransport.messageReceived_,!1,goog.net.xpc.NativeMessagingTransport)}this.sendTimerId_&&(goog.Timer.clear(this.sendTimerId_),this.sendTimerId_=0),goog.dispose(this.eventHandler_),delete this.eventHandler_,goog.dispose(this.maybeAttemptToConnectTimer_),delete this.maybeAttemptToConnectTimer_,this.setupAckReceived_.cancel(),delete this.setupAckReceived_,this.setupAckSent_.cancel(),delete this.setupAckSent_,this.connected_.cancel(),delete this.connected_,delete this.send,goog.net.xpc.NativeMessagingTransport.base(this,"disposeInternal")},goog.net.xpc.NativeMessagingTransport.parseTransportPayload_=function(e){var o=e.split(goog.net.xpc.NativeMessagingTransport.MESSAGE_DELIMITER_);return o[1]=o[1]||null,o};