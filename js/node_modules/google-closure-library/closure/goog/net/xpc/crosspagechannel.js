goog.provide("goog.net.xpc.CrossPageChannel"),goog.require("goog.Uri"),goog.require("goog.async.Deferred"),goog.require("goog.async.Delay"),goog.require("goog.dispose"),goog.require("goog.dom"),goog.require("goog.dom.TagName"),goog.require("goog.dom.safe"),goog.require("goog.events"),goog.require("goog.events.EventHandler"),goog.require("goog.events.EventType"),goog.require("goog.html.legacyconversions"),goog.require("goog.json"),goog.require("goog.log"),goog.require("goog.messaging.AbstractChannel"),goog.require("goog.net.xpc"),goog.require("goog.net.xpc.CfgFields"),goog.require("goog.net.xpc.ChannelStates"),goog.require("goog.net.xpc.CrossPageChannelRole"),goog.require("goog.net.xpc.DirectTransport"),goog.require("goog.net.xpc.NativeMessagingTransport"),goog.require("goog.net.xpc.TransportTypes"),goog.require("goog.net.xpc.UriCfgFields"),goog.require("goog.string"),goog.require("goog.uri.utils"),goog.require("goog.userAgent"),goog.net.xpc.CrossPageChannel=function(e,o){goog.net.xpc.CrossPageChannel.base(this,"constructor");for(var n,t=0;n=goog.net.xpc.UriCfgFields[t];t++)if(n in e&&!/^https?:\/\//.test(e[n]))throw new Error("URI "+e[n]+" is invalid for field "+n);this.cfg_=e,this.name=this.cfg_[goog.net.xpc.CfgFields.CHANNEL_NAME]||goog.net.xpc.getRandomString(10),this.domHelper_=o||goog.dom.getDomHelper(),this.deferredDeliveries_=[],this.peerLoadHandler_=new goog.events.EventHandler(this),e[goog.net.xpc.CfgFields.LOCAL_POLL_URI]=e[goog.net.xpc.CfgFields.LOCAL_POLL_URI]||goog.uri.utils.getHost(this.domHelper_.getWindow().location.href)+"/robots.txt",e[goog.net.xpc.CfgFields.PEER_POLL_URI]=e[goog.net.xpc.CfgFields.PEER_POLL_URI]||goog.uri.utils.getHost(e[goog.net.xpc.CfgFields.PEER_URI]||"")+"/robots.txt",goog.net.xpc.channels[this.name]=this,goog.events.getListener(window,goog.events.EventType.UNLOAD,goog.net.xpc.CrossPageChannel.disposeAll_)||goog.events.listenOnce(window,goog.events.EventType.UNLOAD,goog.net.xpc.CrossPageChannel.disposeAll_),goog.log.info(goog.net.xpc.logger,"CrossPageChannel created: "+this.name)},goog.inherits(goog.net.xpc.CrossPageChannel,goog.messaging.AbstractChannel),goog.net.xpc.CrossPageChannel.TRANSPORT_SERVICE_ESCAPE_RE_=new RegExp("^%*"+goog.net.xpc.TRANSPORT_SERVICE_+"$"),goog.net.xpc.CrossPageChannel.TRANSPORT_SERVICE_UNESCAPE_RE_=new RegExp("^%+"+goog.net.xpc.TRANSPORT_SERVICE_+"$"),goog.net.xpc.CrossPageChannel.prototype.connectionDelay_=null,goog.net.xpc.CrossPageChannel.prototype.peerWindowDeferred_=null,goog.net.xpc.CrossPageChannel.prototype.transport_=null,goog.net.xpc.CrossPageChannel.prototype.state_=goog.net.xpc.ChannelStates.NOT_CONNECTED,goog.net.xpc.CrossPageChannel.prototype.isConnected=function(){return this.state_==goog.net.xpc.ChannelStates.CONNECTED},goog.net.xpc.CrossPageChannel.prototype.peerWindowObject_=null,goog.net.xpc.CrossPageChannel.prototype.iframeElement_=null,goog.net.xpc.CrossPageChannel.prototype.getConfig=function(){return this.cfg_},goog.net.xpc.CrossPageChannel.prototype.getIframeElement=function(){return this.iframeElement_},goog.net.xpc.CrossPageChannel.prototype.setPeerWindowObject=function(e){this.peerWindowObject_=e},goog.net.xpc.CrossPageChannel.prototype.getPeerWindowObject=function(){return this.peerWindowObject_},goog.net.xpc.CrossPageChannel.prototype.isPeerAvailable=function(){try{return!!this.peerWindowObject_&&!this.peerWindowObject_.closed}catch(e){return!1}},goog.net.xpc.CrossPageChannel.prototype.determineTransportType_=function(){return goog.isFunction(document.postMessage)||goog.isFunction(window.postMessage)||goog.userAgent.IE&&window.postMessage?goog.net.xpc.TransportTypes.NATIVE_MESSAGING:goog.net.xpc.TransportTypes.UNDEFINED},goog.net.xpc.CrossPageChannel.prototype.createTransport_=function(){if(!this.transport_){var e=goog.net.xpc.CfgFields;if(this.cfg_[e.TRANSPORT]||(this.cfg_[e.TRANSPORT]=this.determineTransportType_()),goog.isFunction(this.cfg_[e.TRANSPORT]))this.transport_=new this.cfg_[e.TRANSPORT](this,this.domHelper_);else switch(this.cfg_[e.TRANSPORT]){case goog.net.xpc.TransportTypes.NATIVE_MESSAGING:var o=this.cfg_[e.NATIVE_TRANSPORT_PROTOCOL_VERSION]||2;this.transport_=new goog.net.xpc.NativeMessagingTransport(this,this.cfg_[e.PEER_HOSTNAME],this.domHelper_,!!this.cfg_[e.ONE_SIDED_HANDSHAKE],o);break;case goog.net.xpc.TransportTypes.DIRECT:this.peerWindowObject_&&goog.net.xpc.DirectTransport.isSupported(this.peerWindowObject_)?this.transport_=new goog.net.xpc.DirectTransport(this,this.domHelper_):goog.log.info(goog.net.xpc.logger,"DirectTransport not supported for this window, peer window in different security context or not set yet.")}if(!this.transport_)throw new Error("CrossPageChannel: No suitable transport found! You may try injecting a Transport constructor directly via the channel config object.");goog.log.info(goog.net.xpc.logger,"Transport created: "+this.transport_.getName())}},goog.net.xpc.CrossPageChannel.prototype.getTransportType=function(){return this.transport_.getType()},goog.net.xpc.CrossPageChannel.prototype.getTransportName=function(){return this.transport_.getName()},goog.net.xpc.CrossPageChannel.prototype.getPeerConfiguration=function(){var e={};e[goog.net.xpc.CfgFields.CHANNEL_NAME]=this.name,e[goog.net.xpc.CfgFields.TRANSPORT]=this.cfg_[goog.net.xpc.CfgFields.TRANSPORT],e[goog.net.xpc.CfgFields.ONE_SIDED_HANDSHAKE]=this.cfg_[goog.net.xpc.CfgFields.ONE_SIDED_HANDSHAKE],this.cfg_[goog.net.xpc.CfgFields.LOCAL_RELAY_URI]&&(e[goog.net.xpc.CfgFields.PEER_RELAY_URI]=this.cfg_[goog.net.xpc.CfgFields.LOCAL_RELAY_URI]),this.cfg_[goog.net.xpc.CfgFields.LOCAL_POLL_URI]&&(e[goog.net.xpc.CfgFields.PEER_POLL_URI]=this.cfg_[goog.net.xpc.CfgFields.LOCAL_POLL_URI]),this.cfg_[goog.net.xpc.CfgFields.PEER_POLL_URI]&&(e[goog.net.xpc.CfgFields.LOCAL_POLL_URI]=this.cfg_[goog.net.xpc.CfgFields.PEER_POLL_URI]);var o=this.cfg_[goog.net.xpc.CfgFields.ROLE];return o&&(e[goog.net.xpc.CfgFields.ROLE]=o==goog.net.xpc.CrossPageChannelRole.INNER?goog.net.xpc.CrossPageChannelRole.OUTER:goog.net.xpc.CrossPageChannelRole.INNER),e},goog.net.xpc.CrossPageChannel.prototype.createPeerIframe=function(e,o,n){goog.log.info(goog.net.xpc.logger,"createPeerIframe()");var t=this.cfg_[goog.net.xpc.CfgFields.IFRAME_ID];t||(t=this.cfg_[goog.net.xpc.CfgFields.IFRAME_ID]="xpcpeer"+goog.net.xpc.getRandomString(4));var g=goog.dom.getDomHelper(e).createElement(goog.dom.TagName.IFRAME);g.id=g.name=t,o?o(g):g.style.width=g.style.height="100%",this.cleanUpIncompleteConnection_(),this.peerWindowDeferred_=new goog.async.Deferred(void 0,this);var r=this.getPeerUri(n);return this.peerLoadHandler_.listenOnceWithScope(g,"load",this.peerWindowDeferred_.callback,!1,this.peerWindowDeferred_),goog.userAgent.GECKO||goog.userAgent.WEBKIT?window.setTimeout(goog.bind(function(){e.appendChild(g),goog.dom.safe.setIframeSrc(g,goog.html.legacyconversions.trustedResourceUrlFromString(r.toString())),goog.log.info(goog.net.xpc.logger,"peer iframe created ("+t+")")},this),1):(goog.dom.safe.setIframeSrc(g,goog.html.legacyconversions.trustedResourceUrlFromString(r.toString())),e.appendChild(g),goog.log.info(goog.net.xpc.logger,"peer iframe created ("+t+")")),g},goog.net.xpc.CrossPageChannel.prototype.cleanUpIncompleteConnection_=function(){this.peerWindowDeferred_&&(this.peerWindowDeferred_.cancel(),this.peerWindowDeferred_=null),this.deferredDeliveries_.length=0,this.peerLoadHandler_.removeAll()},goog.net.xpc.CrossPageChannel.prototype.getPeerUri=function(e){var o=this.cfg_[goog.net.xpc.CfgFields.PEER_URI];return"string"==typeof o&&(o=this.cfg_[goog.net.xpc.CfgFields.PEER_URI]=new goog.Uri(o)),!1!==e&&o.setParameterValue("xpc",goog.json.serialize(this.getPeerConfiguration())),o},goog.net.xpc.CrossPageChannel.prototype.connect=function(e){this.connectCb_=e||goog.nullFunction,this.state_==goog.net.xpc.ChannelStates.CLOSED&&(this.state_=goog.net.xpc.ChannelStates.NOT_CONNECTED),this.peerWindowDeferred_?this.peerWindowDeferred_.addCallback(this.continueConnection_):this.continueConnection_()},goog.net.xpc.CrossPageChannel.prototype.continueConnection_=function(){if(goog.log.info(goog.net.xpc.logger,"continueConnection_()"),this.peerWindowDeferred_=null,this.cfg_[goog.net.xpc.CfgFields.IFRAME_ID]&&(this.iframeElement_=this.domHelper_.getElement(this.cfg_[goog.net.xpc.CfgFields.IFRAME_ID])),this.iframeElement_){var e=this.iframeElement_.contentWindow;e||(e=window.frames[this.cfg_[goog.net.xpc.CfgFields.IFRAME_ID]]),this.setPeerWindowObject(e)}if(!this.peerWindowObject_){if(window==window.top)throw new Error("CrossPageChannel: Can't connect, peer window-object not set.");this.setPeerWindowObject(window.parent)}for(this.createTransport_(),this.transport_.connect();this.deferredDeliveries_.length>0;)this.deferredDeliveries_.shift()()},goog.net.xpc.CrossPageChannel.prototype.close=function(){this.cleanUpIncompleteConnection_(),this.state_=goog.net.xpc.ChannelStates.CLOSED,goog.dispose(this.transport_),this.transport_=null,this.connectCb_=null,goog.dispose(this.connectionDelay_),this.connectionDelay_=null,goog.log.info(goog.net.xpc.logger,'Channel "'+this.name+'" closed')},goog.net.xpc.CrossPageChannel.prototype.notifyConnected=function(e){this.isConnected()||this.connectionDelay_&&this.connectionDelay_.isActive()||(this.state_=goog.net.xpc.ChannelStates.CONNECTED,goog.log.info(goog.net.xpc.logger,'Channel "'+this.name+'" connected'),goog.dispose(this.connectionDelay_),void 0!==e?(this.connectionDelay_=new goog.async.Delay(this.connectCb_,e),this.connectionDelay_.start()):(this.connectionDelay_=null,this.connectCb_()))},goog.net.xpc.CrossPageChannel.prototype.notifyTransportError=function(){goog.log.info(goog.net.xpc.logger,"Transport Error"),this.close()},goog.net.xpc.CrossPageChannel.prototype.send=function(e,o){if(this.isConnected()){if(!this.isPeerAvailable())return goog.log.error(goog.net.xpc.logger,"Peer has disappeared."),void this.close();goog.isObject(o)&&(o=goog.json.serialize(o)),this.transport_.send(this.escapeServiceName_(e),o)}else goog.log.error(goog.net.xpc.logger,"Can't send. Channel not connected.")},goog.net.xpc.CrossPageChannel.prototype.xpcDeliver=function(e,o,n){this.peerWindowDeferred_?this.deferredDeliveries_.push(goog.bind(this.xpcDeliver,this,e,o,n)):this.isMessageOriginAcceptable(n)?this.isDisposed()||this.state_==goog.net.xpc.ChannelStates.CLOSED?goog.log.warning(goog.net.xpc.logger,"CrossPageChannel::xpcDeliver(): Channel closed."):e&&e!=goog.net.xpc.TRANSPORT_SERVICE_?this.isConnected()?this.deliver(this.unescapeServiceName_(e),o):goog.log.info(goog.net.xpc.logger,"CrossPageChannel::xpcDeliver(): Not connected."):this.transport_.transportServiceHandler(o):goog.log.warning(goog.net.xpc.logger,'Message received from unapproved origin "'+n+'" - rejected.')},goog.net.xpc.CrossPageChannel.prototype.escapeServiceName_=function(e){return goog.net.xpc.CrossPageChannel.TRANSPORT_SERVICE_ESCAPE_RE_.test(e)&&(e="%"+e),e.replace(/[%:|]/g,encodeURIComponent)},goog.net.xpc.CrossPageChannel.prototype.unescapeServiceName_=function(e){return e=e.replace(/%[0-9a-f]{2}/gi,decodeURIComponent),goog.net.xpc.CrossPageChannel.TRANSPORT_SERVICE_UNESCAPE_RE_.test(e)?e.substring(1):e},goog.net.xpc.CrossPageChannel.prototype.getRole=function(){var e=this.cfg_[goog.net.xpc.CfgFields.ROLE];return"number"==typeof e?e:window.parent==this.peerWindowObject_?goog.net.xpc.CrossPageChannelRole.INNER:goog.net.xpc.CrossPageChannelRole.OUTER},goog.net.xpc.CrossPageChannel.prototype.updateChannelNameAndCatalog=function(e){goog.log.fine(goog.net.xpc.logger,"changing channel name to "+e),delete goog.net.xpc.channels[this.name],this.name=e,goog.net.xpc.channels[e]=this},goog.net.xpc.CrossPageChannel.prototype.isMessageOriginAcceptable=function(e){var o=this.cfg_[goog.net.xpc.CfgFields.PEER_HOSTNAME];return goog.string.isEmptyOrWhitespace(goog.string.makeSafe(e))||goog.string.isEmptyOrWhitespace(goog.string.makeSafe(o))||e==this.cfg_[goog.net.xpc.CfgFields.PEER_HOSTNAME]},goog.net.xpc.CrossPageChannel.prototype.disposeInternal=function(){this.close(),this.peerWindowObject_=null,this.iframeElement_=null,delete goog.net.xpc.channels[this.name],goog.dispose(this.peerLoadHandler_),delete this.peerLoadHandler_,goog.net.xpc.CrossPageChannel.base(this,"disposeInternal")},goog.net.xpc.CrossPageChannel.disposeAll_=function(){for(var e in goog.net.xpc.channels)goog.dispose(goog.net.xpc.channels[e])};