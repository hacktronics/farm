goog.provide("goog.net.xpc.DirectTransport"),goog.require("goog.Timer"),goog.require("goog.async.Deferred"),goog.require("goog.events.EventHandler"),goog.require("goog.log"),goog.require("goog.net.xpc"),goog.require("goog.net.xpc.CfgFields"),goog.require("goog.net.xpc.CrossPageChannelRole"),goog.require("goog.net.xpc.Transport"),goog.require("goog.net.xpc.TransportTypes"),goog.require("goog.object"),goog.scope(function(){var e=goog.net.xpc.CfgFields,t=goog.net.xpc.CrossPageChannelRole,n=goog.async.Deferred,o=goog.events.EventHandler,i=goog.Timer,g=goog.net.xpc.Transport;goog.net.xpc.DirectTransport=function(e,t){goog.net.xpc.DirectTransport.base(this,"constructor",t),this.channel_=e,this.eventHandler_=new o(this),this.registerDisposable(this.eventHandler_),this.maybeAttemptToConnectTimer_=new i(s.CONNECTION_ATTEMPT_INTERVAL_MS_,this.getWindow()),this.registerDisposable(this.maybeAttemptToConnectTimer_),this.setupAckReceived_=new n,this.setupAckSent_=new n,this.connected_=new n,this.endpointId_=goog.net.xpc.getRandomString(10),this.peerEndpointId_=null,this.asyncSendsMap_={},this.originalChannelName_=this.channel_.name,this.channel_.updateChannelNameAndCatalog(s.getRoledChannelName_(this.channel_.name,this.channel_.getRole())),this.initialized_=!1,this.connected_.awaitDeferred(this.setupAckReceived_),this.connected_.awaitDeferred(this.setupAckSent_),this.connected_.addCallback(this.notifyConnected_,this),this.connected_.callback(!0),this.eventHandler_.listen(this.maybeAttemptToConnectTimer_,i.TICK,this.maybeAttemptToConnect_),goog.log.info(goog.net.xpc.logger,"DirectTransport created. role="+this.channel_.getRole())},goog.inherits(goog.net.xpc.DirectTransport,g);var s=goog.net.xpc.DirectTransport;s.CONNECTION_ATTEMPT_INTERVAL_MS_=100,s.CONNECTION_DELAY_INTERVAL_MS_=0,s.isSupported=function(e){try{return window.document.domain==e.document.domain}catch(e){return!1}},s.activeCount_={},s.GLOBAL_TRANPORT_PATH_="crosswindowmessaging.channel",s.MESSAGE_DELIMITER_=",",s.initialize_=function(e){var t=goog.getUid(e);0==(s.activeCount_[t]||0)&&(null==goog.getObjectByName(s.GLOBAL_TRANPORT_PATH_,e)&&goog.exportSymbol(s.GLOBAL_TRANPORT_PATH_,s.messageReceivedHandler_,e));s.activeCount_[t]++},s.getRoledChannelName_=function(e,t){return e+"_"+t},s.messageReceivedHandler_=function(e){var n=s.Message_.fromLiteral(e),o=n.channelName,i=n.service,g=n.payload;goog.log.fine(goog.net.xpc.logger,"messageReceived: channel="+o+", service="+i+", payload="+g);var a=goog.net.xpc.channels[o];if(a)return a.xpcDeliver(i,g),!0;var c=s.parseTransportPayload_(g)[0];for(var r in goog.net.xpc.channels){var l=goog.net.xpc.channels[r];if(l.getRole()==t.INNER&&!l.isConnected()&&i==goog.net.xpc.TRANSPORT_SERVICE_&&c==goog.net.xpc.SETUP)return l.updateChannelNameAndCatalog(o),l.xpcDeliver(i,g),!0}return goog.log.info(goog.net.xpc.logger,"channel name mismatch; message ignored."),!1},s.prototype.transportType=goog.net.xpc.TransportTypes.DIRECT,s.prototype.transportServiceHandler=function(e){var t=s.parseTransportPayload_(e),n=t[0],o=t[1];switch(n){case goog.net.xpc.SETUP_ACK_:this.setupAckReceived_.hasFired()||this.setupAckReceived_.callback(!0);break;case goog.net.xpc.SETUP:this.sendSetupAckMessage_(),null!=this.peerEndpointId_&&this.peerEndpointId_!=o&&(goog.log.info(goog.net.xpc.logger,"Sending SETUP and changing peer ID to: "+o),this.sendSetupMessage_()),this.peerEndpointId_=o}},s.prototype.sendSetupMessage_=function(){var e=goog.net.xpc.SETUP;e+=s.MESSAGE_DELIMITER_,e+=this.endpointId_,this.send(goog.net.xpc.TRANSPORT_SERVICE_,e)},s.prototype.sendSetupAckMessage_=function(){this.send(goog.net.xpc.TRANSPORT_SERVICE_,goog.net.xpc.SETUP_ACK_),this.setupAckSent_.hasFired()||this.setupAckSent_.callback(!0)},s.prototype.connect=function(){var e=this.getWindow();e?(s.initialize_(e),this.initialized_=!0,this.maybeAttemptToConnect_()):goog.log.fine(goog.net.xpc.logger,"connect(): no window to initialize.")},s.prototype.maybeAttemptToConnect_=function(){this.channel_.isConnected()?this.maybeAttemptToConnectTimer_.stop():(this.maybeAttemptToConnectTimer_.start(),this.sendSetupMessage_())},s.prototype.send=function(t,n){if(this.channel_.getPeerWindowObject()){var o=s.getRoledChannelName_(this.originalChannelName_,this.getPeerRole_()),g=new s.Message_(o,t,n);this.channel_.getConfig()[e.DIRECT_TRANSPORT_SYNC_MODE]?this.executeScheduledSend_(g):this.asyncSendsMap_[goog.getUid(g)]=i.callOnce(goog.bind(this.executeScheduledSend_,this,g),0)}else goog.log.fine(goog.net.xpc.logger,"send(): window not ready")},s.prototype.executeScheduledSend_=function(e){var t=goog.getUid(e);this.asyncSendsMap_[t]&&delete this.asyncSendsMap_[t];try{var n=goog.getObjectByName(s.GLOBAL_TRANPORT_PATH_,this.channel_.getPeerWindowObject())}catch(e){return void goog.log.warning(goog.net.xpc.logger,"Can't access other window, ignoring.",e)}if(null!==n)try{n(e.toLiteral()),goog.log.info(goog.net.xpc.logger,"send(): channelName="+e.channelName+" service="+e.service+" payload="+e.payload)}catch(e){goog.log.warning(goog.net.xpc.logger,"Error performing call, ignoring.",e)}else goog.log.warning(goog.net.xpc.logger,"Peer window had no global function.")},s.prototype.getPeerRole_=function(){return this.channel_.getRole()==goog.net.xpc.CrossPageChannelRole.OUTER?goog.net.xpc.CrossPageChannelRole.INNER:goog.net.xpc.CrossPageChannelRole.OUTER},s.prototype.notifyConnected_=function(){this.channel_.notifyConnected(this.channel_.getConfig()[e.DIRECT_TRANSPORT_SYNC_MODE]?s.CONNECTION_DELAY_INTERVAL_MS_:0)},s.prototype.disposeInternal=function(){if(this.initialized_){var e=this.getWindow(),t=goog.getUid(e);1==--s.activeCount_[t]&&goog.exportSymbol(s.GLOBAL_TRANPORT_PATH_,null,e)}this.asyncSendsMap_&&(goog.object.forEach(this.asyncSendsMap_,function(e){i.clear(e)}),this.asyncSendsMap_=null),this.setupAckReceived_&&(this.setupAckReceived_.cancel(),delete this.setupAckReceived_),this.setupAckSent_&&(this.setupAckSent_.cancel(),delete this.setupAckSent_),this.connected_&&(this.connected_.cancel(),delete this.connected_),s.base(this,"disposeInternal")},s.parseTransportPayload_=function(e){var t=e.split(s.MESSAGE_DELIMITER_);return t[1]=t[1]||null,t},s.Message_=function(e,t,n){this.channelName=e,this.service=t,this.payload=n},s.Message_.prototype.toLiteral=function(){return{channelName:this.channelName,service:this.service,payload:this.payload}},s.Message_.fromLiteral=function(e){return new s.Message_(e.channelName,e.service,e.payload)}});