goog.provide("goog.net.IframeIo"),goog.provide("goog.net.IframeIo.IncrementalDataEvent"),goog.provide("goog.net.IframeIo.TEST_ONLY"),goog.require("goog.Timer"),goog.require("goog.Uri"),goog.require("goog.array"),goog.require("goog.asserts"),goog.require("goog.debug.HtmlFormatter"),goog.require("goog.dom"),goog.require("goog.dom.InputType"),goog.require("goog.dom.TagName"),goog.require("goog.dom.safe"),goog.require("goog.events"),goog.require("goog.events.Event"),goog.require("goog.events.EventTarget"),goog.require("goog.events.EventType"),goog.require("goog.html.SafeUrl"),goog.require("goog.html.legacyconversions"),goog.require("goog.html.uncheckedconversions"),goog.require("goog.json"),goog.require("goog.log"),goog.require("goog.log.Level"),goog.require("goog.net.ErrorCode"),goog.require("goog.net.EventType"),goog.require("goog.reflect"),goog.require("goog.string"),goog.require("goog.string.Const"),goog.require("goog.structs"),goog.require("goog.userAgent"),goog.net.IframeIo=function(){goog.net.IframeIo.base(this,"constructor"),this.name_=goog.net.IframeIo.getNextName_(),this.iframesForDisposal_=[],goog.net.IframeIo.instances_[this.name_]=this},goog.inherits(goog.net.IframeIo,goog.events.EventTarget),goog.net.IframeIo.instances_={},goog.net.IframeIo.FRAME_NAME_PREFIX="closure_frame",goog.net.IframeIo.INNER_FRAME_SUFFIX="_inner",goog.net.IframeIo.IFRAME_DISPOSE_DELAY_MS=2e3,goog.net.IframeIo.counter_=0,goog.net.IframeIo.form_,goog.net.IframeIo.send=function(o,e,t,r,g){var n=new goog.net.IframeIo;goog.events.listen(n,goog.net.EventType.READY,n.dispose,!1,n),e&&goog.events.listen(n,goog.net.EventType.COMPLETE,e),n.send(o,t,r,g)},goog.net.IframeIo.getIframeByName=function(o){return window.frames[o]},goog.net.IframeIo.getInstanceByName=function(o){return goog.net.IframeIo.instances_[o]},goog.net.IframeIo.handleIncrementalData=function(o,e){var t=goog.string.endsWith(o.name,goog.net.IframeIo.INNER_FRAME_SUFFIX)?o.parent.name:o.name,r=t.substring(0,t.lastIndexOf("_")),g=goog.net.IframeIo.getInstanceByName(r);if(g&&t==g.iframeName_)g.handleIncrementalData_(e);else{var n=goog.log.getLogger("goog.net.IframeIo");goog.log.info(n,"Incremental iframe data routed for unknown iframe")}},goog.net.IframeIo.getNextName_=function(){return goog.net.IframeIo.FRAME_NAME_PREFIX+goog.net.IframeIo.counter_++},goog.net.IframeIo.getForm_=function(){if(!goog.net.IframeIo.form_){goog.net.IframeIo.form_=goog.dom.createDom(goog.dom.TagName.FORM),goog.net.IframeIo.form_.acceptCharset="utf-8";var o=goog.net.IframeIo.form_.style;o.position="absolute",o.visibility="hidden",o.top=o.left="-10px",o.width=o.height="10px",o.overflow="hidden",goog.dom.getDocument().body.appendChild(goog.net.IframeIo.form_)}return goog.net.IframeIo.form_},goog.net.IframeIo.addFormInputs_=function(o,e){var t=goog.dom.getDomHelper(o);goog.structs.forEach(e,function(e,r){goog.isArray(e)||(e=[e]),goog.array.forEach(e,function(e){var g=t.createDom(goog.dom.TagName.INPUT,{type:goog.dom.InputType.HIDDEN,name:r,value:e});o.appendChild(g)})})},goog.net.IframeIo.useIeReadyStateCodePath_=function(){return goog.userAgent.IE&&!goog.userAgent.isVersionOrHigher("11")},goog.net.IframeIo.prototype.logger_=goog.log.getLogger("goog.net.IframeIo"),goog.net.IframeIo.prototype.form_=null,goog.net.IframeIo.prototype.iframe_=null,goog.net.IframeIo.prototype.iframeName_=null,goog.net.IframeIo.prototype.nextIframeId_=0,goog.net.IframeIo.prototype.active_=!1,goog.net.IframeIo.prototype.complete_=!1,goog.net.IframeIo.prototype.success_=!1,goog.net.IframeIo.prototype.lastUri_=null,goog.net.IframeIo.prototype.lastContent_=null,goog.net.IframeIo.prototype.lastErrorCode_=goog.net.ErrorCode.NO_ERROR,goog.net.IframeIo.prototype.firefoxSilentErrorTimeout_=null,goog.net.IframeIo.prototype.iframeDisposalTimer_=null,goog.net.IframeIo.prototype.errorHandled_,goog.net.IframeIo.prototype.ignoreResponse_=!1,goog.net.IframeIo.prototype.errorChecker_,goog.net.IframeIo.prototype.lastCustomError_,goog.net.IframeIo.prototype.lastContentHtml_,goog.net.IframeIo.prototype.send=function(o,e,t,r){if(this.active_)throw new Error("[goog.net.IframeIo] Unable to send, already active.");var g=new goog.Uri(o);this.lastUri_=g;var n=e?e.toUpperCase():"GET";t&&g.makeUnique(),goog.log.info(this.logger_,"Sending iframe request: "+g+" ["+n+"]"),this.form_=goog.net.IframeIo.getForm_(),"GET"==n&&goog.net.IframeIo.addFormInputs_(this.form_,g.getQueryData()),r&&goog.net.IframeIo.addFormInputs_(this.form_,r),goog.dom.safe.setFormElementAction(this.form_,goog.html.legacyconversions.safeUrlFromString(g.toString())),this.form_.method=n,this.sendFormInternal_(),this.clearForm_()},goog.net.IframeIo.prototype.sendFromForm=function(o,e,t){if(this.active_)throw new Error("[goog.net.IframeIo] Unable to send, already active.");var r=new goog.Uri(e||o.action);t&&r.makeUnique(),goog.log.info(this.logger_,"Sending iframe request from form: "+r),this.lastUri_=r,this.form_=o,goog.dom.safe.setFormElementAction(goog.asserts.assert(this.form_),r.toString()),this.sendFormInternal_()},goog.net.IframeIo.prototype.abort=function(o){if(this.active_){goog.log.info(this.logger_,"Request aborted");var e=this.getRequestIframe();goog.asserts.assert(e),goog.events.removeAll(e),this.complete_=!1,this.active_=!1,this.success_=!1,this.lastErrorCode_=o||goog.net.ErrorCode.ABORT,this.dispatchEvent(goog.net.EventType.ABORT),this.makeReady_()}},goog.net.IframeIo.prototype.disposeInternal=function(){goog.log.fine(this.logger_,"Disposing iframeIo instance"),this.active_&&(goog.log.fine(this.logger_,"Aborting active request"),this.abort()),goog.net.IframeIo.superClass_.disposeInternal.call(this),this.iframe_&&this.scheduleIframeDisposal_(),this.disposeForm_(),delete this.errorChecker_,this.form_=null,this.lastCustomError_=this.lastContent_=this.lastContentHtml_=null,this.lastUri_=null,this.lastErrorCode_=goog.net.ErrorCode.NO_ERROR,delete goog.net.IframeIo.instances_[this.name_]},goog.net.IframeIo.prototype.isComplete=function(){return this.complete_},goog.net.IframeIo.prototype.isSuccess=function(){return this.success_},goog.net.IframeIo.prototype.isActive=function(){return this.active_},goog.net.IframeIo.prototype.getResponseText=function(){return this.lastContent_},goog.net.IframeIo.prototype.getResponseHtml=function(){return this.lastContentHtml_},goog.net.IframeIo.prototype.getResponseJson=function(){return goog.json.parse(this.lastContent_)},goog.net.IframeIo.prototype.getResponseXml=function(){return this.iframe_?this.getContentDocument_():null},goog.net.IframeIo.prototype.getLastUri=function(){return this.lastUri_},goog.net.IframeIo.prototype.getLastErrorCode=function(){return this.lastErrorCode_},goog.net.IframeIo.prototype.getLastError=function(){return goog.net.ErrorCode.getDebugMessage(this.lastErrorCode_)},goog.net.IframeIo.prototype.getLastCustomError=function(){return this.lastCustomError_},goog.net.IframeIo.prototype.setErrorChecker=function(o){this.errorChecker_=o},goog.net.IframeIo.prototype.getErrorChecker=function(){return this.errorChecker_},goog.net.IframeIo.prototype.isIgnoringResponse=function(){return this.ignoreResponse_},goog.net.IframeIo.prototype.setIgnoreResponse=function(o){this.ignoreResponse_=o},goog.net.IframeIo.prototype.sendFormInternal_=function(){if(this.active_=!0,this.complete_=!1,this.lastErrorCode_=goog.net.ErrorCode.NO_ERROR,this.createIframe_(),goog.net.IframeIo.useIeReadyStateCodePath_()){this.form_.target=this.iframeName_||"",this.appendIframe_(),this.ignoreResponse_||goog.events.listen(this.iframe_,goog.events.EventType.READYSTATECHANGE,this.onIeReadyStateChange_,!1,this);try{this.errorHandled_=!1,this.form_.submit()}catch(o){this.ignoreResponse_||goog.events.unlisten(this.iframe_,goog.events.EventType.READYSTATECHANGE,this.onIeReadyStateChange_,!1,this),this.handleError_(goog.net.ErrorCode.ACCESS_DENIED)}}else{goog.log.fine(this.logger_,"Setting up iframes and cloning form"),this.appendIframe_();var o,e=this.iframeName_+goog.net.IframeIo.INNER_FRAME_SUFFIX,t=goog.dom.getFrameContentDocument(this.iframe_);o=document.baseURI?goog.net.IframeIo.createIframeHtmlWithBaseUri_(e):goog.net.IframeIo.createIframeHtml_(e),goog.userAgent.OPERA&&!goog.userAgent.WEBKIT?goog.dom.safe.setInnerHtml(t.documentElement,o):goog.dom.safe.documentWrite(t,o),this.ignoreResponse_||goog.events.listen(t.getElementById(e),goog.events.EventType.LOAD,this.onIframeLoaded_,!1,this);for(var r=goog.dom.getElementsByTagName(goog.dom.TagName.TEXTAREA,goog.asserts.assert(this.form_)),g=0,n=r.length;g<n;g++){var a=r[g].value;goog.dom.getRawTextContent(r[g])!=a&&(goog.dom.setTextContent(r[g],a),r[g].value=a)}var s=t.importNode(goog.asserts.assert(this.form_),!0);s.target=e,s.action=this.form_.action,t.body.appendChild(s);var i=goog.dom.getElementsByTagName(goog.dom.TagName.SELECT,goog.asserts.assert(this.form_)),m=goog.dom.getElementsByTagName(goog.dom.TagName.SELECT,s);for(g=0,n=i.length;g<n;g++)for(var f=goog.dom.getElementsByTagName(goog.dom.TagName.OPTION,i[g]),I=goog.dom.getElementsByTagName(goog.dom.TagName.OPTION,m[g]),l=0,h=f.length;l<h;l++)I[l].selected=f[l].selected;var _=goog.dom.getElementsByTagName(goog.dom.TagName.INPUT,goog.asserts.assert(this.form_)),p=goog.dom.getElementsByTagName(goog.dom.TagName.INPUT,s);for(g=0,n=_.length;g<n;g++)if(_[g].type==goog.dom.InputType.FILE&&_[g].value!=p[g].value){goog.log.fine(this.logger_,"File input value not cloned properly.  Will submit using original form."),this.form_.target=e,s=this.form_;break}goog.log.fine(this.logger_,"Submitting form");try{this.errorHandled_=!1,s.submit(),t.close(),goog.userAgent.GECKO&&(this.firefoxSilentErrorTimeout_=goog.Timer.callOnce(this.testForFirefoxSilentError_,250,this))}catch(o){goog.log.error(this.logger_,"Error when submitting form: "+goog.debug.HtmlFormatter.exposeException(o)),this.ignoreResponse_||goog.events.unlisten(t.getElementById(e),goog.events.EventType.LOAD,this.onIframeLoaded_,!1,this),t.close(),this.handleError_(goog.net.ErrorCode.FILE_NOT_FOUND)}}},goog.net.IframeIo.createIframeHtml_=function(o){var e=goog.string.htmlEscape(o);return goog.html.uncheckedconversions.safeHtmlFromStringKnownToSatisfyTypeContract(goog.string.Const.from("Short HTML snippet, input escaped, for performance"),'<body><iframe id="'+e+'" name="'+e+'"></iframe>')},goog.net.IframeIo.createIframeHtmlWithBaseUri_=function(o){var e=goog.string.htmlEscape(o);return goog.html.uncheckedconversions.safeHtmlFromStringKnownToSatisfyTypeContract(goog.string.Const.from("Short HTML snippet, input escaped, safe URL, for performance"),'<head><base href="'+goog.string.htmlEscape(document.baseURI)+'"></head><body><iframe id="'+e+'" name="'+e+'"></iframe>')},goog.net.IframeIo.prototype.onIeReadyStateChange_=function(o){if("complete"==this.iframe_.readyState){var e;goog.events.unlisten(this.iframe_,goog.events.EventType.READYSTATECHANGE,this.onIeReadyStateChange_,!1,this);try{if(e=goog.dom.getFrameContentDocument(this.iframe_),goog.userAgent.IE&&"about:blank"==e.location&&!navigator.onLine)return void this.handleError_(goog.net.ErrorCode.OFFLINE)}catch(o){return void this.handleError_(goog.net.ErrorCode.ACCESS_DENIED)}this.handleLoad_(e)}},goog.net.IframeIo.prototype.onIframeLoaded_=function(o){if(!goog.userAgent.OPERA||goog.userAgent.WEBKIT||"about:blank"!=this.getContentDocument_().location){goog.events.unlisten(this.getRequestIframe(),goog.events.EventType.LOAD,this.onIframeLoaded_,!1,this);try{this.handleLoad_(this.getContentDocument_())}catch(o){this.handleError_(goog.net.ErrorCode.ACCESS_DENIED)}}},goog.net.IframeIo.prototype.handleLoad_=function(o){var e,t;goog.log.fine(this.logger_,"Iframe loaded"),this.complete_=!0,this.active_=!1;try{var r=o.body;this.lastContent_=r.textContent||r.innerText,this.lastContentHtml_=r.innerHTML}catch(o){e=goog.net.ErrorCode.ACCESS_DENIED}e||"function"!=typeof this.errorChecker_||(t=this.errorChecker_(o))&&(e=goog.net.ErrorCode.CUSTOM_ERROR),goog.log.log(this.logger_,goog.log.Level.FINER,"Last content: "+this.lastContent_),goog.log.log(this.logger_,goog.log.Level.FINER,"Last uri: "+this.lastUri_),e?(goog.log.fine(this.logger_,"Load event occurred but failed"),this.handleError_(e,t)):(goog.log.fine(this.logger_,"Load succeeded"),this.success_=!0,this.lastErrorCode_=goog.net.ErrorCode.NO_ERROR,this.dispatchEvent(goog.net.EventType.COMPLETE),this.dispatchEvent(goog.net.EventType.SUCCESS),this.makeReady_())},goog.net.IframeIo.prototype.handleError_=function(o,e){this.errorHandled_||(this.success_=!1,this.active_=!1,this.complete_=!0,this.lastErrorCode_=o,o==goog.net.ErrorCode.CUSTOM_ERROR&&(goog.asserts.assert(void 0!==e),this.lastCustomError_=e),this.dispatchEvent(goog.net.EventType.COMPLETE),this.dispatchEvent(goog.net.EventType.ERROR),this.makeReady_(),this.errorHandled_=!0)},goog.net.IframeIo.prototype.handleIncrementalData_=function(o){this.dispatchEvent(new goog.net.IframeIo.IncrementalDataEvent(o))},goog.net.IframeIo.prototype.makeReady_=function(){goog.log.info(this.logger_,"Ready for new requests"),this.scheduleIframeDisposal_(),this.disposeForm_(),this.dispatchEvent(goog.net.EventType.READY)},goog.net.IframeIo.prototype.createIframe_=function(){goog.log.fine(this.logger_,"Creating iframe"),this.iframeName_=this.name_+"_"+(this.nextIframeId_++).toString(36);var o=goog.dom.getDomHelper(this.form_);this.iframe_=o.createDom(goog.dom.TagName.IFRAME,{name:this.iframeName_,id:this.iframeName_}),goog.userAgent.IE&&Number(goog.userAgent.VERSION)<7&&goog.dom.safe.setFormElementAction(this.iframe_,goog.html.SafeUrl.fromConstant(goog.string.Const.from('javascript:""')));var e=this.iframe_.style;e.visibility="hidden",e.width=e.height="10px",e.display="none",goog.userAgent.WEBKIT?e.marginTop=e.marginLeft="-10px":(e.position="absolute",e.top=e.left="-10px")},goog.net.IframeIo.prototype.appendIframe_=function(){goog.dom.getDomHelper(this.form_).getDocument().body.appendChild(this.iframe_)},goog.net.IframeIo.prototype.scheduleIframeDisposal_=function(){var o=this.iframe_;o&&(o.onreadystatechange=null,o.onload=null,o.onerror=null,this.iframesForDisposal_.push(o)),this.iframeDisposalTimer_&&(goog.Timer.clear(this.iframeDisposalTimer_),this.iframeDisposalTimer_=null),goog.userAgent.GECKO||goog.userAgent.OPERA&&!goog.userAgent.WEBKIT?this.iframeDisposalTimer_=goog.Timer.callOnce(this.disposeIframes_,goog.net.IframeIo.IFRAME_DISPOSE_DELAY_MS,this):this.disposeIframes_(),this.iframe_=null,this.iframeName_=null},goog.net.IframeIo.prototype.disposeIframes_=function(){for(this.iframeDisposalTimer_&&(goog.Timer.clear(this.iframeDisposalTimer_),this.iframeDisposalTimer_=null);0!=this.iframesForDisposal_.length;){var o=this.iframesForDisposal_.pop();goog.log.info(this.logger_,"Disposing iframe"),goog.dom.removeNode(o)}},goog.net.IframeIo.prototype.clearForm_=function(){this.form_&&this.form_==goog.net.IframeIo.form_&&goog.dom.removeChildren(this.form_)},goog.net.IframeIo.prototype.disposeForm_=function(){this.clearForm_(),this.form_=null},goog.net.IframeIo.prototype.getContentDocument_=function(){return this.iframe_?goog.dom.getFrameContentDocument(this.getRequestIframe()):null},goog.net.IframeIo.prototype.getRequestIframe=function(){return this.iframe_?goog.net.IframeIo.useIeReadyStateCodePath_()?this.iframe_:goog.dom.getFrameContentDocument(this.iframe_).getElementById(this.iframeName_+goog.net.IframeIo.INNER_FRAME_SUFFIX):null},goog.net.IframeIo.prototype.testForFirefoxSilentError_=function(){if(this.active_){var o=this.getContentDocument_();if(o&&!goog.reflect.canAccessProperty(o,"documentUri"))return this.ignoreResponse_||goog.events.unlisten(this.getRequestIframe(),goog.events.EventType.LOAD,this.onIframeLoaded_,!1,this),void(navigator.onLine?(goog.log.warning(this.logger_,"Silent Firefox error detected"),this.handleError_(goog.net.ErrorCode.FF_SILENT_ERROR)):(goog.log.warning(this.logger_,"Firefox is offline so report offline error instead of silent error"),this.handleError_(goog.net.ErrorCode.OFFLINE)));this.firefoxSilentErrorTimeout_=goog.Timer.callOnce(this.testForFirefoxSilentError_,250,this)}},goog.net.IframeIo.IncrementalDataEvent=function(o){goog.events.Event.call(this,goog.net.EventType.INCREMENTAL_DATA),this.data=o},goog.inherits(goog.net.IframeIo.IncrementalDataEvent,goog.events.Event),goog.net.IframeIo.TEST_ONLY={getForm:goog.net.IframeIo.getForm_};