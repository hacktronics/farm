goog.provide("goog.net.FetchXmlHttp"),goog.provide("goog.net.FetchXmlHttpFactory"),goog.require("goog.asserts"),goog.require("goog.events.EventTarget"),goog.require("goog.functions"),goog.require("goog.log"),goog.require("goog.net.XhrLike"),goog.require("goog.net.XmlHttpFactory"),goog.net.FetchXmlHttpFactory=function(t){goog.net.FetchXmlHttpFactory.base(this,"constructor"),this.worker_=t,this.credentialsMode_=void 0,this.cacheMode_=void 0},goog.inherits(goog.net.FetchXmlHttpFactory,goog.net.XmlHttpFactory),goog.net.FetchXmlHttpFactory.prototype.createInstance=function(){var t=new goog.net.FetchXmlHttp(this.worker_);return this.credentialsMode_&&t.setCredentialsMode(this.credentialsMode_),this.cacheMode_&&t.setCacheMode(this.cacheMode_),t},goog.net.FetchXmlHttpFactory.prototype.internalGetOptions=goog.functions.constant({}),goog.net.FetchXmlHttpFactory.prototype.setCredentialsMode=function(t){this.credentialsMode_=t},goog.net.FetchXmlHttpFactory.prototype.setCacheMode=function(t){this.cacheMode_=t},goog.net.FetchXmlHttp=function(t){goog.net.FetchXmlHttp.base(this,"constructor"),this.worker_=t,this.credentialsMode_=void 0,this.cacheMode_=void 0,this.readyState=goog.net.FetchXmlHttp.RequestState.UNSENT,this.status=0,this.statusText="",this.response="",this.responseText="",this.responseType="",this.responseXML=null,this.onreadystatechange=null,this.requestHeaders_=new Headers,this.responseHeaders_=null,this.method_="GET",this.url_="",this.inProgress_=!1,this.logger_=goog.log.getLogger("goog.net.FetchXmlHttp"),this.fetchResponse_=null,this.currentReader_=null,this.textDecoder_=null},goog.inherits(goog.net.FetchXmlHttp,goog.events.EventTarget),goog.net.FetchXmlHttp.RequestState={UNSENT:0,OPENED:1,HEADER_RECEIVED:2,LOADING:3,DONE:4},goog.net.FetchXmlHttp.prototype.open=function(t,e,o){if(goog.asserts.assert(!!o,"Only async requests are supported."),this.readyState!=goog.net.FetchXmlHttp.RequestState.UNSENT)throw this.abort(),new Error("Error reopening a connection");this.method_=t,this.url_=e,this.readyState=goog.net.FetchXmlHttp.RequestState.OPENED,this.dispatchCallback_()},goog.net.FetchXmlHttp.prototype.send=function(t){if(this.readyState!=goog.net.FetchXmlHttp.RequestState.OPENED)throw this.abort(),new Error("need to call open() first. ");this.inProgress_=!0;var e={headers:this.requestHeaders_,method:this.method_,credentials:this.credentialsMode_,cache:this.cacheMode_};t&&(e.body=t),this.worker_.fetch(new Request(this.url_,e)).then(this.handleResponse_.bind(this),this.handleSendFailure_.bind(this))},goog.net.FetchXmlHttp.prototype.abort=function(){this.response=this.responseText="",this.requestHeaders_=new Headers,this.status=0,this.currentReader_&&this.currentReader_.cancel("Request was aborted."),this.readyState>=goog.net.FetchXmlHttp.RequestState.OPENED&&this.inProgress_&&this.readyState!=goog.net.FetchXmlHttp.RequestState.DONE&&(this.inProgress_=!1,this.requestDone_(!1)),this.readyState=goog.net.FetchXmlHttp.RequestState.UNSENT},goog.net.FetchXmlHttp.prototype.handleResponse_=function(t){this.inProgress_&&(this.fetchResponse_=t,this.responseHeaders_||(this.responseHeaders_=t.headers,this.readyState=goog.net.FetchXmlHttp.RequestState.HEADER_RECEIVED,this.dispatchCallback_()),this.inProgress_&&(this.readyState=goog.net.FetchXmlHttp.RequestState.LOADING,this.dispatchCallback_(),this.inProgress_&&("arraybuffer"===this.responseType?t.arrayBuffer().then(this.handleResponseArrayBuffer_.bind(this),this.handleSendFailure_.bind(this)):void 0!==goog.global.ReadableStream&&"body"in t?(this.response=this.responseText="",this.currentReader_=t.body.getReader(),this.textDecoder_=new TextDecoder,this.readInputFromFetch_()):t.text().then(this.handleResponseText_.bind(this),this.handleSendFailure_.bind(this)))))},goog.net.FetchXmlHttp.prototype.readInputFromFetch_=function(){this.currentReader_.read().then(this.handleDataFromStream_.bind(this)).catch(this.handleSendFailure_.bind(this))},goog.net.FetchXmlHttp.prototype.handleDataFromStream_=function(t){if(this.inProgress_){var e=t.value?t.value:new Uint8Array(0),o=this.textDecoder_.decode(e,{stream:!t.done});o&&(this.responseText+=o,this.response=this.responseText),t.done?this.requestDone_(!0):this.dispatchCallback_(),this.readyState==goog.net.FetchXmlHttp.RequestState.LOADING&&this.readInputFromFetch_()}},goog.net.FetchXmlHttp.prototype.handleResponseText_=function(t){this.inProgress_&&(this.response=this.responseText=t,this.requestDone_(!0))},goog.net.FetchXmlHttp.prototype.handleResponseArrayBuffer_=function(t){this.inProgress_&&(this.response=t,this.requestDone_(!0))},goog.net.FetchXmlHttp.prototype.handleSendFailure_=function(t){var e=t instanceof Error?t:Error(t);goog.log.warning(this.logger_,"Failed to fetch url "+this.url_,e),this.inProgress_&&this.requestDone_(!0)},goog.net.FetchXmlHttp.prototype.requestDone_=function(t){t&&this.fetchResponse_&&(this.status=this.fetchResponse_.status,this.statusText=this.fetchResponse_.statusText),this.readyState=goog.net.FetchXmlHttp.RequestState.DONE,this.fetchResponse_=null,this.currentReader_=null,this.textDecoder_=null,this.dispatchCallback_()},goog.net.FetchXmlHttp.prototype.setRequestHeader=function(t,e){this.requestHeaders_.append(t,e)},goog.net.FetchXmlHttp.prototype.getResponseHeader=function(t){return this.responseHeaders_?this.responseHeaders_.get(t.toLowerCase())||"":(goog.log.warning(this.logger_,"Attempting to get response header but no headers have been received for url: "+this.url_),"")},goog.net.FetchXmlHttp.prototype.getAllResponseHeaders=function(){if(!this.responseHeaders_)return goog.log.warning(this.logger_,"Attempting to get all response headers but no headers have been received for url: "+this.url_),"";for(var t=[],e=this.responseHeaders_.entries(),o=e.next();!o.done;){var s=o.value;t.push(s[0]+": "+s[1]),o=e.next()}return t.join("\r\n")},goog.net.FetchXmlHttp.prototype.setCredentialsMode=function(t){this.credentialsMode_=t},goog.net.FetchXmlHttp.prototype.setCacheMode=function(t){this.cacheMode_=t},goog.net.FetchXmlHttp.prototype.dispatchCallback_=function(){this.onreadystatechange&&this.onreadystatechange.call(this)};