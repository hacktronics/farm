goog.provide("goog.net.ChannelRequest"),goog.provide("goog.net.ChannelRequest.Error"),goog.forwardDeclare("goog.Uri"),goog.forwardDeclare("goog.net.BrowserChannel"),goog.forwardDeclare("goog.net.BrowserTestChannel"),goog.forwardDeclare("goog.net.ChannelDebug"),goog.forwardDeclare("goog.net.XhrIo"),goog.require("goog.Timer"),goog.require("goog.async.Throttle"),goog.require("goog.dom.TagName"),goog.require("goog.dom.safe"),goog.require("goog.events.EventHandler"),goog.require("goog.html.SafeUrl"),goog.require("goog.html.uncheckedconversions"),goog.require("goog.net.ErrorCode"),goog.require("goog.net.EventType"),goog.require("goog.net.XmlHttp"),goog.require("goog.object"),goog.require("goog.string"),goog.require("goog.string.Const"),goog.require("goog.userAgent"),goog.net.ChannelRequest=function(e,t,n,o,s){this.channel_=e,this.channelDebug_=t,this.sid_=n,this.rid_=o,this.retryId_=s||1,this.timeout_=goog.net.ChannelRequest.TIMEOUT_MS,this.eventHandler_=new goog.events.EventHandler(this),this.pollingTimer_=new goog.Timer,this.pollingTimer_.setInterval(goog.net.ChannelRequest.POLLING_INTERVAL_MS)},goog.net.ChannelRequest.prototype.extraHeaders_=null,goog.net.ChannelRequest.prototype.successful_=!1,goog.net.ChannelRequest.prototype.watchDogTimerId_=null,goog.net.ChannelRequest.prototype.watchDogTimeoutTime_=null,goog.net.ChannelRequest.prototype.requestStartTime_=null,goog.net.ChannelRequest.prototype.type_=null,goog.net.ChannelRequest.prototype.baseUri_=null,goog.net.ChannelRequest.prototype.requestUri_=null,goog.net.ChannelRequest.prototype.postData_=null,goog.net.ChannelRequest.prototype.xmlHttp_=null,goog.net.ChannelRequest.prototype.xmlHttpChunkStart_=0,goog.net.ChannelRequest.prototype.trident_=null,goog.net.ChannelRequest.prototype.verb_=null,goog.net.ChannelRequest.prototype.lastError_=null,goog.net.ChannelRequest.prototype.lastStatusCode_=-1,goog.net.ChannelRequest.prototype.sendClose_=!0,goog.net.ChannelRequest.prototype.cancelled_=!1,goog.net.ChannelRequest.prototype.readyStateChangeThrottleMs_=0,goog.net.ChannelRequest.prototype.readyStateChangeThrottle_=null,goog.net.ChannelRequest.TIMEOUT_MS=45e3,goog.net.ChannelRequest.POLLING_INTERVAL_MS=250,goog.net.ChannelRequest.MIN_WEBKIT_FOR_INTERACTIVE_="420+",goog.net.ChannelRequest.Type_={XML_HTTP:1,IMG:2,TRIDENT:3},goog.net.ChannelRequest.Error={STATUS:0,NO_DATA:1,TIMEOUT:2,UNKNOWN_SESSION_ID:3,BAD_DATA:4,HANDLER_EXCEPTION:5,BROWSER_OFFLINE:6,ACTIVE_X_BLOCKED:7},goog.net.ChannelRequest.errorStringFromCode=function(e,t){switch(e){case goog.net.ChannelRequest.Error.STATUS:return"Non-200 return code ("+t+")";case goog.net.ChannelRequest.Error.NO_DATA:return"XMLHTTP failure (no data)";case goog.net.ChannelRequest.Error.TIMEOUT:return"HttpConnection timeout";default:return"Unknown error"}},goog.net.ChannelRequest.INVALID_CHUNK_={},goog.net.ChannelRequest.INCOMPLETE_CHUNK_={},goog.net.ChannelRequest.supportsXhrStreaming=function(){return!goog.userAgent.IE||goog.userAgent.isDocumentModeOrHigher(10)},goog.net.ChannelRequest.prototype.setExtraHeaders=function(e){this.extraHeaders_=e},goog.net.ChannelRequest.prototype.setTimeout=function(e){this.timeout_=e},goog.net.ChannelRequest.prototype.setReadyStateChangeThrottle=function(e){this.readyStateChangeThrottleMs_=e},goog.net.ChannelRequest.prototype.xmlHttpPost=function(e,t,n){this.type_=goog.net.ChannelRequest.Type_.XML_HTTP,this.baseUri_=e.clone().makeUnique(),this.postData_=t,this.decodeChunks_=n,this.sendXmlHttp_(null)},goog.net.ChannelRequest.prototype.xmlHttpGet=function(e,t,n,o){this.type_=goog.net.ChannelRequest.Type_.XML_HTTP,this.baseUri_=e.clone().makeUnique(),this.postData_=null,this.decodeChunks_=t,o&&(this.sendClose_=!1),this.sendXmlHttp_(n)},goog.net.ChannelRequest.prototype.sendXmlHttp_=function(e){this.requestStartTime_=goog.now(),this.ensureWatchDogTimer_(),this.requestUri_=this.baseUri_.clone(),this.requestUri_.setParameterValues("t",this.retryId_),this.xmlHttpChunkStart_=0;var t=this.channel_.shouldUseSecondaryDomains();this.xmlHttp_=this.channel_.createXhrIo(t?e:null),this.readyStateChangeThrottleMs_>0&&(this.readyStateChangeThrottle_=new goog.async.Throttle(goog.bind(this.xmlHttpHandler_,this,this.xmlHttp_),this.readyStateChangeThrottleMs_)),this.eventHandler_.listen(this.xmlHttp_,goog.net.EventType.READY_STATE_CHANGE,this.readyStateChangeHandler_);var n=this.extraHeaders_?goog.object.clone(this.extraHeaders_):{};this.postData_?(this.verb_="POST",n["Content-Type"]="application/x-www-form-urlencoded",this.xmlHttp_.send(this.requestUri_,this.verb_,this.postData_,n)):(this.verb_="GET",this.sendClose_&&!goog.userAgent.WEBKIT&&(n.Connection="close"),this.xmlHttp_.send(this.requestUri_,this.verb_,null,n)),this.channel_.notifyServerReachabilityEvent(goog.net.BrowserChannel.ServerReachability.REQUEST_MADE),this.channelDebug_.xmlHttpChannelRequest(this.verb_,this.requestUri_,this.rid_,this.retryId_,this.postData_)},goog.net.ChannelRequest.prototype.readyStateChangeHandler_=function(e){var t=e.target,n=this.readyStateChangeThrottle_;n&&t.getReadyState()==goog.net.XmlHttp.ReadyState.INTERACTIVE?(this.channelDebug_.debug("Throttling readystatechange."),n.fire()):this.xmlHttpHandler_(t)},goog.net.ChannelRequest.prototype.xmlHttpHandler_=function(e){goog.net.BrowserChannel.onStartExecution();try{e==this.xmlHttp_?this.onXmlHttpReadyStateChanged_():this.channelDebug_.warning("Called back with an unexpected xmlhttp")}catch(e){this.channelDebug_.debug("Failed call to OnXmlHttpReadyStateChanged_"),this.xmlHttp_&&this.xmlHttp_.getResponseText()?this.channelDebug_.dumpException(e,"ResponseText: "+this.xmlHttp_.getResponseText()):this.channelDebug_.dumpException(e,"No response text")}finally{goog.net.BrowserChannel.onEndExecution()}},goog.net.ChannelRequest.prototype.onXmlHttpReadyStateChanged_=function(){var e=this.xmlHttp_.getReadyState(),t=this.xmlHttp_.getLastErrorCode(),n=this.xmlHttp_.getStatus();if(!goog.net.ChannelRequest.supportsXhrStreaming()||goog.userAgent.WEBKIT&&!goog.userAgent.isVersionOrHigher(goog.net.ChannelRequest.MIN_WEBKIT_FOR_INTERACTIVE_)){if(e<goog.net.XmlHttp.ReadyState.COMPLETE)return}else if(e<goog.net.XmlHttp.ReadyState.INTERACTIVE||e==goog.net.XmlHttp.ReadyState.INTERACTIVE&&!goog.userAgent.OPERA&&!this.xmlHttp_.getResponseText())return;this.cancelled_||e!=goog.net.XmlHttp.ReadyState.COMPLETE||t==goog.net.ErrorCode.ABORT||(t==goog.net.ErrorCode.TIMEOUT||n<=0?this.channel_.notifyServerReachabilityEvent(goog.net.BrowserChannel.ServerReachability.REQUEST_FAILED):this.channel_.notifyServerReachabilityEvent(goog.net.BrowserChannel.ServerReachability.REQUEST_SUCCEEDED)),this.cancelWatchDogTimer_();var o=this.xmlHttp_.getStatus();this.lastStatusCode_=o;var s=this.xmlHttp_.getResponseText();if(s||this.channelDebug_.debug("No response text for uri "+this.requestUri_+" status "+o),this.successful_=200==o,this.channelDebug_.xmlHttpChannelResponseMetaData(this.verb_,this.requestUri_,this.rid_,this.retryId_,e,o),!this.successful_)return 400==o&&s.indexOf("Unknown SID")>0?(this.lastError_=goog.net.ChannelRequest.Error.UNKNOWN_SESSION_ID,goog.net.BrowserChannel.notifyStatEvent(goog.net.BrowserChannel.Stat.REQUEST_UNKNOWN_SESSION_ID),this.channelDebug_.warning("XMLHTTP Unknown SID ("+this.rid_+")")):(this.lastError_=goog.net.ChannelRequest.Error.STATUS,goog.net.BrowserChannel.notifyStatEvent(goog.net.BrowserChannel.Stat.REQUEST_BAD_STATUS),this.channelDebug_.warning("XMLHTTP Bad status "+o+" ("+this.rid_+")")),this.cleanup_(),void this.dispatchFailure_();e==goog.net.XmlHttp.ReadyState.COMPLETE&&this.cleanup_(),this.decodeChunks_?(this.decodeNextChunks_(e,s),goog.userAgent.OPERA&&this.successful_&&e==goog.net.XmlHttp.ReadyState.INTERACTIVE&&this.startPolling_()):(this.channelDebug_.xmlHttpChannelResponseText(this.rid_,s,null),this.safeOnRequestData_(s)),this.successful_&&(this.cancelled_||(e==goog.net.XmlHttp.ReadyState.COMPLETE?this.channel_.onRequestComplete(this):(this.successful_=!1,this.ensureWatchDogTimer_())))},goog.net.ChannelRequest.prototype.decodeNextChunks_=function(e,t){for(var n=!0;!this.cancelled_&&this.xmlHttpChunkStart_<t.length;){var o=this.getNextChunk_(t);if(o==goog.net.ChannelRequest.INCOMPLETE_CHUNK_){e==goog.net.XmlHttp.ReadyState.COMPLETE&&(this.lastError_=goog.net.ChannelRequest.Error.BAD_DATA,goog.net.BrowserChannel.notifyStatEvent(goog.net.BrowserChannel.Stat.REQUEST_INCOMPLETE_DATA),n=!1),this.channelDebug_.xmlHttpChannelResponseText(this.rid_,null,"[Incomplete Response]");break}if(o==goog.net.ChannelRequest.INVALID_CHUNK_){this.lastError_=goog.net.ChannelRequest.Error.BAD_DATA,goog.net.BrowserChannel.notifyStatEvent(goog.net.BrowserChannel.Stat.REQUEST_BAD_DATA),this.channelDebug_.xmlHttpChannelResponseText(this.rid_,t,"[Invalid Chunk]"),n=!1;break}this.channelDebug_.xmlHttpChannelResponseText(this.rid_,o,null),this.safeOnRequestData_(o)}e==goog.net.XmlHttp.ReadyState.COMPLETE&&0==t.length&&(this.lastError_=goog.net.ChannelRequest.Error.NO_DATA,goog.net.BrowserChannel.notifyStatEvent(goog.net.BrowserChannel.Stat.REQUEST_NO_DATA),n=!1),this.successful_=this.successful_&&n,n||(this.channelDebug_.xmlHttpChannelResponseText(this.rid_,t,"[Invalid Chunked Response]"),this.cleanup_(),this.dispatchFailure_())},goog.net.ChannelRequest.prototype.pollResponse_=function(){var e=this.xmlHttp_.getReadyState(),t=this.xmlHttp_.getResponseText();this.xmlHttpChunkStart_<t.length&&(this.cancelWatchDogTimer_(),this.decodeNextChunks_(e,t),this.successful_&&e!=goog.net.XmlHttp.ReadyState.COMPLETE&&this.ensureWatchDogTimer_())},goog.net.ChannelRequest.prototype.startPolling_=function(){this.eventHandler_.listen(this.pollingTimer_,goog.Timer.TICK,this.pollResponse_),this.pollingTimer_.start()},goog.net.ChannelRequest.prototype.getNextChunk_=function(e){var t=this.xmlHttpChunkStart_,n=e.indexOf("\n",t);if(-1==n)return goog.net.ChannelRequest.INCOMPLETE_CHUNK_;var o=e.substring(t,n),s=Number(o);if(isNaN(s))return goog.net.ChannelRequest.INVALID_CHUNK_;var r=n+1;if(r+s>e.length)return goog.net.ChannelRequest.INCOMPLETE_CHUNK_;var i=e.substr(r,s);return this.xmlHttpChunkStart_=r+s,i},goog.net.ChannelRequest.prototype.tridentGet=function(e,t){this.type_=goog.net.ChannelRequest.Type_.TRIDENT,this.baseUri_=e.clone().makeUnique(),this.tridentGet_(t)},goog.net.ChannelRequest.prototype.tridentGet_=function(e){this.requestStartTime_=goog.now(),this.ensureWatchDogTimer_();var t=e?window.location.hostname:"";this.requestUri_=this.baseUri_.clone(),this.requestUri_.setParameterValue("DOMAIN",t),this.requestUri_.setParameterValue("t",this.retryId_);try{this.trident_=new ActiveXObject("htmlfile")}catch(e){return this.channelDebug_.severe("ActiveX blocked"),this.cleanup_(),this.lastError_=goog.net.ChannelRequest.Error.ACTIVE_X_BLOCKED,goog.net.BrowserChannel.notifyStatEvent(goog.net.BrowserChannel.Stat.ACTIVE_X_BLOCKED),void this.dispatchFailure_()}var n="<html><body>";e&&(n+='<script>document.domain="'+goog.net.ChannelRequest.escapeForStringInScript_(t)+'"<\/script>');n+="</body></html>";var o=goog.html.uncheckedconversions.safeHtmlFromStringKnownToSatisfyTypeContract(goog.string.Const.from("b/12014412"),n);this.trident_.open(),goog.dom.safe.documentWrite(this.trident_,o),this.trident_.close(),this.trident_.parentWindow.m=goog.bind(this.onTridentRpcMessage_,this),this.trident_.parentWindow.d=goog.bind(this.onTridentDone_,this,!0),this.trident_.parentWindow.rpcClose=goog.bind(this.onTridentDone_,this,!1);var s=this.trident_.createElement(String(goog.dom.TagName.DIV));this.trident_.parentWindow.document.body.appendChild(s);var r=goog.html.SafeUrl.sanitize(this.requestUri_.toString()),i=goog.string.htmlEscape(goog.html.SafeUrl.unwrap(r)),a=goog.html.uncheckedconversions.safeHtmlFromStringKnownToSatisfyTypeContract(goog.string.Const.from("b/12014412"),'<iframe src="'+i+'"></iframe>');goog.dom.safe.setInnerHtml(s,a),this.channelDebug_.tridentChannelRequest("GET",this.requestUri_,this.rid_,this.retryId_),this.channel_.notifyServerReachabilityEvent(goog.net.BrowserChannel.ServerReachability.REQUEST_MADE)},goog.net.ChannelRequest.escapeForStringInScript_=function(e){for(var t="",n=0;n<e.length;n++){var o=e.charAt(n);t+="<"==o?"\\x3c":">"==o?"\\x3e":goog.string.escapeChar(o)}return t},goog.net.ChannelRequest.prototype.onTridentRpcMessage_=function(e){goog.net.BrowserChannel.setTimeout(goog.bind(this.onTridentRpcMessageAsync_,this,e),0)},goog.net.ChannelRequest.prototype.onTridentRpcMessageAsync_=function(e){this.cancelled_||(this.channelDebug_.tridentChannelResponseText(this.rid_,e),this.cancelWatchDogTimer_(),this.safeOnRequestData_(e),this.ensureWatchDogTimer_())},goog.net.ChannelRequest.prototype.onTridentDone_=function(e){goog.net.BrowserChannel.setTimeout(goog.bind(this.onTridentDoneAsync_,this,e),0)},goog.net.ChannelRequest.prototype.onTridentDoneAsync_=function(e){this.cancelled_||(this.channelDebug_.tridentChannelResponseDone(this.rid_,e),this.cleanup_(),this.successful_=e,this.channel_.onRequestComplete(this),this.channel_.notifyServerReachabilityEvent(goog.net.BrowserChannel.ServerReachability.BACK_CHANNEL_ACTIVITY))},goog.net.ChannelRequest.prototype.sendUsingImgTag=function(e){this.type_=goog.net.ChannelRequest.Type_.IMG,this.baseUri_=e.clone().makeUnique(),this.imgTagGet_()},goog.net.ChannelRequest.prototype.imgTagGet_=function(){goog.dom.safe.setImageSrc(new Image,this.baseUri_.toString()),this.requestStartTime_=goog.now(),this.ensureWatchDogTimer_()},goog.net.ChannelRequest.prototype.cancel=function(){this.cancelled_=!0,this.cleanup_()},goog.net.ChannelRequest.prototype.ensureWatchDogTimer_=function(){this.watchDogTimeoutTime_=goog.now()+this.timeout_,this.startWatchDogTimer_(this.timeout_)},goog.net.ChannelRequest.prototype.startWatchDogTimer_=function(e){if(null!=this.watchDogTimerId_)throw new Error("WatchDog timer not null");this.watchDogTimerId_=goog.net.BrowserChannel.setTimeout(goog.bind(this.onWatchDogTimeout_,this),e)},goog.net.ChannelRequest.prototype.cancelWatchDogTimer_=function(){this.watchDogTimerId_&&(goog.global.clearTimeout(this.watchDogTimerId_),this.watchDogTimerId_=null)},goog.net.ChannelRequest.prototype.onWatchDogTimeout_=function(){this.watchDogTimerId_=null;var e=goog.now();e-this.watchDogTimeoutTime_>=0?this.handleTimeout_():(this.channelDebug_.warning("WatchDog timer called too early"),this.startWatchDogTimer_(this.watchDogTimeoutTime_-e))},goog.net.ChannelRequest.prototype.handleTimeout_=function(){this.successful_&&this.channelDebug_.severe("Received watchdog timeout even though request loaded successfully"),this.channelDebug_.timeoutResponse(this.requestUri_),this.type_!=goog.net.ChannelRequest.Type_.IMG&&this.channel_.notifyServerReachabilityEvent(goog.net.BrowserChannel.ServerReachability.REQUEST_FAILED),this.cleanup_(),this.lastError_=goog.net.ChannelRequest.Error.TIMEOUT,goog.net.BrowserChannel.notifyStatEvent(goog.net.BrowserChannel.Stat.REQUEST_TIMEOUT),this.dispatchFailure_()},goog.net.ChannelRequest.prototype.dispatchFailure_=function(){this.channel_.isClosed()||this.cancelled_||this.channel_.onRequestComplete(this)},goog.net.ChannelRequest.prototype.cleanup_=function(){if(this.cancelWatchDogTimer_(),goog.dispose(this.readyStateChangeThrottle_),this.readyStateChangeThrottle_=null,this.pollingTimer_.stop(),this.eventHandler_.removeAll(),this.xmlHttp_){var e=this.xmlHttp_;this.xmlHttp_=null,e.abort(),e.dispose()}this.trident_&&(this.trident_=null)},goog.net.ChannelRequest.prototype.getSuccess=function(){return this.successful_},goog.net.ChannelRequest.prototype.getLastError=function(){return this.lastError_},goog.net.ChannelRequest.prototype.getLastStatusCode=function(){return this.lastStatusCode_},goog.net.ChannelRequest.prototype.getSessionId=function(){return this.sid_},goog.net.ChannelRequest.prototype.getRequestId=function(){return this.rid_},goog.net.ChannelRequest.prototype.getPostData=function(){return this.postData_},goog.net.ChannelRequest.prototype.getRequestStartTime=function(){return this.requestStartTime_},goog.net.ChannelRequest.prototype.safeOnRequestData_=function(e){try{this.channel_.onRequestData(this,e),this.channel_.notifyServerReachabilityEvent(goog.net.BrowserChannel.ServerReachability.BACK_CHANNEL_ACTIVITY)}catch(e){this.channelDebug_.dumpException(e,"Error in httprequest callback")}};