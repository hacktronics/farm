goog.provide("goog.net.XhrIo"),goog.provide("goog.net.XhrIo.ResponseType"),goog.forwardDeclare("goog.Uri"),goog.require("goog.Timer"),goog.require("goog.array"),goog.require("goog.asserts"),goog.require("goog.debug.entryPointRegistry"),goog.require("goog.events.EventTarget"),goog.require("goog.json.hybrid"),goog.require("goog.log"),goog.require("goog.net.ErrorCode"),goog.require("goog.net.EventType"),goog.require("goog.net.HttpStatus"),goog.require("goog.net.XmlHttp"),goog.require("goog.object"),goog.require("goog.string"),goog.require("goog.structs"),goog.require("goog.structs.Map"),goog.require("goog.uri.utils"),goog.require("goog.userAgent"),goog.scope(function(){goog.net.XhrIo=function(e){t.base(this,"constructor"),this.headers=new goog.structs.Map,this.xmlHttpFactory_=e||null,this.active_=!1,this.xhr_=null,this.xhrOptions_=null,this.lastUri_="",this.lastMethod_="",this.lastErrorCode_=goog.net.ErrorCode.NO_ERROR,this.lastError_="",this.errorDispatched_=!1,this.inSend_=!1,this.inOpen_=!1,this.inAbort_=!1,this.timeoutInterval_=0,this.timeoutId_=null,this.responseType_=o.DEFAULT,this.withCredentials_=!1,this.progressEventsEnabled_=!1,this.useXhr2Timeout_=!1},goog.inherits(goog.net.XhrIo,goog.events.EventTarget);var t=goog.net.XhrIo;goog.net.XhrIo.ResponseType={DEFAULT:"",TEXT:"text",DOCUMENT:"document",BLOB:"blob",ARRAY_BUFFER:"arraybuffer"};var o=goog.net.XhrIo.ResponseType;goog.net.XhrIo.prototype.logger_=goog.log.getLogger("goog.net.XhrIo"),goog.net.XhrIo.CONTENT_TYPE_HEADER="Content-Type",goog.net.XhrIo.CONTENT_TRANSFER_ENCODING="Content-Transfer-Encoding",goog.net.XhrIo.HTTP_SCHEME_PATTERN=/^https?$/i,goog.net.XhrIo.METHODS_WITH_FORM_DATA=["POST","PUT"],goog.net.XhrIo.FORM_CONTENT_TYPE="application/x-www-form-urlencoded;charset=utf-8",goog.net.XhrIo.XHR2_TIMEOUT_="timeout",goog.net.XhrIo.XHR2_ON_TIMEOUT_="ontimeout",goog.net.XhrIo.sendInstances_=[],goog.net.XhrIo.send=function(t,o,e,r,n,s,g){var i=new goog.net.XhrIo;return goog.net.XhrIo.sendInstances_.push(i),o&&i.listen(goog.net.EventType.COMPLETE,o),i.listenOnce(goog.net.EventType.READY,i.cleanupSend_),s&&i.setTimeoutInterval(s),g&&i.setWithCredentials(g),i.send(t,e,r,n),i},goog.net.XhrIo.cleanup=function(){for(var t=goog.net.XhrIo.sendInstances_;t.length;)t.pop().dispose()},goog.net.XhrIo.protectEntryPoints=function(t){goog.net.XhrIo.prototype.onReadyStateChangeEntryPoint_=t.protectEntryPoint(goog.net.XhrIo.prototype.onReadyStateChangeEntryPoint_)},goog.net.XhrIo.prototype.cleanupSend_=function(){this.dispose(),goog.array.remove(goog.net.XhrIo.sendInstances_,this)},goog.net.XhrIo.prototype.getTimeoutInterval=function(){return this.timeoutInterval_},goog.net.XhrIo.prototype.setTimeoutInterval=function(t){this.timeoutInterval_=Math.max(0,t)},goog.net.XhrIo.prototype.setResponseType=function(t){this.responseType_=t},goog.net.XhrIo.prototype.getResponseType=function(){return this.responseType_},goog.net.XhrIo.prototype.setWithCredentials=function(t){this.withCredentials_=t},goog.net.XhrIo.prototype.getWithCredentials=function(){return this.withCredentials_},goog.net.XhrIo.prototype.setProgressEventsEnabled=function(t){this.progressEventsEnabled_=t},goog.net.XhrIo.prototype.getProgressEventsEnabled=function(){return this.progressEventsEnabled_},goog.net.XhrIo.prototype.send=function(t,o,e,r){if(this.xhr_)throw new Error("[goog.net.XhrIo] Object is active with another request="+this.lastUri_+"; newUri="+t);var n=o?o.toUpperCase():"GET";this.lastUri_=t,this.lastError_="",this.lastErrorCode_=goog.net.ErrorCode.NO_ERROR,this.lastMethod_=n,this.errorDispatched_=!1,this.active_=!0,this.xhr_=this.createXhr(),this.xhrOptions_=this.xmlHttpFactory_?this.xmlHttpFactory_.getOptions():goog.net.XmlHttp.getOptions(),this.xhr_.onreadystatechange=goog.bind(this.onReadyStateChange_,this),this.getProgressEventsEnabled()&&"onprogress"in this.xhr_&&(this.xhr_.onprogress=goog.bind(function(t){this.onProgressHandler_(t,!0)},this),this.xhr_.upload&&(this.xhr_.upload.onprogress=goog.bind(this.onProgressHandler_,this)));try{goog.log.fine(this.logger_,this.formatMsg_("Opening Xhr")),this.inOpen_=!0,this.xhr_.open(n,String(t),!0),this.inOpen_=!1}catch(t){return goog.log.fine(this.logger_,this.formatMsg_("Error opening Xhr: "+t.message)),void this.error_(goog.net.ErrorCode.EXCEPTION,t)}var s=e||"",g=this.headers.clone();r&&goog.structs.forEach(r,function(t,o){g.set(o,t)});var i=goog.array.find(g.getKeys(),goog.net.XhrIo.isContentTypeHeader_),h=goog.global.FormData&&s instanceof goog.global.FormData;!goog.array.contains(goog.net.XhrIo.METHODS_WITH_FORM_DATA,n)||i||h||g.set(goog.net.XhrIo.CONTENT_TYPE_HEADER,goog.net.XhrIo.FORM_CONTENT_TYPE),g.forEach(function(t,o){this.xhr_.setRequestHeader(o,t)},this),this.responseType_&&(this.xhr_.responseType=this.responseType_),"withCredentials"in this.xhr_&&this.xhr_.withCredentials!==this.withCredentials_&&(this.xhr_.withCredentials=this.withCredentials_);try{this.cleanUpTimeoutTimer_(),this.timeoutInterval_>0&&(this.useXhr2Timeout_=goog.net.XhrIo.shouldUseXhr2Timeout_(this.xhr_),goog.log.fine(this.logger_,this.formatMsg_("Will abort after "+this.timeoutInterval_+"ms if incomplete, xhr2 "+this.useXhr2Timeout_)),this.useXhr2Timeout_?(this.xhr_[goog.net.XhrIo.XHR2_TIMEOUT_]=this.timeoutInterval_,this.xhr_[goog.net.XhrIo.XHR2_ON_TIMEOUT_]=goog.bind(this.timeout_,this)):this.timeoutId_=goog.Timer.callOnce(this.timeout_,this.timeoutInterval_,this)),goog.log.fine(this.logger_,this.formatMsg_("Sending request")),this.inSend_=!0,this.xhr_.send(s),this.inSend_=!1}catch(t){goog.log.fine(this.logger_,this.formatMsg_("Send error: "+t.message)),this.error_(goog.net.ErrorCode.EXCEPTION,t)}},goog.net.XhrIo.shouldUseXhr2Timeout_=function(t){return goog.userAgent.IE&&goog.userAgent.isVersionOrHigher(9)&&"number"==typeof t[goog.net.XhrIo.XHR2_TIMEOUT_]&&void 0!==t[goog.net.XhrIo.XHR2_ON_TIMEOUT_]},goog.net.XhrIo.isContentTypeHeader_=function(t){return goog.string.caseInsensitiveEquals(goog.net.XhrIo.CONTENT_TYPE_HEADER,t)},goog.net.XhrIo.prototype.createXhr=function(){return this.xmlHttpFactory_?this.xmlHttpFactory_.createInstance():goog.net.XmlHttp()},goog.net.XhrIo.prototype.timeout_=function(){"undefined"==typeof goog||this.xhr_&&(this.lastError_="Timed out after "+this.timeoutInterval_+"ms, aborting",this.lastErrorCode_=goog.net.ErrorCode.TIMEOUT,goog.log.fine(this.logger_,this.formatMsg_(this.lastError_)),this.dispatchEvent(goog.net.EventType.TIMEOUT),this.abort(goog.net.ErrorCode.TIMEOUT))},goog.net.XhrIo.prototype.error_=function(t,o){this.active_=!1,this.xhr_&&(this.inAbort_=!0,this.xhr_.abort(),this.inAbort_=!1),this.lastError_=o,this.lastErrorCode_=t,this.dispatchErrors_(),this.cleanUpXhr_()},goog.net.XhrIo.prototype.dispatchErrors_=function(){this.errorDispatched_||(this.errorDispatched_=!0,this.dispatchEvent(goog.net.EventType.COMPLETE),this.dispatchEvent(goog.net.EventType.ERROR))},goog.net.XhrIo.prototype.abort=function(t){this.xhr_&&this.active_&&(goog.log.fine(this.logger_,this.formatMsg_("Aborting")),this.active_=!1,this.inAbort_=!0,this.xhr_.abort(),this.inAbort_=!1,this.lastErrorCode_=t||goog.net.ErrorCode.ABORT,this.dispatchEvent(goog.net.EventType.COMPLETE),this.dispatchEvent(goog.net.EventType.ABORT),this.cleanUpXhr_())},goog.net.XhrIo.prototype.disposeInternal=function(){this.xhr_&&(this.active_&&(this.active_=!1,this.inAbort_=!0,this.xhr_.abort(),this.inAbort_=!1),this.cleanUpXhr_(!0)),t.base(this,"disposeInternal")},goog.net.XhrIo.prototype.onReadyStateChange_=function(){this.isDisposed()||(this.inOpen_||this.inSend_||this.inAbort_?this.onReadyStateChangeHelper_():this.onReadyStateChangeEntryPoint_())},goog.net.XhrIo.prototype.onReadyStateChangeEntryPoint_=function(){this.onReadyStateChangeHelper_()},goog.net.XhrIo.prototype.onReadyStateChangeHelper_=function(){if(this.active_)if("undefined"==typeof goog);else if(this.xhrOptions_[goog.net.XmlHttp.OptionType.LOCAL_REQUEST_ERROR]&&this.getReadyState()==goog.net.XmlHttp.ReadyState.COMPLETE&&2==this.getStatus())goog.log.fine(this.logger_,this.formatMsg_("Local request error detected and ignored"));else{if(this.inSend_&&this.getReadyState()==goog.net.XmlHttp.ReadyState.COMPLETE)return void goog.Timer.callOnce(this.onReadyStateChange_,0,this);if(this.dispatchEvent(goog.net.EventType.READY_STATE_CHANGE),this.isComplete()){goog.log.fine(this.logger_,this.formatMsg_("Request complete")),this.active_=!1;try{this.isSuccess()?(this.dispatchEvent(goog.net.EventType.COMPLETE),this.dispatchEvent(goog.net.EventType.SUCCESS)):(this.lastErrorCode_=goog.net.ErrorCode.HTTP_ERROR,this.lastError_=this.getStatusText()+" ["+this.getStatus()+"]",this.dispatchErrors_())}finally{this.cleanUpXhr_()}}}},goog.net.XhrIo.prototype.onProgressHandler_=function(t,o){goog.asserts.assert(t.type===goog.net.EventType.PROGRESS,"goog.net.EventType.PROGRESS is of the same type as raw XHR progress."),this.dispatchEvent(goog.net.XhrIo.buildProgressEvent_(t,goog.net.EventType.PROGRESS)),this.dispatchEvent(goog.net.XhrIo.buildProgressEvent_(t,o?goog.net.EventType.DOWNLOAD_PROGRESS:goog.net.EventType.UPLOAD_PROGRESS))},goog.net.XhrIo.buildProgressEvent_=function(t,o){return{type:o,lengthComputable:t.lengthComputable,loaded:t.loaded,total:t.total}},goog.net.XhrIo.prototype.cleanUpXhr_=function(t){if(this.xhr_){this.cleanUpTimeoutTimer_();var o=this.xhr_,e=this.xhrOptions_[goog.net.XmlHttp.OptionType.USE_NULL_FUNCTION]?goog.nullFunction:null;this.xhr_=null,this.xhrOptions_=null,t||this.dispatchEvent(goog.net.EventType.READY);try{o.onreadystatechange=e}catch(t){goog.log.error(this.logger_,"Problem encountered resetting onreadystatechange: "+t.message)}}},goog.net.XhrIo.prototype.cleanUpTimeoutTimer_=function(){this.xhr_&&this.useXhr2Timeout_&&(this.xhr_[goog.net.XhrIo.XHR2_ON_TIMEOUT_]=null),this.timeoutId_&&(goog.Timer.clear(this.timeoutId_),this.timeoutId_=null)},goog.net.XhrIo.prototype.isActive=function(){return!!this.xhr_},goog.net.XhrIo.prototype.isComplete=function(){return this.getReadyState()==goog.net.XmlHttp.ReadyState.COMPLETE},goog.net.XhrIo.prototype.isSuccess=function(){var t=this.getStatus();return goog.net.HttpStatus.isSuccess(t)||0===t&&!this.isLastUriEffectiveSchemeHttp_()},goog.net.XhrIo.prototype.isLastUriEffectiveSchemeHttp_=function(){var t=goog.uri.utils.getEffectiveScheme(String(this.lastUri_));return goog.net.XhrIo.HTTP_SCHEME_PATTERN.test(t)},goog.net.XhrIo.prototype.getReadyState=function(){return this.xhr_?this.xhr_.readyState:goog.net.XmlHttp.ReadyState.UNINITIALIZED},goog.net.XhrIo.prototype.getStatus=function(){try{return this.getReadyState()>goog.net.XmlHttp.ReadyState.LOADED?this.xhr_.status:-1}catch(t){return-1}},goog.net.XhrIo.prototype.getStatusText=function(){try{return this.getReadyState()>goog.net.XmlHttp.ReadyState.LOADED?this.xhr_.statusText:""}catch(t){return goog.log.fine(this.logger_,"Can not get status: "+t.message),""}},goog.net.XhrIo.prototype.getLastUri=function(){return String(this.lastUri_)},goog.net.XhrIo.prototype.getResponseText=function(){try{return this.xhr_?this.xhr_.responseText:""}catch(t){return goog.log.fine(this.logger_,"Can not get responseText: "+t.message),""}},goog.net.XhrIo.prototype.getResponseBody=function(){try{if(this.xhr_&&"responseBody"in this.xhr_)return this.xhr_.responseBody}catch(t){goog.log.fine(this.logger_,"Can not get responseBody: "+t.message)}return null},goog.net.XhrIo.prototype.getResponseXml=function(){try{return this.xhr_?this.xhr_.responseXML:null}catch(t){return goog.log.fine(this.logger_,"Can not get responseXML: "+t.message),null}},goog.net.XhrIo.prototype.getResponseJson=function(t){if(this.xhr_){var o=this.xhr_.responseText;return t&&0==o.indexOf(t)&&(o=o.substring(t.length)),goog.json.hybrid.parse(o)}},goog.net.XhrIo.prototype.getResponse=function(){try{if(!this.xhr_)return null;if("response"in this.xhr_)return this.xhr_.response;switch(this.responseType_){case o.DEFAULT:case o.TEXT:return this.xhr_.responseText;case o.ARRAY_BUFFER:if("mozResponseArrayBuffer"in this.xhr_)return this.xhr_.mozResponseArrayBuffer}return goog.log.error(this.logger_,"Response type "+this.responseType_+" is not supported on this browser"),null}catch(t){return goog.log.fine(this.logger_,"Can not get response: "+t.message),null}},goog.net.XhrIo.prototype.getResponseHeader=function(t){if(this.xhr_&&this.isComplete()){var o=this.xhr_.getResponseHeader(t);return null===o?void 0:o}},goog.net.XhrIo.prototype.getAllResponseHeaders=function(){return this.xhr_&&this.isComplete()&&this.xhr_.getAllResponseHeaders()||""},goog.net.XhrIo.prototype.getResponseHeaders=function(){for(var t={},o=this.getAllResponseHeaders().split("\r\n"),e=0;e<o.length;e++)if(!goog.string.isEmptyOrWhitespace(o[e])){var r=goog.string.splitLimit(o[e],":",1),n=r[0],s=r[1];if("string"==typeof s){s=s.trim();var g=t[n]||[];t[n]=g,g.push(s)}}return goog.object.map(t,function(t){return t.join(", ")})},goog.net.XhrIo.prototype.getStreamingResponseHeader=function(t){return this.xhr_?this.xhr_.getResponseHeader(t):null},goog.net.XhrIo.prototype.getAllStreamingResponseHeaders=function(){return this.xhr_?this.xhr_.getAllResponseHeaders():""},goog.net.XhrIo.prototype.getLastErrorCode=function(){return this.lastErrorCode_},goog.net.XhrIo.prototype.getLastError=function(){return"string"==typeof this.lastError_?this.lastError_:String(this.lastError_)},goog.net.XhrIo.prototype.formatMsg_=function(t){return t+" ["+this.lastMethod_+" "+this.lastUri_+" "+this.getStatus()+"]"},goog.debug.entryPointRegistry.register(function(t){goog.net.XhrIo.prototype.onReadyStateChangeEntryPoint_=t(goog.net.XhrIo.prototype.onReadyStateChangeEntryPoint_)})});