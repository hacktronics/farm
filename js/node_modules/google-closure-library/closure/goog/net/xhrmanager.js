goog.provide("goog.net.XhrManager"),goog.provide("goog.net.XhrManager.Event"),goog.provide("goog.net.XhrManager.Request"),goog.require("goog.events"),goog.require("goog.events.Event"),goog.require("goog.events.EventHandler"),goog.require("goog.events.EventTarget"),goog.require("goog.net.ErrorCode"),goog.require("goog.net.EventType"),goog.require("goog.net.XhrIo"),goog.require("goog.net.XhrIoPool"),goog.require("goog.structs.Map"),goog.net.XhrManager=function(e,t,o,n,r,g){goog.net.XhrManager.base(this,"constructor"),this.maxRetries_=void 0!==e?e:1,this.timeoutInterval_=void 0!==r?Math.max(0,r):0,this.withCredentials_=!!g,this.xhrPool_=new goog.net.XhrIoPool(t,o,n,g),this.requests_=new goog.structs.Map,this.eventHandler_=new goog.events.EventHandler(this)},goog.inherits(goog.net.XhrManager,goog.events.EventTarget),goog.net.XhrManager.ERROR_ID_IN_USE_="[goog.net.XhrManager] ID in use",goog.net.XhrManager.XHR_EVENT_TYPES_=[goog.net.EventType.READY,goog.net.EventType.COMPLETE,goog.net.EventType.SUCCESS,goog.net.EventType.ERROR,goog.net.EventType.ABORT,goog.net.EventType.TIMEOUT],goog.net.XhrManager.prototype.setTimeoutInterval=function(e){this.timeoutInterval_=Math.max(0,e)},goog.net.XhrManager.prototype.getOutstandingCount=function(){return this.requests_.getCount()},goog.net.XhrManager.prototype.getOutstandingRequestIds=function(){return this.requests_.getKeys()},goog.net.XhrManager.prototype.send=function(e,t,o,n,r,g,s,a,h,i){if(this.requests_.get(e))throw new Error(goog.net.XhrManager.ERROR_ID_IN_USE_);var u=new goog.net.XhrManager.Request(t,goog.bind(this.handleEvent_,this,e),o,n,r,s,void 0!==a?a:this.maxRetries_,h,void 0!==i?i:this.withCredentials_);this.requests_.set(e,u);var p=goog.bind(this.handleAvailableXhr_,this,e);return this.xhrPool_.getObject(p,g),u},goog.net.XhrManager.prototype.abort=function(e,t){var o=this.requests_.get(e);if(o){var n=o.xhrIo;o.setAborted(!0),t&&(n&&(this.removeXhrListener_(n,o.getXhrEventCallback()),goog.events.listenOnce(n,goog.net.EventType.READY,function(){this.xhrPool_.releaseObject(n)},!1,this)),this.requests_.remove(e)),n&&n.abort()}},goog.net.XhrManager.prototype.handleAvailableXhr_=function(e,t){var o=this.requests_.get(e);o&&!o.xhrIo?(this.addXhrListener_(t,o.getXhrEventCallback()),t.setTimeoutInterval(this.timeoutInterval_),t.setResponseType(o.getResponseType()),t.setWithCredentials(o.getWithCredentials()),o.xhrIo=t,this.dispatchEvent(new goog.net.XhrManager.Event(goog.net.EventType.READY,this,e,t)),this.retry_(e,t),o.getAborted()&&t.abort()):this.xhrPool_.releaseObject(t)},goog.net.XhrManager.prototype.handleEvent_=function(e,t){var o=t.target;switch(t.type){case goog.net.EventType.READY:this.retry_(e,o);break;case goog.net.EventType.COMPLETE:return this.handleComplete_(e,o,t);case goog.net.EventType.SUCCESS:this.handleSuccess_(e,o);break;case goog.net.EventType.TIMEOUT:case goog.net.EventType.ERROR:this.handleError_(e,o);break;case goog.net.EventType.ABORT:this.handleAbort_(e,o)}return null},goog.net.XhrManager.prototype.retry_=function(e,t){var o=this.requests_.get(e);!o||o.getCompleted()||o.hasReachedMaxRetries()?(o&&(this.removeXhrListener_(t,o.getXhrEventCallback()),this.requests_.remove(e)),this.xhrPool_.releaseObject(t)):(o.increaseAttemptCount(),t.send(o.getUrl(),o.getMethod(),o.getContent(),o.getHeaders()))},goog.net.XhrManager.prototype.handleComplete_=function(e,t,o){var n=this.requests_.get(e);return(t.getLastErrorCode()==goog.net.ErrorCode.ABORT||t.isSuccess()||n.hasReachedMaxRetries())&&(this.dispatchEvent(new goog.net.XhrManager.Event(goog.net.EventType.COMPLETE,this,e,t)),n&&(n.setCompleted(!0),n.getCompleteCallback()))?n.getCompleteCallback().call(t,o):null},goog.net.XhrManager.prototype.handleAbort_=function(e,t){this.dispatchEvent(new goog.net.XhrManager.Event(goog.net.EventType.ABORT,this,e,t))},goog.net.XhrManager.prototype.handleSuccess_=function(e,t){this.dispatchEvent(new goog.net.XhrManager.Event(goog.net.EventType.SUCCESS,this,e,t))},goog.net.XhrManager.prototype.handleError_=function(e,t){this.requests_.get(e).hasReachedMaxRetries()&&this.dispatchEvent(new goog.net.XhrManager.Event(goog.net.EventType.ERROR,this,e,t))},goog.net.XhrManager.prototype.removeXhrListener_=function(e,t,o){var n=o||goog.net.XhrManager.XHR_EVENT_TYPES_;this.eventHandler_.unlisten(e,n,t)},goog.net.XhrManager.prototype.addXhrListener_=function(e,t,o){var n=o||goog.net.XhrManager.XHR_EVENT_TYPES_;this.eventHandler_.listen(e,n,t)},goog.net.XhrManager.prototype.disposeInternal=function(){goog.net.XhrManager.superClass_.disposeInternal.call(this),this.xhrPool_.dispose(),this.xhrPool_=null,this.eventHandler_.dispose(),this.eventHandler_=null,this.requests_.clear(),this.requests_=null},goog.net.XhrManager.Event=function(e,t,o,n){goog.events.Event.call(this,e,t),this.id=o,this.xhrIo=n},goog.inherits(goog.net.XhrManager.Event,goog.events.Event),goog.net.XhrManager.Request=function(e,t,o,n,r,g,s,a,h){this.url_=e,this.method_=o||"GET",this.content_=n,this.headers_=r||null,this.maxRetries_=void 0!==s?s:1,this.attemptCount_=0,this.completed_=!1,this.aborted_=!1,this.xhrEventCallback_=t,this.completeCallback_=g,this.responseType_=a||goog.net.XhrIo.ResponseType.DEFAULT,this.withCredentials_=!!h,this.xhrIo=null},goog.net.XhrManager.Request.prototype.getUrl=function(){return this.url_},goog.net.XhrManager.Request.prototype.getMethod=function(){return this.method_},goog.net.XhrManager.Request.prototype.getContent=function(){return this.content_},goog.net.XhrManager.Request.prototype.getHeaders=function(){return this.headers_},goog.net.XhrManager.Request.prototype.getWithCredentials=function(){return this.withCredentials_},goog.net.XhrManager.Request.prototype.getMaxRetries=function(){return this.maxRetries_},goog.net.XhrManager.Request.prototype.getAttemptCount=function(){return this.attemptCount_},goog.net.XhrManager.Request.prototype.increaseAttemptCount=function(){this.attemptCount_++},goog.net.XhrManager.Request.prototype.hasReachedMaxRetries=function(){return this.attemptCount_>this.maxRetries_},goog.net.XhrManager.Request.prototype.setCompleted=function(e){this.completed_=e},goog.net.XhrManager.Request.prototype.getCompleted=function(){return this.completed_},goog.net.XhrManager.Request.prototype.setAborted=function(e){this.aborted_=e},goog.net.XhrManager.Request.prototype.getAborted=function(){return this.aborted_},goog.net.XhrManager.Request.prototype.getXhrEventCallback=function(){return this.xhrEventCallback_},goog.net.XhrManager.Request.prototype.getCompleteCallback=function(){return this.completeCallback_},goog.net.XhrManager.Request.prototype.getResponseType=function(){return this.responseType_};