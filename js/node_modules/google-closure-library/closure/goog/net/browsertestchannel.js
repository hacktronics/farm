goog.provide("goog.net.BrowserTestChannel"),goog.forwardDeclare("goog.net.BrowserChannel"),goog.forwardDeclare("goog.net.BrowserChannel.ServerReachability"),goog.forwardDeclare("goog.net.XhrIo"),goog.require("goog.json.NativeJsonProcessor"),goog.require("goog.net.ChannelRequest"),goog.require("goog.net.ChannelRequest.Error"),goog.require("goog.net.tmpnetwork"),goog.require("goog.string.Parser"),goog.net.BrowserTestChannel=function(e,t){this.channel_=e,this.channelDebug_=t,this.parser_=new goog.json.NativeJsonProcessor},goog.net.BrowserTestChannel.prototype.extraHeaders_=null,goog.net.BrowserTestChannel.prototype.request_=null,goog.net.BrowserTestChannel.prototype.receivedIntermediateResult_=!1,goog.net.BrowserTestChannel.prototype.startTime_=null,goog.net.BrowserTestChannel.prototype.firstTime_=null,goog.net.BrowserTestChannel.prototype.lastTime_=null,goog.net.BrowserTestChannel.prototype.path_=null,goog.net.BrowserTestChannel.prototype.state_=null,goog.net.BrowserTestChannel.prototype.lastStatusCode_=-1,goog.net.BrowserTestChannel.prototype.hostPrefix_=null,goog.net.BrowserTestChannel.prototype.blockedPrefix_=null,goog.net.BrowserTestChannel.State_={INIT:0,CHECKING_BLOCKED:1,CONNECTION_TESTING:2},goog.net.BrowserTestChannel.BLOCKED_TIMEOUT_=5e3,goog.net.BrowserTestChannel.BLOCKED_RETRIES_=3,goog.net.BrowserTestChannel.BLOCKED_PAUSE_BETWEEN_RETRIES_=2e3,goog.net.BrowserTestChannel.MIN_TIME_EXPECTED_BETWEEN_DATA_=500,goog.net.BrowserTestChannel.prototype.setExtraHeaders=function(e){this.extraHeaders_=e},goog.net.BrowserTestChannel.prototype.setParser=function(e){this.parser_=e},goog.net.BrowserTestChannel.prototype.connect=function(e){this.path_=e;var t=this.channel_.getForwardChannelUri(this.path_);goog.net.BrowserChannel.notifyStatEvent(goog.net.BrowserChannel.Stat.TEST_STAGE_ONE_START),this.startTime_=goog.now();var n=this.channel_.getFirstTestResults();if(null!=n)return this.hostPrefix_=this.channel_.correctHostPrefix(n[0]),this.blockedPrefix_=n[1],void(this.blockedPrefix_?(this.state_=goog.net.BrowserTestChannel.State_.CHECKING_BLOCKED,this.checkBlocked_()):(this.state_=goog.net.BrowserTestChannel.State_.CONNECTION_TESTING,this.connectStage2_()));t.setParameterValues("MODE","init"),this.request_=goog.net.BrowserChannel.createChannelRequest(this,this.channelDebug_),this.request_.setExtraHeaders(this.extraHeaders_),this.request_.xmlHttpGet(t,!1,null,!0),this.state_=goog.net.BrowserTestChannel.State_.INIT},goog.net.BrowserTestChannel.prototype.checkBlocked_=function(){var e=this.channel_.createDataUri(this.blockedPrefix_,"/mail/images/cleardot.gif");e.makeUnique(),goog.net.tmpnetwork.testLoadImageWithRetries(e.toString(),goog.net.BrowserTestChannel.BLOCKED_TIMEOUT_,goog.bind(this.checkBlockedCallback_,this),goog.net.BrowserTestChannel.BLOCKED_RETRIES_,goog.net.BrowserTestChannel.BLOCKED_PAUSE_BETWEEN_RETRIES_),this.notifyServerReachabilityEvent(goog.net.BrowserChannel.ServerReachability.REQUEST_MADE)},goog.net.BrowserTestChannel.prototype.checkBlockedCallback_=function(e){e?(this.state_=goog.net.BrowserTestChannel.State_.CONNECTION_TESTING,this.connectStage2_()):(goog.net.BrowserChannel.notifyStatEvent(goog.net.BrowserChannel.Stat.CHANNEL_BLOCKED),this.channel_.testConnectionBlocked(this)),e&&this.notifyServerReachabilityEvent(goog.net.BrowserChannel.ServerReachability.REQUEST_SUCCEEDED)},goog.net.BrowserTestChannel.prototype.connectStage2_=function(){this.channelDebug_.debug("TestConnection: starting stage 2");var e=this.channel_.getSecondTestResults();if(null!=e)return this.channelDebug_.debug("Buffered"),goog.net.BrowserChannel.notifyStatEvent(goog.net.BrowserChannel.Stat.TEST_STAGE_TWO_START),void(e?(goog.net.BrowserChannel.notifyStatEvent(goog.net.BrowserChannel.Stat.PROXY),this.channel_.testConnectionFinished(this,!1)):(goog.net.BrowserChannel.notifyStatEvent(goog.net.BrowserChannel.Stat.NOPROXY),this.channel_.testConnectionFinished(this,!0)));this.request_=goog.net.BrowserChannel.createChannelRequest(this,this.channelDebug_),this.request_.setExtraHeaders(this.extraHeaders_);var t=this.channel_.getBackChannelUri(this.hostPrefix_,this.path_);goog.net.BrowserChannel.notifyStatEvent(goog.net.BrowserChannel.Stat.TEST_STAGE_TWO_START),goog.net.ChannelRequest.supportsXhrStreaming()?(t.setParameterValues("TYPE","xmlhttp"),this.request_.xmlHttpGet(t,!1,this.hostPrefix_,!1)):(t.setParameterValues("TYPE","html"),this.request_.tridentGet(t,Boolean(this.hostPrefix_)))},goog.net.BrowserTestChannel.prototype.createXhrIo=function(e){return this.channel_.createXhrIo(e)},goog.net.BrowserTestChannel.prototype.abort=function(){this.request_&&(this.request_.cancel(),this.request_=null),this.lastStatusCode_=-1},goog.net.BrowserTestChannel.prototype.isClosed=function(){return!1},goog.net.BrowserTestChannel.prototype.onRequestData=function(e,t){if(this.lastStatusCode_=e.getLastStatusCode(),this.state_==goog.net.BrowserTestChannel.State_.INIT){if(this.channelDebug_.debug("TestConnection: Got data for stage 1"),!t)return this.channelDebug_.debug("TestConnection: Null responseText"),void this.channel_.testConnectionFailure(this,goog.net.ChannelRequest.Error.BAD_DATA);try{var n=this.parser_.parse(t)}catch(e){return this.channelDebug_.dumpException(e),void this.channel_.testConnectionFailure(this,goog.net.ChannelRequest.Error.BAD_DATA)}this.hostPrefix_=this.channel_.correctHostPrefix(n[0]),this.blockedPrefix_=n[1]}else this.state_==goog.net.BrowserTestChannel.State_.CONNECTION_TESTING&&(this.receivedIntermediateResult_?(goog.net.BrowserChannel.notifyStatEvent(goog.net.BrowserChannel.Stat.TEST_STAGE_TWO_DATA_TWO),this.lastTime_=goog.now()):"11111"==t?(goog.net.BrowserChannel.notifyStatEvent(goog.net.BrowserChannel.Stat.TEST_STAGE_TWO_DATA_ONE),this.receivedIntermediateResult_=!0,this.firstTime_=goog.now(),this.checkForEarlyNonBuffered_()&&(this.lastStatusCode_=200,this.request_.cancel(),this.channelDebug_.debug("Test connection succeeded; using streaming connection"),goog.net.BrowserChannel.notifyStatEvent(goog.net.BrowserChannel.Stat.NOPROXY),this.channel_.testConnectionFinished(this,!0))):(goog.net.BrowserChannel.notifyStatEvent(goog.net.BrowserChannel.Stat.TEST_STAGE_TWO_DATA_BOTH),this.firstTime_=this.lastTime_=goog.now(),this.receivedIntermediateResult_=!1))},goog.net.BrowserTestChannel.prototype.onRequestComplete=function(e){if(this.lastStatusCode_=this.request_.getLastStatusCode(),!this.request_.getSuccess())return this.channelDebug_.debug("TestConnection: request failed, in state "+this.state_),this.state_==goog.net.BrowserTestChannel.State_.INIT?goog.net.BrowserChannel.notifyStatEvent(goog.net.BrowserChannel.Stat.TEST_STAGE_ONE_FAILED):this.state_==goog.net.BrowserTestChannel.State_.CONNECTION_TESTING&&goog.net.BrowserChannel.notifyStatEvent(goog.net.BrowserChannel.Stat.TEST_STAGE_TWO_FAILED),void this.channel_.testConnectionFailure(this,this.request_.getLastError());if(this.state_==goog.net.BrowserTestChannel.State_.INIT)this.channelDebug_.debug("TestConnection: request complete for initial check"),this.blockedPrefix_?(this.state_=goog.net.BrowserTestChannel.State_.CHECKING_BLOCKED,this.checkBlocked_()):(this.state_=goog.net.BrowserTestChannel.State_.CONNECTION_TESTING,this.connectStage2_());else if(this.state_==goog.net.BrowserTestChannel.State_.CONNECTION_TESTING){this.channelDebug_.debug("TestConnection: request complete for stage 2");var t=!1;if(goog.net.ChannelRequest.supportsXhrStreaming())t=this.receivedIntermediateResult_;else t=!(this.lastTime_-this.firstTime_<200);t?(this.channelDebug_.debug("Test connection succeeded; using streaming connection"),goog.net.BrowserChannel.notifyStatEvent(goog.net.BrowserChannel.Stat.NOPROXY),this.channel_.testConnectionFinished(this,!0)):(this.channelDebug_.debug("Test connection failed; not using streaming"),goog.net.BrowserChannel.notifyStatEvent(goog.net.BrowserChannel.Stat.PROXY),this.channel_.testConnectionFinished(this,!1))}},goog.net.BrowserTestChannel.prototype.getLastStatusCode=function(){return this.lastStatusCode_},goog.net.BrowserTestChannel.prototype.shouldUseSecondaryDomains=function(){return this.channel_.shouldUseSecondaryDomains()},goog.net.BrowserTestChannel.prototype.isActive=function(e){return this.channel_.isActive()},goog.net.BrowserTestChannel.prototype.checkForEarlyNonBuffered_=function(){var e=this.firstTime_-this.startTime_;return goog.net.ChannelRequest.supportsXhrStreaming()||e<goog.net.BrowserTestChannel.MIN_TIME_EXPECTED_BETWEEN_DATA_},goog.net.BrowserTestChannel.prototype.notifyServerReachabilityEvent=function(e){this.channel_.notifyServerReachabilityEvent(e)};