goog.provide("goog.net.FileDownloader"),goog.provide("goog.net.FileDownloader.Error"),goog.require("goog.Disposable"),goog.require("goog.asserts"),goog.require("goog.async.Deferred"),goog.require("goog.crypt.hash32"),goog.require("goog.debug.Error"),goog.require("goog.events"),goog.require("goog.events.EventHandler"),goog.require("goog.fs"),goog.require("goog.fs.DirectoryEntry"),goog.require("goog.fs.Error"),goog.require("goog.fs.FileSaver"),goog.require("goog.net.EventType"),goog.require("goog.net.XhrIo"),goog.require("goog.net.XhrIoPool"),goog.require("goog.object"),goog.net.FileDownloader=function(o,e){goog.net.FileDownloader.base(this,"constructor"),this.dir_=o,this.pool_=e||new goog.net.XhrIoPool,this.downloads_={},this.eventHandler_=new goog.events.EventHandler(this)},goog.inherits(goog.net.FileDownloader,goog.Disposable),goog.net.FileDownloader.prototype.download=function(o){if(this.isDownloading(o))return this.downloads_[o].deferred.branch(!0);var e=new goog.net.FileDownloader.Download_(o,this);return this.downloads_[o]=e,this.pool_.getObject(goog.bind(this.gotXhr_,this,e)),e.deferred.branch(!0)},goog.net.FileDownloader.prototype.waitForDownload=function(o){var e=new goog.async.Deferred;return this.isDownloading(o)?this.downloads_[o].deferred.addBoth(function(){e.callback(null)},this):e.callback(null),e},goog.net.FileDownloader.prototype.isDownloading=function(o){return o in this.downloads_},goog.net.FileDownloader.prototype.getDownloadedBlob=function(o){return this.getFile_(o).addCallback(function(o){return o.file()})},goog.net.FileDownloader.prototype.getLocalUrl=function(o){return this.getFile_(o).addCallback(function(o){return o.toUrl()})},goog.net.FileDownloader.prototype.isDownloaded=function(o){var e=new goog.async.Deferred,r=this.getDownloadedBlob(o);return r.addCallback(function(){e.callback(!0)}),r.addErrback(function(o){o.name==goog.fs.Error.ErrorName.NOT_FOUND?e.callback(!1):e.errback(o)}),e},goog.net.FileDownloader.prototype.remove=function(o){return this.getDir_(o,goog.fs.DirectoryEntry.Behavior.DEFAULT).addCallback(function(o){return o.removeRecursively()})},goog.net.FileDownloader.prototype.setBlob=function(o,e,r){var t=this.sanitize_(r||this.urlToName_(o)),n=new goog.net.FileDownloader.Download_(o,this);return this.downloads_[o]=n,n.blob=e,this.getDir_(n.url,goog.fs.DirectoryEntry.Behavior.CREATE_EXCLUSIVE).addCallback(function(o){return o.getFile(t,goog.fs.DirectoryEntry.Behavior.CREATE_EXCLUSIVE)}).addCallback(goog.bind(this.fileSuccess_,this,n)).addErrback(goog.bind(this.error_,this,n)),n.deferred.branch(!0)},goog.net.FileDownloader.prototype.gotXhr_=function(o,e){o.cancelled?this.freeXhr_(e):(this.eventHandler_.listen(e,goog.net.EventType.SUCCESS,goog.bind(this.xhrSuccess_,this,o)),this.eventHandler_.listen(e,[goog.net.EventType.ERROR,goog.net.EventType.ABORT],goog.bind(this.error_,this,o)),this.eventHandler_.listen(e,goog.net.EventType.READY,goog.bind(this.freeXhr_,this,e)),o.xhr=e,e.setResponseType(goog.net.XhrIo.ResponseType.ARRAY_BUFFER),e.send(o.url))},goog.net.FileDownloader.prototype.xhrSuccess_=function(o){if(!o.cancelled){var e=this.sanitize_(this.getName_(o.xhr)),r=o.xhr.getResponse();r?(o.blob=goog.fs.getBlob(r),delete o.xhr,this.getDir_(o.url,goog.fs.DirectoryEntry.Behavior.CREATE_EXCLUSIVE).addCallback(function(o){return o.getFile(e,goog.fs.DirectoryEntry.Behavior.CREATE_EXCLUSIVE)}).addCallback(goog.bind(this.fileSuccess_,this,o)).addErrback(goog.bind(this.error_,this,o))):this.error_(o)}},goog.net.FileDownloader.prototype.fileSuccess_=function(o,e){o.cancelled?e.remove():(o.file=e,e.createWriter().addCallback(goog.bind(this.fileWriterSuccess_,this,o)).addErrback(goog.bind(this.error_,this,o)))},goog.net.FileDownloader.prototype.fileWriterSuccess_=function(o,e){o.cancelled?o.file.remove():(o.writer=e,e.write(o.blob),this.eventHandler_.listenOnce(e,goog.fs.FileSaver.EventType.WRITE_END,goog.bind(this.writeEnd_,this,o)))},goog.net.FileDownloader.prototype.writeEnd_=function(o){o.cancelled||o.writer.getError()?this.error_(o,o.writer.getError()):(delete this.downloads_[o.url],o.deferred.callback(o.blob))},goog.net.FileDownloader.prototype.error_=function(o,e){o.file&&o.file.remove(),o.cancelled||(delete this.downloads_[o.url],o.deferred.errback(new goog.net.FileDownloader.Error(o,e)))},goog.net.FileDownloader.prototype.cancel_=function(o){goog.dispose(o),delete this.downloads_[o.url]},goog.net.FileDownloader.prototype.getDir_=function(o,e){var r="`"+Math.abs(goog.crypt.hash32.encodeString(o)).toString(16).substring(0,3);return this.dir_.getDirectory(r,goog.fs.DirectoryEntry.Behavior.CREATE).addCallback(function(r){return r.getDirectory(this.sanitize_(o),e)},this)},goog.net.FileDownloader.prototype.getFile_=function(o){return this.getDir_(o,goog.fs.DirectoryEntry.Behavior.DEFAULT).addCallback(function(o){return o.listDirectory().addCallback(function(e){return goog.asserts.assert(1==e.length),e[0]||o.getFile("file")})})},goog.net.FileDownloader.prototype.sanitize_=function(o){return"`"+o.replace(/[\/\\<>:?*"|%`]/g,encodeURIComponent).replace(/%/g,"`")},goog.net.FileDownloader.prototype.getName_=function(o){var e=o.getResponseHeader("Content-Disposition"),r=e&&e.match(/^attachment *; *filename="(.*)"$/i);return r?r[1].replace(/\\(.)/g,"$1"):this.urlToName_(o.getLastUri())},goog.net.FileDownloader.prototype.urlToName_=function(o){var e=o.split("/");return e[e.length-1]},goog.net.FileDownloader.prototype.freeXhr_=function(o){goog.events.removeAll(o),this.pool_.addFreeObject(o)},goog.net.FileDownloader.prototype.disposeInternal=function(){delete this.dir_,goog.dispose(this.eventHandler_),delete this.eventHandler_,goog.object.forEach(this.downloads_,function(o){o.deferred.cancel()},this),delete this.downloads_,goog.dispose(this.pool_),delete this.pool_,goog.net.FileDownloader.base(this,"disposeInternal")},goog.net.FileDownloader.Error=function(o,e){goog.net.FileDownloader.Error.base(this,"constructor","Error capturing URL "+o.url),this.url=o.url,o.xhr?(this.xhrStatus=o.xhr.getStatus(),this.xhrErrorCode=o.xhr.getLastErrorCode(),this.message+=": XHR failed with status "+this.xhrStatus+" (error code "+this.xhrErrorCode+")"):e&&(this.fileError=e,this.message+=": file API failed ("+e.message+")")},goog.inherits(goog.net.FileDownloader.Error,goog.debug.Error),goog.net.FileDownloader.Error.prototype.xhrStatus,goog.net.FileDownloader.Error.prototype.xhrErrorCode,goog.net.FileDownloader.Error.prototype.fileError,goog.net.FileDownloader.Download_=function(o,e){goog.net.FileDownloader.Download_.base(this,"constructor"),this.url=o,this.deferred=new goog.async.Deferred(goog.bind(e.cancel_,e,this)),this.cancelled=!1,this.xhr=null,this.name=null,this.blob=null,this.file=null,this.writer=null},goog.inherits(goog.net.FileDownloader.Download_,goog.Disposable),goog.net.FileDownloader.Download_.prototype.disposeInternal=function(){this.cancelled=!0,this.xhr?this.xhr.abort():this.writer&&this.writer.getReadyState()==goog.fs.FileSaver.ReadyState.WRITING&&this.writer.abort(),goog.net.FileDownloader.Download_.base(this,"disposeInternal")};