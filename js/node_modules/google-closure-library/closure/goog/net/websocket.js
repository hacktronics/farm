goog.provide("goog.net.WebSocket"),goog.provide("goog.net.WebSocket.ErrorEvent"),goog.provide("goog.net.WebSocket.EventType"),goog.provide("goog.net.WebSocket.MessageEvent"),goog.require("goog.Timer"),goog.require("goog.asserts"),goog.require("goog.debug.entryPointRegistry"),goog.require("goog.events"),goog.require("goog.events.Event"),goog.require("goog.events.EventTarget"),goog.require("goog.log"),goog.net.WebSocket=function(e,o){goog.net.WebSocket.base(this,"constructor"),"object"!=typeof e&&(e={autoReconnect:e,getNextReconnect:o}),this.autoReconnect_=0!=e.autoReconnect,this.getNextReconnect_=e.getNextReconnect||goog.net.WebSocket.EXPONENTIAL_BACKOFF_,this.binaryType_=e.binaryType||goog.net.WebSocket.BinaryType.BLOB,this.nextReconnect_=this.getNextReconnect_(this.reconnectAttempt_)},goog.inherits(goog.net.WebSocket,goog.events.EventTarget),goog.net.WebSocket.BinaryType={ARRAY_BUFFER:"arraybuffer",BLOB:"blob"},goog.net.WebSocket.Options=function(){this.autoReconnect,this.getNextReconnect,this.binaryType},goog.net.WebSocket.prototype.webSocket_=null,goog.net.WebSocket.prototype.url_=null,goog.net.WebSocket.prototype.protocol_=void 0,goog.net.WebSocket.prototype.closeExpected_=!1,goog.net.WebSocket.prototype.reconnectAttempt_=0,goog.net.WebSocket.prototype.reconnectTimer_=null,goog.net.WebSocket.prototype.logger_=goog.log.getLogger("goog.net.WebSocket"),goog.net.WebSocket.EventType={CLOSED:goog.events.getUniqueId("closed"),ERROR:goog.events.getUniqueId("error"),MESSAGE:goog.events.getUniqueId("message"),OPENED:goog.events.getUniqueId("opened")},goog.net.WebSocket.ReadyState_={CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3},goog.net.WebSocket.EXPONENTIAL_BACKOFF_CEILING_=6e4,goog.net.WebSocket.EXPONENTIAL_BACKOFF_=function(e){var o=1e3*Math.pow(2,e);return Math.min(o,goog.net.WebSocket.EXPONENTIAL_BACKOFF_CEILING_)},goog.net.WebSocket.protectEntryPoints=function(e){goog.net.WebSocket.prototype.onOpen_=e.protectEntryPoint(goog.net.WebSocket.prototype.onOpen_),goog.net.WebSocket.prototype.onClose_=e.protectEntryPoint(goog.net.WebSocket.prototype.onClose_),goog.net.WebSocket.prototype.onMessage_=e.protectEntryPoint(goog.net.WebSocket.prototype.onMessage_),goog.net.WebSocket.prototype.onError_=e.protectEntryPoint(goog.net.WebSocket.prototype.onError_)},goog.net.WebSocket.prototype.open=function(e,o){goog.asserts.assert(goog.global.WebSocket,"This browser does not support WebSocket"),goog.asserts.assert(!this.isOpen(),"The WebSocket is already open"),this.clearReconnectTimer_(),this.url_=e,this.protocol_=o,this.protocol_?(goog.log.info(this.logger_,"Opening the WebSocket on "+this.url_+" with protocol "+this.protocol_),this.webSocket_=new WebSocket(this.url_,this.protocol_)):(goog.log.info(this.logger_,"Opening the WebSocket on "+this.url_),this.webSocket_=new WebSocket(this.url_)),this.webSocket_.binaryType=this.binaryType_,this.webSocket_.onopen=goog.bind(this.onOpen_,this),this.webSocket_.onclose=goog.bind(this.onClose_,this),this.webSocket_.onmessage=goog.bind(this.onMessage_,this),this.webSocket_.onerror=goog.bind(this.onError_,this)},goog.net.WebSocket.prototype.close=function(){this.clearReconnectTimer_(),this.webSocket_&&(goog.log.info(this.logger_,"Closing the WebSocket."),this.closeExpected_=!0,this.webSocket_.close(),this.webSocket_=null)},goog.net.WebSocket.prototype.send=function(e){goog.asserts.assert(this.isOpen(),"Cannot send without an open socket"),this.webSocket_.send(e)},goog.net.WebSocket.prototype.isOpen=function(){return!!this.webSocket_&&this.webSocket_.readyState==goog.net.WebSocket.ReadyState_.OPEN},goog.net.WebSocket.prototype.getBufferedAmount=function(){return this.webSocket_.bufferedAmount},goog.net.WebSocket.prototype.onOpen_=function(){goog.log.info(this.logger_,"WebSocket opened on "+this.url_),this.dispatchEvent(goog.net.WebSocket.EventType.OPENED),this.reconnectAttempt_=0,this.nextReconnect_=this.getNextReconnect_(this.reconnectAttempt_)},goog.net.WebSocket.prototype.onClose_=function(e){if(goog.log.info(this.logger_,"The WebSocket on "+this.url_+" closed."),this.dispatchEvent(goog.net.WebSocket.EventType.CLOSED),this.webSocket_=null,this.closeExpected_)goog.log.info(this.logger_,"The WebSocket closed normally."),this.url_=null,this.protocol_=void 0;else if(goog.log.error(this.logger_,"The WebSocket disconnected unexpectedly: "+e.data),this.autoReconnect_){var o=Math.floor(this.nextReconnect_/1e3);goog.log.info(this.logger_,"Seconds until next reconnect attempt: "+o),this.reconnectTimer_=goog.Timer.callOnce(goog.bind(this.open,this,this.url_,this.protocol_),this.nextReconnect_,this),this.reconnectAttempt_++,this.nextReconnect_=this.getNextReconnect_(this.reconnectAttempt_)}this.closeExpected_=!1},goog.net.WebSocket.prototype.onMessage_=function(e){this.dispatchEvent(new goog.net.WebSocket.MessageEvent(e.data))},goog.net.WebSocket.prototype.onError_=function(e){var o=e.data;goog.log.error(this.logger_,"An error occurred: "+o),this.dispatchEvent(new goog.net.WebSocket.ErrorEvent(o))},goog.net.WebSocket.prototype.clearReconnectTimer_=function(){null!=this.reconnectTimer_&&goog.Timer.clear(this.reconnectTimer_),this.reconnectTimer_=null},goog.net.WebSocket.prototype.disposeInternal=function(){goog.net.WebSocket.base(this,"disposeInternal"),this.close()},goog.net.WebSocket.MessageEvent=function(e){goog.net.WebSocket.MessageEvent.base(this,"constructor",goog.net.WebSocket.EventType.MESSAGE),this.message=e},goog.inherits(goog.net.WebSocket.MessageEvent,goog.events.Event),goog.net.WebSocket.ErrorEvent=function(e){goog.net.WebSocket.ErrorEvent.base(this,"constructor",goog.net.WebSocket.EventType.ERROR),this.data=e},goog.inherits(goog.net.WebSocket.ErrorEvent,goog.events.Event),goog.debug.entryPointRegistry.register(function(e){goog.net.WebSocket.prototype.onOpen_=e(goog.net.WebSocket.prototype.onOpen_),goog.net.WebSocket.prototype.onClose_=e(goog.net.WebSocket.prototype.onClose_),goog.net.WebSocket.prototype.onMessage_=e(goog.net.WebSocket.prototype.onMessage_),goog.net.WebSocket.prototype.onError_=e(goog.net.WebSocket.prototype.onError_)});