goog.provide("goog.editor.SeamlessField"),goog.require("goog.cssom.iframe.style"),goog.require("goog.dom"),goog.require("goog.dom.Range"),goog.require("goog.dom.TagName"),goog.require("goog.dom.safe"),goog.require("goog.editor.BrowserFeature"),goog.require("goog.editor.Field"),goog.require("goog.editor.icontent"),goog.require("goog.editor.icontent.FieldFormatInfo"),goog.require("goog.editor.icontent.FieldStyleInfo"),goog.require("goog.editor.node"),goog.require("goog.events"),goog.require("goog.events.EventType"),goog.require("goog.html.SafeHtml"),goog.require("goog.log"),goog.require("goog.style"),goog.editor.SeamlessField=function(e,o){goog.editor.Field.call(this,e,o)},goog.inherits(goog.editor.SeamlessField,goog.editor.Field),goog.editor.SeamlessField.prototype.logger=goog.log.getLogger("goog.editor.SeamlessField"),goog.editor.SeamlessField.prototype.listenForDragOverEventKey_,goog.editor.SeamlessField.prototype.listenForIframeLoadEventKey_,goog.editor.SeamlessField.prototype.setMinHeight=function(e){e!=this.minHeight_&&(this.minHeight_=e,this.usesIframe()&&this.doFieldSizingGecko())},goog.editor.SeamlessField.prototype.isFixedHeight_=!1,goog.editor.SeamlessField.prototype.isFixedHeightOverridden_=!1,goog.editor.SeamlessField.prototype.isFixedHeight=function(){return this.isFixedHeight_},goog.editor.SeamlessField.prototype.overrideFixedHeight=function(e){this.isFixedHeight_=e,this.isFixedHeightOverridden_=!0},goog.editor.SeamlessField.prototype.autoDetectFixedHeight_=function(){if(!this.isFixedHeightOverridden_){var e=this.getOriginalElement();e&&(this.isFixedHeight_="auto"==goog.style.getComputedOverflowY(e))}},goog.editor.SeamlessField.prototype.handleOuterDocChange_=function(){this.isEventStopped(goog.editor.Field.EventType.CHANGE)||this.sizeIframeToWrapperGecko_()},goog.editor.SeamlessField.prototype.sizeIframeToBodyHeightGecko_=function(){if(this.acquireSizeIframeLockGecko_()){var e=!1,o=this.getEditableIframe();if(o){var t=this.getIframeBodyHeightGecko_();this.minHeight_&&(t=Math.max(t,this.minHeight_)),parseInt(goog.style.getStyle(o,"height"),10)!=t&&(o.style.height=t+"px",e=!0)}this.releaseSizeIframeLockGecko_(),e&&this.dispatchEvent(goog.editor.Field.EventType.IFRAME_RESIZED)}},goog.editor.SeamlessField.prototype.getIframeBodyHeightGecko_=function(){var e,o=this.getEditableIframe(),t=o.contentDocument.body,i=t.parentNode;return 0===parseInt(goog.style.getStyle(o,"height"),10)&&goog.style.setStyle(o,"height","1px"),goog.editor.node.isStandardsMode(t)?e=i.offsetHeight:(e=i.scrollHeight,i.clientHeight!=i.offsetHeight&&(e+=goog.editor.SeamlessField.getScrollbarWidth_())),e},goog.editor.SeamlessField.getScrollbarWidth_=function(){return goog.editor.SeamlessField.scrollbarWidth_||(goog.editor.SeamlessField.scrollbarWidth_=goog.style.getScrollbarWidth())},goog.editor.SeamlessField.prototype.sizeIframeToWrapperGecko_=function(){if(this.acquireSizeIframeLockGecko_()){var e=this.getEditableIframe(),o=this.getElement(),t=!1;if(e&&o){var i,s=e.parentNode,g=s.offsetWidth;parseInt(goog.style.getStyle(e,"width"),10)!=g&&(i=goog.style.getPaddingBox(o),e.style.width=g+"px",o.style.width=g-i.left-i.right+"px",t=!0);var r=s.offsetHeight;this.isFixedHeight()&&parseInt(goog.style.getStyle(e,"height"),10)!=r&&(i||(i=goog.style.getPaddingBox(o)),e.style.height=r+"px",o.style.height=r-i.top-i.bottom+"px",t=!0)}this.releaseSizeIframeLockGecko_(),t&&this.dispatchEvent(goog.editor.Field.EventType.IFRAME_RESIZED)}},goog.editor.SeamlessField.prototype.doFieldSizingGecko=function(){this.getElement()&&(this.sizeIframeToWrapperGecko_(),this.isFixedHeight()||this.sizeIframeToBodyHeightGecko_())},goog.editor.SeamlessField.prototype.acquireSizeIframeLockGecko_=function(){return!this.sizeIframeLock_&&(this.sizeIframeLock_=!0)},goog.editor.SeamlessField.prototype.releaseSizeIframeLockGecko_=function(){this.sizeIframeLock_=!1},goog.editor.SeamlessField.prototype.iframeableCss_="",goog.editor.SeamlessField.prototype.getIframeableCss=function(e){if(!this.iframeableCss_||e){var o=this.getOriginalElement();o&&(this.iframeableCss_=goog.cssom.iframe.style.getElementContext(o,e))}return this.iframeableCss_},goog.editor.SeamlessField.prototype.setIframeableCss=function(e){this.iframeableCss_=e},goog.editor.SeamlessField.haveInstalledCss_=!1,goog.editor.SeamlessField.prototype.usesIframe=function(){return!goog.editor.BrowserFeature.HAS_CONTENT_EDITABLE},goog.editor.SeamlessField.prototype.setupMutationEventHandlersGecko=function(){if(goog.editor.SeamlessField.superClass_.setupMutationEventHandlersGecko.call(this),this.usesIframe()){var e=this.getEditableIframe().ownerDocument;this.eventRegister.listen(e,goog.editor.Field.MUTATION_EVENTS_GECKO,this.handleOuterDocChange_,!0),this.listenForIframeLoadEventKey_=goog.events.listenOnce(this.getEditableDomHelper().getWindow(),goog.events.EventType.LOAD,this.sizeIframeToBodyHeightGecko_,!0,this),this.eventRegister.listen(e,"DOMAttrModified",goog.bind(this.handleDomAttrChange,this,this.handleOuterDocChange_),!0)}},goog.editor.SeamlessField.prototype.handleChange=function(){this.isEventStopped(goog.editor.Field.EventType.CHANGE)||(goog.editor.SeamlessField.superClass_.handleChange.call(this),this.usesIframe()&&this.sizeIframeToBodyHeightGecko_())},goog.editor.SeamlessField.prototype.dispatchBlur=function(){if(!this.isEventStopped(goog.editor.Field.EventType.BLUR)&&(goog.editor.SeamlessField.superClass_.dispatchBlur.call(this),!goog.editor.BrowserFeature.HAS_CONTENT_EDITABLE&&!goog.editor.BrowserFeature.CLEARS_SELECTION_WHEN_FOCUS_LEAVES)){var e=this.getEditableDomHelper().getWindow(),o=!1;goog.events.unlistenByKey(this.listenForDragOverEventKey_),this.listenForDragOverEventKey_=goog.events.listenOnce(e.document.body,"dragover",function(){o=!0}),goog.global.setTimeout(goog.bind(function(){if(!o&&this.editableDomHelper){var e=this.getRange(),t=this.editableDomHelper.getWindow();goog.dom.Range.clearSelection(t),e&&(e.collapse(!0),e.select())}},this),0)}},goog.editor.SeamlessField.prototype.turnOnDesignModeGecko=function(){goog.editor.SeamlessField.superClass_.turnOnDesignModeGecko.call(this);var e=this.getEditableDomHelper().getDocument();e.execCommand("enableInlineTableEditing",!1,"false"),e.execCommand("enableObjectResizing",!1,"false")},goog.editor.SeamlessField.prototype.installStyles=function(){this.usesIframe()||goog.editor.SeamlessField.haveInstalledCss_||(this.cssStyles.getTypedStringValue()&&goog.style.installSafeStyleSheet(this.cssStyles,this.getElement()),goog.editor.SeamlessField.haveInstalledCss_=!0)},goog.editor.SeamlessField.prototype.makeEditableInternal=function(e){if(this.usesIframe())goog.editor.SeamlessField.superClass_.makeEditableInternal.call(this,e);else{var o=this.getOriginalElement();o&&(this.setupFieldObject(o),o.contentEditable=!0,this.injectContents(o.innerHTML,o),this.handleFieldLoad())}},goog.editor.SeamlessField.prototype.handleFieldLoad=function(){if(this.usesIframe()){var e=this;goog.global.setTimeout(function(){e.doFieldSizingGecko()},0)}goog.editor.SeamlessField.superClass_.handleFieldLoad.call(this)},goog.editor.SeamlessField.prototype.getIframeAttributes=function(){return{frameBorder:0,style:"padding:0;"}},goog.editor.SeamlessField.prototype.attachIframe=function(e){this.autoDetectFixedHeight_();var o=this.getOriginalElement(),t=goog.dom.getDomHelper(o),i=o.style.width,s=o.style.height;goog.style.setStyle(o,"visibility","hidden");var g=t.createDom(goog.dom.TagName.DIV,{style:"height:0;clear:both",innerHTML:"&nbsp;"}),r=g.cloneNode(!0);o.insertBefore(g,o.firstChild),goog.dom.appendChild(o,r);var l=goog.style.getContentBoxSize(o),d=l.width,n=l.height,a="";if(this.isFixedHeight()&&(a="&nbsp;",goog.style.setStyle(o,"position","relative"),goog.style.setStyle(o,"overflow","visible"),goog.style.setStyle(e,"position","absolute"),goog.style.setStyle(e,"top","0"),goog.style.setStyle(e,"left","0")),goog.style.setSize(o,d,n),goog.editor.node.isStandardsMode(o)&&(this.originalFieldLineHeight_=o.style.lineHeight,goog.style.setStyle(o,"lineHeight","0")),goog.editor.node.replaceInnerHtml(o,a),goog.style.setSize(e,d,n),goog.style.setSize(o,i,s),goog.style.setStyle(o,"visibility",""),goog.dom.appendChild(o,e),!this.shouldLoadAsynchronously()){var h=e.contentWindow.document;if(goog.editor.node.isStandardsMode(e.ownerDocument)){h.open();var m=goog.html.SafeHtml.concat(goog.html.SafeHtml.DOCTYPE_HTML,goog.html.SafeHtml.create("html"));goog.dom.safe.documentWrite(h,m),h.close()}}},goog.editor.SeamlessField.prototype.getFieldFormatInfo=function(e){var o=this.getOriginalElement();if(o)return new goog.editor.icontent.FieldFormatInfo(this.id,goog.editor.node.isStandardsMode(o),!0,this.isFixedHeight(),e);throw new Error("no field")},goog.editor.SeamlessField.prototype.writeIframeContent=function(e,o,t){goog.style.setStyle(e,"visibility","hidden");var i=this.getFieldFormatInfo(t),s=new goog.editor.icontent.FieldStyleInfo(this.getOriginalElement(),this.cssStyles.getTypedStringValue()+this.getIframeableCss());goog.editor.icontent.writeNormalInitialBlendedIframe(i,o,s,e),this.doFieldSizingGecko(),goog.style.setStyle(e,"visibility","visible")},goog.editor.SeamlessField.prototype.restoreDom=function(){this.usesIframe()&&goog.dom.removeNode(this.getEditableIframe())},goog.editor.SeamlessField.prototype.clearListeners=function(){goog.events.unlistenByKey(this.listenForDragOverEventKey_),goog.events.unlistenByKey(this.listenForIframeLoadEventKey_),goog.editor.SeamlessField.base(this,"clearListeners")};