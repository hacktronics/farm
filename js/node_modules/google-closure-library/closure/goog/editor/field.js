goog.provide("goog.editor.Field"),goog.provide("goog.editor.Field.EventType"),goog.require("goog.a11y.aria"),goog.require("goog.a11y.aria.Role"),goog.require("goog.array"),goog.require("goog.asserts"),goog.require("goog.async.Delay"),goog.require("goog.dom"),goog.require("goog.dom.Range"),goog.require("goog.dom.TagName"),goog.require("goog.dom.classlist"),goog.require("goog.dom.safe"),goog.require("goog.editor.BrowserFeature"),goog.require("goog.editor.Command"),goog.require("goog.editor.PluginImpl"),goog.require("goog.editor.icontent"),goog.require("goog.editor.icontent.FieldFormatInfo"),goog.require("goog.editor.icontent.FieldStyleInfo"),goog.require("goog.editor.node"),goog.require("goog.editor.range"),goog.require("goog.events"),goog.require("goog.events.EventHandler"),goog.require("goog.events.EventTarget"),goog.require("goog.events.EventType"),goog.require("goog.events.KeyCodes"),goog.require("goog.functions"),goog.require("goog.html.SafeHtml"),goog.require("goog.html.SafeStyleSheet"),goog.require("goog.log"),goog.require("goog.log.Level"),goog.require("goog.string"),goog.require("goog.string.Unicode"),goog.require("goog.style"),goog.require("goog.userAgent"),goog.require("goog.userAgent.product"),goog.editor.Field=function(e,o){for(var t in goog.events.EventTarget.call(this),this.id=e,this.hashCode_=e,this.editableDomHelper=null,this.plugins_={},this.indexedPlugins_={},goog.editor.PluginImpl.OPCODE)this.indexedPlugins_[t]=[];for(var i in this.cssStyles=goog.html.SafeStyleSheet.EMPTY,this.stoppedEvents_={},this.stopEvent(goog.editor.Field.EventType.CHANGE),this.stopEvent(goog.editor.Field.EventType.DELAYEDCHANGE),this.isModified_=!1,this.isEverModified_=!1,this.delayedChangeTimer_=new goog.async.Delay(this.dispatchDelayedChange_,goog.editor.Field.DELAYED_CHANGE_FREQUENCY,this),this.registerDisposable(this.delayedChangeTimer_),this.debouncedEvents_={},goog.editor.Field.EventType)this.debouncedEvents_[goog.editor.Field.EventType[i]]=0;goog.editor.BrowserFeature.USE_MUTATION_EVENTS&&(this.changeTimerGecko_=new goog.async.Delay(this.handleChange,goog.editor.Field.CHANGE_FREQUENCY,this),this.registerDisposable(this.changeTimerGecko_)),this.eventRegister=new goog.events.EventHandler(this),this.wrappers_=[],this.loadState_=goog.editor.Field.LoadState_.UNEDITABLE;var r=o||document;this.originalDomHelper=goog.dom.getDomHelper(r),this.originalElement=this.originalDomHelper.getElement(this.id),this.followLinkInNewWindow_=goog.editor.BrowserFeature.FOLLOWS_EDITABLE_LINKS,this.appWindow_=this.originalDomHelper.getWindow()},goog.inherits(goog.editor.Field,goog.events.EventTarget),goog.editor.Field.prototype.field=null,goog.editor.Field.prototype.logger=goog.log.getLogger("goog.editor.Field"),goog.editor.Field.EventType={COMMAND_VALUE_CHANGE:"cvc",LOAD:"load",UNLOAD:"unload",BEFORECHANGE:"beforechange",CHANGE:"change",DELAYEDCHANGE:"delayedchange",BEFOREFOCUS:"beforefocus",FOCUS:"focus",BLUR:"blur",BEFORETAB:"beforetab",IFRAME_RESIZED:"ifrsz",BEFORESELECTIONCHANGE:"beforeselectionchange",SELECTIONCHANGE:"selectionchange"},goog.editor.Field.LoadState_={UNEDITABLE:0,LOADING:1,EDITABLE:2},goog.editor.Field.DEBOUNCE_TIME_MS_=500,goog.editor.Field.activeFieldId_=null,goog.editor.Field.prototype.inModalMode_=!1,goog.editor.Field.prototype.appWindow_,goog.editor.Field.prototype.selectionChangeTimer_=null,goog.editor.Field.prototype.isSelectionEditable_=!1,goog.editor.Field.prototype.selectionChangeTarget_,goog.editor.Field.prototype.useWindowMouseUp_=!1,goog.editor.Field.prototype.waitingForMouseUp_=!1,goog.editor.Field.setActiveFieldId=function(e){goog.editor.Field.activeFieldId_=e},goog.editor.Field.getActiveFieldId=function(){return goog.editor.Field.activeFieldId_},goog.editor.Field.prototype.setUseWindowMouseUp=function(e){goog.asserts.assert(!e||!this.usesIframe(),"procssing window mouse up should only be enabled when not using iframe"),this.useWindowMouseUp_=e},goog.editor.Field.prototype.inModalMode=function(){return this.inModalMode_},goog.editor.Field.prototype.setModalMode=function(e){this.inModalMode_=e},goog.editor.Field.prototype.getHashCode=function(){return this.hashCode_},goog.editor.Field.prototype.getElement=function(){return this.field},goog.editor.Field.prototype.getOriginalElement=function(){return this.originalElement},goog.editor.Field.prototype.addListener=function(e,o,t,i){var r=this.getElement();goog.editor.BrowserFeature.USE_DOCUMENT_FOR_KEY_EVENTS&&r&&this.usesIframe()&&(r=r.ownerDocument),i?this.eventRegister.listenWithScope(r,e,o,t,i):this.eventRegister.listen(r,e,o,t)},goog.editor.Field.prototype.getPluginByClassId=function(e){return this.plugins_[e]||null},goog.editor.Field.prototype.registerPlugin=function(e){var o=e.getTrogClassId();for(var t in this.plugins_[o]&&goog.log.error(this.logger,"Cannot register the same class of plugin twice."),this.plugins_[o]=e,goog.editor.PluginImpl.OPCODE){e[goog.editor.PluginImpl.OPCODE[t]]&&this.indexedPlugins_[t].push(e)}e.registerFieldObject(this),this.isLoaded()&&e.enable(this)},goog.editor.Field.prototype.unregisterPlugin=function(e){if(e){var o=e.getTrogClassId();for(var t in this.plugins_[o]||goog.log.error(this.logger,"Cannot unregister a plugin that isn't registered."),delete this.plugins_[o],goog.editor.PluginImpl.OPCODE){e[goog.editor.PluginImpl.OPCODE[t]]&&goog.array.remove(this.indexedPlugins_[t],e)}e.unregisterFieldObject(this)}},goog.editor.Field.prototype.setInitialStyle=function(e){this.cssText=e},goog.editor.Field.prototype.resetOriginalElemProperties=function(){var e=this.getOriginalElement();e.removeAttribute("contentEditable"),e.removeAttribute("g_editable"),e.removeAttribute("role"),this.id?e.id=this.id:e.removeAttribute("id"),e.className=this.savedClassName_||"";var o=this.cssText;o?goog.dom.setProperties(e,{style:o}):e.removeAttribute("style"),"string"==typeof this.originalFieldLineHeight_&&(goog.style.setStyle(e,"lineHeight",this.originalFieldLineHeight_),this.originalFieldLineHeight_=null)},goog.editor.Field.prototype.isModified=function(e){return e?this.isEverModified_:this.isModified_},goog.editor.Field.CHANGE_FREQUENCY=15,goog.editor.Field.DELAYED_CHANGE_FREQUENCY=250,goog.editor.Field.prototype.usesIframe=goog.functions.TRUE,goog.editor.Field.prototype.isFixedHeight=goog.functions.TRUE,goog.editor.Field.prototype.shouldRefocusOnInputMobileSafari=goog.functions.FALSE,goog.editor.Field.KEYS_CAUSING_CHANGES_={46:!0,8:!0},goog.userAgent.IE||(goog.editor.Field.KEYS_CAUSING_CHANGES_[9]=!0),goog.editor.Field.CTRL_KEYS_CAUSING_CHANGES_={86:!0,88:!0},goog.userAgent.WINDOWS&&!goog.userAgent.GECKO&&(goog.editor.Field.KEYS_CAUSING_CHANGES_[229]=!0),goog.editor.Field.isGeneratingKey_=function(e,o){return!!goog.editor.Field.isSpecialGeneratingKey_(e)||!(!o||e.ctrlKey||e.metaKey||goog.userAgent.GECKO&&!e.charCode)},goog.editor.Field.isSpecialGeneratingKey_=function(e){var o=(e.ctrlKey||e.metaKey)&&e.keyCode in goog.editor.Field.CTRL_KEYS_CAUSING_CHANGES_,t=!(e.ctrlKey||e.metaKey)&&e.keyCode in goog.editor.Field.KEYS_CAUSING_CHANGES_;return o||t},goog.editor.Field.prototype.setAppWindow=function(e){this.appWindow_=e},goog.editor.Field.prototype.getAppWindow=function(){return this.appWindow_},goog.editor.Field.prototype.setBaseZindex=function(e){this.baseZindex_=e},goog.editor.Field.prototype.getBaseZindex=function(){return this.baseZindex_||0},goog.editor.Field.prototype.setupFieldObject=function(e){this.loadState_=goog.editor.Field.LoadState_.EDITABLE,this.field=e,this.editableDomHelper=goog.dom.getDomHelper(e),this.isModified_=!1,this.isEverModified_=!1,e.setAttribute("g_editable","true"),goog.a11y.aria.setRole(e,goog.a11y.aria.Role.TEXTBOX)},goog.editor.Field.prototype.tearDownFieldObject_=function(){for(var e in this.loadState_=goog.editor.Field.LoadState_.UNEDITABLE,this.plugins_){var o=this.plugins_[e];o.activeOnUneditableFields()||o.disable(this)}this.field=null,this.editableDomHelper=null},goog.editor.Field.prototype.setupChangeListeners_=function(){if((goog.userAgent.product.IPHONE||goog.userAgent.product.IPAD)&&this.usesIframe()&&this.shouldRefocusOnInputMobileSafari()){var e=this.getEditableDomHelper().getWindow();this.boundRefocusListenerMobileSafari_=goog.bind(e.focus,e),e.addEventListener(goog.events.EventType.KEYDOWN,this.boundRefocusListenerMobileSafari_,!1),e.addEventListener(goog.events.EventType.TOUCHEND,this.boundRefocusListenerMobileSafari_,!1)}goog.userAgent.OPERA&&this.usesIframe()?(this.boundFocusListenerOpera_=goog.bind(this.dispatchFocusAndBeforeFocus_,this),this.boundBlurListenerOpera_=goog.bind(this.dispatchBlur,this),(e=this.getEditableDomHelper().getWindow()).addEventListener(goog.events.EventType.FOCUS,this.boundFocusListenerOpera_,!1),e.addEventListener(goog.events.EventType.BLUR,this.boundBlurListenerOpera_,!1)):(goog.editor.BrowserFeature.SUPPORTS_FOCUSIN?(this.addListener(goog.events.EventType.FOCUS,this.dispatchFocus_),this.addListener(goog.events.EventType.FOCUSIN,this.dispatchBeforeFocus_)):this.addListener(goog.events.EventType.FOCUS,this.dispatchFocusAndBeforeFocus_),this.addListener(goog.events.EventType.BLUR,this.dispatchBlur,goog.editor.BrowserFeature.USE_MUTATION_EVENTS));goog.editor.BrowserFeature.USE_MUTATION_EVENTS?this.setupMutationEventHandlersGecko():(this.addListener(["beforecut","beforepaste","drop","dragend"],this.dispatchBeforeChange),this.addListener(["cut","paste"],goog.functions.lock(this.dispatchChange)),this.addListener("drop",this.handleDrop_));var o=goog.userAgent.WEBKIT?"dragend":"dragdrop";this.addListener(o,this.handleDrop_),this.addListener(goog.events.EventType.KEYDOWN,this.handleKeyDown_),this.addListener(goog.events.EventType.KEYPRESS,this.handleKeyPress_),this.addListener(goog.events.EventType.KEYUP,this.handleKeyUp_),this.selectionChangeTimer_=new goog.async.Delay(this.handleSelectionChangeTimer_,goog.editor.Field.SELECTION_CHANGE_FREQUENCY_,this),this.registerDisposable(this.selectionChangeTimer_),this.followLinkInNewWindow_&&this.addListener(goog.events.EventType.CLICK,goog.editor.Field.cancelLinkClick_),this.addListener(goog.events.EventType.MOUSEDOWN,this.handleMouseDown_),this.useWindowMouseUp_?(this.eventRegister.listen(this.editableDomHelper.getDocument(),goog.events.EventType.MOUSEUP,this.handleMouseUp_),this.addListener(goog.events.EventType.DRAGSTART,this.handleDragStart_)):this.addListener(goog.events.EventType.MOUSEUP,this.handleMouseUp_)},goog.editor.Field.SELECTION_CHANGE_FREQUENCY_=250,goog.editor.Field.prototype.clearListeners=function(){if(this.eventRegister&&this.eventRegister.removeAll(),(goog.userAgent.product.IPHONE||goog.userAgent.product.IPAD)&&this.usesIframe()&&this.shouldRefocusOnInputMobileSafari()){try{(e=this.getEditableDomHelper().getWindow()).removeEventListener(goog.events.EventType.KEYDOWN,this.boundRefocusListenerMobileSafari_,!1),e.removeEventListener(goog.events.EventType.TOUCHEND,this.boundRefocusListenerMobileSafari_,!1)}catch(e){}delete this.boundRefocusListenerMobileSafari_}if(goog.userAgent.OPERA&&this.usesIframe()){try{var e;(e=this.getEditableDomHelper().getWindow()).removeEventListener(goog.events.EventType.FOCUS,this.boundFocusListenerOpera_,!1),e.removeEventListener(goog.events.EventType.BLUR,this.boundBlurListenerOpera_,!1)}catch(e){}delete this.boundFocusListenerOpera_,delete this.boundBlurListenerOpera_}this.changeTimerGecko_&&this.changeTimerGecko_.stop(),this.delayedChangeTimer_.stop()},goog.editor.Field.prototype.disposeInternal=function(){for(var e in(this.isLoading()||this.isLoaded())&&goog.log.warning(this.logger,"Disposing a field that is in use."),this.getOriginalElement()&&this.execCommand(goog.editor.Command.CLEAR_LOREM),this.tearDownFieldObject_(),this.clearListeners(),this.clearFieldLoadListener_(),this.originalDomHelper=null,this.eventRegister&&(this.eventRegister.dispose(),this.eventRegister=null),this.removeAllWrappers(),goog.editor.Field.getActiveFieldId()==this.id&&goog.editor.Field.setActiveFieldId(null),this.plugins_){var o=this.plugins_[e];o.isAutoDispose()&&o.dispose()}delete this.plugins_,goog.editor.Field.superClass_.disposeInternal.call(this)},goog.editor.Field.prototype.attachWrapper=function(e){this.wrappers_.push(e)},goog.editor.Field.prototype.removeAllWrappers=function(){for(var e;e=this.wrappers_.pop();)e.dispose()},goog.editor.Field.prototype.setFollowLinkInNewWindow=function(e){this.followLinkInNewWindow_=e},goog.editor.Field.MUTATION_EVENTS_GECKO=["DOMNodeInserted","DOMNodeRemoved","DOMNodeRemovedFromDocument","DOMNodeInsertedIntoDocument","DOMCharacterDataModified"],goog.editor.Field.prototype.setupMutationEventHandlersGecko=function(){if(goog.editor.BrowserFeature.HAS_DOM_SUBTREE_MODIFIED_EVENT||!this.usesIframe())this.eventRegister.listen(this.getElement(),"DOMSubtreeModified",this.handleMutationEventGecko_);else{var e=this.getEditableDomHelper().getDocument();this.eventRegister.listen(e,goog.editor.Field.MUTATION_EVENTS_GECKO,this.handleMutationEventGecko_,!0),this.eventRegister.listen(e,"DOMAttrModified",goog.bind(this.handleDomAttrChange,this,this.handleMutationEventGecko_),!0)}},goog.editor.Field.prototype.handleBeforeChangeKeyEvent_=function(e){return e.keyCode==goog.events.KeyCodes.TAB&&!this.dispatchBeforeTab_(e)||goog.userAgent.GECKO&&e.metaKey&&!goog.userAgent.isVersionOrHigher(29)&&(e.keyCode==goog.events.KeyCodes.LEFT||e.keyCode==goog.events.KeyCodes.RIGHT)?(e.preventDefault(),!1):(this.gotGeneratingKey_=e.charCode||goog.editor.Field.isGeneratingKey_(e,goog.userAgent.GECKO),this.gotGeneratingKey_&&this.dispatchBeforeChange(),!0)},goog.editor.Field.SELECTION_CHANGE_KEYCODES={8:1,9:1,13:1,33:1,34:1,35:1,36:1,37:1,38:1,39:1,40:1,46:1},goog.editor.Field.CTRL_KEYS_CAUSING_SELECTION_CHANGES_={65:!0,86:!0,88:!0},goog.editor.Field.POTENTIAL_SHORTCUT_KEYCODES_={8:1,9:1,13:1,27:1,33:1,34:1,37:1,38:1,39:1,40:1},goog.editor.Field.prototype.invokeShortCircuitingOp_=function(e,o){for(var t=this.indexedPlugins_[e],i=goog.array.slice(arguments,1),r=0;r<t.length;++r){var g=t[r];if((g.isEnabled(this)||goog.editor.PluginImpl.IRREPRESSIBLE_OPS[e])&&g[goog.editor.PluginImpl.OPCODE[e]].apply(g,i))return!0}return!1},goog.editor.Field.prototype.invokeOp_=function(e,o){for(var t=this.indexedPlugins_[e],i=goog.array.slice(arguments,1),r=0;r<t.length;++r){var g=t[r];(g.isEnabled(this)||goog.editor.PluginImpl.IRREPRESSIBLE_OPS[e])&&g[goog.editor.PluginImpl.OPCODE[e]].apply(g,i)}},goog.editor.Field.prototype.reduceOp_=function(e,o,t){for(var i=this.indexedPlugins_[e],r=goog.array.slice(arguments,1),g=0;g<i.length;++g){var n=i[g];(n.isEnabled(this)||goog.editor.PluginImpl.IRREPRESSIBLE_OPS[e])&&(r[0]=n[goog.editor.PluginImpl.OPCODE[e]].apply(n,r))}return r[0]},goog.editor.Field.prototype.injectContents=function(e,o){var t={},i=this.getInjectableContents(e,t);goog.style.setStyle(o,t),goog.editor.node.replaceInnerHtml(o,i)},goog.editor.Field.prototype.getInjectableContents=function(e,o){return this.reduceOp_(goog.editor.PluginImpl.Op.PREPARE_CONTENTS_HTML,e||"",o)},goog.editor.Field.prototype.handleKeyDown_=function(e){goog.userAgent.MAC&&e.keyCode==goog.events.KeyCodes.A&&this.maybeStartSelectionChangeTimer_(e),(goog.editor.BrowserFeature.USE_MUTATION_EVENTS||this.handleBeforeChangeKeyEvent_(e))&&!this.invokeShortCircuitingOp_(goog.editor.PluginImpl.Op.KEYDOWN,e)&&goog.editor.BrowserFeature.USES_KEYDOWN&&this.handleKeyboardShortcut_(e)},goog.editor.Field.prototype.handleKeyPress_=function(e){if(goog.editor.BrowserFeature.USE_MUTATION_EVENTS){if(!this.handleBeforeChangeKeyEvent_(e))return}else this.gotGeneratingKey_=!0,this.dispatchBeforeChange();this.invokeShortCircuitingOp_(goog.editor.PluginImpl.Op.KEYPRESS,e)||goog.editor.BrowserFeature.USES_KEYDOWN||this.handleKeyboardShortcut_(e)},goog.editor.Field.prototype.handleKeyUp_=function(e){goog.editor.BrowserFeature.USE_MUTATION_EVENTS||!this.gotGeneratingKey_&&!goog.editor.Field.isSpecialGeneratingKey_(e)||this.handleChange(),this.invokeShortCircuitingOp_(goog.editor.PluginImpl.Op.KEYUP,e),this.maybeStartSelectionChangeTimer_(e)},goog.editor.Field.prototype.maybeStartSelectionChangeTimer_=function(e){this.isEventStopped(goog.editor.Field.EventType.SELECTIONCHANGE)||(goog.editor.Field.SELECTION_CHANGE_KEYCODES[e.keyCode]||(e.ctrlKey||e.metaKey)&&goog.editor.Field.CTRL_KEYS_CAUSING_SELECTION_CHANGES_[e.keyCode])&&(this.dispatchEvent(goog.editor.Field.EventType.BEFORESELECTIONCHANGE),this.selectionChangeTimer_.start())},goog.editor.Field.prototype.handleKeyboardShortcut_=function(e){if(!e.altKey||e.shiftKey){var o=e.charCode||e.keyCode,t=String.fromCharCode(o).toLowerCase(),i=goog.userAgent.MAC?e.metaKey:e.ctrlKey,r=e.altKey&&e.shiftKey;if(i||r||goog.editor.Field.POTENTIAL_SHORTCUT_KEYCODES_[e.keyCode]){if(17==o)return;goog.userAgent.MAC&&goog.userAgent.GECKO&&"`"==t&&" "==e.getBrowserEvent().key&&(t=" "),e.keyCode==goog.events.KeyCodes.BACKSLASH&&(t="\\"),this.invokeShortCircuitingOp_(goog.editor.PluginImpl.Op.SHORTCUT,e,t,i)&&e.preventDefault()}}},goog.editor.Field.prototype.execCommand=function(e,o){for(var t,i=arguments,r=this.indexedPlugins_[goog.editor.PluginImpl.Op.EXEC_COMMAND],g=0;g<r.length;++g){var n=r[g];if(n.isEnabled(this)&&n.isSupportedCommand(e)){t=n.execCommand.apply(n,i);break}}return t},goog.editor.Field.prototype.queryCommandValue=function(e){var o=this.isLoaded()&&this.isSelectionEditable();if("string"==typeof e)return this.queryCommandValueInternal_(e,o);for(var t={},i=0;i<e.length;i++)t[e[i]]=this.queryCommandValueInternal_(e[i],o);return t},goog.editor.Field.prototype.queryCommandValueInternal_=function(e,o){for(var t=this.indexedPlugins_[goog.editor.PluginImpl.Op.QUERY_COMMAND],i=0;i<t.length;++i){var r=t[i];if(r.isEnabled(this)&&r.isSupportedCommand(e)&&(o||r.activeOnUneditableFields()))return r.queryCommandValue(e)}return!!o&&null},goog.editor.Field.prototype.handleDomAttrChange=function(e,o){if(!this.isEventStopped(goog.editor.Field.EventType.CHANGE)){var t=o.getBrowserEvent();try{if(t.originalTarget.prefix||"scrollbar"==t.originalTarget.nodeName)return}catch(e){return}t.prevValue!=t.newValue&&e.call(this,t)}},goog.editor.Field.prototype.handleMutationEventGecko_=function(e){this.isEventStopped(goog.editor.Field.EventType.CHANGE)||(e=e.getBrowserEvent?e.getBrowserEvent():e).target.firebugIgnore||(this.isModified_=!0,this.isEverModified_=!0,this.changeTimerGecko_.start())},goog.editor.Field.prototype.handleDrop_=function(e){goog.userAgent.IE&&this.execCommand(goog.editor.Command.CLEAR_LOREM,!0),goog.editor.BrowserFeature.USE_MUTATION_EVENTS&&this.dispatchFocusAndBeforeFocus_(),this.dispatchChange()},goog.editor.Field.prototype.getEditableIframe=function(){var e;if(this.usesIframe()&&(e=this.getEditableDomHelper())){var o=e.getWindow();return o&&o.frameElement}return null},goog.editor.Field.prototype.getEditableDomHelper=function(){return this.editableDomHelper},goog.editor.Field.prototype.getRange=function(){var e=this.editableDomHelper&&this.editableDomHelper.getWindow();return e&&goog.dom.Range.createFromWindow(e)},goog.editor.Field.prototype.dispatchSelectionChangeEvent=function(e,o){if(!this.isEventStopped(goog.editor.Field.EventType.SELECTIONCHANGE)){var t=this.getRange(),i=t&&t.getContainerElement();this.isSelectionEditable_=!!i&&goog.dom.contains(this.getElement(),i),this.dispatchCommandValueChange(),this.dispatchEvent({type:goog.editor.Field.EventType.SELECTIONCHANGE,originalType:e&&e.type}),this.invokeShortCircuitingOp_(goog.editor.PluginImpl.Op.SELECTION,e,o)}},goog.editor.Field.prototype.handleSelectionChangeTimer_=function(){var e=this.selectionChangeTarget_;this.selectionChangeTarget_=null,this.dispatchSelectionChangeEvent(void 0,e)},goog.editor.Field.prototype.dispatchBeforeChange=function(){this.isEventStopped(goog.editor.Field.EventType.BEFORECHANGE)||this.dispatchEvent(goog.editor.Field.EventType.BEFORECHANGE)},goog.editor.Field.prototype.dispatchBeforeTab_=function(e){return this.dispatchEvent({type:goog.editor.Field.EventType.BEFORETAB,shiftKey:e.shiftKey,altKey:e.altKey,ctrlKey:e.ctrlKey})},goog.editor.Field.prototype.stopChangeEvents=function(e,o){e&&(this.changeTimerGecko_&&this.changeTimerGecko_.fireIfActive(),this.stopEvent(goog.editor.Field.EventType.CHANGE)),o&&(this.clearDelayedChange(),this.stopEvent(goog.editor.Field.EventType.DELAYEDCHANGE))},goog.editor.Field.prototype.startChangeEvents=function(e,o){!e&&this.changeTimerGecko_&&this.changeTimerGecko_.fireIfActive(),this.startEvent(goog.editor.Field.EventType.CHANGE),this.startEvent(goog.editor.Field.EventType.DELAYEDCHANGE),e&&this.handleChange(),o&&this.dispatchDelayedChange_()},goog.editor.Field.prototype.stopEvent=function(e){this.stoppedEvents_[e]=1},goog.editor.Field.prototype.startEvent=function(e){this.stoppedEvents_[e]=0},goog.editor.Field.prototype.debounceEvent=function(e){this.debouncedEvents_[e]=goog.now()},goog.editor.Field.prototype.isEventStopped=function(e){return!!this.stoppedEvents_[e]||this.debouncedEvents_[e]&&goog.now()-this.debouncedEvents_[e]<=goog.editor.Field.DEBOUNCE_TIME_MS_},goog.editor.Field.prototype.manipulateDom=function(e,o,t){this.stopChangeEvents(!0,!0);try{e.call(t)}finally{this.isLoaded()&&(o?(this.startEvent(goog.editor.Field.EventType.CHANGE),this.handleChange(),this.startEvent(goog.editor.Field.EventType.DELAYEDCHANGE)):this.dispatchChange())}},goog.editor.Field.prototype.dispatchCommandValueChange=function(e){e?this.dispatchEvent({type:goog.editor.Field.EventType.COMMAND_VALUE_CHANGE,commands:e}):this.dispatchEvent(goog.editor.Field.EventType.COMMAND_VALUE_CHANGE)},goog.editor.Field.prototype.dispatchChange=function(e){this.startChangeEvents(!0,e)},goog.editor.Field.prototype.handleChange=function(){this.isEventStopped(goog.editor.Field.EventType.CHANGE)||(this.changeTimerGecko_&&this.changeTimerGecko_.stop(),this.isModified_=!0,this.isEverModified_=!0,this.isEventStopped(goog.editor.Field.EventType.DELAYEDCHANGE)||this.delayedChangeTimer_.start())},goog.editor.Field.prototype.dispatchDelayedChange_=function(){this.isEventStopped(goog.editor.Field.EventType.DELAYEDCHANGE)||(this.delayedChangeTimer_.stop(),this.isModified_=!1,this.dispatchEvent(goog.editor.Field.EventType.DELAYEDCHANGE))},goog.editor.Field.prototype.clearDelayedChange=function(){this.changeTimerGecko_&&this.changeTimerGecko_.fireIfActive(),this.delayedChangeTimer_.fireIfActive()},goog.editor.Field.prototype.dispatchFocusAndBeforeFocus_=function(){this.dispatchBeforeFocus_(),this.dispatchFocus_()},goog.editor.Field.prototype.dispatchBeforeFocus_=function(){this.isEventStopped(goog.editor.Field.EventType.BEFOREFOCUS)||(this.execCommand(goog.editor.Command.CLEAR_LOREM,!0),this.dispatchEvent(goog.editor.Field.EventType.BEFOREFOCUS))},goog.editor.Field.prototype.dispatchFocus_=function(){if(!this.isEventStopped(goog.editor.Field.EventType.FOCUS)){if(goog.editor.Field.setActiveFieldId(this.id),this.isSelectionEditable_=!0,this.dispatchEvent(goog.editor.Field.EventType.FOCUS),goog.editor.BrowserFeature.PUTS_CURSOR_BEFORE_FIRST_BLOCK_ELEMENT_ON_FOCUS){var e=this.getElement(),o=this.getRange();if(o){var t=o.getFocusNode();0!=o.getFocusOffset()||t&&t!=e&&t.tagName!=goog.dom.TagName.BODY||goog.editor.range.selectNodeStart(e)}}if(!goog.editor.BrowserFeature.CLEARS_SELECTION_WHEN_FOCUS_LEAVES&&this.usesIframe())this.getEditableDomHelper().getWindow().parent.getSelection().removeAllRanges()}},goog.editor.Field.prototype.dispatchBlur=function(){this.isEventStopped(goog.editor.Field.EventType.BLUR)||(goog.editor.Field.getActiveFieldId()==this.id&&goog.editor.Field.setActiveFieldId(null),this.isSelectionEditable_=!1,this.dispatchEvent(goog.editor.Field.EventType.BLUR))},goog.editor.Field.prototype.isSelectionEditable=function(){return this.isSelectionEditable_},goog.editor.Field.cancelLinkClick_=function(e){goog.dom.getAncestorByTagNameAndClass(e.target,goog.dom.TagName.A)&&e.preventDefault()},goog.editor.Field.prototype.handleMouseDown_=function(e){if(goog.editor.Field.setActiveFieldId(this.id),goog.userAgent.IE){var o=e.target;o&&o.tagName==goog.dom.TagName.A&&e.ctrlKey&&this.originalDomHelper.getWindow().open(o.href)}this.waitingForMouseUp_=!0},goog.editor.Field.prototype.handleDragStart_=function(e){this.waitingForMouseUp_=!1},goog.editor.Field.prototype.handleMouseUp_=function(e){this.useWindowMouseUp_&&!this.waitingForMouseUp_||(this.waitingForMouseUp_=!1,this.dispatchEvent(goog.editor.Field.EventType.BEFORESELECTIONCHANGE),this.dispatchSelectionChangeEvent(e),goog.userAgent.IE&&(this.selectionChangeTarget_=e.target,this.selectionChangeTimer_.start()))},goog.editor.Field.prototype.getCleanContents=function(){if(this.queryCommandValue(goog.editor.Command.USING_LOREM))return goog.string.Unicode.NBSP;if(!this.isLoaded()){var e=this.getOriginalElement();return e||goog.log.log(this.logger,goog.log.Level.SHOUT,"Couldn't get the field element to read the contents"),e.innerHTML}var o=this.getFieldCopy();return this.invokeOp_(goog.editor.PluginImpl.Op.CLEAN_CONTENTS_DOM,o),this.reduceOp_(goog.editor.PluginImpl.Op.CLEAN_CONTENTS_HTML,o.innerHTML)},goog.editor.Field.prototype.getFieldCopy=function(){var e=this.getElement(),o=e.cloneNode(!1),t=e.innerHTML;return goog.userAgent.IE&&t.match(/^\s*<script/i)&&(t=goog.string.Unicode.NBSP+t),o.innerHTML=t,o},goog.editor.Field.prototype.setSafeHtml=function(e,o,t,i){this.isLoading()?goog.log.error(this.logger,"Can't set html while loading Trogedit"):(i&&this.execCommand(goog.editor.Command.CLEAR_LOREM),o&&e&&(o=goog.html.SafeHtml.create("p",{},o)),t&&this.stopChangeEvents(!1,!0),this.setInnerHtml_(o),i&&this.execCommand(goog.editor.Command.UPDATE_LOREM),this.isLoaded()&&(t?(goog.editor.BrowserFeature.USE_MUTATION_EVENTS&&this.changeTimerGecko_.fireIfActive(),this.startChangeEvents()):this.dispatchChange()))},goog.editor.Field.prototype.setInnerHtml_=function(e){var o=this.getElement();if(o){if(this.usesIframe()&&goog.editor.BrowserFeature.MOVES_STYLE_TO_HEAD)for(var t=goog.dom.getElementsByTagName(goog.dom.TagName.HEAD,goog.asserts.assert(o.ownerDocument)),i=t.length-1;i>=1;--i)t[i].parentNode.removeChild(t[i])}else o=this.getOriginalElement();o&&this.injectContents(e&&goog.html.SafeHtml.unwrap(e),o)},goog.editor.Field.prototype.turnOnDesignModeGecko=function(){var e=this.getEditableDomHelper().getDocument();e.designMode="on",goog.editor.BrowserFeature.HAS_STYLE_WITH_CSS&&e.execCommand("styleWithCSS",!1,!1)},goog.editor.Field.prototype.installStyles=function(){this.cssStyles.getTypedStringValue()&&this.shouldLoadAsynchronously()&&goog.style.installSafeStyleSheet(this.cssStyles,this.getElement())},goog.editor.Field.prototype.dispatchLoadEvent_=function(){this.getElement(),this.installStyles(),this.startChangeEvents(),goog.log.info(this.logger,"Dispatching load "+this.id),this.dispatchEvent(goog.editor.Field.EventType.LOAD)},goog.editor.Field.prototype.isUneditable=function(){return this.loadState_==goog.editor.Field.LoadState_.UNEDITABLE},goog.editor.Field.prototype.isLoaded=function(){return this.loadState_==goog.editor.Field.LoadState_.EDITABLE},goog.editor.Field.prototype.isLoading=function(){return this.loadState_==goog.editor.Field.LoadState_.LOADING},goog.editor.Field.prototype.focus=function(){if(!goog.editor.BrowserFeature.HAS_CONTENT_EDITABLE&&this.usesIframe())this.getEditableDomHelper().getWindow().focus();else{if(goog.userAgent.OPERA)var e=this.appWindow_.pageXOffset,o=this.appWindow_.pageYOffset;this.getElement().focus(),goog.userAgent.OPERA&&this.appWindow_.scrollTo(e,o)}},goog.editor.Field.prototype.focusAndPlaceCursorAtStart=function(){!goog.editor.BrowserFeature.HAS_IE_RANGES&&goog.userAgent.GECKO||this.placeCursorAtStart(),this.focus()},goog.editor.Field.prototype.placeCursorAtStart=function(){this.placeCursorAtStartOrEnd_(!0)},goog.editor.Field.prototype.placeCursorAtEnd=function(){this.placeCursorAtStartOrEnd_(!1)},goog.editor.Field.prototype.placeCursorAtStartOrEnd_=function(e){var o=this.getElement();if(o){var t=e?goog.editor.node.getLeftMostLeaf(o):goog.editor.node.getRightMostLeaf(o);o==t?goog.dom.Range.createCaret(o,0).select():goog.editor.range.placeCursorNextTo(t,e),this.dispatchSelectionChangeEvent()}},goog.editor.Field.prototype.restoreSavedRange=function(e){e&&e.restore(),this.focus()},goog.editor.Field.prototype.makeEditable=function(e){this.loadState_=goog.editor.Field.LoadState_.LOADING;var o=this.getOriginalElement();this.nodeName=o.nodeName,this.savedClassName_=o.className,this.setInitialStyle(o.style.cssText),goog.dom.classlist.add(o,"editable"),this.makeEditableInternal(e)},goog.editor.Field.prototype.makeEditableInternal=function(e){this.makeIframeField_(e)},goog.editor.Field.prototype.handleFieldLoad=function(){for(var e in goog.userAgent.IE&&goog.dom.Range.clearSelection(this.editableDomHelper.getWindow()),goog.editor.Field.getActiveFieldId()!=this.id&&this.execCommand(goog.editor.Command.UPDATE_LOREM),this.setupChangeListeners_(),this.dispatchLoadEvent_(),this.plugins_)this.plugins_[e].enable(this)},goog.editor.Field.prototype.makeUneditable=function(e){if(this.isUneditable())throw new Error("makeUneditable: Field is already uneditable");this.clearDelayedChange(),this.selectionChangeTimer_.fireIfActive(),this.execCommand(goog.editor.Command.CLEAR_LOREM);var o=null;!e&&this.getElement()&&(o=this.getCleanContents()),this.clearFieldLoadListener_();var t=this.getOriginalElement();goog.editor.Field.getActiveFieldId()==t.id&&goog.editor.Field.setActiveFieldId(null),this.clearListeners(),"string"==typeof o&&(goog.editor.node.replaceInnerHtml(t,o),this.resetOriginalElemProperties()),this.restoreDom(),this.tearDownFieldObject_(),goog.userAgent.WEBKIT&&t.blur(),this.execCommand(goog.editor.Command.UPDATE_LOREM),this.dispatchEvent(goog.editor.Field.EventType.UNLOAD)},goog.editor.Field.prototype.restoreDom=function(){var e=this.getOriginalElement();if(e){var o=this.getEditableIframe();o&&goog.dom.replaceNode(e,o)}},goog.editor.Field.prototype.shouldLoadAsynchronously=function(){if(void 0===this.isHttps_&&(this.isHttps_=!1,goog.userAgent.IE&&this.usesIframe())){for(var e=this.originalDomHelper.getWindow();e!=e.parent;)try{e=e.parent}catch(e){break}var o=e.location;this.isHttps_="https:"==o.protocol&&-1==o.search.indexOf("nocheckhttps")}return this.isHttps_},goog.editor.Field.prototype.makeIframeField_=function(e){var o=this.getOriginalElement();if(o){var t=o.innerHTML,i={};t=this.reduceOp_(goog.editor.PluginImpl.Op.PREPARE_CONTENTS_HTML,t,i);var r=this.originalDomHelper.createDom(goog.dom.TagName.IFRAME,this.getIframeAttributes());if(this.shouldLoadAsynchronously()){var g=goog.bind(this.iframeFieldLoadHandler,this,r,t,i);this.fieldLoadListenerKey_=goog.events.listen(r,goog.events.EventType.LOAD,g,!0),e&&goog.dom.safe.setIframeSrc(r,e)}this.attachIframe(r),this.shouldLoadAsynchronously()||this.iframeFieldLoadHandler(r,t,i)}},goog.editor.Field.prototype.attachIframe=function(e){var o=this.getOriginalElement();e.className=o.className,e.id=o.id,goog.dom.replaceNode(e,o)},goog.editor.Field.prototype.getFieldFormatInfo=function(e){var o=this.getOriginalElement(),t=goog.editor.node.isStandardsMode(o);return new goog.editor.icontent.FieldFormatInfo(this.id,t,!1,!1,e)},goog.editor.Field.prototype.writeIframeContent=function(e,o,t){var i=this.getFieldFormatInfo(t);if(this.shouldLoadAsynchronously()){var r=goog.dom.getFrameContentDocument(e);goog.editor.icontent.writeHttpsInitialIframe(i,r,o)}else{var g=new goog.editor.icontent.FieldStyleInfo(this.getElement(),this.cssStyles.getTypedStringValue());goog.editor.icontent.writeNormalInitialIframe(i,o,g,e)}},goog.editor.Field.prototype.iframeFieldLoadHandler=function(e,o,t){this.clearFieldLoadListener_(),e.allowTransparency="true",this.writeIframeContent(e,o,t);var i=goog.dom.getFrameContentDocument(e).body;this.setupFieldObject(i),!goog.editor.BrowserFeature.HAS_CONTENT_EDITABLE&&this.usesIframe()&&this.turnOnDesignModeGecko(),this.handleFieldLoad()},goog.editor.Field.prototype.clearFieldLoadListener_=function(){this.fieldLoadListenerKey_&&(goog.events.unlistenByKey(this.fieldLoadListenerKey_),this.fieldLoadListenerKey_=null)},goog.editor.Field.prototype.getIframeAttributes=function(){var e="padding:0;"+this.getOriginalElement().style.cssText;return goog.string.endsWith(e,";")||(e+=";"),e+="background-color:white;",goog.userAgent.IE&&(e+="overflow:visible;"),{frameBorder:0,style:e}};