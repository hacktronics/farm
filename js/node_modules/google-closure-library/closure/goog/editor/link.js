goog.provide("goog.editor.Link"),goog.require("goog.array"),goog.require("goog.dom"),goog.require("goog.dom.NodeType"),goog.require("goog.dom.Range"),goog.require("goog.dom.TagName"),goog.require("goog.editor.BrowserFeature"),goog.require("goog.editor.Command"),goog.require("goog.editor.Field"),goog.require("goog.editor.node"),goog.require("goog.editor.range"),goog.require("goog.string"),goog.require("goog.string.Unicode"),goog.require("goog.uri.utils"),goog.require("goog.uri.utils.ComponentIndex"),goog.editor.Link=function(o,e){this.anchor_=o,this.isNew_=e,this.extraAnchors_=[]},goog.editor.Link.prototype.getAnchor=function(){return this.anchor_},goog.editor.Link.prototype.getExtraAnchors=function(){return this.extraAnchors_},goog.editor.Link.prototype.getCurrentText=function(){if(!this.currentText_){var o=this.getAnchor(),e=goog.editor.node.getLeftMostLeaf(o);e.tagName&&e.tagName==goog.dom.TagName.IMG?this.currentText_=e.getAttribute("alt")||"":this.currentText_=goog.dom.getRawTextContent(this.getAnchor())}return this.currentText_},goog.editor.Link.prototype.isNew=function(){return this.isNew_},goog.editor.Link.prototype.initializeUrl=function(o){this.getAnchor().href=o},goog.editor.Link.prototype.removeLink=function(){for(goog.dom.flattenElement(this.anchor_),this.anchor_=null;this.extraAnchors_.length;)goog.dom.flattenElement(this.extraAnchors_.pop())},goog.editor.Link.prototype.setTextAndUrl=function(o,e){var t=this.getAnchor();t.href=e;var i=this.getCurrentText();if(o!=i){var r=goog.editor.node.getLeftMostLeaf(t);if(r.tagName&&r.tagName==goog.dom.TagName.IMG)r.setAttribute("alt",o||"");else{r.nodeType==goog.dom.NodeType.TEXT&&(r=r.parentNode),goog.dom.getRawTextContent(r)!=i&&(r=t),goog.dom.removeChildren(r);var g=goog.dom.getDomHelper(r);goog.dom.appendChild(r,g.createTextNode(o))}this.currentText_=null}this.isNew_=!1},goog.editor.Link.prototype.placeCursorRightOf=function(){var o=this.getAnchor();if(goog.editor.BrowserFeature.GETS_STUCK_IN_LINKS){var e,t=o.nextSibling;if(t&&t.nodeType==goog.dom.NodeType.TEXT&&(goog.string.startsWith(t.data,goog.string.Unicode.NBSP)||goog.string.startsWith(t.data," ")))e=t;else e=goog.dom.getDomHelper(o).createTextNode(goog.string.Unicode.NBSP),goog.dom.insertSiblingAfter(e,o);goog.dom.Range.createCaret(e,1).select()}else goog.editor.range.placeCursorNextTo(o,!1)},goog.editor.Link.prototype.updateLinkDisplay_=function(o,e){this.initializeUrl(e),this.placeCursorRightOf(),o.execCommand(goog.editor.Command.UPDATE_LINK_BUBBLE)},goog.editor.Link.prototype.getValidLinkFromText=function(){var o=goog.string.trim(this.getCurrentText());return goog.editor.Link.isLikelyUrl(o)?o.search(/:/)<0?"http://"+goog.string.trimLeft(o):o:goog.editor.Link.isLikelyEmailAddress(o)?"mailto:"+o:null},goog.editor.Link.prototype.finishLinkCreation=function(o){var e=this.getValidLinkFromText();e?this.updateLinkDisplay_(o,e):o.execCommand(goog.editor.Command.MODAL_LINK_EDITOR,this)},goog.editor.Link.createNewLink=function(o,e,t,i){var r=new goog.editor.Link(o,!0);return r.initializeUrl(e),t&&(o.target=t),i&&(r.extraAnchors_=i),r},goog.editor.Link.createNewLinkFromText=function(o,e){var t=new goog.editor.Link(o,!0),i=t.getValidLinkFromText();return t.initializeUrl(i||""),e&&(o.target=e),t},goog.editor.Link.isLikelyUrl=function(o){if(/\s/.test(o))return!1;if(goog.editor.Link.isLikelyEmailAddress(o))return!1;var e=!1;/^[^:\/?#.]+:/.test(o)||(o="http://"+o,e=!0);var t=goog.uri.utils.split(o),i=t[goog.uri.utils.ComponentIndex.SCHEME];if(-1!=goog.array.indexOf(["mailto","aim"],i))return!0;var r=t[goog.uri.utils.ComponentIndex.DOMAIN];if(!r||e&&(-1===r.indexOf(".")||r.length<3)||/[^\w\d\-\u0100-\uffff.%]/.test(r))return!1;var g=t[goog.uri.utils.ComponentIndex.PATH];return!g||0==g.indexOf("/")},goog.editor.Link.LIKELY_EMAIL_ADDRESS_=new RegExp("^[\\w-]+(\\.[\\w-]+)*\\@([\\w-]+\\.)+(\\d+|\\w\\w+)$","i"),goog.editor.Link.isLikelyEmailAddress=function(o){return goog.editor.Link.LIKELY_EMAIL_ADDRESS_.test(o)},goog.editor.Link.isMailto=function(o){return!!o&&goog.string.startsWith(o,"mailto:")};