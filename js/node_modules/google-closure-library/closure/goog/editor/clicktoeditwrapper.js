goog.provide("goog.editor.ClickToEditWrapper"),goog.require("goog.Disposable"),goog.require("goog.dom"),goog.require("goog.dom.Range"),goog.require("goog.dom.TagName"),goog.require("goog.editor.BrowserFeature"),goog.require("goog.editor.Command"),goog.require("goog.editor.Field"),goog.require("goog.editor.range"),goog.require("goog.events.BrowserEvent"),goog.require("goog.events.EventHandler"),goog.require("goog.events.EventType"),goog.editor.ClickToEditWrapper=function(e){goog.Disposable.call(this),this.fieldObj_=e,this.originalDomHelper_=goog.dom.getDomHelper(e.getOriginalElement()),this.savedCaretRange_=null,this.fieldEventHandler_=new goog.events.EventHandler(this),this.finishMouseUpBound_=goog.bind(this.finishMouseUp_,this),this.mouseEventHandler_=new goog.events.EventHandler(this),this.fieldObj_.isLoaded()||this.enterDocument(),this.fieldEventHandler_.listen(this.fieldObj_,goog.editor.Field.EventType.LOAD,this.renderSelection_).listen(this.fieldObj_,goog.editor.Field.EventType.UNLOAD,this.enterDocument)},goog.inherits(goog.editor.ClickToEditWrapper,goog.Disposable),goog.editor.ClickToEditWrapper.prototype.getFieldObject=function(){return this.fieldObj_},goog.editor.ClickToEditWrapper.prototype.getOriginalDomHelper=function(){return this.originalDomHelper_},goog.editor.ClickToEditWrapper.prototype.disposeInternal=function(){goog.editor.ClickToEditWrapper.base(this,"disposeInternal"),this.exitDocument(),this.savedCaretRange_&&this.savedCaretRange_.dispose(),this.fieldEventHandler_.dispose(),this.mouseEventHandler_.dispose(),this.savedCaretRange_=null,delete this.fieldEventHandler_,delete this.mouseEventHandler_},goog.editor.ClickToEditWrapper.prototype.enterDocument=function(){if(!this.isInDocument_){this.isInDocument_=!0,this.mouseEventTriggeredLoad_=!1;var e=this.fieldObj_.getOriginalElement();this.savedAnchorClicked_=null,this.mouseEventHandler_.listen(e,goog.events.EventType.MOUSEUP,this.handleMouseUp_).listen(e,goog.events.EventType.CLICK,this.handleClick_),this.fieldObj_.execCommand(goog.editor.Command.UPDATE_LOREM)}},goog.editor.ClickToEditWrapper.prototype.exitDocument=function(){this.mouseEventHandler_.removeAll(),this.isInDocument_=!1},goog.editor.ClickToEditWrapper.prototype.getElement=function(){return this.fieldObj_.isLoaded()?this.fieldObj_.getElement():this.fieldObj_.getOriginalElement()},goog.editor.ClickToEditWrapper.prototype.shouldHandleMouseEvent_=function(e){return e.isButton(goog.events.BrowserEvent.MouseButton.LEFT)&&!(e.shiftKey||e.ctrlKey||e.altKey||e.metaKey)},goog.editor.ClickToEditWrapper.prototype.handleClick_=function(e){var o=goog.dom.getAncestorByTagNameAndClass(e.target,goog.dom.TagName.A);o&&(e.preventDefault(),goog.editor.BrowserFeature.HAS_ACTIVE_ELEMENT||(this.savedAnchorClicked_=o))},goog.editor.ClickToEditWrapper.prototype.handleMouseUp_=function(e){this.shouldHandleMouseEvent_(e)&&this.originalDomHelper_.getWindow().setTimeout(this.finishMouseUpBound_,0)},goog.editor.ClickToEditWrapper.prototype.finishMouseUp_=function(){this.fieldObj_.isLoaded()||(this.savedCaretRange_&&(this.savedCaretRange_.dispose(),this.savedCaretRange_=null),this.fieldObj_.queryCommandValue(goog.editor.Command.USING_LOREM)||this.insertCarets_(),this.ensureFieldEditable_()),this.exitDocument(),this.savedAnchorClicked_=null},goog.editor.ClickToEditWrapper.prototype.ensureFieldEditable_=function(){this.fieldObj_.isLoaded()||(this.mouseEventTriggeredLoad_=!0,this.makeFieldEditable(this.fieldObj_))},goog.editor.ClickToEditWrapper.prototype.renderSelection_=function(){if(this.savedCaretRange_){this.savedCaretRange_.setRestorationDocument(this.fieldObj_.getEditableDomHelper().getDocument());var e=this.savedCaretRange_.getCaret(!0),o=this.savedCaretRange_.getCaret(!1),t=e&&o}(this.mouseEventTriggeredLoad_||t)&&this.focusOnFieldObj(this.fieldObj_),t&&(this.savedCaretRange_.restore(),this.fieldObj_.dispatchSelectionChangeEvent()),this.savedCaretRange_&&(this.savedCaretRange_.dispose(),this.savedCaretRange_=null),this.mouseEventTriggeredLoad_=!1},goog.editor.ClickToEditWrapper.prototype.focusOnFieldObj=function(e){e.focusAndPlaceCursorAtStart()},goog.editor.ClickToEditWrapper.prototype.makeFieldEditable=function(e){e.makeEditable()},goog.editor.ClickToEditWrapper.createCaretRange_=function(e){return e&&goog.editor.range.saveUsingNormalizedCarets(e)},goog.editor.ClickToEditWrapper.prototype.insertCarets_=function(){var e=this.fieldObj_.getOriginalElement();this.savedCaretRange_=null;var o=this.originalDomHelper_.getWindow();if(goog.dom.Range.hasSelection(o)){var t=goog.dom.Range.createFromWindow(o);t=t&&goog.editor.range.narrow(t,e),this.savedCaretRange_=goog.editor.ClickToEditWrapper.createCaretRange_(t)}if(!this.savedCaretRange_){var i;(i=goog.editor.BrowserFeature.HAS_ACTIVE_ELEMENT?goog.dom.getActiveElement(this.originalDomHelper_.getDocument()):this.savedAnchorClicked_)&&goog.dom.getAncestor(i,function(o){return o==e},!0)&&(this.savedCaretRange_=goog.editor.ClickToEditWrapper.createCaretRange_(goog.dom.Range.createFromNodes(i,0,i,0)))}};