goog.provide("goog.editor.Table"),goog.provide("goog.editor.TableCell"),goog.provide("goog.editor.TableRow"),goog.require("goog.asserts"),goog.require("goog.dom"),goog.require("goog.dom.DomHelper"),goog.require("goog.dom.NodeType"),goog.require("goog.dom.TagName"),goog.require("goog.log"),goog.require("goog.string.Unicode"),goog.require("goog.style"),goog.editor.Table=function(o){this.element=goog.dom.getAncestorByTagNameAndClass(o,goog.dom.TagName.TABLE),this.element||goog.log.error(this.logger_,"Can't create Table based on a node that isn't a table, or descended from a table."),this.dom_=goog.dom.getDomHelper(this.element),this.refresh()},goog.editor.Table.prototype.logger_=goog.log.getLogger("goog.editor.Table"),goog.editor.Table.prototype.refresh=function(){var o=this.rows=[],e=goog.dom.getElementsByTagName(goog.dom.TagName.TBODY,goog.asserts.assert(this.element))[0];if(e){for(var t=[],r=e.firstChild;r;r=r.nextSibling)r.nodeName==goog.dom.TagName.TR&&t.push(r);for(var l,n=0;l=t[n];n++)for(var g,a=o[n],i=goog.editor.Table.getChildCellElements(l),s=0,d=0;g=i[d];d++){for(;a&&a.columns[s];)s++;for(var p=new goog.editor.TableCell(g,n,s),m=0;m<p.rowSpan;m++){var h=n+m,T=o[h];T||o.push(T=new goog.editor.TableRow(t[h],h));var c=s+p.colSpan;T.columns.length<c&&(T.columns.length=c);for(var u=0;u<p.colSpan;u++){var C=s+u;T.columns[C]=p}}s+=p.colSpan}}},goog.editor.Table.getChildCellElements=function(o){for(var e,t=[],r=0;e=o.childNodes[r];r++)e.nodeName!=goog.dom.TagName.TD&&e.nodeName!=goog.dom.TagName.TH||t.push(e);return t},goog.editor.Table.prototype.insertRow=function(o){var e,t,r=null!=o?o:this.rows.length;0==r?(e=this.rows[0],t=!1):(e=this.rows[r-1],t=!0);for(var l,n=this.dom_.createElement(goog.dom.TagName.TR),g=0;l=e.columns[g];g+=1)t&&l.endRow>r||!t&&l.startRow<r?(l.setRowSpan(l.rowSpan+1),l.colSpan>1&&(g+=l.colSpan-1)):n.appendChild(this.createEmptyTd()),t?goog.dom.insertSiblingAfter(n,e.element):goog.dom.insertSiblingBefore(n,e.element);return this.refresh(),n},goog.editor.Table.prototype.insertColumn=function(o){for(var e,t=null!=o?o:this.rows[0]&&this.rows[0].columns.length||0,r=[],l=0;e=this.rows[l];l++){var n=e.columns[t];if(n&&n.endCol>=t&&n.startCol<t)n.setColSpan(n.colSpan+1),l+=n.rowSpan-1;else{var g=this.createEmptyTd();g.style.width=goog.editor.Table.OPTIMUM_EMPTY_CELL_WIDTH+"px",this.insertCellElement(g,l,t),r.push(g)}}return this.refresh(),r},goog.editor.Table.prototype.removeRow=function(o){var e=this.rows[o];e||goog.log.warning(this.logger_,"Can't remove row at position "+o+": no such row.");for(var t,r=0;t=e.columns[r];r+=t.colSpan)t.rowSpan>1&&(t.setRowSpan(t.rowSpan-1),t.startRow==o&&this.insertCellElement(t.element,o+1,t.startCol));e.element.parentNode.removeChild(e.element),this.refresh()},goog.editor.Table.prototype.removeColumn=function(o){for(var e,t=0;e=this.rows[t];t++){var r=e.columns[o];r||goog.log.error(this.logger_,"Can't remove cell at position "+t+", "+o+": no such cell."),r.colSpan>1?r.setColSpan(r.colSpan-1):r.element.parentNode.removeChild(r.element),t+=r.rowSpan-1}this.refresh()},goog.editor.Table.prototype.mergeCells=function(o,e,t,r){var l,n=[];if(o==t&&e==r)return goog.log.warning(this.logger_,"Can't merge single cell"),!1;for(var g=o;g<=t;g++)for(var a=e;a<=r;a++){if((l=this.rows[g].columns[a]).startRow<o||l.endRow>t||l.startCol<e||l.endCol>r)return goog.log.warning(this.logger_,"Can't merge cells: the cell in row "+g+", column "+a+"extends outside the supplied rectangle."),!1;n.push(l)}var i=n[0],s=i.element,d=this.dom_.getDocument();for(g=1;l=n[g];g++){var p=l.element;if(p.parentNode&&p!=s){var m;for(s.lastChild&&s.lastChild.nodeType==goog.dom.NodeType.TEXT&&s.appendChild(d.createTextNode(" "));m=p.firstChild;)s.appendChild(m);p.parentNode.removeChild(p)}}return i.setColSpan(r-e+1),i.setRowSpan(t-o+1),r>e&&(s.removeAttribute("width"),s.style.width=null),this.refresh(),!0},goog.editor.Table.prototype.splitCell=function(o,e){for(var t=this.rows[o].columns[e],r=[],l=0;l<t.rowSpan;l++)for(var n=0;n<t.colSpan;n++)if(l>0||n>0){var g=this.createEmptyTd();this.insertCellElement(g,o+l,e+n),r.push(g)}return t.setColSpan(1),t.setRowSpan(1),this.refresh(),r},goog.editor.Table.prototype.insertCellElement=function(o,e,t){for(var r,l=this.rows[e],n=null,g=t;r=l.columns[g];g+=r.colSpan)if(r.startRow==e){n=r.element;break}l.element.insertBefore(o,n)},goog.editor.Table.prototype.createEmptyTd=function(){return this.dom_.createDom(goog.dom.TagName.TD,{},goog.string.Unicode.NBSP)},goog.editor.TableRow=function(o,e){this.index=e,this.element=o,this.columns=[]},goog.editor.TableCell=function(o,e,t){this.element=o,this.colSpan=parseInt(o.colSpan,10)||1,this.rowSpan=parseInt(o.rowSpan,10)||1,this.startRow=e,this.startCol=t,this.updateCoordinates_()},goog.editor.TableCell.prototype.updateCoordinates_=function(){this.endCol=this.startCol+this.colSpan-1,this.endRow=this.startRow+this.rowSpan-1},goog.editor.TableCell.prototype.setColSpan=function(o){o!=this.colSpan&&(o>1?this.element.colSpan=o:(this.element.colSpan=1,this.element.removeAttribute("colSpan")),this.colSpan=o,this.updateCoordinates_())},goog.editor.TableCell.prototype.setRowSpan=function(o){o!=this.rowSpan&&(o>1?this.element.rowSpan=o.toString():(this.element.rowSpan="1",this.element.removeAttribute("rowSpan")),this.rowSpan=o,this.updateCoordinates_())},goog.editor.Table.OPTIMUM_EMPTY_CELL_WIDTH=60,goog.editor.Table.OPTIMUM_MAX_NEW_TABLE_WIDTH=600,goog.editor.Table.DEFAULT_BORDER_COLOR="#888",goog.editor.Table.createDomTable=function(o,e,t,r){var l={borderWidth:"1",borderColor:goog.editor.Table.DEFAULT_BORDER_COLOR};for(var n in r)l[n]=r[n];for(var g,a=new goog.dom.DomHelper(o).createTable(t,e,!0),i=Math.max(10,Math.min(goog.editor.Table.OPTIMUM_EMPTY_CELL_WIDTH,goog.editor.Table.OPTIMUM_MAX_NEW_TABLE_WIDTH/e)),s=goog.dom.getElementsByTagName(goog.dom.TagName.TD,a),d=0;g=s[d];d++)g.style.width=i+"px";return goog.style.setStyle(a,{borderCollapse:"collapse",borderColor:l.borderColor,borderWidth:l.borderWidth+"px"}),a.border=l.borderWidth,a.setAttribute("bordercolor",l.borderColor),a.setAttribute("cellspacing","0"),a};