goog.provide("goog.editor.plugins.UndoRedo"),goog.require("goog.dom"),goog.require("goog.dom.NodeOffset"),goog.require("goog.dom.Range"),goog.require("goog.editor.BrowserFeature"),goog.require("goog.editor.Command"),goog.require("goog.editor.Field"),goog.require("goog.editor.Plugin"),goog.require("goog.editor.node"),goog.require("goog.editor.plugins.UndoRedoManager"),goog.require("goog.editor.plugins.UndoRedoState"),goog.require("goog.events"),goog.require("goog.events.EventHandler"),goog.require("goog.log"),goog.require("goog.object"),goog.editor.plugins.UndoRedo=function(o){goog.editor.Plugin.call(this),this.setUndoRedoManager(o||new goog.editor.plugins.UndoRedoManager),this.eventHandlers_={},this.currentStates_={},this.initialFieldChange_=null,this.boundRestoreState_=goog.bind(this.restoreState,this)},goog.inherits(goog.editor.plugins.UndoRedo,goog.editor.Plugin),goog.editor.plugins.UndoRedo.prototype.logger=goog.log.getLogger("goog.editor.plugins.UndoRedo"),goog.editor.plugins.UndoRedo.prototype.inProgressUndo_=null,goog.editor.plugins.UndoRedo.prototype.undoManager_,goog.editor.plugins.UndoRedo.prototype.managerStateChangeKey_,goog.editor.plugins.UndoRedo.COMMAND={UNDO:"+undo",REDO:"+redo"},goog.editor.plugins.UndoRedo.SUPPORTED_COMMANDS_=goog.object.transpose(goog.editor.plugins.UndoRedo.COMMAND),goog.editor.plugins.UndoRedo.prototype.setMaxUndoDepth=function(o){this.undoManager_.setMaxUndoDepth(o)},goog.editor.plugins.UndoRedo.prototype.setUndoRedoManager=function(o){this.managerStateChangeKey_&&goog.events.unlistenByKey(this.managerStateChangeKey_),this.undoManager_=o,this.managerStateChangeKey_=goog.events.listen(this.undoManager_,goog.editor.plugins.UndoRedoManager.EventType.STATE_CHANGE,this.dispatchCommandValueChange_,!1,this)},goog.editor.plugins.UndoRedo.prototype.isSupportedCommand=function(o){return o in goog.editor.plugins.UndoRedo.SUPPORTED_COMMANDS_},goog.editor.plugins.UndoRedo.prototype.unregisterFieldObject=function(o){this.disable(o),this.setFieldObject(null)},goog.editor.plugins.UndoRedo.prototype.getCurrentFieldObject=function(){return this.getFieldObject()},goog.editor.plugins.UndoRedo.prototype.getFieldObjectForHash=function(o){return this.getFieldObject()},goog.editor.plugins.UndoRedo.prototype.getCurrentEventTarget=function(){return this.getFieldObject()},goog.editor.plugins.UndoRedo.prototype.enable=function(o){if(!this.isEnabled(o)){o.clearDelayedChange();var e=new goog.events.EventHandler(this);goog.editor.BrowserFeature.USE_MUTATION_EVENTS||e.listen(o,goog.editor.Field.EventType.BEFORECHANGE,this.handleBeforeChange_),e.listen(o,goog.editor.Field.EventType.DELAYEDCHANGE,this.handleDelayedChange_),e.listen(o,goog.editor.Field.EventType.BLUR,this.handleBlur_),this.eventHandlers_[o.getHashCode()]=e,this.updateCurrentState_(o)}},goog.editor.plugins.UndoRedo.prototype.disable=function(o){o.clearDelayedChange();var e=this.eventHandlers_[o.getHashCode()];e&&(e.dispose(),delete this.eventHandlers_[o.getHashCode()]),this.currentStates_[o.getHashCode()]&&delete this.currentStates_[o.getHashCode()]},goog.editor.plugins.UndoRedo.prototype.isEnabled=function(o){return!!this.eventHandlers_[o.getHashCode()]},goog.editor.plugins.UndoRedo.prototype.disposeInternal=function(){for(var o in goog.editor.plugins.UndoRedo.superClass_.disposeInternal.call(this),this.eventHandlers_)this.eventHandlers_[o].dispose(),delete this.eventHandlers_[o];this.setFieldObject(null),this.undoManager_&&(this.undoManager_.dispose(),delete this.undoManager_)},goog.editor.plugins.UndoRedo.prototype.getTrogClassId=function(){return"UndoRedo"},goog.editor.plugins.UndoRedo.prototype.execCommand=function(o,e){o==goog.editor.plugins.UndoRedo.COMMAND.UNDO?this.undoManager_.undo():o==goog.editor.plugins.UndoRedo.COMMAND.REDO&&this.undoManager_.redo()},goog.editor.plugins.UndoRedo.prototype.queryCommandValue=function(o){var e=null;return o==goog.editor.plugins.UndoRedo.COMMAND.UNDO?e=this.undoManager_.hasUndoState():o==goog.editor.plugins.UndoRedo.COMMAND.REDO&&(e=this.undoManager_.hasRedoState()),e},goog.editor.plugins.UndoRedo.prototype.dispatchCommandValueChange_=function(){this.getCurrentEventTarget().dispatchEvent({type:goog.editor.Field.EventType.COMMAND_VALUE_CHANGE,commands:[goog.editor.plugins.UndoRedo.COMMAND.REDO,goog.editor.plugins.UndoRedo.COMMAND.UNDO]})},goog.editor.plugins.UndoRedo.prototype.restoreState=function(o,e,t){var n=this.getFieldObjectForHash(o.fieldHashCode);if(n){n.stopChangeEvents(!0,!0);try{n.dispatchBeforeChange(),n.execCommand(goog.editor.Command.CLEAR_LOREM,!0),goog.editor.node.replaceInnerHtml(n.getElement(),e),t&&t.select();var i=this.getCurrentFieldObject();n.focus(),i&&i.getHashCode()!=o.fieldHashCode&&i.execCommand(goog.editor.Command.UPDATE_LOREM),this.currentStates_[o.fieldHashCode].setUndoState(e,t)}catch(o){goog.log.error(this.logger,"Error while restoring undo state",o)}finally{this.inProgressUndo_=o,n.dispatchChange(),n.dispatchSelectionChangeEvent()}}},goog.editor.plugins.UndoRedo.prototype.handleKeyboardShortcut=function(o,e,t){var n;if(t&&("z"==e?n=o.shiftKey?goog.editor.plugins.UndoRedo.COMMAND.REDO:goog.editor.plugins.UndoRedo.COMMAND.UNDO:"y"==e&&(n=goog.editor.plugins.UndoRedo.COMMAND.REDO),n)){var i=n==goog.editor.plugins.UndoRedo.COMMAND.UNDO?this.undoManager_.undoPeek():this.undoManager_.redoPeek();return i&&i.fieldHashCode?this.getCurrentFieldObject().execCommand(n):this.execCommand(n),!0}return!1},goog.editor.plugins.UndoRedo.prototype.clearHistory=function(){this.getFieldObject().stopChangeEvents(!0,!0),this.undoManager_.clearHistory(),this.getFieldObject().startChangeEvents()},goog.editor.plugins.UndoRedo.prototype.refreshCurrentState=function(o){this.isEnabled(o)&&(this.currentStates_[o.getHashCode()]&&delete this.currentStates_[o.getHashCode()],this.updateCurrentState_(o))},goog.editor.plugins.UndoRedo.prototype.handleBeforeChange_=function(o){if(!this.inProgressUndo_){var e=o.target,t=e.getHashCode();this.initialFieldChange_!=t&&(this.initialFieldChange_=t,this.updateCurrentState_(e))}},goog.editor.plugins.UndoRedo.prototype.handleDelayedChange_=function(o){if(this.inProgressUndo_){var e=this.inProgressUndo_;return this.inProgressUndo_=null,void e.dispatchEvent(goog.editor.plugins.UndoRedoState.ACTION_COMPLETED)}this.updateCurrentState_(o.target)},goog.editor.plugins.UndoRedo.prototype.handleBlur_=function(o){var e=o.target;e&&e.clearDelayedChange()},goog.editor.plugins.UndoRedo.prototype.getCursorPosition_=function(o){var e=new goog.editor.plugins.UndoRedo.CursorPosition_(o);return e.isValid()?e:null},goog.editor.plugins.UndoRedo.prototype.updateCurrentState_=function(o){var e,t,n=o.getHashCode();o.queryCommandValue(goog.editor.Command.USING_LOREM)?(e="",t=null):(e=o.getElement().innerHTML,t=this.getCursorPosition_(o));var i=this.currentStates_[n];if(i){if(i.undoContent_==e)return;if(""==e||""==i.undoContent_){var d=o.getInjectableContents("",{});if(e==d&&""==i.undoContent_||i.undoContent_==d&&""==e)return}i.setRedoState(e,t),this.undoManager_.addState(i)}this.currentStates_[n]=new goog.editor.plugins.UndoRedo.UndoState_(n,e,t,this.boundRestoreState_)},goog.editor.plugins.UndoRedo.UndoState_=function(o,e,t,n){goog.editor.plugins.UndoRedoState.call(this,!0),this.fieldHashCode=o,this.restore_=n,this.setUndoState(e,t)},goog.inherits(goog.editor.plugins.UndoRedo.UndoState_,goog.editor.plugins.UndoRedoState),goog.editor.plugins.UndoRedo.UndoState_.prototype.undoContent_,goog.editor.plugins.UndoRedo.UndoState_.prototype.undoCursorPosition_,goog.editor.plugins.UndoRedo.UndoState_.prototype.redoContent_,goog.editor.plugins.UndoRedo.UndoState_.prototype.redoCursorPosition_,goog.editor.plugins.UndoRedo.UndoState_.prototype.getUndoContent=function(){return this.undoContent_},goog.editor.plugins.UndoRedo.UndoState_.prototype.getRedoContent=function(){return this.redoContent_},goog.editor.plugins.UndoRedo.UndoState_.prototype.undo=function(){this.restore_(this,this.undoContent_,this.undoCursorPosition_)},goog.editor.plugins.UndoRedo.UndoState_.prototype.redo=function(){this.restore_(this,this.redoContent_,this.redoCursorPosition_)},goog.editor.plugins.UndoRedo.UndoState_.prototype.setUndoState=function(o,e){this.undoContent_=o,this.undoCursorPosition_=e},goog.editor.plugins.UndoRedo.UndoState_.prototype.setRedoState=function(o,e){this.redoContent_=o,this.redoCursorPosition_=e},goog.editor.plugins.UndoRedo.UndoState_.prototype.equals=function(o){return this.fieldHashCode==o.fieldHashCode&&this.undoContent_==o.undoContent_&&this.redoContent_==o.redoContent_},goog.editor.plugins.UndoRedo.CursorPosition_=function(o){this.field_=o;var e=o.getEditableDomHelper().getWindow(),t=o.getRange(),n=!!t&&t.isRangeInDocument()&&t.getWindow()==e;t=n?t:null,goog.editor.BrowserFeature.HAS_W3C_RANGES?this.initW3C_(t):goog.editor.BrowserFeature.HAS_IE_RANGES&&this.initIE_(t)},goog.editor.plugins.UndoRedo.CursorPosition_.prototype.initW3C_=function(o){if(this.isValid_=!1,o){var e=o.getAnchorNode(),t=o.getFocusNode();if(e&&t){var n=o.getAnchorOffset(),i=new goog.dom.NodeOffset(e,this.field_.getElement()),d=o.getFocusOffset(),r=new goog.dom.NodeOffset(t,this.field_.getElement());o.isReversed()?(this.startOffset_=r,this.startChildOffset_=d,this.endOffset_=i,this.endChildOffset_=n):(this.startOffset_=i,this.startChildOffset_=n,this.endOffset_=r,this.endChildOffset_=d),this.isValid_=!0}}},goog.editor.plugins.UndoRedo.CursorPosition_.prototype.initIE_=function(o){if(this.isValid_=!1,o){var e=o.getTextRange(0).getBrowserRangeObject();if(goog.dom.contains(this.field_.getElement(),e.parentElement())){var t=this.field_.getEditableDomHelper().getDocument().body.createTextRange();t.moveToElementText(this.field_.getElement());var n=e.duplicate();n.collapse(!0),n.setEndPoint("StartToStart",t),this.startOffset_=goog.editor.plugins.UndoRedo.CursorPosition_.computeEndOffsetIE_(n);var i=e.duplicate();i.setEndPoint("StartToStart",t),this.endOffset_=goog.editor.plugins.UndoRedo.CursorPosition_.computeEndOffsetIE_(i),this.isValid_=!0}}},goog.editor.plugins.UndoRedo.CursorPosition_.prototype.isValid=function(){return this.isValid_},goog.editor.plugins.UndoRedo.CursorPosition_.prototype.toString=function(){return goog.editor.BrowserFeature.HAS_W3C_RANGES?"W3C:"+this.startOffset_.toString()+"\n"+this.startChildOffset_+":"+this.endOffset_.toString()+"\n"+this.endChildOffset_:"IE:"+this.startOffset_+","+this.endOffset_},goog.editor.plugins.UndoRedo.CursorPosition_.prototype.select=function(){var o=this.getRange_(this.field_.getElement());o&&(goog.editor.BrowserFeature.HAS_IE_RANGES&&this.field_.getElement().focus(),goog.dom.Range.createFromBrowserRange(o).select())},goog.editor.plugins.UndoRedo.CursorPosition_.prototype.getRange_=function(o){if(goog.editor.BrowserFeature.HAS_W3C_RANGES){var e=this.startOffset_.findTargetNode(o),t=this.endOffset_.findTargetNode(o);return e&&t?goog.dom.Range.createFromNodes(e,this.startChildOffset_,t,this.endChildOffset_).getBrowserRangeObject():null}var n=o.ownerDocument.body.createTextRange();return n.moveToElementText(o),n.collapse(!0),n.moveEnd("character",this.endOffset_),n.moveStart("character",this.startOffset_),n},goog.editor.plugins.UndoRedo.CursorPosition_.computeEndOffsetIE_=function(o){var e,t=o.duplicate(),n=o.text,i=n.length;t.collapse(!0),t.moveEnd("character",i);for(var d=10;(e=t.compareEndPoints("EndToEnd",o))&&(i-=e,t.moveEnd("character",-e),0!=--d););for(var r=0,g=n.indexOf("\n\r");-1!=g;)++r,g=n.indexOf("\n\r",g+1);return i+r};