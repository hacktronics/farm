goog.provide("goog.editor.plugins.RemoveFormatting"),goog.require("goog.dom"),goog.require("goog.dom.NodeType"),goog.require("goog.dom.Range"),goog.require("goog.dom.TagName"),goog.require("goog.editor.BrowserFeature"),goog.require("goog.editor.Plugin"),goog.require("goog.editor.node"),goog.require("goog.editor.range"),goog.require("goog.string"),goog.require("goog.userAgent"),goog.editor.plugins.RemoveFormatting=function(){goog.editor.Plugin.call(this),this.optRemoveFormattingFunc_=null,this.keyboardShortcutKey_=" "},goog.inherits(goog.editor.plugins.RemoveFormatting,goog.editor.Plugin),goog.editor.plugins.RemoveFormatting.REMOVE_FORMATTING_COMMAND="+removeFormat",goog.editor.plugins.RemoveFormatting.BLOCK_RE_=/^(DIV|TR|LI|BLOCKQUOTE|H\d|PRE|XMP)/,goog.editor.plugins.RemoveFormatting.appendNewline_=function(e){e.push("<br>")},goog.editor.plugins.RemoveFormatting.createRangeDelimitedByRanges_=function(e,o){return goog.dom.Range.createFromNodes(e.getStartNode(),e.getStartOffset(),o.getEndNode(),o.getEndOffset())},goog.editor.plugins.RemoveFormatting.prototype.getTrogClassId=function(){return"RemoveFormatting"},goog.editor.plugins.RemoveFormatting.prototype.isSupportedCommand=function(e){return e==goog.editor.plugins.RemoveFormatting.REMOVE_FORMATTING_COMMAND},goog.editor.plugins.RemoveFormatting.prototype.execCommandInternal=function(e,o){e==goog.editor.plugins.RemoveFormatting.REMOVE_FORMATTING_COMMAND&&this.removeFormatting_()},goog.editor.plugins.RemoveFormatting.prototype.handleKeyboardShortcut=function(e,o,t){return!!t&&((!e.metaKey||!e.ctrlKey)&&(!e.shiftKey&&(o==this.keyboardShortcutKey_&&(this.getFieldObject().execCommand(goog.editor.plugins.RemoveFormatting.REMOVE_FORMATTING_COMMAND),!0))))},goog.editor.plugins.RemoveFormatting.prototype.setKeyboardShortcutKey=function(e){this.keyboardShortcutKey_=e},goog.editor.plugins.RemoveFormatting.prototype.removeFormatting_=function(){var e=this.getFieldObject().getRange();if(e&&!e.isCollapsed()){var o=this.optRemoveFormattingFunc_||goog.bind(this.removeFormattingWorker_,this);this.convertSelectedHtmlText_(o),this.getFieldDomHelper().getDocument().execCommand("RemoveFormat",!1,void 0),goog.editor.BrowserFeature.ADDS_NBSPS_IN_REMOVE_FORMAT&&this.convertSelectedHtmlText_(function(e){var o=goog.userAgent.isVersionOrHigher("528")?/&nbsp;/g:/\u00A0/g;return e.replace(o," ")})}},goog.editor.plugins.RemoveFormatting.prototype.getTableAncestor_=function(e){for(var o=this.getFieldObject().getElement();e&&e!=o;){if(e.tagName==goog.dom.TagName.TABLE)return e;e=e.parentNode}return null},goog.editor.plugins.RemoveFormatting.prototype.pasteHtml_=function(e){var o=this.getFieldObject().getRange(),t=this.getFieldDomHelper(),g=goog.string.createUniqueString(),r=goog.string.createUniqueString();e='<span id="'+g+'"></span>'+e+'<span id="'+r+'"></span>';var n=goog.string.createUniqueString(),i='<span id="'+n+'"></span>';if(goog.editor.BrowserFeature.HAS_IE_RANGES){var a=o.getTextRange(0).getBrowserRangeObject();for(a.pasteHTML(i);(m=a.parentElement())&&goog.editor.node.isEmpty(m)&&!goog.editor.node.isEditableContainer(m);){if((l=m.nodeName)==goog.dom.TagName.TD||l==goog.dom.TagName.TR||l==goog.dom.TagName.TH)break;goog.dom.removeNode(m)}a.pasteHTML(e),(s=t.getElement(n))&&goog.dom.removeNode(s)}else if(goog.editor.BrowserFeature.HAS_W3C_RANGES){t.getDocument().execCommand("insertImage",!1,n);var m,d=new RegExp("<[^<]*"+n+"[^>]*>");for((m=this.getFieldObject().getRange().getContainerElement()).nodeType==goog.dom.NodeType.TEXT&&(m=m.parentNode);!d.test(m.innerHTML);)m=m.parentNode;if(goog.userAgent.GECKO)goog.editor.node.replaceInnerHtml(m,m.innerHTML.replace(d,e.replace(/\$/g,"$$$$")));else{var s;for(goog.editor.node.replaceInnerHtml(m,m.innerHTML.replace(d,i)),m=s=t.getElement(n);(m=s.parentNode)&&goog.editor.node.isEmpty(m)&&!goog.editor.node.isEditableContainer(m);){var l;if((l=m.nodeName)==goog.dom.TagName.TD||l==goog.dom.TagName.TR||l==goog.dom.TagName.TH)break;goog.dom.insertSiblingAfter(s,m),goog.dom.removeNode(m)}goog.editor.node.replaceInnerHtml(m,m.innerHTML.replace(new RegExp(i,"i"),e.replace(/\$/g,"$$$$")))}}var p=t.getElement(g),u=t.getElement(r);goog.dom.Range.createFromNodes(p,0,u,u.childNodes.length).select(),goog.dom.removeNode(p),goog.dom.removeNode(u)},goog.editor.plugins.RemoveFormatting.prototype.getHtmlText_=function(e){var o=this.getFieldDomHelper().createDom(goog.dom.TagName.DIV),t=e.getBrowserRangeObject();if(goog.editor.BrowserFeature.HAS_W3C_RANGES)o.appendChild(t.cloneContents());else if(goog.editor.BrowserFeature.HAS_IE_RANGES){var g=e.getText(),r=(g=g.replace(/\r\n/g,"\r")).length,n=r-goog.string.trimLeft(g).length,i=r-goog.string.trimRight(g).length;t.moveStart("character",n),t.moveEnd("character",-i);var a=t.htmlText;"Formatted"==t.queryCommandValue("formatBlock")&&(a=goog.string.newLineToBr(t.htmlText)),o.innerHTML=a}return o.innerHTML},goog.editor.plugins.RemoveFormatting.prototype.adjustRangeForTables_=function(e,o,t){var g=goog.editor.range.saveUsingNormalizedCarets(e),r=e.getStartNode(),n=e.getStartOffset(),i=e.getEndNode(),a=e.getEndOffset(),m=this.getFieldDomHelper();if(o){var d=m.createTextNode("");goog.dom.insertSiblingAfter(d,o),r=d,n=0}if(t){d=m.createTextNode("");goog.dom.insertSiblingBefore(d,t),i=d,a=0}return goog.dom.Range.createFromNodes(r,n,i,a).select(),g},goog.editor.plugins.RemoveFormatting.prototype.putCaretInCave_=function(e,o){var t=goog.dom.removeNode(e.getCaret(o));o?this.startCaretInCave_=t:this.endCaretInCave_=t},goog.editor.plugins.RemoveFormatting.prototype.restoreCaretsFromCave_=function(){var e=this.getFieldObject().getElement();this.startCaretInCave_&&(e.insertBefore(this.startCaretInCave_,e.firstChild),this.startCaretInCave_=null),this.endCaretInCave_&&(e.appendChild(this.endCaretInCave_),this.endCaretInCave_=null)},goog.editor.plugins.RemoveFormatting.prototype.convertSelectedHtmlText_=function(e){var o=this.getFieldObject().getRange();if(!(o.getTextRangeCount()>1)){if(goog.userAgent.GECKO||goog.userAgent.EDGE){var t=goog.editor.range.expand(o,this.getFieldObject().getElement()),g=this.getTableAncestor_(t.getStartNode()),r=this.getTableAncestor_(t.getEndNode());if(g||r){if(g==r)return;var n=this.adjustRangeForTables_(o,g,r);g||this.putCaretInCave_(n,!0),r||this.putCaretInCave_(n,!1),o=this.getFieldObject().getRange(),t=goog.editor.range.expand(o,this.getFieldObject().getElement())}t.select(),o=t}var i=this.getHtmlText_(o);if(this.pasteHtml_(e(i)),(goog.userAgent.GECKO||goog.userAgent.EDGE)&&n){o=this.getFieldObject().getRange(),this.restoreCaretsFromCave_();var a=n.toAbstractRange(),m=g?a:o,d=r?a:o;goog.editor.plugins.RemoveFormatting.createRangeDelimitedByRanges_(m,d).select(),n.dispose()}}},goog.editor.plugins.RemoveFormatting.prototype.removeFormattingWorker_=function(e){var o=goog.dom.createElement(goog.dom.TagName.DIV);o.innerHTML=e;for(var t=[],g=[o.childNodes,0],r=[],n=0,i=[],a=0,m=0;m>=0;m-=2){for(var d=!1;a>0&&m<=i[a-1];)a--,d=!0;for(d&&goog.editor.plugins.RemoveFormatting.appendNewline_(t),d=!1;n>0&&m<=r[n-1];)n--,d=!0;d&&goog.editor.plugins.RemoveFormatting.appendNewline_(t);for(var s=g[m],l=g[m+1];l<s.length;){var p=s[l++],u=p.nodeName,c=this.getValueForNode(p);if(null==c){switch(u){case"#text":var v=n>0?p.nodeValue:goog.string.stripNewlines(p.nodeValue);v=goog.string.htmlEscape(v),t.push(v);continue;case String(goog.dom.TagName.P):goog.editor.plugins.RemoveFormatting.appendNewline_(t),goog.editor.plugins.RemoveFormatting.appendNewline_(t);break;case String(goog.dom.TagName.BR):goog.editor.plugins.RemoveFormatting.appendNewline_(t);continue;case String(goog.dom.TagName.TABLE):goog.editor.plugins.RemoveFormatting.appendNewline_(t),i[a++]=m;break;case String(goog.dom.TagName.PRE):case"XMP":r[n++]=m;break;case String(goog.dom.TagName.STYLE):case String(goog.dom.TagName.SCRIPT):case String(goog.dom.TagName.SELECT):continue;case String(goog.dom.TagName.A):if(p.href&&""!=p.href){t.push("<a href='"),t.push(p.href),t.push("'>"),t.push(this.removeFormattingWorker_(p.innerHTML)),t.push("</a>");continue}break;case String(goog.dom.TagName.IMG):t.push("<img src='"),t.push(p.src),t.push("'"),"0"==p.border&&t.push(" border='0'"),t.push(">");continue;case String(goog.dom.TagName.TD):p.previousSibling&&t.push(" ");break;case String(goog.dom.TagName.TR):p.previousSibling&&goog.editor.plugins.RemoveFormatting.appendNewline_(t);break;case String(goog.dom.TagName.DIV):var h=p.parentNode;if(h.firstChild==p&&goog.editor.plugins.RemoveFormatting.BLOCK_RE_.test(h.tagName))break;default:goog.editor.plugins.RemoveFormatting.BLOCK_RE_.test(u)&&goog.editor.plugins.RemoveFormatting.appendNewline_(t)}var R=p.childNodes;R.length>0&&(g[m++]=s,g[m++]=l,s=R,l=0)}else t.push(c)}}return goog.string.normalizeSpaces(t.join(""))},goog.editor.plugins.RemoveFormatting.prototype.getValueForNode=function(e){return null},goog.editor.plugins.RemoveFormatting.prototype.setRemoveFormattingFunc=function(e){this.optRemoveFormattingFunc_=e};