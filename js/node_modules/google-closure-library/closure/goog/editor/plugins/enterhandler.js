goog.provide("goog.editor.plugins.EnterHandler"),goog.require("goog.dom"),goog.require("goog.dom.NodeOffset"),goog.require("goog.dom.NodeType"),goog.require("goog.dom.Range"),goog.require("goog.dom.TagName"),goog.require("goog.editor.BrowserFeature"),goog.require("goog.editor.Plugin"),goog.require("goog.editor.node"),goog.require("goog.editor.plugins.Blockquote"),goog.require("goog.editor.range"),goog.require("goog.editor.style"),goog.require("goog.events.KeyCodes"),goog.require("goog.functions"),goog.require("goog.object"),goog.require("goog.string"),goog.require("goog.userAgent"),goog.editor.plugins.EnterHandler=function(){goog.editor.Plugin.call(this)},goog.inherits(goog.editor.plugins.EnterHandler,goog.editor.Plugin),goog.editor.plugins.EnterHandler.prototype.tag=goog.dom.TagName.DIV,goog.editor.plugins.EnterHandler.prototype.getTrogClassId=function(){return"EnterHandler"},goog.editor.plugins.EnterHandler.prototype.enable=function(e){(goog.editor.plugins.EnterHandler.base(this,"enable",e),!goog.editor.BrowserFeature.SUPPORTS_OPERA_DEFAULTBLOCK_COMMAND||this.tag!=goog.dom.TagName.P&&this.tag!=goog.dom.TagName.DIV)||this.getFieldDomHelper().getDocument().execCommand("opera-defaultBlock",!1,this.tag)},goog.editor.plugins.EnterHandler.prototype.prepareContentsHtml=function(e){return!e||goog.string.isBreakingWhitespace(e)?goog.editor.BrowserFeature.COLLAPSES_EMPTY_NODES?this.getNonCollapsingBlankHtml():"":e},goog.editor.plugins.EnterHandler.prototype.getNonCollapsingBlankHtml=goog.functions.constant("<br>"),goog.editor.plugins.EnterHandler.prototype.handleBackspaceInternal=function(e,o){var t=this.getFieldObject().getElement(),g=o&&o.getStartNode();t.firstChild==g&&goog.editor.node.isEmpty(g)&&(e.preventDefault(),e.stopPropagation())},goog.editor.plugins.EnterHandler.prototype.processParagraphTagsInternal=function(e,o){if(goog.userAgent.IE||goog.userAgent.OPERA)this.ensureBlockIeOpera(goog.dom.TagName.DIV);else if(!o&&goog.userAgent.WEBKIT){var t=this.getFieldObject().getRange();if(!t||!goog.editor.plugins.EnterHandler.isDirectlyInBlockquote(t.getContainerElement()))return;var g=this.getFieldDomHelper(),r=g.createElement(goog.dom.TagName.BR);t.insertNode(r,!0),goog.editor.node.isBlockTag(r.parentNode)&&!goog.editor.node.skipEmptyTextNodes(r.nextSibling)&&goog.dom.insertSiblingBefore(g.createElement(goog.dom.TagName.BR),r),goog.editor.range.placeCursorNextTo(r,!1),e.preventDefault()}},goog.editor.plugins.EnterHandler.isDirectlyInBlockquote=function(e){for(var o=e;o;o=o.parentNode)if(goog.editor.node.isBlockTag(o))return o.tagName==goog.dom.TagName.BLOCKQUOTE;return!1},goog.editor.plugins.EnterHandler.prototype.handleDeleteGecko=function(e){this.deleteBrGecko(e)},goog.editor.plugins.EnterHandler.prototype.deleteBrGecko=function(e){var o=this.getFieldObject().getRange();if(o.isCollapsed()){var t=o.getEndNode();if(t.nodeType==goog.dom.NodeType.ELEMENT){var g=t.childNodes[o.getEndOffset()];if(g&&g.tagName==goog.dom.TagName.BR){var r=goog.editor.node.getPreviousSibling(g),n=g.nextSibling;if(t.removeChild(g),e.preventDefault(),n&&goog.editor.node.isBlockTag(n))if(r&&r.tagName!=goog.dom.TagName.BR&&!goog.editor.node.isBlockTag(r))goog.dom.Range.createCaret(r,goog.editor.node.getLength(r)).select();else{var i=goog.editor.node.getLeftMostLeaf(n);goog.dom.Range.createCaret(i,0).select()}}}}},goog.editor.plugins.EnterHandler.prototype.handleKeyDown=function(e){if(goog.userAgent.GECKO){if(this.getFieldObject().inModalMode())return!1;e.keyCode==goog.events.KeyCodes.BACKSPACE?this.handleBackspaceInternal(e,this.getFieldObject().getRange()):e.keyCode==goog.events.KeyCodes.DELETE&&this.handleDeleteGecko(e)}return!1},goog.editor.plugins.EnterHandler.prototype.handleKeyPress=function(e){if(e.keyCode==goog.events.KeyCodes.ENTER)if(goog.userAgent.GECKO)e.shiftKey||this.handleEnterGecko_(e);else{this.getFieldObject().dispatchBeforeChange();var o=this.deleteCursorSelection_(),t=!!this.getFieldObject().execCommand(goog.editor.plugins.Blockquote.SPLIT_COMMAND,o);t&&(e.preventDefault(),e.stopPropagation()),this.releasePositionObject_(o),goog.userAgent.WEBKIT&&this.handleEnterWebkitInternal(e),this.processParagraphTagsInternal(e,t),this.getFieldObject().dispatchChange()}return!1},goog.editor.plugins.EnterHandler.prototype.handleKeyUp=function(e){return goog.userAgent.GECKO&&this.getFieldObject().inModalMode()||this.handleKeyUpInternal(e),!1},goog.editor.plugins.EnterHandler.prototype.handleKeyUpInternal=function(e){(goog.userAgent.IE||goog.userAgent.OPERA)&&e.keyCode==goog.events.KeyCodes.ENTER&&this.ensureBlockIeOpera(goog.dom.TagName.DIV,!0)},goog.editor.plugins.EnterHandler.prototype.handleEnterGecko_=function(e){var o=this.getFieldObject().getRange(),t=!o||o.isCollapsed(),g=this.deleteCursorSelection_(),r=this.getFieldObject().execCommand(goog.editor.plugins.Blockquote.SPLIT_COMMAND,g);r&&(e.preventDefault(),e.stopPropagation()),this.releasePositionObject_(g),r||this.handleEnterAtCursorGeckoInternal(e,t,o)},goog.editor.plugins.EnterHandler.prototype.handleEnterWebkitInternal=goog.nullFunction,goog.editor.plugins.EnterHandler.prototype.handleEnterAtCursorGeckoInternal=goog.nullFunction,goog.editor.plugins.EnterHandler.DO_NOT_ENSURE_BLOCK_NODES_=goog.object.createSet(goog.dom.TagName.LI,goog.dom.TagName.DIV,goog.dom.TagName.H1,goog.dom.TagName.H2,goog.dom.TagName.H3,goog.dom.TagName.H4,goog.dom.TagName.H5,goog.dom.TagName.H6),goog.editor.plugins.EnterHandler.isBrElem=function(e){return goog.editor.node.isEmpty(e)&&1==goog.dom.getElementsByTagName(goog.dom.TagName.BR,e).length},goog.editor.plugins.EnterHandler.prototype.ensureBlockIeOpera=function(e,o){for(var t=this.getFieldObject().getRange(),g=t.getContainer(),r=this.getFieldObject().getElement(),n=void 0;g&&g!=r;){var i=g.nodeName;if(i==e||goog.editor.plugins.EnterHandler.DO_NOT_ENSURE_BLOCK_NODES_[i]&&(!o||!goog.editor.plugins.EnterHandler.isBrElem(g))){if(goog.userAgent.OPERA&&n){i==e&&n==g.lastChild&&goog.editor.node.isEmpty(n)&&(goog.dom.insertSiblingAfter(n,g),goog.dom.Range.createFromNodeContents(n).select());break}return}goog.userAgent.OPERA&&o&&i==goog.dom.TagName.P&&i!=e&&(n=g),g=g.parentNode}if(goog.userAgent.IE&&!goog.userAgent.isVersionOrHigher(9)){var a=!1,d=(t=t.getBrowserRangeObject()).duplicate();if(d.moveEnd("character",1),d.text.length){var l=d.parentElement(),s=d.duplicate();s.collapse(!1);var u=s.parentElement();(a=l!=u&&u!=t.parentElement())&&(t.move("character",-1),t.select())}}this.getFieldObject().getEditableDomHelper().getDocument().execCommand("FormatBlock",!1,"<"+e+">"),a&&(t.move("character",1),t.select())},goog.editor.plugins.EnterHandler.prototype.deleteCursorSelection_=function(){return goog.editor.BrowserFeature.HAS_W3C_RANGES?this.deleteCursorSelectionW3C_():this.deleteCursorSelectionIE_()},goog.editor.plugins.EnterHandler.prototype.releasePositionObject_=function(e){goog.editor.BrowserFeature.HAS_W3C_RANGES||e.removeNode(!0)},goog.editor.plugins.EnterHandler.prototype.deleteCursorSelectionIE_=function(){var e=this.getFieldDomHelper().getDocument(),o=e.selection.createRange(),t=goog.string.createUniqueString();o.pasteHTML('<span id="'+t+'"></span>');var g=e.getElementById(t);return g.id="",g},goog.editor.plugins.EnterHandler.prototype.deleteCursorSelectionW3C_=function(){var e=this.getFieldObject().getRange();if(e&&!e.isCollapsed()){var o=!0;if(goog.userAgent.OPERA){var t=e.getStartNode(),g=e.getStartOffset();t==e.getEndNode()&&t.lastChild&&t.lastChild.tagName==goog.dom.TagName.BR&&g==t.childNodes.length-1&&(o=!1)}o&&goog.editor.plugins.EnterHandler.deleteW3cRange_(e)}return goog.editor.range.getDeepEndPoint(e,!0)},goog.editor.plugins.EnterHandler.deleteW3cRange_=function(e){if(e&&!e.isCollapsed()){var o=!0,t=e.getContainerElement(),g=new goog.dom.NodeOffset(e.getStartNode(),t),r=e.getStartOffset(),n=goog.editor.plugins.EnterHandler.isInOneContainerW3c_(e),i=!n&&goog.editor.plugins.EnterHandler.isPartialEndW3c_(e);e.removeContents();var a=g.findTargetNode(t);if(a?e=goog.dom.Range.createCaret(a,r):(e=goog.dom.Range.createCaret(t,t.childNodes.length),o=!1),e.select(),n){var d=goog.editor.style.getContainer(e.getStartNode());if(goog.editor.node.isEmpty(d,!0)){var l="&nbsp;";goog.userAgent.OPERA&&d.tagName==goog.dom.TagName.LI&&(l="<br>"),goog.editor.node.replaceInnerHtml(d,l),goog.editor.range.selectNodeStart(d.firstChild),o=!1}}if(i){var s=goog.editor.style.getContainer(e.getStartNode()),u=goog.editor.node.getNextSibling(s);s&&u&&(goog.dom.append(s,u.childNodes),goog.dom.removeNode(u))}o&&(e=goog.dom.Range.createCaret(g.findTargetNode(t),r)).select()}return e},goog.editor.plugins.EnterHandler.isInOneContainerW3c_=function(e){var o=e.getStartNode();goog.editor.style.isContainer(o)&&(o=o.childNodes[e.getStartOffset()]||o),o=goog.editor.style.getContainer(o);var t=e.getEndNode();return goog.editor.style.isContainer(t)&&(t=t.childNodes[e.getEndOffset()]||t),o==(t=goog.editor.style.getContainer(t))},goog.editor.plugins.EnterHandler.isPartialEndW3c_=function(e){var o=e.getEndNode(),t=e.getEndOffset(),g=o;if(goog.editor.style.isContainer(g)){var r=g.childNodes[t];if(!r||r.nodeType==goog.dom.NodeType.ELEMENT&&goog.editor.style.isContainer(r))return!1}for(var n=goog.editor.style.getContainer(g);n!=g;){if(goog.editor.node.getNextSibling(g))return!0;g=g.parentNode}return t!=goog.editor.node.getLength(o)};