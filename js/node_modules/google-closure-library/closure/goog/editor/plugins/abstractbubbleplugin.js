goog.provide("goog.editor.plugins.AbstractBubblePlugin"),goog.require("goog.array"),goog.require("goog.dom"),goog.require("goog.dom.NodeType"),goog.require("goog.dom.Range"),goog.require("goog.dom.TagName"),goog.require("goog.dom.classlist"),goog.require("goog.editor.Plugin"),goog.require("goog.editor.style"),goog.require("goog.events"),goog.require("goog.events.EventHandler"),goog.require("goog.events.EventType"),goog.require("goog.events.KeyCodes"),goog.require("goog.events.actionEventWrapper"),goog.require("goog.functions"),goog.require("goog.string.Unicode"),goog.require("goog.ui.Component"),goog.require("goog.ui.editor.Bubble"),goog.require("goog.userAgent"),goog.editor.plugins.AbstractBubblePlugin=function(){goog.editor.plugins.AbstractBubblePlugin.base(this,"constructor"),this.eventRegister=new goog.events.EventHandler(this),this.bubbleFactory_=null},goog.inherits(goog.editor.plugins.AbstractBubblePlugin,goog.editor.Plugin),goog.editor.plugins.AbstractBubblePlugin.OPTION_LINK_CLASSNAME_=goog.getCssName("tr_option-link"),goog.editor.plugins.AbstractBubblePlugin.LINK_CLASSNAME_=goog.getCssName("tr_bubble_link"),goog.editor.plugins.AbstractBubblePlugin.TABBABLE_CLASSNAME_=goog.getCssName("tr_bubble_tabbable"),goog.editor.plugins.AbstractBubblePlugin.DASH_NBSP_STRING=goog.string.Unicode.NBSP+"-"+goog.string.Unicode.NBSP,goog.editor.plugins.AbstractBubblePlugin.defaultBubbleFactory_=function(e,t){return new goog.ui.editor.Bubble(e,t)},goog.editor.plugins.AbstractBubblePlugin.globalBubbleFactory_=goog.editor.plugins.AbstractBubblePlugin.defaultBubbleFactory_,goog.editor.plugins.AbstractBubblePlugin.setBubbleFactory=function(e){goog.editor.plugins.AbstractBubblePlugin.globalBubbleFactory_=e},goog.editor.plugins.AbstractBubblePlugin.bubbleMap_={},goog.editor.plugins.AbstractBubblePlugin.prototype.bubbleParent_,goog.editor.plugins.AbstractBubblePlugin.prototype.panelId_=null,goog.editor.plugins.AbstractBubblePlugin.prototype.keyboardNavigationEnabled_=!1,goog.editor.plugins.AbstractBubblePlugin.prototype.setBubbleFactory=function(e){this.bubbleFactory_=e},goog.editor.plugins.AbstractBubblePlugin.prototype.enableKeyboardNavigation=function(e){this.keyboardNavigationEnabled_=e},goog.editor.plugins.AbstractBubblePlugin.prototype.setBubbleParent=function(e){this.bubbleParent_=e},goog.editor.plugins.AbstractBubblePlugin.prototype.getBubbleMap=function(){return goog.editor.plugins.AbstractBubblePlugin.bubbleMap_},goog.editor.plugins.AbstractBubblePlugin.prototype.getBubbleDom=function(){return this.dom_},goog.editor.plugins.AbstractBubblePlugin.prototype.getTrogClassId=goog.functions.constant("AbstractBubblePlugin"),goog.editor.plugins.AbstractBubblePlugin.prototype.getTargetElement=function(){return this.targetElement_},goog.editor.plugins.AbstractBubblePlugin.prototype.handleKeyUp=function(e){return this.isVisible()&&this.handleSelectionChange(),!1},goog.editor.plugins.AbstractBubblePlugin.prototype.handleSelectionChange=function(e,t){var o;if(e)o=e.target;else if(t)o=t;else{var g=this.getFieldObject().getRange();if(g){var i=g.getStartNode(),n=g.getEndNode(),l=g.getStartOffset(),r=g.getEndOffset();if(goog.userAgent.IE&&g.isCollapsed()&&i!=n&&(g=goog.dom.Range.createCaret(i,l)),i.nodeType==goog.dom.NodeType.ELEMENT&&i==n&&l==r-1){var b=i.childNodes[l];b.nodeType==goog.dom.NodeType.ELEMENT&&(o=b)}}o=o||g&&g.getContainerElement()}return this.handleSelectionChangeInternal(o)},goog.editor.plugins.AbstractBubblePlugin.prototype.handleSelectionChangeInternal=function(e){if(e){var t=this.getBubbleTargetFromSelection(e);if(t)return t==this.targetElement_&&this.panelId_||(this.panelId_&&this.closeBubble(),this.createBubble(t)),!1}return this.panelId_&&this.closeBubble(),!1},goog.editor.plugins.AbstractBubblePlugin.prototype.getBubbleTargetFromSelection=goog.abstractMethod,goog.editor.plugins.AbstractBubblePlugin.prototype.disable=function(e){if(e.isUneditable()){var t=this.getBubbleMap(),o=t[e.id];o&&(e==this.getFieldObject()&&this.closeBubble(),o.dispose(),delete t[e.id])}},goog.editor.plugins.AbstractBubblePlugin.prototype.getSharedBubble_=function(){var e=this.bubbleParent_||this.getFieldObject().getAppWindow().document.body;this.dom_=goog.dom.getDomHelper(e);var t=this.getBubbleMap(),o=t[this.getFieldObject().id];o||(o=(this.bubbleFactory_||goog.editor.plugins.AbstractBubblePlugin.globalBubbleFactory_).call(null,e,this.getFieldObject().getBaseZindex()),t[this.getFieldObject().id]=o);return o},goog.editor.plugins.AbstractBubblePlugin.prototype.createBubble=function(e){var t=this.getSharedBubble_();t.hasPanelOfType(this.getBubbleType())||(this.targetElement_=e,this.panelId_=t.addPanel(this.getBubbleType(),this.getBubbleTitle(),e,goog.bind(this.createBubbleContents,this),this.shouldPreferBubbleAboveElement()),this.eventRegister.listen(t,goog.ui.Component.EventType.HIDE,this.handlePanelClosed_),this.onShow(),this.keyboardNavigationEnabled_&&this.eventRegister.listen(t.getContentElement(),goog.events.EventType.KEYDOWN,this.onBubbleKey_))},goog.editor.plugins.AbstractBubblePlugin.prototype.getBubbleType=function(){return""},goog.editor.plugins.AbstractBubblePlugin.prototype.getBubbleTitle=function(){return""},goog.editor.plugins.AbstractBubblePlugin.prototype.shouldPreferBubbleAboveElement=goog.functions.FALSE,goog.editor.plugins.AbstractBubblePlugin.prototype.createBubbleContents=goog.abstractMethod,goog.editor.plugins.AbstractBubblePlugin.prototype.registerClickHandler=function(e,t){this.registerActionHandler(e,t)},goog.editor.plugins.AbstractBubblePlugin.prototype.registerActionHandler=function(e,t){this.eventRegister.listenWithWrapper(e,goog.events.actionEventWrapper,t)},goog.editor.plugins.AbstractBubblePlugin.prototype.closeBubble=function(){this.panelId_&&(this.getSharedBubble_().removePanel(this.panelId_),this.handlePanelClosed_())},goog.editor.plugins.AbstractBubblePlugin.prototype.onShow=goog.nullFunction,goog.editor.plugins.AbstractBubblePlugin.prototype.cleanOnBubbleClose=goog.nullFunction,goog.editor.plugins.AbstractBubblePlugin.prototype.handlePanelClosed_=function(){this.targetElement_=null,this.panelId_=null,this.eventRegister.removeAll(),this.cleanOnBubbleClose()},goog.editor.plugins.AbstractBubblePlugin.prototype.handleKeyDown=function(e){if(this.keyboardNavigationEnabled_&&this.isVisible()&&e.keyCode==goog.events.KeyCodes.TAB&&!e.shiftKey){var t=this.getSharedBubble_().getContentElement(),o=goog.dom.getElementByClass(goog.editor.plugins.AbstractBubblePlugin.TABBABLE_CLASSNAME_,t);if(o)return o.focus(),e.preventDefault(),!0}return!1},goog.editor.plugins.AbstractBubblePlugin.prototype.onBubbleKey_=function(e){if(this.isVisible()&&e.keyCode==goog.events.KeyCodes.TAB){var t=this.getSharedBubble_().getContentElement(),o=goog.dom.getElementsByClass(goog.editor.plugins.AbstractBubblePlugin.TABBABLE_CLASSNAME_,t);(e.shiftKey?o[0]:goog.array.peek(o))==e.target&&(this.getFieldObject().focus(),e.preventDefault())}},goog.editor.plugins.AbstractBubblePlugin.prototype.isVisible=function(){return!!this.panelId_},goog.editor.plugins.AbstractBubblePlugin.prototype.reposition=function(){var e=this.getSharedBubble_();e&&e.reposition()},goog.editor.plugins.AbstractBubblePlugin.prototype.createLinkOption=function(e){return this.dom_.createDom(goog.dom.TagName.SPAN,{id:e,className:goog.editor.plugins.AbstractBubblePlugin.OPTION_LINK_CLASSNAME_},this.dom_.createTextNode(goog.editor.plugins.AbstractBubblePlugin.DASH_NBSP_STRING))},goog.editor.plugins.AbstractBubblePlugin.prototype.createLink=function(e,t,o,g){var i=this.createLinkHelper(e,t,!1,g);return o&&this.registerActionHandler(i,o),i},goog.editor.plugins.AbstractBubblePlugin.prototype.createLinkHelper=function(e,t,o,g){var i=this.dom_.createDom(o?goog.dom.TagName.A:goog.dom.TagName.SPAN,{className:goog.editor.plugins.AbstractBubblePlugin.LINK_CLASSNAME_},t);return this.keyboardNavigationEnabled_&&this.setTabbable(i),i.setAttribute("role","link"),this.setupLink(i,e,g),goog.editor.style.makeUnselectable(i,this.eventRegister),i},goog.editor.plugins.AbstractBubblePlugin.prototype.setTabbable=function(e){e.hasAttribute("tabindex")||e.setAttribute("tabindex",0),goog.dom.classlist.add(e,goog.editor.plugins.AbstractBubblePlugin.TABBABLE_CLASSNAME_)},goog.editor.plugins.AbstractBubblePlugin.prototype.setupLink=function(e,t,o){if(o)o.appendChild(e);else{var g=this.dom_.getElement(t);g&&goog.dom.replaceNode(e,g)}e.id=t};