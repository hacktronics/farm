goog.provide("goog.editor.plugins.LinkDialogPlugin"),goog.require("goog.array"),goog.require("goog.dom"),goog.require("goog.editor.Command"),goog.require("goog.editor.plugins.AbstractDialogPlugin"),goog.require("goog.events.EventHandler"),goog.require("goog.functions"),goog.require("goog.ui.editor.AbstractDialog"),goog.require("goog.ui.editor.LinkDialog"),goog.require("goog.uri.utils"),goog.editor.plugins.LinkDialogPlugin=function(){goog.editor.plugins.LinkDialogPlugin.base(this,"constructor",goog.editor.Command.MODAL_LINK_EDITOR),this.eventHandler_=new goog.events.EventHandler(this),this.safeToOpenSchemes_=["http","https","ftp"]},goog.inherits(goog.editor.plugins.LinkDialogPlugin,goog.editor.plugins.AbstractDialogPlugin),goog.editor.plugins.LinkDialogPlugin.prototype.currentLink_,goog.editor.plugins.LinkDialogPlugin.prototype.emailWarning_,goog.editor.plugins.LinkDialogPlugin.prototype.showOpenLinkInNewWindow_=!1,goog.editor.plugins.LinkDialogPlugin.prototype.focusTextToDisplayOnOpenIfEmpty_=!1,goog.editor.plugins.LinkDialogPlugin.prototype.isOpenLinkInNewWindowChecked_=!1,goog.editor.plugins.LinkDialogPlugin.prototype.showRelNoFollow_=!1,goog.editor.plugins.LinkDialogPlugin.prototype.stopReferrerLeaks_=!1,goog.editor.plugins.LinkDialogPlugin.prototype.stopTabNabbing_=!1,goog.editor.plugins.LinkDialogPlugin.prototype.blockOpeningUnsafeSchemes_=!0,goog.editor.plugins.LinkDialogPlugin.prototype.getTrogClassId=goog.functions.constant("LinkDialogPlugin"),goog.editor.plugins.LinkDialogPlugin.prototype.setBlockOpeningUnsafeSchemes=function(o){this.blockOpeningUnsafeSchemes_=o},goog.editor.plugins.LinkDialogPlugin.prototype.setSafeToOpenSchemes=function(o){this.safeToOpenSchemes_=o},goog.editor.plugins.LinkDialogPlugin.prototype.showOpenLinkInNewWindow=function(o){this.showOpenLinkInNewWindow_=!0,this.isOpenLinkInNewWindowChecked_=o},goog.editor.plugins.LinkDialogPlugin.prototype.focusTextToDisplayOnOpenIfEmpty=function(){this.focusTextToDisplayOnOpenIfEmpty_=!0},goog.editor.plugins.LinkDialogPlugin.prototype.showRelNoFollow=function(){this.showRelNoFollow_=!0},goog.editor.plugins.LinkDialogPlugin.prototype.getOpenLinkInNewWindowCheckedState=function(){return this.isOpenLinkInNewWindowChecked_},goog.editor.plugins.LinkDialogPlugin.prototype.stopReferrerLeaks=function(){this.stopReferrerLeaks_=!0},goog.editor.plugins.LinkDialogPlugin.prototype.stopTabNabbing=function(){this.stopTabNabbing_=!0},goog.editor.plugins.LinkDialogPlugin.prototype.setEmailWarning=function(o){this.emailWarning_=o},goog.editor.plugins.LinkDialogPlugin.prototype.execCommandInternal=function(o,i){return this.currentLink_=i,goog.editor.plugins.LinkDialogPlugin.base(this,"execCommandInternal",o,i)},goog.editor.plugins.LinkDialogPlugin.prototype.handleAfterHide=function(o){goog.editor.plugins.LinkDialogPlugin.base(this,"handleAfterHide",o),this.currentLink_=null},goog.editor.plugins.LinkDialogPlugin.prototype.getEventHandler=function(){return this.eventHandler_},goog.editor.plugins.LinkDialogPlugin.prototype.getCurrentLink=function(){return this.currentLink_},goog.editor.plugins.LinkDialogPlugin.prototype.createDialog=function(o,i){var n=new goog.ui.editor.LinkDialog(o,i);return this.emailWarning_&&n.setEmailWarning(this.emailWarning_),this.showOpenLinkInNewWindow_&&n.showOpenLinkInNewWindow(this.isOpenLinkInNewWindowChecked_),this.focusTextToDisplayOnOpenIfEmpty_&&n.focusTextToDisplayOnOpenIfEmpty(),this.showRelNoFollow_&&n.showRelNoFollow(),n.setStopReferrerLeaks(this.stopReferrerLeaks_),n.setStopTabNabbing(this.stopTabNabbing_),this.eventHandler_.listen(n,goog.ui.editor.AbstractDialog.EventType.OK,this.handleOk).listen(n,goog.ui.editor.AbstractDialog.EventType.CANCEL,this.handleCancel_).listen(n,goog.ui.editor.LinkDialog.EventType.BEFORE_TEST_LINK,this.handleBeforeTestLink),n},goog.editor.plugins.LinkDialogPlugin.prototype.disposeInternal=function(){goog.editor.plugins.LinkDialogPlugin.base(this,"disposeInternal"),this.eventHandler_.dispose()},goog.editor.plugins.LinkDialogPlugin.prototype.handleOk=function(o){this.disposeOriginalSelection(),this.currentLink_.setTextAndUrl(o.linkText,o.linkUrl),this.showOpenLinkInNewWindow_&&(this.isOpenLinkInNewWindowChecked_=o.openInNewWindow);var i=this.currentLink_.getAnchor();this.touchUpAnchorOnOk_(i,o);for(var n=this.currentLink_.getExtraAnchors(),e=0;e<n.length;++e)n[e].href=i.href,this.touchUpAnchorOnOk_(n[e],o);this.currentLink_.placeCursorRightOf(),this.getFieldObject().focus(),this.getFieldObject().dispatchSelectionChangeEvent(),this.getFieldObject().dispatchChange(),this.eventHandler_.removeAll()},goog.editor.plugins.LinkDialogPlugin.prototype.touchUpAnchorOnOk_=function(o,i){if(this.showOpenLinkInNewWindow_&&(i.openInNewWindow?o.target="_blank":"_blank"==o.target&&(o.target="")),this.showRelNoFollow_){var n=goog.ui.editor.LinkDialog.hasNoFollow(o.rel);n&&!i.noFollow?o.rel=goog.ui.editor.LinkDialog.removeNoFollow(o.rel):!n&&i.noFollow&&(o.rel=o.rel?o.rel+" nofollow":"nofollow")}},goog.editor.plugins.LinkDialogPlugin.prototype.handleCancel_=function(o){if(this.currentLink_.isNew()){goog.dom.flattenElement(this.currentLink_.getAnchor());for(var i=this.currentLink_.getExtraAnchors(),n=0;n<i.length;++n)goog.dom.flattenElement(i[n]);this.getFieldObject().dispatchChange()}this.eventHandler_.removeAll()},goog.editor.plugins.LinkDialogPlugin.prototype.handleBeforeTestLink=function(o){if(!this.shouldOpenUrl(o.url)){var i=goog.getMsg("This link cannot be tested.");alert(i),o.preventDefault()}},goog.editor.plugins.LinkDialogPlugin.prototype.shouldOpenUrl=function(o){return!this.blockOpeningUnsafeSchemes_||this.isSafeSchemeToOpen_(o)},goog.editor.plugins.LinkDialogPlugin.prototype.isSafeSchemeToOpen_=function(o){var i=goog.uri.utils.getScheme(o)||"http";return goog.array.contains(this.safeToOpenSchemes_,i.toLowerCase())};