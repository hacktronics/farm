goog.provide("goog.editor.plugins.TableEditor"),goog.require("goog.array"),goog.require("goog.dom"),goog.require("goog.dom.Range"),goog.require("goog.dom.TagName"),goog.require("goog.editor.Plugin"),goog.require("goog.editor.Table"),goog.require("goog.editor.node"),goog.require("goog.editor.range"),goog.require("goog.object"),goog.require("goog.userAgent"),goog.editor.plugins.TableEditor=function(){goog.editor.plugins.TableEditor.base(this,"constructor"),this.isTableEditableFunctions_=[],this.isUserEditableTableBound_=goog.bind(this.isUserEditableTable_,this)},goog.inherits(goog.editor.plugins.TableEditor,goog.editor.Plugin),goog.editor.plugins.TableEditor.prototype.getTrogClassId=function(){return String(goog.getUid(this.constructor))},goog.editor.plugins.TableEditor.COMMAND={TABLE:"+table",INSERT_ROW_AFTER:"+insertRowAfter",INSERT_ROW_BEFORE:"+insertRowBefore",INSERT_COLUMN_AFTER:"+insertColumnAfter",INSERT_COLUMN_BEFORE:"+insertColumnBefore",REMOVE_ROWS:"+removeRows",REMOVE_COLUMNS:"+removeColumns",SPLIT_CELL:"+splitCell",MERGE_CELLS:"+mergeCells",REMOVE_TABLE:"+removeTable"},goog.editor.plugins.TableEditor.SUPPORTED_COMMANDS_=goog.object.transpose(goog.editor.plugins.TableEditor.COMMAND),goog.editor.plugins.TableEditor.prototype.isSupportedCommand=function(e){return e in goog.editor.plugins.TableEditor.SUPPORTED_COMMANDS_},goog.editor.plugins.TableEditor.prototype.enable=function(e){(goog.editor.plugins.TableEditor.base(this,"enable",e),goog.userAgent.GECKO)&&this.getFieldDomHelper().getDocument().execCommand("enableObjectResizing",!1,"true")},goog.editor.plugins.TableEditor.prototype.getCurrentTable_=function(){var e=this.getFieldObject().getRange().getContainer();return this.getAncestorTable_(e)},goog.editor.plugins.TableEditor.prototype.getAncestorTable_=function(e){var o=goog.dom.getAncestor(e,this.isUserEditableTableBound_,!0);return goog.editor.node.isEditable(o)?o:null},goog.editor.plugins.TableEditor.prototype.queryCommandValue=function(e){if(e==goog.editor.plugins.TableEditor.COMMAND.TABLE)return!!this.getCurrentTable_()},goog.editor.plugins.TableEditor.prototype.execCommandInternal=function(e,o){var t=null,i=this.getFieldObject().getRange();if(e==goog.editor.plugins.TableEditor.COMMAND.TABLE){if(!goog.editor.range.isEditable(i))return null;var r=o||{width:4,height:2},n=this.getFieldDomHelper().getDocument(),l=goog.editor.Table.createDomTable(n,r.width,r.height);i.replaceContentsWithNode(l),goog.userAgent.IE||(t=goog.dom.getElementsByTagName(goog.dom.TagName.TD,l)[0])}else{var g=new goog.editor.plugins.TableEditor.CellSelection_(i,goog.bind(this.getAncestorTable_,this));if(!(l=g.getTable()))return null;switch(e){case goog.editor.plugins.TableEditor.COMMAND.INSERT_ROW_BEFORE:l.insertRow(g.getFirstRowIndex());break;case goog.editor.plugins.TableEditor.COMMAND.INSERT_ROW_AFTER:l.insertRow(g.getLastRowIndex()+1);break;case goog.editor.plugins.TableEditor.COMMAND.INSERT_COLUMN_BEFORE:l.insertColumn(g.getFirstColumnIndex());break;case goog.editor.plugins.TableEditor.COMMAND.INSERT_COLUMN_AFTER:l.insertColumn(g.getLastColumnIndex()+1);break;case goog.editor.plugins.TableEditor.COMMAND.REMOVE_ROWS:var s=g.getFirstRowIndex(),a=g.getLastRowIndex();if(0==s&&a==l.rows.length-1)return this.execCommandInternal(goog.editor.plugins.TableEditor.COMMAND.REMOVE_TABLE);for(var d=g.getFirstColumnIndex(),u=a-s+1,E=0;E<u;E++)l.removeRow(s);if(l.rows.length>0){var b=Math.min(s,l.rows.length-1);t=l.rows[b].columns[d].element}break;case goog.editor.plugins.TableEditor.COMMAND.REMOVE_COLUMNS:var T=g.getFirstColumnIndex(),c=g.getLastColumnIndex();if(0==T&&c==l.rows[0].columns.length-1)return this.execCommandInternal(goog.editor.plugins.TableEditor.COMMAND.REMOVE_TABLE);s=g.getFirstRowIndex();var C=c-T+1;for(E=0;E<C;E++)l.removeColumn(T);var p=l.rows[s];if(p){var _=Math.min(T,p.columns.length-1);t=p.columns[_].element}break;case goog.editor.plugins.TableEditor.COMMAND.MERGE_CELLS:g.isRectangle()&&l.mergeCells(g.getFirstRowIndex(),g.getFirstColumnIndex(),g.getLastRowIndex(),g.getLastColumnIndex());break;case goog.editor.plugins.TableEditor.COMMAND.SPLIT_CELL:g.containsSingleCell()&&l.splitCell(g.getFirstRowIndex(),g.getFirstColumnIndex());break;case goog.editor.plugins.TableEditor.COMMAND.REMOVE_TABLE:l.element.parentNode.removeChild(l.element)}}return t&&((i=goog.dom.Range.createFromNodeContents(t)).collapse(!1),i.select()),null},goog.editor.plugins.TableEditor.prototype.isUserEditableTable_=function(e){return e.tagName==goog.dom.TagName.TABLE&&goog.array.every(this.isTableEditableFunctions_,function(o){return o(e)})},goog.editor.plugins.TableEditor.prototype.addIsTableEditableFunction=function(e){goog.array.insert(this.isTableEditableFunctions_,e)},goog.editor.plugins.TableEditor.CellSelection_=function(e,o){this.cells_=[];var t=e.getContainerElement(),i=function(o){return t==o||t.parentNode==o||e.containsNode(o,!1)},r=t&&o(t);if(r){var n=new goog.editor.Table(r);if(n.rows.length&&n.rows[0].columns.length){for(var l,g=0;l=n.rows[g];g++)for(var s,a=0;s=l.columns[a];a++)i(s.element)&&(this.cells_.length?(this.firstRowIndex_=Math.min(this.firstRowIndex_,s.startRow),this.lastRowIndex_=Math.max(this.lastRowIndex_,s.endRow),this.firstColIndex_=Math.min(this.firstColIndex_,s.startCol),this.lastColIndex_=Math.max(this.lastColIndex_,s.endCol)):(this.firstRowIndex_=s.startRow,this.lastRowIndex_=s.endRow,this.firstColIndex_=s.startCol,this.lastColIndex_=s.endCol),this.cells_.push(s));this.parentTable_=n}}},goog.editor.plugins.TableEditor.CellSelection_.prototype.getTable=function(){return this.parentTable_},goog.editor.plugins.TableEditor.CellSelection_.prototype.getFirstRowIndex=function(){return this.firstRowIndex_},goog.editor.plugins.TableEditor.CellSelection_.prototype.getLastRowIndex=function(){return this.lastRowIndex_},goog.editor.plugins.TableEditor.CellSelection_.prototype.getFirstColumnIndex=function(){return this.firstColIndex_},goog.editor.plugins.TableEditor.CellSelection_.prototype.getLastColumnIndex=function(){return this.lastColIndex_},goog.editor.plugins.TableEditor.CellSelection_.prototype.getCells=function(){return this.cells_},goog.editor.plugins.TableEditor.CellSelection_.prototype.isRectangle=function(){if(!this.cells_.length)return!1;var e=this.cells_[0],o=this.cells_[this.cells_.length-1];return!(this.firstRowIndex_<e.startRow||this.lastRowIndex_>o.endRow||this.firstColIndex_<e.startCol||this.lastColIndex_>o.endCol)},goog.editor.plugins.TableEditor.CellSelection_.prototype.containsSingleCell=function(){var e=this.cells_.length;return e>0&&this.cells_[0]==this.cells_[e-1]};