goog.provide("goog.editor.plugins.UndoRedoManager"),goog.provide("goog.editor.plugins.UndoRedoManager.EventType"),goog.require("goog.editor.plugins.UndoRedoState"),goog.require("goog.events"),goog.require("goog.events.EventTarget"),goog.editor.plugins.UndoRedoManager=function(){goog.events.EventTarget.call(this),this.maxUndoDepth_=100,this.undoStack_=[],this.redoStack_=[],this.pendingActions_=[]},goog.inherits(goog.editor.plugins.UndoRedoManager,goog.events.EventTarget),goog.editor.plugins.UndoRedoManager.EventType={STATE_CHANGE:"state_change",STATE_ADDED:"state_added",BEFORE_UNDO:"before_undo",BEFORE_REDO:"before_redo"},goog.editor.plugins.UndoRedoManager.prototype.inProgressActionKey_=null,goog.editor.plugins.UndoRedoManager.prototype.setMaxUndoDepth=function(t){this.maxUndoDepth_=t},goog.editor.plugins.UndoRedoManager.prototype.addState=function(t){if(0==this.undoStack_.length||!t.equals(this.undoStack_[this.undoStack_.length-1])){this.undoStack_.push(t),this.undoStack_.length>this.maxUndoDepth_&&this.undoStack_.shift();var o=this.redoStack_.length;this.redoStack_.length=0,this.dispatchEvent({type:goog.editor.plugins.UndoRedoManager.EventType.STATE_ADDED,state:t}),(1==this.undoStack_.length||o)&&this.dispatchStateChange_()}},goog.editor.plugins.UndoRedoManager.prototype.dispatchStateChange_=function(){this.dispatchEvent(goog.editor.plugins.UndoRedoManager.EventType.STATE_CHANGE)},goog.editor.plugins.UndoRedoManager.prototype.undo=function(){this.shiftState_(this.undoStack_,this.redoStack_)},goog.editor.plugins.UndoRedoManager.prototype.redo=function(){this.shiftState_(this.redoStack_,this.undoStack_)},goog.editor.plugins.UndoRedoManager.prototype.hasUndoState=function(){return this.undoStack_.length>0},goog.editor.plugins.UndoRedoManager.prototype.hasRedoState=function(){return this.redoStack_.length>0},goog.editor.plugins.UndoRedoManager.prototype.shiftState_=function(t,o){if(t.length){var e=t.pop();o.push(e),this.addAction_({type:t==this.undoStack_?goog.editor.plugins.UndoRedoManager.EventType.BEFORE_UNDO:goog.editor.plugins.UndoRedoManager.EventType.BEFORE_REDO,func:t==this.undoStack_?e.undo:e.redo,state:e}),0!=t.length&&1!=o.length||this.dispatchStateChange_()}},goog.editor.plugins.UndoRedoManager.prototype.addAction_=function(t){this.pendingActions_.push(t),1==this.pendingActions_.length&&this.doAction_()},goog.editor.plugins.UndoRedoManager.prototype.doAction_=function(){if(!this.inProgressActionKey_&&0!=this.pendingActions_.length){var t=this.pendingActions_.shift(),o={type:t.type,state:t.state};this.dispatchEvent(o)&&(t.state.isAsynchronous()?(this.inProgressActionKey_=goog.events.listen(t.state,goog.editor.plugins.UndoRedoState.ACTION_COMPLETED,this.finishAction_,!1,this),t.func.call(t.state)):(t.func.call(t.state),this.doAction_()))}},goog.editor.plugins.UndoRedoManager.prototype.finishAction_=function(){goog.events.unlistenByKey(this.inProgressActionKey_),this.inProgressActionKey_=null,this.doAction_()},goog.editor.plugins.UndoRedoManager.prototype.clearHistory=function(){(this.undoStack_.length>0||this.redoStack_.length>0)&&(this.undoStack_.length=0,this.redoStack_.length=0,this.dispatchStateChange_())},goog.editor.plugins.UndoRedoManager.prototype.undoPeek=function(){return this.undoStack_[this.undoStack_.length-1]},goog.editor.plugins.UndoRedoManager.prototype.redoPeek=function(){return this.redoStack_[this.redoStack_.length-1]};