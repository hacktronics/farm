goog.provide("goog.editor.plugins.TagOnEnterHandler"),goog.require("goog.dom"),goog.require("goog.dom.NodeType"),goog.require("goog.dom.Range"),goog.require("goog.dom.TagName"),goog.require("goog.editor.Command"),goog.require("goog.editor.node"),goog.require("goog.editor.plugins.EnterHandler"),goog.require("goog.editor.range"),goog.require("goog.editor.style"),goog.require("goog.events.KeyCodes"),goog.require("goog.functions"),goog.require("goog.string.Unicode"),goog.require("goog.style"),goog.require("goog.userAgent"),goog.editor.plugins.TagOnEnterHandler=function(e){this.tag=e,goog.editor.plugins.EnterHandler.call(this)},goog.inherits(goog.editor.plugins.TagOnEnterHandler,goog.editor.plugins.EnterHandler),goog.editor.plugins.TagOnEnterHandler.prototype.getTrogClassId=function(){return"TagOnEnterHandler"},goog.editor.plugins.TagOnEnterHandler.prototype.getNonCollapsingBlankHtml=function(){return this.tag==goog.dom.TagName.P?"<p>&nbsp;</p>":this.tag==goog.dom.TagName.DIV?"<div><br></div>":"<br>"},goog.editor.plugins.TagOnEnterHandler.prototype.activeOnUneditableFields=goog.functions.TRUE,goog.editor.plugins.TagOnEnterHandler.prototype.isSupportedCommand=function(e){return e==goog.editor.Command.DEFAULT_TAG},goog.editor.plugins.TagOnEnterHandler.prototype.queryCommandValue=function(e){return e==goog.editor.Command.DEFAULT_TAG?String(this.tag):null},goog.editor.plugins.TagOnEnterHandler.prototype.handleBackspaceInternal=function(e,o){goog.editor.plugins.TagOnEnterHandler.superClass_.handleBackspaceInternal.call(this,e,o),goog.userAgent.GECKO&&this.markBrToNotBeRemoved_(o,!0)},goog.editor.plugins.TagOnEnterHandler.prototype.processParagraphTagsInternal=function(e,o){(goog.userAgent.OPERA||goog.userAgent.IE)&&this.tag!=goog.dom.TagName.P&&this.ensureBlockIeOpera(this.tag)},goog.editor.plugins.TagOnEnterHandler.prototype.handleDeleteGecko=function(e){var o=this.getFieldObject().getRange(),g=goog.editor.style.getContainer(o&&o.getContainerElement());this.getFieldObject().getElement().lastChild==g&&goog.editor.plugins.EnterHandler.isBrElem(g)?(e.preventDefault(),e.stopPropagation()):(this.markBrToNotBeRemoved_(o,!1),this.deleteBrGecko(e))},goog.editor.plugins.TagOnEnterHandler.prototype.handleKeyUpInternal=function(e){goog.userAgent.GECKO?e.keyCode==goog.events.KeyCodes.DELETE?this.removeBrIfNecessary_(!1):e.keyCode==goog.events.KeyCodes.BACKSPACE&&this.removeBrIfNecessary_(!0):(goog.userAgent.IE||goog.userAgent.OPERA)&&e.keyCode==goog.events.KeyCodes.ENTER&&this.ensureBlockIeOpera(this.tag,!0)},goog.editor.plugins.TagOnEnterHandler.BrOrNbspSurroundedWithWhiteSpace_="[\t\n\r ]*(<br[^>]*/?>|&nbsp;)[\t\n\r ]*",goog.editor.plugins.TagOnEnterHandler.emptyLiRegExp_=new RegExp("^"+goog.editor.plugins.TagOnEnterHandler.BrOrNbspSurroundedWithWhiteSpace_+"$"),goog.editor.plugins.TagOnEnterHandler.prototype.ensureNodeIsWrappedW3c_=function(e,o){if(o==this.getFieldObject().getElement()){var g=goog.dom.getAncestor(e,function(e){return o==e.parentNode},!0);o=goog.editor.plugins.TagOnEnterHandler.wrapInContainerW3c_(String(this.tag),{node:g,offset:0},o)}return o},goog.editor.plugins.TagOnEnterHandler.prototype.handleEnterWebkitInternal=function(e){if(this.tag==goog.dom.TagName.DIV){var o=this.getFieldObject().getRange(),g=goog.editor.style.getContainer(o.getContainerElement()),n=goog.editor.range.getDeepEndPoint(o,!0);g=this.ensureNodeIsWrappedW3c_(n.node,g),goog.dom.Range.createCaret(n.node,n.offset).select()}},goog.editor.plugins.TagOnEnterHandler.prototype.handleEnterAtCursorGeckoInternal=function(e,o,g){var n=null;o&&(n=goog.dom.getAncestorByTagNameAndClass(g&&g.getContainerElement(),goog.dom.TagName.LI));var t=n&&n.innerHTML.match(goog.editor.plugins.TagOnEnterHandler.emptyLiRegExp_)?this.breakOutOfEmptyListItemGecko_(n):this.handleRegularEnterGecko_();if(this.scrollCursorIntoViewGecko_(t),goog.editor.plugins.EnterHandler.isBrElem(t)){t.normalize();var r=goog.dom.getElementsByTagName(goog.dom.TagName.BR,t)[0];r.previousSibling&&r.previousSibling.nodeType==goog.dom.NodeType.TEXT&&(t=r.previousSibling)}goog.editor.range.selectNodeStart(t),e.preventDefault(),e.stopPropagation()},goog.editor.plugins.TagOnEnterHandler.prototype.breakOutOfEmptyListItemGecko_=function(e){var o=e.parentNode,g=o.parentNode,n=g.tagName==goog.dom.TagName.OL||g.tagName==goog.dom.TagName.UL,t=goog.dom.getDomHelper(e).createElement(n?goog.dom.TagName.LI:this.tag);if(e.previousSibling){if(e.nextSibling){for(var r=o.cloneNode(!1);e.nextSibling;)r.appendChild(e.nextSibling);goog.dom.insertSiblingAfter(r,o)}goog.dom.insertSiblingAfter(t,o)}else goog.dom.insertSiblingBefore(t,o);return goog.editor.node.isEmpty(o)&&goog.dom.removeNode(o),goog.dom.removeNode(e),t.innerHTML="&nbsp;",t},goog.editor.plugins.TagOnEnterHandler.wrapInContainerW3c_=function(e,o,g){for(var n=o.node;n.previousSibling&&!goog.editor.style.isContainer(n.previousSibling);)n=n.previousSibling;for(var t=o.node;t.nextSibling&&!goog.editor.style.isContainer(t.nextSibling);)t=t.nextSibling;for(var r=g.ownerDocument.createElement(e);n!=t;){var i=n.nextSibling;goog.dom.appendChild(r,n),n=i}var a=t.nextSibling;return goog.dom.appendChild(r,t),g.insertBefore(r,a),r},goog.editor.plugins.TagOnEnterHandler.prototype.markBrToNotBeRemoved_=function(e,o){var g=e.getFocusNode(),n=e.getFocusOffset(),t=o?n:n+1;if(goog.editor.node.getLength(g)==t){var r=g.nextSibling;r&&r.tagName==goog.dom.TagName.BR&&(this.brToKeep_=r)}},goog.editor.plugins.TagOnEnterHandler.prototype.removeBrIfNecessary_=function(e){var o,g=this.getFieldObject().getRange(),n=g.getFocusNode(),t=g.getFocusOffset();if(e&&""==n.data)o=n.nextSibling;else if(e&&0==t){for(var r=n;r&&!r.previousSibling&&r.parentNode!=this.getFieldObject().getElement();)r=r.parentNode;o=r.previousSibling}else n.length==t&&(o=n.nextSibling);o&&o.tagName==goog.dom.TagName.BR&&this.brToKeep_!=o&&(goog.dom.removeNode(o),n.nodeType==goog.dom.NodeType.TEXT&&(n.data=goog.editor.plugins.TagOnEnterHandler.trimTabsAndLineBreaks_(n.data),goog.dom.Range.createCaret(n,Math.min(t,n.length)).select()))},goog.editor.plugins.TagOnEnterHandler.trimTabsAndLineBreaks_=function(e){return e.replace(/^[\t\n\r]|[\t\n\r]$/g,"")},goog.editor.plugins.TagOnEnterHandler.prototype.handleRegularEnterGecko_=function(){var e,o=this.getFieldObject().getRange(),g=goog.editor.style.getContainer(o.getContainerElement());if(goog.editor.plugins.EnterHandler.isBrElem(g))g.tagName==goog.dom.TagName.BODY&&(g=this.ensureNodeIsWrappedW3c_(goog.dom.getElementsByTagName(goog.dom.TagName.BR,g)[0],g)),e=g.cloneNode(!0),goog.dom.insertSiblingAfter(e,g);else{g.firstChild||(g.innerHTML="&nbsp;");var n=goog.editor.range.getDeepEndPoint(o,!0);g=this.ensureNodeIsWrappedW3c_(n.node,g),e=goog.editor.plugins.TagOnEnterHandler.splitDomAndAppend_(n.node,n.offset,g);var t=goog.editor.plugins.TagOnEnterHandler.findAnchorInTraversal_(g),r=goog.editor.plugins.TagOnEnterHandler.findAnchorInTraversal_(e,!0);if(t&&r&&t.tagName==goog.dom.TagName.A&&r.tagName==goog.dom.TagName.A){var i=goog.editor.node.isEmpty(t,!1)?t:r;goog.dom.flattenElement(i)}}return e},goog.editor.plugins.TagOnEnterHandler.prototype.scrollCursorIntoViewGecko_=function(e){if(this.getFieldObject().isFixedHeight()){var o=this.getFieldObject().getElement(),g=goog.style.getPageOffsetTop(e)+e.offsetHeight,n=this.getFieldDomHelper(),t=this.getFieldDomHelper().getWindow(),r=n.getDocumentScroll().y,i=goog.dom.getViewportSize(t).height;g>i+r&&(o.tagName==goog.dom.TagName.BODY&&goog.editor.node.isStandardsMode(o)&&(o=o.parentNode),o.scrollTop=g-i)}},goog.editor.plugins.TagOnEnterHandler.splitDom_=function(e,o,g){g||(g=e.ownerDocument.body);var n=e.nodeType==goog.dom.NodeType.TEXT,t=null;n?goog.userAgent.IE&&o==e.nodeValue.length?(t=goog.dom.getDomHelper(e).createTextNode(""),goog.dom.insertSiblingAfter(t,e)):t=e.splitText(o):e=o?e.childNodes[o-1]:t=e.firstChild||e;var r=goog.editor.node.splitDomTreeAt(e,t,g);if(n){t=goog.editor.plugins.TagOnEnterHandler.joinTextNodes_(t,!0),goog.editor.plugins.TagOnEnterHandler.replaceWhiteSpaceWithNbsp_(t,!0,!!t.nextSibling);var i=goog.editor.plugins.TagOnEnterHandler.joinTextNodes_(e,!1);goog.editor.plugins.TagOnEnterHandler.replaceWhiteSpaceWithNbsp_(i,!1,!1)}return r},goog.editor.plugins.TagOnEnterHandler.splitDomAndAppend_=function(e,o,g){var n=goog.editor.plugins.TagOnEnterHandler.splitDom_(e,o,g);return goog.dom.insertSiblingAfter(n,g),n},goog.editor.plugins.TagOnEnterHandler.joinTextNodes_=function(e,o){if(e&&"#text"==e.nodeName){for(var g=o?"nextSibling":"previousSibling",n=o?"previousSibling":"nextSibling",t=[e.nodeValue];e[g]&&e[g].nodeType==goog.dom.NodeType.TEXT;)e=e[g],t.push(e.nodeValue),goog.dom.removeNode(e[n]);o||t.reverse(),e.nodeValue=t.join("")}return e},goog.editor.plugins.TagOnEnterHandler.replaceWhiteSpaceWithNbsp_=function(e,o,g){var n=o?/^[ \t\r\n]+/:/[ \t\r\n]+$/;e.nodeValue=e.nodeValue.replace(n,goog.string.Unicode.NBSP),g||""!=e.nodeValue||(e.nodeValue=goog.string.Unicode.NBSP)},goog.editor.plugins.TagOnEnterHandler.findAnchorInTraversal_=function(e,o){for(;(e=o?e.firstChild:e.lastChild)&&e.tagName!=goog.dom.TagName.A;);return e};