goog.provide("goog.editor.plugins.LinkBubble"),goog.provide("goog.editor.plugins.LinkBubble.Action"),goog.require("goog.array"),goog.require("goog.dom"),goog.require("goog.dom.Range"),goog.require("goog.dom.TagName"),goog.require("goog.editor.Command"),goog.require("goog.editor.Link"),goog.require("goog.editor.plugins.AbstractBubblePlugin"),goog.require("goog.functions"),goog.require("goog.string"),goog.require("goog.style"),goog.require("goog.ui.editor.messages"),goog.require("goog.uri.utils"),goog.require("goog.window"),goog.editor.plugins.LinkBubble=function(e){goog.editor.plugins.LinkBubble.base(this,"constructor"),this.extraActions_=goog.array.toArray(arguments),this.actionSpans_=[],this.safeToOpenSchemes_=["http","https","ftp"]},goog.inherits(goog.editor.plugins.LinkBubble,goog.editor.plugins.AbstractBubblePlugin),goog.editor.plugins.LinkBubble.DISABLE_LINK_BUBBLE_DATA_ATTRIBUTE_="data-dlb",goog.editor.plugins.LinkBubble.LINK_TEXT_ID_="tr_link-text",goog.editor.plugins.LinkBubble.TEST_LINK_SPAN_ID_="tr_test-link-span",goog.editor.plugins.LinkBubble.TEST_LINK_ID_="tr_test-link",goog.editor.plugins.LinkBubble.CHANGE_LINK_SPAN_ID_="tr_change-link-span",goog.editor.plugins.LinkBubble.CHANGE_LINK_ID_="tr_change-link",goog.editor.plugins.LinkBubble.DELETE_LINK_SPAN_ID_="tr_delete-link-span",goog.editor.plugins.LinkBubble.DELETE_LINK_ID_="tr_delete-link",goog.editor.plugins.LinkBubble.LINK_DIV_ID_="tr_link-div",goog.editor.plugins.LinkBubble.MSG_LINK_BUBBLE_TEST_LINK=goog.getMsg("Go to link: "),goog.editor.plugins.LinkBubble.MSG_LINK_BUBBLE_CHANGE=goog.getMsg("Change"),goog.editor.plugins.LinkBubble.MSG_LINK_BUBBLE_REMOVE=goog.getMsg("Remove"),goog.editor.plugins.LinkBubble.MSG_INVALID_URL_LINK_BUBBLE=goog.getMsg("invalid url"),goog.editor.plugins.LinkBubble.shouldShowLinkBubble_=function(e){return!e.hasAttribute(goog.editor.plugins.LinkBubble.DISABLE_LINK_BUBBLE_DATA_ATTRIBUTE_)},goog.editor.plugins.LinkBubble.prototype.stopReferrerLeaks_=!1,goog.editor.plugins.LinkBubble.prototype.blockOpeningUnsafeSchemes_=!0,goog.editor.plugins.LinkBubble.prototype.stopReferrerLeaks=function(){this.stopReferrerLeaks_=!0},goog.editor.plugins.LinkBubble.prototype.setBlockOpeningUnsafeSchemes=function(e){this.blockOpeningUnsafeSchemes_=e},goog.editor.plugins.LinkBubble.prototype.setSafeToOpenSchemes=function(e){this.safeToOpenSchemes_=e},goog.editor.plugins.LinkBubble.prototype.getTrogClassId=function(){return"LinkBubble"},goog.editor.plugins.LinkBubble.prototype.isSupportedCommand=function(e){return e==goog.editor.Command.UPDATE_LINK_BUBBLE},goog.editor.plugins.LinkBubble.prototype.execCommandInternal=function(e,o){e==goog.editor.Command.UPDATE_LINK_BUBBLE&&this.updateLink_()},goog.editor.plugins.LinkBubble.prototype.updateLink_=function(){var e=this.getTargetElement();e&&(this.closeBubble(),this.createBubble(e))},goog.editor.plugins.LinkBubble.prototype.getBubbleTargetFromSelection=function(e){var o=goog.dom.getAncestorByTagNameAndClass(e,goog.dom.TagName.A);if(!o){var t=this.getFieldObject().getRange();if(t&&t.isCollapsed()&&0==t.getStartOffset()){var i=t.getStartNode().previousSibling;i&&i.tagName==goog.dom.TagName.A&&(o=i)}}return o},goog.editor.plugins.LinkBubble.prototype.setTestLinkUrlFn=function(e){this.testLinkUrlFn_=e},goog.editor.plugins.LinkBubble.prototype.getTargetUrl=function(){return this.getTargetElement().getAttribute("href")||""},goog.editor.plugins.LinkBubble.prototype.getBubbleType=function(){return String(goog.dom.TagName.A)},goog.editor.plugins.LinkBubble.prototype.getBubbleTitle=function(){return goog.ui.editor.messages.MSG_LINK_CAPTION},goog.editor.plugins.LinkBubble.prototype.getTestLinkMessage=function(){return goog.editor.plugins.LinkBubble.MSG_LINK_BUBBLE_TEST_LINK},goog.editor.plugins.LinkBubble.prototype.handleSelectionChangeInternal=function(e){if(e){var o=this.getBubbleTargetFromSelection(e);if(o&&!goog.editor.plugins.LinkBubble.shouldShowLinkBubble_(o))return!1}return goog.editor.plugins.LinkBubble.base(this,"handleSelectionChangeInternal",e)},goog.editor.plugins.LinkBubble.prototype.createBubbleContents=function(e){var o,t=this.getLinkToTextObj_(),i=t.valid?"black":"red",g=this.shouldOpenUrl(t.linkText);if(!goog.editor.Link.isLikelyEmailAddress(t.linkText)&&t.valid&&g){var n=this.dom_.createDom(goog.dom.TagName.SPAN,{id:goog.editor.plugins.LinkBubble.TEST_LINK_SPAN_ID_},this.getTestLinkMessage());o=this.dom_.createDom(goog.dom.TagName.SPAN,{id:goog.editor.plugins.LinkBubble.LINK_TEXT_ID_,style:"color:"+i},"");var r=goog.string.truncateMiddle(t.linkText,48);this.createLink(goog.editor.plugins.LinkBubble.TEST_LINK_ID_,this.dom_.createTextNode(r).data,this.testLink,o)}else o=this.dom_.createDom(goog.dom.TagName.SPAN,{id:goog.editor.plugins.LinkBubble.LINK_TEXT_ID_,style:"color:"+i},this.dom_.createTextNode(t.linkText));var s=this.createLinkOption(goog.editor.plugins.LinkBubble.CHANGE_LINK_SPAN_ID_);this.createLink(goog.editor.plugins.LinkBubble.CHANGE_LINK_ID_,goog.editor.plugins.LinkBubble.MSG_LINK_BUBBLE_CHANGE,this.showLinkDialog_,s),this.actionSpans_=[];for(var l=0;l<this.extraActions_.length;l++){var u=this.extraActions_[l],a=this.createLinkOption(u.spanId_);this.actionSpans_.push(a),this.createLink(u.linkId_,u.message_,function(){u.actionFn_(this.getTargetUrl())},a)}var p=this.createLinkOption(goog.editor.plugins.LinkBubble.DELETE_LINK_SPAN_ID_);this.createLink(goog.editor.plugins.LinkBubble.DELETE_LINK_ID_,goog.editor.plugins.LinkBubble.MSG_LINK_BUBBLE_REMOVE,this.deleteLink_,p),this.onShow();var b=this.dom_.createDom(goog.dom.TagName.DIV,{id:goog.editor.plugins.LinkBubble.LINK_DIV_ID_},n||"",o,s);for(l=0;l<this.actionSpans_.length;l++)b.appendChild(this.actionSpans_[l]);b.appendChild(p),goog.dom.appendChild(e,b)},goog.editor.plugins.LinkBubble.prototype.testLink=function(e){goog.window.open(this.getTestLinkAction_(),{target:"_blank",noreferrer:this.stopReferrerLeaks_},this.getFieldObject().getAppWindow()),e&&(e.stopPropagation(),e.preventDefault())},goog.editor.plugins.LinkBubble.prototype.isInvalidUrl=goog.functions.FALSE,goog.editor.plugins.LinkBubble.prototype.getLinkToTextObj_=function(){var e,o=this.getTargetUrl();return this.isInvalidUrl(o)?(o=goog.editor.plugins.LinkBubble.MSG_INVALID_URL_LINK_BUBBLE,e=!0):goog.editor.Link.isMailto(o)&&(o=o.substring(7)),{linkText:o,valid:!e}},goog.editor.plugins.LinkBubble.prototype.showLinkDialog_=function(e){e.preventDefault(),this.getFieldObject().execCommand(goog.editor.Command.MODAL_LINK_EDITOR,new goog.editor.Link(this.getTargetElement(),!1)),this.closeBubble()},goog.editor.plugins.LinkBubble.prototype.deleteLink_=function(e){e.preventDefault(),this.getFieldObject().dispatchBeforeChange();var o=this.getTargetElement(),t=o.lastChild;goog.dom.flattenElement(o);var i=this.saveScrollPosition(),g=goog.dom.Range.createFromNodeContents(t);g.collapse(!1),g.select(),this.closeBubble(),this.getFieldObject().dispatchChange(),this.getFieldObject().focus(),i()},goog.editor.plugins.LinkBubble.prototype.onShow=function(){if(this.dom_.getElement(goog.editor.plugins.LinkBubble.LINK_DIV_ID_)){var e=this.dom_.getElement(goog.editor.plugins.LinkBubble.TEST_LINK_SPAN_ID_);if(e){var o=this.getTargetUrl();goog.style.setElementShown(e,!goog.editor.Link.isMailto(o))}for(var t=0;t<this.extraActions_.length;t++){var i=this.extraActions_[t],g=this.dom_.getElement(i.spanId_);g&&goog.style.setElementShown(g,i.toShowFn_(this.getTargetUrl()))}}},goog.editor.plugins.LinkBubble.prototype.getTestLinkAction_=function(){var e=this.getTargetUrl();return this.testLinkUrlFn_?this.testLinkUrlFn_(e):e},goog.editor.plugins.LinkBubble.prototype.shouldOpenUrl=function(e){return!this.blockOpeningUnsafeSchemes_||this.isSafeSchemeToOpen_(e)},goog.editor.plugins.LinkBubble.prototype.isSafeSchemeToOpen_=function(e){var o=goog.uri.utils.getScheme(e)||"http";return goog.array.contains(this.safeToOpenSchemes_,o.toLowerCase())},goog.editor.plugins.LinkBubble.Action=function(e,o,t,i,g){this.spanId_=e,this.linkId_=o,this.message_=t,this.toShowFn_=i,this.actionFn_=g};