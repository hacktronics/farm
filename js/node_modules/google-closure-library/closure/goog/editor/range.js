goog.provide("goog.editor.range"),goog.provide("goog.editor.range.Point"),goog.require("goog.array"),goog.require("goog.dom"),goog.require("goog.dom.NodeType"),goog.require("goog.dom.Range"),goog.require("goog.dom.RangeEndpoint"),goog.require("goog.dom.SavedCaretRange"),goog.require("goog.editor.node"),goog.require("goog.editor.style"),goog.require("goog.iter"),goog.require("goog.userAgent"),goog.editor.range.narrow=function(e,o){var g=e.getStartNode(),n=e.getEndNode();if(g&&n){var t=function(e){return e==o},r=goog.dom.getAncestor(g,t,!0),i=goog.dom.getAncestor(n,t,!0);if(r&&i)return e.clone();if(r){var d=goog.editor.node.getRightMostLeaf(o);return goog.dom.Range.createFromNodes(e.getStartNode(),e.getStartOffset(),d,goog.editor.node.getLength(d))}if(i)return goog.dom.Range.createFromNodes(goog.editor.node.getLeftMostLeaf(o),0,e.getEndNode(),e.getEndOffset())}return null},goog.editor.range.expand=function(e,o){var g=goog.editor.range.expandEndPointToContainer_(e,goog.dom.RangeEndpoint.START,o),n=(g=goog.editor.range.expandEndPointToContainer_(g,goog.dom.RangeEndpoint.END,o)).getStartNode(),t=g.getEndNode(),r=g.getStartOffset(),i=g.getEndOffset();if(n==t){for(;t!=o&&0==r&&i==goog.editor.node.getLength(t);){var d=t.parentNode;i=(r=goog.array.indexOf(d.childNodes,t))+1,t=d}n=t}return goog.dom.Range.createFromNodes(n,r,t,i)},goog.editor.range.expandEndPointToContainer_=function(e,o,g){for(var n=o==goog.dom.RangeEndpoint.START,t=n?e.getStartNode():e.getEndNode(),r=n?e.getStartOffset():e.getEndOffset(),i=e.getContainerElement();t!=i&&t!=g&&!(n&&0!=r||!n&&r!=goog.editor.node.getLength(t));){var d=t.parentNode,a=goog.array.indexOf(d.childNodes,t);r=n?a:a+1,t=d}return goog.dom.Range.createFromNodes(n?t:e.getStartNode(),n?r:e.getStartOffset(),n?e.getEndNode():t,n?e.getEndOffset():r)},goog.editor.range.selectNodeStart=function(e){goog.dom.Range.createCaret(goog.editor.node.getLeftMostLeaf(e),0).select()},goog.editor.range.placeCursorNextTo=function(e,o){var g=e.parentNode,n=goog.array.indexOf(g.childNodes,e)+(o?0:1),t=goog.editor.range.Point.createDeepestPoint(g,n,o,!0),r=goog.dom.Range.createCaret(t.node,t.offset);return r.select(),r},goog.editor.range.selectionPreservingNormalize=function(e){var o=goog.dom.getOwnerDocument(e),g=goog.dom.Range.createFromWindow(goog.dom.getWindow(o)),n=goog.editor.range.rangePreservingNormalize(e,g);n&&n.select()},goog.editor.range.normalizeNodeIe_=function(e){for(var o=null,g=e.firstChild;g;){var n=g.nextSibling;g.nodeType==goog.dom.NodeType.TEXT?""==g.nodeValue?e.removeChild(g):o?(o.nodeValue+=g.nodeValue,e.removeChild(g)):o=g:(goog.editor.range.normalizeNodeIe_(g),o=null),g=n}},goog.editor.range.normalizeNode=function(e){goog.userAgent.IE?goog.editor.range.normalizeNodeIe_(e):e.normalize()},goog.editor.range.rangePreservingNormalize=function(e,o){if(o)var g=goog.editor.range.normalize(o),n=goog.editor.style.getContainer(o.getContainerElement());return n?goog.editor.range.normalizeNode(goog.dom.findCommonAncestor(n,e)):e&&goog.editor.range.normalizeNode(e),g?g():null},goog.editor.range.getDeepEndPoint=function(e,o){return o?goog.editor.range.Point.createDeepestPoint(e.getStartNode(),e.getStartOffset()):goog.editor.range.Point.createDeepestPoint(e.getEndNode(),e.getEndOffset())},goog.editor.range.normalize=function(e){var o=e.isReversed(),g=goog.editor.range.normalizePoint_(goog.editor.range.getDeepEndPoint(e,!o)),n=g.getParentPoint(),t=g.node.previousSibling;g.node.nodeType==goog.dom.NodeType.TEXT&&(g.node=null);var r=goog.editor.range.normalizePoint_(goog.editor.range.getDeepEndPoint(e,o)),i=r.getParentPoint(),d=r.node.previousSibling;return r.node.nodeType==goog.dom.NodeType.TEXT&&(r.node=null),function(){return!g.node&&t&&(g.node=t.nextSibling,g.node||(g=goog.editor.range.Point.getPointAtEndOfNode(t))),!r.node&&d&&(r.node=d.nextSibling,r.node||(r=goog.editor.range.Point.getPointAtEndOfNode(d))),goog.dom.Range.createFromNodes(g.node||n.node.firstChild||n.node,g.offset,r.node||i.node.firstChild||i.node,r.offset)}},goog.editor.range.normalizePoint_=function(e){var o;if(e.node.nodeType==goog.dom.NodeType.TEXT){for(var g=e.node.previousSibling;g&&g.nodeType==goog.dom.NodeType.TEXT;g=g.previousSibling)e.offset+=goog.editor.node.getLength(g);o=g}else o=e.node.previousSibling;var n=e.node.parentNode;return e.node=o?o.nextSibling:n.firstChild,e},goog.editor.range.isEditable=function(e){var o=e.getContainerElement();return e.getStartNode()!=o.parentElement&&goog.editor.node.isEditableContainer(o)||goog.editor.node.isEditable(o)},goog.editor.range.intersectsTag=function(e,o){return!!goog.dom.getAncestorByTagNameAndClass(e.getContainerElement(),o)||goog.iter.some(e,function(e){return e.tagName==o})},goog.editor.range.Point=function(e,o){this.node=e,this.offset=o},goog.editor.range.Point.prototype.getParentPoint=function(){var e=this.node.parentNode;return new goog.editor.range.Point(e,goog.array.indexOf(e.childNodes,this.node))},goog.editor.range.Point.createDeepestPoint=function(e,o,g,n){for(;e.nodeType==goog.dom.NodeType.ELEMENT;){var t=e.childNodes[o];if(!t&&!e.lastChild)break;if(t){var r=t.previousSibling;if(g&&r){if(n&&goog.editor.range.Point.isTerminalElement_(r))break;e=r,o=goog.editor.node.getLength(e)}else{if(n&&goog.editor.range.Point.isTerminalElement_(t))break;e=t,o=0}}else{if(n&&goog.editor.range.Point.isTerminalElement_(e.lastChild))break;e=e.lastChild,o=goog.editor.node.getLength(e)}}return new goog.editor.range.Point(e,o)},goog.editor.range.Point.isTerminalElement_=function(e){return e.nodeType==goog.dom.NodeType.ELEMENT&&!goog.dom.canHaveChildren(e)},goog.editor.range.Point.getPointAtEndOfNode=function(e){return new goog.editor.range.Point(e,goog.editor.node.getLength(e))},goog.editor.range.saveUsingNormalizedCarets=function(e){return new goog.editor.range.NormalizedCaretRange_(e)},goog.editor.range.NormalizedCaretRange_=function(e){goog.dom.SavedCaretRange.call(this,e)},goog.inherits(goog.editor.range.NormalizedCaretRange_,goog.dom.SavedCaretRange),goog.editor.range.NormalizedCaretRange_.prototype.removeCarets=function(e){var o=this.getCaret(!0),g=this.getCaret(!1),n=o&&g?goog.dom.findCommonAncestor(o,g):o||g;if(goog.editor.range.NormalizedCaretRange_.superClass_.removeCarets.call(this),e)return goog.editor.range.rangePreservingNormalize(n,e);n&&goog.editor.range.selectionPreservingNormalize(n)};