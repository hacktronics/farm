goog.provide("goog.crypt.BlobHasher"),goog.provide("goog.crypt.BlobHasher.EventType"),goog.require("goog.asserts"),goog.require("goog.events.EventTarget"),goog.require("goog.fs"),goog.require("goog.log"),goog.crypt.BlobHasher=function(e,o){goog.crypt.BlobHasher.base(this,"constructor"),this.hashFn_=e,this.blob_=null,this.hashVal_=null,this.bytesProcessed_=0,this.hashingLimit_=1/0,this.blockSize_=o||5e6,this.fileReader_=null,this.logger_=goog.log.getLogger("goog.crypt.BlobHasher")},goog.inherits(goog.crypt.BlobHasher,goog.events.EventTarget),goog.crypt.BlobHasher.EventType={STARTED:"started",PROGRESS:"progress",THROTTLED:"throttled",COMPLETE:"complete",ABORT:"abort",ERROR:"error"},goog.crypt.BlobHasher.prototype.hash=function(e){this.abort(),this.hashFn_.reset(),this.blob_=e,this.hashVal_=null,this.bytesProcessed_=0,this.dispatchEvent(goog.crypt.BlobHasher.EventType.STARTED),this.processNextBlock_()},goog.crypt.BlobHasher.prototype.setHashingLimit=function(e){goog.asserts.assert(e>=0,"Hashing limit must be non-negative."),this.hashingLimit_=e,this.blob_&&!this.fileReader_&&this.processNextBlock_()},goog.crypt.BlobHasher.prototype.abort=function(){this.fileReader_&&(this.fileReader_.abort(),this.fileReader_=null),this.blob_&&(this.blob_=null,this.dispatchEvent(goog.crypt.BlobHasher.EventType.ABORT))},goog.crypt.BlobHasher.prototype.getBytesProcessed=function(){return this.bytesProcessed_},goog.crypt.BlobHasher.prototype.getHash=function(){return this.hashVal_},goog.crypt.BlobHasher.prototype.processNextBlock_=function(){if(goog.asserts.assert(this.blob_,"A hash computation must be in progress."),this.bytesProcessed_<this.blob_.size){if(this.hashingLimit_<=this.bytesProcessed_)return void this.dispatchEvent(goog.crypt.BlobHasher.EventType.THROTTLED);this.fileReader_=new FileReader,this.fileReader_.onload=goog.bind(this.onLoad_,this),this.fileReader_.onerror=goog.bind(this.onError_,this);var e=Math.min(this.hashingLimit_,this.blob_.size),o=Math.min(e-this.bytesProcessed_,this.blockSize_),t=goog.fs.sliceBlob(this.blob_,this.bytesProcessed_,this.bytesProcessed_+o);if(!t||t.size!=o)return goog.log.error(this.logger_,"Failed slicing the blob"),void this.onError_();this.fileReader_.readAsArrayBuffer?this.fileReader_.readAsArrayBuffer(t):this.fileReader_.readAsBinaryString?this.fileReader_.readAsBinaryString(t):(goog.log.error(this.logger_,"Failed calling the chunk reader"),this.onError_())}else this.hashVal_=this.hashFn_.digest(),this.blob_=null,this.dispatchEvent(goog.crypt.BlobHasher.EventType.COMPLETE)},goog.crypt.BlobHasher.prototype.onLoad_=function(){goog.log.info(this.logger_,"Successfully loaded a chunk");var e=null;if(this.fileReader_.result instanceof Array||"string"==typeof this.fileReader_.result?e=this.fileReader_.result:goog.global.ArrayBuffer&&goog.global.Uint8Array&&this.fileReader_.result instanceof ArrayBuffer&&(e=new Uint8Array(this.fileReader_.result)),!e)return goog.log.error(this.logger_,"Failed reading the chunk"),void this.onError_();this.hashFn_.update(e),this.bytesProcessed_+=e.length,this.fileReader_=null,this.dispatchEvent(goog.crypt.BlobHasher.EventType.PROGRESS),this.processNextBlock_()},goog.crypt.BlobHasher.prototype.onError_=function(){this.fileReader_=null,this.blob_=null,this.dispatchEvent(goog.crypt.BlobHasher.EventType.ERROR)};