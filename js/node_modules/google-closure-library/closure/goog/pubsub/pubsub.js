goog.provide("goog.pubsub.PubSub"),goog.require("goog.Disposable"),goog.require("goog.array"),goog.require("goog.async.run"),goog.pubsub.PubSub=function(s){goog.pubsub.PubSub.base(this,"constructor"),this.key_=1,this.pendingKeys_=[],this.publishDepth_=0,this.subscriptions_=[],this.topics_={},this.async_=Boolean(s)},goog.inherits(goog.pubsub.PubSub,goog.Disposable),goog.pubsub.PubSub.prototype.subscribe=function(s,i,t){var o=this.topics_[s];o||(o=this.topics_[s]=[]);var u=this.key_;return this.subscriptions_[u]=s,this.subscriptions_[u+1]=i,this.subscriptions_[u+2]=t,this.key_=u+3,o.push(u),u},goog.pubsub.PubSub.prototype.subscribeOnce=function(s,i,t){var o=!1,u=this.subscribe(s,function(s){o||(o=!0,this.unsubscribeByKey(u),i.apply(t,arguments))},this);return u},goog.pubsub.PubSub.prototype.unsubscribe=function(s,i,t){var o=this.topics_[s];if(o){var u=this.subscriptions_,b=goog.array.find(o,function(s){return u[s+1]==i&&u[s+2]==t});if(b)return this.unsubscribeByKey(b)}return!1},goog.pubsub.PubSub.prototype.unsubscribeByKey=function(s){var i=this.subscriptions_[s];if(i){var t=this.topics_[i];0!=this.publishDepth_?(this.pendingKeys_.push(s),this.subscriptions_[s+1]=goog.nullFunction):(t&&goog.array.remove(t,s),delete this.subscriptions_[s],delete this.subscriptions_[s+1],delete this.subscriptions_[s+2])}return!!i},goog.pubsub.PubSub.prototype.publish=function(s,i){var t=this.topics_[s];if(t){for(var o=new Array(arguments.length-1),u=1,b=arguments.length;u<b;u++)o[u-1]=arguments[u];if(this.async_)for(u=0;u<t.length;u++){var r=t[u];goog.pubsub.PubSub.runAsync_(this.subscriptions_[r+1],this.subscriptions_[r+2],o)}else{this.publishDepth_++;try{for(u=0,b=t.length;u<b;u++){r=t[u];this.subscriptions_[r+1].apply(this.subscriptions_[r+2],o)}}finally{if(this.publishDepth_--,this.pendingKeys_.length>0&&0==this.publishDepth_)for(var n;n=this.pendingKeys_.pop();)this.unsubscribeByKey(n)}}return 0!=u}return!1},goog.pubsub.PubSub.runAsync_=function(s,i,t){goog.async.run(function(){s.apply(i,t)})},goog.pubsub.PubSub.prototype.clear=function(s){if(s){var i=this.topics_[s];i&&(goog.array.forEach(i,this.unsubscribeByKey,this),delete this.topics_[s])}else this.subscriptions_.length=0,this.topics_={}},goog.pubsub.PubSub.prototype.getCount=function(s){if(s){var i=this.topics_[s];return i?i.length:0}var t=0;for(var o in this.topics_)t+=this.getCount(o);return t},goog.pubsub.PubSub.prototype.disposeInternal=function(){goog.pubsub.PubSub.base(this,"disposeInternal"),this.clear(),this.pendingKeys_.length=0};