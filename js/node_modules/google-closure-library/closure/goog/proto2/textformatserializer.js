goog.provide("goog.proto2.TextFormatSerializer"),goog.require("goog.array"),goog.require("goog.asserts"),goog.require("goog.math"),goog.require("goog.object"),goog.require("goog.proto2.FieldDescriptor"),goog.require("goog.proto2.Message"),goog.require("goog.proto2.Serializer"),goog.require("goog.string"),goog.proto2.TextFormatSerializer=function(e,o){this.ignoreMissingFields_=!!e,this.useEnumValues_=!!o},goog.inherits(goog.proto2.TextFormatSerializer,goog.proto2.Serializer),goog.proto2.TextFormatSerializer.prototype.deserializeTo=function(e,o){var r=o.toString(),t=new goog.proto2.TextFormatSerializer.Parser;return t.parse(e,r,this.ignoreMissingFields_)?null:t.getError()},goog.proto2.TextFormatSerializer.prototype.serialize=function(e){var o=new goog.proto2.TextFormatSerializer.Printer_;return this.serializeMessage_(e,o),o.toString()},goog.proto2.TextFormatSerializer.prototype.serializeMessage_=function(e,o){var r=e.getDescriptor().getFields();goog.array.forEach(r,function(r){this.printField_(e,r,o)},this),e.forEachUnknown(function(e,r){this.serializeUnknown_(e,r,goog.asserts.assert(o))},this)},goog.proto2.TextFormatSerializer.prototype.serializeUnknown_=function(e,o,r){if(null!=o)if(goog.isArray(o))goog.array.forEach(o,function(o){this.serializeUnknown_(e,o,r)},this);else{if(goog.isObject(o)){if(r.append(e),r.append(" {"),r.appendLine(),r.indent(),o instanceof goog.proto2.Message)this.serializeMessage_(o,r);else for(var t in o){var i=goog.string.parseInt(t);goog.asserts.assert(goog.math.isInt(i)),this.serializeUnknown_(i,o[t],r)}return r.dedent(),r.append("}"),void r.appendLine()}"string"==typeof o&&(o=goog.string.quote(o)),r.append(e),r.append(": "),r.append(o),r.appendLine()}},goog.proto2.TextFormatSerializer.prototype.printFieldValue_=function(e,o,r){switch(o.getFieldType()){case goog.proto2.FieldDescriptor.FieldType.DOUBLE:case goog.proto2.FieldDescriptor.FieldType.FLOAT:case goog.proto2.FieldDescriptor.FieldType.INT64:case goog.proto2.FieldDescriptor.FieldType.UINT64:case goog.proto2.FieldDescriptor.FieldType.INT32:case goog.proto2.FieldDescriptor.FieldType.UINT32:case goog.proto2.FieldDescriptor.FieldType.FIXED64:case goog.proto2.FieldDescriptor.FieldType.FIXED32:case goog.proto2.FieldDescriptor.FieldType.BOOL:case goog.proto2.FieldDescriptor.FieldType.SFIXED32:case goog.proto2.FieldDescriptor.FieldType.SFIXED64:case goog.proto2.FieldDescriptor.FieldType.SINT32:case goog.proto2.FieldDescriptor.FieldType.SINT64:r.append(e);break;case goog.proto2.FieldDescriptor.FieldType.BYTES:case goog.proto2.FieldDescriptor.FieldType.STRING:e=goog.string.quote(e.toString()),r.append(e);break;case goog.proto2.FieldDescriptor.FieldType.ENUM:if(!this.useEnumValues_){var t=!1;goog.object.forEach(o.getNativeType(),function(o,i){t||o!=e||(r.append(i),t=!0)})}t&&!this.useEnumValues_||r.append(e.toString());break;case goog.proto2.FieldDescriptor.FieldType.GROUP:case goog.proto2.FieldDescriptor.FieldType.MESSAGE:this.serializeMessage_(e,r)}},goog.proto2.TextFormatSerializer.prototype.printField_=function(e,o,r){if(e.has(o))for(var t=e.countOf(o),i=0;i<t;++i)r.append(o.getName()),o.getFieldType()==goog.proto2.FieldDescriptor.FieldType.MESSAGE||o.getFieldType()==goog.proto2.FieldDescriptor.FieldType.GROUP?(r.append(" {"),r.appendLine(),r.indent()):r.append(": "),this.printFieldValue_(e.get(o,i),o,r),o.getFieldType()==goog.proto2.FieldDescriptor.FieldType.MESSAGE||o.getFieldType()==goog.proto2.FieldDescriptor.FieldType.GROUP?(r.dedent(),r.append("}"),r.appendLine()):r.appendLine()},goog.proto2.TextFormatSerializer.Printer_=function(){this.indentation_=0,this.buffer_=[],this.requiresIndentation_=!0},goog.proto2.TextFormatSerializer.Printer_.prototype.toString=function(){return this.buffer_.join("")},goog.proto2.TextFormatSerializer.Printer_.prototype.indent=function(){this.indentation_+=2},goog.proto2.TextFormatSerializer.Printer_.prototype.dedent=function(){this.indentation_-=2,goog.asserts.assert(this.indentation_>=0)},goog.proto2.TextFormatSerializer.Printer_.prototype.append=function(e){if(this.requiresIndentation_){for(var o=0;o<this.indentation_;++o)this.buffer_.push(" ");this.requiresIndentation_=!1}this.buffer_.push(String(e))},goog.proto2.TextFormatSerializer.Printer_.prototype.appendLine=function(){this.buffer_.push("\n"),this.requiresIndentation_=!0},goog.proto2.TextFormatSerializer.Tokenizer_=function(e,o,r){this.ignoreWhitespace_=!!o,this.ignoreComments_=!!r,this.data_=e,this.index_=0,this.currentData_=e,this.current_={type:goog.proto2.TextFormatSerializer.Tokenizer_.TokenTypes.END,value:null}},goog.proto2.TextFormatSerializer.Tokenizer_.Token,goog.proto2.TextFormatSerializer.Tokenizer_.prototype.getCurrent=function(){return this.current_},goog.proto2.TextFormatSerializer.Tokenizer_.TokenTypes={END:/---end---/,IDENTIFIER:/^-?[a-zA-Z][a-zA-Z0-9_]*/,NUMBER:/^(0x[0-9a-f]+)|(([-])?[0-9][0-9]*(\.?[0-9]+)?(e[+-]?[0-9]+|[f])?)/,COMMENT:/^#.*/,OPEN_BRACE:/^{/,CLOSE_BRACE:/^}/,OPEN_TAG:/^</,CLOSE_TAG:/^>/,OPEN_LIST:/^\[/,CLOSE_LIST:/^\]/,STRING:new RegExp('^"([^"\\\\]|\\\\.)*"'),COLON:/^:/,COMMA:/^,/,SEMI:/^;/,WHITESPACE:/^\s/},goog.proto2.TextFormatSerializer.Tokenizer_.prototype.next=function(){for(var e=goog.proto2.TextFormatSerializer.Tokenizer_.TokenTypes;this.nextInternal_();){var o=this.getCurrent().type;if(o!=e.WHITESPACE&&o!=e.COMMENT||o==e.WHITESPACE&&!this.ignoreWhitespace_||o==e.COMMENT&&!this.ignoreComments_)return!0}return this.current_={type:goog.proto2.TextFormatSerializer.Tokenizer_.TokenTypes.END,value:null},!1},goog.proto2.TextFormatSerializer.Tokenizer_.prototype.nextInternal_=function(){if(this.index_>=this.data_.length)return!1;var e=this.currentData_,o=goog.proto2.TextFormatSerializer.Tokenizer_.TokenTypes,r=null;return goog.object.some(o,function(t,i){if(r||t==o.END)return!1;var n=t.exec(e);return n&&0==n.index&&(r={type:t,value:n[0]}),!!r}),r&&(this.current_=r,this.index_+=r.value.length,this.currentData_=this.currentData_.substring(r.value.length)),!!r},goog.proto2.TextFormatSerializer.Parser=function(){this.error_=null,this.tokenizer_=null,this.ignoreMissingFields_=!1},goog.proto2.TextFormatSerializer.Parser.prototype.parse=function(e,o,r){return this.error_=null,this.ignoreMissingFields_=!!r,this.tokenizer_=new goog.proto2.TextFormatSerializer.Tokenizer_(o,!0,!0),this.tokenizer_.next(),this.consumeMessage_(e,"")},goog.proto2.TextFormatSerializer.Parser.prototype.getError=function(){return this.error_},goog.proto2.TextFormatSerializer.Parser.prototype.reportError_=function(e){this.error_=e},goog.proto2.TextFormatSerializer.Parser.prototype.consumeMessage_=function(e,o){for(var r=goog.proto2.TextFormatSerializer.Tokenizer_.TokenTypes;!this.lookingAt_(">")&&!this.lookingAt_("}")&&!this.lookingAtType_(r.END);)if(!this.consumeField_(e))return!1;if(o){if(!this.consume_(o))return!1}else this.lookingAtType_(r.END)||this.reportError_("Expected END token");return!0},goog.proto2.TextFormatSerializer.Parser.prototype.consumeFieldValue_=function(e,o){var r=this.getFieldValue_(o);return null!==r&&(o.isRepeated()?e.add(o,r):e.set(o,r),!0)},goog.proto2.TextFormatSerializer.Parser.getNumberFromString_=function(e){var o=goog.string.contains(e,".")?parseFloat(e):goog.string.parseInt(e);return goog.asserts.assert(!isNaN(o)),goog.asserts.assert(isFinite(o)),o},goog.proto2.TextFormatSerializer.Parser.parseNumericalConstant_=function(e){return/^-?inf(?:inity)?f?$/i.test(e)?1/0*(goog.string.startsWith(e,"-")?-1:1):/^nanf?$/i.test(e)?NaN:null},goog.proto2.TextFormatSerializer.Parser.prototype.getFieldValue_=function(e){var o=goog.proto2.TextFormatSerializer.Tokenizer_.TokenTypes;switch(e.getFieldType()){case goog.proto2.FieldDescriptor.FieldType.DOUBLE:case goog.proto2.FieldDescriptor.FieldType.FLOAT:var r=this.consumeIdentifier_();if(r){var t=goog.proto2.TextFormatSerializer.Parser.parseNumericalConstant_(r);if(null!=t)return t}case goog.proto2.FieldDescriptor.FieldType.INT32:case goog.proto2.FieldDescriptor.FieldType.UINT32:case goog.proto2.FieldDescriptor.FieldType.FIXED32:case goog.proto2.FieldDescriptor.FieldType.SFIXED32:case goog.proto2.FieldDescriptor.FieldType.SINT32:return(n=this.consumeNumber_())?goog.proto2.TextFormatSerializer.Parser.getNumberFromString_(n):null;case goog.proto2.FieldDescriptor.FieldType.INT64:case goog.proto2.FieldDescriptor.FieldType.UINT64:case goog.proto2.FieldDescriptor.FieldType.FIXED64:case goog.proto2.FieldDescriptor.FieldType.SFIXED64:case goog.proto2.FieldDescriptor.FieldType.SINT64:return(n=this.consumeNumber_())?e.getNativeType()==Number?goog.proto2.TextFormatSerializer.Parser.getNumberFromString_(n):n:null;case goog.proto2.FieldDescriptor.FieldType.BOOL:var i=this.consumeIdentifier_();if(!i)return null;switch(i){case"true":return!0;case"false":return!1;default:return this.reportError_("Unknown type for bool: "+i),null}case goog.proto2.FieldDescriptor.FieldType.ENUM:var n;if(this.lookingAtType_(o.NUMBER))return(n=this.consumeNumber_())?goog.proto2.TextFormatSerializer.Parser.getNumberFromString_(n):null;var s=this.consumeIdentifier_();if(!s)return null;var g=e.getNativeType()[s];return null==g?(this.reportError_("Unknown enum value: "+s),null):g;case goog.proto2.FieldDescriptor.FieldType.BYTES:case goog.proto2.FieldDescriptor.FieldType.STRING:return this.consumeString_()}},goog.proto2.TextFormatSerializer.Parser.prototype.consumeNestedMessage_=function(e,o){var r="";if(this.tryConsume_("<"))r=">";else{if(!this.consume_("{"))return!1;r="}"}var t=o.getFieldMessageType().createMessageInstance();return!!this.consumeMessage_(t,r)&&(o.isRepeated()?e.add(o,t):e.set(o,t),!0)},goog.proto2.TextFormatSerializer.Parser.prototype.consumeUnknownFieldValue_=function(){if(this.tryConsume_(":"),this.tryConsume_("[")){for(;this.tokenizer_.next(),!this.tryConsume_("]");)if(!this.consume_(","))return!1;return!0}return this.tryConsume_("<")?this.consumeMessage_(null,">"):this.tryConsume_("{")?this.consumeMessage_(null,"}"):(this.tokenizer_.next(),!0)},goog.proto2.TextFormatSerializer.Parser.prototype.consumeField_=function(e){var o=this.consumeIdentifier_();if(!o)return this.reportError_("Missing field name"),!1;var r=null;if(e&&(r=e.getDescriptor().findFieldByName(o.toString())),null==r)return this.ignoreMissingFields_?this.consumeUnknownFieldValue_():(this.reportError_("Unknown field: "+o),!1);if(r.getFieldType()==goog.proto2.FieldDescriptor.FieldType.MESSAGE||r.getFieldType()==goog.proto2.FieldDescriptor.FieldType.GROUP){if(this.tryConsume_(":"),!this.consumeNestedMessage_(e,r))return!1}else{if(!this.consume_(":"))return!1;if(r.isRepeated()&&this.tryConsume_("["))for(;;){if(!this.consumeFieldValue_(e,r))return!1;if(this.tryConsume_("]"))break;if(!this.consume_(","))return!1}else if(!this.consumeFieldValue_(e,r))return!1}return this.tryConsume_(",")||this.tryConsume_(";"),!0},goog.proto2.TextFormatSerializer.Parser.prototype.tryConsume_=function(e){return!!this.lookingAt_(e)&&(this.tokenizer_.next(),!0)},goog.proto2.TextFormatSerializer.Parser.prototype.consumeToken_=function(e){if(!this.lookingAtType_(e))return this.reportError_("Expected token type: "+e),null;var o=this.tokenizer_.getCurrent().value;return this.tokenizer_.next(),o},goog.proto2.TextFormatSerializer.Parser.prototype.consumeIdentifier_=function(){var e=goog.proto2.TextFormatSerializer.Tokenizer_.TokenTypes;return this.consumeToken_(e.IDENTIFIER)},goog.proto2.TextFormatSerializer.Parser.prototype.consumeNumber_=function(){var e=goog.proto2.TextFormatSerializer.Tokenizer_.TokenTypes;return this.consumeToken_(e.NUMBER)},goog.proto2.TextFormatSerializer.Parser.prototype.consumeString_=function(){var e=goog.proto2.TextFormatSerializer.Tokenizer_.TokenTypes,o=this.consumeToken_(e.STRING);if(!o)return null;for(var r=JSON.parse(o).toString();this.lookingAtType_(e.STRING);)o=this.consumeToken_(e.STRING),r+=JSON.parse(o).toString();return r},goog.proto2.TextFormatSerializer.Parser.prototype.consume_=function(e){return!!this.tryConsume_(e)||(this.reportError_('Expected token "'+e+'"'),!1)},goog.proto2.TextFormatSerializer.Parser.prototype.lookingAt_=function(e){return this.tokenizer_.getCurrent().value==e},goog.proto2.TextFormatSerializer.Parser.prototype.lookingAtType_=function(e){return this.tokenizer_.getCurrent().type==e};