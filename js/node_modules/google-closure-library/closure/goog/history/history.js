goog.provide("goog.History"),goog.provide("goog.History.Event"),goog.provide("goog.History.EventType"),goog.require("goog.Timer"),goog.require("goog.asserts"),goog.require("goog.dom"),goog.require("goog.dom.InputType"),goog.require("goog.dom.safe"),goog.require("goog.events.Event"),goog.require("goog.events.EventHandler"),goog.require("goog.events.EventTarget"),goog.require("goog.events.EventType"),goog.require("goog.history.Event"),goog.require("goog.history.EventType"),goog.require("goog.html.SafeHtml"),goog.require("goog.html.TrustedResourceUrl"),goog.require("goog.html.uncheckedconversions"),goog.require("goog.labs.userAgent.device"),goog.require("goog.memoize"),goog.require("goog.string"),goog.require("goog.string.Const"),goog.require("goog.userAgent"),goog.History=function(o,e,t,i){if(goog.events.EventTarget.call(this),o&&!e)throw new Error("Can't use invisible history without providing a blank page.");var g;if(t)g=t;else{var s="history_state"+goog.History.historyCount_,n=goog.html.SafeHtml.create("input",{type:goog.dom.InputType.TEXT,name:s,id:s,style:goog.string.Const.from("display:none")});goog.dom.safe.documentWrite(document,n),g=goog.dom.getElement(s)}if(this.hiddenInput_=g,this.window_=t?goog.dom.getWindow(goog.dom.getOwnerDocument(t)):window,this.iframeSrc_=e,goog.userAgent.IE&&!e&&("https"==window.location.protocol?this.iframeSrc_=goog.html.TrustedResourceUrl.fromConstant(goog.string.Const.from("https:///")):this.iframeSrc_=goog.html.TrustedResourceUrl.fromConstant(goog.string.Const.from('javascript:""'))),this.timer_=new goog.Timer(goog.History.PollingType.NORMAL),this.registerDisposable(this.timer_),this.userVisible_=!o,this.eventHandler_=new goog.events.EventHandler(this),o||goog.History.LEGACY_IE){var r;if(i)r=i;else{var h="history_iframe"+goog.History.historyCount_,a=goog.html.SafeHtml.createIframe(this.iframeSrc_,null,{id:h,style:goog.string.Const.from("display:none"),sandbox:void 0});goog.dom.safe.documentWrite(document,a),r=goog.dom.getElement(h)}this.iframe_=r,this.unsetIframe_=!0}goog.History.LEGACY_IE&&(this.eventHandler_.listen(this.window_,goog.events.EventType.LOAD,this.onDocumentLoaded),this.documentLoaded=!1,this.shouldEnable_=!1),this.userVisible_?this.setHash_(this.getToken(),!0):this.setIframeToken_(this.hiddenInput_.value),goog.History.historyCount_++},goog.inherits(goog.History,goog.events.EventTarget),goog.History.prototype.enabled_=!1,goog.History.prototype.longerPolling_=!1,goog.History.prototype.lastToken_=null,goog.History.isOnHashChangeSupported=goog.memoize(function(){return goog.userAgent.IE?goog.userAgent.isDocumentModeOrHigher(8):"onhashchange"in goog.global}),goog.History.LEGACY_IE=goog.userAgent.IE&&!goog.userAgent.isDocumentModeOrHigher(8),goog.History.HASH_ALWAYS_REQUIRED=goog.History.LEGACY_IE,goog.History.prototype.lockedToken_=null,goog.History.prototype.disposeInternal=function(){goog.History.superClass_.disposeInternal.call(this),this.eventHandler_.dispose(),this.setEnabled(!1)},goog.History.prototype.setEnabled=function(o){o!=this.enabled_&&(!goog.History.LEGACY_IE||this.documentLoaded?o?(goog.userAgent.OPERA?this.eventHandler_.listen(this.window_.document,goog.History.INPUT_EVENTS_,this.operaDefibrillator_):goog.userAgent.GECKO&&this.eventHandler_.listen(this.window_,"pageshow",this.onShow_),goog.History.isOnHashChangeSupported()&&this.userVisible_?(this.eventHandler_.listen(this.window_,goog.events.EventType.HASHCHANGE,this.onHashChange_),this.enabled_=!0,this.dispatchEvent(new goog.history.Event(this.getToken(),!1))):(!goog.userAgent.IE||goog.labs.userAgent.device.isMobile()||this.documentLoaded)&&(this.eventHandler_.listen(this.timer_,goog.Timer.TICK,goog.bind(this.check_,this,!0)),this.enabled_=!0,goog.History.LEGACY_IE||(this.lastToken_=this.getToken(),this.dispatchEvent(new goog.history.Event(this.getToken(),!1))),this.timer_.start())):(this.enabled_=!1,this.eventHandler_.removeAll(),this.timer_.stop()):this.shouldEnable_=o)},goog.History.prototype.onDocumentLoaded=function(){this.documentLoaded=!0,this.hiddenInput_.value&&this.setIframeToken_(this.hiddenInput_.value,!0),this.setEnabled(this.shouldEnable_)},goog.History.prototype.onShow_=function(o){o.getBrowserEvent().persisted&&(this.setEnabled(!1),this.setEnabled(!0))},goog.History.prototype.onHashChange_=function(o){var e=this.getLocationFragment_(this.window_);e!=this.lastToken_&&this.update_(e,!0)},goog.History.prototype.getToken=function(){return null!=this.lockedToken_?this.lockedToken_:this.userVisible_?this.getLocationFragment_(this.window_):this.getIframeToken_()||""},goog.History.prototype.setToken=function(o,e){this.setHistoryState_(o,!1,e)},goog.History.prototype.replaceToken=function(o,e){this.setHistoryState_(o,!0,e)},goog.History.prototype.getLocationFragment_=function(o){var e=o.location.href,t=e.indexOf("#");return t<0?"":e.substring(t+1)},goog.History.prototype.setHistoryState_=function(o,e,t){this.getToken()!=o&&(this.userVisible_?(this.setHash_(o,e),goog.History.isOnHashChangeSupported()||goog.userAgent.IE&&!goog.labs.userAgent.device.isMobile()&&this.setIframeToken_(o,e,t),this.enabled_&&this.check_(!1)):(this.setIframeToken_(o,e),this.lockedToken_=this.lastToken_=this.hiddenInput_.value=o,this.dispatchEvent(new goog.history.Event(o,!1))))},goog.History.prototype.setHash_=function(o,e){var t=this.window_.location,i=t.href.split("#")[0],g=goog.string.contains(t.href,"#");if((goog.History.HASH_ALWAYS_REQUIRED||g||o)&&(i+="#"+o),i!=t.href){var s=goog.html.uncheckedconversions.safeUrlFromStringKnownToSatisfyTypeContract(goog.string.Const.from("URL taken from location.href."),i);e?goog.dom.safe.replaceLocation(t,s):goog.dom.safe.setLocationHref(t,s)}},goog.History.prototype.setIframeToken_=function(o,e,t){if(this.unsetIframe_||o!=this.getIframeToken_())if(this.unsetIframe_=!1,o=goog.string.urlEncode(o),goog.userAgent.IE){var i=goog.dom.getFrameContentDocument(this.iframe_);i.open("text/html",e?"replace":void 0);var g=goog.html.SafeHtml.concat(goog.html.SafeHtml.create("title",{},t||this.window_.document.title),goog.html.SafeHtml.create("body",{},o));goog.dom.safe.documentWrite(i,g),i.close()}else{goog.asserts.assertInstanceof(this.iframeSrc_,goog.html.TrustedResourceUrl,"this.iframeSrc_ must be set on calls to setIframeToken_");var s=goog.html.TrustedResourceUrl.unwrap(this.iframeSrc_)+"#"+o,n=this.iframe_.contentWindow;n&&(e?goog.dom.safe.replaceLocation(n.location,s):goog.dom.safe.setLocationHref(n.location,s))}},goog.History.prototype.getIframeToken_=function(){if(goog.userAgent.IE){var o=goog.dom.getFrameContentDocument(this.iframe_);return o.body?goog.string.urlDecode(o.body.innerHTML):null}var e=this.iframe_.contentWindow;if(e){var t;try{t=goog.string.urlDecode(this.getLocationFragment_(e))}catch(o){return this.longerPolling_||this.setLongerPolling_(!0),null}return this.longerPolling_&&this.setLongerPolling_(!1),t||null}return null},goog.History.prototype.check_=function(o){if(this.userVisible_){var e=this.getLocationFragment_(this.window_);e!=this.lastToken_&&this.update_(e,o)}if(!this.userVisible_||goog.History.LEGACY_IE){var t=this.getIframeToken_()||"";null!=this.lockedToken_&&t!=this.lockedToken_||(this.lockedToken_=null,t!=this.lastToken_&&this.update_(t,o))}},goog.History.prototype.update_=function(o,e){this.lastToken_=this.hiddenInput_.value=o,this.userVisible_?(goog.History.LEGACY_IE&&this.setIframeToken_(o),this.setHash_(o)):this.setIframeToken_(o),this.dispatchEvent(new goog.history.Event(this.getToken(),e))},goog.History.prototype.setLongerPolling_=function(o){this.longerPolling_!=o&&this.timer_.setInterval(o?goog.History.PollingType.LONG:goog.History.PollingType.NORMAL),this.longerPolling_=o},goog.History.prototype.operaDefibrillator_=function(){this.timer_.stop(),this.timer_.start()},goog.History.INPUT_EVENTS_=[goog.events.EventType.MOUSEDOWN,goog.events.EventType.KEYDOWN,goog.events.EventType.MOUSEMOVE],goog.History.historyCount_=0,goog.History.PollingType={NORMAL:150,LONG:1e4},goog.History.EventType=goog.history.EventType,goog.History.Event=goog.history.Event;