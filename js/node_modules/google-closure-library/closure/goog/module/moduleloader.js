goog.provide("goog.module.ModuleLoader"),goog.require("goog.Timer"),goog.require("goog.array"),goog.require("goog.asserts"),goog.require("goog.dom"),goog.require("goog.dom.safe"),goog.require("goog.events"),goog.require("goog.events.Event"),goog.require("goog.events.EventHandler"),goog.require("goog.events.EventId"),goog.require("goog.events.EventTarget"),goog.require("goog.functions"),goog.require("goog.html.TrustedResourceUrl"),goog.require("goog.labs.userAgent.browser"),goog.require("goog.log"),goog.require("goog.module.AbstractModuleLoader"),goog.require("goog.net.BulkLoader"),goog.require("goog.net.EventType"),goog.require("goog.net.jsloader"),goog.require("goog.userAgent"),goog.require("goog.userAgent.product"),goog.module.ModuleLoader=function(){goog.module.ModuleLoader.base(this,"constructor"),this.eventHandler_=new goog.events.EventHandler(this),this.registerDisposable(this.eventHandler_),this.loadingModulesStatus_={}},goog.inherits(goog.module.ModuleLoader,goog.events.EventTarget),goog.module.ModuleLoader.prototype.logger=goog.log.getLogger("goog.module.ModuleLoader"),goog.module.ModuleLoader.prototype.debugMode_=!1,goog.module.ModuleLoader.prototype.sourceUrlInjection_=!1,goog.module.ModuleLoader.prototype.useScriptTags_=!1,goog.module.ModuleLoader.supportsSourceUrlStackTraces=function(){return goog.userAgent.product.CHROME||goog.labs.userAgent.browser.isFirefox()&&goog.labs.userAgent.browser.isVersionOrHigher("36")},goog.module.ModuleLoader.supportsSourceUrlDebugger=function(){return goog.userAgent.product.CHROME||goog.userAgent.GECKO},goog.module.ModuleLoader.URL_MAX_LENGTH_=4043,goog.module.ModuleLoader.SYNTAX_OR_NETWORK_ERROR_CODE_=-1,goog.module.ModuleLoader.createScriptElement_=function(o){const e=goog.dom.createElement(goog.dom.TagName.SCRIPT);return goog.dom.safe.setScriptSrc(e,o),e.async=!1,e},goog.module.ModuleLoader.createPreloadScriptElement_=function(o){const e=goog.dom.createElement(goog.dom.TagName.LINK);return goog.dom.safe.setLinkHrefAndRel(e,o,"preload"),e.as="script",e},goog.module.ModuleLoader.prototype.getDebugMode=function(){return this.debugMode_},goog.module.ModuleLoader.prototype.setUseScriptTags=function(o){this.useScriptTags_=o},goog.module.ModuleLoader.prototype.getUseScriptTags=function(){return this.useScriptTags_},goog.module.ModuleLoader.prototype.setDebugMode=function(o){this.debugMode_=o},goog.module.ModuleLoader.prototype.setSourceUrlInjection=function(o){this.sourceUrlInjection_=o},goog.module.ModuleLoader.prototype.usingSourceUrlInjection_=function(){return this.sourceUrlInjection_||this.getDebugMode()&&goog.module.ModuleLoader.supportsSourceUrlStackTraces()},goog.module.ModuleLoader.prototype.loadModules=function(o,e,t,r,g,s){var u=this.loadingModulesStatus_[o]||goog.module.ModuleLoader.LoadStatus.createForIds_(o,e);u.loadRequested=!0,u.successFn&&t?u.successFn=goog.functions.sequence(u.successFn,t):u.successFn=t||u.successFn,u.errorFn=r||null,this.loadingModulesStatus_[o]?this.getUseScriptTags()?this.downloadModules_(o):null!=u.responseTexts&&this.evaluateCode_(o):(this.loadingModulesStatus_[o]=u,this.downloadModules_(o))},goog.module.ModuleLoader.prototype.evaluateCode_=function(o){this.dispatchEvent(new goog.module.ModuleLoader.RequestSuccessEvent(o)),goog.log.info(this.logger,"evaluateCode ids:"+o);var e=this.loadingModulesStatus_[o],t=e.requestUris,r=e.responseTexts,g=null;try{if(this.usingSourceUrlInjection_())for(var s=0;s<t.length;s++){var u=t[s];goog.globalEval(r[s]+" //# sourceURL="+u)}else goog.globalEval(r.join("\n"))}catch(e){g=e,goog.log.warning(this.logger,"Loaded incomplete code for module(s): "+o,e)}this.dispatchEvent(new goog.module.ModuleLoader.EvaluateCodeEvent(o)),g?this.handleErrorHelper_(o,e.errorFn,null,g):e.successFn&&e.successFn(),delete this.loadingModulesStatus_[o]},goog.module.ModuleLoader.prototype.handleSuccess_=function(o,e){goog.log.info(this.logger,"Code loaded for module(s): "+e);var t=this.loadingModulesStatus_[e];t.responseTexts=o.getResponseTexts(),t.loadRequested&&this.evaluateCode_(e),goog.Timer.callOnce(o.dispose,5,o)},goog.module.ModuleLoader.prototype.prefetchModule=function(o,e){if(!this.getDebugMode()){goog.log.info(this.logger,`Prefetching module: ${o}`);var t=this.loadingModulesStatus_[[o]];if(!t){var r={};if(r[o]=e,t=goog.module.ModuleLoader.LoadStatus.createForIds_([o],r),this.loadingModulesStatus_[[o]]=t,this.getUseScriptTags()){const o=[],e=document.head||document.documentElement;for(var g=0;g<t.trustedRequestUris.length;g++){const r=goog.module.ModuleLoader.createPreloadScriptElement_(t.trustedRequestUris[g]);o.push(r),e.insertBefore(r,e.firstChild)}t.successFn=()=>{for(var e=0;e<o.length;e++){const t=o[e];goog.dom.removeNode(t)}}}else this.downloadModules_([o])}}},goog.module.ModuleLoader.prototype.downloadModules_=function(o){const e=this.getDebugMode(),t=this.usingSourceUrlInjection_(),r=this.getUseScriptTags();if(e+t+r>1){const o=r?"useScriptTags":e&&!t?"debug":"sourceUrlInjection";goog.log.warning(this.logger,`More than one of debugMode (set to ${e}), useScriptTags (set to ${r}), and sourceUrlInjection (set to ${t}) is enabled. Proceeding with download as if ${o} is set to true and the rest to false.`)}const g=goog.asserts.assert(this.loadingModulesStatus_[o]);if(r)this.loadWithNonAsyncScriptTag_(g,o);else if(e&&!t)goog.net.jsloader.safeLoadMany(g.trustedRequestUris);else{goog.log.info(this.logger,"downloadModules ids:"+o+" uris:"+g.requestUris);var s=new goog.net.BulkLoader(g.requestUris),u=this.eventHandler_;u.listen(s,goog.net.EventType.SUCCESS,goog.bind(this.handleSuccess_,this,s,o)),u.listen(s,goog.net.EventType.ERROR,goog.bind(this.handleError_,this,s,o)),s.load()}},goog.module.ModuleLoader.prototype.loadWithNonAsyncScriptTag_=function(o,e){if(goog.log.info(this.logger,`Loading initiated for: ${e}`),0==o.trustedRequestUris.length&&o.successFn)return void o.successFn();let t=null;const r=document.head||document.documentElement;for(var g=0;g<o.trustedRequestUris.length;g++){const s=o.trustedRequestUris[g],u=o.requestUris[g].length;goog.asserts.assert(u<=goog.module.ModuleLoader.URL_MAX_LENGTH_,`Module url length is ${u}, which is greater than limit of ${goog.module.ModuleLoader.URL_MAX_LENGTH_}. This should never happen.`);const d=goog.module.ModuleLoader.createScriptElement_(s);d.onload=()=>{d.onload=null,d.onerror=null,goog.dom.removeNode(d),d==t&&(goog.log.info(this.logger,`Loading complete for: ${e}`),t=null,o.successFn&&o.successFn())},d.onerror=()=>{goog.log.error(this.logger,`Network error when loading module(s): ${e}`),d.onload=null,d.onerror=null,goog.dom.removeNode(d),this.handleErrorHelper_(e,o.errorFn,goog.module.ModuleLoader.SYNTAX_OR_NETWORK_ERROR_CODE_),t==d?t=null:goog.log.error(this.logger,`Dependent requests were made in parallel with failed request for module(s) "${e}". Non-recoverable out-of-order execution may occur.`)},t=d,r.insertBefore(d,r.firstChild)}},goog.module.ModuleLoader.prototype.handleError_=function(o,e,t){var r=this.loadingModulesStatus_[e];r&&(delete this.loadingModulesStatus_[e],this.handleErrorHelper_(e,r.errorFn,t.status)),goog.Timer.callOnce(o.dispose,5,o)},goog.module.ModuleLoader.prototype.handleErrorHelper_=function(o,e,t,r){this.dispatchEvent(new goog.module.ModuleLoader.RequestErrorEvent(o,t,r)),goog.log.warning(this.logger,"Request failed for module(s): "+o),e&&e(t)},goog.module.ModuleLoader.EventType={EVALUATE_CODE:new goog.events.EventId(goog.events.getUniqueId("evaluateCode")),REQUEST_SUCCESS:new goog.events.EventId(goog.events.getUniqueId("requestSuccess")),REQUEST_ERROR:new goog.events.EventId(goog.events.getUniqueId("requestError"))},goog.module.ModuleLoader.EvaluateCodeEvent=function(o){goog.module.ModuleLoader.EvaluateCodeEvent.base(this,"constructor",goog.module.ModuleLoader.EventType.EVALUATE_CODE),this.moduleIds=o},goog.inherits(goog.module.ModuleLoader.EvaluateCodeEvent,goog.events.Event),goog.module.ModuleLoader.RequestSuccessEvent=function(o){goog.module.ModuleLoader.RequestSuccessEvent.base(this,"constructor",goog.module.ModuleLoader.EventType.REQUEST_SUCCESS),this.moduleIds=o},goog.inherits(goog.module.ModuleLoader.RequestSuccessEvent,goog.events.Event),goog.module.ModuleLoader.RequestErrorEvent=function(o,e,t){goog.module.ModuleLoader.RequestErrorEvent.base(this,"constructor",goog.module.ModuleLoader.EventType.REQUEST_ERROR),this.moduleIds=o,this.status=e,this.error=t||null},goog.inherits(goog.module.ModuleLoader.RequestErrorEvent,goog.events.Event),goog.module.ModuleLoader.LoadStatus=function(o){this.requestUris=goog.array.map(o,goog.html.TrustedResourceUrl.unwrap),this.trustedRequestUris=o,this.responseTexts=null,this.loadRequested=!1,this.successFn=null,this.errorFn=null},goog.module.ModuleLoader.LoadStatus.createForIds_=function(o,e){if(!o)return new goog.module.ModuleLoader.LoadStatus([]);const t=[];for(var r=0;r<o.length;r++)goog.array.extend(t,e[o[r]].getUris());return new goog.module.ModuleLoader.LoadStatus(t)};