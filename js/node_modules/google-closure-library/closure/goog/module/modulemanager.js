goog.provide("goog.module.ModuleManager"),goog.provide("goog.module.ModuleManager.CallbackType"),goog.provide("goog.module.ModuleManager.FailureType"),goog.require("goog.array"),goog.require("goog.asserts"),goog.require("goog.async.Deferred"),goog.require("goog.debug.Trace"),goog.require("goog.disposable.IDisposable"),goog.require("goog.disposeAll"),goog.require("goog.loader.AbstractModuleManager"),goog.require("goog.loader.activeModuleManager"),goog.require("goog.log"),goog.require("goog.module"),goog.require("goog.module.ModuleInfo"),goog.require("goog.module.ModuleLoadCallback"),goog.require("goog.object"),goog.module.ModuleManager=function(){goog.module.ModuleManager.base(this,"constructor"),this.moduleInfoMap={},this.loadingModuleIds_=[],this.requestedLoadingModuleIds_=[],this.requestedModuleIds_=[],this.requestedModuleIdsQueue_=[],this.userInitiatedLoadingModuleIds_=[],this.callbackMap_={},this.baseModuleInfo_=new goog.module.ModuleInfo([],""),this.currentlyLoadingModule_=this.baseModuleInfo_,this.lastInitialModuleId_=null,this.initialModulesLoaded_=new goog.async.Deferred,this.logger_=goog.log.getLogger("goog.module.ModuleManager"),this.batchModeEnabled_=!1,this.concurrentLoadingEnabled_=!1,this.loadTracer_=null,this.consecutiveFailures_=0,this.lastActive_=!1,this.userLastActive_=!1,this.isDisposed_=!1},goog.inherits(goog.module.ModuleManager,goog.loader.AbstractModuleManager),goog.module.ModuleManager.CallbackType=goog.loader.AbstractModuleManager.CallbackType,goog.module.ModuleManager.FailureType=goog.loader.AbstractModuleManager.FailureType,goog.module.ModuleManager.CORRUPT_RESPONSE_STATUS_CODE=goog.loader.AbstractModuleManager.CORRUPT_RESPONSE_STATUS_CODE,goog.module.ModuleManager.getInstance=function(){return goog.loader.activeModuleManager.get()},goog.module.ModuleManager.prototype.setBatchModeEnabled=function(e){this.batchModeEnabled_=e},goog.module.ModuleManager.prototype.setConcurrentLoadingEnabled=function(e){this.concurrentLoadingEnabled_=e},goog.module.ModuleManager.prototype.setAllModuleInfo=function(e){for(var o in e)this.moduleInfoMap[o]=new goog.module.ModuleInfo(e[o],o);this.initialModulesLoaded_.hasFired()||this.initialModulesLoaded_.callback(),this.maybeFinishBaseLoad_()},goog.module.ModuleManager.prototype.setAllModuleInfoString=function(e,o){if(this instanceof goog.module.ModuleManager){if("string"==typeof e){for(var t=e.split("/"),d=[],a=0;a<t.length;a++){var l,i=t[a].split(":"),r=i[0];if(i[1]){l=i[1].split(",");for(var g=0;g<l.length;g++){var s=parseInt(l[g],36);goog.asserts.assert(d[s],"No module @ %s, dep of %s @ %s",s,r,a),l[g]=d[s]}}else l=[];d.push(r),this.moduleInfoMap[r]=new goog.module.ModuleInfo(l,r)}o&&o.length?(goog.array.extend(this.loadingModuleIds_,o),this.lastInitialModuleId_=goog.array.peek(o)):this.initialModulesLoaded_.hasFired()||this.initialModulesLoaded_.callback(),this.maybeFinishBaseLoad_()}}else this.setAllModuleInfoString(e,o)},goog.module.ModuleManager.prototype.getModuleInfo=function(e){return this.moduleInfoMap[e]},goog.module.ModuleManager.prototype.setModuleTrustedUris=function(e){for(var o in e)this.moduleInfoMap[o].setTrustedUris(e[o])},goog.module.ModuleManager.prototype.setModuleContext=function(e){goog.module.ModuleManager.base(this,"setModuleContext",e),this.maybeFinishBaseLoad_()},goog.module.ModuleManager.prototype.isActive=function(){return this.loadingModuleIds_.length>0},goog.module.ModuleManager.prototype.isUserActive=function(){return this.userInitiatedLoadingModuleIds_.length>0},goog.module.ModuleManager.prototype.dispatchActiveIdleChangeIfNeeded_=function(){var e=this.lastActive_,o=this.isActive();o!=e&&(this.executeCallbacks_(o?goog.loader.AbstractModuleManager.CallbackType.ACTIVE:goog.loader.AbstractModuleManager.CallbackType.IDLE),this.lastActive_=o);var t=this.userLastActive_,d=this.isUserActive();d!=t&&(this.executeCallbacks_(d?goog.loader.AbstractModuleManager.CallbackType.USER_ACTIVE:goog.loader.AbstractModuleManager.CallbackType.USER_IDLE),this.userLastActive_=d)},goog.module.ModuleManager.prototype.preloadModule=function(e,o){var t=new goog.async.Deferred;return window.setTimeout(goog.bind(this.addLoadModule_,this,e,t),o||0),t},goog.module.ModuleManager.prototype.prefetchModule=function(e){if(this.getModuleInfo(e).isLoaded()||this.isModuleLoading(e))throw new Error("Module load already requested: "+e);if(this.batchModeEnabled_)throw new Error("Modules prefetching is not supported in batch mode");for(var o=this.getNotYetLoadedTransitiveDepIds_(e),t=0;t<o.length;t++)this.getLoader().prefetchModule(o[t],this.moduleInfoMap[o[t]])},goog.module.ModuleManager.prototype.addLoadModule_=function(e,o){var t=this.getModuleInfo(e);t.isLoaded()?o.callback(this.getModuleContext()):(this.registerModuleLoadCallbacks_(e,t,!1,o),this.isModuleLoading(e)||this.loadModulesOrEnqueue_([e]))},goog.module.ModuleManager.prototype.loadModulesOrEnqueueIfNotLoadedOrLoading_=function(e,o){var t=[];goog.array.removeDuplicates(e,t);for(var d=[],a={},l=0;l<t.length;l++){var i=t[l],r=this.getModuleInfo(i);if(!r)throw new Error("Unknown module: "+i);var g=new goog.async.Deferred;a[i]=g,r.isLoaded()?g.callback(this.getModuleContext()):(this.registerModuleLoadCallbacks_(i,r,!!o,g),this.isModuleLoading(i)||d.push(i))}return d.length>0&&this.loadModulesOrEnqueue_(d),a},goog.module.ModuleManager.prototype.registerModuleLoadCallbacks_=function(e,o,t,d){o.registerCallback(d.callback,d),o.registerErrback(function(e){d.errback(Error(e))}),this.isModuleLoading(e)?t&&(goog.log.fine(this.logger_,"User initiated module already loading: "+e),this.addUserInitiatedLoadingModule_(e),this.dispatchActiveIdleChangeIfNeeded_()):t?(goog.log.fine(this.logger_,"User initiated module load: "+e),this.addUserInitiatedLoadingModule_(e)):goog.log.fine(this.logger_,"Initiating module load: "+e)},goog.module.ModuleManager.prototype.loadModulesOrEnqueue_=function(e){this.concurrentLoadingEnabled_?this.initialModulesLoaded_.addCallback(goog.bind(this.loadModules_,this,e)):goog.array.isEmpty(this.loadingModuleIds_)?this.loadModules_(e):(this.requestedModuleIdsQueue_.push(e),this.dispatchActiveIdleChangeIfNeeded_())},goog.module.ModuleManager.prototype.getBackOff_=function(){return 5e3*Math.pow(this.consecutiveFailures_,2)},goog.module.ModuleManager.prototype.loadModules_=function(e,o,t){o||(this.consecutiveFailures_=0);var d=this.processModulesForLoad_(e);if(goog.log.fine(this.logger_,"Loading module(s): "+d),this.concurrentLoadingEnabled_?goog.array.extend(this.loadingModuleIds_,d):this.loadingModuleIds_=d,this.batchModeEnabled_?this.requestedLoadingModuleIds_=e:this.requestedLoadingModuleIds_=goog.array.clone(d),this.dispatchActiveIdleChangeIfNeeded_(),!goog.array.isEmpty(d)){this.requestedModuleIds_.push.apply(this.requestedModuleIds_,d);var a=goog.bind(this.getLoader().loadModules,goog.asserts.assert(this.getLoader()),goog.array.clone(d),goog.asserts.assert(this.moduleInfoMap),null,goog.bind(this.handleLoadError_,this,this.requestedLoadingModuleIds_,d),goog.bind(this.handleLoadTimeout_,this),!!t),l=this.getBackOff_();l?window.setTimeout(a,l):a()}},goog.module.ModuleManager.prototype.processModulesForLoad_=function(e){e=goog.array.filter(e,e=>!this.moduleInfoMap[e].isLoaded()||(goog.global.setTimeout(()=>new Error("Module already loaded: "+e),0),!1));for(var o=[],t=0;t<e.length;t++)o=o.concat(this.getNotYetLoadedTransitiveDepIds_(e[t]));if(goog.array.removeDuplicates(o),!this.batchModeEnabled_&&o.length>1){var d=o.shift();goog.log.fine(this.logger_,"Must load "+d+" module before "+e);var a=goog.array.map(o,function(e){return[e]});return this.requestedModuleIdsQueue_=a.concat(this.requestedModuleIdsQueue_),[d]}return o},goog.module.ModuleManager.prototype.getNotYetLoadedTransitiveDepIds_=function(e){var o=goog.object.createSet(this.requestedModuleIds_),t=[];o[e]||t.push(e);for(var d=[e],a=0;a<d.length;a++)for(var l=this.getModuleInfo(d[a]).getDependencies(),i=l.length-1;i>=0;i--){var r=l[i];this.getModuleInfo(r).isLoaded()||o[r]||(t.push(r),d.push(r))}return t.reverse(),goog.array.removeDuplicates(t),t},goog.module.ModuleManager.prototype.maybeFinishBaseLoad_=function(){this.currentlyLoadingModule_==this.baseModuleInfo_&&(this.currentlyLoadingModule_=null,this.baseModuleInfo_.onLoad(goog.bind(this.getModuleContext,this))&&this.dispatchModuleLoadFailed_(goog.loader.AbstractModuleManager.FailureType.INIT_ERROR),this.dispatchActiveIdleChangeIfNeeded_())},goog.module.ModuleManager.prototype.setLoaded=function(){if(this.currentlyLoadingModule_){var e=this.currentlyLoadingModule_.getId();if(this.isDisposed())goog.log.warning(this.logger_,"Module loaded after module manager was disposed: "+e);else goog.log.fine(this.logger_,"Module loaded: "+e),this.moduleInfoMap[e].onLoad(goog.bind(this.getModuleContext,this))&&this.dispatchModuleLoadFailed_(goog.loader.AbstractModuleManager.FailureType.INIT_ERROR),goog.array.remove(this.userInitiatedLoadingModuleIds_,e),goog.array.remove(this.loadingModuleIds_,e),goog.array.isEmpty(this.loadingModuleIds_)&&this.loadNextModules_(),this.lastInitialModuleId_&&e==this.lastInitialModuleId_&&(this.initialModulesLoaded_.hasFired()||this.initialModulesLoaded_.callback()),this.dispatchActiveIdleChangeIfNeeded_(),this.currentlyLoadingModule_=null,goog.debug.Trace.stopTracer(this.loadTracer_)}else goog.log.error(this.logger_,"setLoaded called while no module is actively loading")},goog.module.ModuleManager.prototype.isModuleLoading=function(e){if(goog.array.contains(this.loadingModuleIds_,e))return!0;for(var o=0;o<this.requestedModuleIdsQueue_.length;o++)if(goog.array.contains(this.requestedModuleIdsQueue_[o],e))return!0;return!1},goog.module.ModuleManager.prototype.execOnLoad=function(e,o,t,d,a,l){var i,r=this.moduleInfoMap[e];return r.isLoaded()?(goog.log.fine(this.logger_,e+" module already loaded"),i=new goog.module.ModuleLoadCallback(o,t),l?i.execute(this.getModuleContext()):window.setTimeout(goog.bind(i.execute,i),0)):this.isModuleLoading(e)?(goog.log.fine(this.logger_,e+" module already loading"),i=r.registerCallback(o,t),a&&(goog.log.fine(this.logger_,"User initiated module already loading: "+e),this.addUserInitiatedLoadingModule_(e),this.dispatchActiveIdleChangeIfNeeded_())):(goog.log.fine(this.logger_,"Registering callback for module: "+e),i=r.registerCallback(o,t),d||(a&&(goog.log.fine(this.logger_,"User initiated module load: "+e),this.addUserInitiatedLoadingModule_(e)),goog.log.fine(this.logger_,"Initiating module load: "+e),this.loadModulesOrEnqueue_([e]))),i},goog.module.ModuleManager.prototype.load=function(e,o){return this.loadModulesOrEnqueueIfNotLoadedOrLoading_([e],o)[e]},goog.module.ModuleManager.prototype.loadMultiple=function(e,o){return this.loadModulesOrEnqueueIfNotLoadedOrLoading_(e,o)},goog.module.ModuleManager.prototype.addUserInitiatedLoadingModule_=function(e){goog.array.contains(this.userInitiatedLoadingModuleIds_,e)||this.userInitiatedLoadingModuleIds_.push(e)},goog.module.ModuleManager.prototype.beforeLoadModuleCode=function(e){this.loadTracer_=goog.debug.Trace.startTracer("Module Load: "+e,"Module Load"),this.currentlyLoadingModule_&&goog.log.error(this.logger_,'beforeLoadModuleCode called with module "'+e+'" while module "'+this.currentlyLoadingModule_.getId()+'" is loading'),this.currentlyLoadingModule_=this.getModuleInfo(e)},goog.module.ModuleManager.prototype.registerInitializationCallback=function(e,o){this.currentlyLoadingModule_?this.currentlyLoadingModule_.registerEarlyCallback(e,o):goog.log.error(this.logger_,"No module is currently loading")},goog.module.ModuleManager.prototype.registerLateInitializationCallback=function(e,o){this.currentlyLoadingModule_?this.currentlyLoadingModule_.registerCallback(e,o):goog.log.error(this.logger_,"No module is currently loading")},goog.module.ModuleManager.prototype.setModuleConstructor=function(e){this.currentlyLoadingModule_?this.currentlyLoadingModule_.setModuleConstructor(e):goog.log.error(this.logger_,"No module is currently loading")},goog.module.ModuleManager.prototype.handleLoadError_=function(e,o,t){if(this.consecutiveFailures_++,this.requestedLoadingModuleIds_=e,goog.array.forEach(o,goog.partial(goog.array.remove,this.requestedModuleIds_),this),401==t)goog.log.info(this.logger_,"Module loading unauthorized"),this.dispatchModuleLoadFailed_(goog.loader.AbstractModuleManager.FailureType.UNAUTHORIZED),this.requestedModuleIdsQueue_.length=0;else if(410==t)this.requeueBatchOrDispatchFailure_(goog.loader.AbstractModuleManager.FailureType.OLD_CODE_GONE),this.loadNextModules_();else if(this.consecutiveFailures_>=3)goog.log.info(this.logger_,"Aborting after failure to load: "+this.loadingModuleIds_),this.requeueBatchOrDispatchFailure_(goog.loader.AbstractModuleManager.FailureType.CONSECUTIVE_FAILURES),this.loadNextModules_();else{goog.log.info(this.logger_,"Retrying after failure to load: "+this.loadingModuleIds_);var d=t==goog.loader.AbstractModuleManager.CORRUPT_RESPONSE_STATUS_CODE;this.loadModules_(this.requestedLoadingModuleIds_,!0,d)}},goog.module.ModuleManager.prototype.handleLoadTimeout_=function(){goog.log.info(this.logger_,"Aborting after timeout: "+this.loadingModuleIds_),this.requeueBatchOrDispatchFailure_(goog.loader.AbstractModuleManager.FailureType.TIMEOUT),this.loadNextModules_()},goog.module.ModuleManager.prototype.requeueBatchOrDispatchFailure_=function(e){if(this.requestedLoadingModuleIds_.length>1){var o=goog.array.map(this.requestedLoadingModuleIds_,function(e){return[e]});this.requestedModuleIdsQueue_=o.concat(this.requestedModuleIdsQueue_)}else this.dispatchModuleLoadFailed_(e)},goog.module.ModuleManager.prototype.dispatchModuleLoadFailed_=function(e){var o=this.requestedLoadingModuleIds_;this.loadingModuleIds_.length=0;for(var t=[],d=0;d<this.requestedModuleIdsQueue_.length;d++){var a=goog.array.filter(this.requestedModuleIdsQueue_[d],function(e){var t=this.getNotYetLoadedTransitiveDepIds_(e);return goog.array.some(o,function(e){return goog.array.contains(t,e)})},this);goog.array.extend(t,a)}for(d=0;d<o.length;d++)goog.array.insert(t,o[d]);for(d=0;d<t.length;d++){for(var l=0;l<this.requestedModuleIdsQueue_.length;l++)goog.array.remove(this.requestedModuleIdsQueue_[l],t[d]);goog.array.remove(this.userInitiatedLoadingModuleIds_,t[d])}var i=this.callbackMap_[goog.loader.AbstractModuleManager.CallbackType.ERROR];if(i)for(d=0;d<i.length;d++){var r=i[d];for(l=0;l<t.length;l++)r(goog.loader.AbstractModuleManager.CallbackType.ERROR,t[l],e)}for(d=0;d<o.length;d++)this.moduleInfoMap[o[d]]&&this.moduleInfoMap[o[d]].onError(e);this.requestedLoadingModuleIds_.length=0,this.dispatchActiveIdleChangeIfNeeded_()},goog.module.ModuleManager.prototype.loadNextModules_=function(){for(;this.requestedModuleIdsQueue_.length;){var e=goog.array.filter(this.requestedModuleIdsQueue_.shift(),function(e){return!this.getModuleInfo(e).isLoaded()},this);if(e.length>0)return void this.loadModules_(e)}this.dispatchActiveIdleChangeIfNeeded_()},goog.module.ModuleManager.prototype.registerCallback=function(e,o){goog.isArray(e)||(e=[e]);for(var t=0;t<e.length;t++)this.registerCallback_(e[t],o)},goog.module.ModuleManager.prototype.registerCallback_=function(e,o){var t=this.callbackMap_;t[e]||(t[e]=[]),t[e].push(o)},goog.module.ModuleManager.prototype.executeCallbacks_=function(e){for(var o=this.callbackMap_[e],t=0;o&&t<o.length;t++)o[t](e)},goog.module.ModuleManager.prototype.dispose=function(){goog.disposeAll(goog.object.getValues(this.moduleInfoMap),this.baseModuleInfo_),this.moduleInfoMap={},this.loadingModuleIds_=[],this.requestedLoadingModuleIds_=[],this.userInitiatedLoadingModuleIds_=[],this.requestedModuleIdsQueue_=[],this.callbackMap_={},this.isDisposed_=!0},goog.module.ModuleManager.prototype.isDisposed=function(){return this.isDisposed_},goog.loader.activeModuleManager.setDefault(function(){return new goog.module.ModuleManager});