goog.setTestOnly("goog.testing.MockClock"),goog.provide("goog.testing.MockClock"),goog.require("goog.Disposable"),goog.require("goog.Promise"),goog.require("goog.Thenable"),goog.require("goog.async.run"),goog.require("goog.testing.PropertyReplacer"),goog.require("goog.testing.events"),goog.require("goog.testing.events.Event"),goog.testing.MockClock=function(o){goog.Disposable.call(this),this.queue_=[],this.deletedKeys_={},this.unmockDateNow_=!1,o&&this.install()},goog.inherits(goog.testing.MockClock,goog.Disposable),goog.testing.MockClock.QueueObjType_,goog.testing.MockClock.REQUEST_ANIMATION_FRAME_TIMEOUT=20,goog.testing.MockClock.nextId=Math.round(1e4*Math.random()),goog.testing.MockClock.prototype.timeoutsMade_=0,goog.testing.MockClock.prototype.callbacksTriggered_=0,goog.testing.MockClock.prototype.replacer_=null,goog.testing.MockClock.prototype.nowMillis_=0,goog.testing.MockClock.prototype.timeoutDelay_=0,goog.testing.MockClock.REAL_SETTIMEOUT_=goog.global.setTimeout,goog.testing.MockClock.prototype.oldGoogNow_,goog.testing.MockClock.prototype.install=function(){if(!this.replacer_){goog.testing.MockClock.REAL_SETTIMEOUT_!==goog.global.setTimeout&&"undefined"!=typeof console&&console.warn&&console.warn("Non default setTimeout detected. Use of multiple MockClock instances or other clock mocking should be avoided due to unspecified behavior and the resulting fragility.");var o=this.replacer_=new goog.testing.PropertyReplacer;o.set(goog.global,"setTimeout",goog.bind(this.setTimeout_,this)),o.set(goog.global,"setInterval",goog.bind(this.setInterval_,this)),o.set(goog.global,"setImmediate",goog.bind(this.setImmediate_,this)),o.set(goog.global,"clearTimeout",goog.bind(this.clearTimeout_,this)),o.set(goog.global,"clearInterval",goog.bind(this.clearInterval_,this)),this.unmockDateNow_||o.set(Date,"now",goog.bind(this.getCurrentTime,this)),goog.async.run.forceNextTick&&goog.async.run.forceNextTick(goog.testing.MockClock.REAL_SETTIMEOUT_),this.replaceRequestAnimationFrame_(),this.oldGoogNow_=goog.now,goog.now=goog.bind(this.getCurrentTime,this)}},goog.testing.MockClock.prototype.unmockDateNow=function(){if(this.unmockDateNow_=!0,this.replacer_)try{this.replacer_.restore(Date,"now")}catch(o){}},goog.testing.MockClock.prototype.replaceRequestAnimationFrame_=function(){for(var o=this.replacer_,t=["requestAnimationFrame","webkitRequestAnimationFrame","mozRequestAnimationFrame","oRequestAnimationFrame","msRequestAnimationFrame"],e=["cancelAnimationFrame","cancelRequestAnimationFrame","webkitCancelRequestAnimationFrame","mozCancelRequestAnimationFrame","oCancelRequestAnimationFrame","msCancelRequestAnimationFrame"],i=0;i<t.length;++i)goog.global&&goog.global[t[i]]&&o.set(goog.global,t[i],goog.bind(this.requestAnimationFrame_,this));for(i=0;i<e.length;++i)goog.global&&goog.global[e[i]]&&o.set(goog.global,e[i],goog.bind(this.cancelRequestAnimationFrame_,this))},goog.testing.MockClock.prototype.uninstall=function(){this.replacer_&&(this.replacer_.reset(),this.replacer_=null,goog.now=this.oldGoogNow_),this.resetAsyncQueue_()},goog.testing.MockClock.prototype.disposeInternal=function(){this.uninstall(),this.queue_=null,this.deletedKeys_=null,goog.testing.MockClock.superClass_.disposeInternal.call(this)},goog.testing.MockClock.prototype.reset=function(){this.queue_=[],this.deletedKeys_={},this.nowMillis_=0,this.timeoutsMade_=0,this.callbacksTriggered_=0,this.timeoutDelay_=0,this.resetAsyncQueue_()},goog.testing.MockClock.prototype.resetAsyncQueue_=function(){goog.async.run.resetQueue()},goog.testing.MockClock.prototype.setTimeoutDelay=function(o){this.timeoutDelay_=o},goog.testing.MockClock.prototype.getTimeoutDelay=function(){return this.timeoutDelay_},goog.testing.MockClock.prototype.tick=function(o){"number"!=typeof o&&(o=1);var t=this.nowMillis_+o;return this.runFunctionsWithinRange_(t),this.nowMillis_=t,t},goog.testing.MockClock.prototype.tickPromise=function(o,t){var e,i,g=!1;if(o.then(function(o){e=o,g=!0},function(o){i=o,g=!0}),this.tick(t),!g)throw new Error("Promise was expected to be resolved after mock clock tick.");if(i)throw i;return e},goog.testing.MockClock.prototype.getTimeoutsMade=function(){return this.timeoutsMade_},goog.testing.MockClock.prototype.getCallbacksTriggered=function(){return this.callbacksTriggered_},goog.testing.MockClock.prototype.getCurrentTime=function(){return this.nowMillis_},goog.testing.MockClock.prototype.isTimeoutSet=function(o){return o<goog.testing.MockClock.nextId&&o>=goog.testing.MockClock.nextId-this.timeoutsMade_&&!this.deletedKeys_[o]},goog.testing.MockClock.prototype.runFunctionsWithinRange_=function(o){for(var t=o-this.timeoutDelay_;this.queue_&&this.queue_.length&&this.queue_[this.queue_.length-1].runAtMillis<=t;){var e=this.queue_.pop();e.timeoutKey in this.deletedKeys_||(this.nowMillis_=Math.max(this.nowMillis_,e.runAtMillis+this.timeoutDelay_),this.callbacksTriggered_++,e.funcToCall.call(goog.global,e.timeoutKey),e.recurring&&this.scheduleFunction_(e.timeoutKey,e.funcToCall,e.millis,!0))}},goog.testing.MockClock.prototype.scheduleFunction_=function(o,t,e,i){if(!goog.isFunction(t))throw new TypeError("The provided callback must be a function, not a "+typeof t);var g={runAtMillis:this.nowMillis_+e,funcToCall:t,recurring:i,timeoutKey:o,millis:e};goog.testing.MockClock.insert_(g,this.queue_)},goog.testing.MockClock.insert_=function(o,t){for(var e=t.length;0!=e&&!(t[e-1].runAtMillis>o.runAtMillis);e--)t[e]=t[e-1];t[e]=o},goog.testing.MockClock.MAX_INT_=2147483647,goog.testing.MockClock.prototype.setTimeout_=function(o,t){var e=t||0;if(e>goog.testing.MockClock.MAX_INT_)throw new Error("Bad timeout value: "+e+".  Timeouts over MAX_INT (24.8 days) cause timeouts to be fired immediately in most browsers, except for IE.");return this.timeoutsMade_++,this.scheduleFunction_(goog.testing.MockClock.nextId,o,e,!1),goog.testing.MockClock.nextId++},goog.testing.MockClock.prototype.setInterval_=function(o,t){var e=t||0;return this.timeoutsMade_++,this.scheduleFunction_(goog.testing.MockClock.nextId,o,e,!0),goog.testing.MockClock.nextId++},goog.testing.MockClock.prototype.requestAnimationFrame_=function(o){return this.setTimeout_(goog.bind(function(){if(o)o(this.getCurrentTime());else if(goog.global.mozRequestAnimationFrame){var t=new goog.testing.events.Event("MozBeforePaint",goog.global);t.timeStamp=this.getCurrentTime(),goog.testing.events.fireBrowserEvent(t)}},this),goog.testing.MockClock.REQUEST_ANIMATION_FRAME_TIMEOUT)},goog.testing.MockClock.prototype.setImmediate_=function(o){return this.setTimeout_(o,0)},goog.testing.MockClock.prototype.clearTimeout_=function(o){this.isTimeoutSet(o)&&(this.deletedKeys_[o]=!0)},goog.testing.MockClock.prototype.clearInterval_=function(o){this.clearTimeout_(o)},goog.testing.MockClock.prototype.cancelRequestAnimationFrame_=function(o){this.clearTimeout_(o)};