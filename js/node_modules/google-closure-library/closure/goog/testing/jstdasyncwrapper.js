goog.provide("goog.testing.JsTdAsyncWrapper"),goog.require("goog.Promise"),goog.testing.JsTdAsyncWrapper.REAL_SET_TIMEOUT_FN_=goog.global.setTimeout,goog.testing.JsTdAsyncWrapper.REAL_SET_TIMEOUT_=function(t,e){(0,goog.testing.JsTdAsyncWrapper.REAL_SET_TIMEOUT_FN_)(t,e)},goog.testing.JsTdAsyncWrapper.convertToAsyncTestObj=function(t){var e=function(t){return function(){var e=new goog.testing.JsTdAsyncWrapper.Queue(this);return t.call(this,e),e.startExecuting()}},o={};for(var s in t)0==s.indexOf("test")||"setUp"==s||"tearDown"==s?o[s]=e(t[s]):o[s]=t[s];return o},goog.testing.JsTdAsyncWrapper.Queue=function(t){this.steps_=[],this.delegate_=null,this.testObj_=t},goog.testing.JsTdAsyncWrapper.Queue.prototype.defer=function(t,e){var o=e;e||"function"!=typeof t||(o=t,t="(Not named)"),this.delegate_?this.delegate_.defer(t,o):this.steps_.push(new goog.testing.JsTdAsyncWrapper.Step_(t,o))},goog.testing.JsTdAsyncWrapper.Queue.prototype.startExecuting=function(){return new goog.Promise(goog.bind(function(t,e){this.executeNextStep_(t,e)},this))},goog.testing.JsTdAsyncWrapper.Queue.prototype.executeNextStep_=function(t,e){if(this.steps_.length){var o=this.steps_.shift();this.delegate_=new goog.testing.JsTdAsyncWrapper.Queue(this.testObj_);var s=new goog.testing.JsTdAsyncWrapper.Pool_(this.testObj_,goog.bind(function(){goog.testing.JsTdAsyncWrapper.REAL_SET_TIMEOUT_(goog.bind(function(){this.executeDelegate_(t,e)},this),0)},this),goog.bind(function(t){this.handleError_(e,t,o.name)},this));try{o.fn.call(this.testObj_,s)}catch(t){this.handleError_(e,t,o.name)}s.maybeComplete()}else t()},goog.testing.JsTdAsyncWrapper.Queue.prototype.executeDelegate_=function(t,e){this.delegate_?this.delegate_.executeNextStep_(goog.bind(function(){this.delegate_=null,goog.testing.JsTdAsyncWrapper.REAL_SET_TIMEOUT_(goog.bind(function(){this.executeNextStep_(t,e)},this),0)},this),e):this.executeNextStep_(t,e)},goog.testing.JsTdAsyncWrapper.Queue.prototype.handleError_=function(t,e,o){var s=e instanceof Error?e:Error(e);s.message="In step "+o+", error: "+s.message,t(e)},goog.testing.JsTdAsyncWrapper.Step_=function(t,e){this.name=t,this.fn=e},goog.testing.JsTdAsyncWrapper.Pool_=function(t,e,o){this.outstandingCallbacks_=0,this.callback_=e,this.errback_=o,this.testObj_=t,this.callbackCalled_=!1},goog.testing.JsTdAsyncWrapper.Pool_.prototype.noop=function(){return this.addCallback(function(){})},goog.testing.JsTdAsyncWrapper.Pool_.prototype.addCallback=function(t,e,o,s){if(o||s)throw new Error("Setting timeout or description in a pool callback is not supported.");var n=e||1;return this.outstandingCallbacks_=this.outstandingCallbacks_+n,goog.bind(function(){try{t.apply(this.testObj_,arguments)}catch(t){s&&(t.message=s+t.message),this.errback_(t)}this.outstandingCallbacks_=this.outstandingCallbacks_-1,this.maybeComplete()},this)},goog.testing.JsTdAsyncWrapper.Pool_.prototype.add=goog.testing.JsTdAsyncWrapper.Pool_.prototype.addCallback,goog.testing.JsTdAsyncWrapper.Pool_.prototype.addErrback=function(t){return goog.bind(function(){var e=t;if(arguments.length){e+=" - Error callback called with params: ( ";for(var o=0;o<arguments.length;o++){var s=arguments[o];e+=s+" ",s instanceof Error&&(e+="\n"+s.stack+"\n")}e+=")"}this.errback_(e)},this)},goog.testing.JsTdAsyncWrapper.Pool_.prototype.maybeComplete=function(){0!=this.outstandingCallbacks_||this.callbackCalled_||(this.callbackCalled_=!0,this.callback_())};