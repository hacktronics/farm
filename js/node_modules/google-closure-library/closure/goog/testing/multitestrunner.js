goog.setTestOnly("goog.testing.MultiTestRunner"),goog.provide("goog.testing.MultiTestRunner"),goog.provide("goog.testing.MultiTestRunner.TestFrame"),goog.require("goog.Timer"),goog.require("goog.array"),goog.require("goog.asserts"),goog.require("goog.dom"),goog.require("goog.dom.TagName"),goog.require("goog.dom.classlist"),goog.require("goog.events.EventHandler"),goog.require("goog.functions"),goog.require("goog.object"),goog.require("goog.string"),goog.require("goog.testing.TestCase"),goog.require("goog.ui.Component"),goog.require("goog.ui.ServerChart"),goog.require("goog.ui.TableSorter"),goog.testing.MultiTestRunner=function(t){goog.ui.Component.call(this,t),this.allTests_=[],this.activeTests_=[],this.eh_=new goog.events.EventHandler(this),this.tableSorter_=new goog.ui.TableSorter(this.dom_),this.failureReports_=[],this.allTestResults_=[]},goog.inherits(goog.testing.MultiTestRunner,goog.ui.Component),goog.testing.MultiTestRunner.DEFAULT_TIMEOUT_MS=45e3,goog.testing.MultiTestRunner.STATES=["waiting for test runner","initializing tests","waiting for tests to finish"],goog.testing.MultiTestRunner.TESTS_FINISHED="testsFinished",goog.testing.MultiTestRunner.prototype.name_="",goog.testing.MultiTestRunner.prototype.basePath_="",goog.testing.MultiTestRunner.prototype.finished_=null,goog.testing.MultiTestRunner.prototype.verbosePasses_=!1,goog.testing.MultiTestRunner.prototype.hidePasses_=!1,goog.testing.MultiTestRunner.prototype.stopped_=!1,goog.testing.MultiTestRunner.prototype.active_=!1,goog.testing.MultiTestRunner.prototype.startedCount_=0,goog.testing.MultiTestRunner.prototype.resultCount_=0,goog.testing.MultiTestRunner.prototype.passes_=0,goog.testing.MultiTestRunner.prototype.startTime_=0,goog.testing.MultiTestRunner.prototype.filterFn_=goog.functions.TRUE,goog.testing.MultiTestRunner.prototype.timeoutMs_=goog.testing.MultiTestRunner.DEFAULT_TIMEOUT_MS,goog.testing.MultiTestRunner.StatsType_,goog.testing.MultiTestRunner.prototype.stats_=null,goog.testing.MultiTestRunner.prototype.startButtonEl_=null,goog.testing.MultiTestRunner.prototype.stopButtonEl_=null,goog.testing.MultiTestRunner.prototype.logEl_=null,goog.testing.MultiTestRunner.prototype.reportEl_=null,goog.testing.MultiTestRunner.prototype.statsEl_=null,goog.testing.MultiTestRunner.prototype.progressEl_=null,goog.testing.MultiTestRunner.prototype.progressRow_=null,goog.testing.MultiTestRunner.prototype.logTabEl_=null,goog.testing.MultiTestRunner.prototype.reportTabEl_=null,goog.testing.MultiTestRunner.prototype.statsTabEl_=null,goog.testing.MultiTestRunner.prototype.poolSize_=1,goog.testing.MultiTestRunner.prototype.numFilesStatsBucketSize_=20,goog.testing.MultiTestRunner.prototype.runTimeStatsBucketSize_=500,goog.testing.MultiTestRunner.prototype.setName=function(t){return this.name_=t,this},goog.testing.MultiTestRunner.prototype.getName=function(){return this.name_},goog.testing.MultiTestRunner.prototype.setBasePath=function(t){return this.basePath_=t,this},goog.testing.MultiTestRunner.prototype.getBasePath=function(){return this.basePath_},goog.testing.MultiTestRunner.prototype.setVerbosePasses=function(t){return this.verbosePasses_=t,this},goog.testing.MultiTestRunner.prototype.getVerbosePasses=function(){return this.verbosePasses_},goog.testing.MultiTestRunner.prototype.setHidePasses=function(t){return this.hidePasses_=t,this},goog.testing.MultiTestRunner.prototype.getHidePasses=function(){return this.hidePasses_},goog.testing.MultiTestRunner.prototype.setStatsBucketSizes=function(t,e){return this.numFilesStatsBucketSize_=t,this.runTimeStatsBucketSize_=e,this},goog.testing.MultiTestRunner.prototype.setTimeout=function(t){return this.timeoutMs_=t,this},goog.testing.MultiTestRunner.prototype.getTimeout=function(){return this.timeoutMs_},goog.testing.MultiTestRunner.prototype.setPoolSize=function(t){return this.poolSize_=t,this},goog.testing.MultiTestRunner.prototype.getPoolSize=function(){return this.poolSize_},goog.testing.MultiTestRunner.prototype.setFilterFunction=function(t){return this.filterFn_=t,this},goog.testing.MultiTestRunner.prototype.getFilterFunction=function(){return this.filterFn_},goog.testing.MultiTestRunner.prototype.addTests=function(t){return goog.array.extend(this.allTests_,t),this},goog.testing.MultiTestRunner.prototype.getAllTests=function(){return this.allTests_},goog.testing.MultiTestRunner.prototype.getTestsToRun=function(){return goog.array.filter(this.allTests_,this.filterFn_)},goog.testing.MultiTestRunner.prototype.getTestsThatFailed=function(){var t=this.stats_,e=[];if(t)for(var s,o=0;s=t[o];o++)s.success||e.push(s.testFile);return e},goog.testing.MultiTestRunner.prototype.getFailureReports=function(){return this.failureReports_},goog.testing.MultiTestRunner.prototype.getAllTestResults=function(){return this.allTestResults_},goog.testing.MultiTestRunner.prototype.resetProgressDom_=function(){goog.dom.removeChildren(this.progressEl_);var t=this.dom_.createDom(goog.dom.TagName.TABLE),e=this.dom_.createDom(goog.dom.TagName.TBODY);this.progressRow_=this.dom_.createDom(goog.dom.TagName.TR);for(var s=0;s<this.activeTests_.length;s++){var o=this.dom_.createDom(goog.dom.TagName.TD);this.progressRow_.appendChild(o)}e.appendChild(this.progressRow_),t.appendChild(e),this.progressEl_.appendChild(t)},goog.testing.MultiTestRunner.prototype.createDom=function(){goog.testing.MultiTestRunner.superClass_.createDom.call(this);var t=this.getElement();t.className=goog.getCssName("goog-testrunner"),this.progressEl_=this.dom_.createDom(goog.dom.TagName.DIV),this.progressEl_.className=goog.getCssName("goog-testrunner-progress"),t.appendChild(this.progressEl_);var e=this.dom_.createDom(goog.dom.TagName.DIV);e.className=goog.getCssName("goog-testrunner-buttons"),this.startButtonEl_=this.dom_.createDom(goog.dom.TagName.BUTTON,null,"Start"),this.stopButtonEl_=this.dom_.createDom(goog.dom.TagName.BUTTON,{disabled:!0},"Stop"),e.appendChild(this.startButtonEl_),e.appendChild(this.stopButtonEl_),t.appendChild(e),this.eh_.listen(this.startButtonEl_,"click",this.onStartClicked_),this.eh_.listen(this.stopButtonEl_,"click",this.onStopClicked_),this.logEl_=this.dom_.createElement(goog.dom.TagName.DIV),this.logEl_.className=goog.getCssName("goog-testrunner-log"),t.appendChild(this.logEl_),this.reportEl_=this.dom_.createElement(goog.dom.TagName.DIV),this.reportEl_.className=goog.getCssName("goog-testrunner-report"),this.reportEl_.style.display="none",t.appendChild(this.reportEl_),this.statsEl_=this.dom_.createElement(goog.dom.TagName.DIV),this.statsEl_.className=goog.getCssName("goog-testrunner-stats"),this.statsEl_.style.display="none",t.appendChild(this.statsEl_),this.logTabEl_=this.dom_.createDom(goog.dom.TagName.DIV,null,"Log"),this.logTabEl_.className=goog.getCssName("goog-testrunner-logtab")+" "+goog.getCssName("goog-testrunner-activetab"),t.appendChild(this.logTabEl_),this.reportTabEl_=this.dom_.createDom(goog.dom.TagName.DIV,null,"Report"),this.reportTabEl_.className=goog.getCssName("goog-testrunner-reporttab"),t.appendChild(this.reportTabEl_),this.statsTabEl_=this.dom_.createDom(goog.dom.TagName.DIV,null,"Stats"),this.statsTabEl_.className=goog.getCssName("goog-testrunner-statstab"),t.appendChild(this.statsTabEl_),this.eh_.listen(this.logTabEl_,"click",this.onLogTabClicked_),this.eh_.listen(this.reportTabEl_,"click",this.onReportTabClicked_),this.eh_.listen(this.statsTabEl_,"click",this.onStatsTabClicked_)},goog.testing.MultiTestRunner.prototype.disposeInternal=function(){goog.testing.MultiTestRunner.superClass_.disposeInternal.call(this),this.tableSorter_.dispose(),this.eh_.dispose(),this.startButtonEl_=null,this.stopButtonEl_=null,this.logEl_=null,this.reportEl_=null,this.progressEl_=null,this.logTabEl_=null,this.reportTabEl_=null,this.statsTabEl_=null,this.statsEl_=null},goog.testing.MultiTestRunner.prototype.start=function(){if(this.startButtonEl_.disabled=!0,this.stopButtonEl_.disabled=!1,this.stopped_=!1,this.active_=!0,this.finished_={},this.activeTests_=this.getTestsToRun(),this.startedCount_=0,this.resultCount_=0,this.passes_=0,this.stats_=[],this.startTime_=goog.now(),this.failureReports_=[],this.resetProgressDom_(),goog.dom.removeChildren(this.logEl_),this.resetReport_(),this.clearStats_(),this.showTab_(0),0!=this.activeTests_.length){for(;this.getChildCount()>this.poolSize_;)this.removeChildAt(0,!0).dispose();for(var t=0;t<this.poolSize_;t++){if(t>=this.getChildCount()){var e=new goog.testing.MultiTestRunner.TestFrame(this.basePath_,this.timeoutMs_,this.verbosePasses_,this.dom_);this.addChild(e,!0)}this.runNextTest_(this.getChildAt(t))}}else this.finish_()},goog.testing.MultiTestRunner.prototype.log=function(t){"."!=t&&(t=this.getTimeStamp_()+" : "+t),this.logEl_.appendChild(this.dom_.createDom(goog.dom.TagName.DIV,null,t));var e=this.logEl_.scrollTop,s=this.logEl_.scrollHeight-this.logEl_.offsetHeight;(0==e||e>s-50)&&(this.logEl_.scrollTop=s)},goog.testing.MultiTestRunner.prototype.processResult=function(t){var e=t.isSuccess(),s=t.getReport(),o=t.getTestFile(),i=t.getStats();i.success||this.failureReports_.push(s),this.allTestResults_.push(t.getTestResults()),this.stats_.push(i),this.finished_[o]=!0;var n=e?"":"*** FAILURE *** ";this.log(n+this.trimFileName_(o)+" : "+(e?"Passed":"Failed")),this.resultCount_++,e&&this.passes_++,this.drawProgressSegment_(o,e),this.writeCurrentSummary_(),e&&this.hidePasses_||this.drawTestResult_(o,e,s),!this.stopped_&&this.startedCount_<this.activeTests_.length?this.runNextTest_(t):this.resultCount_==this.activeTests_.length&&this.finish_()},goog.testing.MultiTestRunner.prototype.runNextTest_=function(t){if(this.startedCount_<this.activeTests_.length){var e=this.activeTests_[this.startedCount_++];this.log(this.trimFileName_(e)+" : Loading"),t.runTest(e)}},goog.testing.MultiTestRunner.prototype.finish_=function(){for(this.stopped_?this.log("Stopped"):this.log("Finished"),this.startButtonEl_.disabled=!1,this.stopButtonEl_.disabled=!0,this.active_=!1,this.showTab_(1),this.drawStats_();this.getChildCount()>0;)this.removeChildAt(0,!0).dispose();for(var t=[],e=0;e<this.activeTests_.length;e++){var s=this.activeTests_[e];this.finished_[s]||t.push(s)}t.length&&this.reportEl_.appendChild(goog.dom.createDom(goog.dom.TagName.PRE,void 0,"These tests did not finish:\n"+t.join("\n"))),this.dispatchEvent({type:goog.testing.MultiTestRunner.TESTS_FINISHED,allTestResults:this.getAllTestResults()})},goog.testing.MultiTestRunner.prototype.resetReport_=function(){goog.dom.removeChildren(this.reportEl_);var t=this.dom_.createDom(goog.dom.TagName.DIV);t.className=goog.getCssName("goog-testrunner-progress-summary"),this.reportEl_.appendChild(t),this.writeCurrentSummary_()},goog.testing.MultiTestRunner.prototype.drawStats_=function(){this.drawFilesHistogram_(),1==this.poolSize_&&(this.drawRunTimePie_(),this.drawTimeHistogram_()),this.drawWorstTestsTable_()},goog.testing.MultiTestRunner.prototype.drawFilesHistogram_=function(){this.drawStatsHistogram_("numFilesLoaded",this.numFilesStatsBucketSize_,goog.functions.identity,500,"Histogram showing distribution of\nnumber of files loaded per test")},goog.testing.MultiTestRunner.prototype.drawTimeHistogram_=function(){this.drawStatsHistogram_("totalTime",this.runTimeStatsBucketSize_,function(t){return t/1e3},500,"Histogram showing distribution of\ntime spent running tests in s")},goog.testing.MultiTestRunner.prototype.drawStatsHistogram_=function(t,e,s,o,i){for(var n={},r=[],g=[],l=[],a=0,u=0;u<this.stats_.length;u++){var h=this.stats_[u][t],_=Math.floor(h/e)*e;_>a&&(a=_),n[_]?n[_]++:n[_]=1}var p=0;for(u=0;u<=a;u+=e){g.push(s(u));var T=n[u]||0;T>p&&(p=T),r.push(T)}var m=Math.max(1,Math.ceil(p/10));for(u=0;u<=p;u+=m)l.push(u);var d=new goog.ui.ServerChart(goog.ui.ServerChart.ChartType.VERTICAL_STACKED_BAR,o,250,null,goog.ui.ServerChart.CHART_SERVER_HTTPS_URI);d.setTitle(i),d.addDataSet(r,"ff9900"),d.setLeftLabels(l),d.setGridY(l.length-1),d.setXLabels(g),d.render(this.statsEl_)},goog.testing.MultiTestRunner.prototype.drawRunTimePie_=function(){for(var t=0,e=0,s=0;s<this.stats_.length;s++){var o=this.stats_[s];t+=o.totalTime,e+=o.runTime}var i=t-e,n=new goog.ui.ServerChart(goog.ui.ServerChart.ChartType.PIE,500,250,null,goog.ui.ServerChart.CHART_SERVER_HTTPS_URI);n.setMinValue(0),n.setMaxValue(t),n.addDataSet([e,i],"ff9900"),n.setXLabels(["Test execution ("+e+"ms)","Loading ("+i+"ms)"]),n.render(this.statsEl_)},goog.testing.MultiTestRunner.prototype.drawWorstTestsTable_=function(){this.stats_.sort(function(t,e){return e.numFilesLoaded-t.numFilesLoaded});for(var t=goog.bind(this.dom_.createDom,this.dom_,"tbody"),e=goog.bind(this.dom_.createDom,this.dom_,"thead"),s=goog.bind(this.dom_.createDom,this.dom_,"tr"),o=goog.bind(this.dom_.createDom,this.dom_,"th"),i=goog.bind(this.dom_.createDom,this.dom_,"td"),n=goog.bind(this.dom_.createDom,this.dom_,"a"),r=e({style:"cursor: pointer"},s(null,o(null," "),o(null,"Test file"),o("center","Num files loaded"),o("center","Run time (ms)"),o("center","Total time (ms)"))),g=t(),l=this.dom_.createDom(goog.dom.TagName.TABLE,null,r,g),a=0;a<this.stats_.length;a++){var u=this.stats_[a];g.appendChild(s(null,i("center",String(a+1)),i(null,n({href:this.basePath_+u.testFile,target:"_blank"},u.testFile)),i("center",String(u.numFilesLoaded)),i("center",String(u.runTime)),i("center",String(u.totalTime))))}this.statsEl_.appendChild(l),this.tableSorter_.setDefaultSortFunction(goog.ui.TableSorter.numericSort),this.tableSorter_.setSortFunction(1,goog.ui.TableSorter.alphaSort),this.tableSorter_.decorate(l)},goog.testing.MultiTestRunner.prototype.clearStats_=function(){goog.dom.removeChildren(this.statsEl_),this.tableSorter_.exitDocument()},goog.testing.MultiTestRunner.prototype.writeCurrentSummary_=function(){var t=this.activeTests_.length,e=this.resultCount_,s=this.passes_,o=e+" of "+t+" tests executed.<br>"+s+" passed, "+(e-s)+" failed.<br>Duration: "+Math.round((goog.now()-this.startTime_)/1e3)+"s.";goog.dom.getFirstElementChild(this.reportEl_).innerHTML=o},goog.testing.MultiTestRunner.prototype.drawProgressSegment_=function(t,e){var s=this.progressRow_.cells[this.resultCount_-1];s.title=t+" : "+(e?"SUCCESS":"FAILURE"),s.style.backgroundColor=e?"#090":"#900"},goog.testing.MultiTestRunner.prototype.drawTestResult_=function(t,e,s){var o=goog.string.isEmptyOrWhitespace(s)?"No report for "+t+"\n":s,i=this.dom_.createDom(goog.dom.TagName.DIV);o=goog.string.htmlEscape(o).replace(/\n/g,"<br>"),e?i.className=goog.getCssName("goog-testrunner-report-success"):(o+='<a href="'+this.basePath_+t+'">Run individually &raquo;</a><br>&nbsp;',i.className=goog.getCssName("goog-testrunner-report-failure")),i.innerHTML=o,this.reportEl_.appendChild(i)},goog.testing.MultiTestRunner.prototype.getTimeStamp_=function(){var t=new Date;return goog.string.padNumber(t.getHours(),2)+":"+goog.string.padNumber(t.getMinutes(),2)+":"+goog.string.padNumber(t.getSeconds(),2)},goog.testing.MultiTestRunner.prototype.trimFileName_=function(t){if(t.length<35)return t;for(var e=t.split("/"),s="";s.length<35&&e.length>0;)s="/"+e.pop()+s;return"..."+s},goog.testing.MultiTestRunner.prototype.showTab_=function(t){var e=goog.getCssName("goog-testrunner-activetab"),s=goog.asserts.assert(this.logTabEl_),o=goog.asserts.assert(this.reportTabEl_),i=goog.asserts.assert(this.statsTabEl_);0==t?(this.logEl_.style.display="",goog.dom.classlist.add(s,e)):(this.logEl_.style.display="none",goog.dom.classlist.remove(s,e)),1==t?(this.reportEl_.style.display="",goog.dom.classlist.add(o,e)):(this.reportEl_.style.display="none",goog.dom.classlist.remove(o,e)),2==t?(this.statsEl_.style.display="",goog.dom.classlist.add(i,e)):(this.statsEl_.style.display="none",goog.dom.classlist.remove(i,e))},goog.testing.MultiTestRunner.prototype.onStartClicked_=function(t){this.start()},goog.testing.MultiTestRunner.prototype.onStopClicked_=function(t){this.stopped_=!0,this.finish_()},goog.testing.MultiTestRunner.prototype.onLogTabClicked_=function(t){this.showTab_(0)},goog.testing.MultiTestRunner.prototype.onReportTabClicked_=function(t){this.showTab_(1)},goog.testing.MultiTestRunner.prototype.onStatsTabClicked_=function(t){this.showTab_(2)},goog.testing.MultiTestRunner.TestFrame=function(t,e,s,o){goog.ui.Component.call(this,o),this.basePath_=t,this.timeoutMs_=e,this.verbosePasses_=s,this.eh_=new goog.events.EventHandler(this),this.testResults_={}},goog.inherits(goog.testing.MultiTestRunner.TestFrame,goog.ui.Component),goog.testing.MultiTestRunner.TestFrame.prototype.iframeEl_=null,goog.testing.MultiTestRunner.TestFrame.prototype.iframeLoaded_=!1,goog.testing.MultiTestRunner.TestFrame.prototype.testFile_="",goog.testing.MultiTestRunner.TestFrame.prototype.report_="",goog.testing.MultiTestRunner.TestFrame.prototype.totalTime_=0,goog.testing.MultiTestRunner.TestFrame.prototype.runTime_=0,goog.testing.MultiTestRunner.TestFrame.prototype.numFilesLoaded_=0,goog.testing.MultiTestRunner.TestFrame.prototype.isSuccess_=null,goog.testing.MultiTestRunner.TestFrame.prototype.startTime_=0,goog.testing.MultiTestRunner.TestFrame.prototype.lastStateTime_=0,goog.testing.MultiTestRunner.TestFrame.prototype.currentState_=0,goog.testing.MultiTestRunner.TestFrame.prototype.disposeInternal=function(){goog.testing.MultiTestRunner.TestFrame.superClass_.disposeInternal.call(this),this.dom_.removeNode(this.iframeEl_),this.eh_.dispose(),this.iframeEl_=null},goog.testing.MultiTestRunner.TestFrame.prototype.runTest=function(t){this.lastStateTime_=this.startTime_=goog.now(),this.iframeEl_||this.createIframe_(),this.iframeLoaded_=!1,this.currentState_=0,this.isSuccess_=null,this.report_="",this.testResults_={},this.testFile_=t;try{this.iframeEl_.src=this.basePath_+t}catch(t){return this.report_=this.testFile_+" failed to load : "+t.message,this.isSuccess_=!1,void this.finish_()}this.checkForCompletion_()},goog.testing.MultiTestRunner.TestFrame.prototype.getTestFile=function(){return this.testFile_},goog.testing.MultiTestRunner.TestFrame.prototype.getStats=function(){return{testFile:this.testFile_,success:this.isSuccess_,runTime:this.runTime_,totalTime:this.totalTime_,numFilesLoaded:this.numFilesLoaded_}},goog.testing.MultiTestRunner.TestFrame.prototype.getReport=function(){return this.report_},goog.testing.MultiTestRunner.TestFrame.prototype.getTestResults=function(){var t={};for(var e in this.testResults_){var s=this.testFile_.replace(/\.html$/,"");e!=this.testFile_&&(s+=":"+e),t[s]=this.testResults_[e]}return t},goog.testing.MultiTestRunner.TestFrame.prototype.isSuccess=function(){return this.isSuccess_},goog.testing.MultiTestRunner.TestFrame.prototype.finish_=function(){this.totalTime_=goog.now()-this.startTime_;var t=this.getParent();t instanceof goog.testing.MultiTestRunner&&t.processResult(this)},goog.testing.MultiTestRunner.TestFrame.prototype.createIframe_=function(){this.iframeEl_=this.dom_.createDom(goog.dom.TagName.IFRAME),this.getElement().appendChild(this.iframeEl_),this.eh_.listen(this.iframeEl_,"load",this.onIframeLoaded_)},goog.testing.MultiTestRunner.TestFrame.prototype.onIframeLoaded_=function(t){this.iframeLoaded_=!0},goog.testing.MultiTestRunner.TestFrame.prototype.checkForCompletion_=function(){var t=goog.dom.getFrameContentWindow(this.iframeEl_);switch(this.currentState_){case 0:this.iframeLoaded_&&t.G_testRunner&&(this.lastStateTime_=goog.now(),this.currentState_++);break;case 1:t.G_testRunner.isInitialized()&&(this.lastStateTime_=goog.now(),this.currentState_++);break;case 2:if(t.G_testRunner.isFinished()){var e=t.G_testRunner;return this.isSuccess_=e.isSuccess(),this.report_=e.getReport(this.verbosePasses_),this.testResults_=e.getTestResults(),goog.object.isEmpty(this.testResults_)&&(this.testResults_[this.testFile_]=this.isSuccess_?[]:[{message:this.report_,source:this.testFile_,stacktrace:""}]),this.runTime_=e.getRunTime(),this.numFilesLoaded_=e.getNumFilesLoaded(),void this.finish_()}}if(goog.now()-this.lastStateTime_>this.timeoutMs_)return this.report_=this.testFile_+" timed out  "+goog.testing.MultiTestRunner.STATES[this.currentState_],this.testResults_[this.testFile_]=[{message:this.report_,source:this.testFile_,stacktrace:""}],this.isSuccess_=!1,void this.finish_();goog.Timer.callOnce(this.checkForCompletion_,100,this)};