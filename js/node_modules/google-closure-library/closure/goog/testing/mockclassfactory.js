goog.setTestOnly("goog.testing.MockClassFactory"),goog.provide("goog.testing.MockClassFactory"),goog.provide("goog.testing.MockClassRecord"),goog.require("goog.array"),goog.require("goog.object"),goog.require("goog.testing.LooseMock"),goog.require("goog.testing.StrictMock"),goog.require("goog.testing.TestCase"),goog.require("goog.testing.mockmatchers"),goog.testing.MockClassRecord=function(o,t,s,e){this.namespace_=o,this.className_=t,this.originalClass_=s,this.proxy_=e,this.instancesByArgs_=[]},goog.testing.MockClassRecord.prototype.staticMock_=null,goog.testing.MockClassRecord.prototype.getNamespace=function(){return this.namespace_},goog.testing.MockClassRecord.prototype.getClassName=function(){return this.className_},goog.testing.MockClassRecord.prototype.getOriginalClass=function(){return this.originalClass_},goog.testing.MockClassRecord.prototype.getProxy=function(){return this.proxy_},goog.testing.MockClassRecord.prototype.getStaticMock=function(){return this.staticMock_},goog.testing.MockClassRecord.prototype.setStaticMock=function(o){this.staticMock_=o},goog.testing.MockClassRecord.prototype.addMockInstance=function(o,t){this.instancesByArgs_.push({args:o,mock:t})},goog.testing.MockClassRecord.prototype.findMockInstance=function(o){for(var t=0;t<this.instancesByArgs_.length;t++){var s=this.instancesByArgs_[t].args;if(goog.testing.mockmatchers.flexibleArrayMatcher(s,o))return this.instancesByArgs_[t].mock}return null},goog.testing.MockClassRecord.prototype.reset=function(){this.namespace_[this.className_]=this.originalClass_,this.instancesByArgs_=[]},goog.testing.MockClassFactory=function(){if(goog.testing.MockClassFactory.instance_)return goog.testing.MockClassFactory.instance_;this.mockClassRecords_={},goog.testing.MockClassFactory.instance_=this},goog.testing.MockClassFactory.instance_=null,goog.testing.MockClassFactory.PROTOTYPE_FIELDS_=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],goog.testing.MockClassFactory.prototype.getClassName_=function(o,t){var s;s=o===goog.global?goog.testing.TestCase.getGlobals():[o];for(var e=0;e<s.length;e++)for(var c in s[e])if(s[e][c]===t)return c;throw new Error("Class is not a part of the given namespace")},goog.testing.MockClassFactory.prototype.classHasMock_=function(o){return!!this.mockClassRecords_[o]},goog.testing.MockClassFactory.prototype.getProxyCtor_=function(o,t){return function(){if(this.$mock_=t(o,arguments),!this.$mock_){var s=Array.prototype.slice.call(arguments,0);throw new Error("No mock found for "+o+" with arguments "+s.join(", "))}}},goog.testing.MockClassFactory.prototype.getProxyFunction_=function(o){return function(){return this.$mock_[o].apply(this.$mock_,arguments)}},goog.testing.MockClassFactory.prototype.findMockInstance_=function(o,t){return this.mockClassRecords_[o].findMockInstance(t)},goog.testing.MockClassFactory.prototype.createProxy_=function(o,t,s){var e=this.getProxyCtor_(s,goog.bind(this.findMockInstance_,this)),c=t.prototype,r=t.base;for(var n in goog.inherits(e,t),e.base=r,c)goog.isFunction(c[n])&&(e.prototype[n]=this.getProxyFunction_(n));return goog.array.forEach(goog.testing.MockClassFactory.PROTOTYPE_FIELDS_,function(o){Object.prototype.hasOwnProperty.call(c,o)&&(e.prototype[o]=this.getProxyFunction_(o))},this),this.mockClassRecords_[s]=new goog.testing.MockClassRecord(o,s,t,e),o[s]=e,e},goog.testing.MockClassFactory.prototype.getMockClass_=function(o,t,s,e){var c=this.getClassName_(o,t);if(e=goog.array.slice(e,2),goog.isFunction(t)){var r=s?new goog.testing.StrictMock(t):new goog.testing.LooseMock(t);if(this.classHasMock_(c)){if(this.findMockInstance_(c,e))throw new Error("Mock instance already created for "+c+" with arguments "+e.join(", "))}else this.createProxy_(o,t,c);return this.mockClassRecords_[c].addMockInstance(e,r),r}throw new Error("Cannot create a mock class for "+c+" of type "+typeof t)},goog.testing.MockClassFactory.prototype.getStrictMockClass=function(o,t,s){return this.getMockClass_(o,t,!0,arguments)},goog.testing.MockClassFactory.prototype.getLooseMockClass=function(o,t,s){return this.getMockClass_(o,t,!1,arguments)},goog.testing.MockClassFactory.prototype.createStaticMock_=function(o,t,s,e){var c=e?new goog.testing.StrictMock(o,!0):new goog.testing.LooseMock(o,!1,!0);for(var r in o)goog.isFunction(o[r])?s[r]=goog.bind(c.$mockMethod,c,r):o[r]!==o.prototype&&(s[r]=o[r]);return this.mockClassRecords_[t].setStaticMock(c),c},goog.testing.MockClassFactory.prototype.getStaticMock_=function(o,t,s){var e=this.getClassName_(o,t);if(goog.isFunction(t)){if(!this.classHasMock_(e)){var c=this.createProxy_(o,t,e);return n=this.createStaticMock_(t,e,c,s)}if(this.mockClassRecords_[e].getStaticMock()){if((n=this.mockClassRecords_[e].getStaticMock())instanceof goog.testing.StrictMock!=s){var r=n instanceof goog.testing.StrictMock?"strict":"loose";throw new Error("Requested a "+(s?"strict":"loose")+" static mock, but a "+r+" mock already exists.")}return n}c=this.mockClassRecords_[e].getProxy();var n,i=this.mockClassRecords_[e].getOriginalClass();return n=this.createStaticMock_(i,e,c,s)}throw new Error("Cannot create a mock for the static functions of "+e+" of type "+typeof t)},goog.testing.MockClassFactory.prototype.getStrictStaticMock=function(o,t){return this.getStaticMock_(o,t,!0)},goog.testing.MockClassFactory.prototype.getLooseStaticMock=function(o,t){return this.getStaticMock_(o,t,!1)},goog.testing.MockClassFactory.prototype.reset=function(){goog.object.forEach(this.mockClassRecords_,function(o){o.reset()}),this.mockClassRecords_={}};