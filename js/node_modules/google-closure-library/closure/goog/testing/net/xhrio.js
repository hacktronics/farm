goog.setTestOnly("goog.testing.net.XhrIo"),goog.provide("goog.testing.net.XhrIo"),goog.require("goog.Uri"),goog.require("goog.array"),goog.require("goog.dom.xml"),goog.require("goog.events"),goog.require("goog.net.ErrorCode"),goog.require("goog.net.EventType"),goog.require("goog.net.HttpStatus"),goog.require("goog.net.XhrIo"),goog.require("goog.net.XmlHttp"),goog.require("goog.object"),goog.require("goog.structs"),goog.require("goog.structs.Map"),goog.require("goog.testing.TestQueue"),goog.require("goog.uri.utils"),goog.testing.net.XhrIo=function(t){goog.testing.net.XhrIo.base.call(this),this.headers=new goog.structs.Map,this.testQueue_=t||null},goog.inherits(goog.testing.net.XhrIo,goog.net.XhrIo),goog.testing.net.XhrIo.base=goog.net.XhrIo,goog.testing.net.XhrIo.allowUnsafeAccessToXhrIoOutsideCallbacks=!1,goog.testing.net.XhrIo.ResponseType=goog.net.XhrIo.ResponseType,goog.testing.net.XhrIo.HTTP_SCHEME_PATTERN_=/^https?$/i,goog.testing.net.XhrIo.sendInstances_=[],goog.testing.net.XhrIo.getSendInstances=function(){return goog.testing.net.XhrIo.sendInstances_},goog.testing.net.XhrIo.cleanup=function(){for(var t=goog.testing.net.XhrIo.sendInstances_;t.length;)t.pop().dispose()},goog.testing.net.XhrIo.send=function(t,e,o,n,s,g,r){var i=new goog.testing.net.XhrIo;return goog.testing.net.XhrIo.sendInstances_.push(i),e&&goog.events.listen(i,goog.net.EventType.COMPLETE,e),goog.events.listen(i,goog.net.EventType.READY,goog.partial(goog.testing.net.XhrIo.cleanupSend_,i)),g&&i.setTimeoutInterval(g),i.setWithCredentials(Boolean(r)),i.send(t,o,n,s),i},goog.testing.net.XhrIo.cleanupSend_=function(t){t.dispose(),goog.array.remove(goog.testing.net.XhrIo.sendInstances_,t)},goog.testing.net.XhrIo.prototype.responseHeaders_,goog.testing.net.XhrIo.prototype.active_=!1,goog.testing.net.XhrIo.prototype.lastUri_="",goog.testing.net.XhrIo.prototype.lastMethod_,goog.testing.net.XhrIo.prototype.lastContent_,goog.testing.net.XhrIo.prototype.lastHeaders_,goog.testing.net.XhrIo.prototype.lastErrorCode_=goog.net.ErrorCode.NO_ERROR,goog.testing.net.XhrIo.prototype.lastError_="",goog.testing.net.XhrIo.prototype.response_="",goog.testing.net.XhrIo.prototype.statusCode_=0,goog.testing.net.XhrIo.prototype.readyState_=goog.net.XmlHttp.ReadyState.UNINITIALIZED,goog.testing.net.XhrIo.prototype.timeoutInterval_=0,goog.testing.net.XhrIo.prototype.responseType_=goog.net.XhrIo.ResponseType.DEFAULT,goog.testing.net.XhrIo.prototype.withCredentials_=!1,goog.testing.net.XhrIo.prototype.progressEventsEnabled_=!1,goog.testing.net.XhrIo.prototype.hasXhr_=!1,goog.testing.net.XhrIo.prototype.getTimeoutInterval=function(){return this.timeoutInterval_},goog.testing.net.XhrIo.prototype.setTimeoutInterval=function(t){this.timeoutInterval_=Math.max(0,t)},goog.testing.net.XhrIo.prototype.simulateTimeout=function(){this.lastErrorCode_=goog.net.ErrorCode.TIMEOUT,this.dispatchEvent(goog.net.EventType.TIMEOUT),this.abort(goog.net.ErrorCode.TIMEOUT)},goog.testing.net.XhrIo.prototype.setResponseType=function(t){this.responseType_=t},goog.testing.net.XhrIo.prototype.getResponseType=function(){return this.responseType_},goog.testing.net.XhrIo.prototype.setWithCredentials=function(t){this.withCredentials_=t},goog.testing.net.XhrIo.prototype.getWithCredentials=function(){return this.withCredentials_},goog.testing.net.XhrIo.prototype.setProgressEventsEnabled=function(t){this.progressEventsEnabled_=t},goog.testing.net.XhrIo.prototype.getProgressEventsEnabled=function(){return this.progressEventsEnabled_},goog.testing.net.XhrIo.prototype.abort=function(t){if(this.active_)try{this.active_=!1,this.readyState_=goog.net.XmlHttp.ReadyState.UNINITIALIZED,this.statusCode_=-1,this.lastErrorCode_=t||goog.net.ErrorCode.ABORT,this.dispatchEvent(goog.net.EventType.COMPLETE),this.dispatchEvent(goog.net.EventType.ABORT)}finally{this.simulateReady()}},goog.testing.net.XhrIo.prototype.send=function(t,e,o,n){if(this.hasXhr_)throw new Error("[goog.net.XhrIo] Object is active with another request");this.lastUri_=t,this.lastMethod_=e||"GET",this.lastContent_=o,this.headers.isEmpty()?this.lastHeaders_=n:(this.lastHeaders_=this.headers.toObject(),n&&goog.structs.forEach(n,goog.bind(function(t,e){this.lastHeaders_[e]=t},this))),this.testQueue_&&this.testQueue_.enqueue(["s",t,e,o,n]),this.hasXhr_=!0,this.active_=!0,this.readyState_=goog.net.XmlHttp.ReadyState.UNINITIALIZED,this.simulateReadyStateChange(goog.net.XmlHttp.ReadyState.LOADING)},goog.testing.net.XhrIo.prototype.createXhr=function(){return goog.net.XmlHttp()},goog.testing.net.XhrIo.prototype.simulateReadyStateChange=function(t){if(t<this.readyState_)throw new Error("Readystate cannot go backwards");if(t!=goog.net.XmlHttp.ReadyState.INTERACTIVE||t!=this.readyState_)for(;this.readyState_<t;)this.readyState_++,this.dispatchEvent(goog.net.EventType.READY_STATE_CHANGE),this.readyState_==goog.net.XmlHttp.ReadyState.COMPLETE&&(this.active_=!1,this.dispatchEvent(goog.net.EventType.COMPLETE));else this.dispatchEvent(goog.net.EventType.READY_STATE_CHANGE)},goog.testing.net.XhrIo.prototype.simulatePartialResponse=function(t,e){this.response_+=t,this.responseHeaders_=e||{},this.statusCode_=200,this.simulateReadyStateChange(goog.net.XmlHttp.ReadyState.INTERACTIVE)},goog.testing.net.XhrIo.prototype.simulateResponse=function(t,e,o){goog.testing.net.XhrIo.allowUnsafeAccessToXhrIoOutsideCallbacks||goog.testing.net.XhrIo.sendInstances_.length||(this.hasXhr_=!0,this.active_=!0),this.statusCode_=t,this.response_=e||"",this.responseHeaders_=o||{};try{this.isSuccess()?(this.simulateReadyStateChange(goog.net.XmlHttp.ReadyState.COMPLETE),this.dispatchEvent(goog.net.EventType.SUCCESS)):(this.lastErrorCode_=goog.net.ErrorCode.HTTP_ERROR,this.lastError_=this.getStatusText()+" ["+this.getStatus()+"]",this.simulateReadyStateChange(goog.net.XmlHttp.ReadyState.COMPLETE),this.dispatchEvent(goog.net.EventType.ERROR))}finally{this.simulateReady()}},goog.testing.net.XhrIo.prototype.simulateReady=function(){this.active_=!1,this.hasXhr_=!1,this.dispatchEvent(goog.net.EventType.READY)},goog.testing.net.XhrIo.prototype.simulateProgress=function(t,e,o,n){var s={type:goog.net.EventType.PROGRESS,lengthComputable:t,loaded:e,total:o};this.dispatchEvent(s);var g=goog.object.clone(s);g.type=n?goog.net.EventType.DOWNLOAD_PROGRESS:goog.net.EventType.UPLOAD_PROGRESS,this.dispatchEvent(g)},goog.testing.net.XhrIo.prototype.isActive=function(){return!!this.hasXhr_},goog.testing.net.XhrIo.prototype.isComplete=function(){return this.readyState_==goog.net.XmlHttp.ReadyState.COMPLETE},goog.testing.net.XhrIo.prototype.isSuccess=function(){var t=this.getStatus();return goog.net.HttpStatus.isSuccess(t)||0===t&&!this.isLastUriEffectiveSchemeHttp_()},goog.testing.net.XhrIo.prototype.isLastUriEffectiveSchemeHttp_=function(){var t=goog.uri.utils.getEffectiveScheme(String(this.lastUri_));return goog.testing.net.XhrIo.HTTP_SCHEME_PATTERN_.test(t)},goog.testing.net.XhrIo.prototype.getReadyState=function(){return this.readyState_},goog.testing.net.XhrIo.prototype.getStatus=function(){return this.statusCode_},goog.testing.net.XhrIo.prototype.getStatusText=function(){return""},goog.testing.net.XhrIo.prototype.getLastErrorCode=function(){return this.lastErrorCode_},goog.testing.net.XhrIo.prototype.getLastError=function(){return this.lastError_},goog.testing.net.XhrIo.prototype.getLastUri=function(){return this.lastUri_},goog.testing.net.XhrIo.prototype.getLastMethod=function(){return this.lastMethod_},goog.testing.net.XhrIo.prototype.getLastContent=function(){return this.lastContent_},goog.testing.net.XhrIo.prototype.getLastRequestHeaders=function(){return this.lastHeaders_},goog.testing.net.XhrIo.prototype.checkXhr_=function(){return goog.testing.net.XhrIo.allowUnsafeAccessToXhrIoOutsideCallbacks||!!this.hasXhr_},goog.testing.net.XhrIo.prototype.getResponseText=function(){return this.checkXhr_()?"string"==typeof this.response_?this.response_:goog.global.ArrayBuffer&&this.response_ instanceof ArrayBuffer?"":goog.dom.xml.serialize(this.response_):""},goog.testing.net.XhrIo.prototype.getResponseBody=function(){return null},goog.testing.net.XhrIo.prototype.getResponseJson=function(t){if(this.checkXhr_()){var e=this.getResponseText();return t&&0==e.indexOf(t)&&(e=e.substring(t.length)),JSON.parse(e)}},goog.testing.net.XhrIo.prototype.getResponseXml=function(){return this.checkXhr_()?"string"==typeof this.response_||goog.global.ArrayBuffer&&this.response_ instanceof ArrayBuffer?null:this.response_:null},goog.testing.net.XhrIo.prototype.getResponse=function(){return this.checkXhr_()?this.response_:null},goog.testing.net.XhrIo.prototype.getResponseHeader=function(t){if(this.checkXhr_()&&this.isComplete())return this.responseHeaders_[t]},goog.testing.net.XhrIo.prototype.getAllResponseHeaders=function(){return this.checkXhr_()&&this.isComplete()?this.getAllStreamingResponseHeaders():""},goog.testing.net.XhrIo.prototype.getResponseHeaders=function(){if(!this.checkXhr_()||!this.isComplete())return{};var t={};return goog.object.forEach(this.responseHeaders_,function(e,o){t[o]?t[o]+=", "+e:t[o]=e}),t},goog.testing.net.XhrIo.prototype.getStreamingResponseHeader=function(t){return this.checkXhr_()&&t in this.responseHeaders_?this.responseHeaders_[t]:null},goog.testing.net.XhrIo.prototype.getAllStreamingResponseHeaders=function(){if(!this.checkXhr_())return"";var t=[];return goog.object.forEach(this.responseHeaders_,function(e,o){t.push(o+": "+e)}),t.join("\r\n")};