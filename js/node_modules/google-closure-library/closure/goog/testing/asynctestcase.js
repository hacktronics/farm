goog.setTestOnly("goog.testing.AsyncTestCase"),goog.provide("goog.testing.AsyncTestCase"),goog.provide("goog.testing.AsyncTestCase.ControlBreakingException"),goog.require("goog.asserts"),goog.require("goog.testing.TestCase"),goog.require("goog.testing.asserts"),goog.testing.AsyncTestCase=function(t){goog.testing.TestCase.call(this,t)},goog.inherits(goog.testing.AsyncTestCase,goog.testing.TestCase),goog.testing.AsyncTestCase.TopStackFuncResult_,goog.testing.AsyncTestCase.ControlBreakingException=function(t){goog.testing.AsyncTestCase.ControlBreakingException.base(this,"constructor",t),this.message=t||""},goog.inherits(goog.testing.AsyncTestCase.ControlBreakingException,Error),goog.testing.AsyncTestCase.ControlBreakingException.TO_STRING="[AsyncTestCase.ControlBreakingException]",goog.testing.AsyncTestCase.ControlBreakingException.prototype.isControlBreakingException=!0,goog.testing.AsyncTestCase.ControlBreakingException.prototype.toString=function(){return goog.testing.AsyncTestCase.ControlBreakingException.TO_STRING},goog.testing.AsyncTestCase.prototype.stepTimeout=1e3,goog.testing.AsyncTestCase.prototype.timeToSleepAfterFailure=500,goog.testing.AsyncTestCase.prototype.enableDebugLogs_=!1,goog.testing.AsyncTestCase.prototype.origAssert_,goog.testing.AsyncTestCase.prototype.origFail_=null,goog.testing.AsyncTestCase.prototype.origOnError_,goog.testing.AsyncTestCase.prototype.curStepFunc_,goog.testing.AsyncTestCase.prototype.curStepName_="",goog.testing.AsyncTestCase.prototype.nextStepFunc_=null,goog.testing.AsyncTestCase.prototype.nextStepName_="",goog.testing.AsyncTestCase.prototype.timeoutHandle_=0,goog.testing.AsyncTestCase.prototype.cleanedUp_=!1,goog.testing.AsyncTestCase.prototype.activeTest,goog.testing.AsyncTestCase.prototype.inException_=!1,goog.testing.AsyncTestCase.prototype.isReady_=!0,goog.testing.AsyncTestCase.prototype.expectedSignalCount_=0,goog.testing.AsyncTestCase.prototype.receivedSignalCount_=0,goog.testing.AsyncTestCase.prototype.returnWillPump_=!1,goog.testing.AsyncTestCase.prototype.numControlExceptionsExpected_=0,goog.testing.AsyncTestCase.prototype.getCurrentStepName=function(){return this.curStepName_},goog.testing.AsyncTestCase.createAndInstall=function(t){var e=new goog.testing.AsyncTestCase(t);return goog.testing.TestCase.initializeTestRunner(e),e},goog.testing.AsyncTestCase.prototype.waitForAsync=function(t){this.isReady_=!1,this.curStepName_=t||this.curStepName_,this.stopTimeoutTimer_(),this.startTimeoutTimer_()},goog.testing.AsyncTestCase.prototype.continueTesting=function(){if(this.receivedSignalCount_<this.expectedSignalCount_){var t=this.expectedSignalCount_-this.receivedSignalCount_;throw new Error("Still waiting for "+t+" signals.")}this.endCurrentStep_()},goog.testing.AsyncTestCase.prototype.endCurrentStep_=function(){this.isReady_||(this.isReady_=!0,this.stopTimeoutTimer_(),this.timeout(goog.bind(this.pump_,this,null),0))},goog.testing.AsyncTestCase.prototype.waitForSignals=function(t,e){this.expectedSignalCount_+=t,this.receivedSignalCount_<this.expectedSignalCount_&&this.waitForAsync(e)},goog.testing.AsyncTestCase.prototype.signal=function(){++this.receivedSignalCount_===this.expectedSignalCount_&&this.expectedSignalCount_>0&&this.endCurrentStep_()},goog.testing.AsyncTestCase.prototype.doAsyncError=function(t){if(t&&t.isControlBreakingException)throw t;this.stopTimeoutTimer_();var e=new goog.testing.TestCase.Test(this.curStepName_,goog.nullFunction);this.activeTest&&(e.name=this.activeTest.name+" ["+e.name+"]"),this.activeTest?(this.recordError(e.name,t),this.doError(e)):this.exceptionBeforeTest=t,this.timeout(goog.bind(this.pump_,this,this.doAsyncErrorTearDown_),this.timeToSleepAfterFailure),this.returnWillPump_||(this.numControlExceptionsExpected_+=1,this.dbgLog_("doAsynError: numControlExceptionsExpected_ = "+this.numControlExceptionsExpected_+" and throwing exception."));var o="";throw"string"==typeof t?o=t:t&&t.message&&(o=t.message),new goog.testing.AsyncTestCase.ControlBreakingException(o)},goog.testing.AsyncTestCase.prototype.runTests=function(){this.hookAssert_(),this.hookOnError_(),goog.testing.TestCase.currentTestName=null,this.setNextStep_(this.doSetUpPage_,"setUpPage"),this.pump_()},goog.testing.AsyncTestCase.prototype.cycleTests=function(){this.saveMessage("Start"),this.setNextStep_(this.doIteration_,"doIteration"),this.pump_()},goog.testing.AsyncTestCase.prototype.finalize=function(){this.unhookAll_(),this.setNextStep_(null,"finalized"),goog.testing.AsyncTestCase.superClass_.finalize.call(this)},goog.testing.AsyncTestCase.prototype.enableDebugLogging=function(){this.enableDebugLogs_=!0},goog.testing.AsyncTestCase.prototype.dbgLog_=function(t){this.enableDebugLogs_&&this.log("AsyncTestCase - "+t)},goog.testing.AsyncTestCase.prototype.doTopOfStackAsyncError_=function(t){try{this.doAsyncError(t)}catch(t){if(!t.isControlBreakingException)throw t;this.numControlExceptionsExpected_-=1,this.dbgLog_("doTopOfStackAsyncError_: numControlExceptionsExpected_ = "+this.numControlExceptionsExpected_+" and catching exception.")}},goog.testing.AsyncTestCase.prototype.doAsyncErrorTearDown_=function(){if(this.inException_)this.endCurrentStep_();else{this.inException_=!0,this.isReady_=!0;var t=this.nextStepFunc_,e="TestCase.execute (after error)";this.activeTest&&(t=this.doIteration_,e="doIteration (after error)"),this.setNextStep_(function(){this.inException_=!1,this.setNextStep_(t,e)},"doAsyncError"),this.cleanedUp_||(this.cleanedUp_=!0,this.tearDown())}},goog.testing.AsyncTestCase.prototype.hookAssert_=function(){if(!this.origAssert_){this.origAssert_=_assert,this.origFail_=fail;var t=this;_assert=function(){try{t.origAssert_.apply(this,arguments)}catch(e){t.dbgLog_("Wrapping failed assert()"),t.doAsyncError(e)}},fail=function(){try{t.origFail_.apply(this,arguments)}catch(e){t.dbgLog_("Wrapping fail()"),t.doAsyncError(e)}}}},goog.testing.AsyncTestCase.prototype.hookOnError_=function(){if(!this.origOnError_){this.origOnError_=window.onerror;var t=this;window.onerror=function(e,o,s){var i=goog.testing.AsyncTestCase.ControlBreakingException.TO_STRING;if(-1!=String(e).indexOf(i)&&t.numControlExceptionsExpected_)return t.numControlExceptionsExpected_-=1,t.dbgLog_("window.onerror: numControlExceptionsExpected_ = "+t.numControlExceptionsExpected_+" and ignoring exception. "+e),!0;t.dbgLog_("window.onerror caught exception.");var n=e+"\nURL: "+o+"\nLine: "+s;return t.doTopOfStackAsyncError_(n),!1}}},goog.testing.AsyncTestCase.prototype.unhookAll_=function(){this.origOnError_&&(window.onerror=this.origOnError_,this.origOnError_=null,_assert=goog.asserts.assert(this.origAssert_),this.origAssert_=null,fail=goog.asserts.assert(this.origFail_),this.origFail_=null)},goog.testing.AsyncTestCase.prototype.startTimeoutTimer_=function(){!this.timeoutHandle_&&this.stepTimeout>0&&(this.timeoutHandle_=this.timeout(goog.bind(function(){this.dbgLog_("Timeout timer fired with id "+this.timeoutHandle_),this.timeoutHandle_=0,this.doTopOfStackAsyncError_("Timed out while waiting for continueTesting() to be called.")},this),this.stepTimeout),this.dbgLog_("Started timeout timer with id "+this.timeoutHandle_))},goog.testing.AsyncTestCase.prototype.stopTimeoutTimer_=function(){this.timeoutHandle_&&(this.dbgLog_("Clearing timeout timer with id "+this.timeoutHandle_),this.clearTimeout(this.timeoutHandle_),this.timeoutHandle_=0)},goog.testing.AsyncTestCase.prototype.setNextStep_=function(t,e){this.nextStepFunc_=t&&goog.bind(t,this),this.nextStepName_=e},goog.testing.AsyncTestCase.prototype.callTopOfStackFunc_=function(t){try{return t.call(this),{controlBreakingExceptionThrown:!1,message:""}}catch(t){this.dbgLog_("Caught exception in callTopOfStackFunc_");try{return this.doAsyncError(t),{controlBreakingExceptionThrown:!1,message:""}}catch(t){if(!t.isControlBreakingException)throw t;return{controlBreakingExceptionThrown:!0,message:t.message}}}},goog.testing.AsyncTestCase.prototype.pump_=function(t){if(this.returnWillPump_)t&&t.call(this);else{this.setBatchTime(this.now()),this.returnWillPump_=!0;var e={};for(t&&(e=this.callTopOfStackFunc_(t));this.isReady_&&this.nextStepFunc_&&!e.controlBreakingExceptionThrown;){if(this.curStepFunc_=this.nextStepFunc_,this.curStepName_=this.nextStepName_,this.nextStepFunc_=null,this.nextStepName_="",this.dbgLog_("Performing step: "+this.curStepName_),e=this.callTopOfStackFunc_(this.curStepFunc_),this.now()-this.getBatchTime()>goog.testing.TestCase.maxRunTime&&!e.controlBreakingExceptionThrown){this.saveMessage("Breaking async");var o=this;this.timeout(function(){o.pump_()},100);break}}this.returnWillPump_=!1}},goog.testing.AsyncTestCase.prototype.doSetUpPage_=function(){this.setNextStep_(this.execute,"TestCase.execute"),this.setUpPage()},goog.testing.AsyncTestCase.prototype.doIteration_=function(){this.expectedSignalCount_=0,this.receivedSignalCount_=0,this.activeTest=this.next(),goog.testing.TestCase.currentTestName=this.activeTest?this.activeTest.name:null,this.activeTest&&this.running?(this.result_.runCount++,this.maybeFailTestEarly(this.activeTest)?this.setNextStep_(this.doIteration_,"doIteration"):this.setNextStep_(this.doSetUp_,"setUp")):this.finalize()},goog.testing.AsyncTestCase.prototype.doSetUp_=function(){this.log("Running test: "+this.activeTest.name),this.cleanedUp_=!1,this.setNextStep_(this.doExecute_,this.activeTest.name),this.setUp()},goog.testing.AsyncTestCase.prototype.doExecute_=function(){this.setNextStep_(this.doTearDown_,"tearDown"),this.activeTest.execute()},goog.testing.AsyncTestCase.prototype.doTearDown_=function(){this.cleanedUp_=!0,this.setNextStep_(this.doNext_,"doNext"),this.tearDown()},goog.testing.AsyncTestCase.prototype.doNext_=function(){this.setNextStep_(this.doIteration_,"doIteration"),this.doSuccess(this.activeTest)};