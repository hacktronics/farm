goog.setTestOnly("goog.testing.ContinuationTestCase"),goog.provide("goog.testing.ContinuationTestCase"),goog.provide("goog.testing.ContinuationTestCase.ContinuationTest"),goog.provide("goog.testing.ContinuationTestCase.Step"),goog.require("goog.array"),goog.require("goog.events.EventHandler"),goog.require("goog.events.EventTarget"),goog.require("goog.testing.TestCase"),goog.require("goog.testing.asserts"),goog.testing.ContinuationTestCase=function(t){goog.testing.TestCase.call(this,t),this.handler_=new goog.events.EventHandler(this)},goog.inherits(goog.testing.ContinuationTestCase,goog.testing.TestCase),goog.testing.ContinuationTestCase.MAX_TIMEOUT=1e3,goog.testing.ContinuationTestCase.prototype.locked_,goog.testing.ContinuationTestCase.prototype.currentTest_=null,goog.testing.ContinuationTestCase.prototype.enableWaitFunctions_=function(t){t?(goog.exportSymbol("waitForCondition",goog.bind(this.waitForCondition,this)),goog.exportSymbol("waitForEvent",goog.bind(this.waitForEvent,this)),goog.exportSymbol("waitForTimeout",goog.bind(this.waitForTimeout,this))):(goog.global.waitForCondition=void 0,goog.global.waitForEvent=void 0,goog.global.waitForTimeout=void 0)},goog.testing.ContinuationTestCase.prototype.runTests=function(){this.enableWaitFunctions_(!0),goog.testing.ContinuationTestCase.superClass_.runTests.call(this)},goog.testing.ContinuationTestCase.prototype.finalize=function(){this.enableWaitFunctions_(!1),goog.testing.ContinuationTestCase.superClass_.finalize.call(this)},goog.testing.ContinuationTestCase.prototype.cycleTests=function(){this.currentTest_||(this.currentTest_=this.createNextTest_()),this.currentTest_?this.runNextStep_():this.finalize()},goog.testing.ContinuationTestCase.prototype.createNextTest_=function(){var t=this.next();if(!t)return null;var e=t.name;return goog.testing.TestCase.currentTestName=e,this.result_.runCount++,this.log("Running test: "+e),new goog.testing.ContinuationTestCase.ContinuationTest(new goog.testing.TestCase.Test(e,this.setUp,this),t,new goog.testing.TestCase.Test(e,this.tearDown,this))},goog.testing.ContinuationTestCase.prototype.finishTest_=function(){var t=this.currentTest_.getError();t?(this.recordError(this.currentTest_.name,t),this.doError(this.currentTest_)):this.doSuccess(this.currentTest_),goog.testing.TestCase.currentTestName=null,this.currentTest_=null,this.locked_=!1,this.handler_.removeAll(),this.timeout(goog.bind(this.cycleTests,this),0)},goog.testing.ContinuationTestCase.prototype.runNextStep_=function(){if(!this.locked_){var t=this.currentTest_.getCurrentPhase();if(t&&t.length){var e=goog.array.findIndex(t,function(t){return!t.waiting});if(!(e<0)){this.locked_=!0;var o=t[e];try{o.execute(),goog.array.removeAt(t,e)}catch(t){this.currentTest_.setError(t),this.currentTest_.cancelCurrentPhase(),this.currentTest_.cancelTestPhase()}this.locked_=!1,this.runNextStep_()}}else this.finishTest_()}},goog.testing.ContinuationTestCase.prototype.waitForTimeout=function(t,e){var o=this.addStep_(t);o.setTimeout(goog.bind(this.handleComplete_,this,o),e||0)},goog.testing.ContinuationTestCase.prototype.waitForEvent=function(t,e,o){var n=this.addStep_(o),i=goog.testing.ContinuationTestCase.MAX_TIMEOUT;n.setTimeout(goog.bind(this.handleTimeout_,this,n,i),i),this.handler_.listenOnce(t,e,goog.bind(this.handleComplete_,this,n))},goog.testing.ContinuationTestCase.prototype.waitForCondition=function(t,e,o,n){var i=o||100,s=n||goog.testing.ContinuationTestCase.MAX_TIMEOUT,g=this.addStep_(e);this.testCondition_(g,t,goog.now(),i,s)},goog.testing.ContinuationTestCase.prototype.addStep_=function(t){if(!this.currentTest_)throw new Error("Cannot add test steps outside of a running test.");var e=new goog.testing.ContinuationTestCase.Step(this.currentTest_.name,t,this.currentTest_.scope);return this.currentTest_.addStep(e),e},goog.testing.ContinuationTestCase.prototype.handleComplete_=function(t){t.clearTimeout(),t.waiting=!1,this.runNextStep_()},goog.testing.ContinuationTestCase.prototype.handleTimeout_=function(t,e){t.ref=function(){fail("Continuation timed out after "+e+"ms.")},this.handler_.removeAll(),this.handleComplete_(t)},goog.testing.ContinuationTestCase.prototype.testCondition_=function(t,e,o,n,i){var s=goog.now()-o;e()?this.handleComplete_(t):s<i?t.setTimeout(goog.bind(this.testCondition_,this,t,e,o,n,i),n):this.handleTimeout_(t,s)},goog.testing.ContinuationTestCase.ContinuationTest=function(t,e,o){goog.testing.TestCase.Test.call(this,e.name,function(){},null),this.setUp_=[t],this.test_=[e],this.tearDown_=[o]},goog.inherits(goog.testing.ContinuationTestCase.ContinuationTest,goog.testing.TestCase.Test),goog.testing.ContinuationTestCase.ContinuationTest.prototype.error_=null,goog.testing.ContinuationTestCase.ContinuationTest.prototype.getError=function(){return this.error_},goog.testing.ContinuationTestCase.ContinuationTest.prototype.setError=function(t){this.error_=this.error_||t},goog.testing.ContinuationTestCase.ContinuationTest.prototype.getCurrentPhase=function(){return this.setUp_.length?this.setUp_:this.test_.length?this.test_:this.tearDown_.length?this.tearDown_:null},goog.testing.ContinuationTestCase.ContinuationTest.prototype.addStep=function(t){var e=this.getCurrentPhase();if(!e)throw new Error("Attempted to add a step to a completed test.");e.push(t)},goog.testing.ContinuationTestCase.ContinuationTest.prototype.cancelCurrentPhase=function(){this.cancelPhase_(this.getCurrentPhase())},goog.testing.ContinuationTestCase.ContinuationTest.prototype.cancelTestPhase=function(){this.cancelPhase_(this.setUp_),this.cancelPhase_(this.test_)},goog.testing.ContinuationTestCase.ContinuationTest.prototype.cancelPhase_=function(t){for(;t&&t.length;){var e=t.pop();e instanceof goog.testing.ContinuationTestCase.Step&&e.clearTimeout()}},goog.testing.ContinuationTestCase.Step=function(t,e,o){goog.testing.TestCase.Test.call(this,t,e,o)},goog.inherits(goog.testing.ContinuationTestCase.Step,goog.testing.TestCase.Test),goog.testing.ContinuationTestCase.Step.prototype.waiting=!0,goog.testing.ContinuationTestCase.Step.protectedClearTimeout_=window.clearTimeout,goog.testing.ContinuationTestCase.Step.protectedSetTimeout_=window.setTimeout,goog.testing.ContinuationTestCase.Step.prototype.timeout_,goog.testing.ContinuationTestCase.Step.prototype.setTimeout=function(t,e){this.clearTimeout();var o=goog.testing.ContinuationTestCase.Step.protectedSetTimeout_;this.timeout_=o(t,e)},goog.testing.ContinuationTestCase.Step.prototype.clearTimeout=function(){this.timeout_&&((0,goog.testing.ContinuationTestCase.Step.protectedClearTimeout_)(this.timeout_),delete this.timeout_)};