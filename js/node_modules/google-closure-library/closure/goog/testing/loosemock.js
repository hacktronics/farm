goog.setTestOnly("goog.testing.LooseExpectationCollection"),goog.provide("goog.testing.LooseExpectationCollection"),goog.provide("goog.testing.LooseMock"),goog.require("goog.array"),goog.require("goog.asserts"),goog.require("goog.structs.Map"),goog.require("goog.structs.Set"),goog.require("goog.testing.Mock"),goog.testing.LooseExpectationCollection=function(){this.expectations_=[]},goog.testing.LooseExpectationCollection.prototype.addExpectation=function(t){this.expectations_.push(t)},goog.testing.LooseExpectationCollection.prototype.getExpectations=function(){return this.expectations_},goog.testing.LooseMock=function(t,o,e,s){goog.testing.Mock.call(this,t,e,s),this.$expectations_=new goog.structs.Map,this.awaitingExpectations_=new goog.structs.Set,this.$calls_=[],this.$ignoreUnexpectedCalls_=!!o},goog.inherits(goog.testing.LooseMock,goog.testing.Mock),goog.testing.LooseMock.prototype.$setIgnoreUnexpectedCalls=function(t){return this.$ignoreUnexpectedCalls_=t,this},goog.testing.LooseMock.prototype.$recordExpectation=function(){this.$expectations_.containsKey(this.$pendingExpectation.name)||this.$expectations_.set(this.$pendingExpectation.name,new goog.testing.LooseExpectationCollection),this.$expectations_.get(this.$pendingExpectation.name).addExpectation(this.$pendingExpectation),this.$pendingExpectation&&this.awaitingExpectations_.add(this.$pendingExpectation)},goog.testing.LooseMock.prototype.$recordCall=function(t,o){if(!this.$expectations_.containsKey(t)){if(this.$ignoreUnexpectedCalls_)return;this.$throwCallException(t,o)}for(var e=null,s=this.$expectations_.get(t).getExpectations(),i=0;i<s.length;i++){var a=s[i];if(this.$verifyCall(a,t,o)&&(e=a,a.actualCalls<a.maxCalls))break}return null==e&&this.$throwCallException(t,o,a),e.actualCalls++,e.actualCalls>e.maxCalls&&this.$throwException("Too many calls to "+e.name+"\nExpected: "+e.maxCalls+" but was: "+e.actualCalls),e.actualCalls>=e.minCalls&&(this.awaitingExpectations_.remove(e),this.maybeFinishedWithExpectations_()),this.$calls_.push([t,o]),this.$do(e,o)},goog.testing.LooseMock.prototype.$reset=function(){goog.testing.LooseMock.superClass_.$reset.call(this),this.$expectations_=new goog.structs.Map,this.awaitingExpectations_=new goog.structs.Set,this.$calls_=[]},goog.testing.LooseMock.prototype.$replay=function(){goog.testing.LooseMock.superClass_.$replay.call(this);for(var t=this.$expectations_.getValues(),o=0;o<t.length;o++)for(var e=t[o].getExpectations(),s=0;s<e.length;s++){var i=e[s];if(!isFinite(i.maxCalls))for(var a=s+1;a<e.length;a++){var n=e[a];if(n.minCalls>0&&goog.array.equals(i.argumentList,n.argumentList)){var g=i.name,l=this.$argumentsAsString(i.argumentList);this.$throwException(["Expected call to ",g," with arguments ",l," has an infinite max number of calls; can't expect an"," identical call later with a positive min number of calls"].join(""))}}}},goog.testing.LooseMock.prototype.$waitAndVerify=function(){for(var t=this.$expectations_.getKeys(),o=0;o<t.length;o++)for(var e=this.$expectations_.get(t[o]).getExpectations(),s=0;s<e.length;s++){var i=e[s];goog.asserts.assert(!isFinite(i.maxCalls)||i.minCalls==i.maxCalls,"Mock expectations cannot have a loose number of expected calls to use $waitAndVerify.")}var a=goog.testing.LooseMock.base(this,"$waitAndVerify");return this.maybeFinishedWithExpectations_(),a},goog.testing.LooseMock.prototype.maybeFinishedWithExpectations_=function(){var t=goog.array.some(this.$expectations_.getValues(),function(t){return goog.array.some(t.getExpectations(),function(t){return t.actualCalls<t.minCalls})});this.waitingForExpectations&&!t&&this.waitingForExpectations.resolve()},goog.testing.LooseMock.prototype.$verify=function(){goog.testing.LooseMock.superClass_.$verify.call(this);for(var t=this.$expectations_.getValues(),o=0;o<t.length;o++)for(var e=t[o].getExpectations(),s=0;s<e.length;s++){var i=e[s];i.actualCalls>i.maxCalls?this.$throwException("Too many calls to "+i.name+"\nExpected: "+i.maxCalls+" but was: "+i.actualCalls):i.actualCalls<i.minCalls&&this.$throwException("Not enough calls to "+i.name+"\nExpected: "+i.minCalls+" but was: "+i.actualCalls)}};