goog.provide("goog.i18n.MessageFormat"),goog.require("goog.array"),goog.require("goog.asserts"),goog.require("goog.i18n.CompactNumberFormatSymbols"),goog.require("goog.i18n.NumberFormat"),goog.require("goog.i18n.NumberFormatSymbols"),goog.require("goog.i18n.ordinalRules"),goog.require("goog.i18n.pluralRules"),goog.i18n.MessageFormat=function(e){this.pattern_=e,this.initialLiterals_=null,this.literals_=null,this.parsedPattern_=null,this.numberFormatter_=goog.i18n.MessageFormat.getNumberFormatter_()},goog.i18n.MessageFormat.numberFormatterSymbols_=null,goog.i18n.MessageFormat.compactNumberFormatterSymbols_=null,goog.i18n.MessageFormat.numberFormatter_=null,goog.i18n.MessageFormat.LITERAL_PLACEHOLDER_="ï·Ÿ_",goog.i18n.MessageFormat.Element_={STRING:0,BLOCK:1},goog.i18n.MessageFormat.BlockType_={PLURAL:0,ORDINAL:1,SELECT:2,SIMPLE:3,STRING:4,UNKNOWN:5},goog.i18n.MessageFormat.OTHER_="other",goog.i18n.MessageFormat.REGEX_LITERAL_=new RegExp("'([{}#].*?)'","g"),goog.i18n.MessageFormat.REGEX_DOUBLE_APOSTROPHE_=new RegExp("''","g"),goog.i18n.MessageFormat.TypeVal_,goog.i18n.MessageFormat.BlockTypeVal_,goog.i18n.MessageFormat.getNumberFormatter_=function(){var e=goog.i18n.NumberFormatSymbols,o=goog.i18n.CompactNumberFormatSymbols;return goog.i18n.MessageFormat.numberFormatterSymbols_===e&&goog.i18n.MessageFormat.compactNumberFormatterSymbols_===o||(goog.i18n.MessageFormat.numberFormatterSymbols_=e,goog.i18n.MessageFormat.compactNumberFormatterSymbols_=o,goog.i18n.MessageFormat.numberFormatter_=new goog.i18n.NumberFormat(goog.i18n.NumberFormat.Format.DECIMAL)),goog.i18n.MessageFormat.numberFormatter_},goog.i18n.MessageFormat.prototype.format=function(e){return this.format_(e,!1)},goog.i18n.MessageFormat.prototype.formatIgnoringPound=function(e){return this.format_(e,!0)},goog.i18n.MessageFormat.prototype.format_=function(e,o){if(this.init_(),!this.parsedPattern_||0==this.parsedPattern_.length)return"";this.literals_=goog.array.clone(this.initialLiterals_);var t=[];this.formatBlock_(this.parsedPattern_,e,o,t);var a=t.join("");for(o||goog.asserts.assert(-1==a.search("#"),"Not all # were replaced.");this.literals_.length>0;)a=a.replace(this.buildPlaceholder_(this.literals_),this.literals_.pop());return a},goog.i18n.MessageFormat.prototype.formatBlock_=function(e,o,t,a){for(var s=0;s<e.length;s++)switch(e[s].type){case goog.i18n.MessageFormat.BlockType_.STRING:a.push(e[s].value);break;case goog.i18n.MessageFormat.BlockType_.SIMPLE:var r=e[s].value;this.formatSimplePlaceholder_(r,o,a);break;case goog.i18n.MessageFormat.BlockType_.SELECT:r=e[s].value;this.formatSelectBlock_(r,o,t,a);break;case goog.i18n.MessageFormat.BlockType_.PLURAL:r=e[s].value;this.formatPluralOrdinalBlock_(r,o,goog.i18n.pluralRules.select,t,a);break;case goog.i18n.MessageFormat.BlockType_.ORDINAL:r=e[s].value;this.formatPluralOrdinalBlock_(r,o,goog.i18n.ordinalRules.select,t,a);break;default:goog.asserts.fail("Unrecognized block type: "+e[s].type)}},goog.i18n.MessageFormat.prototype.formatSimplePlaceholder_=function(e,o,t){var a=o[e];void 0!==a?(this.literals_.push(a),t.push(this.buildPlaceholder_(this.literals_))):t.push("Undefined parameter - "+e)},goog.i18n.MessageFormat.prototype.formatSelectBlock_=function(e,o,t,a){var s=e.argumentIndex;if(void 0!==o[s]){var r=e[o[s]];void 0===r&&(r=e[goog.i18n.MessageFormat.OTHER_],goog.asserts.assertArray(r,"Invalid option or missing other option for select block.")),this.formatBlock_(r,o,t,a)}else a.push("Undefined parameter - "+s)},goog.i18n.MessageFormat.prototype.formatPluralOrdinalBlock_=function(e,o,t,a,s){var r=e.argumentIndex,g=e.argumentOffset,n=+o[r];if(isNaN(n))s.push("Undefined or invalid parameter - "+r);else{var i=n-g,l=e[o[r]];if(void 0===l){var m=t(Math.abs(i));goog.asserts.assertString(m,"Invalid plural key."),void 0===(l=e[m])&&(l=e[goog.i18n.MessageFormat.OTHER_]),goog.asserts.assertArray(l,"Invalid option or missing other option for plural block.")}var p=[];this.formatBlock_(l,o,a,p);var u=p.join("");if(goog.asserts.assertString(u,"Empty block in plural."),a)s.push(u);else{var _=this.numberFormatter_.format(i);s.push(u.replace(/#/g,_))}}},goog.i18n.MessageFormat.prototype.init_=function(){if(this.pattern_){this.initialLiterals_=[];var e=this.insertPlaceholders_(this.pattern_);this.parsedPattern_=this.parseBlock_(e),this.pattern_=null}},goog.i18n.MessageFormat.prototype.insertPlaceholders_=function(e){var o=this.initialLiterals_,t=goog.bind(this.buildPlaceholder_,this);return e=(e=e.replace(goog.i18n.MessageFormat.REGEX_DOUBLE_APOSTROPHE_,function(){return o.push("'"),t(o)})).replace(goog.i18n.MessageFormat.REGEX_LITERAL_,function(e,a){return o.push(a),t(o)})},goog.i18n.MessageFormat.prototype.extractParts_=function(e){var o,t=0,a=[],s=[],r=/[{}]/g;for(r.lastIndex=0;o=r.exec(e);){var g=o.index;if("}"==o[0]){var n=a.pop();if(goog.asserts.assert(void 0!==n&&"{"==n,"No matching { for }."),0==a.length){var i={};i.type=goog.i18n.MessageFormat.Element_.BLOCK,i.value=e.substring(t,g),s.push(i),t=g+1}}else{var l;if(0==a.length)""!=(l=e.substring(t,g))&&s.push({type:goog.i18n.MessageFormat.Element_.STRING,value:l}),t=g+1;a.push("{")}}return goog.asserts.assert(0==a.length,"There are mismatched { or } in the pattern."),""!=(l=e.substring(t))&&s.push({type:goog.i18n.MessageFormat.Element_.STRING,value:l}),s},goog.i18n.MessageFormat.PLURAL_BLOCK_RE_=/^\s*(\w+)\s*,\s*plural\s*,(?:\s*offset:(\d+))?/,goog.i18n.MessageFormat.ORDINAL_BLOCK_RE_=/^\s*(\w+)\s*,\s*selectordinal\s*,/,goog.i18n.MessageFormat.SELECT_BLOCK_RE_=/^\s*(\w+)\s*,\s*select\s*,/,goog.i18n.MessageFormat.prototype.parseBlockType_=function(e){return goog.i18n.MessageFormat.PLURAL_BLOCK_RE_.test(e)?goog.i18n.MessageFormat.BlockType_.PLURAL:goog.i18n.MessageFormat.ORDINAL_BLOCK_RE_.test(e)?goog.i18n.MessageFormat.BlockType_.ORDINAL:goog.i18n.MessageFormat.SELECT_BLOCK_RE_.test(e)?goog.i18n.MessageFormat.BlockType_.SELECT:/^\s*\w+\s*/.test(e)?goog.i18n.MessageFormat.BlockType_.SIMPLE:goog.i18n.MessageFormat.BlockType_.UNKNOWN},goog.i18n.MessageFormat.prototype.parseBlock_=function(e){for(var o=[],t=this.extractParts_(e),a=0;a<t.length;a++){var s={};if(goog.i18n.MessageFormat.Element_.STRING==t[a].type)s.type=goog.i18n.MessageFormat.BlockType_.STRING,s.value=t[a].value;else if(goog.i18n.MessageFormat.Element_.BLOCK==t[a].type){switch(this.parseBlockType_(t[a].value)){case goog.i18n.MessageFormat.BlockType_.SELECT:s.type=goog.i18n.MessageFormat.BlockType_.SELECT,s.value=this.parseSelectBlock_(t[a].value);break;case goog.i18n.MessageFormat.BlockType_.PLURAL:s.type=goog.i18n.MessageFormat.BlockType_.PLURAL,s.value=this.parsePluralBlock_(t[a].value);break;case goog.i18n.MessageFormat.BlockType_.ORDINAL:s.type=goog.i18n.MessageFormat.BlockType_.ORDINAL,s.value=this.parseOrdinalBlock_(t[a].value);break;case goog.i18n.MessageFormat.BlockType_.SIMPLE:s.type=goog.i18n.MessageFormat.BlockType_.SIMPLE,s.value=t[a].value;break;default:goog.asserts.fail("Unknown block type for pattern: "+t[a].value)}}else goog.asserts.fail("Unknown part of the pattern.");o.push(s)}return o},goog.i18n.MessageFormat.prototype.parseSelectBlock_=function(e){var o="",t=goog.i18n.MessageFormat.SELECT_BLOCK_RE_;e=e.replace(t,function(e,t){return o=t,""});var a={};a.argumentIndex=o;for(var s=this.extractParts_(e),r=0;r<s.length;){var g,n=s[r].value;goog.asserts.assertString(n,"Missing select key element."),r++,goog.asserts.assert(r<s.length,"Missing or invalid select value element."),goog.i18n.MessageFormat.Element_.BLOCK==s[r].type?g=this.parseBlock_(s[r].value):goog.asserts.fail("Expected block type."),a[n.replace(/\s/g,"")]=g,r++}return goog.asserts.assertArray(a[goog.i18n.MessageFormat.OTHER_],"Missing other key in select statement."),a},goog.i18n.MessageFormat.prototype.parsePluralBlock_=function(e){var o="",t=0,a=goog.i18n.MessageFormat.PLURAL_BLOCK_RE_;e=e.replace(a,function(e,a,s){return o=a,s&&(t=parseInt(s,10)),""});var s={};s.argumentIndex=o,s.argumentOffset=t;for(var r=this.extractParts_(e),g=0;g<r.length;){var n,i=r[g].value;goog.asserts.assertString(i,"Missing plural key element."),g++,goog.asserts.assert(g<r.length,"Missing or invalid plural value element."),goog.i18n.MessageFormat.Element_.BLOCK==r[g].type?n=this.parseBlock_(r[g].value):goog.asserts.fail("Expected block type."),s[i.replace(/\s*(?:=)?(\w+)\s*/,"$1")]=n,g++}return goog.asserts.assertArray(s[goog.i18n.MessageFormat.OTHER_],"Missing other key in plural statement."),s},goog.i18n.MessageFormat.prototype.parseOrdinalBlock_=function(e){var o="",t=goog.i18n.MessageFormat.ORDINAL_BLOCK_RE_;e=e.replace(t,function(e,t){return o=t,""});var a={};a.argumentIndex=o,a.argumentOffset=0;for(var s=this.extractParts_(e),r=0;r<s.length;){var g=s[r].value;if(goog.asserts.assertString(g,"Missing ordinal key element."),r++,goog.asserts.assert(r<s.length,"Missing or invalid ordinal value element."),goog.i18n.MessageFormat.Element_.BLOCK==s[r].type)var n=this.parseBlock_(s[r].value);else goog.asserts.fail("Expected block type.");a[g.replace(/\s*(?:=)?(\w+)\s*/,"$1")]=n,r++}return goog.asserts.assertArray(a[goog.i18n.MessageFormat.OTHER_],"Missing other key in selectordinal statement."),a},goog.i18n.MessageFormat.prototype.buildPlaceholder_=function(e){goog.asserts.assert(e.length>0,"Literal array is empty.");var o=(e.length-1).toString(10);return goog.i18n.MessageFormat.LITERAL_PLACEHOLDER_+o+"_"};