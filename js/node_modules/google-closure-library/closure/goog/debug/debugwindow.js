goog.provide("goog.debug.DebugWindow"),goog.require("goog.debug.HtmlFormatter"),goog.require("goog.debug.LogManager"),goog.require("goog.debug.Logger"),goog.require("goog.dom.safe"),goog.require("goog.html.SafeHtml"),goog.require("goog.html.SafeStyleSheet"),goog.require("goog.string.Const"),goog.require("goog.structs.CircularBuffer"),goog.require("goog.userAgent"),goog.debug.DebugWindow=function(e,o){this.identifier=e||"",this.outputBuffer=[],this.prefix_=o||"",this.savedMessages_=new goog.structs.CircularBuffer(goog.debug.DebugWindow.MAX_SAVED),this.publishHandler_=goog.bind(this.addLogRecord,this),this.formatter_=new goog.debug.HtmlFormatter(this.prefix_),this.filteredLoggers_={},this.setCapturing(!0),this.enabled_=goog.debug.DebugWindow.isEnabled(this.identifier),goog.global.setInterval(goog.bind(this.saveWindowPositionSize_,this),7500)},goog.debug.DebugWindow.MAX_SAVED=500,goog.debug.DebugWindow.COOKIE_TIME=2592e6,goog.debug.DebugWindow.prototype.welcomeMessage="LOGGING",goog.debug.DebugWindow.prototype.enableOnSevere_=!1,goog.debug.DebugWindow.prototype.win=null,goog.debug.DebugWindow.prototype.winOpening_=!1,goog.debug.DebugWindow.prototype.isCapturing_=!1,goog.debug.DebugWindow.showedBlockedAlert_=!1,goog.debug.DebugWindow.prototype.bufferTimeout_=null,goog.debug.DebugWindow.prototype.lastCall=goog.now(),goog.debug.DebugWindow.prototype.setWelcomeMessage=function(e){this.welcomeMessage=e},goog.debug.DebugWindow.prototype.init=function(){this.enabled_&&this.openWindow_()},goog.debug.DebugWindow.prototype.isEnabled=function(){return this.enabled_},goog.debug.DebugWindow.prototype.setEnabled=function(e){this.enabled_=e,this.enabled_&&this.openWindow_(),this.setCookie_("enabled",e?"1":"0")},goog.debug.DebugWindow.prototype.setForceEnableOnSevere=function(e){this.enableOnSevere_=e},goog.debug.DebugWindow.prototype.isCapturing=function(){return this.isCapturing_},goog.debug.DebugWindow.prototype.setCapturing=function(e){if(e!=this.isCapturing_){this.isCapturing_=e;var o=goog.debug.LogManager.getRoot();e?o.addHandler(this.publishHandler_):o.removeHandler(this.publishHandler_)}},goog.debug.DebugWindow.prototype.getFormatter=function(){return this.formatter_},goog.debug.DebugWindow.prototype.setFormatter=function(e){this.formatter_=e},goog.debug.DebugWindow.prototype.addSeparator=function(){this.write_(goog.html.SafeHtml.create("hr"))},goog.debug.DebugWindow.prototype.hasActiveWindow=function(){return!!this.win&&!this.win.closed},goog.debug.DebugWindow.prototype.clear=function(){this.savedMessages_.clear(),this.hasActiveWindow()&&this.writeInitialDocument()},goog.debug.DebugWindow.prototype.addLogRecord=function(e){if(!this.filteredLoggers_[e.getLoggerName()]){var o=this.formatter_.formatRecordAsHtml(e);this.write_(o),this.enableOnSevere_&&e.getLevel().value>=goog.debug.Logger.Level.SEVERE.value&&this.setEnabled(!0)}},goog.debug.DebugWindow.prototype.write_=function(e){this.enabled_?(this.openWindow_(),this.savedMessages_.add(e),this.writeToLog_(e)):this.savedMessages_.add(e)},goog.debug.DebugWindow.prototype.writeToLog_=function(e){this.outputBuffer.push(e),goog.global.clearTimeout(this.bufferTimeout_),goog.now()-this.lastCall>750?this.writeBufferToLog():this.bufferTimeout_=goog.global.setTimeout(goog.bind(this.writeBufferToLog,this),250)},goog.debug.DebugWindow.prototype.writeBufferToLog=function(){if(this.lastCall=goog.now(),this.hasActiveWindow()){var e=this.win.document.body,o=e&&e.scrollHeight-(e.scrollTop+e.clientHeight)<=100;goog.dom.safe.documentWrite(this.win.document,goog.html.SafeHtml.concat(this.outputBuffer)),this.outputBuffer.length=0,o&&this.win.scrollTo(0,1e6)}},goog.debug.DebugWindow.prototype.writeSavedMessages=function(){for(var e=this.savedMessages_.getValues(),o=0;o<e.length;o++)this.writeToLog_(e[o])},goog.debug.DebugWindow.prototype.openWindow_=function(){if(!this.hasActiveWindow()&&!this.winOpening_){var e=this.getCookie_("dbg","0,0,800,500").split(","),o=Number(e[0]),t=Number(e[1]),g=Number(e[2]),i=Number(e[3]);this.winOpening_=!0,this.win=window.open("",this.getWindowName_(),"width="+g+",height="+i+",toolbar=no,resizable=yes,scrollbars=yes,left="+o+",top="+t+",status=no,screenx="+o+",screeny="+t),this.win||goog.debug.DebugWindow.showedBlockedAlert_||(alert("Logger popup was blocked"),goog.debug.DebugWindow.showedBlockedAlert_=!0),this.winOpening_=!1,this.win&&this.writeInitialDocument()}},goog.debug.DebugWindow.prototype.getWindowName_=function(){return goog.userAgent.IE?this.identifier.replace(/[\s\-\.\,]/g,"_"):this.identifier},goog.debug.DebugWindow.prototype.getStyleRules=function(){return goog.html.SafeStyleSheet.fromConstant(goog.string.Const.from("*{font:normal 14px monospace;}.dbg-sev{color:#F00}.dbg-w{color:#E92}.dbg-sh{background-color:#fd4;font-weight:bold;color:#000}.dbg-i{color:#666}.dbg-f{color:#999}.dbg-ev{color:#0A0}.dbg-m{color:#990}"))},goog.debug.DebugWindow.prototype.writeInitialDocument=function(){if(this.hasActiveWindow()){this.win.document.open();var e=goog.html.SafeHtml.create("div",{class:"dbg-ev",style:goog.string.Const.from("text-align:center;")},goog.html.SafeHtml.concat(this.welcomeMessage,goog.html.SafeHtml.BR,goog.html.SafeHtml.create("small",{},"Logger: "+this.identifier))),o=goog.html.SafeHtml.concat(goog.html.SafeHtml.createStyle(this.getStyleRules()),goog.html.SafeHtml.create("hr"),e,goog.html.SafeHtml.create("hr"));this.writeToLog_(o),this.writeSavedMessages()}},goog.debug.DebugWindow.prototype.setCookie_=function(e,o){var t=goog.debug.DebugWindow.getCookieKey_(this.identifier,e);document.cookie=t+"="+encodeURIComponent(o)+";path=/;expires="+new Date(goog.now()+goog.debug.DebugWindow.COOKIE_TIME).toUTCString()},goog.debug.DebugWindow.prototype.getCookie_=function(e,o){return goog.debug.DebugWindow.getCookieValue_(this.identifier,e,o)},goog.debug.DebugWindow.getCookieKey_=function(e,o){return(o+e).replace(/[;=\s]/g,"_")},goog.debug.DebugWindow.getCookieValue_=function(e,o,t){var g=goog.debug.DebugWindow.getCookieKey_(e,o),i=String(document.cookie),n=i.indexOf(g+"=");if(-1!=n){var r=i.indexOf(";",n);return decodeURIComponent(i.substring(n+g.length+1,-1==r?i.length:r))}return t||""},goog.debug.DebugWindow.isEnabled=function(e){return"1"==goog.debug.DebugWindow.getCookieValue_(e,"enabled")},goog.debug.DebugWindow.prototype.saveWindowPositionSize_=function(){if(this.hasActiveWindow()){var e=this.win.screenX||this.win.screenLeft||0,o=this.win.screenY||this.win.screenTop||0,t=this.win.outerWidth||800,g=this.win.outerHeight||500;this.setCookie_("dbg",e+","+o+","+t+","+g)}},goog.debug.DebugWindow.prototype.addFilter=function(e){this.filteredLoggers_[e]=1},goog.debug.DebugWindow.prototype.removeFilter=function(e){delete this.filteredLoggers_[e]},goog.debug.DebugWindow.prototype.resetBufferWithNewSize=function(e){e>0&&e<5e4&&(this.clear(),this.savedMessages_=new goog.structs.CircularBuffer(e))};