goog.provide("goog.debug.StopTraceDetail"),goog.provide("goog.debug.Trace"),goog.require("goog.array"),goog.require("goog.asserts"),goog.require("goog.debug.Logger"),goog.require("goog.iter"),goog.require("goog.log"),goog.require("goog.structs.Map"),goog.require("goog.structs.SimplePool"),goog.debug.Trace_=function(){this.events_=[],this.outstandingEvents_=new goog.structs.Map,this.startTime_=0,this.tracerOverheadStart_=0,this.tracerOverheadEnd_=0,this.tracerOverheadComment_=0,this.stats_=new goog.structs.Map,this.tracerCount_=0,this.commentCount_=0,this.nextId_=1,this.eventPool_=new goog.structs.SimplePool(0,4e3),this.eventPool_.createObject=function(){return new goog.debug.Trace_.Event_},this.statPool_=new goog.structs.SimplePool(0,50),this.statPool_.createObject=function(){return new goog.debug.Trace_.Stat_};var t=this;this.idPool_=new goog.structs.SimplePool(0,2e3),this.idPool_.setCreateObjectFn(function(){return t.nextId_++}),this.defaultThreshold_=3,this.traceCallbacks_={}},goog.debug.Trace_.prototype.logger_=goog.log.getLogger("goog.debug.Trace"),goog.debug.Trace_.prototype.MAX_TRACE_SIZE=1e3,goog.debug.Trace_.EventType={START:0,STOP:1,COMMENT:2},goog.debug.Trace_.Stat_=function(){this.count=0,this.time=0,this.varAlloc=0},goog.debug.Trace_.Stat_.prototype.type,goog.debug.Trace_.Stat_.prototype.toString=function(){var t=[];return t.push(this.type," ",this.count," (",Math.round(10*this.time)/10," ms)"),this.varAlloc&&t.push(" [VarAlloc = ",this.varAlloc,"]"),t.join("")},goog.debug.Trace_.Event_=function(){},goog.debug.Trace_.Event_.prototype.type,goog.debug.Trace_.Event_.prototype.eventType,goog.debug.Trace_.Event_.prototype.id,goog.debug.Trace_.Event_.prototype.comment,goog.debug.Trace_.Event_.prototype.toTraceString=function(t,e,o){var r=[];if(-1==e?r.push("    "):r.push(goog.debug.Trace_.longToPaddedString_(this.eventTime-e)),r.push(" ",goog.debug.Trace_.formatTime_(this.eventTime-t)),this.eventType==goog.debug.Trace_.EventType.START)r.push(" Start        ");else if(this.eventType==goog.debug.Trace_.EventType.STOP){r.push(" Done ");var a=this.stopTime-this.startTime;r.push(goog.debug.Trace_.longToPaddedString_(a)," ms ")}else r.push(" Comment      ");return r.push(o,this),this.totalVarAlloc>0&&r.push("[VarAlloc ",this.totalVarAlloc,"] "),r.join("")},goog.debug.Trace_.Event_.prototype.toString=function(){return null==this.type?goog.asserts.assert(this.comment):"["+this.type+"] "+this.comment},goog.debug.Trace_.TracerCallbacks=function(){this.start,this.stop,this.comment},goog.debug.Trace_.TRACE_CANCELLED_={wasCancelled:!0},goog.debug.Trace_.NORMAL_STOP_={},goog.debug.Trace_.TracerCallbacks.sequence_=function(t,e){return t?e?function(){t.apply(void 0,arguments),e.apply(void 0,arguments)}:t:e},goog.debug.Trace_.prototype.removeAllListeners=function(){this.traceCallbacks_={}},goog.debug.Trace_.prototype.addTraceCallbacks=function(t){this.traceCallbacks_.start=goog.debug.Trace_.TracerCallbacks.sequence_(this.traceCallbacks_.start,t.start),this.traceCallbacks_.stop=goog.debug.Trace_.TracerCallbacks.sequence_(this.traceCallbacks_.stop,t.stop),this.traceCallbacks_.comment=goog.debug.Trace_.TracerCallbacks.sequence_(this.traceCallbacks_.comment,t.comment)},goog.debug.Trace_.prototype.setStartTime=function(t){this.startTime_=t},goog.debug.Trace_.prototype.initCurrentTrace=function(t){this.reset(t)},goog.debug.Trace_.prototype.clearCurrentTrace=function(){this.reset(0)},goog.debug.Trace_.prototype.clearOutstandingEvents_=function(){this.traceCallbacks_.stop&&goog.iter.forEach(this.outstandingEvents_,function(t){this.traceCallbacks_.stop(t.id,goog.debug.Trace_.TRACE_CANCELLED_)},this),this.outstandingEvents_.clear()},goog.debug.Trace_.prototype.reset=function(t){this.defaultThreshold_=t,this.clearOutstandingEvents_(),this.releaseEvents_(),this.startTime_=goog.debug.Trace_.now(),this.tracerOverheadStart_=0,this.tracerOverheadEnd_=0,this.tracerOverheadComment_=0,this.tracerCount_=0,this.commentCount_=0;for(var e=this.stats_.getKeys(),o=0;o<e.length;o++){var r=e[o],a=this.stats_.get(r);a.count=0,a.time=0,a.varAlloc=0,this.statPool_.releaseObject(a)}this.stats_.clear()},goog.debug.Trace_.prototype.releaseEvents_=function(){for(var t=0;t<this.events_.length;t++){var e=this.events_[t];e.id?this.outstandingEvents_.containsKey(e.id)||(this.idPool_.releaseObject(e.id),this.eventPool_.releaseObject(e)):this.eventPool_.releaseObject(e)}this.events_.length=0},goog.debug.Trace_.prototype.startTracer=function(t,e){var o=goog.debug.Trace_.now(),r=this.getTotalVarAlloc(),a=this.outstandingEvents_.getCount();this.events_.length+a>this.MAX_TRACE_SIZE&&(a>this.MAX_TRACE_SIZE/2&&(goog.log.warning(this.logger_,"Giant thread trace. Clearing outstanding events."),this.clearOutstandingEvents_()),this.events_.length>this.MAX_TRACE_SIZE/2&&(goog.log.warning(this.logger_,"Giant thread trace. Clearing to avoid memory leak."),this.releaseEvents_())),goog.debug.Logger.logToProfilers("Start : "+t);var s=this.eventPool_.getObject();s.stopTime=void 0,s.totalVarAlloc=r,s.eventType=goog.debug.Trace_.EventType.START,s.id=this.idPool_.getObject(),s.comment=t,s.type=e,this.events_.push(s),this.outstandingEvents_.set(String(s.id),s),this.tracerCount_++;var g=goog.debug.Trace_.now();return s.startTime=s.eventTime=g,this.tracerOverheadStart_+=g-o,this.traceCallbacks_.start&&this.traceCallbacks_.start(s.id,s.toString()),s.id},goog.debug.Trace_.prototype.stopTracer=function(t,e){var o,r=goog.debug.Trace_.now();o=0===e?0:e||this.defaultThreshold_;var a,s=this.outstandingEvents_.get(String(t));if(null==s)return null;goog.asserts.assertNumber(t),this.traceCallbacks_.stop&&this.traceCallbacks_.stop(Number(t),goog.debug.Trace_.NORMAL_STOP_),this.outstandingEvents_.remove(String(t));var g=r-s.startTime;if(g<o)for(var n=this.events_.length-1;n>=0;n--){if(this.events_[n]==s){this.events_.splice(n,1),this.idPool_.releaseObject(s.id),this.eventPool_.releaseObject(s);break}}else(a=this.eventPool_.getObject()).id=void 0,a.eventType=goog.debug.Trace_.EventType.STOP,a.startTime=s.startTime,a.comment=s.comment,a.type=s.type,a.stopTime=a.eventTime=r,this.events_.push(a);var i=s.type,c=null;i&&((c=this.getStat_(i)).count++,c.time+=g),a&&(goog.debug.Logger.logToProfilers("Stop : "+a.comment),a.totalVarAlloc=this.getTotalVarAlloc(),c&&(c.varAlloc+=a.totalVarAlloc-s.totalVarAlloc));var _=goog.debug.Trace_.now();return this.tracerOverheadEnd_+=_-r,g},goog.debug.Trace_.prototype.setGcTracer=function(t){this.gcTracer_=t},goog.debug.Trace_.prototype.getTotalVarAlloc=function(){var t=this.gcTracer_;return t&&t.isTracing()?t.totalVarAlloc:-1},goog.debug.Trace_.prototype.addComment=function(t,e,o){var r=goog.debug.Trace_.now(),a=o||r,s=this.eventPool_.getObject();if(s.startTime=void 0,s.stopTime=void 0,s.id=void 0,s.eventType=goog.debug.Trace_.EventType.COMMENT,s.eventTime=a,s.type=e,s.comment=t,s.totalVarAlloc=this.getTotalVarAlloc(),this.commentCount_++,o){this.traceCallbacks_.comment&&this.traceCallbacks_.comment(s.toString(),o);for(var g=this.events_.length,n=0;n<g;n++){if(this.events_[n].eventTime>a){goog.array.insertAt(this.events_,s,n);break}}n==g&&this.events_.push(s)}else this.traceCallbacks_.comment&&this.traceCallbacks_.comment(s.toString()),this.events_.push(s);var i=s.type;i&&this.getStat_(i).count++;this.tracerOverheadComment_+=goog.debug.Trace_.now()-r},goog.debug.Trace_.prototype.getStat_=function(t){var e=this.stats_.get(t);return e||((e=this.statPool_.getObject()).type=t,this.stats_.set(t,e)),e},goog.debug.Trace_.prototype.getFormattedTrace=function(){return this.toString()},goog.debug.Trace_.prototype.toString=function(){for(var t=[],e=-1,o=[],r=0;r<this.events_.length;r++){var a=this.events_[r];a.eventType==goog.debug.Trace_.EventType.STOP&&o.pop(),t.push(" ",a.toTraceString(this.startTime_,e,o.join(""))),e=a.eventTime,t.push("\n"),a.eventType==goog.debug.Trace_.EventType.START&&o.push("|  ")}if(0!=this.outstandingEvents_.getCount()){var s=goog.debug.Trace_.now();t.push(" Unstopped timers:\n"),goog.iter.forEach(this.outstandingEvents_,function(e){t.push("  ",e," (",s-e.startTime," ms, started at ",goog.debug.Trace_.formatTime_(e.startTime),")\n")})}var g=this.stats_.getKeys();for(r=0;r<g.length;r++){var n=this.stats_.get(g[r]);n.count>1&&t.push(" TOTAL ",n,"\n")}return t.push("Total tracers created ",this.tracerCount_,"\n","Total comments created ",this.commentCount_,"\n","Overhead start: ",this.tracerOverheadStart_," ms\n","Overhead end: ",this.tracerOverheadEnd_," ms\n","Overhead comment: ",this.tracerOverheadComment_," ms\n"),t.join("")},goog.debug.Trace_.longToPaddedString_=function(t){var e="";return(t=Math.round(t))<1e3&&(e=" "),t<100&&(e="  "),t<10&&(e="   "),e+t},goog.debug.Trace_.formatTime_=function(t){var e=(t=Math.round(t))%1e3;return String(100+t/1e3%60).substring(1,3)+"."+String(1e3+e).substring(1,4)},goog.debug.Trace_.now=function(){return goog.now()},goog.debug.Trace=new goog.debug.Trace_,goog.debug.StopTraceDetail=function(){this.wasCancelled};