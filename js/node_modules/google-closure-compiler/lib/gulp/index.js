"use strict";class CustomError extends Error{constructor(e,t){t instanceof Error?(super(`Error in ${e}`),this.original=t,this.stack=`${this.stack.split("\n").slice(0,2).join("\n")}\n${t.stack}`):super(`${e}: ${t}`)}}module.exports=function(e){const t=require("./concat-to-json"),r=require("./json-to-vinyl"),s=require("stream"),{getNativeImagePath:i,getFirstSupportedPlatform:o}=require("../utils"),n=require("vinyl-sourcemaps-apply"),a=require("chalk"),l=require("vinyl"),u=e?e.extraArguments:void 0;let c,p;try{c=require("gulp-util").PluginError}catch(e){c=CustomError}try{p=require("gulp-util").log}catch(e){p=console}class h extends s.Transform{constructor(t,r){super({objectMode:!0}),r=r||{},this.compilationOptions_=t,this.streamMode_=r.streamMode||"BOTH",this.logger_=r.logger||p,this.PLUGIN_NAME_=r.pluginName||"gulp-google-closure-compiler",this.fileList_=[],this._streamInputRequired=!1!==r.requireStreamInput;const s=Boolean(e&&e.jsMode);let i=r&&r.platform||(s?["javascript"]:["native","java","javascript"]);Array.isArray(i)||(i=[i]),this.platform=o(i)}src(){return this._streamInputRequired=!1,process.nextTick(()=>{const e=new s.Readable({read:function(){return new l}});e.pipe(this),e.push(null)}),this}_transform(e,t,r){if(e&&!e.isNull()){if(e.isStream())return this.emit("error",new c(this.PLUGIN_NAME_,"Streaming not supported")),void r();e.sourceMap&&"javascript"===this.platform&&(this.compilationOptions_.createSourceMap=!0),this.fileList_.push(e),r()}else r()}_flush(e){let r;if(this.fileList_.length>0)r=t(this.fileList_);else{if(this._streamInputRequired)return this.push(null),void e();r=[]}const o=new("javascript"===this.platform?require("../node/closure-compiler-js"):require("../node/closure-compiler"))(this.compilationOptions_,u);if("javascript"===this.platform)try{o.run(r,(t,r,s)=>{this._compilationComplete(t,r,s),e()})}catch(t){let r=t.stack;return/Bad value for | Unhandled flag: /.test(t.message)&&(r=t.message.replace(/^(java\.lang\.RuntimeException|Class[a-zA-Z0-9_\$]+): /,"")),this._compilationComplete(1,[],r),void e()}else{"native"===this.platform&&(o.JAR_PATH=null,o.javaPath=i());let t="",n="";o.commandArguments.push("--json_streams",this.streamMode_);const a=o.run();a.stdout.on("data",e=>{t+=e}),a.stderr.on("data",e=>{n+=e}),a.on("error",t=>{this.emit("error",new c(this.PLUGIN_NAME_,"Process spawn error. Is java in the path?\n"+t.message)),e()}),a.stdin.on("error",e=>{n+=`Error writing to stdin of the compiler. ${e.message}`}),Promise.all([new Promise(e=>a.on("close",e)),new Promise(e=>a.stdout.on("end",e)),new Promise(e=>a.stderr.on("end",e))]).then(r=>{const s=r[0];let i=[];if(t.trim().length>0)try{i=JSON.parse(t)}catch(t){return this.emit("error",new c(this.PLUGIN_NAME_,"Error parsing json encoded files")),void e()}this._compilationComplete(s,i,n),e()}).catch(t=>{this.emit("error",new c(this.PLUGIN_NAME_,t,{showStack:!0})),e()});const l=new s.Readable({read:function(){}});l.pipe(a.stdin),process.nextTick(()=>{l.push(JSON.stringify(r)),l.push(null)})}}_compilationComplete(e,t,s){if(s&&s.trim().length>0){(this.logger_.warn?this.logger_.warn:this.logger_)(`${a.yellow(this.PLUGIN_NAME_)}: ${s}`)}0!==e&&this.emit("error",new c(this.PLUGIN_NAME_,"Compilation errors occurred"));let i=r(t);for(let e=0;e<i.length;e++)i[e].sourceMap&&n(i[e],i[e].sourceMap),this.push(i[e])}}return(e,t)=>new h(e,t)};