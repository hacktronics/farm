/**
 * @license
 * Copyright 2020 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
import{toolboxTestBlocks,toolboxTestBlocksInit}from"@blockly/block-test";import*as Blockly from"blockly/core";import*as BlocklyDart from"blockly/dart";import*as BlocklyJS from"blockly/javascript";import*as BlocklyLua from"blockly/lua";import*as BlocklyPHP from"blockly/php";import*as BlocklyPython from"blockly/python";import{downloadWorkspaceScreenshot}from"../screenshot";import toolboxCategories from"../toolboxCategories";import toolboxSimple from"../toolboxSimple";import{id}from"./id";import{addCodeEditor}from"./monaco";import{addGUIControls}from"./options";import{LocalStorageState}from"./state";import{renderCheckbox,renderCodeTab,renderPlayground}from"./ui";let CreateWorkspaceFn,PlaygroundTab,PlaygroundAPI;export function createPlayground(e,o=Blockly.inject,t={toolbox:toolboxCategories},n={},a){const{blocklyDiv:r,minimizeButton:l,monacoDiv:d,guiContainer:c,playgroundDiv:i,tabButtons:s,tabsDiv:m}=renderPlayground(e);return addCodeEditor(d,{model:null,language:"xml",minimap:{enabled:!1},theme:"vs-dark",scrollBeyondLastLine:!1,automaticLayout:!0},a).then(e=>{let a;const d=window.monaco.editor.createModel(""),u=e.createContextKey("isEditorXml",!0),p=new LocalStorageState(`playgroundState_${id}`,{activeTab:"XML",autoGenerate:!n||null==n.auto||n.auto,workspaceXml:""});function y(o,t,n,r){const l=renderCodeTab(o);l.setAttribute("data-tab",o),m.appendChild(l);const c=window.monaco.editor.createModel("",t);return{generate:function(){let o,t=c;try{o=n(a)}catch(n){console.error(n),o=n.message,t=d,e.updateOptions({wordWrap:!0})}t.pushEditOperations([],[{range:t.getFullModelRange(),text:o}],()=>null),e.setModel(t),e.setSelection(new window.monaco.Range(0,0,0,0))},state:{name:o,model:c,language:t,viewState:void 0},tabElement:l}}p.load();const k=o=>{v=o,f=o.generate;const t="XML"==o.state.name;e.setModel(v.state.model),e.updateOptions({readOnly:!t,wordWrap:!1}),Object.values(b).forEach(e=>e.tabElement.style.background=e.tabElement==o.tabElement?"#1E1E1E":"#2D2D2D"),u.set(t),p.set("activeTab",o.state.name),p.save()},g=()=>{if(p.get("autoGenerate")){if(C&&x){x=!1;try{Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(C),a)}catch(e){console.warn("Failed to auto import.",e)}}f&&f();let e="";try{e=Blockly.Xml.domToPrettyText(Blockly.Xml.workspaceToDom(a))}catch(e){console.warn("Failed to auto save.",e)}p.set("workspaceXml",e),p.save()}},b={XML:y("XML","xml",e=>Blockly.Xml.domToPrettyText(Blockly.Xml.workspaceToDom(e))),JavaScript:y("JavaScript","javascript",e=>(BlocklyJS||Blockly.JavaScript).workspaceToCode(e)),Python:y("Python","python",e=>(BlocklyPython||Blockly.Python).workspaceToCode(e)),Dart:y("Dart","dart",e=>(BlocklyDart||Blockly.Dart).workspaceToCode(e)),Lua:y("Lua","lua",e=>(BlocklyLua||Blockly.Lua).workspaceToCode(e)),PHP:y("PHP","php",e=>(BlocklyPHP||Blockly.PHP).workspaceToCode(e))};m.addEventListener("click",o=>{const t=o.target.getAttribute("data-tab");if(!t)return;const n=b[t];v.state.viewState=e.saveViewState(),k(n),g(),e.restoreViewState(v.state.viewState),e.focus()});const C=p.get("workspaceXml")||"",w=b.XML.state.model;let x=!0;w.setValue(C),w.onDidChangeContent(()=>{p.set("workspaceXml",w.getValue()),p.save()});const h=p.get("activeTab");let f,v=b[h];v&&k(v);const B=addGUIControls(e=>{a=o(r,e),toolboxTestBlocksInit(a);const t=a.configureContextMenu;return a.configureContextMenu=(e,o)=>{t&&t.call(null,e,o);const n={text:"Download Screenshot",enabled:a.getTopBlocks().length,callback:function(){downloadWorkspaceScreenshot(a)}};e.push(n)},g(),a.addChangeListener(e=>{"ui"!==e.type&&g()}),a},t,{disableResize:!0,toolboxes:n.toolboxes||{categories:toolboxCategories,simple:toolboxSimple,"test blocks":toolboxTestBlocks}}),E=B.domElement;E.removeChild(E.firstChild),E.style.position="relative",E.style.minWidth="100%",c.appendChild(E),l.addEventListener("click",e=>{"none"===i.style.display?(i.style.display="flex",l.textContent="Collapse"):(i.style.display="none",l.textContent="Expand"),Blockly.svgResize(a)});const T={state:p,addAction:B.addAction,addCheckboxAction:B.addCheckboxAction,addGenerator:function(e,o,t){if(!e||!o)throw Error("usage: addGenerator(label, generator, language?);");b[e]=y(e,t||"javascript",e=>o.workspaceToCode(e)),h===e&&k(b[e])},getCurrentTab:function(){return v},getGUI:function(){return B},getWorkspace:function(){return a},removeGenerator:function(e){if(!e)throw Error("usage: removeGenerator(label);");if(!(e in b))throw Error("removeGenerator called on invalid label: "+e);const o=b[e];m.removeChild(o.tabElement),delete b[e];const t=Object.keys(b);h===e&&t.length&&k(b[t[0]])}};return registerTabButtons(e,T,s,g),registerEditorCommands(e,T),T})}function registerTabButtons(e,o,t,n){const[a,r]=renderCheckbox("autoGenerate","Auto");a.checked=o.state.get("autoGenerate"),a.addEventListener("change",e=>{const t=e.target;o.state.set("autoGenerate",!!t.checked),o.state.save(),n()}),t.appendChild(a),t.appendChild(r)}function registerEditorCommands(e,o){const t=()=>{if("XML"!==o.getCurrentTab().state.name)return;const t=e.getModel().getValue(),n=o.getWorkspace();Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(t),n)},n=()=>{o.getCurrentTab().generate()};e.addAction({id:"import-xml",label:"Import from XML",keybindings:[window.monaco.KeyMod.CtrlCmd|window.monaco.KeyCode.Enter],precondition:"isEditorXml",contextMenuGroupId:"playground",contextMenuOrder:0,run:t}),e.addAction({id:"export-xml",label:"Export to XML",keybindings:[window.monaco.KeyMod.CtrlCmd|window.monaco.KeyCode.KEY_S],precondition:"isEditorXml",contextMenuGroupId:"playground",contextMenuOrder:1,run:n}),e.addAction({id:"clean-xml",label:"Clean XML",precondition:"isEditorXml",contextMenuGroupId:"playground",contextMenuOrder:2,run:()=>{const o=e.getModel(),t=o.getValue().replace(/ (x|y|id)="[^"]*"/gim,"");o.pushEditOperations([],[{range:o.getFullModelRange(),text:t}],()=>null),e.setSelection(new window.monaco.Range(0,0,0,0))}}),e.addAction({id:"generate",label:"Generate",keybindings:[window.monaco.KeyMod.CtrlCmd|window.monaco.KeyCode.KEY_S],precondition:"!isEditorXml",contextMenuGroupId:"playground",contextMenuOrder:1,run:n}),document.addEventListener("keydown",e=>{const o=e.metaKey||e.ctrlKey;o&&e.keyCode===Blockly.utils.KeyCodes.S?(n(),e.preventDefault()):o&&e.keyCode===Blockly.utils.KeyCodes.ENTER&&(t(),e.preventDefault())})}