/**
 * @license
 * Copyright 2020 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
import*as Blockly from"blockly/core";import*as dat from"dat.gui";import{DebugRenderer}from"../debugRenderer";import{disableLogger,enableLogger}from"../logger";import{HashState}from"./hash_state";import{populateRandom}from"../populateRandom";import{spaghetti}from"../spaghetti";import{id}from"./id";import toolboxCategories from"../toolboxCategories";import toolboxSimple from"../toolboxSimple";import darkTheme from"@blockly/theme-dark";import deuteranopiaTheme from"@blockly/theme-deuteranopia";import themeTritanopia from"@blockly/theme-tritanopia";import highContrastTheme from"@blockly/theme-highcontrast";const assign=require("lodash.assign"),merge=require("lodash.merge");export function addGUIControls(o,e,t={}){const n=loadGUIState(),i=t.toolboxes||{categories:toolboxCategories,simple:toolboxSimple},a=initDefaultToolbox(e,i);n.toolboxName=n.toolboxName||a,n.options.toolbox=i[n.toolboxName];const l=getThemes(e),s=e.theme?e.theme.name:"classic";n.themeName=n.themeName||s,n.options.theme=l[n.themeName];const r={...e,...n.options};initDebugRenderer(n.debug);let d=o(r);const c=!t.disableResize,p=new dat.GUI({autoPlace:!1,closeOnTop:!0,width:250,load:n.guiObject||{}}),m=p.domElement;m.style.position="absolute",m.style.zIndex="1000",m.onclick=()=>{n.guiObject=p.getSaveObject(),saveGUIState(n,a,s)};const h=()=>{const o=d.getMetrics();d.RTL?(m.style.left=o.absoluteLeft+"px",m.style.right="auto"):(m.style.left="auto",o.toolboxPosition===Blockly.TOOLBOX_AT_RIGHT?m.style.right=o.toolboxWidth+"px":m.style.right="0"),m.style.top=o.absoluteTop+"px"};c&&h();const g=d.getInjectionDiv().parentNode;g.style.position="relative",g.appendChild(m);const b=Object.assign({},d.options),u=()=>{const e=Blockly.Xml.workspaceToDom(d);d.dispose(),d=o(r),Blockly.Xml.domToWorkspace(e,d),c&&h(),n.guiObject=p.getSaveObject(),saveGUIState(n,a,s),merge(b,d.options),p.updateDisplay()},f=(o,e)=>{r[o]=e,n.options[o]=e,u()};p.add({Reset:()=>{Object.keys(r).forEach(o=>delete r[o]),assign(r,e),Object.keys(n.options).forEach(o=>delete n.options[o]),initDebugRenderer(n.debug,!0),n.toolboxName=a,n.themeName=s,Object.values(p.__folders).forEach(o=>o.close()),u()}},"Reset");const y=p.addFolder("Options");setTooltip(y,"Options that affect the appearance of the workspace."),openFolderIfOptionSelected(y,n,n.options,["rtl","renderer","toolboxPosition","horizontalLayout"]),setTooltip(y.add(b,"RTL").name("rtl").onChange(o=>f("rtl",o)),"If true, mirror the editor (for Arabic or Hebrew locales)."),populateRendererOption(y,b,f),populateThemeOption(y,n,l,s,f),populateToolboxOption(y,n,i,a,f),populateToolboxSidesOption(y,b,r,n,u);const k=y.addFolder("Basic");setTooltip(k,"Basic options like sound, comment etc..."),populateBasicOptions(k,b,n,f);const T=y.addFolder("Move");setTooltip(T,"Move options like scrollbars, drag etc..."),populateMoveOptions(T,b,r,f),openFolderIfOptionSelected(T,n,n.options,["move"]);const O=y.addFolder("Zoom");setTooltip(O,"Zoom options like controls, startScale etc..."),populateZoomOptions(O,b,r,f),openFolderIfOptionSelected(T,n,n.options,["zoom"]);const x=y.addFolder("Grid");setTooltip(x,"Grid options like spacing, length etc..."),populateGridOptions(x,b,r,f),openFolderIfOptionSelected(T,n,n.options,["grid"]);const S=p.addFolder("Debug");setTooltip(S,"Rendering debug configuration."),populateDebugOptions(S,n,u);const C=p.addFolder("Actions"),w={},A={},v=p;return v.addCheckboxAction=(o,e,t,n,i)=>{A[o]=!!n;let a=C;t&&(w[t]?a=w[t]:(a=C.addFolder(t),a.open(),w[t]=a));const l=a.add(A,o);return i&&setTooltip(l,i),o&&l.name(o),l.listen().onFinishChange(o=>{e(d,o)}),l},v.addAction=(o,e,t,n)=>{A[o]=()=>{e(d)};let i=C;t&&(w[t]?i=w[t]:(i=C.addFolder(t),i.open(),w[t]=i));const a=i.add(A,o);return n&&setTooltip(a,n),o&&a.name(o),a},v.getWorkspace=()=>d,addActions(v,d),v}function saveGUIState(o,e,t){delete o.options.toolbox,delete o.options.theme;const n=`guiState_${id}`;localStorage.setItem(n,JSON.stringify(o));const i=Object.assign({},o.options);o.toolboxName!==e&&(i.toolbox=o.toolboxName),o.themeName!==t&&(i.theme=o.themeName),window.location.hash=HashState.save(i)}function loadGUIState(){const o=`guiState_${id}`,e=JSON.parse(localStorage.getItem(o))||{options:{},debug:{}};return window.location.hash&&HashState.parse(window.location.hash,e.options),e.options.toolbox&&(e.toolboxName=e.options.toolbox,delete e.options.toolbox),e.options.theme&&(e.themeName=e.options.theme,delete e.options.theme),e}function openFolderIfOptionSelected(o,e,t,n){e.guiObject||n.forEach(e=>{if(null!=t[e])for(o.open();o.parent;)(o=o.parent).open()})}function initDefaultToolbox(o,e){const t=o.toolbox,n=Object.keys(e).filter(o=>e[o]==t);return t&&!n.length?(e.default=t,"default"):n.length?n[0]:Object.keys(e)[0]}function populateBasicOptions(o,e,t,n){setTooltip(o.add(e,"readOnly").onChange(o=>n("readOnly",o)),"If true, prevent the user from editing. Suppresses the toolbox and trashcan."),setTooltip(o.add(e,"hasTrashcan").name("trashCan").onChange(o=>n("trashcan",o)),"Displays or hides the trashcan."),setTooltip(o.add(e,"hasSounds").name("sounds").onChange(o=>n("sounds",o)),"If false, don't play sounds (e.g. click and delete)."),setTooltip(o.add(e,"disable").onChange(o=>n("disable",o)),"Allows blocks to be disabled. "),setTooltip(o.add(e,"collapse").onChange(o=>n("collapse",o)),"Allows blocks to be collapsed or expanded."),setTooltip(o.add(e,"comments").onChange(o=>n("comments",o)),"Allows blocks to have comments."),openFolderIfOptionSelected(o,t,t.options,["readOnly","trashcan","sounds","disable","collapse","comments"])}function populateRendererOption(o,e,t){const n=Blockly.blockRendering.rendererMap_||Blockly.registry&&Blockly.registry.typeMap_.renderer;setTooltip(o.add(e,"renderer",Object.keys(n)).onChange(o=>t("renderer",o)),"The renderer used by Blockly.")}function populateToolboxOption(o,e,t,n,i){setTooltip(o.add(e,"toolboxName").options(Object.keys(t)).name("toolbox").onChange(o=>{e.toolboxName=o,i("toolbox",t[o])}),"The toolbox used by Blockly."),e.toolboxName!==n&&openFolderIfOptionSelected(o,e,e.options,["toolbox"])}function populateToolboxSidesOption(o,e,t,n,i){const a={top:0,bottom:1,left:2,right:3};setTooltip(o.add(e,"toolboxPosition",a).name("toolboxPosition").onChange(o=>{const e=Object.keys(a).find(e=>a[e]==o);t.horizontalLayout="top"==e||"bottom"==e,t.toolboxPosition="top"==e||"left"==e?"start":"end",n.options.toolboxPosition=t.toolboxPosition,n.options.horizontalLayout=t.horizontalLayout,i()}),"The toolbox position.")}function getThemes(o){let e;return Blockly.registry&&Blockly.registry.typeMap_.theme?e=Blockly.registry.typeMap_.theme:(e={classic:Blockly.Themes.Classic,dark:darkTheme,deuteranopia:deuteranopiaTheme,tritanopia:themeTritanopia,highcontrast:highContrastTheme},o.theme&&(e[o.theme.name]=o.theme)),e}function populateThemeOption(o,e,t,n,i){setTooltip(o.add(e,"themeName").options(Object.keys(t)).name("theme").onChange(o=>{e.themeName=o,i("theme",t[o])}),"The theme used by Blockly."),e.themeName!==n&&openFolderIfOptionSelected(o,e,e.options,["theme"])}function populateMoveOptions(o,e,t,n){setTooltip(o.add(e.moveOptions,"scrollbars").onChange(o=>n("move",{...t.move,scrollbars:o})),"True if the workspace has scrollbars."),setTooltip(o.add(e.moveOptions,"wheel").onChange(o=>n("move",{...t.move,wheel:o})),"True if the workspace can be scrolled with the mouse wheel."),setTooltip(o.add(e.moveOptions,"drag").onChange(o=>n("move",{...t.move,drag:o})),"True if the workspace can be dragged with the mouse.")}function populateZoomOptions(o,e,t,n){setTooltip(o.add(e.zoomOptions,"controls").onChange(o=>n("zoom",{...t.zoom,controls:o})),"Set to true to show zoom-centre, zoom-in, and zoom-out buttons."),setTooltip(o.add(e.zoomOptions,"wheel").onChange(o=>n("zoom",{...t.zoom,wheel:o})),"Set to true to allow the mouse wheel to zoom."),setTooltip(o.add(e.zoomOptions,"startScale",.1,4).onChange(o=>n("zoom",{...t.zoom,startScale:o})),"Initial magnification factor. For applications with multiple levels, startScale is often set to a higher value on the first level, then incrementally decreased as subsequent levels become more complex."),setTooltip(o.add(e.zoomOptions,"maxScale",1,20).onChange(o=>n("zoom",{...t.zoom,maxScale:o})).step(1),"Maximum multiplication factor for how far one can zoom in."),setTooltip(o.add(e.zoomOptions,"minScale",.1,1).onChange(o=>n("zoom",{...t.zoom,minScale:o})).step(.05),"Minimum multiplication factor for how far one can zoom out.")}function populateGridOptions(o,e,t,n){setTooltip(o.add(e.gridOptions,"spacing",0,50).onChange(o=>n("grid",{...t.grid,spacing:o})),"The distance between the grid's points."),setTooltip(o.add(e.gridOptions,"length",0,30).onChange(o=>n("grid",{...t.grid,length:o})),"The shape of the grid points. A length of 0 results in an invisible grid (but still one that may be snapped to), a length of 1 (the default value) results in dots, a longer length results in crosses, and a length equal or greater than the spacing results in graph paper."),setTooltip(o.addColor(e.gridOptions,"colour").onChange(o=>n("grid",{...t.grid,colour:o})),"The colour of the grid points."),setTooltip(o.add(e.gridOptions,"snap").onChange(o=>n("grid",{...t.grid,snap:o})),"Whether blocks should snap to the nearest grid point when placed on the workspace.")}function setTooltip(o,e){o.domElement.parentElement.setAttribute("title",e)}function initDebugRenderer(o,e){DebugRenderer.init(),Object.keys(DebugRenderer.config).map(t=>{(null==o[t]||e)&&(o[t]=!1),DebugRenderer.config[t]=o[t]})}function populateDebugOptions(o,e,t){const n=e.debug;Object.keys(DebugRenderer.config).map(e=>{o.add(n,e,0,50).onChange(o=>{n[e]=o,DebugRenderer.config[e]=n[e],t()})}),openFolderIfOptionSelected(o,e,n,Object.keys(DebugRenderer.config).filter(o=>!!n[o]))}function addActions(o,e){o.addAction("Show",o=>{o.setVisible(!0)},"Visibility","Show the workspace."),o.addAction("Hide",o=>{o.setVisible(!1)},"Visibility","Hide the workspace."),o.addAction("Clear",o=>{o.clear()},"Blocks","Clear all the blocks from the workspace."),o.addAction("Format",o=>{o.cleanUp()},"Blocks","Format the blocks on the workspace."),o.addAction("Undo",o=>{o.undo()},"Undo/Redo","Undo last action."),o.addAction("Redo",o=>{o.undo(!0)},"Undo/Redo","Redo last action."),o.addAction("Clear Undo Stack",o=>{o.clearUndo()},"Undo/Redo","Clear the undo stack."),o.addAction("Zoom reset",o=>{o.setScale(o.options.zoomOptions.startScale),o.scrollCenter()},"Scale","Reset zoom."),o.addAction("Zoom center",o=>{o.scrollCenter()},"Scale","Center the workspace."),o.addAction("Zoom to Fit",o=>{o.zoomToFit()},"Scale","Zoom the blocks to fit in the workspace if possible."),o.addAction("Random Blocks",o=>{populateRandom(o,100)},"Stress Test","Populate the workspace with a random set of blocks, for testing."),o.addAction("Spaghetti!",o=>{spaghetti(o,8)},"Stress Test","Populate the workspace with nested if-statement blocks, for testing."),o.addCheckboxAction("Log Events",function(o,e){e?enableLogger(o):disableLogger(o)},"Logging",!1,"Toggle console logging of workspace events."),o.addCheckboxAction("Log Flyout Events",function(o,e){e?o.getFlyout()&&enableLogger(o.getFlyout().getWorkspace()):o.getFlyout()&&disableLogger(o.getFlyout().getWorkspace())},"Logging",!1,"Toggle console logging of flyout events."),o.addCheckboxAction("Keyboard Nav",(o,e)=>{e?Blockly.navigation.enableKeyboardAccessibility():Blockly.navigation.disableKeyboardAccessibility()},"Accessibility",e.keyboardAccessibilityMode,"Toggle keyboard accessibility mode"),o.addCheckboxAction("Navigate All",(o,e)=>{Blockly.ASTNode.NAVIGATE_ALL_FIELDS=e},"Accessibility",Blockly.ASTNode.NAVIGATE_ALL_FIELDS,"Toggle navigating to all fields. False to only navigate to clickable fields.")}