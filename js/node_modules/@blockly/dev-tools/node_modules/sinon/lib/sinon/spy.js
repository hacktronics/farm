"use strict";var arrayProto=require("@sinonjs/commons").prototypes.array,createProxy=require("./proxy"),extend=require("./util/core/extend"),functionName=require("@sinonjs/commons").functionName,getPropertyDescriptor=require("./util/core/get-property-descriptor"),deepEqual=require("@sinonjs/samsam").deepEqual,isEsModule=require("./util/core/is-es-module"),proxyCallUtil=require("./proxy-call-util"),walkObject=require("./util/core/walk-object"),wrapMethod=require("./util/core/wrap-method"),valueToString=require("@sinonjs/commons").valueToString,forEach=arrayProto.forEach,pop=arrayProto.pop,push=arrayProto.push,slice=arrayProto.slice,filter=Array.prototype.filter,uuid=0;function matches(e,t,r){var i=e.matchingArguments;return!!(i.length<=t.length&&deepEqual(slice(t,0,i.length),i))&&(!r||i.length===t.length)}var spyApi={withArgs:function(){var e=slice(arguments),t=pop(this.matchingFakes(e,!0));if(t)return t;var r=this,i=this.instantiateFake();return i.matchingArguments=e,i.parent=this,push(this.fakes,i),i.withArgs=function(){return r.withArgs.apply(r,arguments)},forEach(r.args,function(e,t){matches(i,e)&&(proxyCallUtil.incrementCallCount(i),push(i.thisValues,r.thisValues[t]),push(i.args,e),push(i.returnValues,r.returnValues[t]),push(i.exceptions,r.exceptions[t]),push(i.callIds,r.callIds[t]))}),proxyCallUtil.createCallProperties(i),i},matchingFakes:function(e,t){return filter.call(this.fakes,function(r){return matches(r,e,t)})}},delegateToCalls=proxyCallUtil.delegateToCalls;function createSpy(e){var t,r=e;"function"!=typeof r?r=function(){}:t=functionName(r);var i=createProxy(r,r);return extend.nonEnum(i,spyApi),extend.nonEnum(i,{displayName:t||"spy",fakes:[],instantiateFake:createSpy,id:"spy#"+uuid++}),i}function spy(e,t,r){var i,n;if(isEsModule(e))throw new TypeError("ES Modules cannot be spied");return t||"function"!=typeof e?t||"object"!=typeof e?e||t?r?(i={},n=getPropertyDescriptor(e,t),forEach(r,function(e){i[e]=createSpy(n[e])}),wrapMethod(e,t,i)):wrapMethod(e,t,createSpy(e[t])):createSpy(function(){}):walkObject(spy,e):createSpy(e)}delegateToCalls(spyApi,"callArg",!1,"callArgWith",!0,function(){throw new Error(this.toString()+" cannot call arg since it was not yet invoked.")}),spyApi.callArgWith=spyApi.callArg,delegateToCalls(spyApi,"callArgOn",!1,"callArgOnWith",!0,function(){throw new Error(this.toString()+" cannot call arg since it was not yet invoked.")}),spyApi.callArgOnWith=spyApi.callArgOn,delegateToCalls(spyApi,"throwArg",!1,"throwArg",!1,function(){throw new Error(this.toString()+" cannot throw arg since it was not yet invoked.")}),delegateToCalls(spyApi,"yield",!1,"yield",!0,function(){throw new Error(this.toString()+" cannot yield since it was not yet invoked.")}),spyApi.invokeCallback=spyApi.yield,delegateToCalls(spyApi,"yieldOn",!1,"yieldOn",!0,function(){throw new Error(this.toString()+" cannot yield since it was not yet invoked.")}),delegateToCalls(spyApi,"yieldTo",!1,"yieldTo",!0,function(e){throw new Error(this.toString()+" cannot yield to '"+valueToString(e)+"' since it was not yet invoked.")}),delegateToCalls(spyApi,"yieldToOn",!1,"yieldToOn",!0,function(e){throw new Error(this.toString()+" cannot yield to '"+valueToString(e)+"' since it was not yet invoked.")}),extend(spy,spyApi),module.exports=spy;