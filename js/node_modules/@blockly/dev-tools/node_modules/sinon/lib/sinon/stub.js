"use strict";var arrayProto=require("@sinonjs/commons").prototypes.array,behavior=require("./behavior"),behaviors=require("./default-behaviors"),createProxy=require("./proxy"),functionName=require("@sinonjs/commons").functionName,hasOwnProperty=require("@sinonjs/commons").prototypes.object.hasOwnProperty,isNonExistentProperty=require("./util/core/is-non-existent-property"),spy=require("./spy"),extend=require("./util/core/extend"),getPropertyDescriptor=require("./util/core/get-property-descriptor"),isEsModule=require("./util/core/is-es-module"),wrapMethod=require("./util/core/wrap-method"),throwOnFalsyObject=require("./throw-on-falsy-object"),valueToString=require("@sinonjs/commons").valueToString,walkObject=require("./util/core/walk-object"),forEach=arrayProto.forEach,pop=arrayProto.pop,slice=arrayProto.slice,sort=arrayProto.sort,uuid=0;function createStub(e){var r;function t(){var e=slice(arguments),t=r.matchingFakes(e);return getCurrentBehavior(pop(sort(t,function(e,r){return e.matchingArguments.length-r.matchingArguments.length}))||r).invoke(this,arguments)}r=createProxy(t,e||t),extend.nonEnum(r,spy),extend.nonEnum(r,stub);var o=e?functionName(e):null;return extend.nonEnum(r,{fakes:[],instantiateFake:createStub,displayName:o||"stub",defaultBehavior:null,behaviors:[],id:"stub#"+uuid++}),r}function stub(e,r){if(arguments.length>2)throw new TypeError("stub(obj, 'meth', fn) has been removed, see documentation");if(isEsModule(e))throw new TypeError("ES Modules cannot be stubbed");if(throwOnFalsyObject.apply(null,arguments),isNonExistentProperty(e,r))throw new TypeError("Cannot stub non-existent property "+valueToString(r));var t=getPropertyDescriptor(e,r),o="object"==typeof e||"function"==typeof e,n=void 0===r&&o,i=!e&&void 0===r,a=o&&void 0!==r&&(void 0===t||"function"!=typeof t.value);if(n)return walkObject(stub,e);if(i)return createStub();var s=createStub("function"==typeof t.value?t.value:null);return extend.nonEnum(s,{rootObj:e,propName:r,shadowsPropOnPrototype:!t.isOwn,restore:function(){void 0!==t&&t.isOwn?Object.defineProperty(e,r,t):delete e[r]}}),a?s:wrapMethod(e,r,s)}function getParentBehaviour(e){return e.parent&&getCurrentBehavior(e.parent)}function getDefaultBehavior(e){return e.defaultBehavior||getParentBehaviour(e)||behavior.create(e)}function getCurrentBehavior(e){var r=e.behaviors[e.callCount-1];return r&&r.isPresent()?r:getDefaultBehavior(e)}stub.createStubInstance=function(e,r){if("function"!=typeof e)throw new TypeError("The constructor should be a function.");var t=stub(Object.create(e.prototype));return forEach(Object.keys(r||{}),function(e){if(!(e in t))throw new Error("Cannot stub "+e+". Property does not exist!");var o=r[e];o&&o.createStubInstance?t[e]=o:t[e].returns(o)}),t};var proto={resetBehavior:function(){this.defaultBehavior=null,this.behaviors=[],delete this.returnValue,delete this.returnArgAt,delete this.throwArgAt,delete this.resolveArgAt,delete this.fakeFn,this.returnThis=!1,this.resolveThis=!1,forEach(this.fakes,function(e){e.resetBehavior()})},reset:function(){this.resetHistory(),this.resetBehavior()},onCall:function(e){return this.behaviors[e]||(this.behaviors[e]=behavior.create(this)),this.behaviors[e]},onFirstCall:function(){return this.onCall(0)},onSecondCall:function(){return this.onCall(1)},onThirdCall:function(){return this.onCall(2)},withArgs:function(){var e=spy.withArgs.apply(this,arguments);return this.defaultBehavior&&this.defaultBehavior.promiseLibrary&&(e.defaultBehavior=e.defaultBehavior||behavior.create(e),e.defaultBehavior.promiseLibrary=this.defaultBehavior.promiseLibrary),e}};forEach(Object.keys(behavior),function(e){hasOwnProperty(behavior,e)&&!hasOwnProperty(proto,e)&&"create"!==e&&"invoke"!==e&&(proto[e]=behavior.createBehavior(e))}),forEach(Object.keys(behaviors),function(e){hasOwnProperty(behaviors,e)&&!hasOwnProperty(proto,e)&&behavior.addBehavior(stub,e,behaviors[e])}),extend(stub,proto),module.exports=stub;