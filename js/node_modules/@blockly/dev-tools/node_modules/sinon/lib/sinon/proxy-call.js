"use strict";var arrayProto=require("@sinonjs/commons").prototypes.array,match=require("@sinonjs/samsam").createMatcher,deepEqual=require("@sinonjs/samsam").deepEqual,functionName=require("@sinonjs/commons").functionName,sinonFormat=require("./util/core/format"),valueToString=require("@sinonjs/commons").valueToString,concat=arrayProto.concat,filter=arrayProto.filter,join=arrayProto.join,map=arrayProto.map,reduce=arrayProto.reduce,slice=arrayProto.slice;function throwYieldError(t,r,e){var n=functionName(t)+r;throw e.length&&(n+=" Received ["+join(slice(e),", ")+"]"),new Error(n)}var callProto={calledOn:function(t){return match.isMatcher(t)?t.test(this.thisValue):this.thisValue===t},calledWith:function(){var t=this,r=slice(arguments);return!(r.length>t.args.length)&&reduce(r,function(r,e,n){return r&&deepEqual(t.args[n],e)},!0)},calledWithMatch:function(){var t=this,r=slice(arguments);return!(r.length>t.args.length)&&reduce(r,function(r,e,n){var i=t.args[n];return r&&match(e).test(i)},!0)},calledWithExactly:function(){return arguments.length===this.args.length&&this.calledWith.apply(this,arguments)},notCalledWith:function(){return!this.calledWith.apply(this,arguments)},notCalledWithMatch:function(){return!this.calledWithMatch.apply(this,arguments)},returned:function(t){return deepEqual(this.returnValue,t)},threw:function(t){return void 0!==t&&this.exception?this.exception===t||this.exception.name===t:Boolean(this.exception)},calledWithNew:function(){return this.proxy.prototype&&this.thisValue instanceof this.proxy},calledBefore:function(t){return this.callId<t.callId},calledAfter:function(t){return this.callId>t.callId},calledImmediatelyBefore:function(t){return this.callId===t.callId-1},calledImmediatelyAfter:function(t){return this.callId===t.callId+1},callArg:function(t){return this.ensureArgIsAFunction(t),this.args[t]()},callArgOn:function(t,r){return this.ensureArgIsAFunction(t),this.args[t].apply(r)},callArgWith:function(t){return this.callArgOnWith.apply(this,concat([t,null],slice(arguments,1)))},callArgOnWith:function(t,r){this.ensureArgIsAFunction(t);var e=slice(arguments,2);return this.args[t].apply(r,e)},throwArg:function(t){if(t>this.args.length)throw new TypeError("Not enough arguments: "+t+" required but only "+this.args.length+" present");throw this.args[t]},yield:function(){return this.yieldOn.apply(this,concat([null],slice(arguments,0)))},yieldOn:function(t){var r=slice(this.args),e=filter(r,function(t){return"function"==typeof t})[0];return e||throwYieldError(this.proxy," cannot yield since no callback was passed.",r),e.apply(t,slice(arguments,1))},yieldTo:function(t){return this.yieldToOn.apply(this,concat([t,null],slice(arguments,1)))},yieldToOn:function(t,r){var e=slice(this.args),n=filter(e,function(r){return r&&"function"==typeof r[t]})[0],i=n&&n[t];return i||throwYieldError(this.proxy," cannot yield to '"+valueToString(t)+"' since no callback was passed.",e),i.apply(r,slice(arguments,2))},toString:function(){var t,r=this.proxy?String(this.proxy)+"(":"";return this.args?(t=map(this.args,function(t){return sinonFormat(t)}),r=r+join(t,", ")+")",void 0!==this.returnValue&&(r+=" => "+sinonFormat(this.returnValue)),this.exception&&(r+=" !"+this.exception.name,this.exception.message&&(r+="("+this.exception.message+")")),this.stack&&(r+=(this.stack.split("\n")[3]||"unknown").replace(/^\s*(?:at\s+|@)?/," at ")),r):":("},ensureArgIsAFunction:function(t){if("function"!=typeof this.args[t])throw new TypeError("Expected argument at position "+t+" to be a Function, but was "+typeof this.args[t])}};function createProxyCall(t,r,e,n,i,a,o){if("number"!=typeof a)throw new TypeError("Call id is not a number");var l,c;e.length>0&&(l=e[0],c=e[e.length-1]);var s=Object.create(callProto),u=c&&"function"==typeof c?c:void 0;return s.proxy=t,s.thisValue=r,s.args=e,s.firstArg=l,s.lastArg=c,s.callback=u,s.returnValue=n,s.exception=i,s.callId=a,s.errorWithCallStack=o,s}Object.defineProperty(callProto,"stack",{enumerable:!0,configurable:!0,get:function(){return this.errorWithCallStack&&this.errorWithCallStack.stack||""}}),callProto.invokeCallback=callProto.yield,createProxyCall.toString=callProto.toString,module.exports=createProxyCall;