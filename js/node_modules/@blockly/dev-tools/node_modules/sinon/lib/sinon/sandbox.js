"use strict";var arrayProto=require("@sinonjs/commons").prototypes.array,collectOwnMethods=require("./collect-own-methods"),getPropertyDescriptor=require("./util/core/get-property-descriptor"),isPropertyConfigurable=require("./util/core/is-property-configurable"),match=require("@sinonjs/samsam").createMatcher,sinonAssert=require("./assert"),sinonClock=require("./util/fake-timers"),sinonMock=require("./mock"),sinonSpy=require("./spy"),sinonStub=require("./stub"),sinonFake=require("./fake"),valueToString=require("@sinonjs/commons").valueToString,fakeServer=require("nise").fakeServer,fakeXhr=require("nise").fakeXhr,usePromiseLibrary=require("./util/core/use-promise-library"),filter=arrayProto.filter,forEach=arrayProto.forEach,push=arrayProto.push,reverse=arrayProto.reverse;function applyOnEach(e,r){var t=filter(e,function(e){return"function"==typeof e[r]});forEach(t,function(e){e[r]()})}function Sandbox(){var e,r=this,t=[],n=[];function o(e,r){var t=getPropertyDescriptor(e,r);function n(){t.isOwn?Object.defineProperty(e,r,t):delete e[r]}return n.object=e,n.property=r,n}function i(e,r){forEach(n,function(t){if(t.object===e&&t.property===r)throw new TypeError("Attempted to replace "+r+" which is already replaced")})}function a(r,n){var o=r[0];if(void 0===r[1]&&"object"==typeof o){var i=collectOwnMethods(n);forEach(i,function(e){push(t,e)}),usePromiseLibrary(e,i)}else push(t,n),usePromiseLibrary(e,n);return n}r.assert=sinonAssert.createAssertObject(),r.serverPrototype=fakeServer,r.getFakes=function(){return t},r.getRestorers=function(){return n},r.createStubInstance=function(){var r=sinonStub.createStubInstance.apply(null,arguments),n=collectOwnMethods(r);return forEach(n,function(e){push(t,e)}),usePromiseLibrary(e,n),r},r.inject=function(e){return e.spy=function(){return r.spy.apply(null,arguments)},e.stub=function(){return r.stub.apply(null,arguments)},e.mock=function(){return r.mock.apply(null,arguments)},e.createStubInstance=function(){return r.createStubInstance.apply(r,arguments)},e.fake=function(){return r.fake.apply(null,arguments)},e.replace=function(){return r.replace.apply(null,arguments)},e.replaceSetter=function(){return r.replaceSetter.apply(null,arguments)},e.replaceGetter=function(){return r.replaceGetter.apply(null,arguments)},r.clock&&(e.clock=r.clock),r.server&&(e.server=r.server,e.requests=r.server.requests),e.match=match,e},r.mock=function(){var r=sinonMock.apply(null,arguments);return push(t,r),usePromiseLibrary(e,r),r},r.reset=function(){applyOnEach(t,"reset"),applyOnEach(t,"resetHistory")},r.resetBehavior=function(){applyOnEach(t,"resetBehavior")},r.resetHistory=function(){function e(e){var r=e.resetHistory||e.reset;r&&r.call(e)}forEach(t,function(r){if("function"!=typeof r){var t=[];r.get&&push(t,r.get),r.set&&push(t,r.set),forEach(t,e)}else e(r)})},r.restore=function(){if(arguments.length)throw new Error("sandbox.restore() does not take any parameters. Perhaps you meant stub.restore()");reverse(t),applyOnEach(t,"restore"),t=[],forEach(n,function(e){e()}),n=[],r.restoreContext()},r.restoreContext=function(){var e=r.injectedKeys,t=r.injectInto;e&&(forEach(e,function(e){delete t[e]}),e=[])},r.replace=function(e,r,t){var a=getPropertyDescriptor(e,r);if(void 0===a)throw new TypeError("Cannot replace non-existent property "+valueToString(r));if(void 0===t)throw new TypeError("Expected replacement argument to be defined");if("function"==typeof a.get)throw new Error("Use sandbox.replaceGetter for replacing getters");if("function"==typeof a.set)throw new Error("Use sandbox.replaceSetter for replacing setters");if(typeof e[r]!=typeof t)throw new TypeError("Cannot replace "+typeof e[r]+" with "+typeof t);return i(e,r),push(n,o(e,r)),e[r]=t,t},r.replaceGetter=function(e,r,t){var a=getPropertyDescriptor(e,r);if(void 0===a)throw new TypeError("Cannot replace non-existent property "+valueToString(r));if("function"!=typeof t)throw new TypeError("Expected replacement argument to be a function");if("function"!=typeof a.get)throw new Error("`object.property` is not a getter");return i(e,r),push(n,o(e,r)),Object.defineProperty(e,r,{get:t,configurable:isPropertyConfigurable(e,r)}),t},r.replaceSetter=function(e,r,t){var a=getPropertyDescriptor(e,r);if(void 0===a)throw new TypeError("Cannot replace non-existent property "+valueToString(r));if("function"!=typeof t)throw new TypeError("Expected replacement argument to be a function");if("function"!=typeof a.set)throw new Error("`object.property` is not a setter");return i(e,r),push(n,o(e,r)),Object.defineProperty(e,r,{set:t,configurable:isPropertyConfigurable(e,r)}),t},r.spy=function(){return a(arguments,sinonSpy.apply(sinonSpy,arguments))},r.stub=function(){return a(arguments,sinonStub.apply(sinonStub,arguments))},r.fake=function(e){var r=sinonFake.apply(sinonFake,arguments);return push(t,r),r},forEach(Object.keys(sinonFake),function(e){var n=sinonFake[e];"function"==typeof n&&(r.fake[e]=function(){var e=n.apply(n,arguments);return push(t,e),e})}),r.useFakeTimers=function(e){var n=sinonClock.useFakeTimers.call(null,e);return r.clock=n,push(t,n),n},r.verify=function(){applyOnEach(t,"verify")},r.verifyAndRestore=function(){var e;try{r.verify()}catch(r){e=r}if(r.restore(),e)throw e},r.useFakeServer=function(){var e=r.serverPrototype||fakeServer;return e&&e.create?(r.server=e.create(),push(t,r.server),r.server):null},r.useFakeXMLHttpRequest=function(){var e=fakeXhr.useFakeXMLHttpRequest();return push(t,e),e},r.usingPromise=function(n){return e=n,t.promiseLibrary=n,r}}Sandbox.prototype.match=match,module.exports=Sandbox;